<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MPAS-analisys: src/core_atmosphere/physics/physics_wrf/module_sf_noahlsm_glacial_only.F Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="logoMonanColor_75x75.png"/></td>
  <td id="projectalign">
   <div id="projectname">MPAS-analisys<span id="projectnumber">&#160;teste</span>
   </div>
   <div id="projectbrief">teste</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="dir_c53e21b94733dd8451b4d2db251c70bc.html">core_atmosphere</a></li><li class="navelem"><a class="el" href="dir_195703cd1d38332c0a06b72eede84187.html">physics</a></li><li class="navelem"><a class="el" href="dir_bc4ff68999f89a5d7c146546ef3424c5.html">physics_wrf</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle"><div class="title">module_sf_noahlsm_glacial_only.F</div></div>
</div><!--header-->
<div class="contents">
<a href="module__sf__noahlsm__glacial__only_8F.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a id="l00001" name="l00001"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm__glacial__only.html">    1</a></span><span class="keyword">MODULE</span> <a class="code hl_namespace" href="namespacemodule__sf__noahlsm__glacial__only.html">module_sf_noahlsm_glacial_only</a></div>
<div class="line"><a id="l00002" name="l00002"></a><span class="lineno">    2</span><span class="preprocessor">#if defined(mpas)</span></div>
<div class="line"><a id="l00003" name="l00003"></a><span class="lineno">    3</span><span class="preprocessor"></span><span class="keywordtype">use </span><a class="code hl_namespace" href="namespacempas__atmphys__constants.html">mpas_atmphys_constants</a></div>
<div class="line"><a id="l00004" name="l00004"></a><span class="lineno">    4</span><span class="keywordtype">use </span><a class="code hl_namespace" href="namespacempas__atmphys__utilities.html">mpas_atmphys_utilities</a>, <span class="keywordtype">only</span>: <a class="code hl_function" href="namespacempas__atmphys__utilities.html#aa49abb89b6ebc760010e08cbdade2706">physics_error_fatal</a></div>
<div class="line"><a id="l00005" name="l00005"></a><span class="lineno">    5</span><span class="preprocessor">#define FATAL_ERROR(M) call physics_error_fatal( M )</span></div>
<div class="line"><a id="l00006" name="l00006"></a><span class="lineno">    6</span><span class="preprocessor"></span><span class="preprocessor">#else</span></div>
<div class="line"><a id="l00007" name="l00007"></a><span class="lineno">    7</span><span class="preprocessor"></span><span class="keywordtype">use </span>module_model_constants</div>
<div class="line"><a id="l00008" name="l00008"></a><span class="lineno">    8</span><span class="keywordtype">use </span>module_wrf_error</div>
<div class="line"><a id="l00009" name="l00009"></a><span class="lineno">    9</span><span class="preprocessor">#define FATAL_ERROR(M) call wrf_error_fatal( M )</span></div>
<div class="line"><a id="l00010" name="l00010"></a><span class="lineno">   10</span><span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l00011" name="l00011"></a><span class="lineno">   11</span><span class="preprocessor"></span> </div>
<div class="line"><a id="l00012" name="l00012"></a><span class="lineno">   12</span>  <span class="keywordtype">USE </span><a class="code hl_namespace" href="namespacemodule__sf__noahlsm.html">module_sf_noahlsm</a>, <span class="keywordtype">ONLY</span> : <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a8df53633c056358bfa76c698ee182f17">rd</a>, <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a41b56481dda78f3181c7e40721fa79a0">sigma</a>, <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#ae07d087354ac15d439a02c8f0a1d24e4">cph2o</a>, <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a653d3903e2acbd4d19387ea434944093">cpice</a>, <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a81f1f2ceb78e6b6a447b394803dee3c7">lsubf</a>, <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a54e48804c7badd0dd8544b8c1dbcdf5f">emissi_s</a>, <a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ac6e3e7bb3f0322070546653306177216">rosr12</a></div>
<div class="line"><a id="l00013" name="l00013"></a><span class="lineno">   13</span>  <span class="keywordtype">USE </span><a class="code hl_namespace" href="namespacemodule__sf__noahlsm.html">module_sf_noahlsm</a>, <span class="keywordtype">ONLY</span> : <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#abfdd114973412069ebbfb3a61af8d995">lvcoef_data</a></div>
<div class="line"><a id="l00014" name="l00014"></a><span class="lineno">   14</span> </div>
<div class="line"><a id="l00015" name="l00015"></a><span class="lineno">   15</span>  <span class="keywordtype">PRIVATE</span> :: <a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a7a78bcce992262a6c96711208974f7f1">alcalc</a></div>
<div class="line"><a id="l00016" name="l00016"></a><span class="lineno">   16</span>  <span class="keywordtype">PRIVATE</span> :: <a class="code hl_function" href="namespacemodule__sf__noahlsm.html#abb6e84ee87a6fdb3281c33e8e8457a04">csnow</a></div>
<div class="line"><a id="l00017" name="l00017"></a><span class="lineno">   17</span>  <span class="keywordtype">PRIVATE</span> :: hrtice</div>
<div class="line"><a id="l00018" name="l00018"></a><span class="lineno">   18</span>  <span class="keywordtype">PRIVATE</span> :: <a class="code hl_function" href="namespacemodule__sf__noahlsm.html#adacf01be4e33445ea186feffce24eb35">hstep</a></div>
<div class="line"><a id="l00019" name="l00019"></a><span class="lineno">   19</span>  <span class="keywordtype">PRIVATE</span> :: <a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a5312fbbf31302c20e6823a3d2e97033b">penman</a></div>
<div class="line"><a id="l00020" name="l00020"></a><span class="lineno">   20</span>  <span class="keywordtype">PRIVATE</span> :: <a class="code hl_function" href="namespacemodule__sf__noahlsm.html#aaee442f9d981b7c296c5932352365351">shflx</a></div>
<div class="line"><a id="l00021" name="l00021"></a><span class="lineno">   21</span>  <span class="keywordtype">PRIVATE</span> :: <a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ae27e8294cc66ecbb23f2a9d239a3c3d7">snopac</a></div>
<div class="line"><a id="l00022" name="l00022"></a><span class="lineno">   22</span>  <span class="keywordtype">PRIVATE</span> :: <a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ae6d35ff66196a3ab369a3e87149ddcdc">snowpack</a></div>
<div class="line"><a id="l00023" name="l00023"></a><span class="lineno">   23</span>  <span class="keywordtype">PRIVATE</span> :: <a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ab3693cb1c40b1bd7b4db5e96337f6eef">snowz0</a></div>
<div class="line"><a id="l00024" name="l00024"></a><span class="lineno">   24</span>  <span class="keywordtype">PRIVATE</span> :: <a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ab7e465439f409557715a28bea71551c1">snow_new</a></div>
<div class="line"><a id="l00025" name="l00025"></a><span class="lineno">   25</span> </div>
<div class="line"><a id="l00026" name="l00026"></a><span class="lineno">   26</span>  <span class="keywordtype">integer</span>, <span class="keywordtype">private</span> :: iloc, jloc</div>
<div class="line"><a id="l00027" name="l00027"></a><span class="lineno">   27</span><span class="comment">!$omp threadprivate(iloc, jloc)</span></div>
<div class="line"><a id="l00028" name="l00028"></a><span class="lineno">   28</span> </div>
<div class="line"><a id="l00029" name="l00029"></a><span class="lineno">   29</span><span class="keyword">CONTAINS</span></div>
<div class="line"><a id="l00030" name="l00030"></a><span class="lineno">   30</span> </div>
<div class="line"><a id="l00031" name="l00031"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm__glacial__only.html#afa7bc1c71f24bbd328e603892e6af3ba">   31</a></span>  <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm__glacial__only.html#afa7bc1c71f24bbd328e603892e6af3ba">sflx_glacial</a> (IILOC,JJLOC,ISICE,FFROZP,DT,ZLVL,NSOIL,SLDPTH,     &amp;    !C</div>
<div class="line"><a id="l00032" name="l00032"></a><span class="lineno">   32</span>       &amp;                   LWDN,SOLNET,SFCPRS,PRCP,SFCTMP,Q2,           &amp;    !F</div>
<div class="line"><a id="l00033" name="l00033"></a><span class="lineno">   33</span>       &amp;                   TH2,Q2SAT,DQSDT2,                            &amp;    !I</div>
<div class="line"><a id="l00034" name="l00034"></a><span class="lineno">   34</span>       &amp;                   ALB, SNOALB,TBOT, Z0BRD, Z0, EMISSI, EMBRD,  &amp;    !S</div>
<div class="line"><a id="l00035" name="l00035"></a><span class="lineno">   35</span>       &amp;                   T1,STC,SNOWH,SNEQV,ALBEDO,CH,                &amp;    !H</div>
<div class="line"><a id="l00036" name="l00036"></a><span class="lineno">   36</span>! ----------------------------------------------------------------------</div>
<div class="line"><a id="l00037" name="l00037"></a><span class="lineno">   37</span>! OUTPUTS, DIAGNOSTICS, PARAMETERS BELOW GENERALLY NOT NECESSARY WHEN</div>
<div class="line"><a id="l00038" name="l00038"></a><span class="lineno">   38</span>! COUPLED WITH E.G. A NWP MODEL (SUCH AS THE NOAA/NWS/NCEP MESOSCALE ETA</div>
<div class="line"><a id="l00039" name="l00039"></a><span class="lineno">   39</span>! MODEL).  other applications may require different output variables.</div>
<div class="line"><a id="l00040" name="l00040"></a><span class="lineno">   40</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00041" name="l00041"></a><span class="lineno">   41</span>       &amp;                   eta,sheat, eta_kinematic,fdown,              &amp;    <span class="comment">!O</span></div>
<div class="line"><a id="l00042" name="l00042"></a><span class="lineno">   42</span>       &amp;                   esnow,dew,                                   &amp;    <span class="comment">!O</span></div>
<div class="line"><a id="l00043" name="l00043"></a><span class="lineno">   43</span>       &amp;                   etp,ssoil,                                   &amp;    <span class="comment">!O</span></div>
<div class="line"><a id="l00044" name="l00044"></a><span class="lineno">   44</span>       &amp;                   flx1,flx2,flx3,                              &amp;    <span class="comment">!O</span></div>
<div class="line"><a id="l00045" name="l00045"></a><span class="lineno">   45</span>       &amp;                   snomlt,sncovr,                               &amp;    <span class="comment">!O</span></div>
<div class="line"><a id="l00046" name="l00046"></a><span class="lineno">   46</span>       &amp;                   runoff1,                                     &amp;    <span class="comment">!O</span></div>
<div class="line"><a id="l00047" name="l00047"></a><span class="lineno">   47</span>       &amp;                   q1,                                          &amp;    <span class="comment">!D</span></div>
<div class="line"><a id="l00048" name="l00048"></a><span class="lineno">   48</span>       &amp;                   snotime1,                                    &amp;</div>
<div class="line"><a id="l00049" name="l00049"></a><span class="lineno">   49</span>       &amp;                   ribb)</div>
<div class="line"><a id="l00050" name="l00050"></a><span class="lineno">   50</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00051" name="l00051"></a><span class="lineno">   51</span><span class="comment">! SUB-DRIVER FOR &quot;Noah LSM&quot; FAMILY OF PHYSICS SUBROUTINES FOR A</span></div>
<div class="line"><a id="l00052" name="l00052"></a><span class="lineno">   52</span><span class="comment">! SOIL/VEG/SNOWPACK LAND-SURFACE MODEL TO UPDATE ICE TEMPERATURE, SKIN </span></div>
<div class="line"><a id="l00053" name="l00053"></a><span class="lineno">   53</span><span class="comment">! TEMPERATURE, SNOWPACK WATER CONTENT, SNOWDEPTH, AND ALL TERMS OF THE </span></div>
<div class="line"><a id="l00054" name="l00054"></a><span class="lineno">   54</span><span class="comment">! SURFACE ENERGY BALANCE (EXCLUDING INPUT ATMOSPHERIC FORCINGS OF </span></div>
<div class="line"><a id="l00055" name="l00055"></a><span class="lineno">   55</span><span class="comment">! DOWNWARD RADIATION AND PRECIP)</span></div>
<div class="line"><a id="l00056" name="l00056"></a><span class="lineno">   56</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00057" name="l00057"></a><span class="lineno">   57</span><span class="comment">! SFLX ARGUMENT LIST KEY:</span></div>
<div class="line"><a id="l00058" name="l00058"></a><span class="lineno">   58</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00059" name="l00059"></a><span class="lineno">   59</span><span class="comment">!  C  CONFIGURATION INFORMATION</span></div>
<div class="line"><a id="l00060" name="l00060"></a><span class="lineno">   60</span><span class="comment">!  F  FORCING DATA</span></div>
<div class="line"><a id="l00061" name="l00061"></a><span class="lineno">   61</span><span class="comment">!  I  OTHER (INPUT) FORCING DATA</span></div>
<div class="line"><a id="l00062" name="l00062"></a><span class="lineno">   62</span><span class="comment">!  S  SURFACE CHARACTERISTICS</span></div>
<div class="line"><a id="l00063" name="l00063"></a><span class="lineno">   63</span><span class="comment">!  H  HISTORY (STATE) VARIABLES</span></div>
<div class="line"><a id="l00064" name="l00064"></a><span class="lineno">   64</span><span class="comment">!  O  OUTPUT VARIABLES</span></div>
<div class="line"><a id="l00065" name="l00065"></a><span class="lineno">   65</span><span class="comment">!  D  DIAGNOSTIC OUTPUT</span></div>
<div class="line"><a id="l00066" name="l00066"></a><span class="lineno">   66</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00067" name="l00067"></a><span class="lineno">   67</span><span class="comment">! 1. CONFIGURATION INFORMATION (C):</span></div>
<div class="line"><a id="l00068" name="l00068"></a><span class="lineno">   68</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00069" name="l00069"></a><span class="lineno">   69</span><span class="comment">!   DT         TIMESTEP (SEC) (DT SHOULD NOT EXCEED 3600 SECS, RECOMMEND</span></div>
<div class="line"><a id="l00070" name="l00070"></a><span class="lineno">   70</span><span class="comment">!                1800 SECS OR LESS)</span></div>
<div class="line"><a id="l00071" name="l00071"></a><span class="lineno">   71</span><span class="comment">!   ZLVL       HEIGHT (M) ABOVE GROUND OF ATMOSPHERIC FORCING VARIABLES</span></div>
<div class="line"><a id="l00072" name="l00072"></a><span class="lineno">   72</span><span class="comment">!   NSOIL      NUMBER OF SOIL LAYERS (AT LEAST 2, AND NOT GREATER THAN</span></div>
<div class="line"><a id="l00073" name="l00073"></a><span class="lineno">   73</span><span class="comment">!                PARAMETER NSOLD SET BELOW)</span></div>
<div class="line"><a id="l00074" name="l00074"></a><span class="lineno">   74</span><span class="comment">!   SLDPTH     THE THICKNESS OF EACH SOIL LAYER (M)</span></div>
<div class="line"><a id="l00075" name="l00075"></a><span class="lineno">   75</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00076" name="l00076"></a><span class="lineno">   76</span><span class="comment">! 3. FORCING DATA (F):</span></div>
<div class="line"><a id="l00077" name="l00077"></a><span class="lineno">   77</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00078" name="l00078"></a><span class="lineno">   78</span><span class="comment">!   LWDN       LW DOWNWARD RADIATION (W M-2; POSITIVE, NOT NET LONGWAVE)</span></div>
<div class="line"><a id="l00079" name="l00079"></a><span class="lineno">   79</span><span class="comment">!   SOLNET     NET DOWNWARD SOLAR RADIATION ((W M-2; POSITIVE)</span></div>
<div class="line"><a id="l00080" name="l00080"></a><span class="lineno">   80</span><span class="comment">!   SFCPRS     PRESSURE AT HEIGHT ZLVL ABOVE GROUND (PASCALS)</span></div>
<div class="line"><a id="l00081" name="l00081"></a><span class="lineno">   81</span><span class="comment">!   PRCP       PRECIP RATE (KG M-2 S-1) (NOTE, THIS IS A RATE)</span></div>
<div class="line"><a id="l00082" name="l00082"></a><span class="lineno">   82</span><span class="comment">!   SFCTMP     AIR TEMPERATURE (K) AT HEIGHT ZLVL ABOVE GROUND</span></div>
<div class="line"><a id="l00083" name="l00083"></a><span class="lineno">   83</span><span class="comment">!   TH2        AIR POTENTIAL TEMPERATURE (K) AT HEIGHT ZLVL ABOVE GROUND</span></div>
<div class="line"><a id="l00084" name="l00084"></a><span class="lineno">   84</span><span class="comment">!   Q2         MIXING RATIO AT HEIGHT ZLVL ABOVE GROUND (KG KG-1)</span></div>
<div class="line"><a id="l00085" name="l00085"></a><span class="lineno">   85</span><span class="comment">!   FFROZP     FRACTION OF FROZEN PRECIPITATION</span></div>
<div class="line"><a id="l00086" name="l00086"></a><span class="lineno">   86</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00087" name="l00087"></a><span class="lineno">   87</span><span class="comment">! 4. OTHER FORCING (INPUT) DATA (I):</span></div>
<div class="line"><a id="l00088" name="l00088"></a><span class="lineno">   88</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00089" name="l00089"></a><span class="lineno">   89</span><span class="comment">!   Q2SAT      SAT SPECIFIC HUMIDITY AT HEIGHT ZLVL ABOVE GROUND (KG KG-1)</span></div>
<div class="line"><a id="l00090" name="l00090"></a><span class="lineno">   90</span><span class="comment">!   DQSDT2     SLOPE OF SAT SPECIFIC HUMIDITY CURVE AT T=SFCTMP</span></div>
<div class="line"><a id="l00091" name="l00091"></a><span class="lineno">   91</span><span class="comment">!                (KG KG-1 K-1)</span></div>
<div class="line"><a id="l00092" name="l00092"></a><span class="lineno">   92</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00093" name="l00093"></a><span class="lineno">   93</span><span class="comment">! 5. CANOPY/SOIL CHARACTERISTICS (S):</span></div>
<div class="line"><a id="l00094" name="l00094"></a><span class="lineno">   94</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00095" name="l00095"></a><span class="lineno">   95</span><span class="comment">!   ALB        BACKROUND SNOW-FREE SURFACE ALBEDO (FRACTION), FOR JULIAN</span></div>
<div class="line"><a id="l00096" name="l00096"></a><span class="lineno">   96</span><span class="comment">!                DAY OF YEAR (USUALLY FROM TEMPORAL INTERPOLATION OF</span></div>
<div class="line"><a id="l00097" name="l00097"></a><span class="lineno">   97</span><span class="comment">!                MONTHLY MEAN VALUES&#39; CALLING PROG MAY OR MAY NOT</span></div>
<div class="line"><a id="l00098" name="l00098"></a><span class="lineno">   98</span><span class="comment">!                INCLUDE DIURNAL SUN ANGLE EFFECT)</span></div>
<div class="line"><a id="l00099" name="l00099"></a><span class="lineno">   99</span><span class="comment">!   SNOALB     UPPER BOUND ON MAXIMUM ALBEDO OVER DEEP SNOW (E.G. FROM</span></div>
<div class="line"><a id="l00100" name="l00100"></a><span class="lineno">  100</span><span class="comment">!                ROBINSON AND KUKLA, 1985, J. CLIM. &amp; APPL. METEOR.)</span></div>
<div class="line"><a id="l00101" name="l00101"></a><span class="lineno">  101</span><span class="comment">!   TBOT       BOTTOM SOIL TEMPERATURE (LOCAL YEARLY-MEAN SFC AIR</span></div>
<div class="line"><a id="l00102" name="l00102"></a><span class="lineno">  102</span><span class="comment">!                TEMPERATURE)</span></div>
<div class="line"><a id="l00103" name="l00103"></a><span class="lineno">  103</span><span class="comment">!   Z0BRD      Background fixed roughness length (M)</span></div>
<div class="line"><a id="l00104" name="l00104"></a><span class="lineno">  104</span><span class="comment">!   Z0         Time varying roughness length (M) as function of snow depth</span></div>
<div class="line"><a id="l00105" name="l00105"></a><span class="lineno">  105</span><span class="comment">!   EMBRD      Background surface emissivity (between 0 and 1)</span></div>
<div class="line"><a id="l00106" name="l00106"></a><span class="lineno">  106</span><span class="comment">!   EMISSI     Surface emissivity (between 0 and 1)</span></div>
<div class="line"><a id="l00107" name="l00107"></a><span class="lineno">  107</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00108" name="l00108"></a><span class="lineno">  108</span><span class="comment">! 6. HISTORY (STATE) VARIABLES (H):</span></div>
<div class="line"><a id="l00109" name="l00109"></a><span class="lineno">  109</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00110" name="l00110"></a><span class="lineno">  110</span><span class="comment">!  T1          GROUND/CANOPY/SNOWPACK) EFFECTIVE SKIN TEMPERATURE (K)</span></div>
<div class="line"><a id="l00111" name="l00111"></a><span class="lineno">  111</span><span class="comment">!  STC(NSOIL)  SOIL TEMP (K)</span></div>
<div class="line"><a id="l00112" name="l00112"></a><span class="lineno">  112</span><span class="comment">!  SNOWH       ACTUAL SNOW DEPTH (M)</span></div>
<div class="line"><a id="l00113" name="l00113"></a><span class="lineno">  113</span><span class="comment">!  SNEQV       LIQUID WATER-EQUIVALENT SNOW DEPTH (M)</span></div>
<div class="line"><a id="l00114" name="l00114"></a><span class="lineno">  114</span><span class="comment">!                NOTE: SNOW DENSITY = SNEQV/SNOWH</span></div>
<div class="line"><a id="l00115" name="l00115"></a><span class="lineno">  115</span><span class="comment">!  ALBEDO      SURFACE ALBEDO INCLUDING SNOW EFFECT (UNITLESS FRACTION)</span></div>
<div class="line"><a id="l00116" name="l00116"></a><span class="lineno">  116</span><span class="comment">!                =SNOW-FREE ALBEDO (ALB) WHEN SNEQV=0, OR</span></div>
<div class="line"><a id="l00117" name="l00117"></a><span class="lineno">  117</span><span class="comment">!                =FCT(MSNOALB,ALB,SHDFAC,SHDMIN) WHEN SNEQV&gt;0</span></div>
<div class="line"><a id="l00118" name="l00118"></a><span class="lineno">  118</span><span class="comment">!  CH          SURFACE EXCHANGE COEFFICIENT FOR HEAT AND MOISTURE</span></div>
<div class="line"><a id="l00119" name="l00119"></a><span class="lineno">  119</span><span class="comment">!                (M S-1); NOTE: CH IS TECHNICALLY A CONDUCTANCE SINCE</span></div>
<div class="line"><a id="l00120" name="l00120"></a><span class="lineno">  120</span><span class="comment">!                IT HAS BEEN MULTIPLIED BY WIND SPEED.</span></div>
<div class="line"><a id="l00121" name="l00121"></a><span class="lineno">  121</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00122" name="l00122"></a><span class="lineno">  122</span><span class="comment">! 7. OUTPUT (O):</span></div>
<div class="line"><a id="l00123" name="l00123"></a><span class="lineno">  123</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00124" name="l00124"></a><span class="lineno">  124</span><span class="comment">! OUTPUT VARIABLES NECESSARY FOR A COUPLED NUMERICAL WEATHER PREDICTION</span></div>
<div class="line"><a id="l00125" name="l00125"></a><span class="lineno">  125</span><span class="comment">! MODEL, E.G. NOAA/NWS/NCEP MESOSCALE ETA MODEL.  FOR THIS APPLICATION,</span></div>
<div class="line"><a id="l00126" name="l00126"></a><span class="lineno">  126</span><span class="comment">! THE REMAINING OUTPUT/DIAGNOSTIC/PARAMETER BLOCKS BELOW ARE NOT</span></div>
<div class="line"><a id="l00127" name="l00127"></a><span class="lineno">  127</span><span class="comment">! NECESSARY.  OTHER APPLICATIONS MAY REQUIRE DIFFERENT OUTPUT VARIABLES.</span></div>
<div class="line"><a id="l00128" name="l00128"></a><span class="lineno">  128</span><span class="comment">!   ETA        ACTUAL LATENT HEAT FLUX (W m-2: NEGATIVE, IF UP FROM</span></div>
<div class="line"><a id="l00129" name="l00129"></a><span class="lineno">  129</span><span class="comment">!              SURFACE)</span></div>
<div class="line"><a id="l00130" name="l00130"></a><span class="lineno">  130</span><span class="comment">!  ETA_KINEMATIC atctual latent heat flux in Kg m-2 s-1</span></div>
<div class="line"><a id="l00131" name="l00131"></a><span class="lineno">  131</span><span class="comment">!   SHEAT      SENSIBLE HEAT FLUX (W M-2: NEGATIVE, IF UPWARD FROM</span></div>
<div class="line"><a id="l00132" name="l00132"></a><span class="lineno">  132</span><span class="comment">!              SURFACE)</span></div>
<div class="line"><a id="l00133" name="l00133"></a><span class="lineno">  133</span><span class="comment">!   FDOWN      Radiation forcing at the surface (W m-2) = SOLDN*(1-alb)+LWDN</span></div>
<div class="line"><a id="l00134" name="l00134"></a><span class="lineno">  134</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00135" name="l00135"></a><span class="lineno">  135</span><span class="comment">!   ESNOW      SUBLIMATION FROM (OR DEPOSITION TO IF &lt;0) SNOWPACK</span></div>
<div class="line"><a id="l00136" name="l00136"></a><span class="lineno">  136</span><span class="comment">!                (W m-2)</span></div>
<div class="line"><a id="l00137" name="l00137"></a><span class="lineno">  137</span><span class="comment">!   DEW        DEWFALL (OR FROSTFALL FOR T&lt;273.15) (M)</span></div>
<div class="line"><a id="l00138" name="l00138"></a><span class="lineno">  138</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00139" name="l00139"></a><span class="lineno">  139</span><span class="comment">!   ETP        POTENTIAL EVAPORATION (W m-2)</span></div>
<div class="line"><a id="l00140" name="l00140"></a><span class="lineno">  140</span><span class="comment">!   SSOIL      SOIL HEAT FLUX (W M-2: NEGATIVE IF DOWNWARD FROM SURFACE)</span></div>
<div class="line"><a id="l00141" name="l00141"></a><span class="lineno">  141</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00142" name="l00142"></a><span class="lineno">  142</span><span class="comment">!   FLX1       PRECIP-SNOW SFC (W M-2)</span></div>
<div class="line"><a id="l00143" name="l00143"></a><span class="lineno">  143</span><span class="comment">!   FLX2       FREEZING RAIN LATENT HEAT FLUX (W M-2)</span></div>
<div class="line"><a id="l00144" name="l00144"></a><span class="lineno">  144</span><span class="comment">!   FLX3       PHASE-CHANGE HEAT FLUX FROM SNOWMELT (W M-2)</span></div>
<div class="line"><a id="l00145" name="l00145"></a><span class="lineno">  145</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00146" name="l00146"></a><span class="lineno">  146</span><span class="comment">!   SNOMLT     SNOW MELT (M) (WATER EQUIVALENT)</span></div>
<div class="line"><a id="l00147" name="l00147"></a><span class="lineno">  147</span><span class="comment">!   SNCOVR     FRACTIONAL SNOW COVER (UNITLESS FRACTION, 0-1)</span></div>
<div class="line"><a id="l00148" name="l00148"></a><span class="lineno">  148</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00149" name="l00149"></a><span class="lineno">  149</span><span class="comment">!   RUNOFF1    SURFACE RUNOFF (M S-1), NOT INFILTRATING THE SURFACE</span></div>
<div class="line"><a id="l00150" name="l00150"></a><span class="lineno">  150</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00151" name="l00151"></a><span class="lineno">  151</span><span class="comment">! 8. DIAGNOSTIC OUTPUT (D):</span></div>
<div class="line"><a id="l00152" name="l00152"></a><span class="lineno">  152</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00153" name="l00153"></a><span class="lineno">  153</span><span class="comment">!   Q1         Effective mixing ratio at surface (kg kg-1), used for</span></div>
<div class="line"><a id="l00154" name="l00154"></a><span class="lineno">  154</span><span class="comment">!              diagnosing the mixing ratio at 2 meter for coupled model</span></div>
<div class="line"><a id="l00155" name="l00155"></a><span class="lineno">  155</span><span class="comment">!  Documentation for SNOTIME1 and SNOABL2 ?????</span></div>
<div class="line"><a id="l00156" name="l00156"></a><span class="lineno">  156</span><span class="comment">!  What categories of arguments do these variables fall into ????</span></div>
<div class="line"><a id="l00157" name="l00157"></a><span class="lineno">  157</span><span class="comment">!  Documentation for RIBB ?????</span></div>
<div class="line"><a id="l00158" name="l00158"></a><span class="lineno">  158</span><span class="comment">!  What category of argument does RIBB fall into ?????</span></div>
<div class="line"><a id="l00159" name="l00159"></a><span class="lineno">  159</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00160" name="l00160"></a><span class="lineno">  160</span> </div>
<div class="line"><a id="l00161" name="l00161"></a><span class="lineno">  161</span>    <span class="keywordtype">IMPLICIT NONE</span></div>
<div class="line"><a id="l00162" name="l00162"></a><span class="lineno">  162</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00163" name="l00163"></a><span class="lineno">  163</span>    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> ::  iiloc, jjloc</div>
<div class="line"><a id="l00164" name="l00164"></a><span class="lineno">  164</span>    <span class="keywordtype">INTEGER</span>, <span class="keywordtype">INTENT(IN)</span> ::  ISICE</div>
<div class="line"><a id="l00165" name="l00165"></a><span class="lineno">  165</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00166" name="l00166"></a><span class="lineno">  166</span>    <span class="keywordtype">LOGICAL</span>             ::  FRZGRA, SNOWNG</div>
<div class="line"><a id="l00167" name="l00167"></a><span class="lineno">  167</span> </div>
<div class="line"><a id="l00168" name="l00168"></a><span class="lineno">  168</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00169" name="l00169"></a><span class="lineno">  169</span><span class="comment">! 1. CONFIGURATION INFORMATION (C):</span></div>
<div class="line"><a id="l00170" name="l00170"></a><span class="lineno">  170</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00171" name="l00171"></a><span class="lineno">  171</span>    <span class="keywordtype">INTEGER</span>, <span class="keywordtype">INTENT(IN)</span> ::  NSOIL</div>
<div class="line"><a id="l00172" name="l00172"></a><span class="lineno">  172</span>    <span class="keywordtype">INTEGER</span>             ::  KZ</div>
<div class="line"><a id="l00173" name="l00173"></a><span class="lineno">  173</span> </div>
<div class="line"><a id="l00174" name="l00174"></a><span class="lineno">  174</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00175" name="l00175"></a><span class="lineno">  175</span><span class="comment">! 2. LOGICAL:</span></div>
<div class="line"><a id="l00176" name="l00176"></a><span class="lineno">  176</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00177" name="l00177"></a><span class="lineno">  177</span> </div>
<div class="line"><a id="l00178" name="l00178"></a><span class="lineno">  178</span><span class="keywordtype">    REAL</span>, <span class="keywordtype">INTENT(IN)</span>   :: DT,DQSDT2,LWDN,PRCP,     &amp;</div>
<div class="line"><a id="l00179" name="l00179"></a><span class="lineno">  179</span>         &amp;                Q2,Q2SAT,SFCPRS,SFCTMP, SNOALB,          &amp;</div>
<div class="line"><a id="l00180" name="l00180"></a><span class="lineno">  180</span>         &amp;                SOLNET,TBOT,TH2,ZLVL,FFROZP</div>
<div class="line"><a id="l00181" name="l00181"></a><span class="lineno">  181</span>    <span class="keywordtype">REAL</span>, <span class="keywordtype">INTENT(OUT)</span>  :: EMBRD, ALBEDO</div>
<div class="line"><a id="l00182" name="l00182"></a><span class="lineno">  182</span><span class="keywordtype">    REAL</span>, <span class="keywordtype">INTENT(INOUT)</span>:: CH,SNEQV,SNCOVR,SNOWH,T1,Z0BRD,EMISSI,ALB</div>
<div class="line"><a id="l00183" name="l00183"></a><span class="lineno">  183</span><span class="keywordtype">    REAL</span>, <span class="keywordtype">INTENT(INOUT)</span>:: SNOTIME1</div>
<div class="line"><a id="l00184" name="l00184"></a><span class="lineno">  184</span><span class="keywordtype">    REAL</span>, <span class="keywordtype">INTENT(INOUT)</span>:: RIBB</div>
<div class="line"><a id="l00185" name="l00185"></a><span class="lineno">  185</span><span class="keywordtype">    REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(IN)</span>    :: SLDPTH</div>
<div class="line"><a id="l00186" name="l00186"></a><span class="lineno">  186</span><span class="keywordtype">    REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(INOUT)</span> ::  STC</div>
<div class="line"><a id="l00187" name="l00187"></a><span class="lineno">  187</span><span class="keywordtype">    REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span> ::   ZSOIL</div>
<div class="line"><a id="l00188" name="l00188"></a><span class="lineno">  188</span> </div>
<div class="line"><a id="l00189" name="l00189"></a><span class="lineno">  189</span><span class="keywordtype">    REAL</span>,<span class="keywordtype">INTENT(OUT)</span>   :: ETA_KINEMATIC,DEW,ESNOW,ETA,  &amp;</div>
<div class="line"><a id="l00190" name="l00190"></a><span class="lineno">  190</span>         &amp;                ETP,FLX1,FLX2,FLX3,SHEAT,RUNOFF1,    &amp;</div>
<div class="line"><a id="l00191" name="l00191"></a><span class="lineno">  191</span>         &amp;                SSOIL,SNOMLT,FDOWN,Q1</div>
<div class="line"><a id="l00192" name="l00192"></a><span class="lineno">  192</span>    <span class="keywordtype">REAL</span>               :: DF1,DSOIL,DTOT,FRCSNO,FRCSOI,          &amp;</div>
<div class="line"><a id="l00193" name="l00193"></a><span class="lineno">  193</span>         &amp;                PRCP1,RCH,RR,RSNOW,SNDENS,SNCOND,SN_NEW,     &amp;</div>
<div class="line"><a id="l00194" name="l00194"></a><span class="lineno">  194</span>         &amp;                T1V,T24,T2V,TH2V,TSNOW,Z0,PRCPF,RHO</div>
<div class="line"><a id="l00195" name="l00195"></a><span class="lineno">  195</span> </div>
<div class="line"><a id="l00196" name="l00196"></a><span class="lineno">  196</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00197" name="l00197"></a><span class="lineno">  197</span><span class="comment">! DECLARATIONS - PARAMETERS</span></div>
<div class="line"><a id="l00198" name="l00198"></a><span class="lineno">  198</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00199" name="l00199"></a><span class="lineno">  199</span><span class="keywordtype">    REAL</span>, <span class="keywordtype">PARAMETER</span> :: TFREEZ = 273.15</div>
<div class="line"><a id="l00200" name="l00200"></a><span class="lineno">  200</span><span class="keywordtype">    REAL</span>, <span class="keywordtype">PARAMETER</span> :: LVH2O = 2.501e+6</div>
<div class="line"><a id="l00201" name="l00201"></a><span class="lineno">  201</span><span class="keywordtype">    REAL</span>, <span class="keywordtype">PARAMETER</span> :: LSUBS = 2.83e+6</div>
<div class="line"><a id="l00202" name="l00202"></a><span class="lineno">  202</span><span class="keywordtype">    REAL</span>, <span class="keywordtype">PARAMETER</span> :: R = 287.04</div>
<div class="line"><a id="l00203" name="l00203"></a><span class="lineno">  203</span> </div>
<div class="line"><a id="l00204" name="l00204"></a><span class="lineno">  204</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00205" name="l00205"></a><span class="lineno">  205</span>    iloc = iiloc</div>
<div class="line"><a id="l00206" name="l00206"></a><span class="lineno">  206</span>    jloc = jjloc</div>
<div class="line"><a id="l00207" name="l00207"></a><span class="lineno">  207</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00208" name="l00208"></a><span class="lineno">  208</span>    zsoil(1) = - sldpth(1)</div>
<div class="line"><a id="l00209" name="l00209"></a><span class="lineno">  209</span>    <span class="keywordflow">DO</span> kz = 2,nsoil</div>
<div class="line"><a id="l00210" name="l00210"></a><span class="lineno">  210</span>       zsoil(kz) = - sldpth(kz) + zsoil(kz -1)</div>
<div class="line"><a id="l00211" name="l00211"></a><span class="lineno">  211</span><span class="keywordflow">    END DO</span></div>
<div class="line"><a id="l00212" name="l00212"></a><span class="lineno">  212</span> </div>
<div class="line"><a id="l00213" name="l00213"></a><span class="lineno">  213</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00214" name="l00214"></a><span class="lineno">  214</span><span class="comment">! IF S.W.E. (SNEQV) BELOW THRESHOLD LOWER BOUND (0.10 M FOR GLACIAL </span></div>
<div class="line"><a id="l00215" name="l00215"></a><span class="lineno">  215</span><span class="comment">! ICE), THEN SET AT LOWER BOUND</span></div>
<div class="line"><a id="l00216" name="l00216"></a><span class="lineno">  216</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00217" name="l00217"></a><span class="lineno">  217</span>    <span class="keywordflow">IF</span> ( sneqv &lt; 0.10 ) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00218" name="l00218"></a><span class="lineno">  218</span>       sneqv = 0.10</div>
<div class="line"><a id="l00219" name="l00219"></a><span class="lineno">  219</span>       snowh = 0.50</div>
<div class="line"><a id="l00220" name="l00220"></a><span class="lineno">  220</span><span class="keywordflow">    ENDIF</span></div>
<div class="line"><a id="l00221" name="l00221"></a><span class="lineno">  221</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00222" name="l00222"></a><span class="lineno">  222</span><span class="comment">! IF INPUT SNOWPACK IS NONZERO, THEN COMPUTE SNOW DENSITY &quot;SNDENS&quot; AND</span></div>
<div class="line"><a id="l00223" name="l00223"></a><span class="lineno">  223</span><span class="comment">! SNOW THERMAL CONDUCTIVITY &quot;SNCOND&quot;</span></div>
<div class="line"><a id="l00224" name="l00224"></a><span class="lineno">  224</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00225" name="l00225"></a><span class="lineno">  225</span>    sndens = sneqv / snowh</div>
<div class="line"><a id="l00226" name="l00226"></a><span class="lineno">  226</span>    <span class="keywordflow">IF</span>(sndens &gt; 1.0) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00227" name="l00227"></a><span class="lineno">  227</span>       fatal_error( <span class="stringliteral">&#39;Physical snow depth is less than snow water equiv.&#39;</span> )</div>
<div class="line"><a id="l00228" name="l00228"></a><span class="lineno">  228</span><span class="keywordflow">    ENDIF</span></div>
<div class="line"><a id="l00229" name="l00229"></a><span class="lineno">  229</span> </div>
<div class="line"><a id="l00230" name="l00230"></a><span class="lineno">  230</span>    <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#abb6e84ee87a6fdb3281c33e8e8457a04">csnow</a> (sncond,sndens)</div>
<div class="line"><a id="l00231" name="l00231"></a><span class="lineno">  231</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00232" name="l00232"></a><span class="lineno">  232</span><span class="comment">! DETERMINE IF IT&#39;S PRECIPITATING AND WHAT KIND OF PRECIP IT IS.</span></div>
<div class="line"><a id="l00233" name="l00233"></a><span class="lineno">  233</span><span class="comment">! IF IT&#39;S PRCPING AND THE AIR TEMP IS COLDER THAN 0 C, IT&#39;S SNOWING!</span></div>
<div class="line"><a id="l00234" name="l00234"></a><span class="lineno">  234</span><span class="comment">! IF IT&#39;S PRCPING AND THE AIR TEMP IS WARMER THAN 0 C, BUT THE GRND</span></div>
<div class="line"><a id="l00235" name="l00235"></a><span class="lineno">  235</span><span class="comment">! TEMP IS COLDER THAN 0 C, FREEZING RAIN IS PRESUMED TO BE FALLING.</span></div>
<div class="line"><a id="l00236" name="l00236"></a><span class="lineno">  236</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00237" name="l00237"></a><span class="lineno">  237</span> </div>
<div class="line"><a id="l00238" name="l00238"></a><span class="lineno">  238</span>    snowng = .false.</div>
<div class="line"><a id="l00239" name="l00239"></a><span class="lineno">  239</span>    frzgra = .false.</div>
<div class="line"><a id="l00240" name="l00240"></a><span class="lineno">  240</span>    <span class="keywordflow">IF</span> (prcp &gt; 0.0) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00241" name="l00241"></a><span class="lineno">  241</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00242" name="l00242"></a><span class="lineno">  242</span><span class="comment">! Snow defined when fraction of frozen precip (FFROZP) &gt; 0.5,</span></div>
<div class="line"><a id="l00243" name="l00243"></a><span class="lineno">  243</span><span class="comment">! passed in from model microphysics.</span></div>
<div class="line"><a id="l00244" name="l00244"></a><span class="lineno">  244</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00245" name="l00245"></a><span class="lineno">  245</span>       <span class="keywordflow">IF</span> (ffrozp .GT. 0.5) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00246" name="l00246"></a><span class="lineno">  246</span>          snowng = .true.</div>
<div class="line"><a id="l00247" name="l00247"></a><span class="lineno">  247</span>       <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l00248" name="l00248"></a><span class="lineno">  248</span>          <span class="keywordflow">IF</span> (t1 &lt;= tfreez) frzgra = .true.</div>
<div class="line"><a id="l00249" name="l00249"></a><span class="lineno">  249</span><span class="keywordflow">       END IF</span></div>
<div class="line"><a id="l00250" name="l00250"></a><span class="lineno">  250</span><span class="keywordflow">    END IF</span></div>
<div class="line"><a id="l00251" name="l00251"></a><span class="lineno">  251</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00252" name="l00252"></a><span class="lineno">  252</span><span class="comment">! IF EITHER PRCP FLAG IS SET, DETERMINE NEW SNOWFALL (CONVERTING PRCP</span></div>
<div class="line"><a id="l00253" name="l00253"></a><span class="lineno">  253</span><span class="comment">! RATE FROM KG M-2 S-1 TO A LIQUID EQUIV SNOW DEPTH IN METERS) AND ADD</span></div>
<div class="line"><a id="l00254" name="l00254"></a><span class="lineno">  254</span><span class="comment">! IT TO THE EXISTING SNOWPACK.</span></div>
<div class="line"><a id="l00255" name="l00255"></a><span class="lineno">  255</span><span class="comment">! NOTE THAT SINCE ALL PRECIP IS ADDED TO SNOWPACK, NO PRECIP INFILTRATES</span></div>
<div class="line"><a id="l00256" name="l00256"></a><span class="lineno">  256</span><span class="comment">! INTO THE SOIL SO THAT PRCP1 IS SET TO ZERO.</span></div>
<div class="line"><a id="l00257" name="l00257"></a><span class="lineno">  257</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00258" name="l00258"></a><span class="lineno">  258</span>    <span class="keywordflow">IF</span> ( (snowng) .OR. (frzgra) ) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00259" name="l00259"></a><span class="lineno">  259</span>       sn_new = prcp * dt * 0.001</div>
<div class="line"><a id="l00260" name="l00260"></a><span class="lineno">  260</span>       sneqv = sneqv + sn_new</div>
<div class="line"><a id="l00261" name="l00261"></a><span class="lineno">  261</span>       prcpf = 0.0</div>
<div class="line"><a id="l00262" name="l00262"></a><span class="lineno">  262</span> </div>
<div class="line"><a id="l00263" name="l00263"></a><span class="lineno">  263</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00264" name="l00264"></a><span class="lineno">  264</span><span class="comment">! UPDATE SNOW DENSITY BASED ON NEW SNOWFALL, USING OLD AND NEW SNOW.</span></div>
<div class="line"><a id="l00265" name="l00265"></a><span class="lineno">  265</span><span class="comment">! UPDATE SNOW THERMAL CONDUCTIVITY</span></div>
<div class="line"><a id="l00266" name="l00266"></a><span class="lineno">  266</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00267" name="l00267"></a><span class="lineno">  267</span>       <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ab7e465439f409557715a28bea71551c1">snow_new</a> (sfctmp,sn_new,snowh,sndens)</div>
<div class="line"><a id="l00268" name="l00268"></a><span class="lineno">  268</span> </div>
<div class="line"><a id="l00269" name="l00269"></a><span class="lineno">  269</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00270" name="l00270"></a><span class="lineno">  270</span><span class="comment">! kmh 09/04/2006 set Snow Density at 0.2 g/cm**3</span></div>
<div class="line"><a id="l00271" name="l00271"></a><span class="lineno">  271</span><span class="comment">! for &quot;cold permanent ice&quot; or new &quot;dry&quot; snow</span></div>
<div class="line"><a id="l00272" name="l00272"></a><span class="lineno">  272</span><span class="comment">! if soil temperature less than 268.15 K, treat as typical </span></div>
<div class="line"><a id="l00273" name="l00273"></a><span class="lineno">  273</span><span class="comment">! Antarctic/Greenland snow firn</span></div>
<div class="line"><a id="l00274" name="l00274"></a><span class="lineno">  274</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00275" name="l00275"></a><span class="lineno">  275</span>       <span class="keywordflow">IF</span> ( sncovr .GT. 0.99 ) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00276" name="l00276"></a><span class="lineno">  276</span>          <span class="keywordflow">IF</span> ( stc(1) .LT. (tfreez - 5.) ) sndens = 0.2</div>
<div class="line"><a id="l00277" name="l00277"></a><span class="lineno">  277</span>          <span class="keywordflow">IF</span> ( snowng .AND. (t1.LT.273.) .AND. (sfctmp.LT.273.) ) sndens=0.2</div>
<div class="line"><a id="l00278" name="l00278"></a><span class="lineno">  278</span><span class="keywordflow">       ENDIF</span></div>
<div class="line"><a id="l00279" name="l00279"></a><span class="lineno">  279</span> </div>
<div class="line"><a id="l00280" name="l00280"></a><span class="lineno">  280</span>       <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#abb6e84ee87a6fdb3281c33e8e8457a04">csnow</a> (sncond,sndens)</div>
<div class="line"><a id="l00281" name="l00281"></a><span class="lineno">  281</span> </div>
<div class="line"><a id="l00282" name="l00282"></a><span class="lineno">  282</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00283" name="l00283"></a><span class="lineno">  283</span><span class="comment">! PRECIP IS LIQUID (RAIN), HENCE SAVE IN THE PRECIP VARIABLE THAT</span></div>
<div class="line"><a id="l00284" name="l00284"></a><span class="lineno">  284</span><span class="comment">! LATER CAN WHOLELY OR PARTIALLY INFILTRATE THE SOIL</span></div>
<div class="line"><a id="l00285" name="l00285"></a><span class="lineno">  285</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00286" name="l00286"></a><span class="lineno">  286</span>    <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l00287" name="l00287"></a><span class="lineno">  287</span>       prcpf = prcp</div>
<div class="line"><a id="l00288" name="l00288"></a><span class="lineno">  288</span><span class="keywordflow">    ENDIF</span></div>
<div class="line"><a id="l00289" name="l00289"></a><span class="lineno">  289</span> </div>
<div class="line"><a id="l00290" name="l00290"></a><span class="lineno">  290</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00291" name="l00291"></a><span class="lineno">  291</span><span class="comment">! DETERMINE SNOW FRACTIONAL COVERAGE.</span></div>
<div class="line"><a id="l00292" name="l00292"></a><span class="lineno">  292</span><span class="comment">!      KWM:  Set SNCOVR to 1.0 because SNUP is set small in VEGPARM.TBL,</span></div>
<div class="line"><a id="l00293" name="l00293"></a><span class="lineno">  293</span><span class="comment">!      and SNEQV is at least 0.1 (as set above)</span></div>
<div class="line"><a id="l00294" name="l00294"></a><span class="lineno">  294</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00295" name="l00295"></a><span class="lineno">  295</span>    sncovr = 1.0 </div>
<div class="line"><a id="l00296" name="l00296"></a><span class="lineno">  296</span> </div>
<div class="line"><a id="l00297" name="l00297"></a><span class="lineno">  297</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00298" name="l00298"></a><span class="lineno">  298</span><span class="comment">! DETERMINE SURFACE ALBEDO MODIFICATION DUE TO SNOWDEPTH STATE.</span></div>
<div class="line"><a id="l00299" name="l00299"></a><span class="lineno">  299</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00300" name="l00300"></a><span class="lineno">  300</span> </div>
<div class="line"><a id="l00301" name="l00301"></a><span class="lineno">  301</span>    <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a7a78bcce992262a6c96711208974f7f1">alcalc</a> (alb,snoalb,embrd,t1,albedo,emissi,   &amp;</div>
<div class="line"><a id="l00302" name="l00302"></a><span class="lineno">  302</span>         &amp;       dt,snowng,snotime1) </div>
<div class="line"><a id="l00303" name="l00303"></a><span class="lineno">  303</span> </div>
<div class="line"><a id="l00304" name="l00304"></a><span class="lineno">  304</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00305" name="l00305"></a><span class="lineno">  305</span><span class="comment">! THERMAL CONDUCTIVITY </span></div>
<div class="line"><a id="l00306" name="l00306"></a><span class="lineno">  306</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00307" name="l00307"></a><span class="lineno">  307</span>    df1 = sncond</div>
<div class="line"><a id="l00308" name="l00308"></a><span class="lineno">  308</span> </div>
<div class="line"><a id="l00309" name="l00309"></a><span class="lineno">  309</span>    dsoil = - (0.5 * zsoil(1))</div>
<div class="line"><a id="l00310" name="l00310"></a><span class="lineno">  310</span>    dtot = snowh + dsoil</div>
<div class="line"><a id="l00311" name="l00311"></a><span class="lineno">  311</span>    frcsno = snowh / dtot</div>
<div class="line"><a id="l00312" name="l00312"></a><span class="lineno">  312</span> </div>
<div class="line"><a id="l00313" name="l00313"></a><span class="lineno">  313</span><span class="comment">! 1. HARMONIC MEAN (SERIES FLOW)</span></div>
<div class="line"><a id="l00314" name="l00314"></a><span class="lineno">  314</span><span class="comment">!        DF1 = (SNCOND*DF1)/(FRCSOI*SNCOND+FRCSNO*DF1)</span></div>
<div class="line"><a id="l00315" name="l00315"></a><span class="lineno">  315</span>    frcsoi = dsoil / dtot</div>
<div class="line"><a id="l00316" name="l00316"></a><span class="lineno">  316</span> </div>
<div class="line"><a id="l00317" name="l00317"></a><span class="lineno">  317</span><span class="comment">! 3. GEOMETRIC MEAN (INTERMEDIATE BETWEEN HARMONIC AND ARITHMETIC MEAN)</span></div>
<div class="line"><a id="l00318" name="l00318"></a><span class="lineno">  318</span><span class="comment">!        DF1 = (SNCOND**FRCSNO)*(DF1**FRCSOI)</span></div>
<div class="line"><a id="l00319" name="l00319"></a><span class="lineno">  319</span>    df1 = frcsno * sncond + frcsoi * df1</div>
<div class="line"><a id="l00320" name="l00320"></a><span class="lineno">  320</span> </div>
<div class="line"><a id="l00321" name="l00321"></a><span class="lineno">  321</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00322" name="l00322"></a><span class="lineno">  322</span><span class="comment">! CALCULATE SUBSURFACE HEAT FLUX, SSOIL, FROM FINAL THERMAL DIFFUSIVITY</span></div>
<div class="line"><a id="l00323" name="l00323"></a><span class="lineno">  323</span><span class="comment">! OF SURFACE MEDIUMS, DF1 ABOVE, AND SKIN TEMPERATURE AND TOP</span></div>
<div class="line"><a id="l00324" name="l00324"></a><span class="lineno">  324</span><span class="comment">! MID-LAYER SOIL TEMPERATURE</span></div>
<div class="line"><a id="l00325" name="l00325"></a><span class="lineno">  325</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00326" name="l00326"></a><span class="lineno">  326</span>    <span class="keywordflow">IF</span> ( dtot .GT. 2.*dsoil ) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00327" name="l00327"></a><span class="lineno">  327</span>       dtot = 2.*dsoil</div>
<div class="line"><a id="l00328" name="l00328"></a><span class="lineno">  328</span><span class="keywordflow">    ENDIF</span></div>
<div class="line"><a id="l00329" name="l00329"></a><span class="lineno">  329</span>    ssoil = df1 * ( t1 - stc(1) ) / dtot</div>
<div class="line"><a id="l00330" name="l00330"></a><span class="lineno">  330</span> </div>
<div class="line"><a id="l00331" name="l00331"></a><span class="lineno">  331</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00332" name="l00332"></a><span class="lineno">  332</span><span class="comment">! DETERMINE SURFACE ROUGHNESS OVER SNOWPACK USING SNOW CONDITION FROM</span></div>
<div class="line"><a id="l00333" name="l00333"></a><span class="lineno">  333</span><span class="comment">! THE PREVIOUS TIMESTEP.</span></div>
<div class="line"><a id="l00334" name="l00334"></a><span class="lineno">  334</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00335" name="l00335"></a><span class="lineno">  335</span> </div>
<div class="line"><a id="l00336" name="l00336"></a><span class="lineno">  336</span>    <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ab3693cb1c40b1bd7b4db5e96337f6eef">snowz0</a> (z0,z0brd,snowh)</div>
<div class="line"><a id="l00337" name="l00337"></a><span class="lineno">  337</span> </div>
<div class="line"><a id="l00338" name="l00338"></a><span class="lineno">  338</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00339" name="l00339"></a><span class="lineno">  339</span><span class="comment">! CALCULATE TOTAL DOWNWARD RADIATION (SOLAR PLUS LONGWAVE) NEEDED IN</span></div>
<div class="line"><a id="l00340" name="l00340"></a><span class="lineno">  340</span><span class="comment">! PENMAN EP SUBROUTINE THAT FOLLOWS</span></div>
<div class="line"><a id="l00341" name="l00341"></a><span class="lineno">  341</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00342" name="l00342"></a><span class="lineno">  342</span> </div>
<div class="line"><a id="l00343" name="l00343"></a><span class="lineno">  343</span>    fdown = solnet + lwdn</div>
<div class="line"><a id="l00344" name="l00344"></a><span class="lineno">  344</span> </div>
<div class="line"><a id="l00345" name="l00345"></a><span class="lineno">  345</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00346" name="l00346"></a><span class="lineno">  346</span><span class="comment">! CALC VIRTUAL TEMPS AND VIRTUAL POTENTIAL TEMPS NEEDED BY SUBROUTINES</span></div>
<div class="line"><a id="l00347" name="l00347"></a><span class="lineno">  347</span><span class="comment">! PENMAN.</span></div>
<div class="line"><a id="l00348" name="l00348"></a><span class="lineno">  348</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00349" name="l00349"></a><span class="lineno">  349</span> </div>
<div class="line"><a id="l00350" name="l00350"></a><span class="lineno">  350</span>    t2v = sfctmp * (1.0+ 0.61 * q2 )</div>
<div class="line"><a id="l00351" name="l00351"></a><span class="lineno">  351</span>    rho = sfcprs / (<a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a8df53633c056358bfa76c698ee182f17">rd</a> * t2v)</div>
<div class="line"><a id="l00352" name="l00352"></a><span class="lineno">  352</span>    rch = rho * 1004.6 * ch</div>
<div class="line"><a id="l00353" name="l00353"></a><span class="lineno">  353</span>    t24 = sfctmp * sfctmp * sfctmp * sfctmp</div>
<div class="line"><a id="l00354" name="l00354"></a><span class="lineno">  354</span> </div>
<div class="line"><a id="l00355" name="l00355"></a><span class="lineno">  355</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00356" name="l00356"></a><span class="lineno">  356</span><span class="comment">! CALL PENMAN SUBROUTINE TO CALCULATE POTENTIAL EVAPORATION (ETP), AND</span></div>
<div class="line"><a id="l00357" name="l00357"></a><span class="lineno">  357</span><span class="comment">! OTHER PARTIAL PRODUCTS AND SUMS SAVE IN COMMON/RITE FOR LATER</span></div>
<div class="line"><a id="l00358" name="l00358"></a><span class="lineno">  358</span><span class="comment">! CALCULATIONS.</span></div>
<div class="line"><a id="l00359" name="l00359"></a><span class="lineno">  359</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00360" name="l00360"></a><span class="lineno">  360</span> </div>
<div class="line"><a id="l00361" name="l00361"></a><span class="lineno">  361</span>    <span class="comment">! PENMAN returns ETP, FLX2, and RR</span></div>
<div class="line"><a id="l00362" name="l00362"></a><span class="lineno">  362</span>    <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a5312fbbf31302c20e6823a3d2e97033b">penman</a> (sfctmp,sfcprs,ch,th2,prcp,fdown,t24,ssoil,     &amp;</div>
<div class="line"><a id="l00363" name="l00363"></a><span class="lineno">  363</span>         &amp;       q2,q2sat,etp,rch,rr,snowng,frzgra,             &amp;</div>
<div class="line"><a id="l00364" name="l00364"></a><span class="lineno">  364</span>         &amp;       dqsdt2,flx2,emissi,t1)</div>
<div class="line"><a id="l00365" name="l00365"></a><span class="lineno">  365</span> </div>
<div class="line"><a id="l00366" name="l00366"></a><span class="lineno">  366</span>    <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ae27e8294cc66ecbb23f2a9d239a3c3d7">snopac</a> (etp,eta,prcp,prcpf,snowng,nsoil,dt,df1,        &amp;</div>
<div class="line"><a id="l00367" name="l00367"></a><span class="lineno">  367</span>         &amp;       q2,t1,sfctmp,t24,th2,fdown,ssoil,stc,          &amp;</div>
<div class="line"><a id="l00368" name="l00368"></a><span class="lineno">  368</span>         &amp;       sfcprs,rch,rr,sneqv,sndens,snowh,zsoil,tbot,   &amp;</div>
<div class="line"><a id="l00369" name="l00369"></a><span class="lineno">  369</span>         &amp;       snomlt,dew,flx1,flx2,flx3,esnow,emissi,ribb)</div>
<div class="line"><a id="l00370" name="l00370"></a><span class="lineno">  370</span> </div>
<div class="line"><a id="l00371" name="l00371"></a><span class="lineno">  371</span><span class="comment">!   ETA_KINEMATIC =  ESNOW</span></div>
<div class="line"><a id="l00372" name="l00372"></a><span class="lineno">  372</span>    eta_kinematic =  etp</div>
<div class="line"><a id="l00373" name="l00373"></a><span class="lineno">  373</span> </div>
<div class="line"><a id="l00374" name="l00374"></a><span class="lineno">  374</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00375" name="l00375"></a><span class="lineno">  375</span><span class="comment">! Effective mixing ratio at grnd level (skin)</span></div>
<div class="line"><a id="l00376" name="l00376"></a><span class="lineno">  376</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00377" name="l00377"></a><span class="lineno">  377</span>    q1=q2+eta_kinematic*cp/rch</div>
<div class="line"><a id="l00378" name="l00378"></a><span class="lineno">  378</span> </div>
<div class="line"><a id="l00379" name="l00379"></a><span class="lineno">  379</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00380" name="l00380"></a><span class="lineno">  380</span><span class="comment">! DETERMINE SENSIBLE HEAT (H) IN ENERGY UNITS (W M-2)</span></div>
<div class="line"><a id="l00381" name="l00381"></a><span class="lineno">  381</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00382" name="l00382"></a><span class="lineno">  382</span>    sheat = - (ch * cp * sfcprs)/ (r * t2v) * ( th2- t1 )</div>
<div class="line"><a id="l00383" name="l00383"></a><span class="lineno">  383</span> </div>
<div class="line"><a id="l00384" name="l00384"></a><span class="lineno">  384</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00385" name="l00385"></a><span class="lineno">  385</span><span class="comment">! CONVERT EVAP TERMS FROM KINEMATIC (KG M-2 S-1) TO ENERGY UNITS (W M-2)</span></div>
<div class="line"><a id="l00386" name="l00386"></a><span class="lineno">  386</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00387" name="l00387"></a><span class="lineno">  387</span>    esnow = esnow * lsubs</div>
<div class="line"><a id="l00388" name="l00388"></a><span class="lineno">  388</span>    etp   = etp   * lsubs</div>
<div class="line"><a id="l00389" name="l00389"></a><span class="lineno">  389</span>    <span class="keywordflow">IF</span> (etp .GT. 0.) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00390" name="l00390"></a><span class="lineno">  390</span>       eta = esnow</div>
<div class="line"><a id="l00391" name="l00391"></a><span class="lineno">  391</span>    <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l00392" name="l00392"></a><span class="lineno">  392</span>       eta = etp</div>
<div class="line"><a id="l00393" name="l00393"></a><span class="lineno">  393</span><span class="keywordflow">    ENDIF</span></div>
<div class="line"><a id="l00394" name="l00394"></a><span class="lineno">  394</span> </div>
<div class="line"><a id="l00395" name="l00395"></a><span class="lineno">  395</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00396" name="l00396"></a><span class="lineno">  396</span><span class="comment">! CONVERT THE SIGN OF SOIL HEAT FLUX SO THAT:</span></div>
<div class="line"><a id="l00397" name="l00397"></a><span class="lineno">  397</span><span class="comment">!   SSOIL&gt;0: WARM THE SURFACE  (NIGHT TIME)</span></div>
<div class="line"><a id="l00398" name="l00398"></a><span class="lineno">  398</span><span class="comment">!   SSOIL&lt;0: COOL THE SURFACE  (DAY TIME)</span></div>
<div class="line"><a id="l00399" name="l00399"></a><span class="lineno">  399</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00400" name="l00400"></a><span class="lineno">  400</span>    ssoil = -1.0* ssoil</div>
<div class="line"><a id="l00401" name="l00401"></a><span class="lineno">  401</span> </div>
<div class="line"><a id="l00402" name="l00402"></a><span class="lineno">  402</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00403" name="l00403"></a><span class="lineno">  403</span><span class="comment">! FOR THE CASE OF GLACIAL-ICE, ADD ANY SNOWMELT DIRECTLY TO SURFACE </span></div>
<div class="line"><a id="l00404" name="l00404"></a><span class="lineno">  404</span><span class="comment">! RUNOFF (RUNOFF1) SINCE THERE IS NO SOIL MEDIUM</span></div>
<div class="line"><a id="l00405" name="l00405"></a><span class="lineno">  405</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00406" name="l00406"></a><span class="lineno">  406</span>    runoff1 = snomlt / dt</div>
<div class="line"><a id="l00407" name="l00407"></a><span class="lineno">  407</span> </div>
<div class="line"><a id="l00408" name="l00408"></a><span class="lineno">  408</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00409" name="l00409"></a><span class="lineno">  409</span>  <span class="keyword">END SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm__glacial__only.html#afa7bc1c71f24bbd328e603892e6af3ba">sflx_glacial</a></div>
<div class="line"><a id="l00410" name="l00410"></a><span class="lineno">  410</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00411" name="l00411"></a><span class="lineno">  411</span> </div>
<div class="line"><a id="l00412" name="l00412"></a><span class="lineno">  412</span>  <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a7a78bcce992262a6c96711208974f7f1">alcalc</a> (ALB,SNOALB,EMBRD,TSNOW,ALBEDO,EMISSI,   &amp;</div>
<div class="line"><a id="l00413" name="l00413"></a><span class="lineno">  413</span>       &amp;             DT,SNOWNG,SNOTIME1)</div>
<div class="line"><a id="l00414" name="l00414"></a><span class="lineno">  414</span> </div>
<div class="line"><a id="l00415" name="l00415"></a><span class="lineno">  415</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00416" name="l00416"></a><span class="lineno">  416</span><span class="comment">! CALCULATE ALBEDO INCLUDING SNOW EFFECT (0 -&gt; 1)</span></div>
<div class="line"><a id="l00417" name="l00417"></a><span class="lineno">  417</span><span class="comment">!   ALB     SNOWFREE ALBEDO</span></div>
<div class="line"><a id="l00418" name="l00418"></a><span class="lineno">  418</span><span class="comment">!   SNOALB  MAXIMUM (DEEP) SNOW ALBEDO</span></div>
<div class="line"><a id="l00419" name="l00419"></a><span class="lineno">  419</span><span class="comment">!   ALBEDO  SURFACE ALBEDO INCLUDING SNOW EFFECT</span></div>
<div class="line"><a id="l00420" name="l00420"></a><span class="lineno">  420</span><span class="comment">!   TSNOW   SNOW SURFACE TEMPERATURE (K)</span></div>
<div class="line"><a id="l00421" name="l00421"></a><span class="lineno">  421</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00422" name="l00422"></a><span class="lineno">  422</span>    <span class="keywordtype">IMPLICIT NONE</span></div>
<div class="line"><a id="l00423" name="l00423"></a><span class="lineno">  423</span> </div>
<div class="line"><a id="l00424" name="l00424"></a><span class="lineno">  424</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00425" name="l00425"></a><span class="lineno">  425</span><span class="comment">! SNOALB IS ARGUMENT REPRESENTING MAXIMUM ALBEDO OVER DEEP SNOW,</span></div>
<div class="line"><a id="l00426" name="l00426"></a><span class="lineno">  426</span><span class="comment">! AS PASSED INTO SFLX, AND ADAPTED FROM THE SATELLITE-BASED MAXIMUM</span></div>
<div class="line"><a id="l00427" name="l00427"></a><span class="lineno">  427</span><span class="comment">! SNOW ALBEDO FIELDS PROVIDED BY D. ROBINSON AND G. KUKLA</span></div>
<div class="line"><a id="l00428" name="l00428"></a><span class="lineno">  428</span><span class="comment">! (1985, JCAM, VOL 24, 402-411)</span></div>
<div class="line"><a id="l00429" name="l00429"></a><span class="lineno">  429</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00430" name="l00430"></a><span class="lineno">  430</span><span class="keywordtype">    REAL</span>,    <span class="keywordtype">INTENT(IN)</span>    :: ALB, SNOALB, EMBRD, TSNOW</div>
<div class="line"><a id="l00431" name="l00431"></a><span class="lineno">  431</span><span class="keywordtype">    REAL</span>,    <span class="keywordtype">INTENT(IN)</span>    :: DT</div>
<div class="line"><a id="l00432" name="l00432"></a><span class="lineno">  432</span>    <span class="keywordtype">LOGICAL</span>, <span class="keywordtype">INTENT(IN)</span>    :: SNOWNG</div>
<div class="line"><a id="l00433" name="l00433"></a><span class="lineno">  433</span><span class="keywordtype">    REAL</span>,    <span class="keywordtype">INTENT(INOUT)</span> :: SNOTIME1</div>
<div class="line"><a id="l00434" name="l00434"></a><span class="lineno">  434</span><span class="keywordtype">    REAL</span>,    <span class="keywordtype">INTENT(OUT)</span>   :: ALBEDO, EMISSI</div>
<div class="line"><a id="l00435" name="l00435"></a><span class="lineno">  435</span><span class="keywordtype">    REAL</span>                   :: SNOALB2</div>
<div class="line"><a id="l00436" name="l00436"></a><span class="lineno">  436</span><span class="keywordtype">    REAL</span>                   :: TM,SNOALB1</div>
<div class="line"><a id="l00437" name="l00437"></a><span class="lineno">  437</span><span class="keywordtype">    REAL</span>,    <span class="keywordtype">PARAMETER</span>     :: SNACCA=0.94,snaccb=0.58,snthwa=0.82,snthwb=0.46</div>
<div class="line"><a id="l00438" name="l00438"></a><span class="lineno">  438</span><span class="comment">! turn off vegetation effect</span></div>
<div class="line"><a id="l00439" name="l00439"></a><span class="lineno">  439</span><span class="comment">!      ALBEDO = ALB + (1.0- (SHDFAC - SHDMIN))* SNCOVR * (SNOALB - ALB)</span></div>
<div class="line"><a id="l00440" name="l00440"></a><span class="lineno">  440</span><span class="comment">!      ALBEDO = (1.0-SNCOVR)*ALB + SNCOVR*SNOALB !this is equivalent to below</span></div>
<div class="line"><a id="l00441" name="l00441"></a><span class="lineno">  441</span>    albedo = alb + (snoalb-alb)</div>
<div class="line"><a id="l00442" name="l00442"></a><span class="lineno">  442</span>    emissi = embrd + (<a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a54e48804c7badd0dd8544b8c1dbcdf5f">emissi_s</a> - embrd)</div>
<div class="line"><a id="l00443" name="l00443"></a><span class="lineno">  443</span> </div>
<div class="line"><a id="l00444" name="l00444"></a><span class="lineno">  444</span><span class="comment">!     BASE FORMULATION (DICKINSON ET AL., 1986, COGLEY ET AL., 1990)</span></div>
<div class="line"><a id="l00445" name="l00445"></a><span class="lineno">  445</span><span class="comment">!          IF (TSNOW.LE.263.16) THEN</span></div>
<div class="line"><a id="l00446" name="l00446"></a><span class="lineno">  446</span><span class="comment">!            ALBEDO=SNOALB</span></div>
<div class="line"><a id="l00447" name="l00447"></a><span class="lineno">  447</span><span class="comment">!          ELSE</span></div>
<div class="line"><a id="l00448" name="l00448"></a><span class="lineno">  448</span><span class="comment">!            IF (TSNOW.LT.273.16) THEN</span></div>
<div class="line"><a id="l00449" name="l00449"></a><span class="lineno">  449</span><span class="comment">!              TM=0.1*(TSNOW-263.16)</span></div>
<div class="line"><a id="l00450" name="l00450"></a><span class="lineno">  450</span><span class="comment">!              SNOALB1=0.5*((0.9-0.2*(TM**3))+(0.8-0.16*(TM**3)))</span></div>
<div class="line"><a id="l00451" name="l00451"></a><span class="lineno">  451</span><span class="comment">!            ELSE</span></div>
<div class="line"><a id="l00452" name="l00452"></a><span class="lineno">  452</span><span class="comment">!              SNOALB1=0.67</span></div>
<div class="line"><a id="l00453" name="l00453"></a><span class="lineno">  453</span><span class="comment">!             IF(SNCOVR.GT.0.95) SNOALB1= 0.6</span></div>
<div class="line"><a id="l00454" name="l00454"></a><span class="lineno">  454</span><span class="comment">!             SNOALB1 = ALB + SNCOVR*(SNOALB-ALB)</span></div>
<div class="line"><a id="l00455" name="l00455"></a><span class="lineno">  455</span><span class="comment">!            ENDIF</span></div>
<div class="line"><a id="l00456" name="l00456"></a><span class="lineno">  456</span><span class="comment">!          ENDIF</span></div>
<div class="line"><a id="l00457" name="l00457"></a><span class="lineno">  457</span><span class="comment">!            ALBEDO = ALB + SNCOVR*(SNOALB1-ALB)</span></div>
<div class="line"><a id="l00458" name="l00458"></a><span class="lineno">  458</span> </div>
<div class="line"><a id="l00459" name="l00459"></a><span class="lineno">  459</span><span class="comment">!     ISBA FORMULATION (VERSEGHY, 1991; BAKER ET AL., 1990)</span></div>
<div class="line"><a id="l00460" name="l00460"></a><span class="lineno">  460</span><span class="comment">!          SNOALB1 = SNOALB+COEF*(0.85-SNOALB)</span></div>
<div class="line"><a id="l00461" name="l00461"></a><span class="lineno">  461</span><span class="comment">!          SNOALB2=SNOALB1</span></div>
<div class="line"><a id="l00462" name="l00462"></a><span class="lineno">  462</span><span class="comment">!!m          LSTSNW=LSTSNW+1</span></div>
<div class="line"><a id="l00463" name="l00463"></a><span class="lineno">  463</span><span class="comment">!          SNOTIME1 = SNOTIME1 + DT</span></div>
<div class="line"><a id="l00464" name="l00464"></a><span class="lineno">  464</span><span class="comment">!          IF (SNOWNG) THEN</span></div>
<div class="line"><a id="l00465" name="l00465"></a><span class="lineno">  465</span><span class="comment">!             SNOALB2=SNOALB</span></div>
<div class="line"><a id="l00466" name="l00466"></a><span class="lineno">  466</span><span class="comment">!!m             LSTSNW=0</span></div>
<div class="line"><a id="l00467" name="l00467"></a><span class="lineno">  467</span><span class="comment">!             SNOTIME1 = 0.0</span></div>
<div class="line"><a id="l00468" name="l00468"></a><span class="lineno">  468</span><span class="comment">!          ELSE</span></div>
<div class="line"><a id="l00469" name="l00469"></a><span class="lineno">  469</span><span class="comment">!            IF (TSNOW.LT.273.16) THEN</span></div>
<div class="line"><a id="l00470" name="l00470"></a><span class="lineno">  470</span><span class="comment">!!              SNOALB2=SNOALB-0.008*LSTSNW*DT/86400</span></div>
<div class="line"><a id="l00471" name="l00471"></a><span class="lineno">  471</span><span class="comment">!!m              SNOALB2=SNOALB-0.008*SNOTIME1/86400</span></div>
<div class="line"><a id="l00472" name="l00472"></a><span class="lineno">  472</span><span class="comment">!              SNOALB2=(SNOALB2-0.65)*EXP(-0.05*DT/3600)+0.65</span></div>
<div class="line"><a id="l00473" name="l00473"></a><span class="lineno">  473</span><span class="comment">!!              SNOALB2=(ALBEDO-0.65)*EXP(-0.01*DT/3600)+0.65</span></div>
<div class="line"><a id="l00474" name="l00474"></a><span class="lineno">  474</span><span class="comment">!            ELSE</span></div>
<div class="line"><a id="l00475" name="l00475"></a><span class="lineno">  475</span><span class="comment">!              SNOALB2=(SNOALB2-0.5)*EXP(-0.0005*DT/3600)+0.5</span></div>
<div class="line"><a id="l00476" name="l00476"></a><span class="lineno">  476</span><span class="comment">!!              SNOALB2=(SNOALB-0.5)*EXP(-0.24*LSTSNW*DT/86400)+0.5</span></div>
<div class="line"><a id="l00477" name="l00477"></a><span class="lineno">  477</span><span class="comment">!!m              SNOALB2=(SNOALB-0.5)*EXP(-0.24*SNOTIME1/86400)+0.5</span></div>
<div class="line"><a id="l00478" name="l00478"></a><span class="lineno">  478</span><span class="comment">!            ENDIF</span></div>
<div class="line"><a id="l00479" name="l00479"></a><span class="lineno">  479</span><span class="comment">!          ENDIF</span></div>
<div class="line"><a id="l00480" name="l00480"></a><span class="lineno">  480</span><span class="comment">!</span></div>
<div class="line"><a id="l00481" name="l00481"></a><span class="lineno">  481</span><span class="comment">!!               print*,&#39;SNOALB2&#39;,SNOALB2,&#39;ALBEDO&#39;,ALBEDO,&#39;DT&#39;,DT</span></div>
<div class="line"><a id="l00482" name="l00482"></a><span class="lineno">  482</span><span class="comment">!          ALBEDO = ALB + SNCOVR*(SNOALB2-ALB)</span></div>
<div class="line"><a id="l00483" name="l00483"></a><span class="lineno">  483</span><span class="comment">!          IF (ALBEDO .GT. SNOALB2) ALBEDO=SNOALB2</span></div>
<div class="line"><a id="l00484" name="l00484"></a><span class="lineno">  484</span><span class="comment">!!m          LSTSNW1=LSTSNW</span></div>
<div class="line"><a id="l00485" name="l00485"></a><span class="lineno">  485</span><span class="comment">!!          SNOTIME = SNOTIME1</span></div>
<div class="line"><a id="l00486" name="l00486"></a><span class="lineno">  486</span> </div>
<div class="line"><a id="l00487" name="l00487"></a><span class="lineno">  487</span><span class="comment">! formulation by Livneh</span></div>
<div class="line"><a id="l00488" name="l00488"></a><span class="lineno">  488</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00489" name="l00489"></a><span class="lineno">  489</span><span class="comment">! SNOALB IS CONSIDERED AS THE MAXIMUM SNOW ALBEDO FOR NEW SNOW, AT</span></div>
<div class="line"><a id="l00490" name="l00490"></a><span class="lineno">  490</span><span class="comment">! A VALUE OF 85%. SNOW ALBEDO CURVE DEFAULTS ARE FROM BRAS P.263. SHOULD</span></div>
<div class="line"><a id="l00491" name="l00491"></a><span class="lineno">  491</span><span class="comment">! NOT BE CHANGED EXCEPT FOR SERIOUS PROBLEMS WITH SNOW MELT.</span></div>
<div class="line"><a id="l00492" name="l00492"></a><span class="lineno">  492</span><span class="comment">! TO IMPLEMENT ACCUMULATIN PARAMETERS, SNACCA AND SNACCB, ASSERT THAT IT</span></div>
<div class="line"><a id="l00493" name="l00493"></a><span class="lineno">  493</span><span class="comment">! IS INDEED ACCUMULATION SEASON. I.E. THAT SNOW SURFACE TEMP IS BELOW</span></div>
<div class="line"><a id="l00494" name="l00494"></a><span class="lineno">  494</span><span class="comment">! ZERO AND THE DATE FALLS BETWEEN OCTOBER AND FEBRUARY</span></div>
<div class="line"><a id="l00495" name="l00495"></a><span class="lineno">  495</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00496" name="l00496"></a><span class="lineno">  496</span>    snoalb1 = snoalb+<a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#abfdd114973412069ebbfb3a61af8d995">lvcoef_data</a>*(0.85-snoalb)</div>
<div class="line"><a id="l00497" name="l00497"></a><span class="lineno">  497</span>    snoalb2=snoalb1</div>
<div class="line"><a id="l00498" name="l00498"></a><span class="lineno">  498</span><span class="comment">! ---------------- Initial LSTSNW --------------------------------------</span></div>
<div class="line"><a id="l00499" name="l00499"></a><span class="lineno">  499</span>    <span class="keywordflow">IF</span> (snowng) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00500" name="l00500"></a><span class="lineno">  500</span>       snotime1 = 0.</div>
<div class="line"><a id="l00501" name="l00501"></a><span class="lineno">  501</span>    <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l00502" name="l00502"></a><span class="lineno">  502</span>       snotime1=snotime1+dt</div>
<div class="line"><a id="l00503" name="l00503"></a><span class="lineno">  503</span><span class="comment">!               IF (TSNOW.LT.273.16) THEN</span></div>
<div class="line"><a id="l00504" name="l00504"></a><span class="lineno">  504</span>       snoalb2=snoalb1*(snacca**((snotime1/86400.0)**snaccb))</div>
<div class="line"><a id="l00505" name="l00505"></a><span class="lineno">  505</span><span class="comment">!               ELSE</span></div>
<div class="line"><a id="l00506" name="l00506"></a><span class="lineno">  506</span><span class="comment">!                  SNOALB2 =SNOALB1*(SNTHWA**((SNOTIME1/86400.0)**SNTHWB))</span></div>
<div class="line"><a id="l00507" name="l00507"></a><span class="lineno">  507</span><span class="comment">!               ENDIF</span></div>
<div class="line"><a id="l00508" name="l00508"></a><span class="lineno">  508</span><span class="keywordflow">    ENDIF</span></div>
<div class="line"><a id="l00509" name="l00509"></a><span class="lineno">  509</span> </div>
<div class="line"><a id="l00510" name="l00510"></a><span class="lineno">  510</span>    snoalb2 = max( snoalb2, alb )</div>
<div class="line"><a id="l00511" name="l00511"></a><span class="lineno">  511</span>    albedo = alb + (snoalb2-alb)</div>
<div class="line"><a id="l00512" name="l00512"></a><span class="lineno">  512</span>    <span class="keywordflow">IF</span> (albedo .GT. snoalb2) albedo=snoalb2</div>
<div class="line"><a id="l00513" name="l00513"></a><span class="lineno">  513</span> </div>
<div class="line"><a id="l00514" name="l00514"></a><span class="lineno">  514</span><span class="comment">!          IF (TSNOW.LT.273.16) THEN</span></div>
<div class="line"><a id="l00515" name="l00515"></a><span class="lineno">  515</span><span class="comment">!            ALBEDO=SNOALB-0.008*DT/86400</span></div>
<div class="line"><a id="l00516" name="l00516"></a><span class="lineno">  516</span><span class="comment">!          ELSE</span></div>
<div class="line"><a id="l00517" name="l00517"></a><span class="lineno">  517</span><span class="comment">!            ALBEDO=(SNOALB-0.5)*EXP(-0.24*DT/86400)+0.5</span></div>
<div class="line"><a id="l00518" name="l00518"></a><span class="lineno">  518</span><span class="comment">!          ENDIF</span></div>
<div class="line"><a id="l00519" name="l00519"></a><span class="lineno">  519</span> </div>
<div class="line"><a id="l00520" name="l00520"></a><span class="lineno">  520</span><span class="comment">!      IF (ALBEDO &gt; SNOALB) ALBEDO = SNOALB</span></div>
<div class="line"><a id="l00521" name="l00521"></a><span class="lineno">  521</span> </div>
<div class="line"><a id="l00522" name="l00522"></a><span class="lineno">  522</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00523" name="l00523"></a><span class="lineno">  523</span>  <span class="keyword">END SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a7a78bcce992262a6c96711208974f7f1">alcalc</a></div>
<div class="line"><a id="l00524" name="l00524"></a><span class="lineno">  524</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00525" name="l00525"></a><span class="lineno">  525</span> </div>
<div class="line"><a id="l00526" name="l00526"></a><span class="lineno">  526</span>  <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#abb6e84ee87a6fdb3281c33e8e8457a04">csnow</a> (SNCOND,DSNOW)</div>
<div class="line"><a id="l00527" name="l00527"></a><span class="lineno">  527</span> </div>
<div class="line"><a id="l00528" name="l00528"></a><span class="lineno">  528</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00529" name="l00529"></a><span class="lineno">  529</span><span class="comment">! CALCULATE SNOW TERMAL CONDUCTIVITY</span></div>
<div class="line"><a id="l00530" name="l00530"></a><span class="lineno">  530</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00531" name="l00531"></a><span class="lineno">  531</span>    <span class="keywordtype">IMPLICIT NONE</span></div>
<div class="line"><a id="l00532" name="l00532"></a><span class="lineno">  532</span><span class="keywordtype">    REAL</span>, <span class="keywordtype">INTENT(IN)</span>  :: DSNOW</div>
<div class="line"><a id="l00533" name="l00533"></a><span class="lineno">  533</span><span class="keywordtype">    REAL</span>, <span class="keywordtype">INTENT(OUT)</span> :: SNCOND</div>
<div class="line"><a id="l00534" name="l00534"></a><span class="lineno">  534</span><span class="keywordtype">    REAL</span>              :: C</div>
<div class="line"><a id="l00535" name="l00535"></a><span class="lineno">  535</span><span class="keywordtype">    REAL</span>, <span class="keywordtype">PARAMETER</span>   :: UNIT = 0.11631</div>
<div class="line"><a id="l00536" name="l00536"></a><span class="lineno">  536</span> </div>
<div class="line"><a id="l00537" name="l00537"></a><span class="lineno">  537</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00538" name="l00538"></a><span class="lineno">  538</span><span class="comment">! SNCOND IN UNITS OF CAL/(CM*HR*C), RETURNED IN W/(M*C)</span></div>
<div class="line"><a id="l00539" name="l00539"></a><span class="lineno">  539</span><span class="comment">! CSNOW IN UNITS OF CAL/(CM*HR*C), RETURNED IN W/(M*C)</span></div>
<div class="line"><a id="l00540" name="l00540"></a><span class="lineno">  540</span><span class="comment">! BASIC VERSION IS DYACHKOVA EQUATION (1960), FOR RANGE 0.1-0.4</span></div>
<div class="line"><a id="l00541" name="l00541"></a><span class="lineno">  541</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00542" name="l00542"></a><span class="lineno">  542</span>    c = 0.328*10** (2.25* dsnow)</div>
<div class="line"><a id="l00543" name="l00543"></a><span class="lineno">  543</span><span class="comment">!      CSNOW=UNIT*C</span></div>
<div class="line"><a id="l00544" name="l00544"></a><span class="lineno">  544</span> </div>
<div class="line"><a id="l00545" name="l00545"></a><span class="lineno">  545</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00546" name="l00546"></a><span class="lineno">  546</span><span class="comment">! DE VAUX EQUATION (1933), IN RANGE 0.1-0.6</span></div>
<div class="line"><a id="l00547" name="l00547"></a><span class="lineno">  547</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00548" name="l00548"></a><span class="lineno">  548</span><span class="comment">!      SNCOND=0.0293*(1.+100.*DSNOW**2)</span></div>
<div class="line"><a id="l00549" name="l00549"></a><span class="lineno">  549</span><span class="comment">!      CSNOW=0.0293*(1.+100.*DSNOW**2)</span></div>
<div class="line"><a id="l00550" name="l00550"></a><span class="lineno">  550</span> </div>
<div class="line"><a id="l00551" name="l00551"></a><span class="lineno">  551</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00552" name="l00552"></a><span class="lineno">  552</span><span class="comment">! E. ANDERSEN FROM FLERCHINGER</span></div>
<div class="line"><a id="l00553" name="l00553"></a><span class="lineno">  553</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00554" name="l00554"></a><span class="lineno">  554</span><span class="comment">!      SNCOND=0.021+2.51*DSNOW**2</span></div>
<div class="line"><a id="l00555" name="l00555"></a><span class="lineno">  555</span><span class="comment">!      CSNOW=0.021+2.51*DSNOW**2</span></div>
<div class="line"><a id="l00556" name="l00556"></a><span class="lineno">  556</span> </div>
<div class="line"><a id="l00557" name="l00557"></a><span class="lineno">  557</span><span class="comment">!      SNCOND = UNIT * C</span></div>
<div class="line"><a id="l00558" name="l00558"></a><span class="lineno">  558</span><span class="comment">! double snow thermal conductivity</span></div>
<div class="line"><a id="l00559" name="l00559"></a><span class="lineno">  559</span>    sncond = 2.0 * unit * c</div>
<div class="line"><a id="l00560" name="l00560"></a><span class="lineno">  560</span> </div>
<div class="line"><a id="l00561" name="l00561"></a><span class="lineno">  561</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00562" name="l00562"></a><span class="lineno">  562</span>  <span class="keyword">END SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#abb6e84ee87a6fdb3281c33e8e8457a04">csnow</a></div>
<div class="line"><a id="l00563" name="l00563"></a><span class="lineno">  563</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00564" name="l00564"></a><span class="lineno">  564</span> </div>
<div class="line"><a id="l00565" name="l00565"></a><span class="lineno">  565</span>  <span class="keyword">SUBROUTINE </span>hrtice (RHSTS,STC,TBOT,NSOIL,ZSOIL,YY,ZZ1,DF1,AI,BI,CI)</div>
<div class="line"><a id="l00566" name="l00566"></a><span class="lineno">  566</span> </div>
<div class="line"><a id="l00567" name="l00567"></a><span class="lineno">  567</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00568" name="l00568"></a><span class="lineno">  568</span><span class="comment">! CALCULATE THE RIGHT HAND SIDE OF THE TIME TENDENCY TERM OF THE SOIL</span></div>
<div class="line"><a id="l00569" name="l00569"></a><span class="lineno">  569</span><span class="comment">! THERMAL DIFFUSION EQUATION IN THE CASE OF SEA-ICE (ICE=1) OR GLACIAL</span></div>
<div class="line"><a id="l00570" name="l00570"></a><span class="lineno">  570</span><span class="comment">! ICE (ICE=-1). COMPUTE (PREPARE) THE MATRIX COEFFICIENTS FOR THE</span></div>
<div class="line"><a id="l00571" name="l00571"></a><span class="lineno">  571</span><span class="comment">! TRI-DIAGONAL MATRIX OF THE IMPLICIT TIME SCHEME.</span></div>
<div class="line"><a id="l00572" name="l00572"></a><span class="lineno">  572</span><span class="comment">!</span></div>
<div class="line"><a id="l00573" name="l00573"></a><span class="lineno">  573</span><span class="comment">! (NOTE:  THIS SUBROUTINE ONLY CALLED FOR SEA-ICE OR GLACIAL ICE, BUT</span></div>
<div class="line"><a id="l00574" name="l00574"></a><span class="lineno">  574</span><span class="comment">! NOT FOR NON-GLACIAL LAND (ICE = 0).</span></div>
<div class="line"><a id="l00575" name="l00575"></a><span class="lineno">  575</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00576" name="l00576"></a><span class="lineno">  576</span>    <span class="keywordtype">IMPLICIT NONE</span></div>
<div class="line"><a id="l00577" name="l00577"></a><span class="lineno">  577</span> </div>
<div class="line"><a id="l00578" name="l00578"></a><span class="lineno">  578</span> </div>
<div class="line"><a id="l00579" name="l00579"></a><span class="lineno">  579</span>    <span class="keywordtype">INTEGER</span>,                  <span class="keywordtype">INTENT(IN)</span>  :: NSOIL</div>
<div class="line"><a id="l00580" name="l00580"></a><span class="lineno">  580</span><span class="keywordtype">    REAL</span>,                     <span class="keywordtype">INTENT(IN)</span>  :: DF1,YY,ZZ1</div>
<div class="line"><a id="l00581" name="l00581"></a><span class="lineno">  581</span><span class="keywordtype">    REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(OUT)</span> :: AI, BI,CI</div>
<div class="line"><a id="l00582" name="l00582"></a><span class="lineno">  582</span><span class="keywordtype">    REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(IN)</span>  :: STC, ZSOIL</div>
<div class="line"><a id="l00583" name="l00583"></a><span class="lineno">  583</span><span class="keywordtype">    REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(OUT)</span> :: RHSTS</div>
<div class="line"><a id="l00584" name="l00584"></a><span class="lineno">  584</span><span class="keywordtype">    REAL</span>,                     <span class="keywordtype">INTENT(IN)</span>  :: TBOT</div>
<div class="line"><a id="l00585" name="l00585"></a><span class="lineno">  585</span>    <span class="keywordtype">INTEGER</span>                :: K</div>
<div class="line"><a id="l00586" name="l00586"></a><span class="lineno">  586</span><span class="keywordtype">    REAL</span>                   :: DDZ,DDZ2,DENOM,DTSDZ,DTSDZ2,SSOIL,HCPCT</div>
<div class="line"><a id="l00587" name="l00587"></a><span class="lineno">  587</span><span class="keywordtype">    REAL</span>                   :: DF1K,DF1N</div>
<div class="line"><a id="l00588" name="l00588"></a><span class="lineno">  588</span><span class="keywordtype">    REAL</span>                   :: ZMD</div>
<div class="line"><a id="l00589" name="l00589"></a><span class="lineno">  589</span><span class="keywordtype">    REAL</span>, <span class="keywordtype">PARAMETER</span>        :: ZBOT = -25.0</div>
<div class="line"><a id="l00590" name="l00590"></a><span class="lineno">  590</span> </div>
<div class="line"><a id="l00591" name="l00591"></a><span class="lineno">  591</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00592" name="l00592"></a><span class="lineno">  592</span><span class="comment">! SET A NOMINAL UNIVERSAL VALUE OF GLACIAL-ICE SPECIFIC HEAT CAPACITY,</span></div>
<div class="line"><a id="l00593" name="l00593"></a><span class="lineno">  593</span><span class="comment">!   HCPCT = 2100.0*900.0 = 1.89000E+6 (SOURCE:  BOB GRUMBINE, 2005)</span></div>
<div class="line"><a id="l00594" name="l00594"></a><span class="lineno">  594</span><span class="comment">!   TBOT PASSED IN AS ARGUMENT, VALUE FROM GLOBAL DATA SET</span></div>
<div class="line"><a id="l00595" name="l00595"></a><span class="lineno">  595</span>    <span class="comment">!</span></div>
<div class="line"><a id="l00596" name="l00596"></a><span class="lineno">  596</span>    <span class="comment">! A least-squares fit for the four points provided by</span></div>
<div class="line"><a id="l00597" name="l00597"></a><span class="lineno">  597</span>    <span class="comment">! Keith Hines for the Yen (1981) values for Antarctic</span></div>
<div class="line"><a id="l00598" name="l00598"></a><span class="lineno">  598</span>    <span class="comment">! snow firn.</span></div>
<div class="line"><a id="l00599" name="l00599"></a><span class="lineno">  599</span>    <span class="comment">!</span></div>
<div class="line"><a id="l00600" name="l00600"></a><span class="lineno">  600</span>    hcpct = 1.e6 * (0.8194 - 0.1309*0.5*zsoil(1))</div>
<div class="line"><a id="l00601" name="l00601"></a><span class="lineno">  601</span>    df1k = df1</div>
<div class="line"><a id="l00602" name="l00602"></a><span class="lineno">  602</span> </div>
<div class="line"><a id="l00603" name="l00603"></a><span class="lineno">  603</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00604" name="l00604"></a><span class="lineno">  604</span><span class="comment">! THE INPUT ARGUMENT DF1 IS A UNIVERSALLY CONSTANT VALUE OF SEA-ICE</span></div>
<div class="line"><a id="l00605" name="l00605"></a><span class="lineno">  605</span><span class="comment">! THERMAL DIFFUSIVITY, SET IN ROUTINE SNOPAC AS DF1 = 2.2.</span></div>
<div class="line"><a id="l00606" name="l00606"></a><span class="lineno">  606</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00607" name="l00607"></a><span class="lineno">  607</span><span class="comment">! SET ICE PACK DEPTH.  USE TBOT AS ICE PACK LOWER BOUNDARY TEMPERATURE</span></div>
<div class="line"><a id="l00608" name="l00608"></a><span class="lineno">  608</span><span class="comment">! (THAT OF UNFROZEN SEA WATER AT BOTTOM OF SEA ICE PACK).  ASSUME ICE</span></div>
<div class="line"><a id="l00609" name="l00609"></a><span class="lineno">  609</span><span class="comment">! PACK IS OF N=NSOIL LAYERS SPANNING A UNIFORM CONSTANT ICE PACK</span></div>
<div class="line"><a id="l00610" name="l00610"></a><span class="lineno">  610</span><span class="comment">! THICKNESS AS DEFINED BY ZSOIL(NSOIL) IN ROUTINE SFLX.</span></div>
<div class="line"><a id="l00611" name="l00611"></a><span class="lineno">  611</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00612" name="l00612"></a><span class="lineno">  612</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00613" name="l00613"></a><span class="lineno">  613</span><span class="comment">! CALC THE MATRIX COEFFICIENTS AI, BI, AND CI FOR THE TOP LAYER</span></div>
<div class="line"><a id="l00614" name="l00614"></a><span class="lineno">  614</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00615" name="l00615"></a><span class="lineno">  615</span>    ddz = 1.0 / ( -0.5 * zsoil(2) )</div>
<div class="line"><a id="l00616" name="l00616"></a><span class="lineno">  616</span>    ai(1) = 0.0</div>
<div class="line"><a id="l00617" name="l00617"></a><span class="lineno">  617</span>    ci(1) = (df1 * ddz) / (zsoil(1) * hcpct)</div>
<div class="line"><a id="l00618" name="l00618"></a><span class="lineno">  618</span> </div>
<div class="line"><a id="l00619" name="l00619"></a><span class="lineno">  619</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00620" name="l00620"></a><span class="lineno">  620</span><span class="comment">! CALC THE VERTICAL SOIL TEMP GRADIENT BTWN THE TOP AND 2ND SOIL LAYERS.</span></div>
<div class="line"><a id="l00621" name="l00621"></a><span class="lineno">  621</span><span class="comment">! RECALC/ADJUST THE SOIL HEAT FLUX.  USE THE GRADIENT AND FLUX TO CALC</span></div>
<div class="line"><a id="l00622" name="l00622"></a><span class="lineno">  622</span><span class="comment">! RHSTS FOR THE TOP SOIL LAYER.</span></div>
<div class="line"><a id="l00623" name="l00623"></a><span class="lineno">  623</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00624" name="l00624"></a><span class="lineno">  624</span>    bi(1) = - ci(1) + df1/ (0.5 * zsoil(1) * zsoil(1) * hcpct *    &amp;</div>
<div class="line"><a id="l00625" name="l00625"></a><span class="lineno">  625</span>         &amp;   zz1)</div>
<div class="line"><a id="l00626" name="l00626"></a><span class="lineno">  626</span>    dtsdz = ( stc(1) - stc(2) ) / ( -0.5 * zsoil(2) )</div>
<div class="line"><a id="l00627" name="l00627"></a><span class="lineno">  627</span>    ssoil = df1 * ( stc(1) - yy ) / ( 0.5 * zsoil(1) * zz1 )</div>
<div class="line"><a id="l00628" name="l00628"></a><span class="lineno">  628</span> </div>
<div class="line"><a id="l00629" name="l00629"></a><span class="lineno">  629</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00630" name="l00630"></a><span class="lineno">  630</span><span class="comment">! INITIALIZE DDZ2</span></div>
<div class="line"><a id="l00631" name="l00631"></a><span class="lineno">  631</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00632" name="l00632"></a><span class="lineno">  632</span>    rhsts(1) = ( df1 * dtsdz - ssoil ) / ( zsoil(1) * hcpct )</div>
<div class="line"><a id="l00633" name="l00633"></a><span class="lineno">  633</span> </div>
<div class="line"><a id="l00634" name="l00634"></a><span class="lineno">  634</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00635" name="l00635"></a><span class="lineno">  635</span><span class="comment">! LOOP THRU THE REMAINING SOIL LAYERS, REPEATING THE ABOVE PROCESS</span></div>
<div class="line"><a id="l00636" name="l00636"></a><span class="lineno">  636</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00637" name="l00637"></a><span class="lineno">  637</span>    ddz2 = 0.0</div>
<div class="line"><a id="l00638" name="l00638"></a><span class="lineno">  638</span>    df1k = df1</div>
<div class="line"><a id="l00639" name="l00639"></a><span class="lineno">  639</span>    df1n = df1</div>
<div class="line"><a id="l00640" name="l00640"></a><span class="lineno">  640</span>    <span class="keywordflow">DO</span> k = 2,nsoil</div>
<div class="line"><a id="l00641" name="l00641"></a><span class="lineno">  641</span> </div>
<div class="line"><a id="l00642" name="l00642"></a><span class="lineno">  642</span>       zmd = 0.5 * (zsoil(k)+zsoil(k-1))</div>
<div class="line"><a id="l00643" name="l00643"></a><span class="lineno">  643</span>       <span class="comment">! For the land-ice case</span></div>
<div class="line"><a id="l00644" name="l00644"></a><span class="lineno">  644</span><span class="comment">! kmh 09/03/2006 use Yen (1981)&#39;s values for Antarctic snow firn</span></div>
<div class="line"><a id="l00645" name="l00645"></a><span class="lineno">  645</span><span class="comment">!         IF ( K .eq. 2 ) HCPCT = 0.855108E6</span></div>
<div class="line"><a id="l00646" name="l00646"></a><span class="lineno">  646</span><span class="comment">!         IF ( K .eq. 3 ) HCPCT = 0.922906E6</span></div>
<div class="line"><a id="l00647" name="l00647"></a><span class="lineno">  647</span><span class="comment">!         IF ( K .eq. 4 ) HCPCT = 1.009986E6</span></div>
<div class="line"><a id="l00648" name="l00648"></a><span class="lineno">  648</span> </div>
<div class="line"><a id="l00649" name="l00649"></a><span class="lineno">  649</span>       <span class="comment">! Least squares fit to the four points supplied by Keith Hines</span></div>
<div class="line"><a id="l00650" name="l00650"></a><span class="lineno">  650</span>       <span class="comment">! from Yen (1981) for Antarctic snow firn.  Not optimal, but</span></div>
<div class="line"><a id="l00651" name="l00651"></a><span class="lineno">  651</span>       <span class="comment">! probably better than just a constant.</span></div>
<div class="line"><a id="l00652" name="l00652"></a><span class="lineno">  652</span>       hcpct = 1.e6 * ( 0.8194 - 0.1309*zmd )</div>
<div class="line"><a id="l00653" name="l00653"></a><span class="lineno">  653</span> </div>
<div class="line"><a id="l00654" name="l00654"></a><span class="lineno">  654</span><span class="comment">!         IF ( K .eq. 2 ) DF1N = 0.345356</span></div>
<div class="line"><a id="l00655" name="l00655"></a><span class="lineno">  655</span><span class="comment">!         IF ( K .eq. 3 ) DF1N = 0.398777</span></div>
<div class="line"><a id="l00656" name="l00656"></a><span class="lineno">  656</span><span class="comment">!         IF ( K .eq. 4 ) DF1N = 0.472653</span></div>
<div class="line"><a id="l00657" name="l00657"></a><span class="lineno">  657</span> </div>
<div class="line"><a id="l00658" name="l00658"></a><span class="lineno">  658</span>       <span class="comment">! Least squares fit to the three points supplied by Keith Hines</span></div>
<div class="line"><a id="l00659" name="l00659"></a><span class="lineno">  659</span>       <span class="comment">! from Yen (1981) for Antarctic snow firn.  Not optimal, but</span></div>
<div class="line"><a id="l00660" name="l00660"></a><span class="lineno">  660</span>       <span class="comment">! probably better than just a constant.</span></div>
<div class="line"><a id="l00661" name="l00661"></a><span class="lineno">  661</span>       df1n = 0.32333 - ( 0.10073 * zmd )</div>
<div class="line"><a id="l00662" name="l00662"></a><span class="lineno">  662</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00663" name="l00663"></a><span class="lineno">  663</span><span class="comment">! CALC THE VERTICAL SOIL TEMP GRADIENT THRU THIS LAYER.</span></div>
<div class="line"><a id="l00664" name="l00664"></a><span class="lineno">  664</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00665" name="l00665"></a><span class="lineno">  665</span>       <span class="keywordflow">IF</span> (k /= nsoil) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00666" name="l00666"></a><span class="lineno">  666</span>          denom = 0.5 * ( zsoil(k -1) - zsoil(k +1) )</div>
<div class="line"><a id="l00667" name="l00667"></a><span class="lineno">  667</span> </div>
<div class="line"><a id="l00668" name="l00668"></a><span class="lineno">  668</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00669" name="l00669"></a><span class="lineno">  669</span><span class="comment">! CALC THE MATRIX COEF, CI, AFTER CALC&#39;NG ITS PARTIAL PRODUCT.</span></div>
<div class="line"><a id="l00670" name="l00670"></a><span class="lineno">  670</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00671" name="l00671"></a><span class="lineno">  671</span>          dtsdz2 = ( stc(k) - stc(k +1) ) / denom</div>
<div class="line"><a id="l00672" name="l00672"></a><span class="lineno">  672</span>          ddz2 = 2. / (zsoil(k -1) - zsoil(k +1))</div>
<div class="line"><a id="l00673" name="l00673"></a><span class="lineno">  673</span>          ci(k) = - df1n * ddz2 / ( (zsoil(k -1) - zsoil(k))*hcpct)</div>
<div class="line"><a id="l00674" name="l00674"></a><span class="lineno">  674</span> </div>
<div class="line"><a id="l00675" name="l00675"></a><span class="lineno">  675</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00676" name="l00676"></a><span class="lineno">  676</span><span class="comment">! CALC THE VERTICAL SOIL TEMP GRADIENT THRU THE LOWEST LAYER.</span></div>
<div class="line"><a id="l00677" name="l00677"></a><span class="lineno">  677</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00678" name="l00678"></a><span class="lineno">  678</span>       <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l00679" name="l00679"></a><span class="lineno">  679</span> </div>
<div class="line"><a id="l00680" name="l00680"></a><span class="lineno">  680</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00681" name="l00681"></a><span class="lineno">  681</span><span class="comment">! SET MATRIX COEF, CI TO ZERO.</span></div>
<div class="line"><a id="l00682" name="l00682"></a><span class="lineno">  682</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00683" name="l00683"></a><span class="lineno">  683</span>          dtsdz2 = (stc(k) - tbot)/ (.5 * (zsoil(k -1) + zsoil(k)) &amp;</div>
<div class="line"><a id="l00684" name="l00684"></a><span class="lineno">  684</span>               &amp;   - zbot)</div>
<div class="line"><a id="l00685" name="l00685"></a><span class="lineno">  685</span>          ci(k) = 0.</div>
<div class="line"><a id="l00686" name="l00686"></a><span class="lineno">  686</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00687" name="l00687"></a><span class="lineno">  687</span><span class="comment">! CALC RHSTS FOR THIS LAYER AFTER CALC&#39;NG A PARTIAL PRODUCT.</span></div>
<div class="line"><a id="l00688" name="l00688"></a><span class="lineno">  688</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00689" name="l00689"></a><span class="lineno">  689</span><span class="keywordflow">       END IF</span></div>
<div class="line"><a id="l00690" name="l00690"></a><span class="lineno">  690</span>       denom = ( zsoil(k) - zsoil(k -1) ) * hcpct</div>
<div class="line"><a id="l00691" name="l00691"></a><span class="lineno">  691</span> </div>
<div class="line"><a id="l00692" name="l00692"></a><span class="lineno">  692</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00693" name="l00693"></a><span class="lineno">  693</span><span class="comment">! CALC MATRIX COEFS, AI, AND BI FOR THIS LAYER.</span></div>
<div class="line"><a id="l00694" name="l00694"></a><span class="lineno">  694</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00695" name="l00695"></a><span class="lineno">  695</span>       rhsts(k) = ( df1n * dtsdz2- df1k * dtsdz ) / denom</div>
<div class="line"><a id="l00696" name="l00696"></a><span class="lineno">  696</span>       ai(k) = - df1k * ddz / ( (zsoil(k -1) - zsoil(k)) * hcpct)</div>
<div class="line"><a id="l00697" name="l00697"></a><span class="lineno">  697</span> </div>
<div class="line"><a id="l00698" name="l00698"></a><span class="lineno">  698</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00699" name="l00699"></a><span class="lineno">  699</span><span class="comment">! RESET VALUES OF DTSDZ AND DDZ FOR LOOP TO NEXT SOIL LYR.</span></div>
<div class="line"><a id="l00700" name="l00700"></a><span class="lineno">  700</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00701" name="l00701"></a><span class="lineno">  701</span>       bi(k) = - (ai(k) + ci(k))</div>
<div class="line"><a id="l00702" name="l00702"></a><span class="lineno">  702</span>       df1k = df1n</div>
<div class="line"><a id="l00703" name="l00703"></a><span class="lineno">  703</span>       dtsdz = dtsdz2</div>
<div class="line"><a id="l00704" name="l00704"></a><span class="lineno">  704</span>       ddz = ddz2</div>
<div class="line"><a id="l00705" name="l00705"></a><span class="lineno">  705</span><span class="keywordflow">    END DO</span></div>
<div class="line"><a id="l00706" name="l00706"></a><span class="lineno">  706</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00707" name="l00707"></a><span class="lineno">  707</span>  <span class="keyword">END SUBROUTINE </span>hrtice</div>
<div class="line"><a id="l00708" name="l00708"></a><span class="lineno">  708</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00709" name="l00709"></a><span class="lineno">  709</span> </div>
<div class="line"><a id="l00710" name="l00710"></a><span class="lineno">  710</span>  <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#adacf01be4e33445ea186feffce24eb35">hstep</a> (STCOUT,STCIN,RHSTS,DT,NSOIL,AI,BI,CI)</div>
<div class="line"><a id="l00711" name="l00711"></a><span class="lineno">  711</span> </div>
<div class="line"><a id="l00712" name="l00712"></a><span class="lineno">  712</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00713" name="l00713"></a><span class="lineno">  713</span><span class="comment">! CALCULATE/UPDATE THE SOIL TEMPERATURE FIELD.</span></div>
<div class="line"><a id="l00714" name="l00714"></a><span class="lineno">  714</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00715" name="l00715"></a><span class="lineno">  715</span>    <span class="keywordtype">IMPLICIT NONE</span></div>
<div class="line"><a id="l00716" name="l00716"></a><span class="lineno">  716</span>    <span class="keywordtype">INTEGER</span>,                  <span class="keywordtype">INTENT(IN)</span>    :: NSOIL</div>
<div class="line"><a id="l00717" name="l00717"></a><span class="lineno">  717</span><span class="keywordtype">    REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(IN)</span>    :: STCIN</div>
<div class="line"><a id="l00718" name="l00718"></a><span class="lineno">  718</span><span class="keywordtype">    REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(OUT)</span>   :: STCOUT</div>
<div class="line"><a id="l00719" name="l00719"></a><span class="lineno">  719</span><span class="keywordtype">    REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(INOUT)</span> :: RHSTS</div>
<div class="line"><a id="l00720" name="l00720"></a><span class="lineno">  720</span><span class="keywordtype">    REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(INOUT)</span> :: AI,BI,CI</div>
<div class="line"><a id="l00721" name="l00721"></a><span class="lineno">  721</span><span class="keywordtype">    REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span> :: RHSTSin</div>
<div class="line"><a id="l00722" name="l00722"></a><span class="lineno">  722</span><span class="keywordtype">    REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span> :: CIin</div>
<div class="line"><a id="l00723" name="l00723"></a><span class="lineno">  723</span><span class="keywordtype">    REAL</span>                     :: DT</div>
<div class="line"><a id="l00724" name="l00724"></a><span class="lineno">  724</span>    <span class="keywordtype">INTEGER</span>                  :: K</div>
<div class="line"><a id="l00725" name="l00725"></a><span class="lineno">  725</span> </div>
<div class="line"><a id="l00726" name="l00726"></a><span class="lineno">  726</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00727" name="l00727"></a><span class="lineno">  727</span><span class="comment">! CREATE FINITE DIFFERENCE VALUES FOR USE IN ROSR12 ROUTINE</span></div>
<div class="line"><a id="l00728" name="l00728"></a><span class="lineno">  728</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00729" name="l00729"></a><span class="lineno">  729</span>    <span class="keywordflow">DO</span> k = 1,nsoil</div>
<div class="line"><a id="l00730" name="l00730"></a><span class="lineno">  730</span>       rhsts(k) = rhsts(k) * dt</div>
<div class="line"><a id="l00731" name="l00731"></a><span class="lineno">  731</span>       ai(k) = ai(k) * dt</div>
<div class="line"><a id="l00732" name="l00732"></a><span class="lineno">  732</span>       bi(k) = 1. + bi(k) * dt</div>
<div class="line"><a id="l00733" name="l00733"></a><span class="lineno">  733</span>       ci(k) = ci(k) * dt</div>
<div class="line"><a id="l00734" name="l00734"></a><span class="lineno">  734</span><span class="keywordflow">    END DO</span></div>
<div class="line"><a id="l00735" name="l00735"></a><span class="lineno">  735</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00736" name="l00736"></a><span class="lineno">  736</span><span class="comment">! COPY VALUES FOR INPUT VARIABLES BEFORE CALL TO ROSR12</span></div>
<div class="line"><a id="l00737" name="l00737"></a><span class="lineno">  737</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00738" name="l00738"></a><span class="lineno">  738</span>    <span class="keywordflow">DO</span> k = 1,nsoil</div>
<div class="line"><a id="l00739" name="l00739"></a><span class="lineno">  739</span>       rhstsin(k) = rhsts(k)</div>
<div class="line"><a id="l00740" name="l00740"></a><span class="lineno">  740</span><span class="keywordflow">    END DO</span></div>
<div class="line"><a id="l00741" name="l00741"></a><span class="lineno">  741</span>    <span class="keywordflow">DO</span> k = 1,nsoil</div>
<div class="line"><a id="l00742" name="l00742"></a><span class="lineno">  742</span>       ciin(k) = ci(k)</div>
<div class="line"><a id="l00743" name="l00743"></a><span class="lineno">  743</span><span class="keywordflow">    END DO</span></div>
<div class="line"><a id="l00744" name="l00744"></a><span class="lineno">  744</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00745" name="l00745"></a><span class="lineno">  745</span><span class="comment">! SOLVE THE TRI-DIAGONAL MATRIX EQUATION</span></div>
<div class="line"><a id="l00746" name="l00746"></a><span class="lineno">  746</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00747" name="l00747"></a><span class="lineno">  747</span>    <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ac6e3e7bb3f0322070546653306177216">rosr12</a> (ci,ai,bi,ciin,rhstsin,rhsts,nsoil)</div>
<div class="line"><a id="l00748" name="l00748"></a><span class="lineno">  748</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00749" name="l00749"></a><span class="lineno">  749</span><span class="comment">! CALC/UPDATE THE SOIL TEMPS USING MATRIX SOLUTION</span></div>
<div class="line"><a id="l00750" name="l00750"></a><span class="lineno">  750</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00751" name="l00751"></a><span class="lineno">  751</span>    <span class="keywordflow">DO</span> k = 1,nsoil</div>
<div class="line"><a id="l00752" name="l00752"></a><span class="lineno">  752</span>       stcout(k) = stcin(k) + ci(k)</div>
<div class="line"><a id="l00753" name="l00753"></a><span class="lineno">  753</span><span class="keywordflow">    END DO</span></div>
<div class="line"><a id="l00754" name="l00754"></a><span class="lineno">  754</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00755" name="l00755"></a><span class="lineno">  755</span>  <span class="keyword">END SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#adacf01be4e33445ea186feffce24eb35">hstep</a></div>
<div class="line"><a id="l00756" name="l00756"></a><span class="lineno">  756</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00757" name="l00757"></a><span class="lineno">  757</span> </div>
<div class="line"><a id="l00758" name="l00758"></a><span class="lineno">  758</span>  <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a5312fbbf31302c20e6823a3d2e97033b">penman</a> (SFCTMP,SFCPRS,CH,TH2,PRCP,FDOWN,T24,SSOIL, &amp;</div>
<div class="line"><a id="l00759" name="l00759"></a><span class="lineno">  759</span>       &amp;             Q2,Q2SAT,ETP,RCH,RR,SNOWNG,FRZGRA,       &amp;</div>
<div class="line"><a id="l00760" name="l00760"></a><span class="lineno">  760</span>       &amp;             DQSDT2,FLX2,EMISSI,T1)</div>
<div class="line"><a id="l00761" name="l00761"></a><span class="lineno">  761</span> </div>
<div class="line"><a id="l00762" name="l00762"></a><span class="lineno">  762</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00763" name="l00763"></a><span class="lineno">  763</span><span class="comment">! CALCULATE POTENTIAL EVAPORATION FOR THE CURRENT POINT.  VARIOUS</span></div>
<div class="line"><a id="l00764" name="l00764"></a><span class="lineno">  764</span><span class="comment">! PARTIAL SUMS/PRODUCTS ARE ALSO CALCULATED AND PASSED BACK TO THE</span></div>
<div class="line"><a id="l00765" name="l00765"></a><span class="lineno">  765</span><span class="comment">! CALLING ROUTINE FOR LATER USE.</span></div>
<div class="line"><a id="l00766" name="l00766"></a><span class="lineno">  766</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00767" name="l00767"></a><span class="lineno">  767</span>    <span class="keywordtype">IMPLICIT NONE</span></div>
<div class="line"><a id="l00768" name="l00768"></a><span class="lineno">  768</span>    <span class="keywordtype">LOGICAL</span>, <span class="keywordtype">INTENT(IN)</span>  :: SNOWNG, FRZGRA</div>
<div class="line"><a id="l00769" name="l00769"></a><span class="lineno">  769</span><span class="keywordtype">    REAL</span>,    <span class="keywordtype">INTENT(IN)</span>  :: CH, DQSDT2,FDOWN,PRCP,Q2,Q2SAT,SSOIL,SFCPRS, &amp;</div>
<div class="line"><a id="l00770" name="l00770"></a><span class="lineno">  770</span>         &amp;                  SFCTMP,TH2,EMISSI,T1,RCH,T24</div>
<div class="line"><a id="l00771" name="l00771"></a><span class="lineno">  771</span>    <span class="keywordtype">REAL</span>,    <span class="keywordtype">INTENT(OUT)</span> :: ETP,FLX2,RR</div>
<div class="line"><a id="l00772" name="l00772"></a><span class="lineno">  772</span> </div>
<div class="line"><a id="l00773" name="l00773"></a><span class="lineno">  773</span><span class="keywordtype">    REAL</span>                 :: A, DELTA, FNET,RAD,ELCP1,LVS,EPSCA</div>
<div class="line"><a id="l00774" name="l00774"></a><span class="lineno">  774</span> </div>
<div class="line"><a id="l00775" name="l00775"></a><span class="lineno">  775</span><span class="keywordtype">    REAL</span>, <span class="keywordtype">PARAMETER</span>      :: ELCP = 2.4888e+3, lsubc = 2.501000e+6</div>
<div class="line"><a id="l00776" name="l00776"></a><span class="lineno">  776</span><span class="keywordtype">    REAL</span>, <span class="keywordtype">PARAMETER</span>      :: LSUBS = 2.83e+6</div>
<div class="line"><a id="l00777" name="l00777"></a><span class="lineno">  777</span> </div>
<div class="line"><a id="l00778" name="l00778"></a><span class="lineno">  778</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00779" name="l00779"></a><span class="lineno">  779</span><span class="comment">! PREPARE PARTIAL QUANTITIES FOR PENMAN EQUATION.</span></div>
<div class="line"><a id="l00780" name="l00780"></a><span class="lineno">  780</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00781" name="l00781"></a><span class="lineno">  781</span>    <span class="keywordflow">IF</span> ( t1 &gt; 273.15 ) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00782" name="l00782"></a><span class="lineno">  782</span>       elcp1 = elcp</div>
<div class="line"><a id="l00783" name="l00783"></a><span class="lineno">  783</span>       lvs   = lsubc</div>
<div class="line"><a id="l00784" name="l00784"></a><span class="lineno">  784</span>    <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l00785" name="l00785"></a><span class="lineno">  785</span>       elcp1 = elcp*lsubs/lsubc</div>
<div class="line"><a id="l00786" name="l00786"></a><span class="lineno">  786</span>       lvs   = lsubs</div>
<div class="line"><a id="l00787" name="l00787"></a><span class="lineno">  787</span><span class="keywordflow">    ENDIF</span></div>
<div class="line"><a id="l00788" name="l00788"></a><span class="lineno">  788</span>    delta = elcp1 * dqsdt2</div>
<div class="line"><a id="l00789" name="l00789"></a><span class="lineno">  789</span>    a = elcp1 * (q2sat - q2)</div>
<div class="line"><a id="l00790" name="l00790"></a><span class="lineno">  790</span>    rr = emissi*t24 * 6.48e-8 / (sfcprs * ch) + 1.0</div>
<div class="line"><a id="l00791" name="l00791"></a><span class="lineno">  791</span> </div>
<div class="line"><a id="l00792" name="l00792"></a><span class="lineno">  792</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00793" name="l00793"></a><span class="lineno">  793</span><span class="comment">! ADJUST THE PARTIAL SUMS / PRODUCTS WITH THE LATENT HEAT</span></div>
<div class="line"><a id="l00794" name="l00794"></a><span class="lineno">  794</span><span class="comment">! EFFECTS CAUSED BY FALLING PRECIPITATION.</span></div>
<div class="line"><a id="l00795" name="l00795"></a><span class="lineno">  795</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00796" name="l00796"></a><span class="lineno">  796</span>    <span class="keywordflow">IF</span> (.NOT. snowng) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00797" name="l00797"></a><span class="lineno">  797</span>       <span class="keywordflow">IF</span> (prcp &gt;  0.0) rr = rr + <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#ae07d087354ac15d439a02c8f0a1d24e4">cph2o</a> * prcp / rch</div>
<div class="line"><a id="l00798" name="l00798"></a><span class="lineno">  798</span>    <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l00799" name="l00799"></a><span class="lineno">  799</span>       rr = rr + <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a653d3903e2acbd4d19387ea434944093">cpice</a> * prcp / rch</div>
<div class="line"><a id="l00800" name="l00800"></a><span class="lineno">  800</span><span class="keywordflow">    END IF</span></div>
<div class="line"><a id="l00801" name="l00801"></a><span class="lineno">  801</span> </div>
<div class="line"><a id="l00802" name="l00802"></a><span class="lineno">  802</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00803" name="l00803"></a><span class="lineno">  803</span><span class="comment">! INCLUDE THE LATENT HEAT EFFECTS OF FREEZING RAIN CONVERTING TO ICE ON</span></div>
<div class="line"><a id="l00804" name="l00804"></a><span class="lineno">  804</span><span class="comment">! IMPACT IN THE CALCULATION OF FLX2 AND FNET.</span></div>
<div class="line"><a id="l00805" name="l00805"></a><span class="lineno">  805</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00806" name="l00806"></a><span class="lineno">  806</span>    <span class="keywordflow">IF</span> (frzgra) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00807" name="l00807"></a><span class="lineno">  807</span>       flx2 = - <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a81f1f2ceb78e6b6a447b394803dee3c7">lsubf</a> * prcp</div>
<div class="line"><a id="l00808" name="l00808"></a><span class="lineno">  808</span>    <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l00809" name="l00809"></a><span class="lineno">  809</span>       flx2 = 0.0</div>
<div class="line"><a id="l00810" name="l00810"></a><span class="lineno">  810</span><span class="keywordflow">    ENDIF</span></div>
<div class="line"><a id="l00811" name="l00811"></a><span class="lineno">  811</span>    fnet = fdown -  ( emissi * <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a41b56481dda78f3181c7e40721fa79a0">sigma</a> * t24 ) - ssoil - flx2</div>
<div class="line"><a id="l00812" name="l00812"></a><span class="lineno">  812</span> </div>
<div class="line"><a id="l00813" name="l00813"></a><span class="lineno">  813</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00814" name="l00814"></a><span class="lineno">  814</span><span class="comment">! FINISH PENMAN EQUATION CALCULATIONS.</span></div>
<div class="line"><a id="l00815" name="l00815"></a><span class="lineno">  815</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00816" name="l00816"></a><span class="lineno">  816</span>    rad = fnet / rch + th2 - sfctmp</div>
<div class="line"><a id="l00817" name="l00817"></a><span class="lineno">  817</span>    epsca = (a * rr + rad * delta) / (delta + rr)</div>
<div class="line"><a id="l00818" name="l00818"></a><span class="lineno">  818</span>    etp = epsca * rch / lvs</div>
<div class="line"><a id="l00819" name="l00819"></a><span class="lineno">  819</span> </div>
<div class="line"><a id="l00820" name="l00820"></a><span class="lineno">  820</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00821" name="l00821"></a><span class="lineno">  821</span>  <span class="keyword">END SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a5312fbbf31302c20e6823a3d2e97033b">penman</a></div>
<div class="line"><a id="l00822" name="l00822"></a><span class="lineno">  822</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00823" name="l00823"></a><span class="lineno">  823</span> </div>
<div class="line"><a id="l00824" name="l00824"></a><span class="lineno">  824</span>  <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#aaee442f9d981b7c296c5932352365351">shflx</a> (STC,NSOIL,DT,YY,ZZ1,ZSOIL,TBOT,DF1)</div>
<div class="line"><a id="l00825" name="l00825"></a><span class="lineno">  825</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00826" name="l00826"></a><span class="lineno">  826</span><span class="comment">! UPDATE THE TEMPERATURE STATE OF THE SOIL COLUMN BASED ON THE THERMAL</span></div>
<div class="line"><a id="l00827" name="l00827"></a><span class="lineno">  827</span><span class="comment">! DIFFUSION EQUATION AND UPDATE THE FROZEN SOIL MOISTURE CONTENT BASED</span></div>
<div class="line"><a id="l00828" name="l00828"></a><span class="lineno">  828</span><span class="comment">! ON THE TEMPERATURE.</span></div>
<div class="line"><a id="l00829" name="l00829"></a><span class="lineno">  829</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00830" name="l00830"></a><span class="lineno">  830</span>    <span class="keywordtype">IMPLICIT NONE</span></div>
<div class="line"><a id="l00831" name="l00831"></a><span class="lineno">  831</span> </div>
<div class="line"><a id="l00832" name="l00832"></a><span class="lineno">  832</span>    <span class="keywordtype">INTEGER</span>,                  <span class="keywordtype">INTENT(IN)</span>    :: NSOIL</div>
<div class="line"><a id="l00833" name="l00833"></a><span class="lineno">  833</span><span class="keywordtype">    REAL</span>,                     <span class="keywordtype">INTENT(IN)</span>    :: DF1,DT,TBOT,YY, ZZ1</div>
<div class="line"><a id="l00834" name="l00834"></a><span class="lineno">  834</span><span class="keywordtype">    REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(IN)</span>    :: ZSOIL</div>
<div class="line"><a id="l00835" name="l00835"></a><span class="lineno">  835</span><span class="keywordtype">    REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(INOUT)</span> :: STC</div>
<div class="line"><a id="l00836" name="l00836"></a><span class="lineno">  836</span> </div>
<div class="line"><a id="l00837" name="l00837"></a><span class="lineno">  837</span><span class="keywordtype">    REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span> :: AI, BI, CI, STCF,RHSTS</div>
<div class="line"><a id="l00838" name="l00838"></a><span class="lineno">  838</span>    <span class="keywordtype">INTEGER</span>                  :: I</div>
<div class="line"><a id="l00839" name="l00839"></a><span class="lineno">  839</span><span class="keywordtype">    REAL</span>, <span class="keywordtype">PARAMETER</span>          :: T0 = 273.15</div>
<div class="line"><a id="l00840" name="l00840"></a><span class="lineno">  840</span> </div>
<div class="line"><a id="l00841" name="l00841"></a><span class="lineno">  841</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00842" name="l00842"></a><span class="lineno">  842</span><span class="comment">! HRT ROUTINE CALCS THE RIGHT HAND SIDE OF THE SOIL TEMP DIF EQN</span></div>
<div class="line"><a id="l00843" name="l00843"></a><span class="lineno">  843</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00844" name="l00844"></a><span class="lineno">  844</span> </div>
<div class="line"><a id="l00845" name="l00845"></a><span class="lineno">  845</span>    <span class="keyword">CALL </span>hrtice (rhsts,stc,tbot, nsoil,zsoil,yy,zz1,df1,ai,bi,ci)</div>
<div class="line"><a id="l00846" name="l00846"></a><span class="lineno">  846</span> </div>
<div class="line"><a id="l00847" name="l00847"></a><span class="lineno">  847</span>    <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#adacf01be4e33445ea186feffce24eb35">hstep</a> (stcf,stc,rhsts,dt,nsoil,ai,bi,ci)</div>
<div class="line"><a id="l00848" name="l00848"></a><span class="lineno">  848</span> </div>
<div class="line"><a id="l00849" name="l00849"></a><span class="lineno">  849</span>    <span class="keywordflow">DO</span> i = 1,nsoil</div>
<div class="line"><a id="l00850" name="l00850"></a><span class="lineno">  850</span>       stc(i) = stcf(i)</div>
<div class="line"><a id="l00851" name="l00851"></a><span class="lineno">  851</span><span class="keywordflow">    END DO</span></div>
<div class="line"><a id="l00852" name="l00852"></a><span class="lineno">  852</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00853" name="l00853"></a><span class="lineno">  853</span>  <span class="keyword">END SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#aaee442f9d981b7c296c5932352365351">shflx</a></div>
<div class="line"><a id="l00854" name="l00854"></a><span class="lineno">  854</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00855" name="l00855"></a><span class="lineno">  855</span> </div>
<div class="line"><a id="l00856" name="l00856"></a><span class="lineno">  856</span>  <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ae27e8294cc66ecbb23f2a9d239a3c3d7">snopac</a> (ETP,ETA,PRCP,PRCPF,SNOWNG,NSOIL,DT,DF1,           &amp;</div>
<div class="line"><a id="l00857" name="l00857"></a><span class="lineno">  857</span>       &amp;             Q2,T1,SFCTMP,T24,TH2,FDOWN,SSOIL,STC,             &amp;</div>
<div class="line"><a id="l00858" name="l00858"></a><span class="lineno">  858</span>       &amp;             SFCPRS,RCH,RR,SNEQV,SNDENS,SNOWH,ZSOIL,TBOT,      &amp;</div>
<div class="line"><a id="l00859" name="l00859"></a><span class="lineno">  859</span>       &amp;             SNOMLT,DEW,FLX1,FLX2,FLX3,ESNOW,EMISSI,RIBB)</div>
<div class="line"><a id="l00860" name="l00860"></a><span class="lineno">  860</span> </div>
<div class="line"><a id="l00861" name="l00861"></a><span class="lineno">  861</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00862" name="l00862"></a><span class="lineno">  862</span><span class="comment">! CALCULATE SOIL MOISTURE AND HEAT FLUX VALUES &amp; UPDATE SOIL MOISTURE</span></div>
<div class="line"><a id="l00863" name="l00863"></a><span class="lineno">  863</span><span class="comment">! CONTENT AND SOIL HEAT CONTENT VALUES FOR THE CASE WHEN A SNOW PACK IS</span></div>
<div class="line"><a id="l00864" name="l00864"></a><span class="lineno">  864</span><span class="comment">! PRESENT.</span></div>
<div class="line"><a id="l00865" name="l00865"></a><span class="lineno">  865</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00866" name="l00866"></a><span class="lineno">  866</span>    <span class="keywordtype">IMPLICIT NONE</span></div>
<div class="line"><a id="l00867" name="l00867"></a><span class="lineno">  867</span> </div>
<div class="line"><a id="l00868" name="l00868"></a><span class="lineno">  868</span>    <span class="keywordtype">INTEGER</span>, <span class="keywordtype">INTENT(IN)</span>   :: NSOIL</div>
<div class="line"><a id="l00869" name="l00869"></a><span class="lineno">  869</span>    <span class="keywordtype">LOGICAL</span>, <span class="keywordtype">INTENT(IN)</span>   :: SNOWNG</div>
<div class="line"><a id="l00870" name="l00870"></a><span class="lineno">  870</span><span class="keywordtype">    REAL</span>,    <span class="keywordtype">INTENT(IN)</span>   :: DF1,DT,FDOWN,PRCP,Q2,RCH,RR,SFCPRS,SFCTMP, &amp;</div>
<div class="line"><a id="l00871" name="l00871"></a><span class="lineno">  871</span>         &amp;                   T24,TBOT,TH2,EMISSI</div>
<div class="line"><a id="l00872" name="l00872"></a><span class="lineno">  872</span>    <span class="keywordtype">REAL</span>, <span class="keywordtype">INTENT(INOUT)</span>   :: SNEQV,FLX2,PRCPF,SNOWH,SNDENS,T1,RIBB,ETP</div>
<div class="line"><a id="l00873" name="l00873"></a><span class="lineno">  873</span><span class="keywordtype">    REAL</span>, <span class="keywordtype">INTENT(OUT)</span>     :: DEW,ESNOW,FLX1,FLX3,SSOIL,SNOMLT</div>
<div class="line"><a id="l00874" name="l00874"></a><span class="lineno">  874</span><span class="keywordtype">    REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>,<span class="keywordtype">INTENT(IN)</span>     :: ZSOIL</div>
<div class="line"><a id="l00875" name="l00875"></a><span class="lineno">  875</span><span class="keywordtype">    REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(INOUT)</span> :: STC</div>
<div class="line"><a id="l00876" name="l00876"></a><span class="lineno">  876</span><span class="keywordtype">    REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span> :: ET1</div>
<div class="line"><a id="l00877" name="l00877"></a><span class="lineno">  877</span>    <span class="keywordtype">INTEGER</span>               :: K</div>
<div class="line"><a id="l00878" name="l00878"></a><span class="lineno">  878</span><span class="keywordtype">    REAL</span>                  :: DENOM,DSOIL,DTOT,ESDFLX,ETA,        &amp;</div>
<div class="line"><a id="l00879" name="l00879"></a><span class="lineno">  879</span>         &amp;                   ESNOW1,ESNOW2,ETA1,ETP1,ETP2,       &amp;</div>
<div class="line"><a id="l00880" name="l00880"></a><span class="lineno">  880</span>         &amp;                   ETP3,ETANRG,EX,                     &amp;</div>
<div class="line"><a id="l00881" name="l00881"></a><span class="lineno">  881</span>         &amp;                   FRCSNO,FRCSOI,PRCP1,QSAT,RSNOW,SEH, &amp;</div>
<div class="line"><a id="l00882" name="l00882"></a><span class="lineno">  882</span>         &amp;                   SNCOND,T12,T12A,T12B,T14,YY,ZZ1</div>
<div class="line"><a id="l00883" name="l00883"></a><span class="lineno">  883</span> </div>
<div class="line"><a id="l00884" name="l00884"></a><span class="lineno">  884</span><span class="keywordtype">    REAL</span>, <span class="keywordtype">PARAMETER</span>       :: ESDMIN = 1.e-6, lsubc = 2.501000e+6,     &amp;</div>
<div class="line"><a id="l00885" name="l00885"></a><span class="lineno">  885</span>         &amp;                   lsubs = 2.83e+6, tfreez = 273.15,        &amp;</div>
<div class="line"><a id="l00886" name="l00886"></a><span class="lineno">  886</span>         &amp;                   snoexp = 2.0</div>
<div class="line"><a id="l00887" name="l00887"></a><span class="lineno">  887</span> </div>
<div class="line"><a id="l00888" name="l00888"></a><span class="lineno">  888</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00889" name="l00889"></a><span class="lineno">  889</span><span class="comment">! FOR GLACIAL-ICE, SNOWCOVER FRACTION = 1.0, AND SUBLIMATION IS AT THE </span></div>
<div class="line"><a id="l00890" name="l00890"></a><span class="lineno">  890</span><span class="comment">! POTENTIAL RATE.</span></div>
<div class="line"><a id="l00891" name="l00891"></a><span class="lineno">  891</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00892" name="l00892"></a><span class="lineno">  892</span><span class="comment">! INITIALIZE EVAP TERMS.</span></div>
<div class="line"><a id="l00893" name="l00893"></a><span class="lineno">  893</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00894" name="l00894"></a><span class="lineno">  894</span><span class="comment">! conversions:</span></div>
<div class="line"><a id="l00895" name="l00895"></a><span class="lineno">  895</span><span class="comment">! ESNOW [KG M-2 S-1]</span></div>
<div class="line"><a id="l00896" name="l00896"></a><span class="lineno">  896</span><span class="comment">! ESDFLX [KG M-2 S-1] .le. ESNOW</span></div>
<div class="line"><a id="l00897" name="l00897"></a><span class="lineno">  897</span><span class="comment">! ESNOW1 [M S-1]</span></div>
<div class="line"><a id="l00898" name="l00898"></a><span class="lineno">  898</span><span class="comment">! ESNOW2 [M]</span></div>
<div class="line"><a id="l00899" name="l00899"></a><span class="lineno">  899</span><span class="comment">! ETP [KG M-2 S-1]</span></div>
<div class="line"><a id="l00900" name="l00900"></a><span class="lineno">  900</span><span class="comment">! ETP1 [M S-1]</span></div>
<div class="line"><a id="l00901" name="l00901"></a><span class="lineno">  901</span><span class="comment">! ETP2 [M]</span></div>
<div class="line"><a id="l00902" name="l00902"></a><span class="lineno">  902</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00903" name="l00903"></a><span class="lineno">  903</span>    snomlt = 0.0</div>
<div class="line"><a id="l00904" name="l00904"></a><span class="lineno">  904</span>    dew = 0.</div>
<div class="line"><a id="l00905" name="l00905"></a><span class="lineno">  905</span>    esnow = 0.</div>
<div class="line"><a id="l00906" name="l00906"></a><span class="lineno">  906</span>    esnow1 = 0.</div>
<div class="line"><a id="l00907" name="l00907"></a><span class="lineno">  907</span>    esnow2 = 0.</div>
<div class="line"><a id="l00908" name="l00908"></a><span class="lineno">  908</span> </div>
<div class="line"><a id="l00909" name="l00909"></a><span class="lineno">  909</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00910" name="l00910"></a><span class="lineno">  910</span><span class="comment">! CONVERT POTENTIAL EVAP (ETP) FROM KG M-2 S-1 TO ETP1 IN M S-1</span></div>
<div class="line"><a id="l00911" name="l00911"></a><span class="lineno">  911</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00912" name="l00912"></a><span class="lineno">  912</span>    prcp1 = prcpf *0.001</div>
<div class="line"><a id="l00913" name="l00913"></a><span class="lineno">  913</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00914" name="l00914"></a><span class="lineno">  914</span><span class="comment">! IF ETP&lt;0 (DOWNWARD) THEN DEWFALL (=FROSTFALL IN THIS CASE).</span></div>
<div class="line"><a id="l00915" name="l00915"></a><span class="lineno">  915</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00916" name="l00916"></a><span class="lineno">  916</span>    <span class="keywordflow">IF</span> (etp &lt;= 0.0) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00917" name="l00917"></a><span class="lineno">  917</span>       <span class="keywordflow">IF</span> ( ( ribb &gt;= 0.1 ) .AND. ( fdown &gt; 150.0 ) ) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00918" name="l00918"></a><span class="lineno">  918</span>          etp=(min(etp*(1.0-ribb),0.)/0.980 + etp*(0.980-1.0))/0.980</div>
<div class="line"><a id="l00919" name="l00919"></a><span class="lineno">  919</span><span class="keywordflow">       ENDIF</span></div>
<div class="line"><a id="l00920" name="l00920"></a><span class="lineno">  920</span>       etp1 = etp * 0.001</div>
<div class="line"><a id="l00921" name="l00921"></a><span class="lineno">  921</span>       dew = -etp1</div>
<div class="line"><a id="l00922" name="l00922"></a><span class="lineno">  922</span>       esnow2 = etp1*dt</div>
<div class="line"><a id="l00923" name="l00923"></a><span class="lineno">  923</span>       etanrg = etp*lsubs</div>
<div class="line"><a id="l00924" name="l00924"></a><span class="lineno">  924</span>    <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l00925" name="l00925"></a><span class="lineno">  925</span>       etp1 = etp * 0.001</div>
<div class="line"><a id="l00926" name="l00926"></a><span class="lineno">  926</span>       esnow = etp</div>
<div class="line"><a id="l00927" name="l00927"></a><span class="lineno">  927</span>       esnow1 = esnow*0.001</div>
<div class="line"><a id="l00928" name="l00928"></a><span class="lineno">  928</span>       esnow2 = esnow1*dt</div>
<div class="line"><a id="l00929" name="l00929"></a><span class="lineno">  929</span>       etanrg = esnow*lsubs</div>
<div class="line"><a id="l00930" name="l00930"></a><span class="lineno">  930</span><span class="keywordflow">    END IF</span></div>
<div class="line"><a id="l00931" name="l00931"></a><span class="lineno">  931</span> </div>
<div class="line"><a id="l00932" name="l00932"></a><span class="lineno">  932</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00933" name="l00933"></a><span class="lineno">  933</span><span class="comment">! IF PRECIP IS FALLING, CALCULATE HEAT FLUX FROM SNOW SFC TO NEWLY</span></div>
<div class="line"><a id="l00934" name="l00934"></a><span class="lineno">  934</span><span class="comment">! ACCUMULATING PRECIP.  NOTE THAT THIS REFLECTS THE FLUX APPROPRIATE FOR</span></div>
<div class="line"><a id="l00935" name="l00935"></a><span class="lineno">  935</span><span class="comment">! THE NOT-YET-UPDATED SKIN TEMPERATURE (T1).  ASSUMES TEMPERATURE OF THE</span></div>
<div class="line"><a id="l00936" name="l00936"></a><span class="lineno">  936</span><span class="comment">! SNOWFALL STRIKING THE GROUND IS =SFCTMP (LOWEST MODEL LEVEL AIR TEMP).</span></div>
<div class="line"><a id="l00937" name="l00937"></a><span class="lineno">  937</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00938" name="l00938"></a><span class="lineno">  938</span>    flx1 = 0.0</div>
<div class="line"><a id="l00939" name="l00939"></a><span class="lineno">  939</span>    <span class="keywordflow">IF</span> (snowng) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00940" name="l00940"></a><span class="lineno">  940</span>       flx1 = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a653d3903e2acbd4d19387ea434944093">cpice</a> * prcp * (t1- sfctmp)</div>
<div class="line"><a id="l00941" name="l00941"></a><span class="lineno">  941</span>    <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l00942" name="l00942"></a><span class="lineno">  942</span>       <span class="keywordflow">IF</span> (prcp &gt;  0.0) flx1 = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#ae07d087354ac15d439a02c8f0a1d24e4">cph2o</a> * prcp * (t1- sfctmp)</div>
<div class="line"><a id="l00943" name="l00943"></a><span class="lineno">  943</span><span class="keywordflow">    END IF</span></div>
<div class="line"><a id="l00944" name="l00944"></a><span class="lineno">  944</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00945" name="l00945"></a><span class="lineno">  945</span><span class="comment">! CALCULATE AN &#39;EFFECTIVE SNOW-GRND SFC TEMP&#39; (T12) BASED ON HEAT FLUXES</span></div>
<div class="line"><a id="l00946" name="l00946"></a><span class="lineno">  946</span><span class="comment">! BETWEEN THE SNOW PACK AND THE SOIL AND ON NET RADIATION.</span></div>
<div class="line"><a id="l00947" name="l00947"></a><span class="lineno">  947</span><span class="comment">! INCLUDE FLX1 (PRECIP-SNOW SFC) AND FLX2 (FREEZING RAIN LATENT HEAT)</span></div>
<div class="line"><a id="l00948" name="l00948"></a><span class="lineno">  948</span><span class="comment">! FLUXES.  FLX1 FROM ABOVE, FLX2 BROUGHT IN VIA COMMOM BLOCK RITE.</span></div>
<div class="line"><a id="l00949" name="l00949"></a><span class="lineno">  949</span><span class="comment">! FLX2 REFLECTS FREEZING RAIN LATENT HEAT FLUX USING T1 CALCULATED IN</span></div>
<div class="line"><a id="l00950" name="l00950"></a><span class="lineno">  950</span><span class="comment">! PENMAN.</span></div>
<div class="line"><a id="l00951" name="l00951"></a><span class="lineno">  951</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00952" name="l00952"></a><span class="lineno">  952</span>    dsoil = - (0.5 * zsoil(1))</div>
<div class="line"><a id="l00953" name="l00953"></a><span class="lineno">  953</span>    dtot = snowh + dsoil</div>
<div class="line"><a id="l00954" name="l00954"></a><span class="lineno">  954</span>    denom = 1.0+ df1 / (dtot * rr * rch)</div>
<div class="line"><a id="l00955" name="l00955"></a><span class="lineno">  955</span>    t12a = ( (fdown - flx1- flx2- emissi * <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a41b56481dda78f3181c7e40721fa79a0">sigma</a> * t24)/ rch                    &amp;</div>
<div class="line"><a id="l00956" name="l00956"></a><span class="lineno">  956</span>         + th2- sfctmp - etanrg / rch ) / rr</div>
<div class="line"><a id="l00957" name="l00957"></a><span class="lineno">  957</span>    t12b = df1 * stc(1) / (dtot * rr * rch)</div>
<div class="line"><a id="l00958" name="l00958"></a><span class="lineno">  958</span> </div>
<div class="line"><a id="l00959" name="l00959"></a><span class="lineno">  959</span>    t12 = (sfctmp + t12a + t12b) / denom</div>
<div class="line"><a id="l00960" name="l00960"></a><span class="lineno">  960</span>    <span class="keywordflow">IF</span> (t12 &lt;=  tfreez) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00961" name="l00961"></a><span class="lineno">  961</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00962" name="l00962"></a><span class="lineno">  962</span><span class="comment">! SUB-FREEZING BLOCK</span></div>
<div class="line"><a id="l00963" name="l00963"></a><span class="lineno">  963</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00964" name="l00964"></a><span class="lineno">  964</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00965" name="l00965"></a><span class="lineno">  965</span><span class="comment">! IF THE &#39;EFFECTIVE SNOW-GRND SFC TEMP&#39; IS AT OR BELOW FREEZING, NO SNOW</span></div>
<div class="line"><a id="l00966" name="l00966"></a><span class="lineno">  966</span><span class="comment">! MELT WILL OCCUR.  SET THE SKIN TEMP TO THIS EFFECTIVE TEMP.  REDUCE</span></div>
<div class="line"><a id="l00967" name="l00967"></a><span class="lineno">  967</span><span class="comment">! (BY SUBLIMINATION ) OR INCREASE (BY FROST) THE DEPTH OF THE SNOWPACK,</span></div>
<div class="line"><a id="l00968" name="l00968"></a><span class="lineno">  968</span><span class="comment">! DEPENDING ON SIGN OF ETP.</span></div>
<div class="line"><a id="l00969" name="l00969"></a><span class="lineno">  969</span><span class="comment">! UPDATE SOIL HEAT FLUX (SSOIL) USING NEW SKIN TEMPERATURE (T1)</span></div>
<div class="line"><a id="l00970" name="l00970"></a><span class="lineno">  970</span><span class="comment">! SINCE NO SNOWMELT, SET ACCUMULATED SNOWMELT TO ZERO, SET &#39;EFFECTIVE&#39;</span></div>
<div class="line"><a id="l00971" name="l00971"></a><span class="lineno">  971</span><span class="comment">! PRECIP FROM SNOWMELT TO ZERO, SET PHASE-CHANGE HEAT FLUX FROM SNOWMELT</span></div>
<div class="line"><a id="l00972" name="l00972"></a><span class="lineno">  972</span><span class="comment">! TO ZERO.</span></div>
<div class="line"><a id="l00973" name="l00973"></a><span class="lineno">  973</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00974" name="l00974"></a><span class="lineno">  974</span>       t1 = t12</div>
<div class="line"><a id="l00975" name="l00975"></a><span class="lineno">  975</span>       ssoil = df1 * (t1- stc(1)) / dtot</div>
<div class="line"><a id="l00976" name="l00976"></a><span class="lineno">  976</span>       sneqv = max(0.0, sneqv-esnow2)</div>
<div class="line"><a id="l00977" name="l00977"></a><span class="lineno">  977</span>       flx3 = 0.0</div>
<div class="line"><a id="l00978" name="l00978"></a><span class="lineno">  978</span>       ex = 0.0</div>
<div class="line"><a id="l00979" name="l00979"></a><span class="lineno">  979</span>       snomlt = 0.0</div>
<div class="line"><a id="l00980" name="l00980"></a><span class="lineno">  980</span>    <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l00981" name="l00981"></a><span class="lineno">  981</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00982" name="l00982"></a><span class="lineno">  982</span><span class="comment">! ABOVE FREEZING BLOCK</span></div>
<div class="line"><a id="l00983" name="l00983"></a><span class="lineno">  983</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00984" name="l00984"></a><span class="lineno">  984</span><span class="comment">! IF THE &#39;EFFECTIVE SNOW-GRND SFC TEMP&#39; IS ABOVE FREEZING, SNOW MELT</span></div>
<div class="line"><a id="l00985" name="l00985"></a><span class="lineno">  985</span><span class="comment">! WILL OCCUR.  CALL THE SNOW MELT RATE,EX AND AMT, SNOMLT.  REVISE THE</span></div>
<div class="line"><a id="l00986" name="l00986"></a><span class="lineno">  986</span><span class="comment">! EFFECTIVE SNOW DEPTH.  REVISE THE SKIN TEMP BECAUSE IT WOULD HAVE CHGD</span></div>
<div class="line"><a id="l00987" name="l00987"></a><span class="lineno">  987</span><span class="comment">! DUE TO THE LATENT HEAT RELEASED BY THE MELTING. CALC THE LATENT HEAT</span></div>
<div class="line"><a id="l00988" name="l00988"></a><span class="lineno">  988</span><span class="comment">! RELEASED, FLX3. SET THE EFFECTIVE PRECIP, PRCP1 TO THE SNOW MELT RATE,</span></div>
<div class="line"><a id="l00989" name="l00989"></a><span class="lineno">  989</span><span class="comment">! EX FOR USE IN SMFLX.  ADJUSTMENT TO T1 TO ACCOUNT FOR SNOW PATCHES.</span></div>
<div class="line"><a id="l00990" name="l00990"></a><span class="lineno">  990</span><span class="comment">! CALCULATE QSAT VALID AT FREEZING POINT.  NOTE THAT ESAT (SATURATION</span></div>
<div class="line"><a id="l00991" name="l00991"></a><span class="lineno">  991</span><span class="comment">! VAPOR PRESSURE) VALUE OF 6.11E+2 USED HERE IS THAT VALID AT FRZZING</span></div>
<div class="line"><a id="l00992" name="l00992"></a><span class="lineno">  992</span><span class="comment">! POINT.  NOTE THAT ETP FROM CALL PENMAN IN SFLX IS IGNORED HERE IN</span></div>
<div class="line"><a id="l00993" name="l00993"></a><span class="lineno">  993</span><span class="comment">! FAVOR OF BULK ETP OVER &#39;OPEN WATER&#39; AT FREEZING TEMP.</span></div>
<div class="line"><a id="l00994" name="l00994"></a><span class="lineno">  994</span><span class="comment">! UPDATE SOIL HEAT FLUX (S) USING NEW SKIN TEMPERATURE (T1)</span></div>
<div class="line"><a id="l00995" name="l00995"></a><span class="lineno">  995</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00996" name="l00996"></a><span class="lineno">  996</span>       t1 = tfreez</div>
<div class="line"><a id="l00997" name="l00997"></a><span class="lineno">  997</span>       <span class="keywordflow">IF</span> ( dtot .GT. 2.0*dsoil ) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00998" name="l00998"></a><span class="lineno">  998</span>          dtot = 2.0*dsoil</div>
<div class="line"><a id="l00999" name="l00999"></a><span class="lineno">  999</span><span class="keywordflow">       ENDIF</span></div>
<div class="line"><a id="l01000" name="l01000"></a><span class="lineno"> 1000</span>       ssoil = df1 * (t1- stc(1)) / dtot</div>
<div class="line"><a id="l01001" name="l01001"></a><span class="lineno"> 1001</span>       <span class="keywordflow">IF</span> (sneqv-esnow2 &lt;= esdmin) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l01002" name="l01002"></a><span class="lineno"> 1002</span>          sneqv = 0.0</div>
<div class="line"><a id="l01003" name="l01003"></a><span class="lineno"> 1003</span>          ex = 0.0</div>
<div class="line"><a id="l01004" name="l01004"></a><span class="lineno"> 1004</span>          snomlt = 0.0</div>
<div class="line"><a id="l01005" name="l01005"></a><span class="lineno"> 1005</span>          flx3 = 0.0</div>
<div class="line"><a id="l01006" name="l01006"></a><span class="lineno"> 1006</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01007" name="l01007"></a><span class="lineno"> 1007</span><span class="comment">! SUBLIMATION LESS THAN DEPTH OF SNOWPACK</span></div>
<div class="line"><a id="l01008" name="l01008"></a><span class="lineno"> 1008</span><span class="comment">! SNOWPACK (SNEQV) REDUCED BY ESNOW2 (DEPTH OF SUBLIMATED SNOW)</span></div>
<div class="line"><a id="l01009" name="l01009"></a><span class="lineno"> 1009</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01010" name="l01010"></a><span class="lineno"> 1010</span>       <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l01011" name="l01011"></a><span class="lineno"> 1011</span>          sneqv = sneqv-esnow2</div>
<div class="line"><a id="l01012" name="l01012"></a><span class="lineno"> 1012</span>          etp3 = etp * lsubc</div>
<div class="line"><a id="l01013" name="l01013"></a><span class="lineno"> 1013</span>          seh = rch * (t1- th2)</div>
<div class="line"><a id="l01014" name="l01014"></a><span class="lineno"> 1014</span>          t14 = ( t1 * t1 ) * ( t1 * t1 )</div>
<div class="line"><a id="l01015" name="l01015"></a><span class="lineno"> 1015</span>          flx3 = fdown - flx1- flx2- emissi*<a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a41b56481dda78f3181c7e40721fa79a0">sigma</a> * t14- ssoil - seh - etanrg</div>
<div class="line"><a id="l01016" name="l01016"></a><span class="lineno"> 1016</span>          <span class="keywordflow">IF</span> (flx3 &lt;= 0.0) flx3 = 0.0</div>
<div class="line"><a id="l01017" name="l01017"></a><span class="lineno"> 1017</span>          ex = flx3*0.001/ <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a81f1f2ceb78e6b6a447b394803dee3c7">lsubf</a></div>
<div class="line"><a id="l01018" name="l01018"></a><span class="lineno"> 1018</span>          snomlt = ex * dt</div>
<div class="line"><a id="l01019" name="l01019"></a><span class="lineno"> 1019</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01020" name="l01020"></a><span class="lineno"> 1020</span><span class="comment">! ESDMIN REPRESENTS A SNOWPACK DEPTH THRESHOLD VALUE BELOW WHICH WE</span></div>
<div class="line"><a id="l01021" name="l01021"></a><span class="lineno"> 1021</span><span class="comment">! CHOOSE NOT TO RETAIN ANY SNOWPACK, AND INSTEAD INCLUDE IT IN SNOWMELT.</span></div>
<div class="line"><a id="l01022" name="l01022"></a><span class="lineno"> 1022</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01023" name="l01023"></a><span class="lineno"> 1023</span>          <span class="keywordflow">IF</span> (sneqv- snomlt &gt;=  esdmin) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l01024" name="l01024"></a><span class="lineno"> 1024</span>             sneqv = sneqv- snomlt</div>
<div class="line"><a id="l01025" name="l01025"></a><span class="lineno"> 1025</span>          <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l01026" name="l01026"></a><span class="lineno"> 1026</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01027" name="l01027"></a><span class="lineno"> 1027</span><span class="comment">! SNOWMELT EXCEEDS SNOW DEPTH</span></div>
<div class="line"><a id="l01028" name="l01028"></a><span class="lineno"> 1028</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01029" name="l01029"></a><span class="lineno"> 1029</span>             ex = sneqv / dt</div>
<div class="line"><a id="l01030" name="l01030"></a><span class="lineno"> 1030</span>             flx3 = ex *1000.0* <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a81f1f2ceb78e6b6a447b394803dee3c7">lsubf</a></div>
<div class="line"><a id="l01031" name="l01031"></a><span class="lineno"> 1031</span>             snomlt = sneqv</div>
<div class="line"><a id="l01032" name="l01032"></a><span class="lineno"> 1032</span> </div>
<div class="line"><a id="l01033" name="l01033"></a><span class="lineno"> 1033</span>             sneqv = 0.0</div>
<div class="line"><a id="l01034" name="l01034"></a><span class="lineno"> 1034</span><span class="keywordflow">          ENDIF</span></div>
<div class="line"><a id="l01035" name="l01035"></a><span class="lineno"> 1035</span><span class="keywordflow">       ENDIF</span></div>
<div class="line"><a id="l01036" name="l01036"></a><span class="lineno"> 1036</span> </div>
<div class="line"><a id="l01037" name="l01037"></a><span class="lineno"> 1037</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01038" name="l01038"></a><span class="lineno"> 1038</span><span class="comment">! FOR GLACIAL ICE, THE SNOWMELT WILL BE ADDED TO SUBSURFACE</span></div>
<div class="line"><a id="l01039" name="l01039"></a><span class="lineno"> 1039</span><span class="comment">! RUNOFF/BASEFLOW LATER NEAR THE END OF SFLX (AFTER RETURN FROM CALL TO</span></div>
<div class="line"><a id="l01040" name="l01040"></a><span class="lineno"> 1040</span><span class="comment">! SUBROUTINE SNOPAC)</span></div>
<div class="line"><a id="l01041" name="l01041"></a><span class="lineno"> 1041</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01042" name="l01042"></a><span class="lineno"> 1042</span> </div>
<div class="line"><a id="l01043" name="l01043"></a><span class="lineno"> 1043</span><span class="keywordflow">    ENDIF</span></div>
<div class="line"><a id="l01044" name="l01044"></a><span class="lineno"> 1044</span> </div>
<div class="line"><a id="l01045" name="l01045"></a><span class="lineno"> 1045</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01046" name="l01046"></a><span class="lineno"> 1046</span><span class="comment">! BEFORE CALL SHFLX IN THIS SNOWPACK CASE, SET ZZ1 AND YY ARGUMENTS TO</span></div>
<div class="line"><a id="l01047" name="l01047"></a><span class="lineno"> 1047</span><span class="comment">! SPECIAL VALUES THAT ENSURE THAT GROUND HEAT FLUX CALCULATED IN SHFLX</span></div>
<div class="line"><a id="l01048" name="l01048"></a><span class="lineno"> 1048</span><span class="comment">! MATCHES THAT ALREADY COMPUTED FOR BELOW THE SNOWPACK, THUS THE SFC</span></div>
<div class="line"><a id="l01049" name="l01049"></a><span class="lineno"> 1049</span><span class="comment">! HEAT FLUX TO BE COMPUTED IN SHFLX WILL EFFECTIVELY BE THE FLUX AT THE</span></div>
<div class="line"><a id="l01050" name="l01050"></a><span class="lineno"> 1050</span><span class="comment">! SNOW TOP SURFACE.  </span></div>
<div class="line"><a id="l01051" name="l01051"></a><span class="lineno"> 1051</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01052" name="l01052"></a><span class="lineno"> 1052</span>    zz1 = 1.0</div>
<div class="line"><a id="l01053" name="l01053"></a><span class="lineno"> 1053</span>    yy = stc(1) -0.5* ssoil * zsoil(1)* zz1/ df1</div>
<div class="line"><a id="l01054" name="l01054"></a><span class="lineno"> 1054</span> </div>
<div class="line"><a id="l01055" name="l01055"></a><span class="lineno"> 1055</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01056" name="l01056"></a><span class="lineno"> 1056</span><span class="comment">! SHFLX WILL CALC/UPDATE THE SOIL TEMPS.</span></div>
<div class="line"><a id="l01057" name="l01057"></a><span class="lineno"> 1057</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01058" name="l01058"></a><span class="lineno"> 1058</span>    <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#aaee442f9d981b7c296c5932352365351">shflx</a> (stc,nsoil,dt,yy,zz1,zsoil,tbot,df1)</div>
<div class="line"><a id="l01059" name="l01059"></a><span class="lineno"> 1059</span> </div>
<div class="line"><a id="l01060" name="l01060"></a><span class="lineno"> 1060</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01061" name="l01061"></a><span class="lineno"> 1061</span><span class="comment">! SNOW DEPTH AND DENSITY ADJUSTMENT BASED ON SNOW COMPACTION.  YY IS</span></div>
<div class="line"><a id="l01062" name="l01062"></a><span class="lineno"> 1062</span><span class="comment">! ASSUMED TO BE THE SOIL TEMPERTURE AT THE TOP OF THE SOIL COLUMN.</span></div>
<div class="line"><a id="l01063" name="l01063"></a><span class="lineno"> 1063</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01064" name="l01064"></a><span class="lineno"> 1064</span>    <span class="keywordflow">IF</span> (sneqv .GE. 0.10) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l01065" name="l01065"></a><span class="lineno"> 1065</span>       <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ae6d35ff66196a3ab369a3e87149ddcdc">snowpack</a> (sneqv,dt,snowh,sndens,t1,yy)</div>
<div class="line"><a id="l01066" name="l01066"></a><span class="lineno"> 1066</span>    <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l01067" name="l01067"></a><span class="lineno"> 1067</span>       sneqv = 0.10</div>
<div class="line"><a id="l01068" name="l01068"></a><span class="lineno"> 1068</span>       snowh = 0.50</div>
<div class="line"><a id="l01069" name="l01069"></a><span class="lineno"> 1069</span><span class="comment">!KWM???? SNDENS =</span></div>
<div class="line"><a id="l01070" name="l01070"></a><span class="lineno"> 1070</span><span class="comment">!KWM???? SNCOND =</span></div>
<div class="line"><a id="l01071" name="l01071"></a><span class="lineno"> 1071</span><span class="keywordflow">    ENDIF</span></div>
<div class="line"><a id="l01072" name="l01072"></a><span class="lineno"> 1072</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01073" name="l01073"></a><span class="lineno"> 1073</span>  <span class="keyword">END SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ae27e8294cc66ecbb23f2a9d239a3c3d7">snopac</a></div>
<div class="line"><a id="l01074" name="l01074"></a><span class="lineno"> 1074</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01075" name="l01075"></a><span class="lineno"> 1075</span> </div>
<div class="line"><a id="l01076" name="l01076"></a><span class="lineno"> 1076</span>  <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ae6d35ff66196a3ab369a3e87149ddcdc">snowpack</a> (SNEQV,DTSEC,SNOWH,SNDENS,TSNOW,TSOIL)</div>
<div class="line"><a id="l01077" name="l01077"></a><span class="lineno"> 1077</span> </div>
<div class="line"><a id="l01078" name="l01078"></a><span class="lineno"> 1078</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01079" name="l01079"></a><span class="lineno"> 1079</span><span class="comment">! CALCULATE COMPACTION OF SNOWPACK UNDER CONDITIONS OF INCREASING SNOW</span></div>
<div class="line"><a id="l01080" name="l01080"></a><span class="lineno"> 1080</span><span class="comment">! DENSITY, AS OBTAINED FROM AN APPROXIMATE SOLUTION OF E. ANDERSON&#39;S</span></div>
<div class="line"><a id="l01081" name="l01081"></a><span class="lineno"> 1081</span><span class="comment">! DIFFERENTIAL EQUATION (3.29), NOAA TECHNICAL REPORT NWS 19, BY VICTOR</span></div>
<div class="line"><a id="l01082" name="l01082"></a><span class="lineno"> 1082</span><span class="comment">! KOREN, 03/25/95.</span></div>
<div class="line"><a id="l01083" name="l01083"></a><span class="lineno"> 1083</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01084" name="l01084"></a><span class="lineno"> 1084</span><span class="comment">! SNEQV     WATER EQUIVALENT OF SNOW (M)</span></div>
<div class="line"><a id="l01085" name="l01085"></a><span class="lineno"> 1085</span><span class="comment">! DTSEC   TIME STEP (SEC)</span></div>
<div class="line"><a id="l01086" name="l01086"></a><span class="lineno"> 1086</span><span class="comment">! SNOWH   SNOW DEPTH (M)</span></div>
<div class="line"><a id="l01087" name="l01087"></a><span class="lineno"> 1087</span><span class="comment">! SNDENS  SNOW DENSITY (G/CM3=DIMENSIONLESS FRACTION OF H2O DENSITY)</span></div>
<div class="line"><a id="l01088" name="l01088"></a><span class="lineno"> 1088</span><span class="comment">! TSNOW   SNOW SURFACE TEMPERATURE (K)</span></div>
<div class="line"><a id="l01089" name="l01089"></a><span class="lineno"> 1089</span><span class="comment">! TSOIL   SOIL SURFACE TEMPERATURE (K)</span></div>
<div class="line"><a id="l01090" name="l01090"></a><span class="lineno"> 1090</span> </div>
<div class="line"><a id="l01091" name="l01091"></a><span class="lineno"> 1091</span><span class="comment">! SUBROUTINE WILL RETURN NEW VALUES OF SNOWH AND SNDENS</span></div>
<div class="line"><a id="l01092" name="l01092"></a><span class="lineno"> 1092</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01093" name="l01093"></a><span class="lineno"> 1093</span>      <span class="keywordtype">IMPLICIT NONE</span></div>
<div class="line"><a id="l01094" name="l01094"></a><span class="lineno"> 1094</span> </div>
<div class="line"><a id="l01095" name="l01095"></a><span class="lineno"> 1095</span>      <span class="keywordtype">INTEGER</span>                :: IPOL, J</div>
<div class="line"><a id="l01096" name="l01096"></a><span class="lineno"> 1096</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(IN)</span>       :: SNEQV, DTSEC,TSNOW,TSOIL</div>
<div class="line"><a id="l01097" name="l01097"></a><span class="lineno"> 1097</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(INOUT)</span>    :: SNOWH, SNDENS</div>
<div class="line"><a id="l01098" name="l01098"></a><span class="lineno"> 1098</span><span class="keywordtype">      REAL</span>                   :: BFAC,DSX,DTHR,DW,SNOWHC,PEXP,           &amp;</div>
<div class="line"><a id="l01099" name="l01099"></a><span class="lineno"> 1099</span>                                TAVGC,TSNOWC,TSOILC,ESDC,ESDCX</div>
<div class="line"><a id="l01100" name="l01100"></a><span class="lineno"> 1100</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">PARAMETER</span>        :: C1 = 0.01, <a class="code hl_function" href="params_8m.html#a042889eb4a4c0a313ba885e8f173380d">c2</a> = 21.0, <a class="code hl_function" href="params_8m.html#a86bdec0d61a48a8ca4da1674058837cc">g</a> = 9.81,         &amp;</div>
<div class="line"><a id="l01101" name="l01101"></a><span class="lineno"> 1101</span>                                kn = 4000.0</div>
<div class="line"><a id="l01102" name="l01102"></a><span class="lineno"> 1102</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01103" name="l01103"></a><span class="lineno"> 1103</span><span class="comment">! CONVERSION INTO SIMULATION UNITS</span></div>
<div class="line"><a id="l01104" name="l01104"></a><span class="lineno"> 1104</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01105" name="l01105"></a><span class="lineno"> 1105</span>      snowhc = snowh *100.</div>
<div class="line"><a id="l01106" name="l01106"></a><span class="lineno"> 1106</span>      esdc   = sneqv *100.</div>
<div class="line"><a id="l01107" name="l01107"></a><span class="lineno"> 1107</span>      dthr   = dtsec /3600.</div>
<div class="line"><a id="l01108" name="l01108"></a><span class="lineno"> 1108</span>      tsnowc = tsnow -273.15</div>
<div class="line"><a id="l01109" name="l01109"></a><span class="lineno"> 1109</span>      tsoilc = tsoil -273.15</div>
<div class="line"><a id="l01110" name="l01110"></a><span class="lineno"> 1110</span> </div>
<div class="line"><a id="l01111" name="l01111"></a><span class="lineno"> 1111</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01112" name="l01112"></a><span class="lineno"> 1112</span><span class="comment">! CALCULATING OF AVERAGE TEMPERATURE OF SNOW PACK</span></div>
<div class="line"><a id="l01113" name="l01113"></a><span class="lineno"> 1113</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01114" name="l01114"></a><span class="lineno"> 1114</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01115" name="l01115"></a><span class="lineno"> 1115</span><span class="comment">! CALCULATING OF SNOW DEPTH AND DENSITY AS A RESULT OF COMPACTION</span></div>
<div class="line"><a id="l01116" name="l01116"></a><span class="lineno"> 1116</span><span class="comment">!  SNDENS=DS0*(EXP(BFAC*SNEQV)-1.)/(BFAC*SNEQV)</span></div>
<div class="line"><a id="l01117" name="l01117"></a><span class="lineno"> 1117</span><span class="comment">!  BFAC=DTHR*C1*EXP(0.08*TAVGC-C2*DS0)</span></div>
<div class="line"><a id="l01118" name="l01118"></a><span class="lineno"> 1118</span><span class="comment">! NOTE: BFAC*SNEQV IN SNDENS EQN ABOVE HAS TO BE CAREFULLY TREATED</span></div>
<div class="line"><a id="l01119" name="l01119"></a><span class="lineno"> 1119</span><span class="comment">! NUMERICALLY BELOW:</span></div>
<div class="line"><a id="l01120" name="l01120"></a><span class="lineno"> 1120</span><span class="comment">!   C1 IS THE FRACTIONAL INCREASE IN DENSITY (1/(CM*HR))</span></div>
<div class="line"><a id="l01121" name="l01121"></a><span class="lineno"> 1121</span><span class="comment">!   C2 IS A CONSTANT (CM3/G) KOJIMA ESTIMATED AS 21 CMS/G</span></div>
<div class="line"><a id="l01122" name="l01122"></a><span class="lineno"> 1122</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01123" name="l01123"></a><span class="lineno"> 1123</span>      tavgc = 0.5* (tsnowc + tsoilc)</div>
<div class="line"><a id="l01124" name="l01124"></a><span class="lineno"> 1124</span>      <span class="keywordflow">IF</span> (esdc &gt;  1.e-2) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l01125" name="l01125"></a><span class="lineno"> 1125</span>         esdcx = esdc</div>
<div class="line"><a id="l01126" name="l01126"></a><span class="lineno"> 1126</span>      <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l01127" name="l01127"></a><span class="lineno"> 1127</span>         esdcx = 1.e-2</div>
<div class="line"><a id="l01128" name="l01128"></a><span class="lineno"> 1128</span><span class="keywordflow">      END IF</span></div>
<div class="line"><a id="l01129" name="l01129"></a><span class="lineno"> 1129</span> </div>
<div class="line"><a id="l01130" name="l01130"></a><span class="lineno"> 1130</span><span class="comment">!      DSX = SNDENS*((DEXP(BFAC*ESDC)-1.)/(BFAC*ESDC))</span></div>
<div class="line"><a id="l01131" name="l01131"></a><span class="lineno"> 1131</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01132" name="l01132"></a><span class="lineno"> 1132</span><span class="comment">! THE FUNCTION OF THE FORM (e**x-1)/x IMBEDDED IN ABOVE EXPRESSION</span></div>
<div class="line"><a id="l01133" name="l01133"></a><span class="lineno"> 1133</span><span class="comment">! FOR DSX WAS CAUSING NUMERICAL DIFFICULTIES WHEN THE DENOMINATOR &quot;x&quot;</span></div>
<div class="line"><a id="l01134" name="l01134"></a><span class="lineno"> 1134</span><span class="comment">! (I.E. BFAC*ESDC) BECAME ZERO OR APPROACHED ZERO (DESPITE THE FACT THAT</span></div>
<div class="line"><a id="l01135" name="l01135"></a><span class="lineno"> 1135</span><span class="comment">! THE ANALYTICAL FUNCTION (e**x-1)/x HAS A WELL DEFINED LIMIT AS</span></div>
<div class="line"><a id="l01136" name="l01136"></a><span class="lineno"> 1136</span><span class="comment">! &quot;x&quot; APPROACHES ZERO), HENCE BELOW WE REPLACE THE (e**x-1)/x</span></div>
<div class="line"><a id="l01137" name="l01137"></a><span class="lineno"> 1137</span><span class="comment">! EXPRESSION WITH AN EQUIVALENT, NUMERICALLY WELL-BEHAVED</span></div>
<div class="line"><a id="l01138" name="l01138"></a><span class="lineno"> 1138</span><span class="comment">! POLYNOMIAL EXPANSION.</span></div>
<div class="line"><a id="l01139" name="l01139"></a><span class="lineno"> 1139</span> </div>
<div class="line"><a id="l01140" name="l01140"></a><span class="lineno"> 1140</span><span class="comment">! NUMBER OF TERMS OF POLYNOMIAL EXPANSION, AND HENCE ITS ACCURACY,</span></div>
<div class="line"><a id="l01141" name="l01141"></a><span class="lineno"> 1141</span><span class="comment">! IS GOVERNED BY ITERATION LIMIT &quot;IPOL&quot;.</span></div>
<div class="line"><a id="l01142" name="l01142"></a><span class="lineno"> 1142</span><span class="comment">!      IPOL GREATER THAN 9 ONLY MAKES A DIFFERENCE ON DOUBLE</span></div>
<div class="line"><a id="l01143" name="l01143"></a><span class="lineno"> 1143</span><span class="comment">!            PRECISION (RELATIVE ERRORS GIVEN IN PERCENT %).</span></div>
<div class="line"><a id="l01144" name="l01144"></a><span class="lineno"> 1144</span><span class="comment">!       IPOL=9, FOR REL.ERROR &lt;~ 1.6 E-6 % (8 SIGNIFICANT DIGITS)</span></div>
<div class="line"><a id="l01145" name="l01145"></a><span class="lineno"> 1145</span><span class="comment">!       IPOL=8, FOR REL.ERROR &lt;~ 1.8 E-5 % (7 SIGNIFICANT DIGITS)</span></div>
<div class="line"><a id="l01146" name="l01146"></a><span class="lineno"> 1146</span><span class="comment">!       IPOL=7, FOR REL.ERROR &lt;~ 1.8 E-4 % ...</span></div>
<div class="line"><a id="l01147" name="l01147"></a><span class="lineno"> 1147</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01148" name="l01148"></a><span class="lineno"> 1148</span>      bfac = dthr * c1* exp(0.08* tavgc - <a class="code hl_function" href="params_8m.html#a042889eb4a4c0a313ba885e8f173380d">c2</a>* sndens)</div>
<div class="line"><a id="l01149" name="l01149"></a><span class="lineno"> 1149</span>      ipol = 4</div>
<div class="line"><a id="l01150" name="l01150"></a><span class="lineno"> 1150</span>      pexp = 0.</div>
<div class="line"><a id="l01151" name="l01151"></a><span class="lineno"> 1151</span><span class="comment">!        PEXP = (1. + PEXP)*BFAC*ESDC/REAL(J+1)</span></div>
<div class="line"><a id="l01152" name="l01152"></a><span class="lineno"> 1152</span>      <span class="keywordflow">DO</span> j = ipol,1, -1</div>
<div class="line"><a id="l01153" name="l01153"></a><span class="lineno"> 1153</span>         pexp = (1. + pexp)* bfac * esdcx / <a class="code hl_typedef" href="mpas__ocn__okubo__weiss__eigenvalues_8c.html#a11d147c64891830c9e79b3315b1b2e21">real</a>(j +1)</div>
<div class="line"><a id="l01154" name="l01154"></a><span class="lineno"> 1154</span><span class="keywordflow">      END DO</span></div>
<div class="line"><a id="l01155" name="l01155"></a><span class="lineno"> 1155</span> </div>
<div class="line"><a id="l01156" name="l01156"></a><span class="lineno"> 1156</span>      pexp = pexp + 1.</div>
<div class="line"><a id="l01157" name="l01157"></a><span class="lineno"> 1157</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01158" name="l01158"></a><span class="lineno"> 1158</span><span class="comment">! ABOVE LINE ENDS POLYNOMIAL SUBSTITUTION</span></div>
<div class="line"><a id="l01159" name="l01159"></a><span class="lineno"> 1159</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01160" name="l01160"></a><span class="lineno"> 1160</span><span class="comment">!     END OF KOREAN FORMULATION</span></div>
<div class="line"><a id="l01161" name="l01161"></a><span class="lineno"> 1161</span> </div>
<div class="line"><a id="l01162" name="l01162"></a><span class="lineno"> 1162</span><span class="comment">!     BASE FORMULATION (COGLEY ET AL., 1990)</span></div>
<div class="line"><a id="l01163" name="l01163"></a><span class="lineno"> 1163</span><span class="comment">!     CONVERT DENSITY FROM G/CM3 TO KG/M3</span></div>
<div class="line"><a id="l01164" name="l01164"></a><span class="lineno"> 1164</span><span class="comment">!       DSM=SNDENS*1000.0</span></div>
<div class="line"><a id="l01165" name="l01165"></a><span class="lineno"> 1165</span> </div>
<div class="line"><a id="l01166" name="l01166"></a><span class="lineno"> 1166</span><span class="comment">!       DSX=DSM+DTSEC*0.5*DSM*G*SNEQV/</span></div>
<div class="line"><a id="l01167" name="l01167"></a><span class="lineno"> 1167</span><span class="comment">!    &amp;      (1E7*EXP(-0.02*DSM+KN/(TAVGC+273.16)-14.643))</span></div>
<div class="line"><a id="l01168" name="l01168"></a><span class="lineno"> 1168</span> </div>
<div class="line"><a id="l01169" name="l01169"></a><span class="lineno"> 1169</span><span class="comment">!  &amp;   CONVERT DENSITY FROM KG/M3 TO G/CM3</span></div>
<div class="line"><a id="l01170" name="l01170"></a><span class="lineno"> 1170</span><span class="comment">!       DSX=DSX/1000.0</span></div>
<div class="line"><a id="l01171" name="l01171"></a><span class="lineno"> 1171</span> </div>
<div class="line"><a id="l01172" name="l01172"></a><span class="lineno"> 1172</span><span class="comment">!     END OF COGLEY ET AL. FORMULATION</span></div>
<div class="line"><a id="l01173" name="l01173"></a><span class="lineno"> 1173</span> </div>
<div class="line"><a id="l01174" name="l01174"></a><span class="lineno"> 1174</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01175" name="l01175"></a><span class="lineno"> 1175</span><span class="comment">! SET UPPER/LOWER LIMIT ON SNOW DENSITY</span></div>
<div class="line"><a id="l01176" name="l01176"></a><span class="lineno"> 1176</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01177" name="l01177"></a><span class="lineno"> 1177</span>      dsx = sndens * (pexp)</div>
<div class="line"><a id="l01178" name="l01178"></a><span class="lineno"> 1178</span>      <span class="keywordflow">IF</span> (dsx &gt; 0.40) dsx = 0.40</div>
<div class="line"><a id="l01179" name="l01179"></a><span class="lineno"> 1179</span>      <span class="keywordflow">IF</span> (dsx &lt; 0.05) dsx = 0.05</div>
<div class="line"><a id="l01180" name="l01180"></a><span class="lineno"> 1180</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01181" name="l01181"></a><span class="lineno"> 1181</span><span class="comment">! UPDATE OF SNOW DEPTH AND DENSITY DEPENDING ON LIQUID WATER DURING</span></div>
<div class="line"><a id="l01182" name="l01182"></a><span class="lineno"> 1182</span><span class="comment">! SNOWMELT.  ASSUMED THAT 13% OF LIQUID WATER CAN BE STORED IN SNOW PER</span></div>
<div class="line"><a id="l01183" name="l01183"></a><span class="lineno"> 1183</span><span class="comment">! DAY DURING SNOWMELT TILL SNOW DENSITY 0.40.</span></div>
<div class="line"><a id="l01184" name="l01184"></a><span class="lineno"> 1184</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01185" name="l01185"></a><span class="lineno"> 1185</span>      sndens = dsx</div>
<div class="line"><a id="l01186" name="l01186"></a><span class="lineno"> 1186</span>      <span class="keywordflow">IF</span> (tsnowc &gt;=  0.) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l01187" name="l01187"></a><span class="lineno"> 1187</span>         dw = 0.13* dthr /24.</div>
<div class="line"><a id="l01188" name="l01188"></a><span class="lineno"> 1188</span>         sndens = sndens * (1. - dw) + dw</div>
<div class="line"><a id="l01189" name="l01189"></a><span class="lineno"> 1189</span>         <span class="keywordflow">IF</span> (sndens &gt;=  0.40) sndens = 0.40</div>
<div class="line"><a id="l01190" name="l01190"></a><span class="lineno"> 1190</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01191" name="l01191"></a><span class="lineno"> 1191</span><span class="comment">! CALCULATE SNOW DEPTH (CM) FROM SNOW WATER EQUIVALENT AND SNOW DENSITY.</span></div>
<div class="line"><a id="l01192" name="l01192"></a><span class="lineno"> 1192</span><span class="comment">! CHANGE SNOW DEPTH UNITS TO METERS</span></div>
<div class="line"><a id="l01193" name="l01193"></a><span class="lineno"> 1193</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01194" name="l01194"></a><span class="lineno"> 1194</span><span class="keywordflow">      END IF</span></div>
<div class="line"><a id="l01195" name="l01195"></a><span class="lineno"> 1195</span>      snowhc = esdc / sndens</div>
<div class="line"><a id="l01196" name="l01196"></a><span class="lineno"> 1196</span>      snowh = snowhc * 0.01</div>
<div class="line"><a id="l01197" name="l01197"></a><span class="lineno"> 1197</span> </div>
<div class="line"><a id="l01198" name="l01198"></a><span class="lineno"> 1198</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01199" name="l01199"></a><span class="lineno"> 1199</span>  <span class="keyword">END SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ae6d35ff66196a3ab369a3e87149ddcdc">snowpack</a></div>
<div class="line"><a id="l01200" name="l01200"></a><span class="lineno"> 1200</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01201" name="l01201"></a><span class="lineno"> 1201</span> </div>
<div class="line"><a id="l01202" name="l01202"></a><span class="lineno"> 1202</span>  <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ab3693cb1c40b1bd7b4db5e96337f6eef">snowz0</a> (Z0, Z0BRD, SNOWH)</div>
<div class="line"><a id="l01203" name="l01203"></a><span class="lineno"> 1203</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01204" name="l01204"></a><span class="lineno"> 1204</span><span class="comment">! CALCULATE TOTAL ROUGHNESS LENGTH OVER SNOW</span></div>
<div class="line"><a id="l01205" name="l01205"></a><span class="lineno"> 1205</span><span class="comment">! Z0      ROUGHNESS LENGTH (m)</span></div>
<div class="line"><a id="l01206" name="l01206"></a><span class="lineno"> 1206</span><span class="comment">! Z0S     SNOW ROUGHNESS LENGTH:=0.001 (m)</span></div>
<div class="line"><a id="l01207" name="l01207"></a><span class="lineno"> 1207</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01208" name="l01208"></a><span class="lineno"> 1208</span>    <span class="keywordtype">IMPLICIT NONE</span></div>
<div class="line"><a id="l01209" name="l01209"></a><span class="lineno"> 1209</span><span class="keywordtype">    REAL</span>, <span class="keywordtype">INTENT(IN)</span>        :: Z0BRD</div>
<div class="line"><a id="l01210" name="l01210"></a><span class="lineno"> 1210</span><span class="keywordtype">    REAL</span>, <span class="keywordtype">INTENT(OUT)</span>       :: Z0</div>
<div class="line"><a id="l01211" name="l01211"></a><span class="lineno"> 1211</span><span class="keywordtype">    REAL</span>, <span class="keywordtype">PARAMETER</span>         :: Z0S=0.001</div>
<div class="line"><a id="l01212" name="l01212"></a><span class="lineno"> 1212</span><span class="keywordtype">    REAL</span>, <span class="keywordtype">INTENT(IN)</span>        :: SNOWH</div>
<div class="line"><a id="l01213" name="l01213"></a><span class="lineno"> 1213</span><span class="keywordtype">    REAL</span>                    :: BURIAL</div>
<div class="line"><a id="l01214" name="l01214"></a><span class="lineno"> 1214</span><span class="keywordtype">    REAL</span>                    :: Z0EFF</div>
<div class="line"><a id="l01215" name="l01215"></a><span class="lineno"> 1215</span> </div>
<div class="line"><a id="l01216" name="l01216"></a><span class="lineno"> 1216</span>    burial = 7.0*z0brd - snowh</div>
<div class="line"><a id="l01217" name="l01217"></a><span class="lineno"> 1217</span>    <span class="keywordflow">IF</span>(burial.LE.0.0007) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l01218" name="l01218"></a><span class="lineno"> 1218</span>       z0eff = z0s</div>
<div class="line"><a id="l01219" name="l01219"></a><span class="lineno"> 1219</span>    <span class="keywordflow">ELSE</span>      </div>
<div class="line"><a id="l01220" name="l01220"></a><span class="lineno"> 1220</span>       z0eff = burial/7.0</div>
<div class="line"><a id="l01221" name="l01221"></a><span class="lineno"> 1221</span><span class="keywordflow">    ENDIF</span></div>
<div class="line"><a id="l01222" name="l01222"></a><span class="lineno"> 1222</span> </div>
<div class="line"><a id="l01223" name="l01223"></a><span class="lineno"> 1223</span>    z0 = z0eff</div>
<div class="line"><a id="l01224" name="l01224"></a><span class="lineno"> 1224</span> </div>
<div class="line"><a id="l01225" name="l01225"></a><span class="lineno"> 1225</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01226" name="l01226"></a><span class="lineno"> 1226</span>  <span class="keyword">END SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ab3693cb1c40b1bd7b4db5e96337f6eef">snowz0</a></div>
<div class="line"><a id="l01227" name="l01227"></a><span class="lineno"> 1227</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01228" name="l01228"></a><span class="lineno"> 1228</span> </div>
<div class="line"><a id="l01229" name="l01229"></a><span class="lineno"> 1229</span>  <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ab7e465439f409557715a28bea71551c1">snow_new</a> (TEMP,NEWSN,SNOWH,SNDENS)</div>
<div class="line"><a id="l01230" name="l01230"></a><span class="lineno"> 1230</span> </div>
<div class="line"><a id="l01231" name="l01231"></a><span class="lineno"> 1231</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01232" name="l01232"></a><span class="lineno"> 1232</span><span class="comment">! CALCULATE SNOW DEPTH AND DENSITY TO ACCOUNT FOR THE NEW SNOWFALL.</span></div>
<div class="line"><a id="l01233" name="l01233"></a><span class="lineno"> 1233</span><span class="comment">! UPDATED VALUES OF SNOW DEPTH AND DENSITY ARE RETURNED.</span></div>
<div class="line"><a id="l01234" name="l01234"></a><span class="lineno"> 1234</span> </div>
<div class="line"><a id="l01235" name="l01235"></a><span class="lineno"> 1235</span><span class="comment">! TEMP    AIR TEMPERATURE (K)</span></div>
<div class="line"><a id="l01236" name="l01236"></a><span class="lineno"> 1236</span><span class="comment">! NEWSN   NEW SNOWFALL (M)</span></div>
<div class="line"><a id="l01237" name="l01237"></a><span class="lineno"> 1237</span><span class="comment">! SNOWH   SNOW DEPTH (M)</span></div>
<div class="line"><a id="l01238" name="l01238"></a><span class="lineno"> 1238</span><span class="comment">! SNDENS  SNOW DENSITY (G/CM3=DIMENSIONLESS FRACTION OF H2O DENSITY)</span></div>
<div class="line"><a id="l01239" name="l01239"></a><span class="lineno"> 1239</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01240" name="l01240"></a><span class="lineno"> 1240</span>    <span class="keywordtype">IMPLICIT NONE</span></div>
<div class="line"><a id="l01241" name="l01241"></a><span class="lineno"> 1241</span><span class="keywordtype">    REAL</span>, <span class="keywordtype">INTENT(IN)</span>        :: NEWSN, TEMP</div>
<div class="line"><a id="l01242" name="l01242"></a><span class="lineno"> 1242</span><span class="keywordtype">    REAL</span>, <span class="keywordtype">INTENT(INOUT)</span>     :: SNDENS, SNOWH</div>
<div class="line"><a id="l01243" name="l01243"></a><span class="lineno"> 1243</span><span class="keywordtype">    REAL</span>                    :: DSNEW, HNEWC, SNOWHC,NEWSNC,TEMPC</div>
<div class="line"><a id="l01244" name="l01244"></a><span class="lineno"> 1244</span> </div>
<div class="line"><a id="l01245" name="l01245"></a><span class="lineno"> 1245</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01246" name="l01246"></a><span class="lineno"> 1246</span><span class="comment">! CALCULATING NEW SNOWFALL DENSITY DEPENDING ON TEMPERATURE</span></div>
<div class="line"><a id="l01247" name="l01247"></a><span class="lineno"> 1247</span><span class="comment">! EQUATION FROM GOTTLIB L. &#39;A GENERAL RUNOFF MODEL FOR SNOWCOVERED</span></div>
<div class="line"><a id="l01248" name="l01248"></a><span class="lineno"> 1248</span><span class="comment">! AND GLACIERIZED BASIN&#39;, 6TH NORDIC HYDROLOGICAL CONFERENCE,</span></div>
<div class="line"><a id="l01249" name="l01249"></a><span class="lineno"> 1249</span><span class="comment">! VEMADOLEN, SWEDEN, 1980, 172-177PP.</span></div>
<div class="line"><a id="l01250" name="l01250"></a><span class="lineno"> 1250</span><span class="comment">!-----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01251" name="l01251"></a><span class="lineno"> 1251</span>    tempc = temp - 273.15</div>
<div class="line"><a id="l01252" name="l01252"></a><span class="lineno"> 1252</span>    <span class="keywordflow">IF</span> ( tempc &lt;=  -15. ) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l01253" name="l01253"></a><span class="lineno"> 1253</span>       dsnew = 0.05</div>
<div class="line"><a id="l01254" name="l01254"></a><span class="lineno"> 1254</span>    <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l01255" name="l01255"></a><span class="lineno"> 1255</span>       dsnew = 0.05 + 0.0017 * ( tempc + 15. ) ** 1.5</div>
<div class="line"><a id="l01256" name="l01256"></a><span class="lineno"> 1256</span><span class="keywordflow">    ENDIF</span></div>
<div class="line"><a id="l01257" name="l01257"></a><span class="lineno"> 1257</span> </div>
<div class="line"><a id="l01258" name="l01258"></a><span class="lineno"> 1258</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01259" name="l01259"></a><span class="lineno"> 1259</span><span class="comment">! CONVERSION INTO SIMULATION UNITS</span></div>
<div class="line"><a id="l01260" name="l01260"></a><span class="lineno"> 1260</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01261" name="l01261"></a><span class="lineno"> 1261</span>    snowhc = snowh * 100.</div>
<div class="line"><a id="l01262" name="l01262"></a><span class="lineno"> 1262</span>    newsnc = newsn * 100.</div>
<div class="line"><a id="l01263" name="l01263"></a><span class="lineno"> 1263</span> </div>
<div class="line"><a id="l01264" name="l01264"></a><span class="lineno"> 1264</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01265" name="l01265"></a><span class="lineno"> 1265</span><span class="comment">! ADJUSTMENT OF SNOW DENSITY DEPENDING ON NEW SNOWFALL</span></div>
<div class="line"><a id="l01266" name="l01266"></a><span class="lineno"> 1266</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01267" name="l01267"></a><span class="lineno"> 1267</span>    hnewc = newsnc / dsnew</div>
<div class="line"><a id="l01268" name="l01268"></a><span class="lineno"> 1268</span>    <span class="keywordflow">IF</span> ( snowhc + hnewc &lt; 1.0e-3 ) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l01269" name="l01269"></a><span class="lineno"> 1269</span>       sndens = max( dsnew , sndens )</div>
<div class="line"><a id="l01270" name="l01270"></a><span class="lineno"> 1270</span>    <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l01271" name="l01271"></a><span class="lineno"> 1271</span>       sndens = ( snowhc * sndens + hnewc * dsnew ) / ( snowhc + hnewc )</div>
<div class="line"><a id="l01272" name="l01272"></a><span class="lineno"> 1272</span><span class="keywordflow">    ENDIF</span></div>
<div class="line"><a id="l01273" name="l01273"></a><span class="lineno"> 1273</span>    snowhc = snowhc + hnewc</div>
<div class="line"><a id="l01274" name="l01274"></a><span class="lineno"> 1274</span>    snowh = snowhc * 0.01</div>
<div class="line"><a id="l01275" name="l01275"></a><span class="lineno"> 1275</span> </div>
<div class="line"><a id="l01276" name="l01276"></a><span class="lineno"> 1276</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01277" name="l01277"></a><span class="lineno"> 1277</span>  <span class="keyword">END SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ab7e465439f409557715a28bea71551c1">snow_new</a></div>
<div class="line"><a id="l01278" name="l01278"></a><span class="lineno"> 1278</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01279" name="l01279"></a><span class="lineno"> 1279</span> </div>
<div class="line"><a id="l01280" name="l01280"></a><span class="lineno"> 1280</span><span class="keyword">END MODULE </span><a class="code hl_namespace" href="namespacemodule__sf__noahlsm__glacial__only.html">module_sf_noahlsm_glacial_only</a></div>
<div class="ttc" id="ampas__ocn__okubo__weiss__eigenvalues_8c_html_a11d147c64891830c9e79b3315b1b2e21"><div class="ttname"><a href="mpas__ocn__okubo__weiss__eigenvalues_8c.html#a11d147c64891830c9e79b3315b1b2e21">real</a></div><div class="ttdeci">double real</div><div class="ttdef"><b>Definition:</b> <a href="mpas__ocn__okubo__weiss__eigenvalues_8c_source.html#l00050">mpas_ocn_okubo_weiss_eigenvalues.c:50</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm__glacial__only_html"><div class="ttname"><a href="namespacemodule__sf__noahlsm__glacial__only.html">module_sf_noahlsm_glacial_only</a></div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm__glacial__only_8F_source.html#l00001">module_sf_noahlsm_glacial_only.F:1</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm__glacial__only_html_afa7bc1c71f24bbd328e603892e6af3ba"><div class="ttname"><a href="namespacemodule__sf__noahlsm__glacial__only.html#afa7bc1c71f24bbd328e603892e6af3ba">module_sf_noahlsm_glacial_only::sflx_glacial</a></div><div class="ttdeci">subroutine sflx_glacial(IILOC, JJLOC, ISICE, FFROZP, DT, ZLVL, NSOIL, SLDPTH, LWDN, SOLNET, SFCPRS, PRCP, SFCTMP, Q2, TH2, Q2SAT, DQSDT2, ALB, SNOALB, TBOT, Z0BRD, Z0, EMISSI, EMBRD, T1, STC, SNOWH, SNEQV, ALBEDO, CH, ETA, SHEAT, ETA_KINEMATIC, FDOWN, ESNOW, DEW, ETP, SSOIL, FLX1, FLX2, FLX3, SNOMLT, SNCOVR, RUNOFF1, Q1, SNOTIME1, RIBB)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm__glacial__only_8F_source.html#l00031">module_sf_noahlsm_glacial_only.F:50</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html">module_sf_noahlsm</a></div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00001">module_sf_noahlsm.F:1</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a41b56481dda78f3181c7e40721fa79a0"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a41b56481dda78f3181c7e40721fa79a0">module_sf_noahlsm::sigma</a></div><div class="ttdeci">real, parameter sigma</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00024">module_sf_noahlsm.F:24</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a5312fbbf31302c20e6823a3d2e97033b"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a5312fbbf31302c20e6823a3d2e97033b">module_sf_noahlsm::penman</a></div><div class="ttdeci">subroutine penman(SFCTMP, SFCPRS, CH, T2V, TH2, PRCP, FDOWN, T24, SSOIL, Q2, Q2SAT, ETP, RCH, EPSCA, RR, SNOWNG, FRZGRA, DQSDT2, FLX2, EMISSI_IN, SNEQV, T1, SNCOVR, AOASIS, ALBEDO, SOLDN, FVB, GAMA, STC1, ETPN, FLX4, UA_PHYS)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l02189">module_sf_noahlsm.F:2193</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a54e48804c7badd0dd8544b8c1dbcdf5f"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a54e48804c7badd0dd8544b8c1dbcdf5f">module_sf_noahlsm::emissi_s</a></div><div class="ttdeci">real, parameter emissi_s</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00024">module_sf_noahlsm.F:24</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a653d3903e2acbd4d19387ea434944093"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a653d3903e2acbd4d19387ea434944093">module_sf_noahlsm::cpice</a></div><div class="ttdeci">real, parameter cpice</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00024">module_sf_noahlsm.F:24</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a7a78bcce992262a6c96711208974f7f1"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a7a78bcce992262a6c96711208974f7f1">module_sf_noahlsm::alcalc</a></div><div class="ttdeci">subroutine alcalc(ALB, SNOALB, EMBRD, SHDFAC, SHDMIN, SNCOVR, TSNOW, ALBEDO, EMISSI, DT, SNOWNG, SNOTIME1, LVCOEF)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00887">module_sf_noahlsm.F:889</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a81f1f2ceb78e6b6a447b394803dee3c7"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a81f1f2ceb78e6b6a447b394803dee3c7">module_sf_noahlsm::lsubf</a></div><div class="ttdeci">real, parameter lsubf</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00024">module_sf_noahlsm.F:24</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a8df53633c056358bfa76c698ee182f17"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a8df53633c056358bfa76c698ee182f17">module_sf_noahlsm::rd</a></div><div class="ttdeci">real, parameter rd</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00024">module_sf_noahlsm.F:24</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_aaee442f9d981b7c296c5932352365351"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#aaee442f9d981b7c296c5932352365351">module_sf_noahlsm::shflx</a></div><div class="ttdeci">subroutine shflx(SSOIL, STC, SMC, SMCMAX, NSOIL, T1, DT, YY, ZZ1, ZSOIL, TBOT, ZBOT, SMCWLT, PSISAT, SH2O, BEXP, F1, DF1, QUARTZ, CSOIL, VEGTYP, ISURBAN, SOILTYP, OPT_THCND, HCPCT_FASDAS)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l02594">module_sf_noahlsm.F:2598</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_ab3693cb1c40b1bd7b4db5e96337f6eef"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#ab3693cb1c40b1bd7b4db5e96337f6eef">module_sf_noahlsm::snowz0</a></div><div class="ttdeci">subroutine snowz0(SNCOVR, Z0, Z0BRD, SNOWH, FBUR, FGSN, SHDMAX, UA_PHYS)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l03541">module_sf_noahlsm.F:3542</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_ab7e465439f409557715a28bea71551c1"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#ab7e465439f409557715a28bea71551c1">module_sf_noahlsm::snow_new</a></div><div class="ttdeci">subroutine snow_new(TEMP, NEWSN, SNOWH, SNDENS)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l03590">module_sf_noahlsm.F:3591</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_abb6e84ee87a6fdb3281c33e8e8457a04"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#abb6e84ee87a6fdb3281c33e8e8457a04">module_sf_noahlsm::csnow</a></div><div class="ttdeci">subroutine csnow(SNCOND, DSNOW)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l01144">module_sf_noahlsm.F:1145</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_abfdd114973412069ebbfb3a61af8d995"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#abfdd114973412069ebbfb3a61af8d995">module_sf_noahlsm::lvcoef_data</a></div><div class="ttdeci">real lvcoef_data</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00059">module_sf_noahlsm.F:59</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_ac6e3e7bb3f0322070546653306177216"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#ac6e3e7bb3f0322070546653306177216">module_sf_noahlsm::rosr12</a></div><div class="ttdeci">subroutine rosr12(P, A, B, C, D, DELTA, NSOIL)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l02531">module_sf_noahlsm.F:2532</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_adacf01be4e33445ea186feffce24eb35"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#adacf01be4e33445ea186feffce24eb35">module_sf_noahlsm::hstep</a></div><div class="ttdeci">subroutine hstep(STCOUT, STCIN, RHSTS, DT, NSOIL, AI, BI, CI)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l01849">module_sf_noahlsm.F:1850</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_ae07d087354ac15d439a02c8f0a1d24e4"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#ae07d087354ac15d439a02c8f0a1d24e4">module_sf_noahlsm::cph2o</a></div><div class="ttdeci">real, parameter cph2o</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00024">module_sf_noahlsm.F:24</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_ae27e8294cc66ecbb23f2a9d239a3c3d7"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#ae27e8294cc66ecbb23f2a9d239a3c3d7">module_sf_noahlsm::snopac</a></div><div class="ttdeci">subroutine snopac(ETP, ETA, PRCP, PRCPF, SNOWNG, SMC, SMCMAX, SMCWLT, SMCREF, SMCDRY, CMC, CMCMAX, NSOIL, DT, SBETA, DF1, Q2, T1, SFCTMP, T24, TH2, FDOWN, F1, SSOIL, STC, EPSCA, SFCPRS, BEXP, PC, RCH, RR, CFACTR, SNCOVR, ESD, SNDENS, SNOWH, SH2O, SLOPE, KDT, FRZFACT, PSISAT, ZSOIL, DWSAT, DKSAT, TBOT, ZBOT, SHDFAC, RUNOFF1, RUNOFF2, RUNOFF3, EDIR, EC, ET, ETT, NROOT, SNOMLT, RTDIS, QUARTZ, FXEXP, CSOIL, BETA, DRIP, DEW, FLX1, FLX2, FLX3, ESNOW, ETNS, EMISSI, RIBB, SOLDN, ISURBAN, VEGTYP, ETPN, FLX4, UA_PHYS, SFHEAD1RT, INFXS1RT, ETPND1, SOILTYP, OPT_THCND, QFX_PHY, fasdas, HCPCT_FASDAS)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l02999">module_sf_noahlsm.F:3015</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_ae6d35ff66196a3ab369a3e87149ddcdc"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#ae6d35ff66196a3ab369a3e87149ddcdc">module_sf_noahlsm::snowpack</a></div><div class="ttdeci">subroutine snowpack(ESD, DTSEC, SNOWH, SNDENS, TSNOW, TSOIL, SNOMLT, UA_PHYS)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l03406">module_sf_noahlsm.F:3407</a></div></div>
<div class="ttc" id="anamespacempas__atmphys__constants_html"><div class="ttname"><a href="namespacempas__atmphys__constants.html">mpas_atmphys_constants</a></div><div class="ttdef"><b>Definition:</b> <a href="core__atmosphere_2physics_2mpas__atmphys__constants_8F_source.html#l00009">mpas_atmphys_constants.F:9</a></div></div>
<div class="ttc" id="anamespacempas__atmphys__utilities_html"><div class="ttname"><a href="namespacempas__atmphys__utilities.html">mpas_atmphys_utilities</a></div><div class="ttdef"><b>Definition:</b> <a href="core__atmosphere_2physics_2mpas__atmphys__utilities_8F_source.html#l00009">mpas_atmphys_utilities.F:9</a></div></div>
<div class="ttc" id="anamespacempas__atmphys__utilities_html_aa49abb89b6ebc760010e08cbdade2706"><div class="ttname"><a href="namespacempas__atmphys__utilities.html#aa49abb89b6ebc760010e08cbdade2706">mpas_atmphys_utilities::physics_error_fatal</a></div><div class="ttdeci">subroutine, public physics_error_fatal(str)</div><div class="ttdef"><b>Definition:</b> <a href="core__atmosphere_2physics_2mpas__atmphys__utilities_8F_source.html#l00044">mpas_atmphys_utilities.F:45</a></div></div>
<div class="ttc" id="aparams_8m_html_a042889eb4a4c0a313ba885e8f173380d"><div class="ttname"><a href="params_8m.html#a042889eb4a4c0a313ba885e8f173380d">c2</a></div><div class="ttdeci">id c2()</div></div>
<div class="ttc" id="aparams_8m_html_a86bdec0d61a48a8ca4da1674058837cc"><div class="ttname"><a href="params_8m.html#a86bdec0d61a48a8ca4da1674058837cc">g</a></div><div class="ttdeci">id g()</div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5
</small></address>
</body>
</html>
