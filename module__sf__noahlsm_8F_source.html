<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MPAS-analisys: src/core_atmosphere/physics/physics_wrf/module_sf_noahlsm.F Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="logoMonanColor_75x75.png"/></td>
  <td id="projectalign">
   <div id="projectname">MPAS-analisys<span id="projectnumber">&#160;teste</span>
   </div>
   <div id="projectbrief">teste</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="dir_c53e21b94733dd8451b4d2db251c70bc.html">core_atmosphere</a></li><li class="navelem"><a class="el" href="dir_195703cd1d38332c0a06b72eede84187.html">physics</a></li><li class="navelem"><a class="el" href="dir_bc4ff68999f89a5d7c146546ef3424c5.html">physics_wrf</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle"><div class="title">module_sf_noahlsm.F</div></div>
</div><!--header-->
<div class="contents">
<a href="module__sf__noahlsm_8F.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a id="l00001" name="l00001"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html">    1</a></span><span class="keyword">MODULE</span> <a class="code hl_namespace" href="namespacemodule__sf__noahlsm.html">module_sf_noahlsm</a></div>
<div class="line"><a id="l00002" name="l00002"></a><span class="lineno">    2</span><span class="preprocessor">#if defined(mpas)</span></div>
<div class="line"><a id="l00003" name="l00003"></a><span class="lineno">    3</span><span class="preprocessor"></span><span class="keywordtype">use </span><a class="code hl_namespace" href="namespacempas__atmphys__constants.html">mpas_atmphys_constants</a>,<span class="keywordtype">only</span>: cp=&gt;cp,r_d=&gt;r_d,<a class="code hl_variable" href="namespacempas__atmphys__constants.html#aba58e22ad60aaeebff0afae9c623c38b">xlf</a>=&gt;<a class="code hl_variable" href="namespacempas__atmphys__constants.html#aba58e22ad60aaeebff0afae9c623c38b">xlf</a>,<a class="code hl_variable" href="namespacempas__atmphys__constants.html#a31b4d2a264901a4cbf284076c4828c0f">xlv</a>=&gt;<a class="code hl_variable" href="namespacempas__atmphys__constants.html#a31b4d2a264901a4cbf284076c4828c0f">xlv</a>,rhowater=&gt;<a class="code hl_variable" href="namespacempas__atmphys__constants.html#a92d08f338230a59f1a7b897a6bef4eed">rho_w</a>,<a class="code hl_variable" href="namespacempas__atmphys__constants.html#a29666893866b300a606b1d995d182d4e">stbolt</a>=&gt;<a class="code hl_variable" href="namespacempas__atmphys__constants.html#a29666893866b300a606b1d995d182d4e">stbolt</a>,<a class="code hl_variable" href="namespacempas__atmphys__constants.html#acc1b2857ee04cca1a37455c80fbd10bf">karman</a>=&gt;<a class="code hl_variable" href="namespacempas__atmphys__constants.html#acc1b2857ee04cca1a37455c80fbd10bf">karman</a></div>
<div class="line"><a id="l00004" name="l00004"></a><span class="lineno">    4</span><span class="keywordtype">use </span><a class="code hl_namespace" href="namespacempas__atmphys__utilities.html">mpas_atmphys_utilities</a>, <span class="keywordtype">only</span>: <a class="code hl_function" href="namespacempas__atmphys__utilities.html#aa49abb89b6ebc760010e08cbdade2706">physics_error_fatal</a></div>
<div class="line"><a id="l00005" name="l00005"></a><span class="lineno">    5</span><span class="preprocessor">#define FATAL_ERROR(M) call physics_error_fatal( M )</span></div>
<div class="line"><a id="l00006" name="l00006"></a><span class="lineno">    6</span><span class="preprocessor"></span><span class="preprocessor">#else</span></div>
<div class="line"><a id="l00007" name="l00007"></a><span class="lineno">    7</span><span class="preprocessor"></span><span class="keywordtype">USE </span>module_model_constants, <span class="keywordtype">only</span> : cp, r_d, <a class="code hl_variable" href="namespacempas__atmphys__constants.html#aba58e22ad60aaeebff0afae9c623c38b">xlf</a>, <a class="code hl_variable" href="namespacempas__atmphys__constants.html#a31b4d2a264901a4cbf284076c4828c0f">xlv</a>, rhowater, <a class="code hl_variable" href="namespacempas__atmphys__constants.html#a29666893866b300a606b1d995d182d4e">stbolt</a>, <a class="code hl_variable" href="namespacempas__atmphys__constants.html#acc1b2857ee04cca1a37455c80fbd10bf">karman</a></div>
<div class="line"><a id="l00008" name="l00008"></a><span class="lineno">    8</span><span class="keywordtype">use </span>module_wrf_error</div>
<div class="line"><a id="l00009" name="l00009"></a><span class="lineno">    9</span><span class="preprocessor">#define FATAL_ERROR(M) call wrf_error_fatal( M )</span></div>
<div class="line"><a id="l00010" name="l00010"></a><span class="lineno">   10</span><span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l00011" name="l00011"></a><span class="lineno">   11</span><span class="preprocessor"></span> </div>
<div class="line"><a id="l00012" name="l00012"></a><span class="lineno">   12</span><span class="comment">!ckay=KIRAN ALAPATY @ US EPA -- November 01, 2015</span></div>
<div class="line"><a id="l00013" name="l00013"></a><span class="lineno">   13</span><span class="comment">!</span></div>
<div class="line"><a id="l00014" name="l00014"></a><span class="lineno">   14</span><span class="comment">! Tim Glotfelty@CNSU; AJ Deng@PSU</span></div>
<div class="line"><a id="l00015" name="l00015"></a><span class="lineno">   15</span><span class="comment">!modified for use with FASDAS </span></div>
<div class="line"><a id="l00016" name="l00016"></a><span class="lineno">   16</span><span class="comment">!Flux Adjusting Surface Data Assimilation System to assimilate </span></div>
<div class="line"><a id="l00017" name="l00017"></a><span class="lineno">   17</span><span class="comment">!surface layer and soil layers temperature and moisture using</span></div>
<div class="line"><a id="l00018" name="l00018"></a><span class="lineno">   18</span><span class="comment">! surfance reanalsys </span></div>
<div class="line"><a id="l00019" name="l00019"></a><span class="lineno">   19</span><span class="comment">!Reference: Alapaty et al., 2008: Development of the flux-adjusting surface</span></div>
<div class="line"><a id="l00020" name="l00020"></a><span class="lineno">   20</span><span class="comment">! data assimilation system for mesoscale models. JAMC, 47, 2331-2350</span></div>
<div class="line"><a id="l00021" name="l00021"></a><span class="lineno">   21</span><span class="comment">!</span></div>
<div class="line"><a id="l00022" name="l00022"></a><span class="lineno">   22</span> </div>
<div class="line"><a id="l00023" name="l00023"></a><span class="lineno">   23</span><span class="comment">!   REAL, PARAMETER    :: CP = 1004.5</span></div>
<div class="line"><a id="l00024" name="l00024"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#ae07d087354ac15d439a02c8f0a1d24e4">   24</a></span><span class="keywordtype">  REAL</span>, <span class="keywordtype">PARAMETER</span>      :: <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a8df53633c056358bfa76c698ee182f17">rd</a> = 287.04, <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a41b56481dda78f3181c7e40721fa79a0">sigma</a> = 5.67e-8,                 &amp;</div>
<div class="line"><a id="l00025" name="l00025"></a><span class="lineno">   25</span>                          <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#ae07d087354ac15d439a02c8f0a1d24e4">cph2o</a> = 4.218e+3,<a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a653d3903e2acbd4d19387ea434944093">cpice</a> = 2.106e+3,            &amp;</div>
<div class="line"><a id="l00026" name="l00026"></a><span class="lineno">   26</span>                          <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a81f1f2ceb78e6b6a447b394803dee3c7">lsubf</a> = 3.335e+5,                             &amp;</div>
<div class="line"><a id="l00027" name="l00027"></a><span class="lineno">   27</span>                          <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a54e48804c7badd0dd8544b8c1dbcdf5f">emissi_s</a> = 0.95</div>
<div class="line"><a id="l00028" name="l00028"></a><span class="lineno">   28</span> </div>
<div class="line"><a id="l00029" name="l00029"></a><span class="lineno">   29</span><span class="comment">! VEGETATION PARAMETERS</span></div>
<div class="line"><a id="l00030" name="l00030"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#af967731a9437616e8e2b5bb6f3e1712e">   30</a></span>        <span class="keywordtype">INTEGER</span> :: <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#aa1474706df3973c92ce572eb5517a6ca">lucats</a> , <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#af967731a9437616e8e2b5bb6f3e1712e">bare</a></div>
<div class="line"><a id="l00031" name="l00031"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#ab98144204f7c38b7c42ae05ce73403b2">   31</a></span>        <span class="keywordtype">INTEGER</span> :: <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#ab98144204f7c38b7c42ae05ce73403b2">natural</a></div>
<div class="line"><a id="l00032" name="l00032"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#a162eaa508d912b165fd5d5b59f9c8276">   32</a></span>        <span class="keywordtype">INTEGER</span> :: <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a6029894190d9a2de7f0bfe83f84821ed">low_density_residential</a>, <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a162eaa508d912b165fd5d5b59f9c8276">high_density_residential</a>, <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a80bccc6a8e3641348467b3867a35ca00">high_intensity_industrial</a></div>
<div class="line"><a id="l00033" name="l00033"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#a6eb802ec31e08c8d45492d3057202b09">   33</a></span>        <span class="keywordtype">integer</span>, <span class="keywordtype">PARAMETER</span> :: <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a6eb802ec31e08c8d45492d3057202b09">nlus</a>=50</div>
<div class="line"><a id="l00034" name="l00034"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#ae38d77ba0e04158bf5681f63787f5615">   34</a></span>        <span class="keywordtype">CHARACTER(LEN=256)</span> <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#ae38d77ba0e04158bf5681f63787f5615">lutype</a></div>
<div class="line"><a id="l00035" name="l00035"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#af54c396581833689886321e9937a8b6b">   35</a></span>        <span class="keywordtype">INTEGER</span>, <span class="keywordtype">DIMENSION(1:NLUS)</span> :: <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#af54c396581833689886321e9937a8b6b">nrotbl</a></div>
<div class="line"><a id="l00036" name="l00036"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#a9cb2add5ba6296cc7aac44442d42b2d4">   36</a></span><span class="keywordtype">        real</span>, <span class="keywordtype">dimension(1:NLUS)</span> ::  <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#af49267d813703d06dc522c006a0efdd8">snuptbl</a>, <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#aa0847a080464d5bff86f7fc48a8eae13">rstbl</a>, <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a0f671f01ac448828a19839c29fe2a80d">rgltbl</a>, <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a032dea1cb1492e469ff23cf4a34170ea">hstbl</a>,                &amp;</div>
<div class="line"><a id="l00037" name="l00037"></a><span class="lineno">   37</span>                                    <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a901df854f3a4654ea71bfa71ad88282f">shdtbl</a>, <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#aaf2ec4ae19423d4c1b907274266e1f75">maxalb</a>,                               &amp;</div>
<div class="line"><a id="l00038" name="l00038"></a><span class="lineno">   38</span>                                    <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#aa4d4ac6f0a95c2a6bce0c39cea8fe74d">emissmintbl</a>, <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#af6a31bb1e4de31d7e62c196cbf6dc2ee">emissmaxtbl</a>,                     &amp;</div>
<div class="line"><a id="l00039" name="l00039"></a><span class="lineno">   39</span>                                    <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#ab9a5163c0bdd9b8af04056e8b88daa4e">laimintbl</a>, <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a2c126e8a645fbfff910ba7d7415078e5">laimaxtbl</a>,                         &amp;</div>
<div class="line"><a id="l00040" name="l00040"></a><span class="lineno">   40</span>                                    <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#aef1bae6bfa7f8eb613369181f2ca0bcd">z0mintbl</a>, <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a72bf7902c4cdf8a89ad09a592be5381a">z0maxtbl</a>,                           &amp;</div>
<div class="line"><a id="l00041" name="l00041"></a><span class="lineno">   41</span>                                    <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a5620825a183522809f7fd87ce222bc75">albedomintbl</a>, <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a9cb2add5ba6296cc7aac44442d42b2d4">albedomaxtbl</a>,                   &amp;</div>
<div class="line"><a id="l00042" name="l00042"></a><span class="lineno">   42</span>                                    <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a6eefa55e3997176fcb176348dbabfa4e">ztopvtbl</a>,<a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a5e4d45f6d99b175703cb7cf1c2485e8a">zbotvtbl</a></div>
<div class="line"><a id="l00043" name="l00043"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#a49b5bd6e866a73374623128552be22ec">   43</a></span><span class="keywordtype">        REAL</span> ::   <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a9b543a894e8a65d824249871d7f936d3">topt_data</a>,<a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a0de1ade2206d62259245f281a9751200">cmcmax_data</a>,<a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a49b5bd6e866a73374623128552be22ec">cfactr_data</a>,<a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a0500272007439fcc4870091db509d5e0">rsmax_data</a></div>
<div class="line"><a id="l00044" name="l00044"></a><span class="lineno">   44</span> </div>
<div class="line"><a id="l00045" name="l00045"></a><span class="lineno">   45</span><span class="comment">! SOIL PARAMETERS</span></div>
<div class="line"><a id="l00046" name="l00046"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#a86862de601c92fc02c2501c1827c3da4">   46</a></span>        <span class="keywordtype">INTEGER</span> :: <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a86862de601c92fc02c2501c1827c3da4">slcats</a></div>
<div class="line"><a id="l00047" name="l00047"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#a2b8557df16e078c40e5bea80224b951c">   47</a></span>        <span class="keywordtype">INTEGER</span>, <span class="keywordtype">PARAMETER</span> :: <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a2b8557df16e078c40e5bea80224b951c">nsltype</a>=30</div>
<div class="line"><a id="l00048" name="l00048"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#abe6654781f59a713e1ac61fda3eb633b">   48</a></span>        <span class="keywordtype">CHARACTER(LEN=256)</span> <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#abe6654781f59a713e1ac61fda3eb633b">sltype</a></div>
<div class="line"><a id="l00049" name="l00049"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#a421c11109bef5a1c768d721cb746c495">   49</a></span><span class="keywordtype">        REAL</span>, <span class="keywordtype">DIMENSION (1:NSLTYPE)</span> :: <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a421c11109bef5a1c768d721cb746c495">bb</a>,<a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a6e407ba242e1b07a68eb56f1180447c6">drysmc</a>,<a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a5394697bf41b6a406cf68211008c2c05">f11</a>,                           &amp;</div>
<div class="line"><a id="l00050" name="l00050"></a><span class="lineno">   50</span>        <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#ae7e9abc3699009623585d342ed700ea8">maxsmc</a>, <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a7a50ad4eacd814b850f723a4b67a8ead">refsmc</a>,<a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a2d3913e03c9d3f6dc2f1817689a70aa7">satpsi</a>,<a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a935945ddf12582dad80c67c9c88034ac">satdk</a>,<a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#ab26c159cdc7754b2a7c741d846fb9e28">satdw</a>, <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#ab273c118cc131cacda35bba9180402f9">wltsmc</a>,<a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a264ef4f6e4e0348d29a24399729c47b1">qtz</a></div>
<div class="line"><a id="l00051" name="l00051"></a><span class="lineno">   51</span> </div>
<div class="line"><a id="l00052" name="l00052"></a><span class="lineno">   52</span><span class="comment">! LSM GENERAL PARAMETERS</span></div>
<div class="line"><a id="l00053" name="l00053"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#a347f1f27afb384360fada49937ebf1cc">   53</a></span>        <span class="keywordtype">INTEGER</span> :: <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a347f1f27afb384360fada49937ebf1cc">slpcats</a></div>
<div class="line"><a id="l00054" name="l00054"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#a66770731f9d207f81564cc084cdcd40e">   54</a></span>        <span class="keywordtype">INTEGER</span>, <span class="keywordtype">PARAMETER</span> :: <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a66770731f9d207f81564cc084cdcd40e">nslope</a>=30</div>
<div class="line"><a id="l00055" name="l00055"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#ae24910d9fdc3b5b4d0ed62901e8c53bd">   55</a></span><span class="keywordtype">        REAL</span>, <span class="keywordtype">DIMENSION (1:NSLOPE)</span> :: <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#ae24910d9fdc3b5b4d0ed62901e8c53bd">slope_data</a></div>
<div class="line"><a id="l00056" name="l00056"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#ac05feb2a0ff4bb9285433492b2eb10f4">   56</a></span><span class="keywordtype">        REAL</span> ::  <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#aae70644775d8b7023c8c3a7ba90616a8">sbeta_data</a>,<a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#acc9389a964a5c2195267b0d1b6a71ced">fxexp_data</a>,<a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#ac05feb2a0ff4bb9285433492b2eb10f4">csoil_data</a>,<a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a5e842b9c23b43bc3ccf873a9bf9612af">salp_data</a>,<a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#ae3fd374e34b9af10dd489dfc1965d827">refdk_data</a>,           &amp;</div>
<div class="line"><a id="l00057" name="l00057"></a><span class="lineno">   57</span>                 <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#acbe287caffdd1287fb71954b6284d2f5">refkdt_data</a>,<a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a786fd6e5794b80a6cbb602a290a6fd6a">frzk_data</a>,<a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a1e5f83b829493815912f8e801edd7b17">zbot_data</a>,  <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a3d56b3f7eeeccda9e1d6f7d0aecfb149">smlow_data</a>,<a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#ad1881be5e002e66566e6119f6ca6e032">smhigh_data</a>,        &amp;</div>
<div class="line"><a id="l00058" name="l00058"></a><span class="lineno">   58</span>                        <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a6c8c21728a7859d57a4e867f2df6d521">czil_data</a></div>
<div class="line"><a id="l00059" name="l00059"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#abfdd114973412069ebbfb3a61af8d995">   59</a></span><span class="keywordtype">        REAL</span> ::  <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#abfdd114973412069ebbfb3a61af8d995">lvcoef_data</a></div>
<div class="line"><a id="l00060" name="l00060"></a><span class="lineno">   60</span> </div>
<div class="line"><a id="l00061" name="l00061"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#a120cf314f9b0b4e08b223b15858faefe">   61</a></span>        <span class="keywordtype">CHARACTER*256</span>  :: <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a120cf314f9b0b4e08b223b15858faefe">err_message</a></div>
<div class="line"><a id="l00062" name="l00062"></a><span class="lineno">   62</span> </div>
<div class="line"><a id="l00063" name="l00063"></a><span class="lineno">   63</span>        <span class="keywordtype">integer</span>, <span class="keywordtype">private</span> :: iloc, jloc</div>
<div class="line"><a id="l00064" name="l00064"></a><span class="lineno">   64</span><span class="comment">!$omp threadprivate(iloc, jloc)</span></div>
<div class="line"><a id="l00065" name="l00065"></a><span class="lineno">   65</span><span class="comment">!</span></div>
<div class="line"><a id="l00066" name="l00066"></a><span class="lineno">   66</span><span class="keyword">CONTAINS</span></div>
<div class="line"><a id="l00067" name="l00067"></a><span class="lineno">   67</span><span class="comment">!</span></div>
<div class="line"><a id="l00068" name="l00068"></a><span class="lineno">   68</span> </div>
<div class="line"><a id="l00069" name="l00069"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#a89de2b557283473efeeec5d3d49c7e7e">   69</a></span>      <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a89de2b557283473efeeec5d3d49c7e7e">sflx</a> (IILOC,JJLOC,FFROZP,ISURBAN,DT,ZLVL,NSOIL,SLDPTH, &amp;    !C</div>
<div class="line"><a id="l00070" name="l00070"></a><span class="lineno">   70</span>                       LOCAL,                                           &amp;    !L</div>
<div class="line"><a id="l00071" name="l00071"></a><span class="lineno">   71</span>                       LLANDUSE, LSOIL,                                 &amp;    !CL</div>
<div class="line"><a id="l00072" name="l00072"></a><span class="lineno">   72</span>                       LWDN,SOLDN,SOLNET,SFCPRS,PRCP,SFCTMP,Q2,SFCSPD,  &amp;    !F</div>
<div class="line"><a id="l00073" name="l00073"></a><span class="lineno">   73</span>                       COSZ,PRCPRAIN, SOLARDIRECT,                      &amp;    !F</div>
<div class="line"><a id="l00074" name="l00074"></a><span class="lineno">   74</span>                       TH2,Q2SAT,DQSDT2,                                &amp;    !I</div>
<div class="line"><a id="l00075" name="l00075"></a><span class="lineno">   75</span>                       VEGTYP,SOILTYP,SLOPETYP,SHDFAC,SHDMIN,SHDMAX,    &amp;    !I</div>
<div class="line"><a id="l00076" name="l00076"></a><span class="lineno">   76</span>                       ALB, SNOALB,TBOT, Z0BRD, Z0, EMISSI, EMBRD,      &amp;    !S</div>
<div class="line"><a id="l00077" name="l00077"></a><span class="lineno">   77</span>                       CMC,T1,STC,SMC,SH2O,SNOWH,SNEQV,ALBEDO,CH,CM,    &amp;    !H</div>
<div class="line"><a id="l00078" name="l00078"></a><span class="lineno">   78</span>! ----------------------------------------------------------------------</div>
<div class="line"><a id="l00079" name="l00079"></a><span class="lineno">   79</span>! OUTPUTS, DIAGNOSTICS, PARAMETERS BELOW GENERALLY NOT NECESSARY WHEN</div>
<div class="line"><a id="l00080" name="l00080"></a><span class="lineno">   80</span>! COUPLED WITH E.G. A NWP MODEL (SUCH AS THE NOAA/NWS/NCEP MESOSCALE ETA</div>
<div class="line"><a id="l00081" name="l00081"></a><span class="lineno">   81</span>! MODEL).  other applications may require different output variables.</div>
<div class="line"><a id="l00082" name="l00082"></a><span class="lineno">   82</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00083" name="l00083"></a><span class="lineno">   83</span>                       eta,sheat, eta_kinematic,fdown,                  &amp;    <span class="comment">!O</span></div>
<div class="line"><a id="l00084" name="l00084"></a><span class="lineno">   84</span>                       ec,edir,et,ett,esnow,drip,dew,                   &amp;    <span class="comment">!O</span></div>
<div class="line"><a id="l00085" name="l00085"></a><span class="lineno">   85</span>                       beta,etp,ssoil,                                  &amp;    <span class="comment">!O</span></div>
<div class="line"><a id="l00086" name="l00086"></a><span class="lineno">   86</span>                       flx1,flx2,flx3,                                  &amp;    <span class="comment">!O</span></div>
<div class="line"><a id="l00087" name="l00087"></a><span class="lineno">   87</span>               flx4,fvb,fbur,fgsn,ua_phys,                      &amp;    <span class="comment">!UA </span></div>
<div class="line"><a id="l00088" name="l00088"></a><span class="lineno">   88</span>                       snomlt,sncovr,                                   &amp;    <span class="comment">!O</span></div>
<div class="line"><a id="l00089" name="l00089"></a><span class="lineno">   89</span>                       runoff1,runoff2,runoff3,                         &amp;    <span class="comment">!O</span></div>
<div class="line"><a id="l00090" name="l00090"></a><span class="lineno">   90</span>                       rc,pc,rsmin,xlai,rcs,rct,rcq,rcsoil,             &amp;    <span class="comment">!O</span></div>
<div class="line"><a id="l00091" name="l00091"></a><span class="lineno">   91</span>                       soilw,soilm,q1,smav,                             &amp;    <span class="comment">!D</span></div>
<div class="line"><a id="l00092" name="l00092"></a><span class="lineno">   92</span>                       rdlai2d,usemonalb,                               &amp;</div>
<div class="line"><a id="l00093" name="l00093"></a><span class="lineno">   93</span>                       snotime1,                                        &amp;</div>
<div class="line"><a id="l00094" name="l00094"></a><span class="lineno">   94</span>                       ribb,                                            &amp;</div>
<div class="line"><a id="l00095" name="l00095"></a><span class="lineno">   95</span>                       smcwlt,smcdry,smcref,smcmax,nroot,   &amp;</div>
<div class="line"><a id="l00096" name="l00096"></a><span class="lineno">   96</span>                       sfhead1rt,                                       &amp;    <span class="comment">!I</span></div>
<div class="line"><a id="l00097" name="l00097"></a><span class="lineno">   97</span>                       infxs1rt,etpnd1,opt_thcnd,aoasis                 &amp;    <span class="comment">!P</span></div>
<div class="line"><a id="l00098" name="l00098"></a><span class="lineno">   98</span>                      ,xsda_qfx,hfx_phy,qfx_phy,xqnorm                  &amp;    <span class="comment">!fasdas</span></div>
<div class="line"><a id="l00099" name="l00099"></a><span class="lineno">   99</span>                      ,fasdas,hcpct_fasdas                              )    <span class="comment">!fasdas</span></div>
<div class="line"><a id="l00100" name="l00100"></a><span class="lineno">  100</span> </div>
<div class="line"><a id="l00101" name="l00101"></a><span class="lineno">  101</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00102" name="l00102"></a><span class="lineno">  102</span><span class="comment">! SUBROUTINE SFLX - UNIFIED NOAHLSM VERSION 1.0 JULY 2007</span></div>
<div class="line"><a id="l00103" name="l00103"></a><span class="lineno">  103</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00104" name="l00104"></a><span class="lineno">  104</span><span class="comment">! SUB-DRIVER FOR &quot;Noah LSM&quot; FAMILY OF PHYSICS SUBROUTINES FOR A</span></div>
<div class="line"><a id="l00105" name="l00105"></a><span class="lineno">  105</span><span class="comment">! SOIL/VEG/SNOWPACK LAND-SURFACE MODEL TO UPDATE SOIL MOISTURE, SOIL</span></div>
<div class="line"><a id="l00106" name="l00106"></a><span class="lineno">  106</span><span class="comment">! ICE, SOIL TEMPERATURE, SKIN TEMPERATURE, SNOWPACK WATER CONTENT,</span></div>
<div class="line"><a id="l00107" name="l00107"></a><span class="lineno">  107</span><span class="comment">! SNOWDEPTH, AND ALL TERMS OF THE SURFACE ENERGY BALANCE AND SURFACE</span></div>
<div class="line"><a id="l00108" name="l00108"></a><span class="lineno">  108</span><span class="comment">! WATER BALANCE (EXCLUDING INPUT ATMOSPHERIC FORCINGS OF DOWNWARD</span></div>
<div class="line"><a id="l00109" name="l00109"></a><span class="lineno">  109</span><span class="comment">! RADIATION AND PRECIP)</span></div>
<div class="line"><a id="l00110" name="l00110"></a><span class="lineno">  110</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00111" name="l00111"></a><span class="lineno">  111</span><span class="comment">! SFLX ARGUMENT LIST KEY:</span></div>
<div class="line"><a id="l00112" name="l00112"></a><span class="lineno">  112</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00113" name="l00113"></a><span class="lineno">  113</span><span class="comment">!  C  CONFIGURATION INFORMATION</span></div>
<div class="line"><a id="l00114" name="l00114"></a><span class="lineno">  114</span><span class="comment">!  L  LOGICAL</span></div>
<div class="line"><a id="l00115" name="l00115"></a><span class="lineno">  115</span><span class="comment">! CL  4-string character bearing logical meaning</span></div>
<div class="line"><a id="l00116" name="l00116"></a><span class="lineno">  116</span><span class="comment">!  F  FORCING DATA</span></div>
<div class="line"><a id="l00117" name="l00117"></a><span class="lineno">  117</span><span class="comment">!  I  OTHER (INPUT) FORCING DATA</span></div>
<div class="line"><a id="l00118" name="l00118"></a><span class="lineno">  118</span><span class="comment">!  S  SURFACE CHARACTERISTICS</span></div>
<div class="line"><a id="l00119" name="l00119"></a><span class="lineno">  119</span><span class="comment">!  H  HISTORY (STATE) VARIABLES</span></div>
<div class="line"><a id="l00120" name="l00120"></a><span class="lineno">  120</span><span class="comment">!  O  OUTPUT VARIABLES</span></div>
<div class="line"><a id="l00121" name="l00121"></a><span class="lineno">  121</span><span class="comment">!  D  DIAGNOSTIC OUTPUT</span></div>
<div class="line"><a id="l00122" name="l00122"></a><span class="lineno">  122</span><span class="comment">!  P  Parameters</span></div>
<div class="line"><a id="l00123" name="l00123"></a><span class="lineno">  123</span><span class="comment">!  Msic Miscellaneous terms passed from gridded driver</span></div>
<div class="line"><a id="l00124" name="l00124"></a><span class="lineno">  124</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00125" name="l00125"></a><span class="lineno">  125</span><span class="comment">! 1. CONFIGURATION INFORMATION (C):</span></div>
<div class="line"><a id="l00126" name="l00126"></a><span class="lineno">  126</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00127" name="l00127"></a><span class="lineno">  127</span><span class="comment">!   DT         TIMESTEP (SEC) (DT SHOULD NOT EXCEED 3600 SECS, RECOMMEND</span></div>
<div class="line"><a id="l00128" name="l00128"></a><span class="lineno">  128</span><span class="comment">!                1800 SECS OR LESS)</span></div>
<div class="line"><a id="l00129" name="l00129"></a><span class="lineno">  129</span><span class="comment">!   ZLVL       HEIGHT (M) ABOVE GROUND OF ATMOSPHERIC FORCING VARIABLES</span></div>
<div class="line"><a id="l00130" name="l00130"></a><span class="lineno">  130</span><span class="comment">!   NSOIL      NUMBER OF SOIL LAYERS (AT LEAST 2, AND NOT GREATER THAN</span></div>
<div class="line"><a id="l00131" name="l00131"></a><span class="lineno">  131</span><span class="comment">!                PARAMETER NSOLD SET BELOW)</span></div>
<div class="line"><a id="l00132" name="l00132"></a><span class="lineno">  132</span><span class="comment">!   SLDPTH     THE THICKNESS OF EACH SOIL LAYER (M)</span></div>
<div class="line"><a id="l00133" name="l00133"></a><span class="lineno">  133</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00134" name="l00134"></a><span class="lineno">  134</span><span class="comment">! 2. LOGICAL:</span></div>
<div class="line"><a id="l00135" name="l00135"></a><span class="lineno">  135</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00136" name="l00136"></a><span class="lineno">  136</span><span class="comment">!   LCH       Exchange coefficient (Ch) calculation flag (false: using</span></div>
<div class="line"><a id="l00137" name="l00137"></a><span class="lineno">  137</span><span class="comment">!                ch-routine SFCDIF; true: Ch is brought in)</span></div>
<div class="line"><a id="l00138" name="l00138"></a><span class="lineno">  138</span><span class="comment">!   LOCAL      Flag for local-site simulation (where there is no</span></div>
<div class="line"><a id="l00139" name="l00139"></a><span class="lineno">  139</span><span class="comment">!              maps for albedo, veg fraction, and roughness</span></div>
<div class="line"><a id="l00140" name="l00140"></a><span class="lineno">  140</span><span class="comment">!             true:  all LSM parameters (inluding albedo, veg fraction and</span></div>
<div class="line"><a id="l00141" name="l00141"></a><span class="lineno">  141</span><span class="comment">!                    roughness length) will be defined by three tables</span></div>
<div class="line"><a id="l00142" name="l00142"></a><span class="lineno">  142</span><span class="comment">!   LLANDUSE  (=USGS, using USGS landuse classification)</span></div>
<div class="line"><a id="l00143" name="l00143"></a><span class="lineno">  143</span><span class="comment">!   LSOIL     (=STAS, using FAO/STATSGO soil texture classification)</span></div>
<div class="line"><a id="l00144" name="l00144"></a><span class="lineno">  144</span><span class="comment">!   OPT_THCND option for how to treat thermal conductivity</span></div>
<div class="line"><a id="l00145" name="l00145"></a><span class="lineno">  145</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00146" name="l00146"></a><span class="lineno">  146</span><span class="comment">! 3. FORCING DATA (F):</span></div>
<div class="line"><a id="l00147" name="l00147"></a><span class="lineno">  147</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00148" name="l00148"></a><span class="lineno">  148</span><span class="comment">!   LWDN       LW DOWNWARD RADIATION (W M-2; POSITIVE, NOT NET LONGWAVE)</span></div>
<div class="line"><a id="l00149" name="l00149"></a><span class="lineno">  149</span><span class="comment">!   SOLDN      SOLAR DOWNWARD RADIATION (W M-2; POSITIVE, NOT NET SOLAR)</span></div>
<div class="line"><a id="l00150" name="l00150"></a><span class="lineno">  150</span><span class="comment">!   SOLNET     NET DOWNWARD SOLAR RADIATION ((W M-2; POSITIVE)</span></div>
<div class="line"><a id="l00151" name="l00151"></a><span class="lineno">  151</span><span class="comment">!   SFCPRS     PRESSURE AT HEIGHT ZLVL ABOVE GROUND (PASCALS)</span></div>
<div class="line"><a id="l00152" name="l00152"></a><span class="lineno">  152</span><span class="comment">!   PRCP       PRECIP RATE (KG M-2 S-1) (NOTE, THIS IS A RATE)</span></div>
<div class="line"><a id="l00153" name="l00153"></a><span class="lineno">  153</span><span class="comment">!   SFCTMP     AIR TEMPERATURE (K) AT HEIGHT ZLVL ABOVE GROUND</span></div>
<div class="line"><a id="l00154" name="l00154"></a><span class="lineno">  154</span><span class="comment">!   TH2        AIR POTENTIAL TEMPERATURE (K) AT HEIGHT ZLVL ABOVE GROUND</span></div>
<div class="line"><a id="l00155" name="l00155"></a><span class="lineno">  155</span><span class="comment">!   Q2         MIXING RATIO AT HEIGHT ZLVL ABOVE GROUND (KG KG-1)</span></div>
<div class="line"><a id="l00156" name="l00156"></a><span class="lineno">  156</span><span class="comment">!   COSZ       Solar zenith angle (not used for now)</span></div>
<div class="line"><a id="l00157" name="l00157"></a><span class="lineno">  157</span><span class="comment">!   PRCPRAIN   Liquid-precipitation rate (KG M-2 S-1) (not used)</span></div>
<div class="line"><a id="l00158" name="l00158"></a><span class="lineno">  158</span><span class="comment">! SOLARDIRECT  Direct component of downward solar radiation (W M-2) (not used)</span></div>
<div class="line"><a id="l00159" name="l00159"></a><span class="lineno">  159</span><span class="comment">!   FFROZP     FRACTION OF FROZEN PRECIPITATION</span></div>
<div class="line"><a id="l00160" name="l00160"></a><span class="lineno">  160</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00161" name="l00161"></a><span class="lineno">  161</span><span class="comment">! 4. OTHER FORCING (INPUT) DATA (I):</span></div>
<div class="line"><a id="l00162" name="l00162"></a><span class="lineno">  162</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00163" name="l00163"></a><span class="lineno">  163</span><span class="comment">!   SFCSPD     WIND SPEED (M S-1) AT HEIGHT ZLVL ABOVE GROUND</span></div>
<div class="line"><a id="l00164" name="l00164"></a><span class="lineno">  164</span><span class="comment">!   Q2SAT      SAT SPECIFIC HUMIDITY AT HEIGHT ZLVL ABOVE GROUND (KG KG-1)</span></div>
<div class="line"><a id="l00165" name="l00165"></a><span class="lineno">  165</span><span class="comment">!   DQSDT2     SLOPE OF SAT SPECIFIC HUMIDITY CURVE AT T=SFCTMP</span></div>
<div class="line"><a id="l00166" name="l00166"></a><span class="lineno">  166</span><span class="comment">!                (KG KG-1 K-1)</span></div>
<div class="line"><a id="l00167" name="l00167"></a><span class="lineno">  167</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00168" name="l00168"></a><span class="lineno">  168</span><span class="comment">! 5. CANOPY/SOIL CHARACTERISTICS (S):</span></div>
<div class="line"><a id="l00169" name="l00169"></a><span class="lineno">  169</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00170" name="l00170"></a><span class="lineno">  170</span><span class="comment">!   VEGTYP     VEGETATION TYPE (INTEGER INDEX)</span></div>
<div class="line"><a id="l00171" name="l00171"></a><span class="lineno">  171</span><span class="comment">!   SOILTYP    SOIL TYPE (INTEGER INDEX)</span></div>
<div class="line"><a id="l00172" name="l00172"></a><span class="lineno">  172</span><span class="comment">!   SLOPETYP   CLASS OF SFC SLOPE (INTEGER INDEX)</span></div>
<div class="line"><a id="l00173" name="l00173"></a><span class="lineno">  173</span><span class="comment">!   SHDFAC     AREAL FRACTIONAL COVERAGE OF GREEN VEGETATION</span></div>
<div class="line"><a id="l00174" name="l00174"></a><span class="lineno">  174</span><span class="comment">!                (FRACTION= 0.0-1.0)</span></div>
<div class="line"><a id="l00175" name="l00175"></a><span class="lineno">  175</span><span class="comment">!   SHDMIN     MINIMUM AREAL FRACTIONAL COVERAGE OF GREEN VEGETATION</span></div>
<div class="line"><a id="l00176" name="l00176"></a><span class="lineno">  176</span><span class="comment">!                (FRACTION= 0.0-1.0) &lt;= SHDFAC</span></div>
<div class="line"><a id="l00177" name="l00177"></a><span class="lineno">  177</span><span class="comment">!   PTU        PHOTO THERMAL UNIT (PLANT PHENOLOGY FOR ANNUALS/CROPS)</span></div>
<div class="line"><a id="l00178" name="l00178"></a><span class="lineno">  178</span><span class="comment">!                (NOT YET USED, BUT PASSED TO REDPRM FOR FUTURE USE IN</span></div>
<div class="line"><a id="l00179" name="l00179"></a><span class="lineno">  179</span><span class="comment">!                VEG PARMS)</span></div>
<div class="line"><a id="l00180" name="l00180"></a><span class="lineno">  180</span><span class="comment">!   ALB        BACKROUND SNOW-FREE SURFACE ALBEDO (FRACTION), FOR JULIAN</span></div>
<div class="line"><a id="l00181" name="l00181"></a><span class="lineno">  181</span><span class="comment">!                DAY OF YEAR (USUALLY FROM TEMPORAL INTERPOLATION OF</span></div>
<div class="line"><a id="l00182" name="l00182"></a><span class="lineno">  182</span><span class="comment">!                MONTHLY MEAN VALUES&#39; CALLING PROG MAY OR MAY NOT</span></div>
<div class="line"><a id="l00183" name="l00183"></a><span class="lineno">  183</span><span class="comment">!                INCLUDE DIURNAL SUN ANGLE EFFECT)</span></div>
<div class="line"><a id="l00184" name="l00184"></a><span class="lineno">  184</span><span class="comment">!   SNOALB     UPPER BOUND ON MAXIMUM ALBEDO OVER DEEP SNOW (E.G. FROM</span></div>
<div class="line"><a id="l00185" name="l00185"></a><span class="lineno">  185</span><span class="comment">!                ROBINSON AND KUKLA, 1985, J. CLIM. &amp; APPL. METEOR.)</span></div>
<div class="line"><a id="l00186" name="l00186"></a><span class="lineno">  186</span><span class="comment">!   TBOT       BOTTOM SOIL TEMPERATURE (LOCAL YEARLY-MEAN SFC AIR</span></div>
<div class="line"><a id="l00187" name="l00187"></a><span class="lineno">  187</span><span class="comment">!                TEMPERATURE)</span></div>
<div class="line"><a id="l00188" name="l00188"></a><span class="lineno">  188</span><span class="comment">!   Z0BRD      Background fixed roughness length (M)</span></div>
<div class="line"><a id="l00189" name="l00189"></a><span class="lineno">  189</span><span class="comment">!   Z0         Time varying roughness length (M) as function of snow depth</span></div>
<div class="line"><a id="l00190" name="l00190"></a><span class="lineno">  190</span><span class="comment">!</span></div>
<div class="line"><a id="l00191" name="l00191"></a><span class="lineno">  191</span><span class="comment">!   EMBRD      Background surface emissivity (between 0 and 1)</span></div>
<div class="line"><a id="l00192" name="l00192"></a><span class="lineno">  192</span><span class="comment">!   EMISSI     Surface emissivity (between 0 and 1)</span></div>
<div class="line"><a id="l00193" name="l00193"></a><span class="lineno">  193</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00194" name="l00194"></a><span class="lineno">  194</span><span class="comment">! 6. HISTORY (STATE) VARIABLES (H):</span></div>
<div class="line"><a id="l00195" name="l00195"></a><span class="lineno">  195</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00196" name="l00196"></a><span class="lineno">  196</span><span class="comment">!  CMC         CANOPY MOISTURE CONTENT (M)</span></div>
<div class="line"><a id="l00197" name="l00197"></a><span class="lineno">  197</span><span class="comment">!  T1          GROUND/CANOPY/SNOWPACK) EFFECTIVE SKIN TEMPERATURE (K)</span></div>
<div class="line"><a id="l00198" name="l00198"></a><span class="lineno">  198</span><span class="comment">!  STC(NSOIL)  SOIL TEMP (K)</span></div>
<div class="line"><a id="l00199" name="l00199"></a><span class="lineno">  199</span><span class="comment">!  SMC(NSOIL)  TOTAL SOIL MOISTURE CONTENT (VOLUMETRIC FRACTION)</span></div>
<div class="line"><a id="l00200" name="l00200"></a><span class="lineno">  200</span><span class="comment">!  SH2O(NSOIL) UNFROZEN SOIL MOISTURE CONTENT (VOLUMETRIC FRACTION)</span></div>
<div class="line"><a id="l00201" name="l00201"></a><span class="lineno">  201</span><span class="comment">!                NOTE: FROZEN SOIL MOISTURE = SMC - SH2O</span></div>
<div class="line"><a id="l00202" name="l00202"></a><span class="lineno">  202</span><span class="comment">!  SNOWH       ACTUAL SNOW DEPTH (M)</span></div>
<div class="line"><a id="l00203" name="l00203"></a><span class="lineno">  203</span><span class="comment">!  SNEQV       LIQUID WATER-EQUIVALENT SNOW DEPTH (M)</span></div>
<div class="line"><a id="l00204" name="l00204"></a><span class="lineno">  204</span><span class="comment">!                NOTE: SNOW DENSITY = SNEQV/SNOWH</span></div>
<div class="line"><a id="l00205" name="l00205"></a><span class="lineno">  205</span><span class="comment">!  ALBEDO      SURFACE ALBEDO INCLUDING SNOW EFFECT (UNITLESS FRACTION)</span></div>
<div class="line"><a id="l00206" name="l00206"></a><span class="lineno">  206</span><span class="comment">!                =SNOW-FREE ALBEDO (ALB) WHEN SNEQV=0, OR</span></div>
<div class="line"><a id="l00207" name="l00207"></a><span class="lineno">  207</span><span class="comment">!                =FCT(MSNOALB,ALB,VEGTYP,SHDFAC,SHDMIN) WHEN SNEQV&gt;0</span></div>
<div class="line"><a id="l00208" name="l00208"></a><span class="lineno">  208</span><span class="comment">!  CH          SURFACE EXCHANGE COEFFICIENT FOR HEAT AND MOISTURE</span></div>
<div class="line"><a id="l00209" name="l00209"></a><span class="lineno">  209</span><span class="comment">!                (M S-1); NOTE: CH IS TECHNICALLY A CONDUCTANCE SINCE</span></div>
<div class="line"><a id="l00210" name="l00210"></a><span class="lineno">  210</span><span class="comment">!                IT HAS BEEN MULTIPLIED BY WIND SPEED.</span></div>
<div class="line"><a id="l00211" name="l00211"></a><span class="lineno">  211</span><span class="comment">!  CM          SURFACE EXCHANGE COEFFICIENT FOR MOMENTUM (M S-1); NOTE:</span></div>
<div class="line"><a id="l00212" name="l00212"></a><span class="lineno">  212</span><span class="comment">!                CM IS TECHNICALLY A CONDUCTANCE SINCE IT HAS BEEN</span></div>
<div class="line"><a id="l00213" name="l00213"></a><span class="lineno">  213</span><span class="comment">!                MULTIPLIED BY WIND SPEED.</span></div>
<div class="line"><a id="l00214" name="l00214"></a><span class="lineno">  214</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00215" name="l00215"></a><span class="lineno">  215</span><span class="comment">! 7. OUTPUT (O):</span></div>
<div class="line"><a id="l00216" name="l00216"></a><span class="lineno">  216</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00217" name="l00217"></a><span class="lineno">  217</span><span class="comment">! OUTPUT VARIABLES NECESSARY FOR A COUPLED NUMERICAL WEATHER PREDICTION</span></div>
<div class="line"><a id="l00218" name="l00218"></a><span class="lineno">  218</span><span class="comment">! MODEL, E.G. NOAA/NWS/NCEP MESOSCALE ETA MODEL.  FOR THIS APPLICATION,</span></div>
<div class="line"><a id="l00219" name="l00219"></a><span class="lineno">  219</span><span class="comment">! THE REMAINING OUTPUT/DIAGNOSTIC/PARAMETER BLOCKS BELOW ARE NOT</span></div>
<div class="line"><a id="l00220" name="l00220"></a><span class="lineno">  220</span><span class="comment">! NECESSARY.  OTHER APPLICATIONS MAY REQUIRE DIFFERENT OUTPUT VARIABLES.</span></div>
<div class="line"><a id="l00221" name="l00221"></a><span class="lineno">  221</span><span class="comment">!   ETA        ACTUAL LATENT HEAT FLUX (W m-2: NEGATIVE, IF UP FROM</span></div>
<div class="line"><a id="l00222" name="l00222"></a><span class="lineno">  222</span><span class="comment">!              SURFACE)</span></div>
<div class="line"><a id="l00223" name="l00223"></a><span class="lineno">  223</span><span class="comment">!  ETA_KINEMATIC atctual latent heat flux in Kg m-2 s-1</span></div>
<div class="line"><a id="l00224" name="l00224"></a><span class="lineno">  224</span><span class="comment">!   SHEAT      SENSIBLE HEAT FLUX (W M-2: POSITIVE, IF UPWARD FROM</span></div>
<div class="line"><a id="l00225" name="l00225"></a><span class="lineno">  225</span><span class="comment">!              SURFACE)</span></div>
<div class="line"><a id="l00226" name="l00226"></a><span class="lineno">  226</span><span class="comment">!   FDOWN      Radiation forcing at the surface (W m-2) = SOLDN*(1-alb)+LWDN</span></div>
<div class="line"><a id="l00227" name="l00227"></a><span class="lineno">  227</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00228" name="l00228"></a><span class="lineno">  228</span><span class="comment">!   EC         CANOPY WATER EVAPORATION (W m-2)</span></div>
<div class="line"><a id="l00229" name="l00229"></a><span class="lineno">  229</span><span class="comment">!   EDIR       DIRECT SOIL EVAPORATION (W m-2)</span></div>
<div class="line"><a id="l00230" name="l00230"></a><span class="lineno">  230</span><span class="comment">!   ET(NSOIL)  PLANT TRANSPIRATION FROM A PARTICULAR ROOT (SOIL) LAYER</span></div>
<div class="line"><a id="l00231" name="l00231"></a><span class="lineno">  231</span><span class="comment">!                 (W m-2)</span></div>
<div class="line"><a id="l00232" name="l00232"></a><span class="lineno">  232</span><span class="comment">!   ETT        TOTAL PLANT TRANSPIRATION (W m-2)</span></div>
<div class="line"><a id="l00233" name="l00233"></a><span class="lineno">  233</span><span class="comment">!   ESNOW      SUBLIMATION FROM (OR DEPOSITION TO IF &lt;0) SNOWPACK</span></div>
<div class="line"><a id="l00234" name="l00234"></a><span class="lineno">  234</span><span class="comment">!                (W m-2)</span></div>
<div class="line"><a id="l00235" name="l00235"></a><span class="lineno">  235</span><span class="comment">!   DRIP       THROUGH-FALL OF PRECIP AND/OR DEW IN EXCESS OF CANOPY</span></div>
<div class="line"><a id="l00236" name="l00236"></a><span class="lineno">  236</span><span class="comment">!                WATER-HOLDING CAPACITY (M)</span></div>
<div class="line"><a id="l00237" name="l00237"></a><span class="lineno">  237</span><span class="comment">!   DEW        DEWFALL (OR FROSTFALL FOR T&lt;273.15) (M)</span></div>
<div class="line"><a id="l00238" name="l00238"></a><span class="lineno">  238</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00239" name="l00239"></a><span class="lineno">  239</span><span class="comment">!   BETA       RATIO OF ACTUAL/POTENTIAL EVAP (DIMENSIONLESS)</span></div>
<div class="line"><a id="l00240" name="l00240"></a><span class="lineno">  240</span><span class="comment">!   ETP        POTENTIAL EVAPORATION (W m-2)</span></div>
<div class="line"><a id="l00241" name="l00241"></a><span class="lineno">  241</span><span class="comment">!   SSOIL      SOIL HEAT FLUX (W M-2: NEGATIVE IF DOWNWARD FROM SURFACE)</span></div>
<div class="line"><a id="l00242" name="l00242"></a><span class="lineno">  242</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00243" name="l00243"></a><span class="lineno">  243</span><span class="comment">!   FLX1       PRECIP-SNOW SFC (W M-2)</span></div>
<div class="line"><a id="l00244" name="l00244"></a><span class="lineno">  244</span><span class="comment">!   FLX2       FREEZING RAIN LATENT HEAT FLUX (W M-2)</span></div>
<div class="line"><a id="l00245" name="l00245"></a><span class="lineno">  245</span><span class="comment">!   FLX3       PHASE-CHANGE HEAT FLUX FROM SNOWMELT (W M-2)</span></div>
<div class="line"><a id="l00246" name="l00246"></a><span class="lineno">  246</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00247" name="l00247"></a><span class="lineno">  247</span><span class="comment">!   SNOMLT     SNOW MELT (M) (WATER EQUIVALENT)</span></div>
<div class="line"><a id="l00248" name="l00248"></a><span class="lineno">  248</span><span class="comment">!   SNCOVR     FRACTIONAL SNOW COVER (UNITLESS FRACTION, 0-1)</span></div>
<div class="line"><a id="l00249" name="l00249"></a><span class="lineno">  249</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00250" name="l00250"></a><span class="lineno">  250</span><span class="comment">!   RUNOFF1    SURFACE RUNOFF (M S-1), NOT INFILTRATING THE SURFACE</span></div>
<div class="line"><a id="l00251" name="l00251"></a><span class="lineno">  251</span><span class="comment">!   RUNOFF2    SUBSURFACE RUNOFF (M S-1), DRAINAGE OUT BOTTOM OF LAST</span></div>
<div class="line"><a id="l00252" name="l00252"></a><span class="lineno">  252</span><span class="comment">!                SOIL LAYER (BASEFLOW)</span></div>
<div class="line"><a id="l00253" name="l00253"></a><span class="lineno">  253</span><span class="comment">!   RUNOFF3    NUMERICAL TRUNCTATION IN EXCESS OF POROSITY (SMCMAX)</span></div>
<div class="line"><a id="l00254" name="l00254"></a><span class="lineno">  254</span><span class="comment">!                FOR A GIVEN SOIL LAYER AT THE END OF A TIME STEP (M S-1).</span></div>
<div class="line"><a id="l00255" name="l00255"></a><span class="lineno">  255</span><span class="comment">! Note: the above RUNOFF2 is actually the sum of RUNOFF2 and RUNOFF3</span></div>
<div class="line"><a id="l00256" name="l00256"></a><span class="lineno">  256</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00257" name="l00257"></a><span class="lineno">  257</span><span class="comment">!   RC         CANOPY RESISTANCE (S M-1)</span></div>
<div class="line"><a id="l00258" name="l00258"></a><span class="lineno">  258</span><span class="comment">!   PC         PLANT COEFFICIENT (UNITLESS FRACTION, 0-1) WHERE PC*ETP</span></div>
<div class="line"><a id="l00259" name="l00259"></a><span class="lineno">  259</span><span class="comment">!                = ACTUAL TRANSP</span></div>
<div class="line"><a id="l00260" name="l00260"></a><span class="lineno">  260</span><span class="comment">!   XLAI       LEAF AREA INDEX (DIMENSIONLESS)</span></div>
<div class="line"><a id="l00261" name="l00261"></a><span class="lineno">  261</span><span class="comment">!   RSMIN      MINIMUM CANOPY RESISTANCE (S M-1)</span></div>
<div class="line"><a id="l00262" name="l00262"></a><span class="lineno">  262</span><span class="comment">!   RCS        INCOMING SOLAR RC FACTOR (DIMENSIONLESS)</span></div>
<div class="line"><a id="l00263" name="l00263"></a><span class="lineno">  263</span><span class="comment">!   RCT        AIR TEMPERATURE RC FACTOR (DIMENSIONLESS)</span></div>
<div class="line"><a id="l00264" name="l00264"></a><span class="lineno">  264</span><span class="comment">!   RCQ        ATMOS VAPOR PRESSURE DEFICIT RC FACTOR (DIMENSIONLESS)</span></div>
<div class="line"><a id="l00265" name="l00265"></a><span class="lineno">  265</span><span class="comment">!   RCSOIL     SOIL MOISTURE RC FACTOR (DIMENSIONLESS)</span></div>
<div class="line"><a id="l00266" name="l00266"></a><span class="lineno">  266</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00267" name="l00267"></a><span class="lineno">  267</span><span class="comment">! 8. DIAGNOSTIC OUTPUT (D):</span></div>
<div class="line"><a id="l00268" name="l00268"></a><span class="lineno">  268</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00269" name="l00269"></a><span class="lineno">  269</span><span class="comment">!   SOILW      AVAILABLE SOIL MOISTURE IN ROOT ZONE (UNITLESS FRACTION</span></div>
<div class="line"><a id="l00270" name="l00270"></a><span class="lineno">  270</span><span class="comment">!              BETWEEN SMCWLT AND SMCMAX)</span></div>
<div class="line"><a id="l00271" name="l00271"></a><span class="lineno">  271</span><span class="comment">!   SOILM      TOTAL SOIL COLUMN MOISTURE CONTENT (FROZEN+UNFROZEN) (M)</span></div>
<div class="line"><a id="l00272" name="l00272"></a><span class="lineno">  272</span><span class="comment">!   Q1         Effective mixing ratio at surface (kg kg-1), used for</span></div>
<div class="line"><a id="l00273" name="l00273"></a><span class="lineno">  273</span><span class="comment">!              diagnosing the mixing ratio at 2 meter for coupled model</span></div>
<div class="line"><a id="l00274" name="l00274"></a><span class="lineno">  274</span><span class="comment">!   SMAV       Soil Moisture Availability for each layer, as a fraction</span></div>
<div class="line"><a id="l00275" name="l00275"></a><span class="lineno">  275</span><span class="comment">!              between SMCWLT and SMCMAX.</span></div>
<div class="line"><a id="l00276" name="l00276"></a><span class="lineno">  276</span><span class="comment">!  Documentation for SNOTIME1 and SNOABL2 ?????</span></div>
<div class="line"><a id="l00277" name="l00277"></a><span class="lineno">  277</span><span class="comment">!  What categories of arguments do these variables fall into ????</span></div>
<div class="line"><a id="l00278" name="l00278"></a><span class="lineno">  278</span><span class="comment">!  Documentation for RIBB ?????</span></div>
<div class="line"><a id="l00279" name="l00279"></a><span class="lineno">  279</span><span class="comment">!  What category of argument does RIBB fall into ?????</span></div>
<div class="line"><a id="l00280" name="l00280"></a><span class="lineno">  280</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00281" name="l00281"></a><span class="lineno">  281</span><span class="comment">! 9. PARAMETERS (P):</span></div>
<div class="line"><a id="l00282" name="l00282"></a><span class="lineno">  282</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00283" name="l00283"></a><span class="lineno">  283</span><span class="comment">!   SMCWLT     WILTING POINT (VOLUMETRIC)</span></div>
<div class="line"><a id="l00284" name="l00284"></a><span class="lineno">  284</span><span class="comment">!   SMCDRY     DRY SOIL MOISTURE THRESHOLD WHERE DIRECT EVAP FRM TOP</span></div>
<div class="line"><a id="l00285" name="l00285"></a><span class="lineno">  285</span><span class="comment">!                LAYER ENDS (VOLUMETRIC)</span></div>
<div class="line"><a id="l00286" name="l00286"></a><span class="lineno">  286</span><span class="comment">!   SMCREF     SOIL MOISTURE THRESHOLD WHERE TRANSPIRATION BEGINS TO</span></div>
<div class="line"><a id="l00287" name="l00287"></a><span class="lineno">  287</span><span class="comment">!                STRESS (VOLUMETRIC)</span></div>
<div class="line"><a id="l00288" name="l00288"></a><span class="lineno">  288</span><span class="comment">!   SMCMAX     POROSITY, I.E. SATURATED VALUE OF SOIL MOISTURE</span></div>
<div class="line"><a id="l00289" name="l00289"></a><span class="lineno">  289</span><span class="comment">!                (VOLUMETRIC)</span></div>
<div class="line"><a id="l00290" name="l00290"></a><span class="lineno">  290</span><span class="comment">!   NROOT      NUMBER OF ROOT LAYERS, A FUNCTION OF VEG TYPE, DETERMINED</span></div>
<div class="line"><a id="l00291" name="l00291"></a><span class="lineno">  291</span><span class="comment">!              IN SUBROUTINE REDPRM.</span></div>
<div class="line"><a id="l00292" name="l00292"></a><span class="lineno">  292</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00293" name="l00293"></a><span class="lineno">  293</span> </div>
<div class="line"><a id="l00294" name="l00294"></a><span class="lineno">  294</span> </div>
<div class="line"><a id="l00295" name="l00295"></a><span class="lineno">  295</span>      <span class="keywordtype">IMPLICIT NONE</span></div>
<div class="line"><a id="l00296" name="l00296"></a><span class="lineno">  296</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00297" name="l00297"></a><span class="lineno">  297</span> </div>
<div class="line"><a id="l00298" name="l00298"></a><span class="lineno">  298</span><span class="comment">! DECLARATIONS - LOGICAL AND CHARACTERS</span></div>
<div class="line"><a id="l00299" name="l00299"></a><span class="lineno">  299</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00300" name="l00300"></a><span class="lineno">  300</span> </div>
<div class="line"><a id="l00301" name="l00301"></a><span class="lineno">  301</span>      <span class="keywordtype">INTEGER</span>, <span class="keywordtype">INTENT(IN)</span> :: IILOC, JJLOC</div>
<div class="line"><a id="l00302" name="l00302"></a><span class="lineno">  302</span>      <span class="keywordtype">LOGICAL</span>, <span class="keywordtype">INTENT(IN)</span>::  LOCAL</div>
<div class="line"><a id="l00303" name="l00303"></a><span class="lineno">  303</span>      <span class="keywordtype">LOGICAL</span>            ::  FRZGRA, SNOWNG</div>
<div class="line"><a id="l00304" name="l00304"></a><span class="lineno">  304</span>      <span class="keywordtype">CHARACTER (LEN=256)</span>, <span class="keywordtype">INTENT(IN)</span>::  LLANDUSE, LSOIL</div>
<div class="line"><a id="l00305" name="l00305"></a><span class="lineno">  305</span> </div>
<div class="line"><a id="l00306" name="l00306"></a><span class="lineno">  306</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00307" name="l00307"></a><span class="lineno">  307</span><span class="comment">! 1. CONFIGURATION INFORMATION (C):</span></div>
<div class="line"><a id="l00308" name="l00308"></a><span class="lineno">  308</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00309" name="l00309"></a><span class="lineno">  309</span>      <span class="keywordtype">INTEGER</span>,<span class="keywordtype">INTENT(IN)</span> ::  NSOIL,SLOPETYP,SOILTYP,VEGTYP</div>
<div class="line"><a id="l00310" name="l00310"></a><span class="lineno">  310</span>      <span class="keywordtype">INTEGER</span>, <span class="keywordtype">INTENT(IN)</span> :: ISURBAN</div>
<div class="line"><a id="l00311" name="l00311"></a><span class="lineno">  311</span>      <span class="keywordtype">INTEGER</span>,<span class="keywordtype">INTENT(OUT)</span>::  NROOT</div>
<div class="line"><a id="l00312" name="l00312"></a><span class="lineno">  312</span>      <span class="keywordtype">INTEGER</span>  KZ, K, iout</div>
<div class="line"><a id="l00313" name="l00313"></a><span class="lineno">  313</span> </div>
<div class="line"><a id="l00314" name="l00314"></a><span class="lineno">  314</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00315" name="l00315"></a><span class="lineno">  315</span><span class="comment">! 2. LOGICAL:</span></div>
<div class="line"><a id="l00316" name="l00316"></a><span class="lineno">  316</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00317" name="l00317"></a><span class="lineno">  317</span>      <span class="keywordtype">LOGICAL</span>, <span class="keywordtype">INTENT(IN)</span> :: RDLAI2D</div>
<div class="line"><a id="l00318" name="l00318"></a><span class="lineno">  318</span>      <span class="keywordtype">LOGICAL</span>, <span class="keywordtype">INTENT(IN)</span> :: USEMONALB</div>
<div class="line"><a id="l00319" name="l00319"></a><span class="lineno">  319</span>      <span class="keywordtype">INTEGER</span>, <span class="keywordtype">INTENT(IN)</span> :: OPT_THCND</div>
<div class="line"><a id="l00320" name="l00320"></a><span class="lineno">  320</span> </div>
<div class="line"><a id="l00321" name="l00321"></a><span class="lineno">  321</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(INOUT)</span>:: SFHEAD1RT,INFXS1RT, ETPND1</div>
<div class="line"><a id="l00322" name="l00322"></a><span class="lineno">  322</span> </div>
<div class="line"><a id="l00323" name="l00323"></a><span class="lineno">  323</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(IN)</span>   :: SHDMIN,SHDMAX,DT,DQSDT2,LWDN,PRCP,PRCPRAIN,     &amp;</div>
<div class="line"><a id="l00324" name="l00324"></a><span class="lineno">  324</span>                            Q2,Q2SAT,SFCPRS,SFCSPD,SFCTMP, SNOALB,          &amp;</div>
<div class="line"><a id="l00325" name="l00325"></a><span class="lineno">  325</span>                            SOLDN,SOLNET,TBOT,TH2,ZLVL,                     &amp;</div>
<div class="line"><a id="l00326" name="l00326"></a><span class="lineno">  326</span>                            FFROZP,AOASIS</div>
<div class="line"><a id="l00327" name="l00327"></a><span class="lineno">  327</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(OUT)</span>  :: EMBRD</div>
<div class="line"><a id="l00328" name="l00328"></a><span class="lineno">  328</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(OUT)</span>  :: ALBEDO</div>
<div class="line"><a id="l00329" name="l00329"></a><span class="lineno">  329</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(INOUT)</span>:: COSZ, SOLARDIRECT,CH,CM,                        &amp;</div>
<div class="line"><a id="l00330" name="l00330"></a><span class="lineno">  330</span>                            CMC,SNEQV,SNCOVR,SNOWH,T1,XLAI,SHDFAC,Z0BRD,    &amp;</div>
<div class="line"><a id="l00331" name="l00331"></a><span class="lineno">  331</span>                            EMISSI, ALB</div>
<div class="line"><a id="l00332" name="l00332"></a><span class="lineno">  332</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(INOUT)</span>:: SNOTIME1</div>
<div class="line"><a id="l00333" name="l00333"></a><span class="lineno">  333</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(INOUT)</span>:: RIBB</div>
<div class="line"><a id="l00334" name="l00334"></a><span class="lineno">  334</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(IN)</span> :: SLDPTH</div>
<div class="line"><a id="l00335" name="l00335"></a><span class="lineno">  335</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(OUT)</span>:: ET</div>
<div class="line"><a id="l00336" name="l00336"></a><span class="lineno">  336</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(OUT)</span>:: SMAV</div>
<div class="line"><a id="l00337" name="l00337"></a><span class="lineno">  337</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(INOUT)</span> ::  SH2O, SMC, STC</div>
<div class="line"><a id="l00338" name="l00338"></a><span class="lineno">  338</span><span class="keywordtype">      REAL</span>,<span class="keywordtype">DIMENSION(1:NSOIL)</span>::   RTDIS, ZSOIL</div>
<div class="line"><a id="l00339" name="l00339"></a><span class="lineno">  339</span> </div>
<div class="line"><a id="l00340" name="l00340"></a><span class="lineno">  340</span><span class="keywordtype">      REAL</span>,<span class="keywordtype">INTENT(OUT)</span>   :: ETA_KINEMATIC,BETA,DEW,DRIP,EC,EDIR,ESNOW,ETA,  &amp;</div>
<div class="line"><a id="l00341" name="l00341"></a><span class="lineno">  341</span>                            ETP,FLX1,FLX2,FLX3,SHEAT,PC,RUNOFF1,RUNOFF2,    &amp;</div>
<div class="line"><a id="l00342" name="l00342"></a><span class="lineno">  342</span>                            RUNOFF3,RC,RSMIN,RCQ,RCS,RCSOIL,RCT,SSOIL,      &amp;</div>
<div class="line"><a id="l00343" name="l00343"></a><span class="lineno">  343</span>                            SMCDRY,SMCMAX,SMCREF,SMCWLT,SNOMLT, SOILM,      &amp;</div>
<div class="line"><a id="l00344" name="l00344"></a><span class="lineno">  344</span>                            SOILW,FDOWN,Q1</div>
<div class="line"><a id="l00345" name="l00345"></a><span class="lineno">  345</span>      <span class="keywordtype">LOGICAL</span>, <span class="keywordtype">INTENT(IN)</span> :: UA_PHYS   <span class="comment">! UA: flag for UA option</span></div>
<div class="line"><a id="l00346" name="l00346"></a><span class="lineno">  346</span><span class="keywordtype">      REAL</span>,<span class="keywordtype">INTENT(OUT)</span>    :: FLX4      <span class="comment">! UA: energy added to sensible heat</span></div>
<div class="line"><a id="l00347" name="l00347"></a><span class="lineno">  347</span><span class="keywordtype">      REAL</span>,<span class="keywordtype">INTENT(OUT)</span>    :: FVB       <span class="comment">! UA: frac. veg. w/snow beneath</span></div>
<div class="line"><a id="l00348" name="l00348"></a><span class="lineno">  348</span><span class="keywordtype">      REAL</span>,<span class="keywordtype">INTENT(OUT)</span>    :: FBUR      <span class="comment">! UA: fraction of canopy buried</span></div>
<div class="line"><a id="l00349" name="l00349"></a><span class="lineno">  349</span><span class="keywordtype">      REAL</span>,<span class="keywordtype">INTENT(OUT)</span>    :: FGSN      <span class="comment">! UA: ground snow cover fraction</span></div>
<div class="line"><a id="l00350" name="l00350"></a><span class="lineno">  350</span><span class="keywordtype">      REAL</span>                :: ZTOPV     <span class="comment">! UA: height of canopy top</span></div>
<div class="line"><a id="l00351" name="l00351"></a><span class="lineno">  351</span><span class="keywordtype">      REAL</span>                :: ZBOTV     <span class="comment">! UA: height of canopy bottom</span></div>
<div class="line"><a id="l00352" name="l00352"></a><span class="lineno">  352</span><span class="keywordtype">      REAL</span>                :: GAMA      <span class="comment">! UA: = EXP(-1.* XLAI)</span></div>
<div class="line"><a id="l00353" name="l00353"></a><span class="lineno">  353</span><span class="keywordtype">      REAL</span>                :: FNET      <span class="comment">! UA:</span></div>
<div class="line"><a id="l00354" name="l00354"></a><span class="lineno">  354</span><span class="keywordtype">      REAL</span>                :: ETPN      <span class="comment">! UA:</span></div>
<div class="line"><a id="l00355" name="l00355"></a><span class="lineno">  355</span><span class="keywordtype">      REAL</span>                :: RU        <span class="comment">! UA:</span></div>
<div class="line"><a id="l00356" name="l00356"></a><span class="lineno">  356</span> </div>
<div class="line"><a id="l00357" name="l00357"></a><span class="lineno">  357</span><span class="keywordtype">      REAL</span> :: BEXP,CFACTR,CMCMAX,CSOIL,CZIL,DF1,DF1H,DF1A,DKSAT,DWSAT,      &amp;</div>
<div class="line"><a id="l00358" name="l00358"></a><span class="lineno">  358</span>              DSOIL,DTOT,ETT,FRCSNO,FRCSOI,EPSCA,F1,FXEXP,FRZX,HS,          &amp;</div>
<div class="line"><a id="l00359" name="l00359"></a><span class="lineno">  359</span>              KDT,LVH2O,PRCP1,PSISAT,QUARTZ,R,RCH,REFKDT,RR,RGL,            &amp;</div>
<div class="line"><a id="l00360" name="l00360"></a><span class="lineno">  360</span>              RSMAX,                                                        &amp;</div>
<div class="line"><a id="l00361" name="l00361"></a><span class="lineno">  361</span>              RSNOW,SNDENS,SNCOND,SBETA,SN_NEW,SLOPE,SNUP,SALP,SOILWM,      &amp;</div>
<div class="line"><a id="l00362" name="l00362"></a><span class="lineno">  362</span>              SOILWW,T1V,T24,T2V,TH2V,TOPT,TFREEZ,TSNOW,ZBOT,Z0,PRCPF,      &amp;</div>
<div class="line"><a id="l00363" name="l00363"></a><span class="lineno">  363</span>              ETNS,PTU,LSUBS</div>
<div class="line"><a id="l00364" name="l00364"></a><span class="lineno">  364</span><span class="keywordtype">        REAL</span> ::  LVCOEF</div>
<div class="line"><a id="l00365" name="l00365"></a><span class="lineno">  365</span><span class="keywordtype">      REAL</span> :: INTERP_FRACTION</div>
<div class="line"><a id="l00366" name="l00366"></a><span class="lineno">  366</span><span class="keywordtype">      REAL</span> :: LAIMIN,    LAIMAX</div>
<div class="line"><a id="l00367" name="l00367"></a><span class="lineno">  367</span><span class="keywordtype">      REAL</span> :: ALBEDOMIN, ALBEDOMAX</div>
<div class="line"><a id="l00368" name="l00368"></a><span class="lineno">  368</span><span class="keywordtype">      REAL</span> :: EMISSMIN,  EMISSMAX</div>
<div class="line"><a id="l00369" name="l00369"></a><span class="lineno">  369</span><span class="keywordtype">      REAL</span> :: Z0MIN,     Z0MAX</div>
<div class="line"><a id="l00370" name="l00370"></a><span class="lineno">  370</span> </div>
<div class="line"><a id="l00371" name="l00371"></a><span class="lineno">  371</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00372" name="l00372"></a><span class="lineno">  372</span><span class="comment">! DECLARATIONS - PARAMETERS</span></div>
<div class="line"><a id="l00373" name="l00373"></a><span class="lineno">  373</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00374" name="l00374"></a><span class="lineno">  374</span>      parameter(tfreez = 273.15)</div>
<div class="line"><a id="l00375" name="l00375"></a><span class="lineno">  375</span>      parameter(lvh2o = 2.501e+6)</div>
<div class="line"><a id="l00376" name="l00376"></a><span class="lineno">  376</span>      parameter(lsubs = 2.83e+6)</div>
<div class="line"><a id="l00377" name="l00377"></a><span class="lineno">  377</span>      parameter(r = 287.04)</div>
<div class="line"><a id="l00378" name="l00378"></a><span class="lineno">  378</span><span class="comment">!</span></div>
<div class="line"><a id="l00379" name="l00379"></a><span class="lineno">  379</span><span class="comment">!  FASDAS</span></div>
<div class="line"><a id="l00380" name="l00380"></a><span class="lineno">  380</span><span class="comment">!</span></div>
<div class="line"><a id="l00381" name="l00381"></a><span class="lineno">  381</span>   <span class="keywordtype">INTEGER</span>, <span class="keywordtype">INTENT(IN   )</span>  ::  fasdas</div>
<div class="line"><a id="l00382" name="l00382"></a><span class="lineno">  382</span><span class="keywordtype">   REAL</span>,    <span class="keywordtype">INTENT(INOUT)</span>  ::  XSDA_QFX, XQNORM</div>
<div class="line"><a id="l00383" name="l00383"></a><span class="lineno">  383</span><span class="keywordtype">   REAL</span>,    <span class="keywordtype">INTENT(INOUT)</span>  ::  HFX_PHY, QFX_PHY</div>
<div class="line"><a id="l00384" name="l00384"></a><span class="lineno">  384</span><span class="keywordtype">   REAL</span>,    <span class="keywordtype">INTENT(  OUT)</span>  ::  HCPCT_FASDAS</div>
<div class="line"><a id="l00385" name="l00385"></a><span class="lineno">  385</span><span class="comment">!</span></div>
<div class="line"><a id="l00386" name="l00386"></a><span class="lineno">  386</span><span class="comment">!  END FASDAS</span></div>
<div class="line"><a id="l00387" name="l00387"></a><span class="lineno">  387</span><span class="comment">!</span></div>
<div class="line"><a id="l00388" name="l00388"></a><span class="lineno">  388</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00389" name="l00389"></a><span class="lineno">  389</span><span class="comment">!   INITIALIZATION</span></div>
<div class="line"><a id="l00390" name="l00390"></a><span class="lineno">  390</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00391" name="l00391"></a><span class="lineno">  391</span>      iloc = iiloc</div>
<div class="line"><a id="l00392" name="l00392"></a><span class="lineno">  392</span>      jloc = jjloc</div>
<div class="line"><a id="l00393" name="l00393"></a><span class="lineno">  393</span> </div>
<div class="line"><a id="l00394" name="l00394"></a><span class="lineno">  394</span>      runoff1 = 0.0</div>
<div class="line"><a id="l00395" name="l00395"></a><span class="lineno">  395</span>      runoff2 = 0.0</div>
<div class="line"><a id="l00396" name="l00396"></a><span class="lineno">  396</span>      runoff3 = 0.0</div>
<div class="line"><a id="l00397" name="l00397"></a><span class="lineno">  397</span>      snomlt = 0.0</div>
<div class="line"><a id="l00398" name="l00398"></a><span class="lineno">  398</span> </div>
<div class="line"><a id="l00399" name="l00399"></a><span class="lineno">  399</span>      <span class="keywordflow">IF</span> ( .NOT. ua_phys ) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00400" name="l00400"></a><span class="lineno">  400</span>          flx4 = 0.0</div>
<div class="line"><a id="l00401" name="l00401"></a><span class="lineno">  401</span>          fvb  = 0.0</div>
<div class="line"><a id="l00402" name="l00402"></a><span class="lineno">  402</span>          fbur = 0.0</div>
<div class="line"><a id="l00403" name="l00403"></a><span class="lineno">  403</span>          fgsn = 0.0</div>
<div class="line"><a id="l00404" name="l00404"></a><span class="lineno">  404</span><span class="keywordflow">      ENDIF</span></div>
<div class="line"><a id="l00405" name="l00405"></a><span class="lineno">  405</span> </div>
<div class="line"><a id="l00406" name="l00406"></a><span class="lineno">  406</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00407" name="l00407"></a><span class="lineno">  407</span><span class="comment">! CALCULATE DEPTH (NEGATIVE) BELOW GROUND FROM TOP SKIN SFC TO BOTTOM OF</span></div>
<div class="line"><a id="l00408" name="l00408"></a><span class="lineno">  408</span><span class="comment">!   EACH SOIL LAYER.  NOTE:  SIGN OF ZSOIL IS NEGATIVE (DENOTING BELOW</span></div>
<div class="line"><a id="l00409" name="l00409"></a><span class="lineno">  409</span><span class="comment">!   GROUND)</span></div>
<div class="line"><a id="l00410" name="l00410"></a><span class="lineno">  410</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00411" name="l00411"></a><span class="lineno">  411</span>      zsoil(1) = - sldpth(1)</div>
<div class="line"><a id="l00412" name="l00412"></a><span class="lineno">  412</span>      <span class="keywordflow">DO</span> kz = 2,nsoil</div>
<div class="line"><a id="l00413" name="l00413"></a><span class="lineno">  413</span>         zsoil(kz) = - sldpth(kz) + zsoil(kz -1)</div>
<div class="line"><a id="l00414" name="l00414"></a><span class="lineno">  414</span><span class="keywordflow">      END DO</span></div>
<div class="line"><a id="l00415" name="l00415"></a><span class="lineno">  415</span> </div>
<div class="line"><a id="l00416" name="l00416"></a><span class="lineno">  416</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00417" name="l00417"></a><span class="lineno">  417</span><span class="comment">! NEXT IS CRUCIAL CALL TO SET THE LAND-SURFACE PARAMETERS, INCLUDING</span></div>
<div class="line"><a id="l00418" name="l00418"></a><span class="lineno">  418</span><span class="comment">! SOIL-TYPE AND VEG-TYPE DEPENDENT PARAMETERS.</span></div>
<div class="line"><a id="l00419" name="l00419"></a><span class="lineno">  419</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00420" name="l00420"></a><span class="lineno">  420</span>         <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a035da859804652a83bc5fd235e70b2e0">redprm</a> (vegtyp,soiltyp,slopetyp,cfactr,cmcmax,rsmax,topt,   &amp;</div>
<div class="line"><a id="l00421" name="l00421"></a><span class="lineno">  421</span>                       refkdt,kdt,sbeta, shdfac,rsmin,rgl,hs,zbot,frzx,    &amp;</div>
<div class="line"><a id="l00422" name="l00422"></a><span class="lineno">  422</span>                         psisat,slope,snup,salp,bexp,dksat,dwsat,          &amp;</div>
<div class="line"><a id="l00423" name="l00423"></a><span class="lineno">  423</span>                         smcmax,smcwlt,smcref,smcdry,f1,quartz,fxexp,      &amp;</div>
<div class="line"><a id="l00424" name="l00424"></a><span class="lineno">  424</span>                         rtdis,sldpth,zsoil,nroot,nsoil,czil,              &amp;</div>
<div class="line"><a id="l00425" name="l00425"></a><span class="lineno">  425</span>                         laimin, laimax, emissmin, emissmax, albedomin,    &amp;</div>
<div class="line"><a id="l00426" name="l00426"></a><span class="lineno">  426</span>                         albedomax, z0min, z0max, csoil, ptu, llanduse,    &amp;</div>
<div class="line"><a id="l00427" name="l00427"></a><span class="lineno">  427</span>                         lsoil,local,lvcoef,ztopv,zbotv)</div>
<div class="line"><a id="l00428" name="l00428"></a><span class="lineno">  428</span> </div>
<div class="line"><a id="l00429" name="l00429"></a><span class="lineno">  429</span><span class="comment">!urban</span></div>
<div class="line"><a id="l00430" name="l00430"></a><span class="lineno">  430</span>         <span class="keywordflow">IF</span>(vegtyp==isurban)<span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00431" name="l00431"></a><span class="lineno">  431</span>              shdfac=0.05</div>
<div class="line"><a id="l00432" name="l00432"></a><span class="lineno">  432</span>              rsmin=400.0</div>
<div class="line"><a id="l00433" name="l00433"></a><span class="lineno">  433</span>              smcmax = 0.45</div>
<div class="line"><a id="l00434" name="l00434"></a><span class="lineno">  434</span>              smcref = 0.42</div>
<div class="line"><a id="l00435" name="l00435"></a><span class="lineno">  435</span>              smcwlt = 0.40</div>
<div class="line"><a id="l00436" name="l00436"></a><span class="lineno">  436</span>              smcdry = 0.40</div>
<div class="line"><a id="l00437" name="l00437"></a><span class="lineno">  437</span><span class="keywordflow">         ENDIF</span></div>
<div class="line"><a id="l00438" name="l00438"></a><span class="lineno">  438</span> </div>
<div class="line"><a id="l00439" name="l00439"></a><span class="lineno">  439</span>         <span class="keywordflow">IF</span> ( shdfac &gt;= shdmax ) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00440" name="l00440"></a><span class="lineno">  440</span>            embrd = emissmax</div>
<div class="line"><a id="l00441" name="l00441"></a><span class="lineno">  441</span>            <span class="keywordflow">IF</span> (.NOT. rdlai2d) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00442" name="l00442"></a><span class="lineno">  442</span>               xlai  = laimax</div>
<div class="line"><a id="l00443" name="l00443"></a><span class="lineno">  443</span><span class="keywordflow">            ENDIF</span></div>
<div class="line"><a id="l00444" name="l00444"></a><span class="lineno">  444</span>            <span class="keywordflow">IF</span> (.NOT. usemonalb) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00445" name="l00445"></a><span class="lineno">  445</span>               alb   = albedomin</div>
<div class="line"><a id="l00446" name="l00446"></a><span class="lineno">  446</span><span class="keywordflow">            ENDIF</span></div>
<div class="line"><a id="l00447" name="l00447"></a><span class="lineno">  447</span>            z0brd = z0max</div>
<div class="line"><a id="l00448" name="l00448"></a><span class="lineno">  448</span>         <span class="keywordflow">ELSE</span> <span class="keywordflow">IF</span> ( shdfac &lt;= shdmin ) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00449" name="l00449"></a><span class="lineno">  449</span>            embrd = emissmin</div>
<div class="line"><a id="l00450" name="l00450"></a><span class="lineno">  450</span>            <span class="keywordflow">IF</span>(.NOT. rdlai2d) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00451" name="l00451"></a><span class="lineno">  451</span>               xlai  = laimin</div>
<div class="line"><a id="l00452" name="l00452"></a><span class="lineno">  452</span><span class="keywordflow">            ENDIF</span></div>
<div class="line"><a id="l00453" name="l00453"></a><span class="lineno">  453</span>            <span class="keywordflow">IF</span>(.NOT. usemonalb) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00454" name="l00454"></a><span class="lineno">  454</span>               alb   = albedomax</div>
<div class="line"><a id="l00455" name="l00455"></a><span class="lineno">  455</span><span class="keywordflow">            ENDIF</span></div>
<div class="line"><a id="l00456" name="l00456"></a><span class="lineno">  456</span>            z0brd = z0min</div>
<div class="line"><a id="l00457" name="l00457"></a><span class="lineno">  457</span>         <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l00458" name="l00458"></a><span class="lineno">  458</span> </div>
<div class="line"><a id="l00459" name="l00459"></a><span class="lineno">  459</span>            <span class="keywordflow">IF</span> ( shdmax &gt; shdmin ) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00460" name="l00460"></a><span class="lineno">  460</span> </div>
<div class="line"><a id="l00461" name="l00461"></a><span class="lineno">  461</span>               interp_fraction = ( shdfac - shdmin ) / ( shdmax - shdmin )</div>
<div class="line"><a id="l00462" name="l00462"></a><span class="lineno">  462</span>               <span class="comment">! Bound INTERP_FRACTION between 0 and 1</span></div>
<div class="line"><a id="l00463" name="l00463"></a><span class="lineno">  463</span>               interp_fraction = min( interp_fraction, 1.0 )</div>
<div class="line"><a id="l00464" name="l00464"></a><span class="lineno">  464</span>               interp_fraction = max( interp_fraction, 0.0 )</div>
<div class="line"><a id="l00465" name="l00465"></a><span class="lineno">  465</span>               <span class="comment">! Scale Emissivity and LAI between EMISSMIN and EMISSMAX by INTERP_FRACTION</span></div>
<div class="line"><a id="l00466" name="l00466"></a><span class="lineno">  466</span>               embrd = ( ( 1.0 - interp_fraction ) * emissmin  ) + ( interp_fraction * emissmax  )</div>
<div class="line"><a id="l00467" name="l00467"></a><span class="lineno">  467</span>               <span class="keywordflow">IF</span> (.NOT. rdlai2d) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00468" name="l00468"></a><span class="lineno">  468</span>                  xlai  = ( ( 1.0 - interp_fraction ) * laimin    ) + ( interp_fraction * laimax    )</div>
<div class="line"><a id="l00469" name="l00469"></a><span class="lineno">  469</span><span class="keywordflow">               ENDIF</span></div>
<div class="line"><a id="l00470" name="l00470"></a><span class="lineno">  470</span>               <span class="keywordflow">if</span> (.not. usemonalb) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00471" name="l00471"></a><span class="lineno">  471</span>                  alb   = ( ( 1.0 - interp_fraction ) * albedomax ) + ( interp_fraction * albedomin )</div>
<div class="line"><a id="l00472" name="l00472"></a><span class="lineno">  472</span><span class="keywordflow">               endif</span></div>
<div class="line"><a id="l00473" name="l00473"></a><span class="lineno">  473</span>               z0brd = ( ( 1.0 - interp_fraction ) * z0min     ) + ( interp_fraction * z0max     )</div>
<div class="line"><a id="l00474" name="l00474"></a><span class="lineno">  474</span> </div>
<div class="line"><a id="l00475" name="l00475"></a><span class="lineno">  475</span>            <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l00476" name="l00476"></a><span class="lineno">  476</span> </div>
<div class="line"><a id="l00477" name="l00477"></a><span class="lineno">  477</span>               embrd = 0.5 * emissmin  + 0.5 * emissmax</div>
<div class="line"><a id="l00478" name="l00478"></a><span class="lineno">  478</span>               <span class="keywordflow">IF</span> (.NOT. rdlai2d) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00479" name="l00479"></a><span class="lineno">  479</span>                  xlai  = 0.5 * laimin    + 0.5 * laimax</div>
<div class="line"><a id="l00480" name="l00480"></a><span class="lineno">  480</span><span class="keywordflow">               ENDIF</span></div>
<div class="line"><a id="l00481" name="l00481"></a><span class="lineno">  481</span>               <span class="keywordflow">if</span> (.not. usemonalb) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00482" name="l00482"></a><span class="lineno">  482</span>                  alb   = 0.5 * albedomin + 0.5 * albedomax</div>
<div class="line"><a id="l00483" name="l00483"></a><span class="lineno">  483</span><span class="keywordflow">               endif</span></div>
<div class="line"><a id="l00484" name="l00484"></a><span class="lineno">  484</span>               z0brd = 0.5 * z0min     + 0.5 * z0max</div>
<div class="line"><a id="l00485" name="l00485"></a><span class="lineno">  485</span> </div>
<div class="line"><a id="l00486" name="l00486"></a><span class="lineno">  486</span><span class="keywordflow">            ENDIF</span></div>
<div class="line"><a id="l00487" name="l00487"></a><span class="lineno">  487</span> </div>
<div class="line"><a id="l00488" name="l00488"></a><span class="lineno">  488</span><span class="keywordflow">         ENDIF</span></div>
<div class="line"><a id="l00489" name="l00489"></a><span class="lineno">  489</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00490" name="l00490"></a><span class="lineno">  490</span><span class="comment">!  INITIALIZE PRECIPITATION LOGICALS.</span></div>
<div class="line"><a id="l00491" name="l00491"></a><span class="lineno">  491</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00492" name="l00492"></a><span class="lineno">  492</span>         snowng = .false.</div>
<div class="line"><a id="l00493" name="l00493"></a><span class="lineno">  493</span>         frzgra = .false.</div>
<div class="line"><a id="l00494" name="l00494"></a><span class="lineno">  494</span> </div>
<div class="line"><a id="l00495" name="l00495"></a><span class="lineno">  495</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00496" name="l00496"></a><span class="lineno">  496</span><span class="comment">! IF INPUT SNOWPACK IS NONZERO, THEN COMPUTE SNOW DENSITY &quot;SNDENS&quot; AND</span></div>
<div class="line"><a id="l00497" name="l00497"></a><span class="lineno">  497</span><span class="comment">!   SNOW THERMAL CONDUCTIVITY &quot;SNCOND&quot; (NOTE THAT CSNOW IS A FUNCTION</span></div>
<div class="line"><a id="l00498" name="l00498"></a><span class="lineno">  498</span><span class="comment">!   SUBROUTINE)</span></div>
<div class="line"><a id="l00499" name="l00499"></a><span class="lineno">  499</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00500" name="l00500"></a><span class="lineno">  500</span>         <span class="keywordflow">IF</span> ( sneqv &lt;= 1.e-7 ) <span class="keywordflow">THEN</span> <span class="comment">! safer IF  kmh (2008/03/25)</span></div>
<div class="line"><a id="l00501" name="l00501"></a><span class="lineno">  501</span>            sneqv = 0.0</div>
<div class="line"><a id="l00502" name="l00502"></a><span class="lineno">  502</span>            sndens = 0.0</div>
<div class="line"><a id="l00503" name="l00503"></a><span class="lineno">  503</span>            snowh = 0.0</div>
<div class="line"><a id="l00504" name="l00504"></a><span class="lineno">  504</span>            sncond = 1.0</div>
<div class="line"><a id="l00505" name="l00505"></a><span class="lineno">  505</span>         <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l00506" name="l00506"></a><span class="lineno">  506</span>            sndens = sneqv / snowh</div>
<div class="line"><a id="l00507" name="l00507"></a><span class="lineno">  507</span>            <span class="keywordflow">IF</span>(sndens &gt; 1.0) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00508" name="l00508"></a><span class="lineno">  508</span>             fatal_error( <span class="stringliteral">&#39;Physical snow depth is less than snow water equiv.&#39;</span> )</div>
<div class="line"><a id="l00509" name="l00509"></a><span class="lineno">  509</span><span class="keywordflow">            ENDIF</span></div>
<div class="line"><a id="l00510" name="l00510"></a><span class="lineno">  510</span>            <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#abb6e84ee87a6fdb3281c33e8e8457a04">csnow</a> (sncond,sndens)</div>
<div class="line"><a id="l00511" name="l00511"></a><span class="lineno">  511</span><span class="keywordflow">         END IF</span></div>
<div class="line"><a id="l00512" name="l00512"></a><span class="lineno">  512</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00513" name="l00513"></a><span class="lineno">  513</span><span class="comment">! DETERMINE IF IT&#39;S PRECIPITATING AND WHAT KIND OF PRECIP IT IS.</span></div>
<div class="line"><a id="l00514" name="l00514"></a><span class="lineno">  514</span><span class="comment">! IF IT&#39;S PRCPING AND THE AIR TEMP IS COLDER THAN 0 C, IT&#39;S SNOWING!</span></div>
<div class="line"><a id="l00515" name="l00515"></a><span class="lineno">  515</span><span class="comment">! IF IT&#39;S PRCPING AND THE AIR TEMP IS WARMER THAN 0 C, BUT THE GRND</span></div>
<div class="line"><a id="l00516" name="l00516"></a><span class="lineno">  516</span><span class="comment">! TEMP IS COLDER THAN 0 C, FREEZING RAIN IS PRESUMED TO BE FALLING.</span></div>
<div class="line"><a id="l00517" name="l00517"></a><span class="lineno">  517</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00518" name="l00518"></a><span class="lineno">  518</span>         <span class="keywordflow">IF</span> (prcp &gt; 0.0) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00519" name="l00519"></a><span class="lineno">  519</span><span class="comment">! snow defined when fraction of frozen precip (FFROZP) &gt; 0.5,</span></div>
<div class="line"><a id="l00520" name="l00520"></a><span class="lineno">  520</span><span class="comment">! passed in from model microphysics.</span></div>
<div class="line"><a id="l00521" name="l00521"></a><span class="lineno">  521</span>            <span class="keywordflow">IF</span> (ffrozp .GT. 0.5) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00522" name="l00522"></a><span class="lineno">  522</span>               snowng = .true.</div>
<div class="line"><a id="l00523" name="l00523"></a><span class="lineno">  523</span>            <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l00524" name="l00524"></a><span class="lineno">  524</span>               <span class="keywordflow">IF</span> (t1 &lt;= tfreez) frzgra = .true.</div>
<div class="line"><a id="l00525" name="l00525"></a><span class="lineno">  525</span><span class="keywordflow">            END IF</span></div>
<div class="line"><a id="l00526" name="l00526"></a><span class="lineno">  526</span><span class="keywordflow">         END IF</span></div>
<div class="line"><a id="l00527" name="l00527"></a><span class="lineno">  527</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00528" name="l00528"></a><span class="lineno">  528</span><span class="comment">! IF EITHER PRCP FLAG IS SET, DETERMINE NEW SNOWFALL (CONVERTING PRCP</span></div>
<div class="line"><a id="l00529" name="l00529"></a><span class="lineno">  529</span><span class="comment">! RATE FROM KG M-2 S-1 TO A LIQUID EQUIV SNOW DEPTH IN METERS) AND ADD</span></div>
<div class="line"><a id="l00530" name="l00530"></a><span class="lineno">  530</span><span class="comment">! IT TO THE EXISTING SNOWPACK.</span></div>
<div class="line"><a id="l00531" name="l00531"></a><span class="lineno">  531</span><span class="comment">! NOTE THAT SINCE ALL PRECIP IS ADDED TO SNOWPACK, NO PRECIP INFILTRATES</span></div>
<div class="line"><a id="l00532" name="l00532"></a><span class="lineno">  532</span><span class="comment">! INTO THE SOIL SO THAT PRCP1 IS SET TO ZERO.</span></div>
<div class="line"><a id="l00533" name="l00533"></a><span class="lineno">  533</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00534" name="l00534"></a><span class="lineno">  534</span>         <span class="keywordflow">IF</span> ( (snowng) .OR. (frzgra) ) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00535" name="l00535"></a><span class="lineno">  535</span>            sn_new = prcp * dt * 0.001</div>
<div class="line"><a id="l00536" name="l00536"></a><span class="lineno">  536</span>            sneqv = sneqv + sn_new</div>
<div class="line"><a id="l00537" name="l00537"></a><span class="lineno">  537</span>            prcpf = 0.0</div>
<div class="line"><a id="l00538" name="l00538"></a><span class="lineno">  538</span> </div>
<div class="line"><a id="l00539" name="l00539"></a><span class="lineno">  539</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00540" name="l00540"></a><span class="lineno">  540</span><span class="comment">! UPDATE SNOW DENSITY BASED ON NEW SNOWFALL, USING OLD AND NEW SNOW.</span></div>
<div class="line"><a id="l00541" name="l00541"></a><span class="lineno">  541</span><span class="comment">! UPDATE SNOW THERMAL CONDUCTIVITY</span></div>
<div class="line"><a id="l00542" name="l00542"></a><span class="lineno">  542</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00543" name="l00543"></a><span class="lineno">  543</span>            <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ab7e465439f409557715a28bea71551c1">snow_new</a> (sfctmp,sn_new,snowh,sndens)</div>
<div class="line"><a id="l00544" name="l00544"></a><span class="lineno">  544</span>            <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#abb6e84ee87a6fdb3281c33e8e8457a04">csnow</a> (sncond,sndens)</div>
<div class="line"><a id="l00545" name="l00545"></a><span class="lineno">  545</span> </div>
<div class="line"><a id="l00546" name="l00546"></a><span class="lineno">  546</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00547" name="l00547"></a><span class="lineno">  547</span><span class="comment">! PRECIP IS LIQUID (RAIN), HENCE SAVE IN THE PRECIP VARIABLE THAT</span></div>
<div class="line"><a id="l00548" name="l00548"></a><span class="lineno">  548</span><span class="comment">! LATER CAN WHOLELY OR PARTIALLY INFILTRATE THE SOIL (ALONG WITH</span></div>
<div class="line"><a id="l00549" name="l00549"></a><span class="lineno">  549</span><span class="comment">! ANY CANOPY &quot;DRIP&quot; ADDED TO THIS LATER)</span></div>
<div class="line"><a id="l00550" name="l00550"></a><span class="lineno">  550</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00551" name="l00551"></a><span class="lineno">  551</span>         <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l00552" name="l00552"></a><span class="lineno">  552</span>            prcpf = prcp</div>
<div class="line"><a id="l00553" name="l00553"></a><span class="lineno">  553</span><span class="keywordflow">         ENDIF</span></div>
<div class="line"><a id="l00554" name="l00554"></a><span class="lineno">  554</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00555" name="l00555"></a><span class="lineno">  555</span><span class="comment">! DETERMINE SNOWCOVER AND ALBEDO OVER LAND.</span></div>
<div class="line"><a id="l00556" name="l00556"></a><span class="lineno">  556</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00557" name="l00557"></a><span class="lineno">  557</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00558" name="l00558"></a><span class="lineno">  558</span><span class="comment">! IF SNOW DEPTH=0, SET SNOW FRACTION=0, ALBEDO=SNOW FREE ALBEDO.</span></div>
<div class="line"><a id="l00559" name="l00559"></a><span class="lineno">  559</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00560" name="l00560"></a><span class="lineno">  560</span>         <span class="keywordflow">IF</span> (sneqv  == 0.0) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00561" name="l00561"></a><span class="lineno">  561</span>            sncovr = 0.0</div>
<div class="line"><a id="l00562" name="l00562"></a><span class="lineno">  562</span>            albedo = alb</div>
<div class="line"><a id="l00563" name="l00563"></a><span class="lineno">  563</span>            emissi = embrd</div>
<div class="line"><a id="l00564" name="l00564"></a><span class="lineno">  564</span>        <span class="keywordflow">IF</span>(ua_phys) fgsn = 0.0</div>
<div class="line"><a id="l00565" name="l00565"></a><span class="lineno">  565</span>        <span class="keywordflow">IF</span>(ua_phys) fvb = 0.0</div>
<div class="line"><a id="l00566" name="l00566"></a><span class="lineno">  566</span>        <span class="keywordflow">IF</span>(ua_phys) fbur = 0.0</div>
<div class="line"><a id="l00567" name="l00567"></a><span class="lineno">  567</span>         <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l00568" name="l00568"></a><span class="lineno">  568</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00569" name="l00569"></a><span class="lineno">  569</span><span class="comment">! DETERMINE SNOW FRACTIONAL COVERAGE.</span></div>
<div class="line"><a id="l00570" name="l00570"></a><span class="lineno">  570</span><span class="comment">! DETERMINE SURFACE ALBEDO MODIFICATION DUE TO SNOWDEPTH STATE.</span></div>
<div class="line"><a id="l00571" name="l00571"></a><span class="lineno">  571</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00572" name="l00572"></a><span class="lineno">  572</span>            <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ae7ad09a03325fa6a08429faa078bb8f2">snfrac</a> (sneqv,snup,salp,snowh,sncovr, &amp;</div>
<div class="line"><a id="l00573" name="l00573"></a><span class="lineno">  573</span>                         xlai,shdfac,fvb,gama,fbur,    &amp;</div>
<div class="line"><a id="l00574" name="l00574"></a><span class="lineno">  574</span>                         fgsn,ztopv,zbotv,ua_phys)</div>
<div class="line"><a id="l00575" name="l00575"></a><span class="lineno">  575</span> </div>
<div class="line"><a id="l00576" name="l00576"></a><span class="lineno">  576</span>            <span class="keywordflow">IF</span> ( ua_phys ) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00577" name="l00577"></a><span class="lineno">  577</span>              <span class="keywordflow">IF</span>(sfctmp &lt;= t1) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00578" name="l00578"></a><span class="lineno">  578</span>                ru = 0.</div>
<div class="line"><a id="l00579" name="l00579"></a><span class="lineno">  579</span>              <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l00580" name="l00580"></a><span class="lineno">  580</span>                ru = 100.*shdfac*fgsn*min((sfctmp-t1)/5., 1.)*(1.-exp(-xlai))</div>
<div class="line"><a id="l00581" name="l00581"></a><span class="lineno">  581</span><span class="keywordflow">              ENDIF</span></div>
<div class="line"><a id="l00582" name="l00582"></a><span class="lineno">  582</span>              ch = ch/(1.+ru*ch)</div>
<div class="line"><a id="l00583" name="l00583"></a><span class="lineno">  583</span><span class="keywordflow">            ENDIF</span></div>
<div class="line"><a id="l00584" name="l00584"></a><span class="lineno">  584</span> </div>
<div class="line"><a id="l00585" name="l00585"></a><span class="lineno">  585</span>            sncovr = min(sncovr,0.98) </div>
<div class="line"><a id="l00586" name="l00586"></a><span class="lineno">  586</span> </div>
<div class="line"><a id="l00587" name="l00587"></a><span class="lineno">  587</span>            <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a7a78bcce992262a6c96711208974f7f1">alcalc</a> (alb,snoalb,embrd,shdfac,shdmin,sncovr,t1, &amp;</div>
<div class="line"><a id="l00588" name="l00588"></a><span class="lineno">  588</span>                 albedo,emissi,dt,snowng,snotime1,lvcoef)</div>
<div class="line"><a id="l00589" name="l00589"></a><span class="lineno">  589</span><span class="keywordflow">         ENDIF</span></div>
<div class="line"><a id="l00590" name="l00590"></a><span class="lineno">  590</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00591" name="l00591"></a><span class="lineno">  591</span><span class="comment">! NEXT CALCULATE THE SUBSURFACE HEAT FLUX, WHICH FIRST REQUIRES</span></div>
<div class="line"><a id="l00592" name="l00592"></a><span class="lineno">  592</span><span class="comment">! CALCULATION OF THE THERMAL DIFFUSIVITY.  TREATMENT OF THE</span></div>
<div class="line"><a id="l00593" name="l00593"></a><span class="lineno">  593</span><span class="comment">! LATTER FOLLOWS THAT ON PAGES 148-149 FROM &quot;HEAT TRANSFER IN</span></div>
<div class="line"><a id="l00594" name="l00594"></a><span class="lineno">  594</span><span class="comment">! COLD CLIMATES&quot;, BY V. J. LUNARDINI (PUBLISHED IN 1981</span></div>
<div class="line"><a id="l00595" name="l00595"></a><span class="lineno">  595</span><span class="comment">! BY VAN NOSTRAND REINHOLD CO.) I.E. TREATMENT OF TWO CONTIGUOUS</span></div>
<div class="line"><a id="l00596" name="l00596"></a><span class="lineno">  596</span><span class="comment">! &quot;PLANE PARALLEL&quot; MEDIUMS (NAMELY HERE THE FIRST SOIL LAYER</span></div>
<div class="line"><a id="l00597" name="l00597"></a><span class="lineno">  597</span><span class="comment">! AND THE SNOWPACK LAYER, IF ANY). THIS DIFFUSIVITY TREATMENT</span></div>
<div class="line"><a id="l00598" name="l00598"></a><span class="lineno">  598</span><span class="comment">! BEHAVES WELL FOR BOTH ZERO AND NONZERO SNOWPACK, INCLUDING THE</span></div>
<div class="line"><a id="l00599" name="l00599"></a><span class="lineno">  599</span><span class="comment">! LIMIT OF VERY THIN SNOWPACK.  THIS TREATMENT ALSO ELIMINATES</span></div>
<div class="line"><a id="l00600" name="l00600"></a><span class="lineno">  600</span><span class="comment">! THE NEED TO IMPOSE AN ARBITRARY UPPER BOUND ON SUBSURFACE</span></div>
<div class="line"><a id="l00601" name="l00601"></a><span class="lineno">  601</span><span class="comment">! HEAT FLUX WHEN THE SNOWPACK BECOMES EXTREMELY THIN.</span></div>
<div class="line"><a id="l00602" name="l00602"></a><span class="lineno">  602</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00603" name="l00603"></a><span class="lineno">  603</span><span class="comment">! FIRST CALCULATE THERMAL DIFFUSIVITY OF TOP SOIL LAYER, USING</span></div>
<div class="line"><a id="l00604" name="l00604"></a><span class="lineno">  604</span><span class="comment">! BOTH THE FROZEN AND LIQUID SOIL MOISTURE, FOLLOWING THE</span></div>
<div class="line"><a id="l00605" name="l00605"></a><span class="lineno">  605</span><span class="comment">! SOIL THERMAL DIFFUSIVITY FUNCTION OF PETERS-LIDARD ET AL.</span></div>
<div class="line"><a id="l00606" name="l00606"></a><span class="lineno">  606</span><span class="comment">! (1998,JAS, VOL 55, 1209-1224), WHICH REQUIRES THE SPECIFYING</span></div>
<div class="line"><a id="l00607" name="l00607"></a><span class="lineno">  607</span><span class="comment">! THE QUARTZ CONTENT OF THE GIVEN SOIL CLASS (SEE ROUTINE REDPRM)</span></div>
<div class="line"><a id="l00608" name="l00608"></a><span class="lineno">  608</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00609" name="l00609"></a><span class="lineno">  609</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00610" name="l00610"></a><span class="lineno">  610</span><span class="comment">! NEXT ADD SUBSURFACE HEAT FLUX REDUCTION EFFECT FROM THE</span></div>
<div class="line"><a id="l00611" name="l00611"></a><span class="lineno">  611</span><span class="comment">! OVERLYING GREEN CANOPY, ADAPTED FROM SECTION 2.1.2 OF</span></div>
<div class="line"><a id="l00612" name="l00612"></a><span class="lineno">  612</span><span class="comment">! PETERS-LIDARD ET AL. (1997, JGR, VOL 102(D4))</span></div>
<div class="line"><a id="l00613" name="l00613"></a><span class="lineno">  613</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00614" name="l00614"></a><span class="lineno">  614</span>            <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a7946ddfb3b6fc624a9e87acbfa08fe1b">tdfcnd</a> (df1,smc(1),quartz,smcmax,sh2o(1),bexp, psisat, soiltyp, opt_thcnd)</div>
<div class="line"><a id="l00615" name="l00615"></a><span class="lineno">  615</span> </div>
<div class="line"><a id="l00616" name="l00616"></a><span class="lineno">  616</span><span class="comment">!urban</span></div>
<div class="line"><a id="l00617" name="l00617"></a><span class="lineno">  617</span>            <span class="keywordflow">IF</span> ( vegtyp == isurban ) df1=3.24</div>
<div class="line"><a id="l00618" name="l00618"></a><span class="lineno">  618</span> </div>
<div class="line"><a id="l00619" name="l00619"></a><span class="lineno">  619</span>            df1 = df1 * exp(sbeta * shdfac)</div>
<div class="line"><a id="l00620" name="l00620"></a><span class="lineno">  620</span><span class="comment">!</span></div>
<div class="line"><a id="l00621" name="l00621"></a><span class="lineno">  621</span><span class="comment">! kmh 09/03/2006</span></div>
<div class="line"><a id="l00622" name="l00622"></a><span class="lineno">  622</span><span class="comment">! kmh 03/25/2008  change SNCOVR threshold to 0.97</span></div>
<div class="line"><a id="l00623" name="l00623"></a><span class="lineno">  623</span><span class="comment">!</span></div>
<div class="line"><a id="l00624" name="l00624"></a><span class="lineno">  624</span>            <span class="keywordflow">IF</span> (  sncovr .GT. 0.97 ) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00625" name="l00625"></a><span class="lineno">  625</span>               df1 = sncond</div>
<div class="line"><a id="l00626" name="l00626"></a><span class="lineno">  626</span><span class="keywordflow">            ENDIF</span></div>
<div class="line"><a id="l00627" name="l00627"></a><span class="lineno">  627</span><span class="comment">!</span></div>
<div class="line"><a id="l00628" name="l00628"></a><span class="lineno">  628</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00629" name="l00629"></a><span class="lineno">  629</span><span class="comment">! FINALLY &quot;PLANE PARALLEL&quot; SNOWPACK EFFECT FOLLOWING</span></div>
<div class="line"><a id="l00630" name="l00630"></a><span class="lineno">  630</span><span class="comment">! V.J. LINARDINI REFERENCE CITED ABOVE. NOTE THAT DTOT IS</span></div>
<div class="line"><a id="l00631" name="l00631"></a><span class="lineno">  631</span><span class="comment">! COMBINED DEPTH OF SNOWDEPTH AND THICKNESS OF FIRST SOIL LAYER</span></div>
<div class="line"><a id="l00632" name="l00632"></a><span class="lineno">  632</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00633" name="l00633"></a><span class="lineno">  633</span> </div>
<div class="line"><a id="l00634" name="l00634"></a><span class="lineno">  634</span>         dsoil = - (0.5 * zsoil(1))</div>
<div class="line"><a id="l00635" name="l00635"></a><span class="lineno">  635</span>         <span class="keywordflow">IF</span> (sneqv == 0.) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00636" name="l00636"></a><span class="lineno">  636</span>            ssoil = df1 * (t1- stc(1) ) / dsoil</div>
<div class="line"><a id="l00637" name="l00637"></a><span class="lineno">  637</span>         <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l00638" name="l00638"></a><span class="lineno">  638</span>            dtot = snowh + dsoil</div>
<div class="line"><a id="l00639" name="l00639"></a><span class="lineno">  639</span>            frcsno = snowh / dtot</div>
<div class="line"><a id="l00640" name="l00640"></a><span class="lineno">  640</span> </div>
<div class="line"><a id="l00641" name="l00641"></a><span class="lineno">  641</span><span class="comment">! 1. HARMONIC MEAN (SERIES FLOW)</span></div>
<div class="line"><a id="l00642" name="l00642"></a><span class="lineno">  642</span><span class="comment">!        DF1 = (SNCOND*DF1)/(FRCSOI*SNCOND+FRCSNO*DF1)</span></div>
<div class="line"><a id="l00643" name="l00643"></a><span class="lineno">  643</span>            frcsoi = dsoil / dtot</div>
<div class="line"><a id="l00644" name="l00644"></a><span class="lineno">  644</span><span class="comment">! 2. ARITHMETIC MEAN (PARALLEL FLOW)</span></div>
<div class="line"><a id="l00645" name="l00645"></a><span class="lineno">  645</span><span class="comment">!        DF1 = FRCSNO*SNCOND + FRCSOI*DF1</span></div>
<div class="line"><a id="l00646" name="l00646"></a><span class="lineno">  646</span>            df1h = (sncond * df1)/ (frcsoi * sncond+ frcsno * df1)</div>
<div class="line"><a id="l00647" name="l00647"></a><span class="lineno">  647</span> </div>
<div class="line"><a id="l00648" name="l00648"></a><span class="lineno">  648</span><span class="comment">! 3. GEOMETRIC MEAN (INTERMEDIATE BETWEEN HARMONIC AND ARITHMETIC MEAN)</span></div>
<div class="line"><a id="l00649" name="l00649"></a><span class="lineno">  649</span><span class="comment">!        DF1 = (SNCOND**FRCSNO)*(DF1**FRCSOI)</span></div>
<div class="line"><a id="l00650" name="l00650"></a><span class="lineno">  650</span><span class="comment">! weigh DF by snow fraction</span></div>
<div class="line"><a id="l00651" name="l00651"></a><span class="lineno">  651</span><span class="comment">!        DF1 = DF1H*SNCOVR + DF1A*(1.0-SNCOVR)</span></div>
<div class="line"><a id="l00652" name="l00652"></a><span class="lineno">  652</span><span class="comment">!        DF1 = DF1H*SNCOVR + DF1*(1.0-SNCOVR)</span></div>
<div class="line"><a id="l00653" name="l00653"></a><span class="lineno">  653</span>            df1a = frcsno * sncond+ frcsoi * df1</div>
<div class="line"><a id="l00654" name="l00654"></a><span class="lineno">  654</span> </div>
<div class="line"><a id="l00655" name="l00655"></a><span class="lineno">  655</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00656" name="l00656"></a><span class="lineno">  656</span><span class="comment">! CALCULATE SUBSURFACE HEAT FLUX, SSOIL, FROM FINAL THERMAL DIFFUSIVITY</span></div>
<div class="line"><a id="l00657" name="l00657"></a><span class="lineno">  657</span><span class="comment">! OF SURFACE MEDIUMS, DF1 ABOVE, AND SKIN TEMPERATURE AND TOP</span></div>
<div class="line"><a id="l00658" name="l00658"></a><span class="lineno">  658</span><span class="comment">! MID-LAYER SOIL TEMPERATURE</span></div>
<div class="line"><a id="l00659" name="l00659"></a><span class="lineno">  659</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00660" name="l00660"></a><span class="lineno">  660</span>            df1 = df1a * sncovr + df1* (1.0- sncovr)</div>
<div class="line"><a id="l00661" name="l00661"></a><span class="lineno">  661</span>            ssoil = df1 * (t1- stc(1) ) / dtot</div>
<div class="line"><a id="l00662" name="l00662"></a><span class="lineno">  662</span><span class="keywordflow">         END IF</span></div>
<div class="line"><a id="l00663" name="l00663"></a><span class="lineno">  663</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00664" name="l00664"></a><span class="lineno">  664</span><span class="comment">! DETERMINE SURFACE ROUGHNESS OVER SNOWPACK USING SNOW CONDITION FROM</span></div>
<div class="line"><a id="l00665" name="l00665"></a><span class="lineno">  665</span><span class="comment">! THE PREVIOUS TIMESTEP.</span></div>
<div class="line"><a id="l00666" name="l00666"></a><span class="lineno">  666</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00667" name="l00667"></a><span class="lineno">  667</span>         <span class="keywordflow">IF</span> (sncovr  &gt; 0. ) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00668" name="l00668"></a><span class="lineno">  668</span>            <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ab3693cb1c40b1bd7b4db5e96337f6eef">snowz0</a> (sncovr,z0,z0brd,snowh,fbur,fgsn,shdmax,ua_phys)</div>
<div class="line"><a id="l00669" name="l00669"></a><span class="lineno">  669</span>         <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l00670" name="l00670"></a><span class="lineno">  670</span>            z0=z0brd</div>
<div class="line"><a id="l00671" name="l00671"></a><span class="lineno">  671</span>            <span class="keywordflow">IF</span>(ua_phys) <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ab3693cb1c40b1bd7b4db5e96337f6eef">snowz0</a> (sncovr,z0,z0brd,snowh,fbur,fgsn, &amp;</div>
<div class="line"><a id="l00672" name="l00672"></a><span class="lineno">  672</span>                                 shdmax,ua_phys)</div>
<div class="line"><a id="l00673" name="l00673"></a><span class="lineno">  673</span><span class="keywordflow">         END IF</span></div>
<div class="line"><a id="l00674" name="l00674"></a><span class="lineno">  674</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00675" name="l00675"></a><span class="lineno">  675</span><span class="comment">! NEXT CALL ROUTINE SFCDIF TO CALCULATE THE SFC EXCHANGE COEF (CH) FOR</span></div>
<div class="line"><a id="l00676" name="l00676"></a><span class="lineno">  676</span><span class="comment">! HEAT AND MOISTURE.</span></div>
<div class="line"><a id="l00677" name="l00677"></a><span class="lineno">  677</span> </div>
<div class="line"><a id="l00678" name="l00678"></a><span class="lineno">  678</span><span class="comment">! NOTE !!!</span></div>
<div class="line"><a id="l00679" name="l00679"></a><span class="lineno">  679</span><span class="comment">! DO NOT CALL SFCDIF UNTIL AFTER ABOVE CALL TO REDPRM, IN CASE</span></div>
<div class="line"><a id="l00680" name="l00680"></a><span class="lineno">  680</span><span class="comment">! ALTERNATIVE VALUES OF ROUGHNESS LENGTH (Z0) AND ZILINTINKEVICH COEF</span></div>
<div class="line"><a id="l00681" name="l00681"></a><span class="lineno">  681</span><span class="comment">! (CZIL) ARE SET THERE VIA NAMELIST I/O.</span></div>
<div class="line"><a id="l00682" name="l00682"></a><span class="lineno">  682</span> </div>
<div class="line"><a id="l00683" name="l00683"></a><span class="lineno">  683</span><span class="comment">! NOTE !!!</span></div>
<div class="line"><a id="l00684" name="l00684"></a><span class="lineno">  684</span><span class="comment">! ROUTINE SFCDIF RETURNS A CH THAT REPRESENTS THE WIND SPD TIMES THE</span></div>
<div class="line"><a id="l00685" name="l00685"></a><span class="lineno">  685</span><span class="comment">! &quot;ORIGINAL&quot; NONDIMENSIONAL &quot;Ch&quot; TYPICAL IN LITERATURE.  HENCE THE CH</span></div>
<div class="line"><a id="l00686" name="l00686"></a><span class="lineno">  686</span><span class="comment">! RETURNED FROM SFCDIF HAS UNITS OF M/S.  THE IMPORTANT COMPANION</span></div>
<div class="line"><a id="l00687" name="l00687"></a><span class="lineno">  687</span><span class="comment">! COEFFICIENT OF CH, CARRIED HERE AS &quot;RCH&quot;, IS THE CH FROM SFCDIF TIMES</span></div>
<div class="line"><a id="l00688" name="l00688"></a><span class="lineno">  688</span><span class="comment">! AIR DENSITY AND PARAMETER &quot;CP&quot;.  &quot;RCH&quot; IS COMPUTED IN &quot;CALL PENMAN&quot;.</span></div>
<div class="line"><a id="l00689" name="l00689"></a><span class="lineno">  689</span><span class="comment">! RCH RATHER THAN CH IS THE COEFF USUALLY INVOKED LATER IN EQNS.</span></div>
<div class="line"><a id="l00690" name="l00690"></a><span class="lineno">  690</span> </div>
<div class="line"><a id="l00691" name="l00691"></a><span class="lineno">  691</span><span class="comment">! NOTE !!!</span></div>
<div class="line"><a id="l00692" name="l00692"></a><span class="lineno">  692</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00693" name="l00693"></a><span class="lineno">  693</span><span class="comment">! SFCDIF ALSO RETURNS THE SURFACE EXCHANGE COEFFICIENT FOR MOMENTUM, CM,</span></div>
<div class="line"><a id="l00694" name="l00694"></a><span class="lineno">  694</span><span class="comment">! ALSO KNOWN AS THE SURFACE DRAGE COEFFICIENT. Needed as a state variable</span></div>
<div class="line"><a id="l00695" name="l00695"></a><span class="lineno">  695</span><span class="comment">! for iterative/implicit solution of CH in SFCDIF</span></div>
<div class="line"><a id="l00696" name="l00696"></a><span class="lineno">  696</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00697" name="l00697"></a><span class="lineno">  697</span><span class="comment">!        IF(.NOT.LCH) THEN</span></div>
<div class="line"><a id="l00698" name="l00698"></a><span class="lineno">  698</span><span class="comment">!          T1V = T1 * (1.0+ 0.61 * Q2)</span></div>
<div class="line"><a id="l00699" name="l00699"></a><span class="lineno">  699</span><span class="comment">!          TH2V = TH2 * (1.0+ 0.61 * Q2)</span></div>
<div class="line"><a id="l00700" name="l00700"></a><span class="lineno">  700</span><span class="comment">!          CALL SFCDIF_off (ZLVL,Z0,T1V,TH2V,SFCSPD,CZIL,CM,CH)</span></div>
<div class="line"><a id="l00701" name="l00701"></a><span class="lineno">  701</span><span class="comment">!        ENDIF</span></div>
<div class="line"><a id="l00702" name="l00702"></a><span class="lineno">  702</span> </div>
<div class="line"><a id="l00703" name="l00703"></a><span class="lineno">  703</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00704" name="l00704"></a><span class="lineno">  704</span><span class="comment">! CALL PENMAN SUBROUTINE TO CALCULATE POTENTIAL EVAPORATION (ETP), AND</span></div>
<div class="line"><a id="l00705" name="l00705"></a><span class="lineno">  705</span><span class="comment">! OTHER PARTIAL PRODUCTS AND SUMS SAVE IN COMMON/RITE FOR LATER</span></div>
<div class="line"><a id="l00706" name="l00706"></a><span class="lineno">  706</span><span class="comment">! CALCULATIONS.</span></div>
<div class="line"><a id="l00707" name="l00707"></a><span class="lineno">  707</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00708" name="l00708"></a><span class="lineno">  708</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00709" name="l00709"></a><span class="lineno">  709</span><span class="comment">! CALCULATE TOTAL DOWNWARD RADIATION (SOLAR PLUS LONGWAVE) NEEDED IN</span></div>
<div class="line"><a id="l00710" name="l00710"></a><span class="lineno">  710</span><span class="comment">! PENMAN EP SUBROUTINE THAT FOLLOWS</span></div>
<div class="line"><a id="l00711" name="l00711"></a><span class="lineno">  711</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00712" name="l00712"></a><span class="lineno">  712</span><span class="comment">!         FDOWN = SOLDN * (1.0- ALBEDO) + LWDN</span></div>
<div class="line"><a id="l00713" name="l00713"></a><span class="lineno">  713</span>         fdown =  solnet + lwdn</div>
<div class="line"><a id="l00714" name="l00714"></a><span class="lineno">  714</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00715" name="l00715"></a><span class="lineno">  715</span><span class="comment">! CALC VIRTUAL TEMPS AND VIRTUAL POTENTIAL TEMPS NEEDED BY SUBROUTINES</span></div>
<div class="line"><a id="l00716" name="l00716"></a><span class="lineno">  716</span><span class="comment">! PENMAN.</span></div>
<div class="line"><a id="l00717" name="l00717"></a><span class="lineno">  717</span>         t2v = sfctmp * (1.0+ 0.61 * q2 )</div>
<div class="line"><a id="l00718" name="l00718"></a><span class="lineno">  718</span> </div>
<div class="line"><a id="l00719" name="l00719"></a><span class="lineno">  719</span>         iout=0</div>
<div class="line"><a id="l00720" name="l00720"></a><span class="lineno">  720</span>         <span class="keywordflow">if</span>(iout.eq.1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00721" name="l00721"></a><span class="lineno">  721</span>         print*,<span class="stringliteral">&#39;before penman&#39;</span></div>
<div class="line"><a id="l00722" name="l00722"></a><span class="lineno">  722</span>         print*,<span class="stringliteral">&#39; SFCTMP&#39;</span>,sfctmp,<span class="stringliteral">&#39;SFCPRS&#39;</span>,sfcprs,<span class="stringliteral">&#39;CH&#39;</span>,ch,<span class="stringliteral">&#39;T2V&#39;</span>,t2v,      &amp;</div>
<div class="line"><a id="l00723" name="l00723"></a><span class="lineno">  723</span>       <span class="stringliteral">&#39;TH2&#39;</span>,th2,<span class="stringliteral">&#39;PRCP&#39;</span>,prcp,<span class="stringliteral">&#39;FDOWN&#39;</span>,fdown,<span class="stringliteral">&#39;T24&#39;</span>,t24,<span class="stringliteral">&#39;SSOIL&#39;</span>,ssoil,      &amp;</div>
<div class="line"><a id="l00724" name="l00724"></a><span class="lineno">  724</span>        <span class="stringliteral">&#39;Q2&#39;</span>,q2,<span class="stringliteral">&#39;Q2SAT&#39;</span>,q2sat,<span class="stringliteral">&#39;ETP&#39;</span>,etp,<span class="stringliteral">&#39;RCH&#39;</span>,rch,                       &amp;</div>
<div class="line"><a id="l00725" name="l00725"></a><span class="lineno">  725</span>        <span class="stringliteral">&#39;EPSCA&#39;</span>,epsca,<span class="stringliteral">&#39;RR&#39;</span>,rr  ,<span class="stringliteral">&#39;SNOWNG&#39;</span>,snowng,<span class="stringliteral">&#39;FRZGRA&#39;</span>,frzgra,           &amp;</div>
<div class="line"><a id="l00726" name="l00726"></a><span class="lineno">  726</span>        <span class="stringliteral">&#39;DQSDT2&#39;</span>,dqsdt2,<span class="stringliteral">&#39;FLX2&#39;</span>,flx2,<span class="stringliteral">&#39;SNOWH&#39;</span>,snowh,<span class="stringliteral">&#39;SNEQV&#39;</span>,sneqv,         &amp;</div>
<div class="line"><a id="l00727" name="l00727"></a><span class="lineno">  727</span>        <span class="stringliteral">&#39; DSOIL&#39;</span>,dsoil,<span class="stringliteral">&#39; FRCSNO&#39;</span>,frcsno,<span class="stringliteral">&#39; SNCOVR&#39;</span>,sncovr,<span class="stringliteral">&#39; DTOT&#39;</span>,dtot,   &amp;</div>
<div class="line"><a id="l00728" name="l00728"></a><span class="lineno">  728</span>       <span class="stringliteral">&#39; ZSOIL (1)&#39;</span>,zsoil(1),<span class="stringliteral">&#39; DF1&#39;</span>,df1,<span class="stringliteral">&#39;T1&#39;</span>,t1,<span class="stringliteral">&#39; STC1&#39;</span>,stc(1),          &amp;</div>
<div class="line"><a id="l00729" name="l00729"></a><span class="lineno">  729</span>        <span class="stringliteral">&#39;ALBEDO&#39;</span>,albedo,<span class="stringliteral">&#39;SMC&#39;</span>,smc,<span class="stringliteral">&#39;STC&#39;</span>,stc,<span class="stringliteral">&#39;SH2O&#39;</span>,sh2o</div>
<div class="line"><a id="l00730" name="l00730"></a><span class="lineno">  730</span><span class="keywordflow">         endif</span></div>
<div class="line"><a id="l00731" name="l00731"></a><span class="lineno">  731</span> </div>
<div class="line"><a id="l00732" name="l00732"></a><span class="lineno">  732</span>         <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a5312fbbf31302c20e6823a3d2e97033b">penman</a> (sfctmp,sfcprs,ch,t2v,th2,prcp,fdown,t24,ssoil,     &amp;</div>
<div class="line"><a id="l00733" name="l00733"></a><span class="lineno">  733</span>                       q2,q2sat,etp,rch,epsca,rr,snowng,frzgra,          &amp;</div>
<div class="line"><a id="l00734" name="l00734"></a><span class="lineno">  734</span>                       dqsdt2,flx2,emissi,sneqv,t1,sncovr,aoasis,        &amp;</div>
<div class="line"><a id="l00735" name="l00735"></a><span class="lineno">  735</span>               albedo,soldn,fvb,gama,stc(1),etpn,flx4,ua_phys)</div>
<div class="line"><a id="l00736" name="l00736"></a><span class="lineno">  736</span><span class="comment">!</span></div>
<div class="line"><a id="l00737" name="l00737"></a><span class="lineno">  737</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00738" name="l00738"></a><span class="lineno">  738</span><span class="comment">! CALL CANRES TO CALCULATE THE CANOPY RESISTANCE AND CONVERT IT INTO PC</span></div>
<div class="line"><a id="l00739" name="l00739"></a><span class="lineno">  739</span><span class="comment">! IF NONZERO GREENNESS FRACTION</span></div>
<div class="line"><a id="l00740" name="l00740"></a><span class="lineno">  740</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00741" name="l00741"></a><span class="lineno">  741</span> </div>
<div class="line"><a id="l00742" name="l00742"></a><span class="lineno">  742</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00743" name="l00743"></a><span class="lineno">  743</span><span class="comment">!  FROZEN GROUND EXTENSION: TOTAL SOIL WATER &quot;SMC&quot; WAS REPLACED</span></div>
<div class="line"><a id="l00744" name="l00744"></a><span class="lineno">  744</span><span class="comment">!  BY UNFROZEN SOIL WATER &quot;SH2O&quot; IN CALL TO CANRES BELOW</span></div>
<div class="line"><a id="l00745" name="l00745"></a><span class="lineno">  745</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00746" name="l00746"></a><span class="lineno">  746</span>         <span class="keywordflow">IF</span> ( (shdfac &gt; 0.) .AND. (xlai &gt; 0.) ) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00747" name="l00747"></a><span class="lineno">  747</span>            <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a433b2b986f9e11459dc99a8a99db6ba7">canres</a> (soldn,ch,sfctmp,q2,sfcprs,sh2o,zsoil,nsoil,     &amp;</div>
<div class="line"><a id="l00748" name="l00748"></a><span class="lineno">  748</span>                          smcwlt,smcref,rsmin,rc,pc,nroot,q2sat,dqsdt2,  &amp;</div>
<div class="line"><a id="l00749" name="l00749"></a><span class="lineno">  749</span>                          topt,rsmax,rgl,hs,xlai,                        &amp;</div>
<div class="line"><a id="l00750" name="l00750"></a><span class="lineno">  750</span>                          rcs,rct,rcq,rcsoil,emissi)</div>
<div class="line"><a id="l00751" name="l00751"></a><span class="lineno">  751</span>         <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l00752" name="l00752"></a><span class="lineno">  752</span>            rc = 0.0</div>
<div class="line"><a id="l00753" name="l00753"></a><span class="lineno">  753</span><span class="keywordflow">         END IF</span></div>
<div class="line"><a id="l00754" name="l00754"></a><span class="lineno">  754</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00755" name="l00755"></a><span class="lineno">  755</span><span class="comment">! NOW DECIDE MAJOR PATHWAY BRANCH TO TAKE DEPENDING ON WHETHER SNOWPACK</span></div>
<div class="line"><a id="l00756" name="l00756"></a><span class="lineno">  756</span><span class="comment">! EXISTS OR NOT:</span></div>
<div class="line"><a id="l00757" name="l00757"></a><span class="lineno">  757</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00758" name="l00758"></a><span class="lineno">  758</span>         esnow = 0.0</div>
<div class="line"><a id="l00759" name="l00759"></a><span class="lineno">  759</span>         <span class="keywordflow">IF</span> (sneqv  == 0.0) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00760" name="l00760"></a><span class="lineno">  760</span>            <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a010cd10c8d345760dec2a6bddbb5170f">nopac</a> (etp,eta,prcp,smc,smcmax,smcwlt,                  &amp;</div>
<div class="line"><a id="l00761" name="l00761"></a><span class="lineno">  761</span>                            smcref,smcdry,cmc,cmcmax,nsoil,dt,           &amp;</div>
<div class="line"><a id="l00762" name="l00762"></a><span class="lineno">  762</span>                            shdfac,                                      &amp;</div>
<div class="line"><a id="l00763" name="l00763"></a><span class="lineno">  763</span>                            sbeta,q2,t1,sfctmp,t24,th2,fdown,f1,emissi,  &amp;</div>
<div class="line"><a id="l00764" name="l00764"></a><span class="lineno">  764</span>                            ssoil,                                       &amp;</div>
<div class="line"><a id="l00765" name="l00765"></a><span class="lineno">  765</span>                            stc,epsca,bexp,pc,rch,rr,cfactr,             &amp;</div>
<div class="line"><a id="l00766" name="l00766"></a><span class="lineno">  766</span>                            sh2o,slope,kdt,frzx,psisat,zsoil,            &amp;</div>
<div class="line"><a id="l00767" name="l00767"></a><span class="lineno">  767</span>                            dksat,dwsat,tbot,zbot,runoff1,runoff2,       &amp;</div>
<div class="line"><a id="l00768" name="l00768"></a><span class="lineno">  768</span>                            runoff3,edir,ec,et,ett,nroot,rtdis,          &amp;</div>
<div class="line"><a id="l00769" name="l00769"></a><span class="lineno">  769</span>                            quartz,fxexp,csoil,                          &amp;</div>
<div class="line"><a id="l00770" name="l00770"></a><span class="lineno">  770</span>                            beta,drip,dew,flx1,flx3,vegtyp,isurban,      &amp;</div>
<div class="line"><a id="l00771" name="l00771"></a><span class="lineno">  771</span>                            sfhead1rt,infxs1rt,etpnd1,soiltyp,opt_thcnd  &amp;</div>
<div class="line"><a id="l00772" name="l00772"></a><span class="lineno">  772</span>                           ,xsda_qfx,qfx_phy,xqnorm,fasdas,hcpct_fasdas  ) <span class="comment">!fasdas</span></div>
<div class="line"><a id="l00773" name="l00773"></a><span class="lineno">  773</span>            eta_kinematic = eta</div>
<div class="line"><a id="l00774" name="l00774"></a><span class="lineno">  774</span>         <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l00775" name="l00775"></a><span class="lineno">  775</span>            <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ae27e8294cc66ecbb23f2a9d239a3c3d7">snopac</a> (etp,eta,prcp,prcpf,snowng,smc,smcmax,smcwlt,    &amp;</div>
<div class="line"><a id="l00776" name="l00776"></a><span class="lineno">  776</span>                         smcref,smcdry,cmc,cmcmax,nsoil,dt,              &amp;</div>
<div class="line"><a id="l00777" name="l00777"></a><span class="lineno">  777</span>                         sbeta,df1,                                      &amp;</div>
<div class="line"><a id="l00778" name="l00778"></a><span class="lineno">  778</span>                         q2,t1,sfctmp,t24,th2,fdown,f1,ssoil,stc,epsca,  &amp;</div>
<div class="line"><a id="l00779" name="l00779"></a><span class="lineno">  779</span>                         sfcprs,bexp,pc,rch,rr,cfactr,sncovr,sneqv,sndens,&amp;</div>
<div class="line"><a id="l00780" name="l00780"></a><span class="lineno">  780</span>                         snowh,sh2o,slope,kdt,frzx,psisat,               &amp;</div>
<div class="line"><a id="l00781" name="l00781"></a><span class="lineno">  781</span>                         zsoil,dwsat,dksat,tbot,zbot,shdfac,runoff1,     &amp;</div>
<div class="line"><a id="l00782" name="l00782"></a><span class="lineno">  782</span>                         runoff2,runoff3,edir,ec,et,ett,nroot,snomlt,    &amp;</div>
<div class="line"><a id="l00783" name="l00783"></a><span class="lineno">  783</span>                         rtdis,quartz,fxexp,csoil,                       &amp;</div>
<div class="line"><a id="l00784" name="l00784"></a><span class="lineno">  784</span>                         beta,drip,dew,flx1,flx2,flx3,esnow,etns,emissi, &amp;</div>
<div class="line"><a id="l00785" name="l00785"></a><span class="lineno">  785</span>                         ribb,soldn,                                     &amp;</div>
<div class="line"><a id="l00786" name="l00786"></a><span class="lineno">  786</span>                         isurban,                                        &amp;</div>
<div class="line"><a id="l00787" name="l00787"></a><span class="lineno">  787</span>                         vegtyp,                                         &amp;</div>
<div class="line"><a id="l00788" name="l00788"></a><span class="lineno">  788</span>                         etpn,flx4,ua_phys,                              &amp;</div>
<div class="line"><a id="l00789" name="l00789"></a><span class="lineno">  789</span>                         sfhead1rt,infxs1rt,etpnd1,soiltyp,opt_thcnd     &amp;</div>
<div class="line"><a id="l00790" name="l00790"></a><span class="lineno">  790</span>                        ,qfx_phy,fasdas,hcpct_fasdas                     ) <span class="comment">!fasdas</span></div>
<div class="line"><a id="l00791" name="l00791"></a><span class="lineno">  791</span>            eta_kinematic =  esnow + etns - 1000.0*dew</div>
<div class="line"><a id="l00792" name="l00792"></a><span class="lineno">  792</span><span class="keywordflow">         END IF</span></div>
<div class="line"><a id="l00793" name="l00793"></a><span class="lineno">  793</span> </div>
<div class="line"><a id="l00794" name="l00794"></a><span class="lineno">  794</span><span class="comment">!     Calculate effective mixing ratio at grnd level (skin)</span></div>
<div class="line"><a id="l00795" name="l00795"></a><span class="lineno">  795</span><span class="comment">!</span></div>
<div class="line"><a id="l00796" name="l00796"></a><span class="lineno">  796</span><span class="comment">!     Q1=Q2+ETA*CP/RCH</span></div>
<div class="line"><a id="l00797" name="l00797"></a><span class="lineno">  797</span>     q1=q2+eta_kinematic*cp/rch</div>
<div class="line"><a id="l00798" name="l00798"></a><span class="lineno">  798</span><span class="comment">!</span></div>
<div class="line"><a id="l00799" name="l00799"></a><span class="lineno">  799</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00800" name="l00800"></a><span class="lineno">  800</span><span class="comment">! DETERMINE SENSIBLE HEAT (H) IN ENERGY UNITS (W M-2)</span></div>
<div class="line"><a id="l00801" name="l00801"></a><span class="lineno">  801</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00802" name="l00802"></a><span class="lineno">  802</span> </div>
<div class="line"><a id="l00803" name="l00803"></a><span class="lineno">  803</span>         sheat = - (ch * cp * sfcprs)/ (r * t2v) * ( th2- t1 )</div>
<div class="line"><a id="l00804" name="l00804"></a><span class="lineno">  804</span>         <span class="keywordflow">IF</span>(ua_phys) sheat = sheat + flx4   </div>
<div class="line"><a id="l00805" name="l00805"></a><span class="lineno">  805</span><span class="comment">!</span></div>
<div class="line"><a id="l00806" name="l00806"></a><span class="lineno">  806</span><span class="comment">! FASDAS</span></div>
<div class="line"><a id="l00807" name="l00807"></a><span class="lineno">  807</span><span class="comment">!</span></div>
<div class="line"><a id="l00808" name="l00808"></a><span class="lineno">  808</span>      <span class="keywordflow">IF</span> ( fasdas == 1 ) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00809" name="l00809"></a><span class="lineno">  809</span>        hfx_phy = sheat</div>
<div class="line"><a id="l00810" name="l00810"></a><span class="lineno">  810</span><span class="keywordflow">      ENDIF</span></div>
<div class="line"><a id="l00811" name="l00811"></a><span class="lineno">  811</span><span class="comment">!</span></div>
<div class="line"><a id="l00812" name="l00812"></a><span class="lineno">  812</span><span class="comment">! END FASDAS</span></div>
<div class="line"><a id="l00813" name="l00813"></a><span class="lineno">  813</span><span class="comment">!</span></div>
<div class="line"><a id="l00814" name="l00814"></a><span class="lineno">  814</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00815" name="l00815"></a><span class="lineno">  815</span><span class="comment">! CONVERT EVAP TERMS FROM KINEMATIC (KG M-2 S-1) TO ENERGY UNITS (W M-2)</span></div>
<div class="line"><a id="l00816" name="l00816"></a><span class="lineno">  816</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00817" name="l00817"></a><span class="lineno">  817</span>      edir = edir * lvh2o</div>
<div class="line"><a id="l00818" name="l00818"></a><span class="lineno">  818</span>      ec = ec * lvh2o</div>
<div class="line"><a id="l00819" name="l00819"></a><span class="lineno">  819</span>      <span class="keywordflow">DO</span> k=1,4</div>
<div class="line"><a id="l00820" name="l00820"></a><span class="lineno">  820</span>      et(k) = et(k) * lvh2o</div>
<div class="line"><a id="l00821" name="l00821"></a><span class="lineno">  821</span><span class="keywordflow">      ENDDO</span></div>
<div class="line"><a id="l00822" name="l00822"></a><span class="lineno">  822</span>      ett = ett * lvh2o</div>
<div class="line"><a id="l00823" name="l00823"></a><span class="lineno">  823</span>      </div>
<div class="line"><a id="l00824" name="l00824"></a><span class="lineno">  824</span>      etpnd1=etpnd1 * lvh2o</div>
<div class="line"><a id="l00825" name="l00825"></a><span class="lineno">  825</span> </div>
<div class="line"><a id="l00826" name="l00826"></a><span class="lineno">  826</span>      esnow = esnow * lsubs</div>
<div class="line"><a id="l00827" name="l00827"></a><span class="lineno">  827</span>      etp = etp*((1.-sncovr)*lvh2o + sncovr*lsubs)</div>
<div class="line"><a id="l00828" name="l00828"></a><span class="lineno">  828</span>      <span class="keywordflow">IF</span>(ua_phys) etpn = etpn*((1.-sncovr)*lvh2o + sncovr*lsubs)</div>
<div class="line"><a id="l00829" name="l00829"></a><span class="lineno">  829</span>      <span class="keywordflow">IF</span> (etp .GT. 0.) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00830" name="l00830"></a><span class="lineno">  830</span>         eta = edir + ec + ett + esnow</div>
<div class="line"><a id="l00831" name="l00831"></a><span class="lineno">  831</span>      <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l00832" name="l00832"></a><span class="lineno">  832</span>        eta = etp</div>
<div class="line"><a id="l00833" name="l00833"></a><span class="lineno">  833</span><span class="keywordflow">      ENDIF</span></div>
<div class="line"><a id="l00834" name="l00834"></a><span class="lineno">  834</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00835" name="l00835"></a><span class="lineno">  835</span><span class="comment">! DETERMINE BETA (RATIO OF ACTUAL TO POTENTIAL EVAP)</span></div>
<div class="line"><a id="l00836" name="l00836"></a><span class="lineno">  836</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00837" name="l00837"></a><span class="lineno">  837</span>      <span class="keywordflow">IF</span> (etp == 0.0) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00838" name="l00838"></a><span class="lineno">  838</span>        beta = 0.0</div>
<div class="line"><a id="l00839" name="l00839"></a><span class="lineno">  839</span>      <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l00840" name="l00840"></a><span class="lineno">  840</span>        beta = eta/etp</div>
<div class="line"><a id="l00841" name="l00841"></a><span class="lineno">  841</span><span class="keywordflow">      ENDIF</span></div>
<div class="line"><a id="l00842" name="l00842"></a><span class="lineno">  842</span> </div>
<div class="line"><a id="l00843" name="l00843"></a><span class="lineno">  843</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00844" name="l00844"></a><span class="lineno">  844</span><span class="comment">! CONVERT THE SIGN OF SOIL HEAT FLUX SO THAT:</span></div>
<div class="line"><a id="l00845" name="l00845"></a><span class="lineno">  845</span><span class="comment">!   SSOIL&gt;0: WARM THE SURFACE  (NIGHT TIME)</span></div>
<div class="line"><a id="l00846" name="l00846"></a><span class="lineno">  846</span><span class="comment">!   SSOIL&lt;0: COOL THE SURFACE  (DAY TIME)</span></div>
<div class="line"><a id="l00847" name="l00847"></a><span class="lineno">  847</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00848" name="l00848"></a><span class="lineno">  848</span>         ssoil = -1.0* ssoil</div>
<div class="line"><a id="l00849" name="l00849"></a><span class="lineno">  849</span> </div>
<div class="line"><a id="l00850" name="l00850"></a><span class="lineno">  850</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00851" name="l00851"></a><span class="lineno">  851</span><span class="comment">!  FOR THE CASE OF LAND:</span></div>
<div class="line"><a id="l00852" name="l00852"></a><span class="lineno">  852</span><span class="comment">!  CONVERT RUNOFF3 (INTERNAL LAYER RUNOFF FROM SUPERSAT) FROM M TO M S-1</span></div>
<div class="line"><a id="l00853" name="l00853"></a><span class="lineno">  853</span><span class="comment">!  AND ADD TO SUBSURFACE RUNOFF/DRAINAGE/BASEFLOW.  RUNOFF2 IS ALREADY</span></div>
<div class="line"><a id="l00854" name="l00854"></a><span class="lineno">  854</span><span class="comment">!  A RATE AT THIS POINT</span></div>
<div class="line"><a id="l00855" name="l00855"></a><span class="lineno">  855</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00856" name="l00856"></a><span class="lineno">  856</span>         runoff3 = runoff3/ dt</div>
<div class="line"><a id="l00857" name="l00857"></a><span class="lineno">  857</span>         runoff2 = runoff2+ runoff3</div>
<div class="line"><a id="l00858" name="l00858"></a><span class="lineno">  858</span>         soilm = -1.0* smc(1)* zsoil(1)</div>
<div class="line"><a id="l00859" name="l00859"></a><span class="lineno">  859</span>         <span class="keywordflow">DO</span> k = 2,nsoil</div>
<div class="line"><a id="l00860" name="l00860"></a><span class="lineno">  860</span>            soilm = soilm + smc(k)* (zsoil(k -1) - zsoil(k))</div>
<div class="line"><a id="l00861" name="l00861"></a><span class="lineno">  861</span><span class="keywordflow">         END DO</span></div>
<div class="line"><a id="l00862" name="l00862"></a><span class="lineno">  862</span>         soilwm = -1.0* (smcmax - smcwlt)* zsoil(1)</div>
<div class="line"><a id="l00863" name="l00863"></a><span class="lineno">  863</span>         soilww = -1.0* (smc(1) - smcwlt)* zsoil(1)</div>
<div class="line"><a id="l00864" name="l00864"></a><span class="lineno">  864</span> </div>
<div class="line"><a id="l00865" name="l00865"></a><span class="lineno">  865</span>         <span class="keywordflow">DO</span> k = 1,nsoil</div>
<div class="line"><a id="l00866" name="l00866"></a><span class="lineno">  866</span>            smav(k)=(smc(k) - smcwlt)/(smcmax - smcwlt)</div>
<div class="line"><a id="l00867" name="l00867"></a><span class="lineno">  867</span><span class="keywordflow">         END DO</span></div>
<div class="line"><a id="l00868" name="l00868"></a><span class="lineno">  868</span> </div>
<div class="line"><a id="l00869" name="l00869"></a><span class="lineno">  869</span>         <span class="keywordflow">IF</span> (nroot &gt;= 2) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00870" name="l00870"></a><span class="lineno">  870</span>            <span class="keywordflow">DO</span> k = 2,nroot</div>
<div class="line"><a id="l00871" name="l00871"></a><span class="lineno">  871</span>                soilwm = soilwm + (smcmax - smcwlt)* (zsoil(k -1) - zsoil(k))</div>
<div class="line"><a id="l00872" name="l00872"></a><span class="lineno">  872</span>                soilww = soilww + (smc(k) - smcwlt)* (zsoil(k -1) - zsoil(k))</div>
<div class="line"><a id="l00873" name="l00873"></a><span class="lineno">  873</span><span class="keywordflow">            END DO</span></div>
<div class="line"><a id="l00874" name="l00874"></a><span class="lineno">  874</span><span class="keywordflow">         END IF</span></div>
<div class="line"><a id="l00875" name="l00875"></a><span class="lineno">  875</span>         <span class="keywordflow">IF</span> (soilwm .LT. 1.e-6) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00876" name="l00876"></a><span class="lineno">  876</span>           soilwm = 0.0</div>
<div class="line"><a id="l00877" name="l00877"></a><span class="lineno">  877</span>           soilw  = 0.0</div>
<div class="line"><a id="l00878" name="l00878"></a><span class="lineno">  878</span>           soilm  = 0.0</div>
<div class="line"><a id="l00879" name="l00879"></a><span class="lineno">  879</span>         <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l00880" name="l00880"></a><span class="lineno">  880</span>           soilw = soilww / soilwm</div>
<div class="line"><a id="l00881" name="l00881"></a><span class="lineno">  881</span><span class="keywordflow">         END IF</span></div>
<div class="line"><a id="l00882" name="l00882"></a><span class="lineno">  882</span> </div>
<div class="line"><a id="l00883" name="l00883"></a><span class="lineno">  883</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00884" name="l00884"></a><span class="lineno">  884</span>  <span class="keyword">END SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a89de2b557283473efeeec5d3d49c7e7e">sflx</a></div>
<div class="line"><a id="l00885" name="l00885"></a><span class="lineno">  885</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00886" name="l00886"></a><span class="lineno">  886</span> </div>
<div class="line"><a id="l00887" name="l00887"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#a7a78bcce992262a6c96711208974f7f1">  887</a></span>      <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a7a78bcce992262a6c96711208974f7f1">alcalc</a> (ALB,SNOALB,EMBRD,SHDFAC,SHDMIN,SNCOVR,TSNOW,ALBEDO,EMISSI,   &amp;</div>
<div class="line"><a id="l00888" name="l00888"></a><span class="lineno">  888</span>                         DT,SNOWNG,SNOTIME1,LVCOEF)</div>
<div class="line"><a id="l00889" name="l00889"></a><span class="lineno">  889</span> </div>
<div class="line"><a id="l00890" name="l00890"></a><span class="lineno">  890</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00891" name="l00891"></a><span class="lineno">  891</span><span class="comment">! CALCULATE ALBEDO INCLUDING SNOW EFFECT (0 -&gt; 1)</span></div>
<div class="line"><a id="l00892" name="l00892"></a><span class="lineno">  892</span><span class="comment">!   ALB     SNOWFREE ALBEDO</span></div>
<div class="line"><a id="l00893" name="l00893"></a><span class="lineno">  893</span><span class="comment">!   SNOALB  MAXIMUM (DEEP) SNOW ALBEDO</span></div>
<div class="line"><a id="l00894" name="l00894"></a><span class="lineno">  894</span><span class="comment">!   SHDFAC    AREAL FRACTIONAL COVERAGE OF GREEN VEGETATION</span></div>
<div class="line"><a id="l00895" name="l00895"></a><span class="lineno">  895</span><span class="comment">!   SHDMIN    MINIMUM AREAL FRACTIONAL COVERAGE OF GREEN VEGETATION</span></div>
<div class="line"><a id="l00896" name="l00896"></a><span class="lineno">  896</span><span class="comment">!   SNCOVR  FRACTIONAL SNOW COVER</span></div>
<div class="line"><a id="l00897" name="l00897"></a><span class="lineno">  897</span><span class="comment">!   ALBEDO  SURFACE ALBEDO INCLUDING SNOW EFFECT</span></div>
<div class="line"><a id="l00898" name="l00898"></a><span class="lineno">  898</span><span class="comment">!   TSNOW   SNOW SURFACE TEMPERATURE (K)</span></div>
<div class="line"><a id="l00899" name="l00899"></a><span class="lineno">  899</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00900" name="l00900"></a><span class="lineno">  900</span>      <span class="keywordtype">IMPLICIT NONE</span></div>
<div class="line"><a id="l00901" name="l00901"></a><span class="lineno">  901</span> </div>
<div class="line"><a id="l00902" name="l00902"></a><span class="lineno">  902</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00903" name="l00903"></a><span class="lineno">  903</span><span class="comment">! SNOALB IS ARGUMENT REPRESENTING MAXIMUM ALBEDO OVER DEEP SNOW,</span></div>
<div class="line"><a id="l00904" name="l00904"></a><span class="lineno">  904</span><span class="comment">! AS PASSED INTO SFLX, AND ADAPTED FROM THE SATELLITE-BASED MAXIMUM</span></div>
<div class="line"><a id="l00905" name="l00905"></a><span class="lineno">  905</span><span class="comment">! SNOW ALBEDO FIELDS PROVIDED BY D. ROBINSON AND G. KUKLA</span></div>
<div class="line"><a id="l00906" name="l00906"></a><span class="lineno">  906</span><span class="comment">! (1985, JCAM, VOL 24, 402-411)</span></div>
<div class="line"><a id="l00907" name="l00907"></a><span class="lineno">  907</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00908" name="l00908"></a><span class="lineno">  908</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(IN)</span>  ::  ALB, SNOALB, EMBRD, SHDFAC, SHDMIN, SNCOVR, TSNOW</div>
<div class="line"><a id="l00909" name="l00909"></a><span class="lineno">  909</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(IN)</span>  :: DT</div>
<div class="line"><a id="l00910" name="l00910"></a><span class="lineno">  910</span>      <span class="keywordtype">LOGICAL</span>, <span class="keywordtype">INTENT(IN)</span> :: SNOWNG</div>
<div class="line"><a id="l00911" name="l00911"></a><span class="lineno">  911</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(INOUT)</span>:: SNOTIME1</div>
<div class="line"><a id="l00912" name="l00912"></a><span class="lineno">  912</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(OUT)</span> ::  ALBEDO, EMISSI</div>
<div class="line"><a id="l00913" name="l00913"></a><span class="lineno">  913</span><span class="keywordtype">      REAL</span>              :: SNOALB2</div>
<div class="line"><a id="l00914" name="l00914"></a><span class="lineno">  914</span><span class="keywordtype">      REAL</span>              :: TM,SNOALB1</div>
<div class="line"><a id="l00915" name="l00915"></a><span class="lineno">  915</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(IN)</span>  :: LVCOEF</div>
<div class="line"><a id="l00916" name="l00916"></a><span class="lineno">  916</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">PARAMETER</span>   :: SNACCA=0.94,snaccb=0.58,snthwa=0.82,snthwb=0.46</div>
<div class="line"><a id="l00917" name="l00917"></a><span class="lineno">  917</span><span class="comment">! turn of vegetation effect</span></div>
<div class="line"><a id="l00918" name="l00918"></a><span class="lineno">  918</span><span class="comment">!      ALBEDO = ALB + (1.0- (SHDFAC - SHDMIN))* SNCOVR * (SNOALB - ALB)</span></div>
<div class="line"><a id="l00919" name="l00919"></a><span class="lineno">  919</span><span class="comment">!      ALBEDO = (1.0-SNCOVR)*ALB + SNCOVR*SNOALB !this is equivalent to below</span></div>
<div class="line"><a id="l00920" name="l00920"></a><span class="lineno">  920</span>      albedo = alb + sncovr*(snoalb-alb)</div>
<div class="line"><a id="l00921" name="l00921"></a><span class="lineno">  921</span>      emissi = embrd + sncovr*(<a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a54e48804c7badd0dd8544b8c1dbcdf5f">emissi_s</a> - embrd)</div>
<div class="line"><a id="l00922" name="l00922"></a><span class="lineno">  922</span> </div>
<div class="line"><a id="l00923" name="l00923"></a><span class="lineno">  923</span><span class="comment">!     BASE FORMULATION (DICKINSON ET AL., 1986, COGLEY ET AL., 1990)</span></div>
<div class="line"><a id="l00924" name="l00924"></a><span class="lineno">  924</span><span class="comment">!          IF (TSNOW.LE.263.16) THEN</span></div>
<div class="line"><a id="l00925" name="l00925"></a><span class="lineno">  925</span><span class="comment">!            ALBEDO=SNOALB</span></div>
<div class="line"><a id="l00926" name="l00926"></a><span class="lineno">  926</span><span class="comment">!          ELSE</span></div>
<div class="line"><a id="l00927" name="l00927"></a><span class="lineno">  927</span><span class="comment">!            IF (TSNOW.LT.273.16) THEN</span></div>
<div class="line"><a id="l00928" name="l00928"></a><span class="lineno">  928</span><span class="comment">!              TM=0.1*(TSNOW-263.16)</span></div>
<div class="line"><a id="l00929" name="l00929"></a><span class="lineno">  929</span><span class="comment">!              SNOALB1=0.5*((0.9-0.2*(TM**3))+(0.8-0.16*(TM**3)))</span></div>
<div class="line"><a id="l00930" name="l00930"></a><span class="lineno">  930</span><span class="comment">!            ELSE</span></div>
<div class="line"><a id="l00931" name="l00931"></a><span class="lineno">  931</span><span class="comment">!              SNOALB1=0.67</span></div>
<div class="line"><a id="l00932" name="l00932"></a><span class="lineno">  932</span><span class="comment">!             IF(SNCOVR.GT.0.95) SNOALB1= 0.6</span></div>
<div class="line"><a id="l00933" name="l00933"></a><span class="lineno">  933</span><span class="comment">!             SNOALB1 = ALB + SNCOVR*(SNOALB-ALB)</span></div>
<div class="line"><a id="l00934" name="l00934"></a><span class="lineno">  934</span><span class="comment">!            ENDIF</span></div>
<div class="line"><a id="l00935" name="l00935"></a><span class="lineno">  935</span><span class="comment">!          ENDIF</span></div>
<div class="line"><a id="l00936" name="l00936"></a><span class="lineno">  936</span><span class="comment">!            ALBEDO = ALB + SNCOVR*(SNOALB1-ALB)</span></div>
<div class="line"><a id="l00937" name="l00937"></a><span class="lineno">  937</span> </div>
<div class="line"><a id="l00938" name="l00938"></a><span class="lineno">  938</span><span class="comment">!     ISBA FORMULATION (VERSEGHY, 1991; BAKER ET AL., 1990)</span></div>
<div class="line"><a id="l00939" name="l00939"></a><span class="lineno">  939</span><span class="comment">!          SNOALB1 = SNOALB+COEF*(0.85-SNOALB)</span></div>
<div class="line"><a id="l00940" name="l00940"></a><span class="lineno">  940</span><span class="comment">!          SNOALB2=SNOALB1</span></div>
<div class="line"><a id="l00941" name="l00941"></a><span class="lineno">  941</span><span class="comment">!!m          LSTSNW=LSTSNW+1</span></div>
<div class="line"><a id="l00942" name="l00942"></a><span class="lineno">  942</span><span class="comment">!          SNOTIME1 = SNOTIME1 + DT</span></div>
<div class="line"><a id="l00943" name="l00943"></a><span class="lineno">  943</span><span class="comment">!          IF (SNOWNG) THEN</span></div>
<div class="line"><a id="l00944" name="l00944"></a><span class="lineno">  944</span><span class="comment">!             SNOALB2=SNOALB</span></div>
<div class="line"><a id="l00945" name="l00945"></a><span class="lineno">  945</span><span class="comment">!!m             LSTSNW=0</span></div>
<div class="line"><a id="l00946" name="l00946"></a><span class="lineno">  946</span><span class="comment">!             SNOTIME1 = 0.0</span></div>
<div class="line"><a id="l00947" name="l00947"></a><span class="lineno">  947</span><span class="comment">!          ELSE</span></div>
<div class="line"><a id="l00948" name="l00948"></a><span class="lineno">  948</span><span class="comment">!            IF (TSNOW.LT.273.16) THEN</span></div>
<div class="line"><a id="l00949" name="l00949"></a><span class="lineno">  949</span><span class="comment">!!              SNOALB2=SNOALB-0.008*LSTSNW*DT/86400</span></div>
<div class="line"><a id="l00950" name="l00950"></a><span class="lineno">  950</span><span class="comment">!!m              SNOALB2=SNOALB-0.008*SNOTIME1/86400</span></div>
<div class="line"><a id="l00951" name="l00951"></a><span class="lineno">  951</span><span class="comment">!              SNOALB2=(SNOALB2-0.65)*EXP(-0.05*DT/3600)+0.65</span></div>
<div class="line"><a id="l00952" name="l00952"></a><span class="lineno">  952</span><span class="comment">!!              SNOALB2=(ALBEDO-0.65)*EXP(-0.01*DT/3600)+0.65</span></div>
<div class="line"><a id="l00953" name="l00953"></a><span class="lineno">  953</span><span class="comment">!            ELSE</span></div>
<div class="line"><a id="l00954" name="l00954"></a><span class="lineno">  954</span><span class="comment">!              SNOALB2=(SNOALB2-0.5)*EXP(-0.0005*DT/3600)+0.5</span></div>
<div class="line"><a id="l00955" name="l00955"></a><span class="lineno">  955</span><span class="comment">!!              SNOALB2=(SNOALB-0.5)*EXP(-0.24*LSTSNW*DT/86400)+0.5</span></div>
<div class="line"><a id="l00956" name="l00956"></a><span class="lineno">  956</span><span class="comment">!!m              SNOALB2=(SNOALB-0.5)*EXP(-0.24*SNOTIME1/86400)+0.5</span></div>
<div class="line"><a id="l00957" name="l00957"></a><span class="lineno">  957</span><span class="comment">!            ENDIF</span></div>
<div class="line"><a id="l00958" name="l00958"></a><span class="lineno">  958</span><span class="comment">!          ENDIF</span></div>
<div class="line"><a id="l00959" name="l00959"></a><span class="lineno">  959</span><span class="comment">!</span></div>
<div class="line"><a id="l00960" name="l00960"></a><span class="lineno">  960</span><span class="comment">!!               print*,&#39;SNOALB2&#39;,SNOALB2,&#39;ALBEDO&#39;,ALBEDO,&#39;DT&#39;,DT</span></div>
<div class="line"><a id="l00961" name="l00961"></a><span class="lineno">  961</span><span class="comment">!          ALBEDO = ALB + SNCOVR*(SNOALB2-ALB)</span></div>
<div class="line"><a id="l00962" name="l00962"></a><span class="lineno">  962</span><span class="comment">!          IF (ALBEDO .GT. SNOALB2) ALBEDO=SNOALB2</span></div>
<div class="line"><a id="l00963" name="l00963"></a><span class="lineno">  963</span><span class="comment">!!m          LSTSNW1=LSTSNW</span></div>
<div class="line"><a id="l00964" name="l00964"></a><span class="lineno">  964</span><span class="comment">!!          SNOTIME = SNOTIME1</span></div>
<div class="line"><a id="l00965" name="l00965"></a><span class="lineno">  965</span> </div>
<div class="line"><a id="l00966" name="l00966"></a><span class="lineno">  966</span><span class="comment">! formulation by Livneh</span></div>
<div class="line"><a id="l00967" name="l00967"></a><span class="lineno">  967</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00968" name="l00968"></a><span class="lineno">  968</span><span class="comment">! SNOALB IS CONSIDERED AS THE MAXIMUM SNOW ALBEDO FOR NEW SNOW, AT</span></div>
<div class="line"><a id="l00969" name="l00969"></a><span class="lineno">  969</span><span class="comment">! A VALUE OF 85%. SNOW ALBEDO CURVE DEFAULTS ARE FROM BRAS P.263. SHOULD</span></div>
<div class="line"><a id="l00970" name="l00970"></a><span class="lineno">  970</span><span class="comment">! NOT BE CHANGED EXCEPT FOR SERIOUS PROBLEMS WITH SNOW MELT.</span></div>
<div class="line"><a id="l00971" name="l00971"></a><span class="lineno">  971</span><span class="comment">! TO IMPLEMENT ACCUMULATIN PARAMETERS, SNACCA AND SNACCB, ASSERT THAT IT</span></div>
<div class="line"><a id="l00972" name="l00972"></a><span class="lineno">  972</span><span class="comment">! IS INDEED ACCUMULATION SEASON. I.E. THAT SNOW SURFACE TEMP IS BELOW</span></div>
<div class="line"><a id="l00973" name="l00973"></a><span class="lineno">  973</span><span class="comment">! ZERO AND THE DATE FALLS BETWEEN OCTOBER AND FEBRUARY</span></div>
<div class="line"><a id="l00974" name="l00974"></a><span class="lineno">  974</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00975" name="l00975"></a><span class="lineno">  975</span>         snoalb1 = snoalb+lvcoef*(0.85-snoalb)</div>
<div class="line"><a id="l00976" name="l00976"></a><span class="lineno">  976</span>         snoalb2=snoalb1</div>
<div class="line"><a id="l00977" name="l00977"></a><span class="lineno">  977</span><span class="comment">! ---------------- Initial LSTSNW --------------------------------------</span></div>
<div class="line"><a id="l00978" name="l00978"></a><span class="lineno">  978</span>          <span class="keywordflow">IF</span> (snowng) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00979" name="l00979"></a><span class="lineno">  979</span>             snotime1 = 0.</div>
<div class="line"><a id="l00980" name="l00980"></a><span class="lineno">  980</span>          <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l00981" name="l00981"></a><span class="lineno">  981</span>           snotime1=snotime1+dt</div>
<div class="line"><a id="l00982" name="l00982"></a><span class="lineno">  982</span><span class="comment">!               IF (TSNOW.LT.273.16) THEN</span></div>
<div class="line"><a id="l00983" name="l00983"></a><span class="lineno">  983</span>                   snoalb2=snoalb1*(snacca**((snotime1/86400.0)**snaccb))</div>
<div class="line"><a id="l00984" name="l00984"></a><span class="lineno">  984</span><span class="comment">!               ELSE</span></div>
<div class="line"><a id="l00985" name="l00985"></a><span class="lineno">  985</span><span class="comment">!                  SNOALB2 =SNOALB1*(SNTHWA**((SNOTIME1/86400.0)**SNTHWB))</span></div>
<div class="line"><a id="l00986" name="l00986"></a><span class="lineno">  986</span><span class="comment">!               ENDIF</span></div>
<div class="line"><a id="l00987" name="l00987"></a><span class="lineno">  987</span><span class="keywordflow">          ENDIF</span></div>
<div class="line"><a id="l00988" name="l00988"></a><span class="lineno">  988</span><span class="comment">!</span></div>
<div class="line"><a id="l00989" name="l00989"></a><span class="lineno">  989</span>           snoalb2 = max( snoalb2, alb )</div>
<div class="line"><a id="l00990" name="l00990"></a><span class="lineno">  990</span>           albedo = alb + sncovr*(snoalb2-alb)</div>
<div class="line"><a id="l00991" name="l00991"></a><span class="lineno">  991</span>           <span class="keywordflow">IF</span> (albedo .GT. snoalb2) albedo=snoalb2</div>
<div class="line"><a id="l00992" name="l00992"></a><span class="lineno">  992</span> </div>
<div class="line"><a id="l00993" name="l00993"></a><span class="lineno">  993</span><span class="comment">!          IF (TSNOW.LT.273.16) THEN</span></div>
<div class="line"><a id="l00994" name="l00994"></a><span class="lineno">  994</span><span class="comment">!            ALBEDO=SNOALB-0.008*DT/86400</span></div>
<div class="line"><a id="l00995" name="l00995"></a><span class="lineno">  995</span><span class="comment">!          ELSE</span></div>
<div class="line"><a id="l00996" name="l00996"></a><span class="lineno">  996</span><span class="comment">!            ALBEDO=(SNOALB-0.5)*EXP(-0.24*DT/86400)+0.5</span></div>
<div class="line"><a id="l00997" name="l00997"></a><span class="lineno">  997</span><span class="comment">!          ENDIF</span></div>
<div class="line"><a id="l00998" name="l00998"></a><span class="lineno">  998</span> </div>
<div class="line"><a id="l00999" name="l00999"></a><span class="lineno">  999</span><span class="comment">!      IF (ALBEDO &gt; SNOALB) ALBEDO = SNOALB</span></div>
<div class="line"><a id="l01000" name="l01000"></a><span class="lineno"> 1000</span> </div>
<div class="line"><a id="l01001" name="l01001"></a><span class="lineno"> 1001</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01002" name="l01002"></a><span class="lineno"> 1002</span>  <span class="keyword">END SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a7a78bcce992262a6c96711208974f7f1">alcalc</a></div>
<div class="line"><a id="l01003" name="l01003"></a><span class="lineno"> 1003</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01004" name="l01004"></a><span class="lineno"> 1004</span> </div>
<div class="line"><a id="l01005" name="l01005"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#a433b2b986f9e11459dc99a8a99db6ba7"> 1005</a></span>      <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a433b2b986f9e11459dc99a8a99db6ba7">canres</a> (SOLAR,CH,SFCTMP,Q2,SFCPRS,SMC,ZSOIL,NSOIL,       &amp;</div>
<div class="line"><a id="l01006" name="l01006"></a><span class="lineno"> 1006</span>                         SMCWLT,SMCREF,RSMIN,RC,PC,NROOT,Q2SAT,DQSDT2,    &amp;</div>
<div class="line"><a id="l01007" name="l01007"></a><span class="lineno"> 1007</span>                         TOPT,RSMAX,RGL,HS,XLAI,                          &amp;</div>
<div class="line"><a id="l01008" name="l01008"></a><span class="lineno"> 1008</span>                         RCS,RCT,RCQ,RCSOIL,EMISSI)</div>
<div class="line"><a id="l01009" name="l01009"></a><span class="lineno"> 1009</span> </div>
<div class="line"><a id="l01010" name="l01010"></a><span class="lineno"> 1010</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01011" name="l01011"></a><span class="lineno"> 1011</span><span class="comment">! SUBROUTINE CANRES</span></div>
<div class="line"><a id="l01012" name="l01012"></a><span class="lineno"> 1012</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01013" name="l01013"></a><span class="lineno"> 1013</span><span class="comment">! CALCULATE CANOPY RESISTANCE WHICH DEPENDS ON INCOMING SOLAR RADIATION,</span></div>
<div class="line"><a id="l01014" name="l01014"></a><span class="lineno"> 1014</span><span class="comment">! AIR TEMPERATURE, ATMOSPHERIC WATER VAPOR PRESSURE DEFICIT AT THE</span></div>
<div class="line"><a id="l01015" name="l01015"></a><span class="lineno"> 1015</span><span class="comment">! LOWEST MODEL LEVEL, AND SOIL MOISTURE (PREFERABLY UNFROZEN SOIL</span></div>
<div class="line"><a id="l01016" name="l01016"></a><span class="lineno"> 1016</span><span class="comment">! MOISTURE RATHER THAN TOTAL)</span></div>
<div class="line"><a id="l01017" name="l01017"></a><span class="lineno"> 1017</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01018" name="l01018"></a><span class="lineno"> 1018</span><span class="comment">! SOURCE:  JARVIS (1976), NOILHAN AND PLANTON (1989, MWR), JACQUEMIN AND</span></div>
<div class="line"><a id="l01019" name="l01019"></a><span class="lineno"> 1019</span><span class="comment">! NOILHAN (1990, BLM)</span></div>
<div class="line"><a id="l01020" name="l01020"></a><span class="lineno"> 1020</span><span class="comment">! SEE ALSO:  CHEN ET AL (1996, JGR, VOL 101(D3), 7251-7268), EQNS 12-14</span></div>
<div class="line"><a id="l01021" name="l01021"></a><span class="lineno"> 1021</span><span class="comment">! AND TABLE 2 OF SEC. 3.1.2</span></div>
<div class="line"><a id="l01022" name="l01022"></a><span class="lineno"> 1022</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01023" name="l01023"></a><span class="lineno"> 1023</span><span class="comment">! INPUT:</span></div>
<div class="line"><a id="l01024" name="l01024"></a><span class="lineno"> 1024</span><span class="comment">!   SOLAR   INCOMING SOLAR RADIATION</span></div>
<div class="line"><a id="l01025" name="l01025"></a><span class="lineno"> 1025</span><span class="comment">!   CH      SURFACE EXCHANGE COEFFICIENT FOR HEAT AND MOISTURE</span></div>
<div class="line"><a id="l01026" name="l01026"></a><span class="lineno"> 1026</span><span class="comment">!   SFCTMP  AIR TEMPERATURE AT 1ST LEVEL ABOVE GROUND</span></div>
<div class="line"><a id="l01027" name="l01027"></a><span class="lineno"> 1027</span><span class="comment">!   Q2      AIR HUMIDITY AT 1ST LEVEL ABOVE GROUND</span></div>
<div class="line"><a id="l01028" name="l01028"></a><span class="lineno"> 1028</span><span class="comment">!   Q2SAT   SATURATION AIR HUMIDITY AT 1ST LEVEL ABOVE GROUND</span></div>
<div class="line"><a id="l01029" name="l01029"></a><span class="lineno"> 1029</span><span class="comment">!   DQSDT2  SLOPE OF SATURATION HUMIDITY FUNCTION WRT TEMP</span></div>
<div class="line"><a id="l01030" name="l01030"></a><span class="lineno"> 1030</span><span class="comment">!   SFCPRS  SURFACE PRESSURE</span></div>
<div class="line"><a id="l01031" name="l01031"></a><span class="lineno"> 1031</span><span class="comment">!   SMC     VOLUMETRIC SOIL MOISTURE</span></div>
<div class="line"><a id="l01032" name="l01032"></a><span class="lineno"> 1032</span><span class="comment">!   ZSOIL   SOIL DEPTH (NEGATIVE SIGN, AS IT IS BELOW GROUND)</span></div>
<div class="line"><a id="l01033" name="l01033"></a><span class="lineno"> 1033</span><span class="comment">!   NSOIL   NO. OF SOIL LAYERS</span></div>
<div class="line"><a id="l01034" name="l01034"></a><span class="lineno"> 1034</span><span class="comment">!   NROOT   NO. OF SOIL LAYERS IN ROOT ZONE (1.LE.NROOT.LE.NSOIL)</span></div>
<div class="line"><a id="l01035" name="l01035"></a><span class="lineno"> 1035</span><span class="comment">!   XLAI    LEAF AREA INDEX</span></div>
<div class="line"><a id="l01036" name="l01036"></a><span class="lineno"> 1036</span><span class="comment">!   SMCWLT  WILTING POINT</span></div>
<div class="line"><a id="l01037" name="l01037"></a><span class="lineno"> 1037</span><span class="comment">!   SMCREF  REFERENCE SOIL MOISTURE (WHERE SOIL WATER DEFICIT STRESS</span></div>
<div class="line"><a id="l01038" name="l01038"></a><span class="lineno"> 1038</span><span class="comment">!             SETS IN)</span></div>
<div class="line"><a id="l01039" name="l01039"></a><span class="lineno"> 1039</span><span class="comment">! RSMIN, RSMAX, TOPT, RGL, HS ARE CANOPY STRESS PARAMETERS SET IN</span></div>
<div class="line"><a id="l01040" name="l01040"></a><span class="lineno"> 1040</span><span class="comment">!   SURBOUTINE REDPRM</span></div>
<div class="line"><a id="l01041" name="l01041"></a><span class="lineno"> 1041</span><span class="comment">! OUTPUT:</span></div>
<div class="line"><a id="l01042" name="l01042"></a><span class="lineno"> 1042</span><span class="comment">!   PC  PLANT COEFFICIENT</span></div>
<div class="line"><a id="l01043" name="l01043"></a><span class="lineno"> 1043</span><span class="comment">!   RC  CANOPY RESISTANCE</span></div>
<div class="line"><a id="l01044" name="l01044"></a><span class="lineno"> 1044</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01045" name="l01045"></a><span class="lineno"> 1045</span> </div>
<div class="line"><a id="l01046" name="l01046"></a><span class="lineno"> 1046</span>      <span class="keywordtype">IMPLICIT NONE</span></div>
<div class="line"><a id="l01047" name="l01047"></a><span class="lineno"> 1047</span>      <span class="keywordtype">INTEGER</span>, <span class="keywordtype">INTENT(IN)</span> :: NROOT,NSOIL</div>
<div class="line"><a id="l01048" name="l01048"></a><span class="lineno"> 1048</span>      <span class="keywordtype">INTEGER</span>  K</div>
<div class="line"><a id="l01049" name="l01049"></a><span class="lineno"> 1049</span><span class="keywordtype">      REAL</span>,    <span class="keywordtype">INTENT(IN)</span> :: CH,DQSDT2,HS,Q2,Q2SAT,RSMIN,RGL,RSMAX,        &amp;</div>
<div class="line"><a id="l01050" name="l01050"></a><span class="lineno"> 1050</span>                             SFCPRS,SFCTMP,SMCREF,SMCWLT, SOLAR,TOPT,XLAI, &amp;</div>
<div class="line"><a id="l01051" name="l01051"></a><span class="lineno"> 1051</span>                             EMISSI</div>
<div class="line"><a id="l01052" name="l01052"></a><span class="lineno"> 1052</span><span class="keywordtype">      REAL</span>,<span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(IN)</span> :: SMC,ZSOIL</div>
<div class="line"><a id="l01053" name="l01053"></a><span class="lineno"> 1053</span><span class="keywordtype">      REAL</span>,    <span class="keywordtype">INTENT(OUT)</span>:: PC,RC,RCQ,RCS,RCSOIL,RCT</div>
<div class="line"><a id="l01054" name="l01054"></a><span class="lineno"> 1054</span><span class="keywordtype">      REAL</span>                :: DELTA,FF,GX,P,RR</div>
<div class="line"><a id="l01055" name="l01055"></a><span class="lineno"> 1055</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span> ::  PART</div>
<div class="line"><a id="l01056" name="l01056"></a><span class="lineno"> 1056</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">PARAMETER</span>     :: SLV = 2.501000e6</div>
<div class="line"><a id="l01057" name="l01057"></a><span class="lineno"> 1057</span> </div>
<div class="line"><a id="l01058" name="l01058"></a><span class="lineno"> 1058</span> </div>
<div class="line"><a id="l01059" name="l01059"></a><span class="lineno"> 1059</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01060" name="l01060"></a><span class="lineno"> 1060</span><span class="comment">! INITIALIZE CANOPY RESISTANCE MULTIPLIER TERMS.</span></div>
<div class="line"><a id="l01061" name="l01061"></a><span class="lineno"> 1061</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01062" name="l01062"></a><span class="lineno"> 1062</span>      rcs = 0.0</div>
<div class="line"><a id="l01063" name="l01063"></a><span class="lineno"> 1063</span>      rct = 0.0</div>
<div class="line"><a id="l01064" name="l01064"></a><span class="lineno"> 1064</span>      rcq = 0.0</div>
<div class="line"><a id="l01065" name="l01065"></a><span class="lineno"> 1065</span>      rcsoil = 0.0</div>
<div class="line"><a id="l01066" name="l01066"></a><span class="lineno"> 1066</span> </div>
<div class="line"><a id="l01067" name="l01067"></a><span class="lineno"> 1067</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01068" name="l01068"></a><span class="lineno"> 1068</span><span class="comment">! CONTRIBUTION DUE TO INCOMING SOLAR RADIATION</span></div>
<div class="line"><a id="l01069" name="l01069"></a><span class="lineno"> 1069</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01070" name="l01070"></a><span class="lineno"> 1070</span>      rc = 0.0</div>
<div class="line"><a id="l01071" name="l01071"></a><span class="lineno"> 1071</span>      ff = 0.55*2.0* solar / (rgl * xlai)</div>
<div class="line"><a id="l01072" name="l01072"></a><span class="lineno"> 1072</span>      rcs = (ff + rsmin / rsmax) / (1.0+ ff)</div>
<div class="line"><a id="l01073" name="l01073"></a><span class="lineno"> 1073</span> </div>
<div class="line"><a id="l01074" name="l01074"></a><span class="lineno"> 1074</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01075" name="l01075"></a><span class="lineno"> 1075</span><span class="comment">! CONTRIBUTION DUE TO AIR TEMPERATURE AT FIRST MODEL LEVEL ABOVE GROUND</span></div>
<div class="line"><a id="l01076" name="l01076"></a><span class="lineno"> 1076</span><span class="comment">! RCT EXPRESSION FROM NOILHAN AND PLANTON (1989, MWR).</span></div>
<div class="line"><a id="l01077" name="l01077"></a><span class="lineno"> 1077</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01078" name="l01078"></a><span class="lineno"> 1078</span>      rcs = max(rcs,0.0001)</div>
<div class="line"><a id="l01079" name="l01079"></a><span class="lineno"> 1079</span>      rct = 1.0- 0.0016* ( (topt - sfctmp)**2.0)</div>
<div class="line"><a id="l01080" name="l01080"></a><span class="lineno"> 1080</span> </div>
<div class="line"><a id="l01081" name="l01081"></a><span class="lineno"> 1081</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01082" name="l01082"></a><span class="lineno"> 1082</span><span class="comment">! CONTRIBUTION DUE TO VAPOR PRESSURE DEFICIT AT FIRST MODEL LEVEL.</span></div>
<div class="line"><a id="l01083" name="l01083"></a><span class="lineno"> 1083</span><span class="comment">! RCQ EXPRESSION FROM SSIB</span></div>
<div class="line"><a id="l01084" name="l01084"></a><span class="lineno"> 1084</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01085" name="l01085"></a><span class="lineno"> 1085</span>      rct = max(rct,0.0001)</div>
<div class="line"><a id="l01086" name="l01086"></a><span class="lineno"> 1086</span>      rcq = 1.0/ (1.0+ hs * (q2sat - q2))</div>
<div class="line"><a id="l01087" name="l01087"></a><span class="lineno"> 1087</span> </div>
<div class="line"><a id="l01088" name="l01088"></a><span class="lineno"> 1088</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01089" name="l01089"></a><span class="lineno"> 1089</span><span class="comment">! CONTRIBUTION DUE TO SOIL MOISTURE AVAILABILITY.</span></div>
<div class="line"><a id="l01090" name="l01090"></a><span class="lineno"> 1090</span><span class="comment">! DETERMINE CONTRIBUTION FROM EACH SOIL LAYER, THEN ADD THEM UP.</span></div>
<div class="line"><a id="l01091" name="l01091"></a><span class="lineno"> 1091</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01092" name="l01092"></a><span class="lineno"> 1092</span>      rcq = max(rcq,0.01)</div>
<div class="line"><a id="l01093" name="l01093"></a><span class="lineno"> 1093</span>      gx = (smc(1) - smcwlt) / (smcref - smcwlt)</div>
<div class="line"><a id="l01094" name="l01094"></a><span class="lineno"> 1094</span>      <span class="keywordflow">IF</span> (gx  &gt;  1.) gx = 1.</div>
<div class="line"><a id="l01095" name="l01095"></a><span class="lineno"> 1095</span>      <span class="keywordflow">IF</span> (gx  &lt;  0.) gx = 0.</div>
<div class="line"><a id="l01096" name="l01096"></a><span class="lineno"> 1096</span> </div>
<div class="line"><a id="l01097" name="l01097"></a><span class="lineno"> 1097</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01098" name="l01098"></a><span class="lineno"> 1098</span><span class="comment">! USE SOIL DEPTH AS WEIGHTING FACTOR</span></div>
<div class="line"><a id="l01099" name="l01099"></a><span class="lineno"> 1099</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01100" name="l01100"></a><span class="lineno"> 1100</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01101" name="l01101"></a><span class="lineno"> 1101</span><span class="comment">! USE ROOT DISTRIBUTION AS WEIGHTING FACTOR</span></div>
<div class="line"><a id="l01102" name="l01102"></a><span class="lineno"> 1102</span><span class="comment">!      PART(1) = RTDIS(1) * GX</span></div>
<div class="line"><a id="l01103" name="l01103"></a><span class="lineno"> 1103</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01104" name="l01104"></a><span class="lineno"> 1104</span>      part(1) = (zsoil(1)/ zsoil(nroot)) * gx</div>
<div class="line"><a id="l01105" name="l01105"></a><span class="lineno"> 1105</span>      <span class="keywordflow">DO</span> k = 2,nroot</div>
<div class="line"><a id="l01106" name="l01106"></a><span class="lineno"> 1106</span>         gx = (smc(k) - smcwlt) / (smcref - smcwlt)</div>
<div class="line"><a id="l01107" name="l01107"></a><span class="lineno"> 1107</span>         <span class="keywordflow">IF</span> (gx &gt;  1.) gx = 1.</div>
<div class="line"><a id="l01108" name="l01108"></a><span class="lineno"> 1108</span>         <span class="keywordflow">IF</span> (gx &lt;  0.) gx = 0.</div>
<div class="line"><a id="l01109" name="l01109"></a><span class="lineno"> 1109</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01110" name="l01110"></a><span class="lineno"> 1110</span><span class="comment">! USE SOIL DEPTH AS WEIGHTING FACTOR</span></div>
<div class="line"><a id="l01111" name="l01111"></a><span class="lineno"> 1111</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01112" name="l01112"></a><span class="lineno"> 1112</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01113" name="l01113"></a><span class="lineno"> 1113</span><span class="comment">! USE ROOT DISTRIBUTION AS WEIGHTING FACTOR</span></div>
<div class="line"><a id="l01114" name="l01114"></a><span class="lineno"> 1114</span><span class="comment">!        PART(K) = RTDIS(K) * GX</span></div>
<div class="line"><a id="l01115" name="l01115"></a><span class="lineno"> 1115</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01116" name="l01116"></a><span class="lineno"> 1116</span>         part(k) = ( (zsoil(k) - zsoil(k -1))/ zsoil(nroot)) * gx</div>
<div class="line"><a id="l01117" name="l01117"></a><span class="lineno"> 1117</span><span class="keywordflow">      END DO</span></div>
<div class="line"><a id="l01118" name="l01118"></a><span class="lineno"> 1118</span>      <span class="keywordflow">DO</span> k = 1,nroot</div>
<div class="line"><a id="l01119" name="l01119"></a><span class="lineno"> 1119</span>         rcsoil = rcsoil + part(k)</div>
<div class="line"><a id="l01120" name="l01120"></a><span class="lineno"> 1120</span><span class="keywordflow">      END DO</span></div>
<div class="line"><a id="l01121" name="l01121"></a><span class="lineno"> 1121</span> </div>
<div class="line"><a id="l01122" name="l01122"></a><span class="lineno"> 1122</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01123" name="l01123"></a><span class="lineno"> 1123</span><span class="comment">! DETERMINE CANOPY RESISTANCE DUE TO ALL FACTORS.  CONVERT CANOPY</span></div>
<div class="line"><a id="l01124" name="l01124"></a><span class="lineno"> 1124</span><span class="comment">! RESISTANCE (RC) TO PLANT COEFFICIENT (PC) TO BE USED WITH POTENTIAL</span></div>
<div class="line"><a id="l01125" name="l01125"></a><span class="lineno"> 1125</span><span class="comment">! EVAP IN DETERMINING ACTUAL EVAP.  PC IS DETERMINED BY:</span></div>
<div class="line"><a id="l01126" name="l01126"></a><span class="lineno"> 1126</span><span class="comment">!   PC * LINERIZED PENMAN POTENTIAL EVAP =</span></div>
<div class="line"><a id="l01127" name="l01127"></a><span class="lineno"> 1127</span><span class="comment">!   PENMAN-MONTEITH ACTUAL EVAPORATION (CONTAINING RC TERM).</span></div>
<div class="line"><a id="l01128" name="l01128"></a><span class="lineno"> 1128</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01129" name="l01129"></a><span class="lineno"> 1129</span>      rcsoil = max(rcsoil,0.0001)</div>
<div class="line"><a id="l01130" name="l01130"></a><span class="lineno"> 1130</span> </div>
<div class="line"><a id="l01131" name="l01131"></a><span class="lineno"> 1131</span>      rc = rsmin / (xlai * rcs * rct * rcq * rcsoil)</div>
<div class="line"><a id="l01132" name="l01132"></a><span class="lineno"> 1132</span><span class="comment">!      RR = (4.* SIGMA * RD / CP)* (SFCTMP **4.)/ (SFCPRS * CH) + 1.0</span></div>
<div class="line"><a id="l01133" name="l01133"></a><span class="lineno"> 1133</span>      rr = (4.* emissi *<a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a41b56481dda78f3181c7e40721fa79a0">sigma</a> * <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a8df53633c056358bfa76c698ee182f17">rd</a> / cp)* (sfctmp **4.)/ (sfcprs * ch) &amp;</div>
<div class="line"><a id="l01134" name="l01134"></a><span class="lineno"> 1134</span>             + 1.0</div>
<div class="line"><a id="l01135" name="l01135"></a><span class="lineno"> 1135</span> </div>
<div class="line"><a id="l01136" name="l01136"></a><span class="lineno"> 1136</span>      delta = (slv / cp)* dqsdt2</div>
<div class="line"><a id="l01137" name="l01137"></a><span class="lineno"> 1137</span> </div>
<div class="line"><a id="l01138" name="l01138"></a><span class="lineno"> 1138</span>      pc = (rr + delta)/ (rr * (1. + rc * ch) + delta)</div>
<div class="line"><a id="l01139" name="l01139"></a><span class="lineno"> 1139</span> </div>
<div class="line"><a id="l01140" name="l01140"></a><span class="lineno"> 1140</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01141" name="l01141"></a><span class="lineno"> 1141</span>  <span class="keyword">END SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a433b2b986f9e11459dc99a8a99db6ba7">canres</a></div>
<div class="line"><a id="l01142" name="l01142"></a><span class="lineno"> 1142</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01143" name="l01143"></a><span class="lineno"> 1143</span> </div>
<div class="line"><a id="l01144" name="l01144"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#abb6e84ee87a6fdb3281c33e8e8457a04"> 1144</a></span>      <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#abb6e84ee87a6fdb3281c33e8e8457a04">csnow</a> (SNCOND,DSNOW)</div>
<div class="line"><a id="l01145" name="l01145"></a><span class="lineno"> 1145</span> </div>
<div class="line"><a id="l01146" name="l01146"></a><span class="lineno"> 1146</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01147" name="l01147"></a><span class="lineno"> 1147</span><span class="comment">! SUBROUTINE CSNOW</span></div>
<div class="line"><a id="l01148" name="l01148"></a><span class="lineno"> 1148</span><span class="comment">! FUNCTION CSNOW</span></div>
<div class="line"><a id="l01149" name="l01149"></a><span class="lineno"> 1149</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01150" name="l01150"></a><span class="lineno"> 1150</span><span class="comment">! CALCULATE SNOW TERMAL CONDUCTIVITY</span></div>
<div class="line"><a id="l01151" name="l01151"></a><span class="lineno"> 1151</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01152" name="l01152"></a><span class="lineno"> 1152</span>      <span class="keywordtype">IMPLICIT NONE</span></div>
<div class="line"><a id="l01153" name="l01153"></a><span class="lineno"> 1153</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(IN)</span> :: DSNOW</div>
<div class="line"><a id="l01154" name="l01154"></a><span class="lineno"> 1154</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(OUT)</span>:: SNCOND</div>
<div class="line"><a id="l01155" name="l01155"></a><span class="lineno"> 1155</span><span class="keywordtype">      REAL</span>             :: C</div>
<div class="line"><a id="l01156" name="l01156"></a><span class="lineno"> 1156</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">PARAMETER</span>  :: UNIT = 0.11631</div>
<div class="line"><a id="l01157" name="l01157"></a><span class="lineno"> 1157</span> </div>
<div class="line"><a id="l01158" name="l01158"></a><span class="lineno"> 1158</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01159" name="l01159"></a><span class="lineno"> 1159</span><span class="comment">! SNCOND IN UNITS OF CAL/(CM*HR*C), RETURNED IN W/(M*C)</span></div>
<div class="line"><a id="l01160" name="l01160"></a><span class="lineno"> 1160</span><span class="comment">! CSNOW IN UNITS OF CAL/(CM*HR*C), RETURNED IN W/(M*C)</span></div>
<div class="line"><a id="l01161" name="l01161"></a><span class="lineno"> 1161</span><span class="comment">! BASIC VERSION IS DYACHKOVA EQUATION (1960), FOR RANGE 0.1-0.4</span></div>
<div class="line"><a id="l01162" name="l01162"></a><span class="lineno"> 1162</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01163" name="l01163"></a><span class="lineno"> 1163</span>      c = 0.328*10** (2.25* dsnow)</div>
<div class="line"><a id="l01164" name="l01164"></a><span class="lineno"> 1164</span><span class="comment">!      CSNOW=UNIT*C</span></div>
<div class="line"><a id="l01165" name="l01165"></a><span class="lineno"> 1165</span> </div>
<div class="line"><a id="l01166" name="l01166"></a><span class="lineno"> 1166</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01167" name="l01167"></a><span class="lineno"> 1167</span><span class="comment">! DE VAUX EQUATION (1933), IN RANGE 0.1-0.6</span></div>
<div class="line"><a id="l01168" name="l01168"></a><span class="lineno"> 1168</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01169" name="l01169"></a><span class="lineno"> 1169</span><span class="comment">!      SNCOND=0.0293*(1.+100.*DSNOW**2)</span></div>
<div class="line"><a id="l01170" name="l01170"></a><span class="lineno"> 1170</span><span class="comment">!      CSNOW=0.0293*(1.+100.*DSNOW**2)</span></div>
<div class="line"><a id="l01171" name="l01171"></a><span class="lineno"> 1171</span> </div>
<div class="line"><a id="l01172" name="l01172"></a><span class="lineno"> 1172</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01173" name="l01173"></a><span class="lineno"> 1173</span><span class="comment">! E. ANDERSEN FROM FLERCHINGER</span></div>
<div class="line"><a id="l01174" name="l01174"></a><span class="lineno"> 1174</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01175" name="l01175"></a><span class="lineno"> 1175</span><span class="comment">!      SNCOND=0.021+2.51*DSNOW**2</span></div>
<div class="line"><a id="l01176" name="l01176"></a><span class="lineno"> 1176</span><span class="comment">!      CSNOW=0.021+2.51*DSNOW**2</span></div>
<div class="line"><a id="l01177" name="l01177"></a><span class="lineno"> 1177</span> </div>
<div class="line"><a id="l01178" name="l01178"></a><span class="lineno"> 1178</span><span class="comment">!      SNCOND = UNIT * C</span></div>
<div class="line"><a id="l01179" name="l01179"></a><span class="lineno"> 1179</span><span class="comment">! double snow thermal conductivity</span></div>
<div class="line"><a id="l01180" name="l01180"></a><span class="lineno"> 1180</span>      sncond = 2.0 * unit * c</div>
<div class="line"><a id="l01181" name="l01181"></a><span class="lineno"> 1181</span> </div>
<div class="line"><a id="l01182" name="l01182"></a><span class="lineno"> 1182</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01183" name="l01183"></a><span class="lineno"> 1183</span>  <span class="keyword">END SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#abb6e84ee87a6fdb3281c33e8e8457a04">csnow</a></div>
<div class="line"><a id="l01184" name="l01184"></a><span class="lineno"> 1184</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01185" name="l01185"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#a1f4bae7bb5581ef61d8c22e58df4c88f"> 1185</a></span>      <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a1f4bae7bb5581ef61d8c22e58df4c88f">devap</a> (EDIR,ETP1,SMC,ZSOIL,SHDFAC,SMCMAX,BEXP,         &amp;</div>
<div class="line"><a id="l01186" name="l01186"></a><span class="lineno"> 1186</span>                        DKSAT,DWSAT,SMCDRY,SMCREF,SMCWLT,FXEXP)</div>
<div class="line"><a id="l01187" name="l01187"></a><span class="lineno"> 1187</span> </div>
<div class="line"><a id="l01188" name="l01188"></a><span class="lineno"> 1188</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01189" name="l01189"></a><span class="lineno"> 1189</span><span class="comment">! SUBROUTINE DEVAP</span></div>
<div class="line"><a id="l01190" name="l01190"></a><span class="lineno"> 1190</span><span class="comment">! FUNCTION DEVAP</span></div>
<div class="line"><a id="l01191" name="l01191"></a><span class="lineno"> 1191</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01192" name="l01192"></a><span class="lineno"> 1192</span><span class="comment">! CALCULATE DIRECT SOIL EVAPORATION</span></div>
<div class="line"><a id="l01193" name="l01193"></a><span class="lineno"> 1193</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01194" name="l01194"></a><span class="lineno"> 1194</span>      <span class="keywordtype">IMPLICIT NONE</span></div>
<div class="line"><a id="l01195" name="l01195"></a><span class="lineno"> 1195</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(IN)</span> :: ETP1,SMC,BEXP,DKSAT,DWSAT,FXEXP,              &amp;</div>
<div class="line"><a id="l01196" name="l01196"></a><span class="lineno"> 1196</span>                          SHDFAC,SMCDRY,SMCMAX,ZSOIL,SMCREF,SMCWLT</div>
<div class="line"><a id="l01197" name="l01197"></a><span class="lineno"> 1197</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(OUT)</span>:: EDIR</div>
<div class="line"><a id="l01198" name="l01198"></a><span class="lineno"> 1198</span><span class="keywordtype">      REAL</span>             :: FX, SRATIO</div>
<div class="line"><a id="l01199" name="l01199"></a><span class="lineno"> 1199</span> </div>
<div class="line"><a id="l01200" name="l01200"></a><span class="lineno"> 1200</span> </div>
<div class="line"><a id="l01201" name="l01201"></a><span class="lineno"> 1201</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01202" name="l01202"></a><span class="lineno"> 1202</span><span class="comment">! DIRECT EVAP A FUNCTION OF RELATIVE SOIL MOISTURE AVAILABILITY, LINEAR</span></div>
<div class="line"><a id="l01203" name="l01203"></a><span class="lineno"> 1203</span><span class="comment">! WHEN FXEXP=1.</span></div>
<div class="line"><a id="l01204" name="l01204"></a><span class="lineno"> 1204</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01205" name="l01205"></a><span class="lineno"> 1205</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01206" name="l01206"></a><span class="lineno"> 1206</span><span class="comment">! FX &gt; 1 REPRESENTS DEMAND CONTROL</span></div>
<div class="line"><a id="l01207" name="l01207"></a><span class="lineno"> 1207</span><span class="comment">! FX &lt; 1 REPRESENTS FLUX CONTROL</span></div>
<div class="line"><a id="l01208" name="l01208"></a><span class="lineno"> 1208</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01209" name="l01209"></a><span class="lineno"> 1209</span> </div>
<div class="line"><a id="l01210" name="l01210"></a><span class="lineno"> 1210</span>      sratio = (smc - smcdry) / (smcmax - smcdry)</div>
<div class="line"><a id="l01211" name="l01211"></a><span class="lineno"> 1211</span>      <span class="keywordflow">IF</span> (sratio &gt; 0.) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l01212" name="l01212"></a><span class="lineno"> 1212</span>        fx = sratio**fxexp</div>
<div class="line"><a id="l01213" name="l01213"></a><span class="lineno"> 1213</span>        fx = max( min( fx, 1. ) ,0. )</div>
<div class="line"><a id="l01214" name="l01214"></a><span class="lineno"> 1214</span>      <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l01215" name="l01215"></a><span class="lineno"> 1215</span>        fx = 0.</div>
<div class="line"><a id="l01216" name="l01216"></a><span class="lineno"> 1216</span><span class="keywordflow">      ENDIF</span></div>
<div class="line"><a id="l01217" name="l01217"></a><span class="lineno"> 1217</span> </div>
<div class="line"><a id="l01218" name="l01218"></a><span class="lineno"> 1218</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01219" name="l01219"></a><span class="lineno"> 1219</span><span class="comment">! ALLOW FOR THE DIRECT-EVAP-REDUCING EFFECT OF SHADE</span></div>
<div class="line"><a id="l01220" name="l01220"></a><span class="lineno"> 1220</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01221" name="l01221"></a><span class="lineno"> 1221</span>      edir = fx * ( 1.0- shdfac ) * etp1</div>
<div class="line"><a id="l01222" name="l01222"></a><span class="lineno"> 1222</span> </div>
<div class="line"><a id="l01223" name="l01223"></a><span class="lineno"> 1223</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01224" name="l01224"></a><span class="lineno"> 1224</span>  <span class="keyword">END SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a1f4bae7bb5581ef61d8c22e58df4c88f">devap</a></div>
<div class="line"><a id="l01225" name="l01225"></a><span class="lineno"> 1225</span> </div>
<div class="line"><a id="l01226" name="l01226"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#aba39fbf0ed9d113693d485869fc69bad"> 1226</a></span>      <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#aba39fbf0ed9d113693d485869fc69bad">devap_hydro</a> (EDIR,ETP1,SMC,ZSOIL,SHDFAC,SMCMAX,BEXP,         &amp;</div>
<div class="line"><a id="l01227" name="l01227"></a><span class="lineno"> 1227</span>                        DKSAT,DWSAT,SMCDRY,SMCREF,SMCWLT,FXEXP,         &amp;</div>
<div class="line"><a id="l01228" name="l01228"></a><span class="lineno"> 1228</span>                        SFHEAD1RT,ETPND1,DT)</div>
<div class="line"><a id="l01229" name="l01229"></a><span class="lineno"> 1229</span> </div>
<div class="line"><a id="l01230" name="l01230"></a><span class="lineno"> 1230</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01231" name="l01231"></a><span class="lineno"> 1231</span><span class="comment">! SUBROUTINE DEVAP</span></div>
<div class="line"><a id="l01232" name="l01232"></a><span class="lineno"> 1232</span><span class="comment">! FUNCTION DEVAP</span></div>
<div class="line"><a id="l01233" name="l01233"></a><span class="lineno"> 1233</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01234" name="l01234"></a><span class="lineno"> 1234</span><span class="comment">! CALCULATE DIRECT SOIL EVAPORATION</span></div>
<div class="line"><a id="l01235" name="l01235"></a><span class="lineno"> 1235</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01236" name="l01236"></a><span class="lineno"> 1236</span>      <span class="keywordtype">IMPLICIT NONE</span></div>
<div class="line"><a id="l01237" name="l01237"></a><span class="lineno"> 1237</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(IN)</span> :: ETP1,SMC,BEXP,DKSAT,DWSAT,FXEXP,              &amp;</div>
<div class="line"><a id="l01238" name="l01238"></a><span class="lineno"> 1238</span>                          SHDFAC,SMCDRY,SMCMAX,ZSOIL,SMCREF,SMCWLT</div>
<div class="line"><a id="l01239" name="l01239"></a><span class="lineno"> 1239</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(OUT)</span>:: EDIR</div>
<div class="line"><a id="l01240" name="l01240"></a><span class="lineno"> 1240</span><span class="keywordtype">      REAL</span>             :: FX, SRATIO</div>
<div class="line"><a id="l01241" name="l01241"></a><span class="lineno"> 1241</span> </div>
<div class="line"><a id="l01242" name="l01242"></a><span class="lineno"> 1242</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(INOUT)</span> :: SFHEAD1RT,ETPND1</div>
<div class="line"><a id="l01243" name="l01243"></a><span class="lineno"> 1243</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(IN   )</span> :: DT</div>
<div class="line"><a id="l01244" name="l01244"></a><span class="lineno"> 1244</span><span class="keywordtype">       REAL</span>             :: EDIRTMP</div>
<div class="line"><a id="l01245" name="l01245"></a><span class="lineno"> 1245</span> </div>
<div class="line"><a id="l01246" name="l01246"></a><span class="lineno"> 1246</span> </div>
<div class="line"><a id="l01247" name="l01247"></a><span class="lineno"> 1247</span> </div>
<div class="line"><a id="l01248" name="l01248"></a><span class="lineno"> 1248</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01249" name="l01249"></a><span class="lineno"> 1249</span><span class="comment">! DIRECT EVAP A FUNCTION OF RELATIVE SOIL MOISTURE AVAILABILITY, LINEAR</span></div>
<div class="line"><a id="l01250" name="l01250"></a><span class="lineno"> 1250</span><span class="comment">! WHEN FXEXP=1.</span></div>
<div class="line"><a id="l01251" name="l01251"></a><span class="lineno"> 1251</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01252" name="l01252"></a><span class="lineno"> 1252</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01253" name="l01253"></a><span class="lineno"> 1253</span><span class="comment">! FX &gt; 1 REPRESENTS DEMAND CONTROL</span></div>
<div class="line"><a id="l01254" name="l01254"></a><span class="lineno"> 1254</span><span class="comment">! FX &lt; 1 REPRESENTS FLUX CONTROL</span></div>
<div class="line"><a id="l01255" name="l01255"></a><span class="lineno"> 1255</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01256" name="l01256"></a><span class="lineno"> 1256</span> </div>
<div class="line"><a id="l01257" name="l01257"></a><span class="lineno"> 1257</span>      sratio = (smc - smcdry) / (smcmax - smcdry)</div>
<div class="line"><a id="l01258" name="l01258"></a><span class="lineno"> 1258</span>      <span class="keywordflow">IF</span> (sratio &gt; 0.) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l01259" name="l01259"></a><span class="lineno"> 1259</span>        fx = sratio**fxexp</div>
<div class="line"><a id="l01260" name="l01260"></a><span class="lineno"> 1260</span>        fx = max( min( fx, 1. ) ,0. )</div>
<div class="line"><a id="l01261" name="l01261"></a><span class="lineno"> 1261</span>      <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l01262" name="l01262"></a><span class="lineno"> 1262</span>        fx = 0.</div>
<div class="line"><a id="l01263" name="l01263"></a><span class="lineno"> 1263</span><span class="keywordflow">      ENDIF</span></div>
<div class="line"><a id="l01264" name="l01264"></a><span class="lineno"> 1264</span> </div>
<div class="line"><a id="l01265" name="l01265"></a><span class="lineno"> 1265</span><span class="comment">!DJG NDHMS/WRF-Hydro edits... Adjustment for ponded surface water : Reduce ETP1</span></div>
<div class="line"><a id="l01266" name="l01266"></a><span class="lineno"> 1266</span>      edirtmp = 0.</div>
<div class="line"><a id="l01267" name="l01267"></a><span class="lineno"> 1267</span>      etpnd1 = 0.</div>
<div class="line"><a id="l01268" name="l01268"></a><span class="lineno"> 1268</span> </div>
<div class="line"><a id="l01269" name="l01269"></a><span class="lineno"> 1269</span><span class="comment">!DJG NDHMS/WRF-Hydro edits...  Calc Max Potential Dir Evap. (ETP1 units: }=m/s)</span></div>
<div class="line"><a id="l01270" name="l01270"></a><span class="lineno"> 1270</span> </div>
<div class="line"><a id="l01271" name="l01271"></a><span class="lineno"> 1271</span><span class="comment">!DJG NDHMS/WRF-Hydro...currently set ponded water evap to 0.0 until further notice...11/5/2012</span></div>
<div class="line"><a id="l01272" name="l01272"></a><span class="lineno"> 1272</span><span class="comment">!EDIRTMP = ( 1.0- SHDFAC ) * ETP1</span></div>
<div class="line"><a id="l01273" name="l01273"></a><span class="lineno"> 1273</span> </div>
<div class="line"><a id="l01274" name="l01274"></a><span class="lineno"> 1274</span><span class="comment">! Convert all units to (m)</span></div>
<div class="line"><a id="l01275" name="l01275"></a><span class="lineno"> 1275</span><span class="comment">! Convert EDIRTMP  from (kg m{-2} s{-1}=m/s) to (m) ...</span></div>
<div class="line"><a id="l01276" name="l01276"></a><span class="lineno"> 1276</span>      edirtmp = edirtmp * dt</div>
<div class="line"><a id="l01277" name="l01277"></a><span class="lineno"> 1277</span> </div>
<div class="line"><a id="l01278" name="l01278"></a><span class="lineno"> 1278</span><span class="comment">!DJG NDHMS/WRF-Hydro edits... Convert SFHEAD from (mm) to (m) ...</span></div>
<div class="line"><a id="l01279" name="l01279"></a><span class="lineno"> 1279</span>      sfhead1rt=sfhead1rt * 0.001</div>
<div class="line"><a id="l01280" name="l01280"></a><span class="lineno"> 1280</span> </div>
<div class="line"><a id="l01281" name="l01281"></a><span class="lineno"> 1281</span> </div>
<div class="line"><a id="l01282" name="l01282"></a><span class="lineno"> 1282</span> </div>
<div class="line"><a id="l01283" name="l01283"></a><span class="lineno"> 1283</span><span class="comment">!DJG NDHMS/WRF-Hydro edits... Calculate ETPND as reduction in EDIR(TMP)...</span></div>
<div class="line"><a id="l01284" name="l01284"></a><span class="lineno"> 1284</span>      <span class="keywordflow">IF</span> (edirtmp &gt; 0.) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l01285" name="l01285"></a><span class="lineno"> 1285</span>       <span class="keywordflow">IF</span> ( edirtmp &gt; sfhead1rt ) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l01286" name="l01286"></a><span class="lineno"> 1286</span>         etpnd1 = sfhead1rt</div>
<div class="line"><a id="l01287" name="l01287"></a><span class="lineno"> 1287</span>         sfhead1rt=0.</div>
<div class="line"><a id="l01288" name="l01288"></a><span class="lineno"> 1288</span>         edirtmp = edirtmp - etpnd1</div>
<div class="line"><a id="l01289" name="l01289"></a><span class="lineno"> 1289</span>       <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l01290" name="l01290"></a><span class="lineno"> 1290</span>         etpnd1 = edirtmp</div>
<div class="line"><a id="l01291" name="l01291"></a><span class="lineno"> 1291</span>         edirtmp = 0.</div>
<div class="line"><a id="l01292" name="l01292"></a><span class="lineno"> 1292</span>         sfhead1rt = sfhead1rt - etpnd1</div>
<div class="line"><a id="l01293" name="l01293"></a><span class="lineno"> 1293</span><span class="keywordflow">       END IF</span></div>
<div class="line"><a id="l01294" name="l01294"></a><span class="lineno"> 1294</span><span class="keywordflow">      END IF</span></div>
<div class="line"><a id="l01295" name="l01295"></a><span class="lineno"> 1295</span> </div>
<div class="line"><a id="l01296" name="l01296"></a><span class="lineno"> 1296</span><span class="comment">!DJG NDHMS/WRF-Hydro edits... Convert SFHEAD units back to (mm)</span></div>
<div class="line"><a id="l01297" name="l01297"></a><span class="lineno"> 1297</span>      <span class="keywordflow">IF</span> ( sfhead1rt /= 0.) sfhead1rt=sfhead1rt * 1000.</div>
<div class="line"><a id="l01298" name="l01298"></a><span class="lineno"> 1298</span> </div>
<div class="line"><a id="l01299" name="l01299"></a><span class="lineno"> 1299</span><span class="comment">!DJG NDHMS/WRF-Hydro edits...Convert ETPND and EDIRTMP back to (mm/s=kg m{-2} s{-1})</span></div>
<div class="line"><a id="l01300" name="l01300"></a><span class="lineno"> 1300</span>      etpnd1 = etpnd1 / dt</div>
<div class="line"><a id="l01301" name="l01301"></a><span class="lineno"> 1301</span>      edirtmp = edirtmp / dt</div>
<div class="line"><a id="l01302" name="l01302"></a><span class="lineno"> 1302</span><span class="comment">!DEBUG    print *, &quot;After DEVAP...SFCHEAD+ETPND1&quot;,SFHEAD1RT+ETPND1*DT</span></div>
<div class="line"><a id="l01303" name="l01303"></a><span class="lineno"> 1303</span> </div>
<div class="line"><a id="l01304" name="l01304"></a><span class="lineno"> 1304</span> </div>
<div class="line"><a id="l01305" name="l01305"></a><span class="lineno"> 1305</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01306" name="l01306"></a><span class="lineno"> 1306</span><span class="comment">! ALLOW FOR THE DIRECT-EVAP-REDUCING EFFECT OF SHADE</span></div>
<div class="line"><a id="l01307" name="l01307"></a><span class="lineno"> 1307</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01308" name="l01308"></a><span class="lineno"> 1308</span><span class="comment">!DJG NDHMS/WRF-Hydro edits...</span></div>
<div class="line"><a id="l01309" name="l01309"></a><span class="lineno"> 1309</span><span class="comment">!       EDIR = FX * ( 1.0- SHDFAC ) * ETP1</span></div>
<div class="line"><a id="l01310" name="l01310"></a><span class="lineno"> 1310</span>       edir = fx * edirtmp</div>
<div class="line"><a id="l01311" name="l01311"></a><span class="lineno"> 1311</span> </div>
<div class="line"><a id="l01312" name="l01312"></a><span class="lineno"> 1312</span> </div>
<div class="line"><a id="l01313" name="l01313"></a><span class="lineno"> 1313</span> </div>
<div class="line"><a id="l01314" name="l01314"></a><span class="lineno"> 1314</span> </div>
<div class="line"><a id="l01315" name="l01315"></a><span class="lineno"> 1315</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01316" name="l01316"></a><span class="lineno"> 1316</span>  <span class="keyword">END SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#aba39fbf0ed9d113693d485869fc69bad">devap_hydro</a></div>
<div class="line"><a id="l01317" name="l01317"></a><span class="lineno"> 1317</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01318" name="l01318"></a><span class="lineno"> 1318</span> </div>
<div class="line"><a id="l01319" name="l01319"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#ae65310d4c0555dd149f413ff42737077"> 1319</a></span>      <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ae65310d4c0555dd149f413ff42737077">evapo</a> (ETA1,SMC,NSOIL,CMC,ETP1,DT,ZSOIL,               &amp;</div>
<div class="line"><a id="l01320" name="l01320"></a><span class="lineno"> 1320</span>                         SH2O,                                          &amp;</div>
<div class="line"><a id="l01321" name="l01321"></a><span class="lineno"> 1321</span>                         SMCMAX,BEXP,PC,SMCWLT,DKSAT,DWSAT,             &amp;</div>
<div class="line"><a id="l01322" name="l01322"></a><span class="lineno"> 1322</span>                         SMCREF,SHDFAC,CMCMAX,                          &amp;</div>
<div class="line"><a id="l01323" name="l01323"></a><span class="lineno"> 1323</span>                         SMCDRY,CFACTR,                                 &amp;</div>
<div class="line"><a id="l01324" name="l01324"></a><span class="lineno"> 1324</span>                         EDIR,EC,ET,ETT,SFCTMP,Q2,NROOT,RTDIS,FXEXP,    &amp;</div>
<div class="line"><a id="l01325" name="l01325"></a><span class="lineno"> 1325</span>                         SFHEAD1RT,ETPND1)</div>
<div class="line"><a id="l01326" name="l01326"></a><span class="lineno"> 1326</span> </div>
<div class="line"><a id="l01327" name="l01327"></a><span class="lineno"> 1327</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01328" name="l01328"></a><span class="lineno"> 1328</span><span class="comment">! SUBROUTINE EVAPO</span></div>
<div class="line"><a id="l01329" name="l01329"></a><span class="lineno"> 1329</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01330" name="l01330"></a><span class="lineno"> 1330</span><span class="comment">! CALCULATE SOIL MOISTURE FLUX.  THE SOIL MOISTURE CONTENT (SMC - A PER</span></div>
<div class="line"><a id="l01331" name="l01331"></a><span class="lineno"> 1331</span><span class="comment">! UNIT VOLUME MEASUREMENT) IS A DEPENDENT VARIABLE THAT IS UPDATED WITH</span></div>
<div class="line"><a id="l01332" name="l01332"></a><span class="lineno"> 1332</span><span class="comment">! PROGNOSTIC EQNS. THE CANOPY MOISTURE CONTENT (CMC) IS ALSO UPDATED.</span></div>
<div class="line"><a id="l01333" name="l01333"></a><span class="lineno"> 1333</span><span class="comment">! FROZEN GROUND VERSION:  NEW STATES ADDED: SH2O, AND FROZEN GROUND</span></div>
<div class="line"><a id="l01334" name="l01334"></a><span class="lineno"> 1334</span><span class="comment">! CORRECTION FACTOR, FRZFACT AND PARAMETER SLOPE.</span></div>
<div class="line"><a id="l01335" name="l01335"></a><span class="lineno"> 1335</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01336" name="l01336"></a><span class="lineno"> 1336</span>      <span class="keywordtype">IMPLICIT NONE</span></div>
<div class="line"><a id="l01337" name="l01337"></a><span class="lineno"> 1337</span>      <span class="keywordtype">INTEGER</span>, <span class="keywordtype">INTENT(IN)</span>   :: NSOIL, NROOT</div>
<div class="line"><a id="l01338" name="l01338"></a><span class="lineno"> 1338</span>      <span class="keywordtype">INTEGER</span>               :: I,K</div>
<div class="line"><a id="l01339" name="l01339"></a><span class="lineno"> 1339</span><span class="keywordtype">      REAL</span>,    <span class="keywordtype">INTENT(IN)</span>   :: BEXP, CFACTR,CMC,CMCMAX,DKSAT,           &amp;</div>
<div class="line"><a id="l01340" name="l01340"></a><span class="lineno"> 1340</span>                                 DT,DWSAT,ETP1,FXEXP,PC,Q2,SFCTMP,           &amp;</div>
<div class="line"><a id="l01341" name="l01341"></a><span class="lineno"> 1341</span>                                 SHDFAC,SMCDRY,SMCMAX,SMCREF,SMCWLT</div>
<div class="line"><a id="l01342" name="l01342"></a><span class="lineno"> 1342</span><span class="keywordtype">      REAL</span>,    <span class="keywordtype">INTENT(OUT)</span>  :: EC,EDIR,ETA1,ETT</div>
<div class="line"><a id="l01343" name="l01343"></a><span class="lineno"> 1343</span><span class="keywordtype">      REAL</span>                  :: CMC2MS</div>
<div class="line"><a id="l01344" name="l01344"></a><span class="lineno"> 1344</span><span class="keywordtype">      REAL</span>,<span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(IN)</span> :: RTDIS, SMC, SH2O, ZSOIL</div>
<div class="line"><a id="l01345" name="l01345"></a><span class="lineno"> 1345</span><span class="keywordtype">      REAL</span>,<span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(OUT)</span> :: ET</div>
<div class="line"><a id="l01346" name="l01346"></a><span class="lineno"> 1346</span> </div>
<div class="line"><a id="l01347" name="l01347"></a><span class="lineno"> 1347</span><span class="keywordtype">      REAL</span>,   <span class="keywordtype">INTENT(INOUT)</span> :: SFHEAD1RT,ETPND1</div>
<div class="line"><a id="l01348" name="l01348"></a><span class="lineno"> 1348</span> </div>
<div class="line"><a id="l01349" name="l01349"></a><span class="lineno"> 1349</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01350" name="l01350"></a><span class="lineno"> 1350</span><span class="comment">! EXECUTABLE CODE BEGINS HERE IF THE POTENTIAL EVAPOTRANSPIRATION IS</span></div>
<div class="line"><a id="l01351" name="l01351"></a><span class="lineno"> 1351</span><span class="comment">! GREATER THAN ZERO.</span></div>
<div class="line"><a id="l01352" name="l01352"></a><span class="lineno"> 1352</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01353" name="l01353"></a><span class="lineno"> 1353</span>      edir = 0.</div>
<div class="line"><a id="l01354" name="l01354"></a><span class="lineno"> 1354</span>      ec = 0.</div>
<div class="line"><a id="l01355" name="l01355"></a><span class="lineno"> 1355</span>      ett = 0.</div>
<div class="line"><a id="l01356" name="l01356"></a><span class="lineno"> 1356</span>      <span class="keywordflow">DO</span> k = 1,nsoil</div>
<div class="line"><a id="l01357" name="l01357"></a><span class="lineno"> 1357</span>         et(k) = 0.</div>
<div class="line"><a id="l01358" name="l01358"></a><span class="lineno"> 1358</span><span class="keywordflow">      END DO</span></div>
<div class="line"><a id="l01359" name="l01359"></a><span class="lineno"> 1359</span> </div>
<div class="line"><a id="l01360" name="l01360"></a><span class="lineno"> 1360</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01361" name="l01361"></a><span class="lineno"> 1361</span><span class="comment">! RETRIEVE DIRECT EVAPORATION FROM SOIL SURFACE.  CALL THIS FUNCTION</span></div>
<div class="line"><a id="l01362" name="l01362"></a><span class="lineno"> 1362</span><span class="comment">! ONLY IF VEG COVER NOT COMPLETE.</span></div>
<div class="line"><a id="l01363" name="l01363"></a><span class="lineno"> 1363</span><span class="comment">! FROZEN GROUND VERSION:  SH2O STATES REPLACE SMC STATES.</span></div>
<div class="line"><a id="l01364" name="l01364"></a><span class="lineno"> 1364</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01365" name="l01365"></a><span class="lineno"> 1365</span>      <span class="keywordflow">IF</span> (etp1 &gt; 0.0) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l01366" name="l01366"></a><span class="lineno"> 1366</span>         <span class="keywordflow">IF</span> (shdfac &lt;  1.) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l01367" name="l01367"></a><span class="lineno"> 1367</span><span class="preprocessor">#ifdef WRF_HYDRO</span></div>
<div class="line"><a id="l01368" name="l01368"></a><span class="lineno"> 1368</span><span class="preprocessor"></span><span class="comment">!            CALL DEVAP_hydro (EDIR,ETP1,SMC (1),ZSOIL (1),SHDFAC,SMCMAX,      &amp;</span></div>
<div class="line"><a id="l01369" name="l01369"></a><span class="lineno"> 1369</span><span class="comment">!                        BEXP,DKSAT,DWSAT,SMCDRY,SMCREF,SMCWLT,FXEXP,    &amp;</span></div>
<div class="line"><a id="l01370" name="l01370"></a><span class="lineno"> 1370</span><span class="comment">!                         SFHEAD1RT,ETPND1,DT)</span></div>
<div class="line"><a id="l01371" name="l01371"></a><span class="lineno"> 1371</span><span class="comment">!DJG Reduce ETP1 by EDIR &amp; ETPND1...</span></div>
<div class="line"><a id="l01372" name="l01372"></a><span class="lineno"> 1372</span><span class="comment">!                ETP1=ETP1-EDIR-ETPND1</span></div>
<div class="line"><a id="l01373" name="l01373"></a><span class="lineno"> 1373</span> </div>
<div class="line"><a id="l01374" name="l01374"></a><span class="lineno"> 1374</span><span class="comment">! following is the temparay setting ...</span></div>
<div class="line"><a id="l01375" name="l01375"></a><span class="lineno"> 1375</span>             <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a1f4bae7bb5581ef61d8c22e58df4c88f">devap</a> (edir,etp1,smc(1),zsoil(1),shdfac,smcmax,      &amp;</div>
<div class="line"><a id="l01376" name="l01376"></a><span class="lineno"> 1376</span>                         bexp,dksat,dwsat,smcdry,smcref,smcwlt,fxexp)</div>
<div class="line"><a id="l01377" name="l01377"></a><span class="lineno"> 1377</span><span class="comment">!            ETP1=ETP1-EDIR</span></div>
<div class="line"><a id="l01378" name="l01378"></a><span class="lineno"> 1378</span><span class="preprocessor">#else</span></div>
<div class="line"><a id="l01379" name="l01379"></a><span class="lineno"> 1379</span><span class="preprocessor"></span>             <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a1f4bae7bb5581ef61d8c22e58df4c88f">devap</a> (edir,etp1,smc(1),zsoil(1),shdfac,smcmax,      &amp;</div>
<div class="line"><a id="l01380" name="l01380"></a><span class="lineno"> 1380</span>                         bexp,dksat,dwsat,smcdry,smcref,smcwlt,fxexp)</div>
<div class="line"><a id="l01381" name="l01381"></a><span class="lineno"> 1381</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l01382" name="l01382"></a><span class="lineno"> 1382</span><span class="preprocessor"></span><span class="keywordflow">         END IF</span></div>
<div class="line"><a id="l01383" name="l01383"></a><span class="lineno"> 1383</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01384" name="l01384"></a><span class="lineno"> 1384</span><span class="comment">! INITIALIZE PLANT TOTAL TRANSPIRATION, RETRIEVE PLANT TRANSPIRATION,</span></div>
<div class="line"><a id="l01385" name="l01385"></a><span class="lineno"> 1385</span><span class="comment">! AND ACCUMULATE IT FOR ALL SOIL LAYERS.</span></div>
<div class="line"><a id="l01386" name="l01386"></a><span class="lineno"> 1386</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01387" name="l01387"></a><span class="lineno"> 1387</span> </div>
<div class="line"><a id="l01388" name="l01388"></a><span class="lineno"> 1388</span>         <span class="keywordflow">IF</span> (shdfac &gt; 0.0) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l01389" name="l01389"></a><span class="lineno"> 1389</span>            <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#aa418d6be3fc3de942821faf6fb68e3f8">transp</a> (et,nsoil,etp1,sh2o,cmc,zsoil,shdfac,smcwlt,     &amp;</div>
<div class="line"><a id="l01390" name="l01390"></a><span class="lineno"> 1390</span>                          cmcmax,pc,cfactr,smcref,sfctmp,q2,nroot,rtdis)</div>
<div class="line"><a id="l01391" name="l01391"></a><span class="lineno"> 1391</span>            <span class="keywordflow">DO</span> k = 1,nsoil</div>
<div class="line"><a id="l01392" name="l01392"></a><span class="lineno"> 1392</span>               ett = ett + et( k )</div>
<div class="line"><a id="l01393" name="l01393"></a><span class="lineno"> 1393</span><span class="keywordflow">            END DO</span></div>
<div class="line"><a id="l01394" name="l01394"></a><span class="lineno"> 1394</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01395" name="l01395"></a><span class="lineno"> 1395</span><span class="comment">! CALCULATE CANOPY EVAPORATION.</span></div>
<div class="line"><a id="l01396" name="l01396"></a><span class="lineno"> 1396</span><span class="comment">! IF STATEMENTS TO AVOID TANGENT LINEAR PROBLEMS NEAR CMC=0.0.</span></div>
<div class="line"><a id="l01397" name="l01397"></a><span class="lineno"> 1397</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01398" name="l01398"></a><span class="lineno"> 1398</span>            <span class="keywordflow">IF</span> (cmc &gt; 0.0) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l01399" name="l01399"></a><span class="lineno"> 1399</span>               ec = shdfac * ( ( cmc / cmcmax ) ** cfactr ) * etp1</div>
<div class="line"><a id="l01400" name="l01400"></a><span class="lineno"> 1400</span>            <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l01401" name="l01401"></a><span class="lineno"> 1401</span>               ec = 0.0</div>
<div class="line"><a id="l01402" name="l01402"></a><span class="lineno"> 1402</span><span class="keywordflow">            END IF</span></div>
<div class="line"><a id="l01403" name="l01403"></a><span class="lineno"> 1403</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01404" name="l01404"></a><span class="lineno"> 1404</span><span class="comment">! EC SHOULD BE LIMITED BY THE TOTAL AMOUNT OF AVAILABLE WATER ON THE</span></div>
<div class="line"><a id="l01405" name="l01405"></a><span class="lineno"> 1405</span><span class="comment">! CANOPY.  -F.CHEN, 18-OCT-1994</span></div>
<div class="line"><a id="l01406" name="l01406"></a><span class="lineno"> 1406</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01407" name="l01407"></a><span class="lineno"> 1407</span>            cmc2ms = cmc / dt</div>
<div class="line"><a id="l01408" name="l01408"></a><span class="lineno"> 1408</span>            ec = min( cmc2ms, ec )</div>
<div class="line"><a id="l01409" name="l01409"></a><span class="lineno"> 1409</span><span class="keywordflow">         END IF</span></div>
<div class="line"><a id="l01410" name="l01410"></a><span class="lineno"> 1410</span><span class="keywordflow">      END IF</span></div>
<div class="line"><a id="l01411" name="l01411"></a><span class="lineno"> 1411</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01412" name="l01412"></a><span class="lineno"> 1412</span><span class="comment">! TOTAL UP EVAP AND TRANSP TYPES TO OBTAIN ACTUAL EVAPOTRANSP</span></div>
<div class="line"><a id="l01413" name="l01413"></a><span class="lineno"> 1413</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01414" name="l01414"></a><span class="lineno"> 1414</span>      eta1 = edir + ett + ec</div>
<div class="line"><a id="l01415" name="l01415"></a><span class="lineno"> 1415</span> </div>
<div class="line"><a id="l01416" name="l01416"></a><span class="lineno"> 1416</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01417" name="l01417"></a><span class="lineno"> 1417</span>  <span class="keyword">END SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ae65310d4c0555dd149f413ff42737077">evapo</a></div>
<div class="line"><a id="l01418" name="l01418"></a><span class="lineno"> 1418</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01419" name="l01419"></a><span class="lineno"> 1419</span> </div>
<div class="line"><a id="l01420" name="l01420"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#ad15804ed9573673deb4f95b3f160eeb2"> 1420</a></span>  <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ad15804ed9573673deb4f95b3f160eeb2">fac2mit</a>(SMCMAX,FLIMIT)</div>
<div class="line"><a id="l01421" name="l01421"></a><span class="lineno"> 1421</span>    <span class="keywordtype">IMPLICIT NONE</span>       </div>
<div class="line"><a id="l01422" name="l01422"></a><span class="lineno"> 1422</span><span class="keywordtype">    REAL</span>, <span class="keywordtype">INTENT(IN)</span>  :: SMCMAX</div>
<div class="line"><a id="l01423" name="l01423"></a><span class="lineno"> 1423</span><span class="keywordtype">    REAL</span>, <span class="keywordtype">INTENT(OUT)</span> :: FLIMIT</div>
<div class="line"><a id="l01424" name="l01424"></a><span class="lineno"> 1424</span> </div>
<div class="line"><a id="l01425" name="l01425"></a><span class="lineno"> 1425</span>    flimit = 0.90</div>
<div class="line"><a id="l01426" name="l01426"></a><span class="lineno"> 1426</span> </div>
<div class="line"><a id="l01427" name="l01427"></a><span class="lineno"> 1427</span>    <span class="keywordflow">IF</span> ( smcmax == 0.395 ) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l01428" name="l01428"></a><span class="lineno"> 1428</span>       flimit = 0.59</div>
<div class="line"><a id="l01429" name="l01429"></a><span class="lineno"> 1429</span>    <span class="keywordflow">ELSE</span> <span class="keywordflow">IF</span> ( ( smcmax == 0.434 ) .OR. ( smcmax == 0.404 ) ) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l01430" name="l01430"></a><span class="lineno"> 1430</span>       flimit = 0.85</div>
<div class="line"><a id="l01431" name="l01431"></a><span class="lineno"> 1431</span>    <span class="keywordflow">ELSE</span> <span class="keywordflow">IF</span> ( ( smcmax == 0.465 ) .OR. ( smcmax == 0.406 ) ) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l01432" name="l01432"></a><span class="lineno"> 1432</span>       flimit = 0.86</div>
<div class="line"><a id="l01433" name="l01433"></a><span class="lineno"> 1433</span>    <span class="keywordflow">ELSE</span> <span class="keywordflow">IF</span> ( ( smcmax == 0.476 ) .OR. ( smcmax == 0.439 ) ) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l01434" name="l01434"></a><span class="lineno"> 1434</span>       flimit = 0.74</div>
<div class="line"><a id="l01435" name="l01435"></a><span class="lineno"> 1435</span>    <span class="keywordflow">ELSE</span> <span class="keywordflow">IF</span> ( ( smcmax == 0.200 ) .OR. ( smcmax == 0.464 ) ) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l01436" name="l01436"></a><span class="lineno"> 1436</span>       flimit = 0.80</div>
<div class="line"><a id="l01437" name="l01437"></a><span class="lineno"> 1437</span><span class="keywordflow">    ENDIF</span></div>
<div class="line"><a id="l01438" name="l01438"></a><span class="lineno"> 1438</span> </div>
<div class="line"><a id="l01439" name="l01439"></a><span class="lineno"> 1439</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01440" name="l01440"></a><span class="lineno"> 1440</span>  <span class="keyword">END SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ad15804ed9573673deb4f95b3f160eeb2">fac2mit</a></div>
<div class="line"><a id="l01441" name="l01441"></a><span class="lineno"> 1441</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01442" name="l01442"></a><span class="lineno"> 1442</span> </div>
<div class="line"><a id="l01443" name="l01443"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#a5beb42f74e1a357ccfc0e904f356b33a"> 1443</a></span>      <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a5beb42f74e1a357ccfc0e904f356b33a">frh2o</a> (FREE,TKELV,SMC,SH2O,SMCMAX,BEXP,PSIS)</div>
<div class="line"><a id="l01444" name="l01444"></a><span class="lineno"> 1444</span> </div>
<div class="line"><a id="l01445" name="l01445"></a><span class="lineno"> 1445</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01446" name="l01446"></a><span class="lineno"> 1446</span><span class="comment">! SUBROUTINE FRH2O</span></div>
<div class="line"><a id="l01447" name="l01447"></a><span class="lineno"> 1447</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01448" name="l01448"></a><span class="lineno"> 1448</span><span class="comment">! CALCULATE AMOUNT OF SUPERCOOLED LIQUID SOIL WATER CONTENT IF</span></div>
<div class="line"><a id="l01449" name="l01449"></a><span class="lineno"> 1449</span><span class="comment">! TEMPERATURE IS BELOW 273.15K (T0).  REQUIRES NEWTON-TYPE ITERATION TO</span></div>
<div class="line"><a id="l01450" name="l01450"></a><span class="lineno"> 1450</span><span class="comment">! SOLVE THE NONLINEAR IMPLICIT EQUATION GIVEN IN EQN 17 OF KOREN ET AL</span></div>
<div class="line"><a id="l01451" name="l01451"></a><span class="lineno"> 1451</span><span class="comment">! (1999, JGR, VOL 104(D16), 19569-19585).</span></div>
<div class="line"><a id="l01452" name="l01452"></a><span class="lineno"> 1452</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01453" name="l01453"></a><span class="lineno"> 1453</span><span class="comment">! NEW VERSION (JUNE 2001): MUCH FASTER AND MORE ACCURATE NEWTON</span></div>
<div class="line"><a id="l01454" name="l01454"></a><span class="lineno"> 1454</span><span class="comment">! ITERATION ACHIEVED BY FIRST TAKING LOG OF EQN CITED ABOVE -- LESS THAN</span></div>
<div class="line"><a id="l01455" name="l01455"></a><span class="lineno"> 1455</span><span class="comment">! 4 (TYPICALLY 1 OR 2) ITERATIONS ACHIEVES CONVERGENCE.  ALSO, EXPLICIT</span></div>
<div class="line"><a id="l01456" name="l01456"></a><span class="lineno"> 1456</span><span class="comment">! 1-STEP SOLUTION OPTION FOR SPECIAL CASE OF PARAMETER CK=0, WHICH</span></div>
<div class="line"><a id="l01457" name="l01457"></a><span class="lineno"> 1457</span><span class="comment">! REDUCES THE ORIGINAL IMPLICIT EQUATION TO A SIMPLER EXPLICIT FORM,</span></div>
<div class="line"><a id="l01458" name="l01458"></a><span class="lineno"> 1458</span><span class="comment">! KNOWN AS THE &quot;FLERCHINGER EQN&quot;. IMPROVED HANDLING OF SOLUTION IN THE</span></div>
<div class="line"><a id="l01459" name="l01459"></a><span class="lineno"> 1459</span><span class="comment">! LIMIT OF FREEZING POINT TEMPERATURE T0.</span></div>
<div class="line"><a id="l01460" name="l01460"></a><span class="lineno"> 1460</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01461" name="l01461"></a><span class="lineno"> 1461</span><span class="comment">! INPUT:</span></div>
<div class="line"><a id="l01462" name="l01462"></a><span class="lineno"> 1462</span> </div>
<div class="line"><a id="l01463" name="l01463"></a><span class="lineno"> 1463</span><span class="comment">!   TKELV.........TEMPERATURE (Kelvin)</span></div>
<div class="line"><a id="l01464" name="l01464"></a><span class="lineno"> 1464</span><span class="comment">!   SMC...........TOTAL SOIL MOISTURE CONTENT (VOLUMETRIC)</span></div>
<div class="line"><a id="l01465" name="l01465"></a><span class="lineno"> 1465</span><span class="comment">!   SH2O..........LIQUID SOIL MOISTURE CONTENT (VOLUMETRIC)</span></div>
<div class="line"><a id="l01466" name="l01466"></a><span class="lineno"> 1466</span><span class="comment">!   SMCMAX........SATURATION SOIL MOISTURE CONTENT (FROM REDPRM)</span></div>
<div class="line"><a id="l01467" name="l01467"></a><span class="lineno"> 1467</span><span class="comment">!   B.............SOIL TYPE &quot;B&quot; PARAMETER (FROM REDPRM)</span></div>
<div class="line"><a id="l01468" name="l01468"></a><span class="lineno"> 1468</span><span class="comment">!   PSIS..........SATURATED SOIL MATRIC POTENTIAL (FROM REDPRM)</span></div>
<div class="line"><a id="l01469" name="l01469"></a><span class="lineno"> 1469</span> </div>
<div class="line"><a id="l01470" name="l01470"></a><span class="lineno"> 1470</span><span class="comment">! OUTPUT:</span></div>
<div class="line"><a id="l01471" name="l01471"></a><span class="lineno"> 1471</span><span class="comment">!   FRH2O.........SUPERCOOLED LIQUID WATER CONTENT</span></div>
<div class="line"><a id="l01472" name="l01472"></a><span class="lineno"> 1472</span><span class="comment">!   FREE..........SUPERCOOLED LIQUID WATER CONTENT</span></div>
<div class="line"><a id="l01473" name="l01473"></a><span class="lineno"> 1473</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01474" name="l01474"></a><span class="lineno"> 1474</span>      <span class="keywordtype">IMPLICIT NONE</span></div>
<div class="line"><a id="l01475" name="l01475"></a><span class="lineno"> 1475</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(IN)</span>     :: BEXP,PSIS,SH2O,SMC,SMCMAX,TKELV</div>
<div class="line"><a id="l01476" name="l01476"></a><span class="lineno"> 1476</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(OUT)</span>    :: FREE</div>
<div class="line"><a id="l01477" name="l01477"></a><span class="lineno"> 1477</span><span class="keywordtype">      REAL</span>                 :: BX,DENOM,DF,DSWL,FK,SWL,SWLK</div>
<div class="line"><a id="l01478" name="l01478"></a><span class="lineno"> 1478</span>      <span class="keywordtype">INTEGER</span>              :: NLOG,KCOUNT</div>
<div class="line"><a id="l01479" name="l01479"></a><span class="lineno"> 1479</span><span class="comment">!      PARAMETER(CK = 0.0)</span></div>
<div class="line"><a id="l01480" name="l01480"></a><span class="lineno"> 1480</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">PARAMETER</span>      :: CK = 8.0, blim = 5.5, error = 0.005,       &amp;</div>
<div class="line"><a id="l01481" name="l01481"></a><span class="lineno"> 1481</span>                              hlice = 3.335e5, gs = 9.81,dice = 920.0,   &amp;</div>
<div class="line"><a id="l01482" name="l01482"></a><span class="lineno"> 1482</span>                              dh2o = 1000.0, t0 = 273.15</div>
<div class="line"><a id="l01483" name="l01483"></a><span class="lineno"> 1483</span> </div>
<div class="line"><a id="l01484" name="l01484"></a><span class="lineno"> 1484</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01485" name="l01485"></a><span class="lineno"> 1485</span><span class="comment">! LIMITS ON PARAMETER B: B &lt; 5.5  (use parameter BLIM)</span></div>
<div class="line"><a id="l01486" name="l01486"></a><span class="lineno"> 1486</span><span class="comment">! SIMULATIONS SHOWED IF B &gt; 5.5 UNFROZEN WATER CONTENT IS</span></div>
<div class="line"><a id="l01487" name="l01487"></a><span class="lineno"> 1487</span><span class="comment">! NON-REALISTICALLY HIGH AT VERY LOW TEMPERATURES.</span></div>
<div class="line"><a id="l01488" name="l01488"></a><span class="lineno"> 1488</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01489" name="l01489"></a><span class="lineno"> 1489</span>      bx = bexp</div>
<div class="line"><a id="l01490" name="l01490"></a><span class="lineno"> 1490</span> </div>
<div class="line"><a id="l01491" name="l01491"></a><span class="lineno"> 1491</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01492" name="l01492"></a><span class="lineno"> 1492</span><span class="comment">! INITIALIZING ITERATIONS COUNTER AND ITERATIVE SOLUTION FLAG.</span></div>
<div class="line"><a id="l01493" name="l01493"></a><span class="lineno"> 1493</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01494" name="l01494"></a><span class="lineno"> 1494</span>      <span class="keywordflow">IF</span> (bexp &gt;  blim) bx = blim</div>
<div class="line"><a id="l01495" name="l01495"></a><span class="lineno"> 1495</span>      nlog = 0</div>
<div class="line"><a id="l01496" name="l01496"></a><span class="lineno"> 1496</span> </div>
<div class="line"><a id="l01497" name="l01497"></a><span class="lineno"> 1497</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01498" name="l01498"></a><span class="lineno"> 1498</span><span class="comment">!  IF TEMPERATURE NOT SIGNIFICANTLY BELOW FREEZING (T0), SH2O = SMC</span></div>
<div class="line"><a id="l01499" name="l01499"></a><span class="lineno"> 1499</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01500" name="l01500"></a><span class="lineno"> 1500</span>      kcount = 0</div>
<div class="line"><a id="l01501" name="l01501"></a><span class="lineno"> 1501</span><span class="comment">!      FRH2O = SMC</span></div>
<div class="line"><a id="l01502" name="l01502"></a><span class="lineno"> 1502</span>      <span class="keywordflow">IF</span> (tkelv &gt; (t0- 1.e-3)) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l01503" name="l01503"></a><span class="lineno"> 1503</span>          free = smc</div>
<div class="line"><a id="l01504" name="l01504"></a><span class="lineno"> 1504</span>      <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l01505" name="l01505"></a><span class="lineno"> 1505</span> </div>
<div class="line"><a id="l01506" name="l01506"></a><span class="lineno"> 1506</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01507" name="l01507"></a><span class="lineno"> 1507</span><span class="comment">! OPTION 1: ITERATED SOLUTION FOR NONZERO CK</span></div>
<div class="line"><a id="l01508" name="l01508"></a><span class="lineno"> 1508</span><span class="comment">! IN KOREN ET AL, JGR, 1999, EQN 17</span></div>
<div class="line"><a id="l01509" name="l01509"></a><span class="lineno"> 1509</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01510" name="l01510"></a><span class="lineno"> 1510</span><span class="comment">! INITIAL GUESS FOR SWL (frozen content)</span></div>
<div class="line"><a id="l01511" name="l01511"></a><span class="lineno"> 1511</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01512" name="l01512"></a><span class="lineno"> 1512</span>         <span class="keywordflow">IF</span> (ck /= 0.0) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l01513" name="l01513"></a><span class="lineno"> 1513</span>            swl = smc - sh2o</div>
<div class="line"><a id="l01514" name="l01514"></a><span class="lineno"> 1514</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01515" name="l01515"></a><span class="lineno"> 1515</span><span class="comment">! KEEP WITHIN BOUNDS.</span></div>
<div class="line"><a id="l01516" name="l01516"></a><span class="lineno"> 1516</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01517" name="l01517"></a><span class="lineno"> 1517</span>            <span class="keywordflow">IF</span> (swl &gt; (smc -0.02)) swl = smc -0.02</div>
<div class="line"><a id="l01518" name="l01518"></a><span class="lineno"> 1518</span> </div>
<div class="line"><a id="l01519" name="l01519"></a><span class="lineno"> 1519</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01520" name="l01520"></a><span class="lineno"> 1520</span><span class="comment">!  START OF ITERATIONS</span></div>
<div class="line"><a id="l01521" name="l01521"></a><span class="lineno"> 1521</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01522" name="l01522"></a><span class="lineno"> 1522</span>            <span class="keywordflow">IF</span> (swl &lt; 0.) swl = 0.</div>
<div class="line"><a id="l01523" name="l01523"></a><span class="lineno"> 1523</span> 1001       <span class="keywordflow">Continue</span></div>
<div class="line"><a id="l01524" name="l01524"></a><span class="lineno"> 1524</span>              <span class="keywordflow">IF</span> (.NOT.( (nlog &lt; 10) .AND. (kcount == 0)))   <span class="keywordflow">goto</span> 1002</div>
<div class="line"><a id="l01525" name="l01525"></a><span class="lineno"> 1525</span>              nlog = nlog +1</div>
<div class="line"><a id="l01526" name="l01526"></a><span class="lineno"> 1526</span>              df = alog( ( psis * gs / hlice ) * ( ( 1. + ck * swl )**2.) * &amp;</div>
<div class="line"><a id="l01527" name="l01527"></a><span class="lineno"> 1527</span>                   ( smcmax / (smc - swl) )** bx) - alog( - (               &amp;</div>
<div class="line"><a id="l01528" name="l01528"></a><span class="lineno"> 1528</span>                   tkelv - t0)/ tkelv)</div>
<div class="line"><a id="l01529" name="l01529"></a><span class="lineno"> 1529</span>              denom = 2. * ck / ( 1. + ck * swl ) + bx / ( smc - swl )</div>
<div class="line"><a id="l01530" name="l01530"></a><span class="lineno"> 1530</span>              swlk = swl - df / denom</div>
<div class="line"><a id="l01531" name="l01531"></a><span class="lineno"> 1531</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01532" name="l01532"></a><span class="lineno"> 1532</span><span class="comment">! BOUNDS USEFUL FOR MATHEMATICAL SOLUTION.</span></div>
<div class="line"><a id="l01533" name="l01533"></a><span class="lineno"> 1533</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01534" name="l01534"></a><span class="lineno"> 1534</span>              <span class="keywordflow">IF</span> (swlk &gt; (smc -0.02)) swlk = smc - 0.02</div>
<div class="line"><a id="l01535" name="l01535"></a><span class="lineno"> 1535</span>              <span class="keywordflow">IF</span> (swlk &lt; 0.) swlk = 0.</div>
<div class="line"><a id="l01536" name="l01536"></a><span class="lineno"> 1536</span> </div>
<div class="line"><a id="l01537" name="l01537"></a><span class="lineno"> 1537</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01538" name="l01538"></a><span class="lineno"> 1538</span><span class="comment">! MATHEMATICAL SOLUTION BOUNDS APPLIED.</span></div>
<div class="line"><a id="l01539" name="l01539"></a><span class="lineno"> 1539</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01540" name="l01540"></a><span class="lineno"> 1540</span>              dswl = abs(swlk - swl)</div>
<div class="line"><a id="l01541" name="l01541"></a><span class="lineno"> 1541</span> </div>
<div class="line"><a id="l01542" name="l01542"></a><span class="lineno"> 1542</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01543" name="l01543"></a><span class="lineno"> 1543</span><span class="comment">! IF MORE THAN 10 ITERATIONS, USE EXPLICIT METHOD (CK=0 APPROX.)</span></div>
<div class="line"><a id="l01544" name="l01544"></a><span class="lineno"> 1544</span><span class="comment">! WHEN DSWL LESS OR EQ. ERROR, NO MORE ITERATIONS REQUIRED.</span></div>
<div class="line"><a id="l01545" name="l01545"></a><span class="lineno"> 1545</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01546" name="l01546"></a><span class="lineno"> 1546</span>              swl = swlk</div>
<div class="line"><a id="l01547" name="l01547"></a><span class="lineno"> 1547</span>              <span class="keywordflow">IF</span> ( dswl &lt;= error ) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l01548" name="l01548"></a><span class="lineno"> 1548</span>                    kcount = kcount +1</div>
<div class="line"><a id="l01549" name="l01549"></a><span class="lineno"> 1549</span><span class="keywordflow">              END IF</span></div>
<div class="line"><a id="l01550" name="l01550"></a><span class="lineno"> 1550</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01551" name="l01551"></a><span class="lineno"> 1551</span><span class="comment">!  END OF ITERATIONS</span></div>
<div class="line"><a id="l01552" name="l01552"></a><span class="lineno"> 1552</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01553" name="l01553"></a><span class="lineno"> 1553</span><span class="comment">! BOUNDS APPLIED WITHIN DO-BLOCK ARE VALID FOR PHYSICAL SOLUTION.</span></div>
<div class="line"><a id="l01554" name="l01554"></a><span class="lineno"> 1554</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01555" name="l01555"></a><span class="lineno"> 1555</span><span class="comment">!          FRH2O = SMC - SWL</span></div>
<div class="line"><a id="l01556" name="l01556"></a><span class="lineno"> 1556</span>           <span class="keywordflow">goto</span> 1001</div>
<div class="line"><a id="l01557" name="l01557"></a><span class="lineno"> 1557</span> 1002   <span class="keywordflow">continue</span></div>
<div class="line"><a id="l01558" name="l01558"></a><span class="lineno"> 1558</span>           free = smc - swl</div>
<div class="line"><a id="l01559" name="l01559"></a><span class="lineno"> 1559</span><span class="keywordflow">         END IF</span></div>
<div class="line"><a id="l01560" name="l01560"></a><span class="lineno"> 1560</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01561" name="l01561"></a><span class="lineno"> 1561</span><span class="comment">! END OPTION 1</span></div>
<div class="line"><a id="l01562" name="l01562"></a><span class="lineno"> 1562</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01563" name="l01563"></a><span class="lineno"> 1563</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01564" name="l01564"></a><span class="lineno"> 1564</span><span class="comment">! OPTION 2: EXPLICIT SOLUTION FOR FLERCHINGER EQ. i.e. CK=0</span></div>
<div class="line"><a id="l01565" name="l01565"></a><span class="lineno"> 1565</span><span class="comment">! IN KOREN ET AL., JGR, 1999, EQN 17</span></div>
<div class="line"><a id="l01566" name="l01566"></a><span class="lineno"> 1566</span><span class="comment">! APPLY PHYSICAL BOUNDS TO FLERCHINGER SOLUTION</span></div>
<div class="line"><a id="l01567" name="l01567"></a><span class="lineno"> 1567</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01568" name="l01568"></a><span class="lineno"> 1568</span>         <span class="keywordflow">IF</span> (kcount == 0) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l01569" name="l01569"></a><span class="lineno"> 1569</span>             print *,<span class="stringliteral">&#39;Flerchinger USEd in NEW version. Iterations=&#39;</span>,nlog</div>
<div class="line"><a id="l01570" name="l01570"></a><span class="lineno"> 1570</span>                  fk = ( ( (hlice / (gs * ( - psis)))*                    &amp;</div>
<div class="line"><a id="l01571" name="l01571"></a><span class="lineno"> 1571</span>                       ( (tkelv - t0)/ tkelv))** ( -1/ bx))* smcmax</div>
<div class="line"><a id="l01572" name="l01572"></a><span class="lineno"> 1572</span><span class="comment">!            FRH2O = MIN (FK, SMC)</span></div>
<div class="line"><a id="l01573" name="l01573"></a><span class="lineno"> 1573</span>             <span class="keywordflow">IF</span> (fk &lt; 0.02) fk = 0.02</div>
<div class="line"><a id="l01574" name="l01574"></a><span class="lineno"> 1574</span>             free = min(fk, smc)</div>
<div class="line"><a id="l01575" name="l01575"></a><span class="lineno"> 1575</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01576" name="l01576"></a><span class="lineno"> 1576</span><span class="comment">! END OPTION 2</span></div>
<div class="line"><a id="l01577" name="l01577"></a><span class="lineno"> 1577</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01578" name="l01578"></a><span class="lineno"> 1578</span><span class="keywordflow">         END IF</span></div>
<div class="line"><a id="l01579" name="l01579"></a><span class="lineno"> 1579</span><span class="keywordflow">      END IF</span></div>
<div class="line"><a id="l01580" name="l01580"></a><span class="lineno"> 1580</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01581" name="l01581"></a><span class="lineno"> 1581</span>  <span class="keyword">END SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a5beb42f74e1a357ccfc0e904f356b33a">frh2o</a></div>
<div class="line"><a id="l01582" name="l01582"></a><span class="lineno"> 1582</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01583" name="l01583"></a><span class="lineno"> 1583</span> </div>
<div class="line"><a id="l01584" name="l01584"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#af9f7c237f83a49f3981875bf59dd7816"> 1584</a></span>      <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#af9f7c237f83a49f3981875bf59dd7816">hrt</a> (RHSTS,STC,SMC,SMCMAX,NSOIL,ZSOIL,YY,ZZ1,          &amp;</div>
<div class="line"><a id="l01585" name="l01585"></a><span class="lineno"> 1585</span>                       TBOT,ZBOT,PSISAT,SH2O,DT,BEXP,SOILTYP,OPT_THCND, &amp;</div>
<div class="line"><a id="l01586" name="l01586"></a><span class="lineno"> 1586</span>                       F1,DF1,QUARTZ,CSOIL,AI,BI,CI,VEGTYP,ISURBAN      &amp;</div>
<div class="line"><a id="l01587" name="l01587"></a><span class="lineno"> 1587</span>                      ,HCPCT_FASDAS                                     ) <span class="comment">!fasdas</span></div>
<div class="line"><a id="l01588" name="l01588"></a><span class="lineno"> 1588</span> </div>
<div class="line"><a id="l01589" name="l01589"></a><span class="lineno"> 1589</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01590" name="l01590"></a><span class="lineno"> 1590</span><span class="comment">! SUBROUTINE HRT</span></div>
<div class="line"><a id="l01591" name="l01591"></a><span class="lineno"> 1591</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01592" name="l01592"></a><span class="lineno"> 1592</span><span class="comment">! CALCULATE THE RIGHT HAND SIDE OF THE TIME TENDENCY TERM OF THE SOIL</span></div>
<div class="line"><a id="l01593" name="l01593"></a><span class="lineno"> 1593</span><span class="comment">! THERMAL DIFFUSION EQUATION.  ALSO TO COMPUTE ( PREPARE ) THE MATRIX</span></div>
<div class="line"><a id="l01594" name="l01594"></a><span class="lineno"> 1594</span><span class="comment">! COEFFICIENTS FOR THE TRI-DIAGONAL MATRIX OF THE IMPLICIT TIME SCHEME.</span></div>
<div class="line"><a id="l01595" name="l01595"></a><span class="lineno"> 1595</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01596" name="l01596"></a><span class="lineno"> 1596</span>      <span class="keywordtype">IMPLICIT NONE</span></div>
<div class="line"><a id="l01597" name="l01597"></a><span class="lineno"> 1597</span>      <span class="keywordtype">LOGICAL</span>              :: ITAVG</div>
<div class="line"><a id="l01598" name="l01598"></a><span class="lineno"> 1598</span>      <span class="keywordtype">INTEGER</span>, <span class="keywordtype">INTENT(IN)</span>  :: OPT_THCND</div>
<div class="line"><a id="l01599" name="l01599"></a><span class="lineno"> 1599</span>      <span class="keywordtype">INTEGER</span>, <span class="keywordtype">INTENT(IN)</span>  :: NSOIL, VEGTYP, SOILTYP</div>
<div class="line"><a id="l01600" name="l01600"></a><span class="lineno"> 1600</span>      <span class="keywordtype">INTEGER</span>, <span class="keywordtype">INTENT(IN)</span>  :: ISURBAN</div>
<div class="line"><a id="l01601" name="l01601"></a><span class="lineno"> 1601</span>      <span class="keywordtype">INTEGER</span>              :: I, K</div>
<div class="line"><a id="l01602" name="l01602"></a><span class="lineno"> 1602</span> </div>
<div class="line"><a id="l01603" name="l01603"></a><span class="lineno"> 1603</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(IN)</span>     :: BEXP, CSOIL, DF1, DT,F1,PSISAT,QUARTZ,     &amp;</div>
<div class="line"><a id="l01604" name="l01604"></a><span class="lineno"> 1604</span>                              SMCMAX ,TBOT,YY,ZZ1, ZBOT</div>
<div class="line"><a id="l01605" name="l01605"></a><span class="lineno"> 1605</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(IN)</span>   :: SMC,STC,ZSOIL</div>
<div class="line"><a id="l01606" name="l01606"></a><span class="lineno"> 1606</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(INOUT)</span>:: SH2O</div>
<div class="line"><a id="l01607" name="l01607"></a><span class="lineno"> 1607</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(OUT)</span>  :: RHSTS</div>
<div class="line"><a id="l01608" name="l01608"></a><span class="lineno"> 1608</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(OUT)</span>  :: AI, BI,CI</div>
<div class="line"><a id="l01609" name="l01609"></a><span class="lineno"> 1609</span><span class="keywordtype">      REAL</span>                 :: DDZ, DDZ2, DENOM, DF1N, DF1K, DTSDZ,       &amp;</div>
<div class="line"><a id="l01610" name="l01610"></a><span class="lineno"> 1610</span>                              DTSDZ2,HCPCT,QTOT,SSOIL,SICE,TAVG,TBK,     &amp;</div>
<div class="line"><a id="l01611" name="l01611"></a><span class="lineno"> 1611</span>                              TBK1,TSNSR,TSURF,CSOIL_LOC</div>
<div class="line"><a id="l01612" name="l01612"></a><span class="lineno"> 1612</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">PARAMETER</span>      :: T0 = 273.15, cair = 1004.0, <a class="code hl_variable" href="namespacempas__atmphys__constants.html#a08b81a4441d9a2086b9caea75cea1285">cice</a> = 2.106e6,&amp;</div>
<div class="line"><a id="l01613" name="l01613"></a><span class="lineno"> 1613</span>                              ch2o = 4.2e6</div>
<div class="line"><a id="l01614" name="l01614"></a><span class="lineno"> 1614</span> </div>
<div class="line"><a id="l01615" name="l01615"></a><span class="lineno"> 1615</span><span class="comment">!</span></div>
<div class="line"><a id="l01616" name="l01616"></a><span class="lineno"> 1616</span><span class="comment">! FASDAS</span></div>
<div class="line"><a id="l01617" name="l01617"></a><span class="lineno"> 1617</span><span class="comment">!</span></div>
<div class="line"><a id="l01618" name="l01618"></a><span class="lineno"> 1618</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(  OUT)</span>       :: HCPCT_FASDAS</div>
<div class="line"><a id="l01619" name="l01619"></a><span class="lineno"> 1619</span><span class="comment">!</span></div>
<div class="line"><a id="l01620" name="l01620"></a><span class="lineno"> 1620</span><span class="comment">! END FASDAS</span></div>
<div class="line"><a id="l01621" name="l01621"></a><span class="lineno"> 1621</span><span class="comment">!</span></div>
<div class="line"><a id="l01622" name="l01622"></a><span class="lineno"> 1622</span> </div>
<div class="line"><a id="l01623" name="l01623"></a><span class="lineno"> 1623</span><span class="comment">!urban</span></div>
<div class="line"><a id="l01624" name="l01624"></a><span class="lineno"> 1624</span>        <span class="keywordflow">IF</span>( vegtyp == isurban ) <span class="keywordflow">then</span></div>
<div class="line"><a id="l01625" name="l01625"></a><span class="lineno"> 1625</span>            csoil_loc=3.0e6</div>
<div class="line"><a id="l01626" name="l01626"></a><span class="lineno"> 1626</span>        <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l01627" name="l01627"></a><span class="lineno"> 1627</span>            csoil_loc=csoil</div>
<div class="line"><a id="l01628" name="l01628"></a><span class="lineno"> 1628</span><span class="keywordflow">        ENDIF</span></div>
<div class="line"><a id="l01629" name="l01629"></a><span class="lineno"> 1629</span> </div>
<div class="line"><a id="l01630" name="l01630"></a><span class="lineno"> 1630</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01631" name="l01631"></a><span class="lineno"> 1631</span><span class="comment">! INITIALIZE LOGICAL FOR SOIL LAYER TEMPERATURE AVERAGING.</span></div>
<div class="line"><a id="l01632" name="l01632"></a><span class="lineno"> 1632</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01633" name="l01633"></a><span class="lineno"> 1633</span>       itavg = .true.</div>
<div class="line"><a id="l01634" name="l01634"></a><span class="lineno"> 1634</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01635" name="l01635"></a><span class="lineno"> 1635</span><span class="comment">! BEGIN SECTION FOR TOP SOIL LAYER</span></div>
<div class="line"><a id="l01636" name="l01636"></a><span class="lineno"> 1636</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01637" name="l01637"></a><span class="lineno"> 1637</span><span class="comment">! CALC THE HEAT CAPACITY OF THE TOP SOIL LAYER</span></div>
<div class="line"><a id="l01638" name="l01638"></a><span class="lineno"> 1638</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01639" name="l01639"></a><span class="lineno"> 1639</span>      hcpct = sh2o(1)* ch2o + (1.0- smcmax)* csoil_loc + (smcmax - smc(1))&amp;</div>
<div class="line"><a id="l01640" name="l01640"></a><span class="lineno"> 1640</span>       * cair                                                           &amp;</div>
<div class="line"><a id="l01641" name="l01641"></a><span class="lineno"> 1641</span>              + ( smc(1) - sh2o(1) )* <a class="code hl_variable" href="namespacempas__atmphys__constants.html#a08b81a4441d9a2086b9caea75cea1285">cice</a></div>
<div class="line"><a id="l01642" name="l01642"></a><span class="lineno"> 1642</span><span class="comment">!</span></div>
<div class="line"><a id="l01643" name="l01643"></a><span class="lineno"> 1643</span><span class="comment">! FASDAS</span></div>
<div class="line"><a id="l01644" name="l01644"></a><span class="lineno"> 1644</span><span class="comment">!</span></div>
<div class="line"><a id="l01645" name="l01645"></a><span class="lineno"> 1645</span>      hcpct_fasdas = hcpct</div>
<div class="line"><a id="l01646" name="l01646"></a><span class="lineno"> 1646</span><span class="comment">!</span></div>
<div class="line"><a id="l01647" name="l01647"></a><span class="lineno"> 1647</span><span class="comment">! END FASDAS</span></div>
<div class="line"><a id="l01648" name="l01648"></a><span class="lineno"> 1648</span><span class="comment">!</span></div>
<div class="line"><a id="l01649" name="l01649"></a><span class="lineno"> 1649</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01650" name="l01650"></a><span class="lineno"> 1650</span><span class="comment">! CALC THE MATRIX COEFFICIENTS AI, BI, AND CI FOR THE TOP LAYER</span></div>
<div class="line"><a id="l01651" name="l01651"></a><span class="lineno"> 1651</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01652" name="l01652"></a><span class="lineno"> 1652</span>      ddz = 1.0 / ( -0.5 * zsoil(2) )</div>
<div class="line"><a id="l01653" name="l01653"></a><span class="lineno"> 1653</span>      ai(1) = 0.0</div>
<div class="line"><a id="l01654" name="l01654"></a><span class="lineno"> 1654</span>      ci(1) = (df1 * ddz) / (zsoil(1) * hcpct)</div>
<div class="line"><a id="l01655" name="l01655"></a><span class="lineno"> 1655</span> </div>
<div class="line"><a id="l01656" name="l01656"></a><span class="lineno"> 1656</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01657" name="l01657"></a><span class="lineno"> 1657</span><span class="comment">! CALCULATE THE VERTICAL SOIL TEMP GRADIENT BTWN THE 1ST AND 2ND SOIL</span></div>
<div class="line"><a id="l01658" name="l01658"></a><span class="lineno"> 1658</span><span class="comment">! LAYERS.  THEN CALCULATE THE SUBSURFACE HEAT FLUX. USE THE TEMP</span></div>
<div class="line"><a id="l01659" name="l01659"></a><span class="lineno"> 1659</span><span class="comment">! GRADIENT AND SUBSFC HEAT FLUX TO CALC &quot;RIGHT-HAND SIDE TENDENCY</span></div>
<div class="line"><a id="l01660" name="l01660"></a><span class="lineno"> 1660</span><span class="comment">! TERMS&quot;, OR &quot;RHSTS&quot;, FOR TOP SOIL LAYER.</span></div>
<div class="line"><a id="l01661" name="l01661"></a><span class="lineno"> 1661</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01662" name="l01662"></a><span class="lineno"> 1662</span>      bi(1) = - ci(1) + df1 / (0.5 * zsoil(1) * zsoil(1)* hcpct *    &amp;</div>
<div class="line"><a id="l01663" name="l01663"></a><span class="lineno"> 1663</span>       zz1)</div>
<div class="line"><a id="l01664" name="l01664"></a><span class="lineno"> 1664</span>      dtsdz = (stc(1) - stc(2)) / ( -0.5 * zsoil(2))</div>
<div class="line"><a id="l01665" name="l01665"></a><span class="lineno"> 1665</span>      ssoil = df1 * (stc(1) - yy) / (0.5 * zsoil(1) * zz1)</div>
<div class="line"><a id="l01666" name="l01666"></a><span class="lineno"> 1666</span><span class="comment">!      RHSTS(1) = (DF1 * DTSDZ - SSOIL) / (ZSOIL(1) * HCPCT)</span></div>
<div class="line"><a id="l01667" name="l01667"></a><span class="lineno"> 1667</span>      denom = (zsoil(1) * hcpct)</div>
<div class="line"><a id="l01668" name="l01668"></a><span class="lineno"> 1668</span> </div>
<div class="line"><a id="l01669" name="l01669"></a><span class="lineno"> 1669</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01670" name="l01670"></a><span class="lineno"> 1670</span><span class="comment">! NEXT CAPTURE THE VERTICAL DIFFERENCE OF THE HEAT FLUX AT TOP AND</span></div>
<div class="line"><a id="l01671" name="l01671"></a><span class="lineno"> 1671</span><span class="comment">! BOTTOM OF FIRST SOIL LAYER FOR USE IN HEAT FLUX CONSTRAINT APPLIED TO</span></div>
<div class="line"><a id="l01672" name="l01672"></a><span class="lineno"> 1672</span><span class="comment">! POTENTIAL SOIL FREEZING/THAWING IN ROUTINE SNKSRC.</span></div>
<div class="line"><a id="l01673" name="l01673"></a><span class="lineno"> 1673</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01674" name="l01674"></a><span class="lineno"> 1674</span><span class="comment">!      QTOT = SSOIL - DF1*DTSDZ</span></div>
<div class="line"><a id="l01675" name="l01675"></a><span class="lineno"> 1675</span>      rhsts(1) = (df1 * dtsdz - ssoil) / denom</div>
<div class="line"><a id="l01676" name="l01676"></a><span class="lineno"> 1676</span> </div>
<div class="line"><a id="l01677" name="l01677"></a><span class="lineno"> 1677</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01678" name="l01678"></a><span class="lineno"> 1678</span><span class="comment">! CALCULATE FROZEN WATER CONTENT IN 1ST SOIL LAYER.</span></div>
<div class="line"><a id="l01679" name="l01679"></a><span class="lineno"> 1679</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01680" name="l01680"></a><span class="lineno"> 1680</span>      qtot = -1.0* rhsts(1)* denom</div>
<div class="line"><a id="l01681" name="l01681"></a><span class="lineno"> 1681</span> </div>
<div class="line"><a id="l01682" name="l01682"></a><span class="lineno"> 1682</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01683" name="l01683"></a><span class="lineno"> 1683</span><span class="comment">! IF TEMPERATURE AVERAGING INVOKED (ITAVG=TRUE; ELSE SKIP):</span></div>
<div class="line"><a id="l01684" name="l01684"></a><span class="lineno"> 1684</span><span class="comment">! SET TEMP &quot;TSURF&quot; AT TOP OF SOIL COLUMN (FOR USE IN FREEZING SOIL</span></div>
<div class="line"><a id="l01685" name="l01685"></a><span class="lineno"> 1685</span><span class="comment">! PHYSICS LATER IN FUNCTION SUBROUTINE SNKSRC).  IF SNOWPACK CONTENT IS</span></div>
<div class="line"><a id="l01686" name="l01686"></a><span class="lineno"> 1686</span><span class="comment">! ZERO, THEN TSURF EXPRESSION BELOW GIVES TSURF = SKIN TEMP.  IF</span></div>
<div class="line"><a id="l01687" name="l01687"></a><span class="lineno"> 1687</span><span class="comment">! SNOWPACK IS NONZERO (HENCE ARGUMENT ZZ1=1), THEN TSURF EXPRESSION</span></div>
<div class="line"><a id="l01688" name="l01688"></a><span class="lineno"> 1688</span><span class="comment">! BELOW YIELDS SOIL COLUMN TOP TEMPERATURE UNDER SNOWPACK.  THEN</span></div>
<div class="line"><a id="l01689" name="l01689"></a><span class="lineno"> 1689</span><span class="comment">! CALCULATE TEMPERATURE AT BOTTOM INTERFACE OF 1ST SOIL LAYER FOR USE</span></div>
<div class="line"><a id="l01690" name="l01690"></a><span class="lineno"> 1690</span><span class="comment">! LATER IN FUNCTION SUBROUTINE SNKSRC</span></div>
<div class="line"><a id="l01691" name="l01691"></a><span class="lineno"> 1691</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01692" name="l01692"></a><span class="lineno"> 1692</span>      sice = smc(1) - sh2o(1)</div>
<div class="line"><a id="l01693" name="l01693"></a><span class="lineno"> 1693</span>      <span class="keywordflow">IF</span> (itavg) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l01694" name="l01694"></a><span class="lineno"> 1694</span>         tsurf = (yy + (zz1-1) * stc(1)) / zz1</div>
<div class="line"><a id="l01695" name="l01695"></a><span class="lineno"> 1695</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01696" name="l01696"></a><span class="lineno"> 1696</span><span class="comment">! IF FROZEN WATER PRESENT OR ANY OF LAYER-1 MID-POINT OR BOUNDING</span></div>
<div class="line"><a id="l01697" name="l01697"></a><span class="lineno"> 1697</span><span class="comment">! INTERFACE TEMPERATURES BELOW FREEZING, THEN CALL SNKSRC TO</span></div>
<div class="line"><a id="l01698" name="l01698"></a><span class="lineno"> 1698</span><span class="comment">! COMPUTE HEAT SOURCE/SINK (AND CHANGE IN FROZEN WATER CONTENT)</span></div>
<div class="line"><a id="l01699" name="l01699"></a><span class="lineno"> 1699</span><span class="comment">! DUE TO POSSIBLE SOIL WATER PHASE CHANGE</span></div>
<div class="line"><a id="l01700" name="l01700"></a><span class="lineno"> 1700</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01701" name="l01701"></a><span class="lineno"> 1701</span>         <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a578d0dc05848d5bc7fb823e379da5cdd">tbnd</a> (stc(1),stc(2),zsoil,zbot,1,nsoil,tbk)</div>
<div class="line"><a id="l01702" name="l01702"></a><span class="lineno"> 1702</span>         <span class="keywordflow">IF</span> ( (sice &gt; 0.) .OR. (stc(1) &lt; t0) .OR.                         &amp;</div>
<div class="line"><a id="l01703" name="l01703"></a><span class="lineno"> 1703</span>            (tsurf &lt; t0) .OR. (tbk &lt; t0) ) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l01704" name="l01704"></a><span class="lineno"> 1704</span><span class="comment">!          TSNSR = SNKSRC (TAVG,SMC(1),SH2O(1),</span></div>
<div class="line"><a id="l01705" name="l01705"></a><span class="lineno"> 1705</span>            <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ab786b4f52dbea2106470993f2ea20e69">tmpavg</a> (tavg,tsurf,stc(1),tbk,zsoil,nsoil,1)</div>
<div class="line"><a id="l01706" name="l01706"></a><span class="lineno"> 1706</span>            <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a5d089c57c48085d25b95857c682922da">snksrc</a> (tsnsr,tavg,smc(1),sh2o(1),                      &amp;</div>
<div class="line"><a id="l01707" name="l01707"></a><span class="lineno"> 1707</span>                          zsoil,nsoil,smcmax,psisat,bexp,dt,1,qtot)</div>
<div class="line"><a id="l01708" name="l01708"></a><span class="lineno"> 1708</span><span class="comment">!          RHSTS(1) = RHSTS(1) - TSNSR / ( ZSOIL(1) * HCPCT )</span></div>
<div class="line"><a id="l01709" name="l01709"></a><span class="lineno"> 1709</span>            rhsts(1) = rhsts(1) - tsnsr / denom</div>
<div class="line"><a id="l01710" name="l01710"></a><span class="lineno"> 1710</span><span class="keywordflow">         END IF</span></div>
<div class="line"><a id="l01711" name="l01711"></a><span class="lineno"> 1711</span>      <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l01712" name="l01712"></a><span class="lineno"> 1712</span><span class="comment">!          TSNSR = SNKSRC (STC(1),SMC(1),SH2O(1),</span></div>
<div class="line"><a id="l01713" name="l01713"></a><span class="lineno"> 1713</span>         <span class="keywordflow">IF</span> ( (sice &gt; 0.) .OR. (stc(1) &lt; t0) ) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l01714" name="l01714"></a><span class="lineno"> 1714</span>            <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a5d089c57c48085d25b95857c682922da">snksrc</a> (tsnsr,stc(1),smc(1),sh2o(1),                   &amp;</div>
<div class="line"><a id="l01715" name="l01715"></a><span class="lineno"> 1715</span>                          zsoil,nsoil,smcmax,psisat,bexp,dt,1,qtot)</div>
<div class="line"><a id="l01716" name="l01716"></a><span class="lineno"> 1716</span><span class="comment">!          RHSTS(1) = RHSTS(1) - TSNSR / ( ZSOIL(1) * HCPCT )</span></div>
<div class="line"><a id="l01717" name="l01717"></a><span class="lineno"> 1717</span>            rhsts(1) = rhsts(1) - tsnsr / denom</div>
<div class="line"><a id="l01718" name="l01718"></a><span class="lineno"> 1718</span><span class="keywordflow">         END IF</span></div>
<div class="line"><a id="l01719" name="l01719"></a><span class="lineno"> 1719</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01720" name="l01720"></a><span class="lineno"> 1720</span><span class="comment">! THIS ENDS SECTION FOR TOP SOIL LAYER.</span></div>
<div class="line"><a id="l01721" name="l01721"></a><span class="lineno"> 1721</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01722" name="l01722"></a><span class="lineno"> 1722</span><span class="keywordflow">      END IF</span></div>
<div class="line"><a id="l01723" name="l01723"></a><span class="lineno"> 1723</span> </div>
<div class="line"><a id="l01724" name="l01724"></a><span class="lineno"> 1724</span><span class="comment">! INITIALIZE DDZ2</span></div>
<div class="line"><a id="l01725" name="l01725"></a><span class="lineno"> 1725</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01726" name="l01726"></a><span class="lineno"> 1726</span> </div>
<div class="line"><a id="l01727" name="l01727"></a><span class="lineno"> 1727</span>      ddz2 = 0.0</div>
<div class="line"><a id="l01728" name="l01728"></a><span class="lineno"> 1728</span>      df1k = df1</div>
<div class="line"><a id="l01729" name="l01729"></a><span class="lineno"> 1729</span> </div>
<div class="line"><a id="l01730" name="l01730"></a><span class="lineno"> 1730</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01731" name="l01731"></a><span class="lineno"> 1731</span><span class="comment">! LOOP THRU THE REMAINING SOIL LAYERS, REPEATING THE ABOVE PROCESS</span></div>
<div class="line"><a id="l01732" name="l01732"></a><span class="lineno"> 1732</span><span class="comment">! (EXCEPT SUBSFC OR &quot;GROUND&quot; HEAT FLUX NOT REPEATED IN LOWER LAYERS)</span></div>
<div class="line"><a id="l01733" name="l01733"></a><span class="lineno"> 1733</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01734" name="l01734"></a><span class="lineno"> 1734</span><span class="comment">! CALCULATE HEAT CAPACITY FOR THIS SOIL LAYER.</span></div>
<div class="line"><a id="l01735" name="l01735"></a><span class="lineno"> 1735</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01736" name="l01736"></a><span class="lineno"> 1736</span>      <span class="keywordflow">DO</span> k = 2,nsoil</div>
<div class="line"><a id="l01737" name="l01737"></a><span class="lineno"> 1737</span>         hcpct = sh2o(k)* ch2o + (1.0- smcmax)* csoil_loc + (smcmax - smc(  &amp;</div>
<div class="line"><a id="l01738" name="l01738"></a><span class="lineno"> 1738</span>                k))* cair + ( smc(k) - sh2o(k) )* <a class="code hl_variable" href="namespacempas__atmphys__constants.html#a08b81a4441d9a2086b9caea75cea1285">cice</a></div>
<div class="line"><a id="l01739" name="l01739"></a><span class="lineno"> 1739</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01740" name="l01740"></a><span class="lineno"> 1740</span><span class="comment">! THIS SECTION FOR LAYER 2 OR GREATER, BUT NOT LAST LAYER.</span></div>
<div class="line"><a id="l01741" name="l01741"></a><span class="lineno"> 1741</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01742" name="l01742"></a><span class="lineno"> 1742</span><span class="comment">! CALCULATE THERMAL DIFFUSIVITY FOR THIS LAYER.</span></div>
<div class="line"><a id="l01743" name="l01743"></a><span class="lineno"> 1743</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01744" name="l01744"></a><span class="lineno"> 1744</span>         <span class="keywordflow">IF</span> (k /= nsoil) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l01745" name="l01745"></a><span class="lineno"> 1745</span> </div>
<div class="line"><a id="l01746" name="l01746"></a><span class="lineno"> 1746</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01747" name="l01747"></a><span class="lineno"> 1747</span><span class="comment">! CALC THE VERTICAL SOIL TEMP GRADIENT THRU THIS LAYER</span></div>
<div class="line"><a id="l01748" name="l01748"></a><span class="lineno"> 1748</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01749" name="l01749"></a><span class="lineno"> 1749</span>            <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a7946ddfb3b6fc624a9e87acbfa08fe1b">tdfcnd</a> (df1n,smc(k),quartz,smcmax,sh2o(k),bexp, psisat, soiltyp, opt_thcnd)</div>
<div class="line"><a id="l01750" name="l01750"></a><span class="lineno"> 1750</span> </div>
<div class="line"><a id="l01751" name="l01751"></a><span class="lineno"> 1751</span><span class="comment">!urban</span></div>
<div class="line"><a id="l01752" name="l01752"></a><span class="lineno"> 1752</span>       <span class="keywordflow">IF</span> ( vegtyp == isurban ) df1n = 3.24</div>
<div class="line"><a id="l01753" name="l01753"></a><span class="lineno"> 1753</span> </div>
<div class="line"><a id="l01754" name="l01754"></a><span class="lineno"> 1754</span>            denom = 0.5 * ( zsoil(k -1) - zsoil(k +1) )</div>
<div class="line"><a id="l01755" name="l01755"></a><span class="lineno"> 1755</span> </div>
<div class="line"><a id="l01756" name="l01756"></a><span class="lineno"> 1756</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01757" name="l01757"></a><span class="lineno"> 1757</span><span class="comment">! CALC THE MATRIX COEF, CI, AFTER CALC&#39;NG ITS PARTIAL PRODUCT</span></div>
<div class="line"><a id="l01758" name="l01758"></a><span class="lineno"> 1758</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01759" name="l01759"></a><span class="lineno"> 1759</span>            dtsdz2 = ( stc(k) - stc(k +1) ) / denom</div>
<div class="line"><a id="l01760" name="l01760"></a><span class="lineno"> 1760</span>            ddz2 = 2. / (zsoil(k -1) - zsoil(k +1))</div>
<div class="line"><a id="l01761" name="l01761"></a><span class="lineno"> 1761</span> </div>
<div class="line"><a id="l01762" name="l01762"></a><span class="lineno"> 1762</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01763" name="l01763"></a><span class="lineno"> 1763</span><span class="comment">! IF TEMPERATURE AVERAGING INVOKED (ITAVG=TRUE; ELSE SKIP):  CALCULATE</span></div>
<div class="line"><a id="l01764" name="l01764"></a><span class="lineno"> 1764</span><span class="comment">! TEMP AT BOTTOM OF LAYER.</span></div>
<div class="line"><a id="l01765" name="l01765"></a><span class="lineno"> 1765</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01766" name="l01766"></a><span class="lineno"> 1766</span>            ci(k) = - df1n * ddz2 / ( (zsoil(k -1) - zsoil(k)) *      &amp;</div>
<div class="line"><a id="l01767" name="l01767"></a><span class="lineno"> 1767</span>       hcpct)</div>
<div class="line"><a id="l01768" name="l01768"></a><span class="lineno"> 1768</span>            <span class="keywordflow">IF</span> (itavg) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l01769" name="l01769"></a><span class="lineno"> 1769</span>               <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a578d0dc05848d5bc7fb823e379da5cdd">tbnd</a> (stc(k),stc(k +1),zsoil,zbot,k,nsoil,tbk1)</div>
<div class="line"><a id="l01770" name="l01770"></a><span class="lineno"> 1770</span><span class="keywordflow">            END IF</span></div>
<div class="line"><a id="l01771" name="l01771"></a><span class="lineno"> 1771</span> </div>
<div class="line"><a id="l01772" name="l01772"></a><span class="lineno"> 1772</span>         <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l01773" name="l01773"></a><span class="lineno"> 1773</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01774" name="l01774"></a><span class="lineno"> 1774</span><span class="comment">! SPECIAL CASE OF BOTTOM SOIL LAYER:  CALCULATE THERMAL DIFFUSIVITY FOR</span></div>
<div class="line"><a id="l01775" name="l01775"></a><span class="lineno"> 1775</span><span class="comment">! BOTTOM LAYER.</span></div>
<div class="line"><a id="l01776" name="l01776"></a><span class="lineno"> 1776</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01777" name="l01777"></a><span class="lineno"> 1777</span> </div>
<div class="line"><a id="l01778" name="l01778"></a><span class="lineno"> 1778</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01779" name="l01779"></a><span class="lineno"> 1779</span><span class="comment">! CALC THE VERTICAL SOIL TEMP GRADIENT THRU BOTTOM LAYER.</span></div>
<div class="line"><a id="l01780" name="l01780"></a><span class="lineno"> 1780</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01781" name="l01781"></a><span class="lineno"> 1781</span>            <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a7946ddfb3b6fc624a9e87acbfa08fe1b">tdfcnd</a> (df1n,smc(k),quartz,smcmax,sh2o(k),bexp, psisat, soiltyp, opt_thcnd)</div>
<div class="line"><a id="l01782" name="l01782"></a><span class="lineno"> 1782</span> </div>
<div class="line"><a id="l01783" name="l01783"></a><span class="lineno"> 1783</span> </div>
<div class="line"><a id="l01784" name="l01784"></a><span class="lineno"> 1784</span><span class="comment">!urban</span></div>
<div class="line"><a id="l01785" name="l01785"></a><span class="lineno"> 1785</span>       <span class="keywordflow">IF</span> ( vegtyp == isurban ) df1n = 3.24</div>
<div class="line"><a id="l01786" name="l01786"></a><span class="lineno"> 1786</span> </div>
<div class="line"><a id="l01787" name="l01787"></a><span class="lineno"> 1787</span>            denom = .5 * (zsoil(k -1) + zsoil(k)) - zbot</div>
<div class="line"><a id="l01788" name="l01788"></a><span class="lineno"> 1788</span> </div>
<div class="line"><a id="l01789" name="l01789"></a><span class="lineno"> 1789</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01790" name="l01790"></a><span class="lineno"> 1790</span><span class="comment">! SET MATRIX COEF, CI TO ZERO IF BOTTOM LAYER.</span></div>
<div class="line"><a id="l01791" name="l01791"></a><span class="lineno"> 1791</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01792" name="l01792"></a><span class="lineno"> 1792</span>            dtsdz2 = (stc(k) - tbot) / denom</div>
<div class="line"><a id="l01793" name="l01793"></a><span class="lineno"> 1793</span> </div>
<div class="line"><a id="l01794" name="l01794"></a><span class="lineno"> 1794</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01795" name="l01795"></a><span class="lineno"> 1795</span><span class="comment">! IF TEMPERATURE AVERAGING INVOKED (ITAVG=TRUE; ELSE SKIP):  CALCULATE</span></div>
<div class="line"><a id="l01796" name="l01796"></a><span class="lineno"> 1796</span><span class="comment">! TEMP AT BOTTOM OF LAST LAYER.</span></div>
<div class="line"><a id="l01797" name="l01797"></a><span class="lineno"> 1797</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01798" name="l01798"></a><span class="lineno"> 1798</span>            ci(k) = 0.</div>
<div class="line"><a id="l01799" name="l01799"></a><span class="lineno"> 1799</span>            <span class="keywordflow">IF</span> (itavg) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l01800" name="l01800"></a><span class="lineno"> 1800</span>               <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a578d0dc05848d5bc7fb823e379da5cdd">tbnd</a> (stc(k),tbot,zsoil,zbot,k,nsoil,tbk1)</div>
<div class="line"><a id="l01801" name="l01801"></a><span class="lineno"> 1801</span><span class="keywordflow">            END IF</span></div>
<div class="line"><a id="l01802" name="l01802"></a><span class="lineno"> 1802</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01803" name="l01803"></a><span class="lineno"> 1803</span><span class="comment">! THIS ENDS SPECIAL LOOP FOR BOTTOM LAYER.</span></div>
<div class="line"><a id="l01804" name="l01804"></a><span class="lineno"> 1804</span><span class="keywordflow">         END IF</span></div>
<div class="line"><a id="l01805" name="l01805"></a><span class="lineno"> 1805</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01806" name="l01806"></a><span class="lineno"> 1806</span><span class="comment">! CALCULATE RHSTS FOR THIS LAYER AFTER CALC&#39;NG A PARTIAL PRODUCT.</span></div>
<div class="line"><a id="l01807" name="l01807"></a><span class="lineno"> 1807</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01808" name="l01808"></a><span class="lineno"> 1808</span>         denom = ( zsoil(k) - zsoil(k -1) ) * hcpct</div>
<div class="line"><a id="l01809" name="l01809"></a><span class="lineno"> 1809</span>         rhsts(k) = ( df1n * dtsdz2- df1k * dtsdz ) / denom</div>
<div class="line"><a id="l01810" name="l01810"></a><span class="lineno"> 1810</span>         qtot = -1.0* denom * rhsts(k)</div>
<div class="line"><a id="l01811" name="l01811"></a><span class="lineno"> 1811</span> </div>
<div class="line"><a id="l01812" name="l01812"></a><span class="lineno"> 1812</span>         sice = smc(k) - sh2o(k)</div>
<div class="line"><a id="l01813" name="l01813"></a><span class="lineno"> 1813</span>         <span class="keywordflow">IF</span> (itavg) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l01814" name="l01814"></a><span class="lineno"> 1814</span>            <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ab786b4f52dbea2106470993f2ea20e69">tmpavg</a> (tavg,tbk,stc(k),tbk1,zsoil,nsoil,k)</div>
<div class="line"><a id="l01815" name="l01815"></a><span class="lineno"> 1815</span><span class="comment">!            TSNSR = SNKSRC(TAVG,SMC(K),SH2O(K),ZSOIL,NSOIL,</span></div>
<div class="line"><a id="l01816" name="l01816"></a><span class="lineno"> 1816</span>            <span class="keywordflow">IF</span> ( (sice &gt; 0.) .OR. (stc(k) &lt; t0) .OR.                   &amp;</div>
<div class="line"><a id="l01817" name="l01817"></a><span class="lineno"> 1817</span>               (tbk .lt. t0) .OR. (tbk1 .lt. t0) ) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l01818" name="l01818"></a><span class="lineno"> 1818</span>               <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a5d089c57c48085d25b95857c682922da">snksrc</a> (tsnsr,tavg,smc(k),sh2o(k),zsoil,nsoil,    &amp;</div>
<div class="line"><a id="l01819" name="l01819"></a><span class="lineno"> 1819</span>                             smcmax,psisat,bexp,dt,k,qtot)</div>
<div class="line"><a id="l01820" name="l01820"></a><span class="lineno"> 1820</span>               rhsts(k) = rhsts(k) - tsnsr / denom</div>
<div class="line"><a id="l01821" name="l01821"></a><span class="lineno"> 1821</span><span class="keywordflow">            END IF</span></div>
<div class="line"><a id="l01822" name="l01822"></a><span class="lineno"> 1822</span>         <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l01823" name="l01823"></a><span class="lineno"> 1823</span><span class="comment">!            TSNSR = SNKSRC(STC(K),SMC(K),SH2O(K),ZSOIL,NSOIL,</span></div>
<div class="line"><a id="l01824" name="l01824"></a><span class="lineno"> 1824</span>            <span class="keywordflow">IF</span> ( (sice &gt; 0.) .OR. (stc(k) &lt; t0) ) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l01825" name="l01825"></a><span class="lineno"> 1825</span>               <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a5d089c57c48085d25b95857c682922da">snksrc</a> (tsnsr,stc(k),smc(k),sh2o(k),zsoil,nsoil, &amp;</div>
<div class="line"><a id="l01826" name="l01826"></a><span class="lineno"> 1826</span>                             smcmax,psisat,bexp,dt,k,qtot)</div>
<div class="line"><a id="l01827" name="l01827"></a><span class="lineno"> 1827</span>               rhsts(k) = rhsts(k) - tsnsr / denom</div>
<div class="line"><a id="l01828" name="l01828"></a><span class="lineno"> 1828</span><span class="keywordflow">            END IF</span></div>
<div class="line"><a id="l01829" name="l01829"></a><span class="lineno"> 1829</span><span class="keywordflow">         END IF</span></div>
<div class="line"><a id="l01830" name="l01830"></a><span class="lineno"> 1830</span> </div>
<div class="line"><a id="l01831" name="l01831"></a><span class="lineno"> 1831</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01832" name="l01832"></a><span class="lineno"> 1832</span><span class="comment">! CALC MATRIX COEFS, AI, AND BI FOR THIS LAYER.</span></div>
<div class="line"><a id="l01833" name="l01833"></a><span class="lineno"> 1833</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01834" name="l01834"></a><span class="lineno"> 1834</span>         ai(k) = - df1k * ddz / ( (zsoil(k -1) - zsoil(k)) * hcpct)</div>
<div class="line"><a id="l01835" name="l01835"></a><span class="lineno"> 1835</span> </div>
<div class="line"><a id="l01836" name="l01836"></a><span class="lineno"> 1836</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01837" name="l01837"></a><span class="lineno"> 1837</span><span class="comment">! RESET VALUES OF DF1, DTSDZ, DDZ, AND TBK FOR LOOP TO NEXT SOIL LAYER.</span></div>
<div class="line"><a id="l01838" name="l01838"></a><span class="lineno"> 1838</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01839" name="l01839"></a><span class="lineno"> 1839</span>         bi(k) = - (ai(k) + ci(k))</div>
<div class="line"><a id="l01840" name="l01840"></a><span class="lineno"> 1840</span>         tbk = tbk1</div>
<div class="line"><a id="l01841" name="l01841"></a><span class="lineno"> 1841</span>         df1k = df1n</div>
<div class="line"><a id="l01842" name="l01842"></a><span class="lineno"> 1842</span>         dtsdz = dtsdz2</div>
<div class="line"><a id="l01843" name="l01843"></a><span class="lineno"> 1843</span>         ddz = ddz2</div>
<div class="line"><a id="l01844" name="l01844"></a><span class="lineno"> 1844</span><span class="keywordflow">      END DO</span></div>
<div class="line"><a id="l01845" name="l01845"></a><span class="lineno"> 1845</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01846" name="l01846"></a><span class="lineno"> 1846</span>  <span class="keyword">END SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#af9f7c237f83a49f3981875bf59dd7816">hrt</a></div>
<div class="line"><a id="l01847" name="l01847"></a><span class="lineno"> 1847</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01848" name="l01848"></a><span class="lineno"> 1848</span> </div>
<div class="line"><a id="l01849" name="l01849"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#adacf01be4e33445ea186feffce24eb35"> 1849</a></span>      <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#adacf01be4e33445ea186feffce24eb35">hstep</a> (STCOUT,STCIN,RHSTS,DT,NSOIL,AI,BI,CI)</div>
<div class="line"><a id="l01850" name="l01850"></a><span class="lineno"> 1850</span> </div>
<div class="line"><a id="l01851" name="l01851"></a><span class="lineno"> 1851</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01852" name="l01852"></a><span class="lineno"> 1852</span><span class="comment">! SUBROUTINE HSTEP</span></div>
<div class="line"><a id="l01853" name="l01853"></a><span class="lineno"> 1853</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01854" name="l01854"></a><span class="lineno"> 1854</span><span class="comment">! CALCULATE/UPDATE THE SOIL TEMPERATURE FIELD.</span></div>
<div class="line"><a id="l01855" name="l01855"></a><span class="lineno"> 1855</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01856" name="l01856"></a><span class="lineno"> 1856</span>      <span class="keywordtype">IMPLICIT NONE</span></div>
<div class="line"><a id="l01857" name="l01857"></a><span class="lineno"> 1857</span>      <span class="keywordtype">INTEGER</span>, <span class="keywordtype">INTENT(IN)</span>  :: NSOIL</div>
<div class="line"><a id="l01858" name="l01858"></a><span class="lineno"> 1858</span>      <span class="keywordtype">INTEGER</span>              :: K</div>
<div class="line"><a id="l01859" name="l01859"></a><span class="lineno"> 1859</span> </div>
<div class="line"><a id="l01860" name="l01860"></a><span class="lineno"> 1860</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(IN)</span>:: STCIN</div>
<div class="line"><a id="l01861" name="l01861"></a><span class="lineno"> 1861</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(OUT)</span>:: STCOUT</div>
<div class="line"><a id="l01862" name="l01862"></a><span class="lineno"> 1862</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(INOUT)</span>:: RHSTS</div>
<div class="line"><a id="l01863" name="l01863"></a><span class="lineno"> 1863</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(INOUT)</span>:: AI,BI,CI</div>
<div class="line"><a id="l01864" name="l01864"></a><span class="lineno"> 1864</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span> :: RHSTSin</div>
<div class="line"><a id="l01865" name="l01865"></a><span class="lineno"> 1865</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span> :: CIin</div>
<div class="line"><a id="l01866" name="l01866"></a><span class="lineno"> 1866</span><span class="keywordtype">      REAL</span>                 :: DT</div>
<div class="line"><a id="l01867" name="l01867"></a><span class="lineno"> 1867</span> </div>
<div class="line"><a id="l01868" name="l01868"></a><span class="lineno"> 1868</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01869" name="l01869"></a><span class="lineno"> 1869</span><span class="comment">! CREATE FINITE DIFFERENCE VALUES FOR USE IN ROSR12 ROUTINE</span></div>
<div class="line"><a id="l01870" name="l01870"></a><span class="lineno"> 1870</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01871" name="l01871"></a><span class="lineno"> 1871</span>      <span class="keywordflow">DO</span> k = 1,nsoil</div>
<div class="line"><a id="l01872" name="l01872"></a><span class="lineno"> 1872</span>         rhsts(k) = rhsts(k) * dt</div>
<div class="line"><a id="l01873" name="l01873"></a><span class="lineno"> 1873</span>         ai(k) = ai(k) * dt</div>
<div class="line"><a id="l01874" name="l01874"></a><span class="lineno"> 1874</span>         bi(k) = 1. + bi(k) * dt</div>
<div class="line"><a id="l01875" name="l01875"></a><span class="lineno"> 1875</span>         ci(k) = ci(k) * dt</div>
<div class="line"><a id="l01876" name="l01876"></a><span class="lineno"> 1876</span><span class="keywordflow">      END DO</span></div>
<div class="line"><a id="l01877" name="l01877"></a><span class="lineno"> 1877</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01878" name="l01878"></a><span class="lineno"> 1878</span><span class="comment">! COPY VALUES FOR INPUT VARIABLES BEFORE CALL TO ROSR12</span></div>
<div class="line"><a id="l01879" name="l01879"></a><span class="lineno"> 1879</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01880" name="l01880"></a><span class="lineno"> 1880</span>      <span class="keywordflow">DO</span> k = 1,nsoil</div>
<div class="line"><a id="l01881" name="l01881"></a><span class="lineno"> 1881</span>         rhstsin(k) = rhsts(k)</div>
<div class="line"><a id="l01882" name="l01882"></a><span class="lineno"> 1882</span><span class="keywordflow">      END DO</span></div>
<div class="line"><a id="l01883" name="l01883"></a><span class="lineno"> 1883</span>      <span class="keywordflow">DO</span> k = 1,nsoil</div>
<div class="line"><a id="l01884" name="l01884"></a><span class="lineno"> 1884</span>         ciin(k) = ci(k)</div>
<div class="line"><a id="l01885" name="l01885"></a><span class="lineno"> 1885</span><span class="keywordflow">      END DO</span></div>
<div class="line"><a id="l01886" name="l01886"></a><span class="lineno"> 1886</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01887" name="l01887"></a><span class="lineno"> 1887</span><span class="comment">! SOLVE THE TRI-DIAGONAL MATRIX EQUATION</span></div>
<div class="line"><a id="l01888" name="l01888"></a><span class="lineno"> 1888</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01889" name="l01889"></a><span class="lineno"> 1889</span>      <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ac6e3e7bb3f0322070546653306177216">rosr12</a> (ci,ai,bi,ciin,rhstsin,rhsts,nsoil)</div>
<div class="line"><a id="l01890" name="l01890"></a><span class="lineno"> 1890</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01891" name="l01891"></a><span class="lineno"> 1891</span><span class="comment">! CALC/UPDATE THE SOIL TEMPS USING MATRIX SOLUTION</span></div>
<div class="line"><a id="l01892" name="l01892"></a><span class="lineno"> 1892</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01893" name="l01893"></a><span class="lineno"> 1893</span>      <span class="keywordflow">DO</span> k = 1,nsoil</div>
<div class="line"><a id="l01894" name="l01894"></a><span class="lineno"> 1894</span>         stcout(k) = stcin(k) + ci(k)</div>
<div class="line"><a id="l01895" name="l01895"></a><span class="lineno"> 1895</span><span class="keywordflow">      END DO</span></div>
<div class="line"><a id="l01896" name="l01896"></a><span class="lineno"> 1896</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01897" name="l01897"></a><span class="lineno"> 1897</span>  <span class="keyword">END SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#adacf01be4e33445ea186feffce24eb35">hstep</a></div>
<div class="line"><a id="l01898" name="l01898"></a><span class="lineno"> 1898</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01899" name="l01899"></a><span class="lineno"> 1899</span> </div>
<div class="line"><a id="l01900" name="l01900"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#a010cd10c8d345760dec2a6bddbb5170f"> 1900</a></span>      <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a010cd10c8d345760dec2a6bddbb5170f">nopac</a> (ETP,ETA,PRCP,SMC,SMCMAX,SMCWLT,                 &amp;</div>
<div class="line"><a id="l01901" name="l01901"></a><span class="lineno"> 1901</span>                         SMCREF,SMCDRY,CMC,CMCMAX,NSOIL,DT,SHDFAC,      &amp;</div>
<div class="line"><a id="l01902" name="l01902"></a><span class="lineno"> 1902</span>                         SBETA,Q2,T1,SFCTMP,T24,TH2,FDOWN,F1,EMISSI,    &amp;</div>
<div class="line"><a id="l01903" name="l01903"></a><span class="lineno"> 1903</span>                         SSOIL,                                         &amp;</div>
<div class="line"><a id="l01904" name="l01904"></a><span class="lineno"> 1904</span>                         STC,EPSCA,BEXP,PC,RCH,RR,CFACTR,               &amp;</div>
<div class="line"><a id="l01905" name="l01905"></a><span class="lineno"> 1905</span>                         SH2O,SLOPE,KDT,FRZFACT,PSISAT,ZSOIL,           &amp;</div>
<div class="line"><a id="l01906" name="l01906"></a><span class="lineno"> 1906</span>                         DKSAT,DWSAT,TBOT,ZBOT,RUNOFF1,RUNOFF2,         &amp;</div>
<div class="line"><a id="l01907" name="l01907"></a><span class="lineno"> 1907</span>                         RUNOFF3,EDIR,EC,ET,ETT,NROOT,RTDIS,            &amp;</div>
<div class="line"><a id="l01908" name="l01908"></a><span class="lineno"> 1908</span>                         QUARTZ,FXEXP,CSOIL,                            &amp;</div>
<div class="line"><a id="l01909" name="l01909"></a><span class="lineno"> 1909</span>                         BETA,DRIP,DEW,FLX1,FLX3,VEGTYP,ISURBAN,        &amp;</div>
<div class="line"><a id="l01910" name="l01910"></a><span class="lineno"> 1910</span>                         SFHEAD1RT,INFXS1RT,ETPND1,SOILTYP,OPT_THCND    &amp;</div>
<div class="line"><a id="l01911" name="l01911"></a><span class="lineno"> 1911</span>                        ,XSDA_QFX,QFX_PHY,XQNORM,fasdas,HCPCT_FASDAS    ) <span class="comment">!fasdas</span></div>
<div class="line"><a id="l01912" name="l01912"></a><span class="lineno"> 1912</span> </div>
<div class="line"><a id="l01913" name="l01913"></a><span class="lineno"> 1913</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01914" name="l01914"></a><span class="lineno"> 1914</span><span class="comment">! SUBROUTINE NOPAC</span></div>
<div class="line"><a id="l01915" name="l01915"></a><span class="lineno"> 1915</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01916" name="l01916"></a><span class="lineno"> 1916</span><span class="comment">! CALCULATE SOIL MOISTURE AND HEAT FLUX VALUES AND UPDATE SOIL MOISTURE</span></div>
<div class="line"><a id="l01917" name="l01917"></a><span class="lineno"> 1917</span><span class="comment">! CONTENT AND SOIL HEAT CONTENT VALUES FOR THE CASE WHEN NO SNOW PACK IS</span></div>
<div class="line"><a id="l01918" name="l01918"></a><span class="lineno"> 1918</span><span class="comment">! PRESENT.</span></div>
<div class="line"><a id="l01919" name="l01919"></a><span class="lineno"> 1919</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01920" name="l01920"></a><span class="lineno"> 1920</span>      <span class="keywordtype">IMPLICIT NONE</span></div>
<div class="line"><a id="l01921" name="l01921"></a><span class="lineno"> 1921</span> </div>
<div class="line"><a id="l01922" name="l01922"></a><span class="lineno"> 1922</span>      <span class="keywordtype">INTEGER</span>, <span class="keywordtype">INTENT(IN)</span>  :: OPT_THCND</div>
<div class="line"><a id="l01923" name="l01923"></a><span class="lineno"> 1923</span>      <span class="keywordtype">INTEGER</span>, <span class="keywordtype">INTENT(IN)</span>  :: NROOT,NSOIL,VEGTYP,SOILTYP</div>
<div class="line"><a id="l01924" name="l01924"></a><span class="lineno"> 1924</span>      <span class="keywordtype">INTEGER</span>, <span class="keywordtype">INTENT(IN)</span>  :: ISURBAN</div>
<div class="line"><a id="l01925" name="l01925"></a><span class="lineno"> 1925</span>      <span class="keywordtype">INTEGER</span>              :: K</div>
<div class="line"><a id="l01926" name="l01926"></a><span class="lineno"> 1926</span> </div>
<div class="line"><a id="l01927" name="l01927"></a><span class="lineno"> 1927</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(IN)</span>     :: BEXP,CFACTR, CMCMAX,CSOIL,DKSAT,DT,DWSAT, &amp;</div>
<div class="line"><a id="l01928" name="l01928"></a><span class="lineno"> 1928</span>                              EPSCA,ETP,FDOWN,F1,FXEXP,FRZFACT,KDT,PC,  &amp;</div>
<div class="line"><a id="l01929" name="l01929"></a><span class="lineno"> 1929</span>                              PRCP,PSISAT,Q2,QUARTZ,RCH,RR,SBETA,SFCTMP,&amp;</div>
<div class="line"><a id="l01930" name="l01930"></a><span class="lineno"> 1930</span>                              SHDFAC,SLOPE,SMCDRY,SMCMAX,SMCREF,SMCWLT, &amp;</div>
<div class="line"><a id="l01931" name="l01931"></a><span class="lineno"> 1931</span>                              T24,TBOT,TH2,ZBOT,EMISSI</div>
<div class="line"><a id="l01932" name="l01932"></a><span class="lineno"> 1932</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(INOUT)</span>  :: CMC,BETA,T1</div>
<div class="line"><a id="l01933" name="l01933"></a><span class="lineno"> 1933</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(OUT)</span>    :: DEW,DRIP,EC,EDIR,ETA,ETT,FLX1,FLX3,       &amp;</div>
<div class="line"><a id="l01934" name="l01934"></a><span class="lineno"> 1934</span>                              RUNOFF1,RUNOFF2,RUNOFF3,SSOIL</div>
<div class="line"><a id="l01935" name="l01935"></a><span class="lineno"> 1935</span><span class="comment">!DJG NDHMS/WRF-Hydro edit...</span></div>
<div class="line"><a id="l01936" name="l01936"></a><span class="lineno"> 1936</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(INOUT)</span>  :: SFHEAD1RT,INFXS1RT,ETPND1</div>
<div class="line"><a id="l01937" name="l01937"></a><span class="lineno"> 1937</span> </div>
<div class="line"><a id="l01938" name="l01938"></a><span class="lineno"> 1938</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>,<span class="keywordtype">INTENT(IN)</span>     :: RTDIS,ZSOIL</div>
<div class="line"><a id="l01939" name="l01939"></a><span class="lineno"> 1939</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>,<span class="keywordtype">INTENT(OUT)</span>    :: ET</div>
<div class="line"><a id="l01940" name="l01940"></a><span class="lineno"> 1940</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(INOUT)</span> :: SMC,SH2O,STC</div>
<div class="line"><a id="l01941" name="l01941"></a><span class="lineno"> 1941</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span> :: ET1</div>
<div class="line"><a id="l01942" name="l01942"></a><span class="lineno"> 1942</span><span class="keywordtype">      REAL</span>                 :: EC1,EDIR1,ETT1,DF1,ETA1,ETP1,PRCP1,YY,    &amp;</div>
<div class="line"><a id="l01943" name="l01943"></a><span class="lineno"> 1943</span>                              YYNUM,ZZ1</div>
<div class="line"><a id="l01944" name="l01944"></a><span class="lineno"> 1944</span><span class="comment">!</span></div>
<div class="line"><a id="l01945" name="l01945"></a><span class="lineno"> 1945</span><span class="comment">! FASDAS</span></div>
<div class="line"><a id="l01946" name="l01946"></a><span class="lineno"> 1946</span><span class="comment">!</span></div>
<div class="line"><a id="l01947" name="l01947"></a><span class="lineno"> 1947</span><span class="keywordtype">      REAL</span>                       ::  XSDA_QFX, QFX_PHY, XQNORM</div>
<div class="line"><a id="l01948" name="l01948"></a><span class="lineno"> 1948</span>      <span class="keywordtype">INTEGER</span>                    ::  fasdas</div>
<div class="line"><a id="l01949" name="l01949"></a><span class="lineno"> 1949</span><span class="keywordtype">      REAL</span> , <span class="keywordtype">DIMENSION(1:NSOIL)</span>  ::  EFT(NSOIL), wetty(1:NSOIL)</div>
<div class="line"><a id="l01950" name="l01950"></a><span class="lineno"> 1950</span><span class="keywordtype">      REAL</span>                       ::  EFDIR, EFC, EALL_now</div>
<div class="line"><a id="l01951" name="l01951"></a><span class="lineno"> 1951</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(  OUT)</span>        ::  HCPCT_FASDAS</div>
<div class="line"><a id="l01952" name="l01952"></a><span class="lineno"> 1952</span><span class="comment">!</span></div>
<div class="line"><a id="l01953" name="l01953"></a><span class="lineno"> 1953</span><span class="comment">! END FASDAS</span></div>
<div class="line"><a id="l01954" name="l01954"></a><span class="lineno"> 1954</span><span class="comment">!</span></div>
<div class="line"><a id="l01955" name="l01955"></a><span class="lineno"> 1955</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01956" name="l01956"></a><span class="lineno"> 1956</span><span class="comment">! EXECUTABLE CODE BEGINS HERE:</span></div>
<div class="line"><a id="l01957" name="l01957"></a><span class="lineno"> 1957</span><span class="comment">! CONVERT ETP Fnd PRCP FROM KG M-2 S-1 TO M S-1 AND INITIALIZE DEW.</span></div>
<div class="line"><a id="l01958" name="l01958"></a><span class="lineno"> 1958</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01959" name="l01959"></a><span class="lineno"> 1959</span>      prcp1 = prcp * 0.001</div>
<div class="line"><a id="l01960" name="l01960"></a><span class="lineno"> 1960</span>      etp1 = etp * 0.001</div>
<div class="line"><a id="l01961" name="l01961"></a><span class="lineno"> 1961</span>      dew = 0.0</div>
<div class="line"><a id="l01962" name="l01962"></a><span class="lineno"> 1962</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01963" name="l01963"></a><span class="lineno"> 1963</span><span class="comment">! INITIALIZE EVAP TERMS.</span></div>
<div class="line"><a id="l01964" name="l01964"></a><span class="lineno"> 1964</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01965" name="l01965"></a><span class="lineno"> 1965</span><span class="comment">!</span></div>
<div class="line"><a id="l01966" name="l01966"></a><span class="lineno"> 1966</span><span class="comment">! FASDAS</span></div>
<div class="line"><a id="l01967" name="l01967"></a><span class="lineno"> 1967</span><span class="comment">!</span></div>
<div class="line"><a id="l01968" name="l01968"></a><span class="lineno"> 1968</span>      qfx_phy = 0.0</div>
<div class="line"><a id="l01969" name="l01969"></a><span class="lineno"> 1969</span><span class="comment">!</span></div>
<div class="line"><a id="l01970" name="l01970"></a><span class="lineno"> 1970</span><span class="comment">! END FASDAS</span></div>
<div class="line"><a id="l01971" name="l01971"></a><span class="lineno"> 1971</span><span class="comment">!</span></div>
<div class="line"><a id="l01972" name="l01972"></a><span class="lineno"> 1972</span>      edir = 0.</div>
<div class="line"><a id="l01973" name="l01973"></a><span class="lineno"> 1973</span>      edir1 = 0.</div>
<div class="line"><a id="l01974" name="l01974"></a><span class="lineno"> 1974</span>      ec1 = 0.</div>
<div class="line"><a id="l01975" name="l01975"></a><span class="lineno"> 1975</span>      ec = 0.</div>
<div class="line"><a id="l01976" name="l01976"></a><span class="lineno"> 1976</span>      <span class="keywordflow">DO</span> k = 1,nsoil</div>
<div class="line"><a id="l01977" name="l01977"></a><span class="lineno"> 1977</span>        et(k) = 0.</div>
<div class="line"><a id="l01978" name="l01978"></a><span class="lineno"> 1978</span>        et1(k) = 0.</div>
<div class="line"><a id="l01979" name="l01979"></a><span class="lineno"> 1979</span><span class="comment">!</span></div>
<div class="line"><a id="l01980" name="l01980"></a><span class="lineno"> 1980</span><span class="comment">! FASDAS</span></div>
<div class="line"><a id="l01981" name="l01981"></a><span class="lineno"> 1981</span><span class="comment">!</span></div>
<div class="line"><a id="l01982" name="l01982"></a><span class="lineno"> 1982</span>        wetty(k) = 1.0</div>
<div class="line"><a id="l01983" name="l01983"></a><span class="lineno"> 1983</span><span class="comment">!</span></div>
<div class="line"><a id="l01984" name="l01984"></a><span class="lineno"> 1984</span><span class="comment">! END FASDAS</span></div>
<div class="line"><a id="l01985" name="l01985"></a><span class="lineno"> 1985</span><span class="comment">!</span></div>
<div class="line"><a id="l01986" name="l01986"></a><span class="lineno"> 1986</span><span class="keywordflow">      END DO</span></div>
<div class="line"><a id="l01987" name="l01987"></a><span class="lineno"> 1987</span>      ett = 0.</div>
<div class="line"><a id="l01988" name="l01988"></a><span class="lineno"> 1988</span>      ett1 = 0.</div>
<div class="line"><a id="l01989" name="l01989"></a><span class="lineno"> 1989</span> </div>
<div class="line"><a id="l01990" name="l01990"></a><span class="lineno"> 1990</span><span class="comment">!DJG NDHMS/WRF-Hydro edit...</span></div>
<div class="line"><a id="l01991" name="l01991"></a><span class="lineno"> 1991</span>      etpnd1 = 0.</div>
<div class="line"><a id="l01992" name="l01992"></a><span class="lineno"> 1992</span> </div>
<div class="line"><a id="l01993" name="l01993"></a><span class="lineno"> 1993</span> </div>
<div class="line"><a id="l01994" name="l01994"></a><span class="lineno"> 1994</span>      <span class="keywordflow">IF</span> (etp &gt; 0.0) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l01995" name="l01995"></a><span class="lineno"> 1995</span>         <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ae65310d4c0555dd149f413ff42737077">evapo</a> (eta1,smc,nsoil,cmc,etp1,dt,zsoil,                  &amp;</div>
<div class="line"><a id="l01996" name="l01996"></a><span class="lineno"> 1996</span>                      sh2o,                                             &amp;</div>
<div class="line"><a id="l01997" name="l01997"></a><span class="lineno"> 1997</span>                      smcmax,bexp,pc,smcwlt,dksat,dwsat,                &amp;</div>
<div class="line"><a id="l01998" name="l01998"></a><span class="lineno"> 1998</span>                      smcref,shdfac,cmcmax,                             &amp;</div>
<div class="line"><a id="l01999" name="l01999"></a><span class="lineno"> 1999</span>                      smcdry,cfactr,                                    &amp;</div>
<div class="line"><a id="l02000" name="l02000"></a><span class="lineno"> 2000</span>                       edir1,ec1,et1,ett1,sfctmp,q2,nroot,rtdis,fxexp,  &amp;</div>
<div class="line"><a id="l02001" name="l02001"></a><span class="lineno"> 2001</span>                      sfhead1rt,etpnd1 )</div>
<div class="line"><a id="l02002" name="l02002"></a><span class="lineno"> 2002</span><span class="comment">!</span></div>
<div class="line"><a id="l02003" name="l02003"></a><span class="lineno"> 2003</span><span class="comment">! FASDAS</span></div>
<div class="line"><a id="l02004" name="l02004"></a><span class="lineno"> 2004</span><span class="comment">!</span></div>
<div class="line"><a id="l02005" name="l02005"></a><span class="lineno"> 2005</span>      <span class="keywordflow">IF</span>( fasdas == 1 ) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l02006" name="l02006"></a><span class="lineno"> 2006</span>        <span class="keywordflow">DO</span> k=1,nsoil</div>
<div class="line"><a id="l02007" name="l02007"></a><span class="lineno"> 2007</span>        qfx_phy = qfx_phy + et1(k)   <span class="comment">! m/s</span></div>
<div class="line"><a id="l02008" name="l02008"></a><span class="lineno"> 2008</span><span class="comment">! dont add moisture fluxes if soil moisture is = or &gt; smcref</span></div>
<div class="line"><a id="l02009" name="l02009"></a><span class="lineno"> 2009</span>        <span class="keywordflow">IF</span>(smc(k).GE.smcref.and.xsda_qfx.gt.0.0) wetty(k)=0.0</div>
<div class="line"><a id="l02010" name="l02010"></a><span class="lineno"> 2010</span><span class="keywordflow">        END DO</span></div>
<div class="line"><a id="l02011" name="l02011"></a><span class="lineno"> 2011</span>       qfx_phy = edir1+ec1+qfx_phy    <span class="comment">! m/s</span></div>
<div class="line"><a id="l02012" name="l02012"></a><span class="lineno"> 2012</span>       eall_now = qfx_phy           <span class="comment">! m/s</span></div>
<div class="line"><a id="l02013" name="l02013"></a><span class="lineno"> 2013</span>       qfx_phy = qfx_phy*1000.0     <span class="comment">! Kg/m2/s</span></div>
<div class="line"><a id="l02014" name="l02014"></a><span class="lineno"> 2014</span> </div>
<div class="line"><a id="l02015" name="l02015"></a><span class="lineno"> 2015</span>       <span class="keywordflow">if</span>(eall_now.ne.0.0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02016" name="l02016"></a><span class="lineno"> 2016</span>       efdir = (edir1/eall_now)*xsda_qfx*1.0e-03*xqnorm</div>
<div class="line"><a id="l02017" name="l02017"></a><span class="lineno"> 2017</span>       efdir = efdir * wetty(1)</div>
<div class="line"><a id="l02018" name="l02018"></a><span class="lineno"> 2018</span>          <span class="comment">!TWG2015 Bugfix Flip Sign to conform to Net upward Flux</span></div>
<div class="line"><a id="l02019" name="l02019"></a><span class="lineno"> 2019</span>           edir1 = edir1 + efdir    <span class="comment">! new value</span></div>
<div class="line"><a id="l02020" name="l02020"></a><span class="lineno"> 2020</span>       </div>
<div class="line"><a id="l02021" name="l02021"></a><span class="lineno"> 2021</span>       efc = (ec1/eall_now)*xsda_qfx*1.0e-03*xqnorm</div>
<div class="line"><a id="l02022" name="l02022"></a><span class="lineno"> 2022</span>       <span class="comment">!TWG2015 Bugfix Flip Sign to conform to Net upward Flux</span></div>
<div class="line"><a id="l02023" name="l02023"></a><span class="lineno"> 2023</span>       ec1 = ec1 + efc         <span class="comment">! new value</span></div>
<div class="line"><a id="l02024" name="l02024"></a><span class="lineno"> 2024</span> </div>
<div class="line"><a id="l02025" name="l02025"></a><span class="lineno"> 2025</span> </div>
<div class="line"><a id="l02026" name="l02026"></a><span class="lineno"> 2026</span>       <span class="keywordflow">DO</span> k=1,nsoil</div>
<div class="line"><a id="l02027" name="l02027"></a><span class="lineno"> 2027</span>        eft(k) = (et1(k)/eall_now)*xsda_qfx*1.0e-03*xqnorm</div>
<div class="line"><a id="l02028" name="l02028"></a><span class="lineno"> 2028</span>        eft(k) =  eft(k) * wetty(k)</div>
<div class="line"><a id="l02029" name="l02029"></a><span class="lineno"> 2029</span>        <span class="comment">!TWG2015 Bugfix Flip Sign to conform to Net upward Flux</span></div>
<div class="line"><a id="l02030" name="l02030"></a><span class="lineno"> 2030</span>        et1(k) = et1(k) + eft(k) <span class="comment">! new value</span></div>
<div class="line"><a id="l02031" name="l02031"></a><span class="lineno"> 2031</span><span class="keywordflow">       END DO</span></div>
<div class="line"><a id="l02032" name="l02032"></a><span class="lineno"> 2032</span> </div>
<div class="line"><a id="l02033" name="l02033"></a><span class="lineno"> 2033</span> </div>
<div class="line"><a id="l02034" name="l02034"></a><span class="lineno"> 2034</span><span class="keywordflow">       END IF</span> <span class="comment">! for non-zero eall_now</span></div>
<div class="line"><a id="l02035" name="l02035"></a><span class="lineno"> 2035</span>      <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l02036" name="l02036"></a><span class="lineno"> 2036</span>        qfx_phy = 0.0</div>
<div class="line"><a id="l02037" name="l02037"></a><span class="lineno"> 2037</span><span class="keywordflow">      ENDIF</span></div>
<div class="line"><a id="l02038" name="l02038"></a><span class="lineno"> 2038</span><span class="comment">!</span></div>
<div class="line"><a id="l02039" name="l02039"></a><span class="lineno"> 2039</span><span class="comment">! END FASDAS</span></div>
<div class="line"><a id="l02040" name="l02040"></a><span class="lineno"> 2040</span><span class="comment">!</span></div>
<div class="line"><a id="l02041" name="l02041"></a><span class="lineno"> 2041</span>         <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a58888da8d933fe6e55e825b83159658b">smflx</a> (smc,nsoil,cmc,dt,prcp1,zsoil,                      &amp;</div>
<div class="line"><a id="l02042" name="l02042"></a><span class="lineno"> 2042</span>                      sh2o,slope,kdt,frzfact,                           &amp;</div>
<div class="line"><a id="l02043" name="l02043"></a><span class="lineno"> 2043</span>                      smcmax,bexp,smcwlt,dksat,dwsat,                   &amp;</div>
<div class="line"><a id="l02044" name="l02044"></a><span class="lineno"> 2044</span>                      shdfac,cmcmax,                                    &amp;</div>
<div class="line"><a id="l02045" name="l02045"></a><span class="lineno"> 2045</span>                      runoff1,runoff2,runoff3,                          &amp;</div>
<div class="line"><a id="l02046" name="l02046"></a><span class="lineno"> 2046</span>                      edir1,ec1,et1,                                    &amp;</div>
<div class="line"><a id="l02047" name="l02047"></a><span class="lineno"> 2047</span>                      drip, sfhead1rt,infxs1rt)</div>
<div class="line"><a id="l02048" name="l02048"></a><span class="lineno"> 2048</span> </div>
<div class="line"><a id="l02049" name="l02049"></a><span class="lineno"> 2049</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02050" name="l02050"></a><span class="lineno"> 2050</span><span class="comment">! CONVERT MODELED EVAPOTRANSPIRATION FROM  M S-1  TO  KG M-2 S-1.</span></div>
<div class="line"><a id="l02051" name="l02051"></a><span class="lineno"> 2051</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02052" name="l02052"></a><span class="lineno"> 2052</span> </div>
<div class="line"><a id="l02053" name="l02053"></a><span class="lineno"> 2053</span>         eta = eta1 * 1000.0</div>
<div class="line"><a id="l02054" name="l02054"></a><span class="lineno"> 2054</span> </div>
<div class="line"><a id="l02055" name="l02055"></a><span class="lineno"> 2055</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02056" name="l02056"></a><span class="lineno"> 2056</span><span class="comment">! IF ETP &lt; 0, ASSUME DEW FORMS (TRANSFORM ETP1 INTO DEW AND REINITIALIZE</span></div>
<div class="line"><a id="l02057" name="l02057"></a><span class="lineno"> 2057</span><span class="comment">! ETP1 TO ZERO).</span></div>
<div class="line"><a id="l02058" name="l02058"></a><span class="lineno"> 2058</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02059" name="l02059"></a><span class="lineno"> 2059</span>      <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l02060" name="l02060"></a><span class="lineno"> 2060</span>         dew = - etp1</div>
<div class="line"><a id="l02061" name="l02061"></a><span class="lineno"> 2061</span> </div>
<div class="line"><a id="l02062" name="l02062"></a><span class="lineno"> 2062</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02063" name="l02063"></a><span class="lineno"> 2063</span><span class="comment">! CONVERT PRCP FROM &#39;KG M-2 S-1&#39; TO &#39;M S-1&#39; AND ADD DEW AMOUNT.</span></div>
<div class="line"><a id="l02064" name="l02064"></a><span class="lineno"> 2064</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02065" name="l02065"></a><span class="lineno"> 2065</span> </div>
<div class="line"><a id="l02066" name="l02066"></a><span class="lineno"> 2066</span>         prcp1 = prcp1+ dew</div>
<div class="line"><a id="l02067" name="l02067"></a><span class="lineno"> 2067</span><span class="comment">!</span></div>
<div class="line"><a id="l02068" name="l02068"></a><span class="lineno"> 2068</span><span class="comment">! FASDAS</span></div>
<div class="line"><a id="l02069" name="l02069"></a><span class="lineno"> 2069</span><span class="comment">!</span></div>
<div class="line"><a id="l02070" name="l02070"></a><span class="lineno"> 2070</span>     <span class="keywordflow">IF</span>( fasdas == 1 ) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l02071" name="l02071"></a><span class="lineno"> 2071</span>       <span class="keywordflow">DO</span> k=1,nsoil</div>
<div class="line"><a id="l02072" name="l02072"></a><span class="lineno"> 2072</span>        qfx_phy = qfx_phy + et1(k)   <span class="comment">! m/s</span></div>
<div class="line"><a id="l02073" name="l02073"></a><span class="lineno"> 2073</span><span class="comment">! dont add moisture fluxes if soil moisture is = or &gt; smcref</span></div>
<div class="line"><a id="l02074" name="l02074"></a><span class="lineno"> 2074</span>        <span class="keywordflow">IF</span>(smc(k).GE.smcref.and.xsda_qfx.gt.0.0) wetty(k)=0.0</div>
<div class="line"><a id="l02075" name="l02075"></a><span class="lineno"> 2075</span><span class="keywordflow">       END DO</span></div>
<div class="line"><a id="l02076" name="l02076"></a><span class="lineno"> 2076</span>       qfx_phy = edir1+ec1+qfx_phy    <span class="comment">! m/s</span></div>
<div class="line"><a id="l02077" name="l02077"></a><span class="lineno"> 2077</span>        eall_now = qfx_phy     <span class="comment">! m/s</span></div>
<div class="line"><a id="l02078" name="l02078"></a><span class="lineno"> 2078</span>       qfx_phy = qfx_phy*1000.0    <span class="comment">! Kg/m2/s</span></div>
<div class="line"><a id="l02079" name="l02079"></a><span class="lineno"> 2079</span> </div>
<div class="line"><a id="l02080" name="l02080"></a><span class="lineno"> 2080</span>       <span class="keywordflow">IF</span>(eall_now.ne.0.0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02081" name="l02081"></a><span class="lineno"> 2081</span>       efdir = (edir1/eall_now)*xsda_qfx*1.0e-03*xqnorm</div>
<div class="line"><a id="l02082" name="l02082"></a><span class="lineno"> 2082</span>        efdir =  efdir * wetty(1)</div>
<div class="line"><a id="l02083" name="l02083"></a><span class="lineno"> 2083</span>          <span class="comment">!TWG2015 Bugfix Flip Sign to conform to Net Upward Flux</span></div>
<div class="line"><a id="l02084" name="l02084"></a><span class="lineno"> 2084</span>           edir1 = edir1 + efdir    <span class="comment">! new value</span></div>
<div class="line"><a id="l02085" name="l02085"></a><span class="lineno"> 2085</span> </div>
<div class="line"><a id="l02086" name="l02086"></a><span class="lineno"> 2086</span>        efc = (ec1/eall_now)*xsda_qfx*1.0e-03*xqnorm</div>
<div class="line"><a id="l02087" name="l02087"></a><span class="lineno"> 2087</span>        <span class="comment">!TWG2015 Bugfix Flip Sign to conform to Net Upward Flux</span></div>
<div class="line"><a id="l02088" name="l02088"></a><span class="lineno"> 2088</span>        ec1 = ec1+ efc         <span class="comment">! new value</span></div>
<div class="line"><a id="l02089" name="l02089"></a><span class="lineno"> 2089</span> </div>
<div class="line"><a id="l02090" name="l02090"></a><span class="lineno"> 2090</span>       <span class="keywordflow">DO</span> k=1,nsoil</div>
<div class="line"><a id="l02091" name="l02091"></a><span class="lineno"> 2091</span>        eft(k) = (et1(k)/eall_now)*xsda_qfx*1.0e-03*xqnorm</div>
<div class="line"><a id="l02092" name="l02092"></a><span class="lineno"> 2092</span>        eft(k) = eft(k) * wetty(k)</div>
<div class="line"><a id="l02093" name="l02093"></a><span class="lineno"> 2093</span>        <span class="comment">!TWG2015 Bugfix Flip Sign to conform to Net Upward Flux</span></div>
<div class="line"><a id="l02094" name="l02094"></a><span class="lineno"> 2094</span>        et1(k) = et1(k) + eft(k)   <span class="comment">! new value</span></div>
<div class="line"><a id="l02095" name="l02095"></a><span class="lineno"> 2095</span><span class="keywordflow">       END DO</span></div>
<div class="line"><a id="l02096" name="l02096"></a><span class="lineno"> 2096</span> </div>
<div class="line"><a id="l02097" name="l02097"></a><span class="lineno"> 2097</span><span class="keywordflow">        END IF</span> <span class="comment">! for non-zero eall_now</span></div>
<div class="line"><a id="l02098" name="l02098"></a><span class="lineno"> 2098</span>      <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l02099" name="l02099"></a><span class="lineno"> 2099</span>        qfx_phy = 0.0</div>
<div class="line"><a id="l02100" name="l02100"></a><span class="lineno"> 2100</span><span class="keywordflow">      ENDIF</span></div>
<div class="line"><a id="l02101" name="l02101"></a><span class="lineno"> 2101</span><span class="comment">!</span></div>
<div class="line"><a id="l02102" name="l02102"></a><span class="lineno"> 2102</span><span class="comment">! END FASDAS</span></div>
<div class="line"><a id="l02103" name="l02103"></a><span class="lineno"> 2103</span><span class="comment">!</span></div>
<div class="line"><a id="l02104" name="l02104"></a><span class="lineno"> 2104</span>         <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a58888da8d933fe6e55e825b83159658b">smflx</a> (smc,nsoil,cmc,dt,prcp1,zsoil,                      &amp;</div>
<div class="line"><a id="l02105" name="l02105"></a><span class="lineno"> 2105</span>                      sh2o,slope,kdt,frzfact,                           &amp;</div>
<div class="line"><a id="l02106" name="l02106"></a><span class="lineno"> 2106</span>                      smcmax,bexp,smcwlt,dksat,dwsat,                   &amp;</div>
<div class="line"><a id="l02107" name="l02107"></a><span class="lineno"> 2107</span>                      shdfac,cmcmax,                                    &amp;</div>
<div class="line"><a id="l02108" name="l02108"></a><span class="lineno"> 2108</span>                      runoff1,runoff2,runoff3,                          &amp;</div>
<div class="line"><a id="l02109" name="l02109"></a><span class="lineno"> 2109</span>                      edir1,ec1,et1,                                    &amp;</div>
<div class="line"><a id="l02110" name="l02110"></a><span class="lineno"> 2110</span>                      drip, sfhead1rt,infxs1rt)</div>
<div class="line"><a id="l02111" name="l02111"></a><span class="lineno"> 2111</span> </div>
<div class="line"><a id="l02112" name="l02112"></a><span class="lineno"> 2112</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02113" name="l02113"></a><span class="lineno"> 2113</span><span class="comment">! CONVERT MODELED EVAPOTRANSPIRATION FROM &#39;M S-1&#39; TO &#39;KG M-2 S-1&#39;.</span></div>
<div class="line"><a id="l02114" name="l02114"></a><span class="lineno"> 2114</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02115" name="l02115"></a><span class="lineno"> 2115</span><span class="comment">!         ETA = ETA1 * 1000.0</span></div>
<div class="line"><a id="l02116" name="l02116"></a><span class="lineno"> 2116</span><span class="keywordflow">      END IF</span></div>
<div class="line"><a id="l02117" name="l02117"></a><span class="lineno"> 2117</span> </div>
<div class="line"><a id="l02118" name="l02118"></a><span class="lineno"> 2118</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02119" name="l02119"></a><span class="lineno"> 2119</span><span class="comment">! BASED ON ETP AND E VALUES, DETERMINE BETA</span></div>
<div class="line"><a id="l02120" name="l02120"></a><span class="lineno"> 2120</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02121" name="l02121"></a><span class="lineno"> 2121</span> </div>
<div class="line"><a id="l02122" name="l02122"></a><span class="lineno"> 2122</span>      <span class="keywordflow">IF</span> ( etp &lt;= 0.0 ) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l02123" name="l02123"></a><span class="lineno"> 2123</span>         beta = 0.0</div>
<div class="line"><a id="l02124" name="l02124"></a><span class="lineno"> 2124</span>         eta = etp</div>
<div class="line"><a id="l02125" name="l02125"></a><span class="lineno"> 2125</span>         <span class="keywordflow">IF</span> ( etp &lt; 0.0 ) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l02126" name="l02126"></a><span class="lineno"> 2126</span>            beta = 1.0</div>
<div class="line"><a id="l02127" name="l02127"></a><span class="lineno"> 2127</span><span class="keywordflow">         END IF</span></div>
<div class="line"><a id="l02128" name="l02128"></a><span class="lineno"> 2128</span>      <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l02129" name="l02129"></a><span class="lineno"> 2129</span>         beta = eta / etp</div>
<div class="line"><a id="l02130" name="l02130"></a><span class="lineno"> 2130</span><span class="keywordflow">      END IF</span></div>
<div class="line"><a id="l02131" name="l02131"></a><span class="lineno"> 2131</span> </div>
<div class="line"><a id="l02132" name="l02132"></a><span class="lineno"> 2132</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02133" name="l02133"></a><span class="lineno"> 2133</span><span class="comment">! CONVERT MODELED EVAPOTRANSPIRATION COMPONENTS &#39;M S-1&#39; TO &#39;KG M-2 S-1&#39;.</span></div>
<div class="line"><a id="l02134" name="l02134"></a><span class="lineno"> 2134</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02135" name="l02135"></a><span class="lineno"> 2135</span>      edir = edir1*1000.</div>
<div class="line"><a id="l02136" name="l02136"></a><span class="lineno"> 2136</span>      ec = ec1*1000.</div>
<div class="line"><a id="l02137" name="l02137"></a><span class="lineno"> 2137</span>      <span class="keywordflow">DO</span> k = 1,nsoil</div>
<div class="line"><a id="l02138" name="l02138"></a><span class="lineno"> 2138</span>        et(k) = et1(k)*1000.</div>
<div class="line"><a id="l02139" name="l02139"></a><span class="lineno"> 2139</span><span class="keywordflow">      END DO</span></div>
<div class="line"><a id="l02140" name="l02140"></a><span class="lineno"> 2140</span>      ett = ett1*1000.</div>
<div class="line"><a id="l02141" name="l02141"></a><span class="lineno"> 2141</span> </div>
<div class="line"><a id="l02142" name="l02142"></a><span class="lineno"> 2142</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02143" name="l02143"></a><span class="lineno"> 2143</span><span class="comment">! GET SOIL THERMAL DIFFUXIVITY/CONDUCTIVITY FOR TOP SOIL LYR,</span></div>
<div class="line"><a id="l02144" name="l02144"></a><span class="lineno"> 2144</span><span class="comment">! CALC. ADJUSTED TOP LYR SOIL TEMP AND ADJUSTED SOIL FLUX, THEN</span></div>
<div class="line"><a id="l02145" name="l02145"></a><span class="lineno"> 2145</span><span class="comment">! CALL SHFLX TO COMPUTE/UPDATE SOIL HEAT FLUX AND SOIL TEMPS.</span></div>
<div class="line"><a id="l02146" name="l02146"></a><span class="lineno"> 2146</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02147" name="l02147"></a><span class="lineno"> 2147</span> </div>
<div class="line"><a id="l02148" name="l02148"></a><span class="lineno"> 2148</span>      <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a7946ddfb3b6fc624a9e87acbfa08fe1b">tdfcnd</a> (df1,smc(1),quartz,smcmax,sh2o(1),bexp, psisat, soiltyp, opt_thcnd)</div>
<div class="line"><a id="l02149" name="l02149"></a><span class="lineno"> 2149</span> </div>
<div class="line"><a id="l02150" name="l02150"></a><span class="lineno"> 2150</span><span class="comment">!urban</span></div>
<div class="line"><a id="l02151" name="l02151"></a><span class="lineno"> 2151</span>      <span class="keywordflow">IF</span> ( vegtyp == isurban ) df1=3.24</div>
<div class="line"><a id="l02152" name="l02152"></a><span class="lineno"> 2152</span><span class="comment">!</span></div>
<div class="line"><a id="l02153" name="l02153"></a><span class="lineno"> 2153</span> </div>
<div class="line"><a id="l02154" name="l02154"></a><span class="lineno"> 2154</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02155" name="l02155"></a><span class="lineno"> 2155</span><span class="comment">! VEGETATION GREENNESS FRACTION REDUCTION IN SUBSURFACE HEAT FLUX</span></div>
<div class="line"><a id="l02156" name="l02156"></a><span class="lineno"> 2156</span><span class="comment">! VIA REDUCTION FACTOR, WHICH IS CONVENIENT TO APPLY HERE TO THERMAL</span></div>
<div class="line"><a id="l02157" name="l02157"></a><span class="lineno"> 2157</span><span class="comment">! DIFFUSIVITY THAT IS LATER USED IN HRT TO COMPUTE SUB SFC HEAT FLUX</span></div>
<div class="line"><a id="l02158" name="l02158"></a><span class="lineno"> 2158</span><span class="comment">! (SEE ADDITIONAL COMMENTS ON VEG EFFECT SUB-SFC HEAT FLX IN</span></div>
<div class="line"><a id="l02159" name="l02159"></a><span class="lineno"> 2159</span><span class="comment">! ROUTINE SFLX)</span></div>
<div class="line"><a id="l02160" name="l02160"></a><span class="lineno"> 2160</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02161" name="l02161"></a><span class="lineno"> 2161</span>      df1 = df1 * exp(sbeta * shdfac)</div>
<div class="line"><a id="l02162" name="l02162"></a><span class="lineno"> 2162</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02163" name="l02163"></a><span class="lineno"> 2163</span><span class="comment">! COMPUTE INTERMEDIATE TERMS PASSED TO ROUTINE HRT (VIA ROUTINE</span></div>
<div class="line"><a id="l02164" name="l02164"></a><span class="lineno"> 2164</span><span class="comment">! SHFLX BELOW) FOR USE IN COMPUTING SUBSURFACE HEAT FLUX IN HRT</span></div>
<div class="line"><a id="l02165" name="l02165"></a><span class="lineno"> 2165</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02166" name="l02166"></a><span class="lineno"> 2166</span>      yynum = fdown - emissi*<a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a41b56481dda78f3181c7e40721fa79a0">sigma</a> * t24</div>
<div class="line"><a id="l02167" name="l02167"></a><span class="lineno"> 2167</span>      yy = sfctmp + (yynum / rch + th2- sfctmp - beta * epsca) / rr</div>
<div class="line"><a id="l02168" name="l02168"></a><span class="lineno"> 2168</span> </div>
<div class="line"><a id="l02169" name="l02169"></a><span class="lineno"> 2169</span>      zz1 = df1 / ( -0.5 * zsoil(1) * rch * rr ) + 1.0</div>
<div class="line"><a id="l02170" name="l02170"></a><span class="lineno"> 2170</span> </div>
<div class="line"><a id="l02171" name="l02171"></a><span class="lineno"> 2171</span><span class="comment">!urban</span></div>
<div class="line"><a id="l02172" name="l02172"></a><span class="lineno"> 2172</span>      <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#aaee442f9d981b7c296c5932352365351">shflx</a> (ssoil,stc,smc,smcmax,nsoil,t1,dt,yy,zz1,zsoil,       &amp;</div>
<div class="line"><a id="l02173" name="l02173"></a><span class="lineno"> 2173</span>                  tbot,zbot,smcwlt,psisat,sh2o,bexp,f1,df1,            &amp;</div>
<div class="line"><a id="l02174" name="l02174"></a><span class="lineno"> 2174</span>                  quartz,csoil,vegtyp,isurban,soiltyp,opt_thcnd        &amp;</div>
<div class="line"><a id="l02175" name="l02175"></a><span class="lineno"> 2175</span>                 ,hcpct_fasdas                                         ) <span class="comment">!fasdas</span></div>
<div class="line"><a id="l02176" name="l02176"></a><span class="lineno"> 2176</span> </div>
<div class="line"><a id="l02177" name="l02177"></a><span class="lineno"> 2177</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02178" name="l02178"></a><span class="lineno"> 2178</span><span class="comment">! SET FLX1 AND FLX3 (SNOPACK PHASE CHANGE HEAT FLUXES) TO ZERO SINCE</span></div>
<div class="line"><a id="l02179" name="l02179"></a><span class="lineno"> 2179</span><span class="comment">! THEY ARE NOT USED HERE IN SNOPAC.  FLX2 (FREEZING RAIN HEAT FLUX) WAS</span></div>
<div class="line"><a id="l02180" name="l02180"></a><span class="lineno"> 2180</span><span class="comment">! SIMILARLY INITIALIZED IN THE PENMAN ROUTINE.</span></div>
<div class="line"><a id="l02181" name="l02181"></a><span class="lineno"> 2181</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02182" name="l02182"></a><span class="lineno"> 2182</span>      flx1 = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#ae07d087354ac15d439a02c8f0a1d24e4">cph2o</a> * prcp * (t1- sfctmp)</div>
<div class="line"><a id="l02183" name="l02183"></a><span class="lineno"> 2183</span>      flx3 = 0.0</div>
<div class="line"><a id="l02184" name="l02184"></a><span class="lineno"> 2184</span> </div>
<div class="line"><a id="l02185" name="l02185"></a><span class="lineno"> 2185</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02186" name="l02186"></a><span class="lineno"> 2186</span>  <span class="keyword">END SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a010cd10c8d345760dec2a6bddbb5170f">nopac</a></div>
<div class="line"><a id="l02187" name="l02187"></a><span class="lineno"> 2187</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02188" name="l02188"></a><span class="lineno"> 2188</span> </div>
<div class="line"><a id="l02189" name="l02189"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#a5312fbbf31302c20e6823a3d2e97033b"> 2189</a></span>      <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a5312fbbf31302c20e6823a3d2e97033b">penman</a> (SFCTMP,SFCPRS,CH,T2V,TH2,PRCP,FDOWN,T24,SSOIL, &amp;</div>
<div class="line"><a id="l02190" name="l02190"></a><span class="lineno"> 2190</span>     &amp;                   Q2,Q2SAT,ETP,RCH,EPSCA,RR,SNOWNG,FRZGRA,       &amp;</div>
<div class="line"><a id="l02191" name="l02191"></a><span class="lineno"> 2191</span>     &amp;                   DQSDT2,FLX2,EMISSI_IN,SNEQV,T1,SNCOVR,AOASIS,  &amp;</div>
<div class="line"><a id="l02192" name="l02192"></a><span class="lineno"> 2192</span>                 ALBEDO,SOLDN,FVB,GAMA,STC1,ETPN,FLX4,UA_PHYS)</div>
<div class="line"><a id="l02193" name="l02193"></a><span class="lineno"> 2193</span> </div>
<div class="line"><a id="l02194" name="l02194"></a><span class="lineno"> 2194</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02195" name="l02195"></a><span class="lineno"> 2195</span><span class="comment">! SUBROUTINE PENMAN</span></div>
<div class="line"><a id="l02196" name="l02196"></a><span class="lineno"> 2196</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02197" name="l02197"></a><span class="lineno"> 2197</span><span class="comment">! CALCULATE POTENTIAL EVAPORATION FOR THE CURRENT POINT.  VARIOUS</span></div>
<div class="line"><a id="l02198" name="l02198"></a><span class="lineno"> 2198</span><span class="comment">! PARTIAL SUMS/PRODUCTS ARE ALSO CALCULATED AND PASSED BACK TO THE</span></div>
<div class="line"><a id="l02199" name="l02199"></a><span class="lineno"> 2199</span><span class="comment">! CALLING ROUTINE FOR LATER USE.</span></div>
<div class="line"><a id="l02200" name="l02200"></a><span class="lineno"> 2200</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02201" name="l02201"></a><span class="lineno"> 2201</span>      <span class="keywordtype">IMPLICIT NONE</span></div>
<div class="line"><a id="l02202" name="l02202"></a><span class="lineno"> 2202</span>      <span class="keywordtype">LOGICAL</span>, <span class="keywordtype">INTENT(IN)</span>     :: SNOWNG, FRZGRA</div>
<div class="line"><a id="l02203" name="l02203"></a><span class="lineno"> 2203</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(IN)</span>        :: CH, DQSDT2,FDOWN,PRCP,                 &amp;</div>
<div class="line"><a id="l02204" name="l02204"></a><span class="lineno"> 2204</span>                                 Q2, Q2SAT,SSOIL, SFCPRS, SFCTMP,       &amp;</div>
<div class="line"><a id="l02205" name="l02205"></a><span class="lineno"> 2205</span>                                 T2V, TH2,EMISSI_IN,SNEQV,AOASIS</div>
<div class="line"><a id="l02206" name="l02206"></a><span class="lineno"> 2206</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(IN)</span>        :: T1 , SNCOVR</div>
<div class="line"><a id="l02207" name="l02207"></a><span class="lineno"> 2207</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(IN)</span>        :: ALBEDO,SOLDN,FVB,GAMA,STC1</div>
<div class="line"><a id="l02208" name="l02208"></a><span class="lineno"> 2208</span>      <span class="keywordtype">LOGICAL</span>, <span class="keywordtype">INTENT(IN)</span>     :: UA_PHYS</div>
<div class="line"><a id="l02209" name="l02209"></a><span class="lineno"> 2209</span><span class="comment">!</span></div>
<div class="line"><a id="l02210" name="l02210"></a><span class="lineno"> 2210</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(OUT)</span>       :: EPSCA,ETP,FLX2,RCH,RR,T24</div>
<div class="line"><a id="l02211" name="l02211"></a><span class="lineno"> 2211</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(OUT)</span>       :: FLX4,ETPN</div>
<div class="line"><a id="l02212" name="l02212"></a><span class="lineno"> 2212</span><span class="keywordtype">      REAL</span>                    :: A, DELTA, FNET,RAD,RHO,EMISSI,ELCP1,LVS</div>
<div class="line"><a id="l02213" name="l02213"></a><span class="lineno"> 2213</span><span class="keywordtype">      REAL</span>                    :: TOTABS,UCABS,SIGNCK,FNETN,RADN,EPSCAN</div>
<div class="line"><a id="l02214" name="l02214"></a><span class="lineno"> 2214</span> </div>
<div class="line"><a id="l02215" name="l02215"></a><span class="lineno"> 2215</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">PARAMETER</span>      :: ELCP = 2.4888e+3, lsubc = 2.501000e+6,cp = 1004.6</div>
<div class="line"><a id="l02216" name="l02216"></a><span class="lineno"> 2216</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">PARAMETER</span>      :: LSUBS = 2.83e+6</div>
<div class="line"><a id="l02217" name="l02217"></a><span class="lineno"> 2217</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">PARAMETER</span>      :: ALGDSN = 0.5, alvgsn = 0.13</div>
<div class="line"><a id="l02218" name="l02218"></a><span class="lineno"> 2218</span> </div>
<div class="line"><a id="l02219" name="l02219"></a><span class="lineno"> 2219</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02220" name="l02220"></a><span class="lineno"> 2220</span><span class="comment">! EXECUTABLE CODE BEGINS HERE:</span></div>
<div class="line"><a id="l02221" name="l02221"></a><span class="lineno"> 2221</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02222" name="l02222"></a><span class="lineno"> 2222</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02223" name="l02223"></a><span class="lineno"> 2223</span><span class="comment">! PREPARE PARTIAL QUANTITIES FOR PENMAN EQUATION.</span></div>
<div class="line"><a id="l02224" name="l02224"></a><span class="lineno"> 2224</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02225" name="l02225"></a><span class="lineno"> 2225</span>        emissi=emissi_in</div>
<div class="line"><a id="l02226" name="l02226"></a><span class="lineno"> 2226</span>        elcp1  = (1.0-sncovr)*elcp  + sncovr*elcp*lsubs/lsubc</div>
<div class="line"><a id="l02227" name="l02227"></a><span class="lineno"> 2227</span>        lvs    = (1.0-sncovr)*lsubc + sncovr*lsubs</div>
<div class="line"><a id="l02228" name="l02228"></a><span class="lineno"> 2228</span> </div>
<div class="line"><a id="l02229" name="l02229"></a><span class="lineno"> 2229</span>      flx2 = 0.0</div>
<div class="line"><a id="l02230" name="l02230"></a><span class="lineno"> 2230</span><span class="comment">!      DELTA = ELCP * DQSDT2</span></div>
<div class="line"><a id="l02231" name="l02231"></a><span class="lineno"> 2231</span>      delta = elcp1 * dqsdt2</div>
<div class="line"><a id="l02232" name="l02232"></a><span class="lineno"> 2232</span>      t24 = sfctmp * sfctmp * sfctmp * sfctmp</div>
<div class="line"><a id="l02233" name="l02233"></a><span class="lineno"> 2233</span><span class="comment">!      RR = T24 * 6.48E-8 / (SFCPRS * CH) + 1.0</span></div>
<div class="line"><a id="l02234" name="l02234"></a><span class="lineno"> 2234</span>      rr = emissi*t24 * 6.48e-8 / (sfcprs * ch) + 1.0</div>
<div class="line"><a id="l02235" name="l02235"></a><span class="lineno"> 2235</span>      rho = sfcprs / (<a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a8df53633c056358bfa76c698ee182f17">rd</a> * t2v)</div>
<div class="line"><a id="l02236" name="l02236"></a><span class="lineno"> 2236</span> </div>
<div class="line"><a id="l02237" name="l02237"></a><span class="lineno"> 2237</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02238" name="l02238"></a><span class="lineno"> 2238</span><span class="comment">! ADJUST THE PARTIAL SUMS / PRODUCTS WITH THE LATENT HEAT</span></div>
<div class="line"><a id="l02239" name="l02239"></a><span class="lineno"> 2239</span><span class="comment">! EFFECTS CAUSED BY FALLING PRECIPITATION.</span></div>
<div class="line"><a id="l02240" name="l02240"></a><span class="lineno"> 2240</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02241" name="l02241"></a><span class="lineno"> 2241</span>      rch = rho * cp * ch</div>
<div class="line"><a id="l02242" name="l02242"></a><span class="lineno"> 2242</span>      <span class="keywordflow">IF</span> (.NOT. snowng) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l02243" name="l02243"></a><span class="lineno"> 2243</span>         <span class="keywordflow">IF</span> (prcp &gt;  0.0) rr = rr + <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#ae07d087354ac15d439a02c8f0a1d24e4">cph2o</a> * prcp / rch</div>
<div class="line"><a id="l02244" name="l02244"></a><span class="lineno"> 2244</span>      <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l02245" name="l02245"></a><span class="lineno"> 2245</span>         rr = rr + <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a653d3903e2acbd4d19387ea434944093">cpice</a> * prcp / rch</div>
<div class="line"><a id="l02246" name="l02246"></a><span class="lineno"> 2246</span><span class="keywordflow">      END IF</span></div>
<div class="line"><a id="l02247" name="l02247"></a><span class="lineno"> 2247</span> </div>
<div class="line"><a id="l02248" name="l02248"></a><span class="lineno"> 2248</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02249" name="l02249"></a><span class="lineno"> 2249</span><span class="comment">! INCLUDE THE LATENT HEAT EFFECTS OF FRZNG RAIN CONVERTING TO ICE ON</span></div>
<div class="line"><a id="l02250" name="l02250"></a><span class="lineno"> 2250</span><span class="comment">! IMPACT IN THE CALCULATION OF FLX2 AND FNET.</span></div>
<div class="line"><a id="l02251" name="l02251"></a><span class="lineno"> 2251</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02252" name="l02252"></a><span class="lineno"> 2252</span><span class="comment">!      FNET = FDOWN - SIGMA * T24- SSOIL</span></div>
<div class="line"><a id="l02253" name="l02253"></a><span class="lineno"> 2253</span>      fnet = fdown -  emissi*<a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a41b56481dda78f3181c7e40721fa79a0">sigma</a> * t24- ssoil</div>
<div class="line"><a id="l02254" name="l02254"></a><span class="lineno"> 2254</span> </div>
<div class="line"><a id="l02255" name="l02255"></a><span class="lineno"> 2255</span>      flx4 = 0.0</div>
<div class="line"><a id="l02256" name="l02256"></a><span class="lineno"> 2256</span>      <span class="keywordflow">IF</span>(ua_phys) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l02257" name="l02257"></a><span class="lineno"> 2257</span>        <span class="keywordflow">IF</span>(sneqv &gt; 0. .AND. fnet &gt; 0. .AND. soldn &gt; 0. ) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l02258" name="l02258"></a><span class="lineno"> 2258</span>         totabs = (1.-albedo)*soldn*fvb           <span class="comment">! solar radiation absorbed </span></div>
<div class="line"><a id="l02259" name="l02259"></a><span class="lineno"> 2259</span>                                                  <span class="comment">! by vegetated fraction</span></div>
<div class="line"><a id="l02260" name="l02260"></a><span class="lineno"> 2260</span>         ucabs = min(totabs,((1.0-algdsn)*(1.0-alvgsn)*soldn*gama)*fvb)</div>
<div class="line"><a id="l02261" name="l02261"></a><span class="lineno"> 2261</span><span class="comment">!         print*,&#39;penman&#39;,UCABS,TOTABS,SOLDN,GAMA,FVB</span></div>
<div class="line"><a id="l02262" name="l02262"></a><span class="lineno"> 2262</span><span class="comment">!         UCABS = MIN(TOTABS,(0.44*SOLDN*GAMA)*FVB)  </span></div>
<div class="line"><a id="l02263" name="l02263"></a><span class="lineno"> 2263</span>                                                  <span class="comment">! UCABS -&gt; solar radiation</span></div>
<div class="line"><a id="l02264" name="l02264"></a><span class="lineno"> 2264</span>                          <span class="comment">! absorbed under canopy</span></div>
<div class="line"><a id="l02265" name="l02265"></a><span class="lineno"> 2265</span>         flx4 = min(totabs - ucabs, min(250., 0.5*(1.-albedo)*soldn))</div>
<div class="line"><a id="l02266" name="l02266"></a><span class="lineno"> 2266</span><span class="keywordflow">        ENDIF</span></div>
<div class="line"><a id="l02267" name="l02267"></a><span class="lineno"> 2267</span> </div>
<div class="line"><a id="l02268" name="l02268"></a><span class="lineno"> 2268</span>        signck = (stc1-273.15)*(sfctmp-273.15)</div>
<div class="line"><a id="l02269" name="l02269"></a><span class="lineno"> 2269</span> </div>
<div class="line"><a id="l02270" name="l02270"></a><span class="lineno"> 2270</span>        <span class="keywordflow">IF</span>(flx4 &gt; 0. .AND. (signck &lt;= 0. .OR. stc1 &lt; 273.15)) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l02271" name="l02271"></a><span class="lineno"> 2271</span>          <span class="keywordflow">IF</span>(fnet &gt;= flx4) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l02272" name="l02272"></a><span class="lineno"> 2272</span>           fnetn = fnet - flx4</div>
<div class="line"><a id="l02273" name="l02273"></a><span class="lineno"> 2273</span>          <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l02274" name="l02274"></a><span class="lineno"> 2274</span>           flx4 = fnet</div>
<div class="line"><a id="l02275" name="l02275"></a><span class="lineno"> 2275</span>           fnetn = 0.</div>
<div class="line"><a id="l02276" name="l02276"></a><span class="lineno"> 2276</span><span class="keywordflow">          ENDIF</span></div>
<div class="line"><a id="l02277" name="l02277"></a><span class="lineno"> 2277</span>        <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l02278" name="l02278"></a><span class="lineno"> 2278</span>          flx4 = 0.0</div>
<div class="line"><a id="l02279" name="l02279"></a><span class="lineno"> 2279</span>          fnetn = 0.</div>
<div class="line"><a id="l02280" name="l02280"></a><span class="lineno"> 2280</span><span class="keywordflow">        ENDIF</span></div>
<div class="line"><a id="l02281" name="l02281"></a><span class="lineno"> 2281</span><span class="keywordflow">      ENDIF</span></div>
<div class="line"><a id="l02282" name="l02282"></a><span class="lineno"> 2282</span> </div>
<div class="line"><a id="l02283" name="l02283"></a><span class="lineno"> 2283</span>      <span class="keywordflow">IF</span> (frzgra) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l02284" name="l02284"></a><span class="lineno"> 2284</span>         flx2 = - <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a81f1f2ceb78e6b6a447b394803dee3c7">lsubf</a> * prcp</div>
<div class="line"><a id="l02285" name="l02285"></a><span class="lineno"> 2285</span>         fnet = fnet - flx2</div>
<div class="line"><a id="l02286" name="l02286"></a><span class="lineno"> 2286</span>         <span class="keywordflow">IF</span>(ua_phys) fnetn = fnetn - flx2</div>
<div class="line"><a id="l02287" name="l02287"></a><span class="lineno"> 2287</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02288" name="l02288"></a><span class="lineno"> 2288</span><span class="comment">! FINISH PENMAN EQUATION CALCULATIONS.</span></div>
<div class="line"><a id="l02289" name="l02289"></a><span class="lineno"> 2289</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02290" name="l02290"></a><span class="lineno"> 2290</span><span class="keywordflow">      END IF</span></div>
<div class="line"><a id="l02291" name="l02291"></a><span class="lineno"> 2291</span>      rad = fnet / rch + th2- sfctmp</div>
<div class="line"><a id="l02292" name="l02292"></a><span class="lineno"> 2292</span><span class="comment">!      A = ELCP * (Q2SAT - Q2)</span></div>
<div class="line"><a id="l02293" name="l02293"></a><span class="lineno"> 2293</span>      a = elcp1 * (q2sat - q2)</div>
<div class="line"><a id="l02294" name="l02294"></a><span class="lineno"> 2294</span>      epsca = (a * rr + rad * delta) / (delta + rr)</div>
<div class="line"><a id="l02295" name="l02295"></a><span class="lineno"> 2295</span><span class="comment">! Fei-Mike</span></div>
<div class="line"><a id="l02296" name="l02296"></a><span class="lineno"> 2296</span>      <span class="keywordflow">IF</span> (epsca&gt;0.) epsca = epsca * aoasis</div>
<div class="line"><a id="l02297" name="l02297"></a><span class="lineno"> 2297</span><span class="comment">!      ETP = EPSCA * RCH / LSUBC</span></div>
<div class="line"><a id="l02298" name="l02298"></a><span class="lineno"> 2298</span>      etp = epsca * rch / lvs</div>
<div class="line"><a id="l02299" name="l02299"></a><span class="lineno"> 2299</span> </div>
<div class="line"><a id="l02300" name="l02300"></a><span class="lineno"> 2300</span>      <span class="keywordflow">IF</span>(ua_phys) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l02301" name="l02301"></a><span class="lineno"> 2301</span>        radn = fnetn / rch + th2- sfctmp</div>
<div class="line"><a id="l02302" name="l02302"></a><span class="lineno"> 2302</span>        epscan = (a * rr + radn * delta) / (delta + rr)</div>
<div class="line"><a id="l02303" name="l02303"></a><span class="lineno"> 2303</span>        etpn = epscan * rch / lvs</div>
<div class="line"><a id="l02304" name="l02304"></a><span class="lineno"> 2304</span><span class="keywordflow">      END IF</span></div>
<div class="line"><a id="l02305" name="l02305"></a><span class="lineno"> 2305</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02306" name="l02306"></a><span class="lineno"> 2306</span>  <span class="keyword">END SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a5312fbbf31302c20e6823a3d2e97033b">penman</a></div>
<div class="line"><a id="l02307" name="l02307"></a><span class="lineno"> 2307</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02308" name="l02308"></a><span class="lineno"> 2308</span> </div>
<div class="line"><a id="l02309" name="l02309"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#a035da859804652a83bc5fd235e70b2e0"> 2309</a></span>      <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a035da859804652a83bc5fd235e70b2e0">redprm</a> (VEGTYP,SOILTYP,SLOPETYP,CFACTR,CMCMAX,RSMAX,      &amp;</div>
<div class="line"><a id="l02310" name="l02310"></a><span class="lineno"> 2310</span>                         TOPT,                                             &amp;</div>
<div class="line"><a id="l02311" name="l02311"></a><span class="lineno"> 2311</span>                         REFKDT,KDT,SBETA, SHDFAC,RSMIN,RGL,HS,ZBOT,FRZX,  &amp;</div>
<div class="line"><a id="l02312" name="l02312"></a><span class="lineno"> 2312</span>                         PSISAT,SLOPE,SNUP,SALP,BEXP,DKSAT,DWSAT,          &amp;</div>
<div class="line"><a id="l02313" name="l02313"></a><span class="lineno"> 2313</span>                         SMCMAX,SMCWLT,SMCREF,SMCDRY,F1,QUARTZ,FXEXP,      &amp;</div>
<div class="line"><a id="l02314" name="l02314"></a><span class="lineno"> 2314</span>                         RTDIS,SLDPTH,ZSOIL, NROOT,NSOIL,CZIL,             &amp;</div>
<div class="line"><a id="l02315" name="l02315"></a><span class="lineno"> 2315</span>                         LAIMIN, LAIMAX, EMISSMIN, EMISSMAX, ALBEDOMIN,    &amp;</div>
<div class="line"><a id="l02316" name="l02316"></a><span class="lineno"> 2316</span>                         ALBEDOMAX, Z0MIN, Z0MAX, CSOIL, PTU, LLANDUSE,    &amp;</div>
<div class="line"><a id="l02317" name="l02317"></a><span class="lineno"> 2317</span>                         LSOIL, LOCAL,LVCOEF,ZTOPV,ZBOTV)</div>
<div class="line"><a id="l02318" name="l02318"></a><span class="lineno"> 2318</span> </div>
<div class="line"><a id="l02319" name="l02319"></a><span class="lineno"> 2319</span>      <span class="keywordtype">IMPLICIT NONE</span></div>
<div class="line"><a id="l02320" name="l02320"></a><span class="lineno"> 2320</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02321" name="l02321"></a><span class="lineno"> 2321</span><span class="comment">! Internally set (default valuess)</span></div>
<div class="line"><a id="l02322" name="l02322"></a><span class="lineno"> 2322</span><span class="comment">! all soil and vegetation parameters required for the execusion oF</span></div>
<div class="line"><a id="l02323" name="l02323"></a><span class="lineno"> 2323</span><span class="comment">! the Noah lsm are defined in VEGPARM.TBL, SOILPARM.TB, and GENPARM.TBL.</span></div>
<div class="line"><a id="l02324" name="l02324"></a><span class="lineno"> 2324</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02325" name="l02325"></a><span class="lineno"> 2325</span><span class="comment">!     Vegetation parameters:</span></div>
<div class="line"><a id="l02326" name="l02326"></a><span class="lineno"> 2326</span><span class="comment">!             ALBBRD: SFC background snow-free albedo</span></div>
<div class="line"><a id="l02327" name="l02327"></a><span class="lineno"> 2327</span><span class="comment">!             CMXTBL: MAX CNPY Capacity</span></div>
<div class="line"><a id="l02328" name="l02328"></a><span class="lineno"> 2328</span><span class="comment">!              Z0BRD: Background roughness length</span></div>
<div class="line"><a id="l02329" name="l02329"></a><span class="lineno"> 2329</span><span class="comment">!             SHDFAC: Green vegetation fraction</span></div>
<div class="line"><a id="l02330" name="l02330"></a><span class="lineno"> 2330</span><span class="comment">!              NROOT: Rooting depth</span></div>
<div class="line"><a id="l02331" name="l02331"></a><span class="lineno"> 2331</span><span class="comment">!              RSMIN: Mimimum stomatal resistance</span></div>
<div class="line"><a id="l02332" name="l02332"></a><span class="lineno"> 2332</span><span class="comment">!              RSMAX: Max. stomatal resistance</span></div>
<div class="line"><a id="l02333" name="l02333"></a><span class="lineno"> 2333</span><span class="comment">!                RGL: Parameters used in radiation stress function</span></div>
<div class="line"><a id="l02334" name="l02334"></a><span class="lineno"> 2334</span><span class="comment">!                 HS: Parameter used in vapor pressure deficit functio</span></div>
<div class="line"><a id="l02335" name="l02335"></a><span class="lineno"> 2335</span><span class="comment">!               TOPT: Optimum transpiration air temperature.</span></div>
<div class="line"><a id="l02336" name="l02336"></a><span class="lineno"> 2336</span><span class="comment">!             CMCMAX: Maximum canopy water capacity</span></div>
<div class="line"><a id="l02337" name="l02337"></a><span class="lineno"> 2337</span><span class="comment">!             CFACTR: Parameter used in the canopy inteception calculation</span></div>
<div class="line"><a id="l02338" name="l02338"></a><span class="lineno"> 2338</span><span class="comment">!               SNUP: Threshold snow depth (in water equivalent m) that</span></div>
<div class="line"><a id="l02339" name="l02339"></a><span class="lineno"> 2339</span><span class="comment">!                     implies 100 percent snow cover</span></div>
<div class="line"><a id="l02340" name="l02340"></a><span class="lineno"> 2340</span><span class="comment">!                LAI: Leaf area index</span></div>
<div class="line"><a id="l02341" name="l02341"></a><span class="lineno"> 2341</span><span class="comment">!</span></div>
<div class="line"><a id="l02342" name="l02342"></a><span class="lineno"> 2342</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02343" name="l02343"></a><span class="lineno"> 2343</span><span class="comment">!      Soil parameters:</span></div>
<div class="line"><a id="l02344" name="l02344"></a><span class="lineno"> 2344</span><span class="comment">!        SMCMAX: MAX soil moisture content (porosity)</span></div>
<div class="line"><a id="l02345" name="l02345"></a><span class="lineno"> 2345</span><span class="comment">!        SMCREF: Reference soil moisture  (field capacity)</span></div>
<div class="line"><a id="l02346" name="l02346"></a><span class="lineno"> 2346</span><span class="comment">!        SMCWLT: Wilting point soil moisture</span></div>
<div class="line"><a id="l02347" name="l02347"></a><span class="lineno"> 2347</span><span class="comment">!        SMCWLT: Air dry soil moist content limits</span></div>
<div class="line"><a id="l02348" name="l02348"></a><span class="lineno"> 2348</span><span class="comment">!       SSATPSI: SAT (saturation) soil potential</span></div>
<div class="line"><a id="l02349" name="l02349"></a><span class="lineno"> 2349</span><span class="comment">!         DKSAT: SAT soil conductivity</span></div>
<div class="line"><a id="l02350" name="l02350"></a><span class="lineno"> 2350</span><span class="comment">!          BEXP: B parameter</span></div>
<div class="line"><a id="l02351" name="l02351"></a><span class="lineno"> 2351</span><span class="comment">!        SSATDW: SAT soil diffusivity</span></div>
<div class="line"><a id="l02352" name="l02352"></a><span class="lineno"> 2352</span><span class="comment">!           F1: Soil thermal diffusivity/conductivity coef.</span></div>
<div class="line"><a id="l02353" name="l02353"></a><span class="lineno"> 2353</span><span class="comment">!        QUARTZ: Soil quartz content</span></div>
<div class="line"><a id="l02354" name="l02354"></a><span class="lineno"> 2354</span><span class="comment">!  Modified by F. Chen (12/22/97)  to use the STATSGO soil map</span></div>
<div class="line"><a id="l02355" name="l02355"></a><span class="lineno"> 2355</span><span class="comment">!  Modified By F. Chen (01/22/00)  to include PLaya, Lava, and White San</span></div>
<div class="line"><a id="l02356" name="l02356"></a><span class="lineno"> 2356</span><span class="comment">!  Modified By F. Chen (08/05/02)  to include additional parameters for the Noah</span></div>
<div class="line"><a id="l02357" name="l02357"></a><span class="lineno"> 2357</span><span class="comment">! NOTE: SATDW = BB*SATDK*(SATPSI/MAXSMC)</span></div>
<div class="line"><a id="l02358" name="l02358"></a><span class="lineno"> 2358</span><span class="comment">!         F11 = ALOG10(SATPSI) + BB*ALOG10(MAXSMC) + 2.0</span></div>
<div class="line"><a id="l02359" name="l02359"></a><span class="lineno"> 2359</span><span class="comment">!       REFSMC1=MAXSMC*(5.79E-9/SATDK)**(1/(2*BB+3)) 5.79E-9 m/s= 0.5 mm</span></div>
<div class="line"><a id="l02360" name="l02360"></a><span class="lineno"> 2360</span><span class="comment">!       REFSMC=REFSMC1+1./3.(MAXSMC-REFSMC1)</span></div>
<div class="line"><a id="l02361" name="l02361"></a><span class="lineno"> 2361</span><span class="comment">!       WLTSMC1=MAXSMC*(200./SATPSI)**(-1./BB)    (Wetzel and Chang, 198</span></div>
<div class="line"><a id="l02362" name="l02362"></a><span class="lineno"> 2362</span><span class="comment">!       WLTSMC=WLTSMC1-0.5*WLTSMC1</span></div>
<div class="line"><a id="l02363" name="l02363"></a><span class="lineno"> 2363</span><span class="comment">! Note: the values for playa is set for it to have a thermal conductivit</span></div>
<div class="line"><a id="l02364" name="l02364"></a><span class="lineno"> 2364</span><span class="comment">! as sand and to have a hydrulic conductivity as clay</span></div>
<div class="line"><a id="l02365" name="l02365"></a><span class="lineno"> 2365</span><span class="comment">!</span></div>
<div class="line"><a id="l02366" name="l02366"></a><span class="lineno"> 2366</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02367" name="l02367"></a><span class="lineno"> 2367</span><span class="comment">! Class parameter &#39;SLOPETYP&#39; was included to estimate linear reservoir</span></div>
<div class="line"><a id="l02368" name="l02368"></a><span class="lineno"> 2368</span><span class="comment">! coefficient &#39;SLOPE&#39; to the baseflow runoff out of the bottom layer.</span></div>
<div class="line"><a id="l02369" name="l02369"></a><span class="lineno"> 2369</span><span class="comment">! lowest class (slopetyp=0) means highest slope parameter = 1.</span></div>
<div class="line"><a id="l02370" name="l02370"></a><span class="lineno"> 2370</span><span class="comment">! definition of slopetyp from &#39;zobler&#39; slope type:</span></div>
<div class="line"><a id="l02371" name="l02371"></a><span class="lineno"> 2371</span><span class="comment">! slope class  percent slope</span></div>
<div class="line"><a id="l02372" name="l02372"></a><span class="lineno"> 2372</span><span class="comment">! 1            0-8</span></div>
<div class="line"><a id="l02373" name="l02373"></a><span class="lineno"> 2373</span><span class="comment">! 2            8-30</span></div>
<div class="line"><a id="l02374" name="l02374"></a><span class="lineno"> 2374</span><span class="comment">! 3            &gt; 30</span></div>
<div class="line"><a id="l02375" name="l02375"></a><span class="lineno"> 2375</span><span class="comment">! 4            0-30</span></div>
<div class="line"><a id="l02376" name="l02376"></a><span class="lineno"> 2376</span><span class="comment">! 5            0-8 &amp; &gt; 30</span></div>
<div class="line"><a id="l02377" name="l02377"></a><span class="lineno"> 2377</span><span class="comment">! 6            8-30 &amp; &gt; 30</span></div>
<div class="line"><a id="l02378" name="l02378"></a><span class="lineno"> 2378</span><span class="comment">! 7            0-8, 8-30, &gt; 30</span></div>
<div class="line"><a id="l02379" name="l02379"></a><span class="lineno"> 2379</span><span class="comment">! 9            GLACIAL ICE</span></div>
<div class="line"><a id="l02380" name="l02380"></a><span class="lineno"> 2380</span><span class="comment">! BLANK        OCEAN/SEA</span></div>
<div class="line"><a id="l02381" name="l02381"></a><span class="lineno"> 2381</span><span class="comment">!       SLOPE_DATA: linear reservoir coefficient</span></div>
<div class="line"><a id="l02382" name="l02382"></a><span class="lineno"> 2382</span><span class="comment">!       SBETA_DATA: parameter used to caluculate vegetation effect on soil heat</span></div>
<div class="line"><a id="l02383" name="l02383"></a><span class="lineno"> 2383</span><span class="comment">!       FXEXP_DAT:  soil evaporation exponent used in DEVAP</span></div>
<div class="line"><a id="l02384" name="l02384"></a><span class="lineno"> 2384</span><span class="comment">!       CSOIL_DATA: soil heat capacity [J M-3 K-1]</span></div>
<div class="line"><a id="l02385" name="l02385"></a><span class="lineno"> 2385</span><span class="comment">!       SALP_DATA: shape parameter of  distribution function of snow cover</span></div>
<div class="line"><a id="l02386" name="l02386"></a><span class="lineno"> 2386</span><span class="comment">!       REFDK_DATA and REFKDT_DATA: parameters in the surface runoff parameteriz</span></div>
<div class="line"><a id="l02387" name="l02387"></a><span class="lineno"> 2387</span><span class="comment">!       FRZK_DATA: frozen ground parameter</span></div>
<div class="line"><a id="l02388" name="l02388"></a><span class="lineno"> 2388</span><span class="comment">!       ZBOT_DATA: depth[M] of lower boundary soil temperature</span></div>
<div class="line"><a id="l02389" name="l02389"></a><span class="lineno"> 2389</span><span class="comment">!       CZIL_DATA: calculate roughness length of heat</span></div>
<div class="line"><a id="l02390" name="l02390"></a><span class="lineno"> 2390</span><span class="comment">!       SMLOW_DATA and MHIGH_DATA: two soil moisture wilt, soil moisture referen</span></div>
<div class="line"><a id="l02391" name="l02391"></a><span class="lineno"> 2391</span><span class="comment">!                 parameters</span></div>
<div class="line"><a id="l02392" name="l02392"></a><span class="lineno"> 2392</span><span class="comment">! Set maximum number of soil-, veg-, and slopetyp in data statement.</span></div>
<div class="line"><a id="l02393" name="l02393"></a><span class="lineno"> 2393</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02394" name="l02394"></a><span class="lineno"> 2394</span>      <span class="keywordtype">INTEGER</span>, <span class="keywordtype">PARAMETER</span>     :: MAX_SLOPETYP=30,max_soiltyp=30,max_vegtyp=30</div>
<div class="line"><a id="l02395" name="l02395"></a><span class="lineno"> 2395</span>      <span class="keywordtype">LOGICAL</span>                :: LOCAL</div>
<div class="line"><a id="l02396" name="l02396"></a><span class="lineno"> 2396</span>      <span class="keywordtype">CHARACTER (LEN=256)</span>, <span class="keywordtype">INTENT(IN)</span>::  LLANDUSE, LSOIL</div>
<div class="line"><a id="l02397" name="l02397"></a><span class="lineno"> 2397</span> </div>
<div class="line"><a id="l02398" name="l02398"></a><span class="lineno"> 2398</span><span class="comment">! Veg parameters</span></div>
<div class="line"><a id="l02399" name="l02399"></a><span class="lineno"> 2399</span>      <span class="keywordtype">INTEGER</span>, <span class="keywordtype">INTENT(IN)</span>    :: VEGTYP</div>
<div class="line"><a id="l02400" name="l02400"></a><span class="lineno"> 2400</span>      <span class="keywordtype">INTEGER</span>, <span class="keywordtype">INTENT(OUT)</span>   :: NROOT</div>
<div class="line"><a id="l02401" name="l02401"></a><span class="lineno"> 2401</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(INOUT)</span>    :: SHDFAC</div>
<div class="line"><a id="l02402" name="l02402"></a><span class="lineno"> 2402</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(OUT)</span>      :: HS,RSMIN,RGL,SNUP,                          &amp;</div>
<div class="line"><a id="l02403" name="l02403"></a><span class="lineno"> 2403</span>                                CMCMAX,RSMAX,TOPT,                          &amp;</div>
<div class="line"><a id="l02404" name="l02404"></a><span class="lineno"> 2404</span>                                EMISSMIN,  EMISSMAX,                        &amp;</div>
<div class="line"><a id="l02405" name="l02405"></a><span class="lineno"> 2405</span>                                LAIMIN,    LAIMAX,                          &amp;</div>
<div class="line"><a id="l02406" name="l02406"></a><span class="lineno"> 2406</span>                                Z0MIN,     Z0MAX,                           &amp;</div>
<div class="line"><a id="l02407" name="l02407"></a><span class="lineno"> 2407</span>                                ALBEDOMIN, ALBEDOMAX, ZTOPV, ZBOTV</div>
<div class="line"><a id="l02408" name="l02408"></a><span class="lineno"> 2408</span><span class="comment">! Soil parameters</span></div>
<div class="line"><a id="l02409" name="l02409"></a><span class="lineno"> 2409</span>      <span class="keywordtype">INTEGER</span>, <span class="keywordtype">INTENT(IN)</span>    :: SOILTYP</div>
<div class="line"><a id="l02410" name="l02410"></a><span class="lineno"> 2410</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(OUT)</span>      :: BEXP,DKSAT,DWSAT,F1,QUARTZ,SMCDRY,          &amp;</div>
<div class="line"><a id="l02411" name="l02411"></a><span class="lineno"> 2411</span>                                SMCMAX,SMCREF,SMCWLT,PSISAT</div>
<div class="line"><a id="l02412" name="l02412"></a><span class="lineno"> 2412</span><span class="comment">! General parameters</span></div>
<div class="line"><a id="l02413" name="l02413"></a><span class="lineno"> 2413</span>      <span class="keywordtype">INTEGER</span>, <span class="keywordtype">INTENT(IN)</span>    :: SLOPETYP,NSOIL</div>
<div class="line"><a id="l02414" name="l02414"></a><span class="lineno"> 2414</span>      <span class="keywordtype">INTEGER</span>                :: I</div>
<div class="line"><a id="l02415" name="l02415"></a><span class="lineno"> 2415</span> </div>
<div class="line"><a id="l02416" name="l02416"></a><span class="lineno"> 2416</span><span class="keywordtype">      REAL</span>,    <span class="keywordtype">INTENT(OUT)</span>   :: SLOPE,CZIL,SBETA,FXEXP,                     &amp;</div>
<div class="line"><a id="l02417" name="l02417"></a><span class="lineno"> 2417</span>                                CSOIL,SALP,FRZX,KDT,CFACTR,      &amp;</div>
<div class="line"><a id="l02418" name="l02418"></a><span class="lineno"> 2418</span>                                ZBOT,REFKDT,PTU</div>
<div class="line"><a id="l02419" name="l02419"></a><span class="lineno"> 2419</span><span class="keywordtype">      REAL</span>,    <span class="keywordtype">INTENT(OUT)</span>   :: LVCOEF</div>
<div class="line"><a id="l02420" name="l02420"></a><span class="lineno"> 2420</span><span class="keywordtype">      REAL</span>,<span class="keywordtype">DIMENSION(1:NSOIL)</span>,<span class="keywordtype">INTENT(IN)</span> :: SLDPTH,ZSOIL</div>
<div class="line"><a id="l02421" name="l02421"></a><span class="lineno"> 2421</span><span class="keywordtype">      REAL</span>,<span class="keywordtype">DIMENSION(1:NSOIL)</span>,<span class="keywordtype">INTENT(OUT)</span>:: RTDIS</div>
<div class="line"><a id="l02422" name="l02422"></a><span class="lineno"> 2422</span><span class="keywordtype">      REAL</span>                   :: FRZFACT,FRZK,REFDK</div>
<div class="line"><a id="l02423" name="l02423"></a><span class="lineno"> 2423</span> </div>
<div class="line"><a id="l02424" name="l02424"></a><span class="lineno"> 2424</span><span class="comment">!      SAVE</span></div>
<div class="line"><a id="l02425" name="l02425"></a><span class="lineno"> 2425</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02426" name="l02426"></a><span class="lineno"> 2426</span><span class="comment">!</span></div>
<div class="line"><a id="l02427" name="l02427"></a><span class="lineno"> 2427</span>               <span class="keywordflow">IF</span> (soiltyp .gt. <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a86862de601c92fc02c2501c1827c3da4">slcats</a>) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l02428" name="l02428"></a><span class="lineno"> 2428</span>                        fatal_error( <span class="stringliteral">&#39;Warning: too many input soil types&#39;</span> )</div>
<div class="line"><a id="l02429" name="l02429"></a><span class="lineno"> 2429</span><span class="keywordflow">               END IF</span></div>
<div class="line"><a id="l02430" name="l02430"></a><span class="lineno"> 2430</span>               <span class="keywordflow">IF</span> (vegtyp .gt. <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#aa1474706df3973c92ce572eb5517a6ca">lucats</a>) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l02431" name="l02431"></a><span class="lineno"> 2431</span>                     fatal_error( <span class="stringliteral">&#39;Warning: too many input landuse types&#39;</span> )</div>
<div class="line"><a id="l02432" name="l02432"></a><span class="lineno"> 2432</span><span class="keywordflow">               END IF</span></div>
<div class="line"><a id="l02433" name="l02433"></a><span class="lineno"> 2433</span>               <span class="keywordflow">IF</span> (slopetyp .gt. <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a347f1f27afb384360fada49937ebf1cc">slpcats</a>) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l02434" name="l02434"></a><span class="lineno"> 2434</span>                     fatal_error( <span class="stringliteral">&#39;Warning: too many input slope types&#39;</span> )</div>
<div class="line"><a id="l02435" name="l02435"></a><span class="lineno"> 2435</span><span class="keywordflow">               END IF</span></div>
<div class="line"><a id="l02436" name="l02436"></a><span class="lineno"> 2436</span> </div>
<div class="line"><a id="l02437" name="l02437"></a><span class="lineno"> 2437</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02438" name="l02438"></a><span class="lineno"> 2438</span><span class="comment">!  SET-UP SOIL PARAMETERS</span></div>
<div class="line"><a id="l02439" name="l02439"></a><span class="lineno"> 2439</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02440" name="l02440"></a><span class="lineno"> 2440</span>      csoil = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#ac05feb2a0ff4bb9285433492b2eb10f4">csoil_data</a></div>
<div class="line"><a id="l02441" name="l02441"></a><span class="lineno"> 2441</span>      bexp = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a421c11109bef5a1c768d721cb746c495">bb</a>(soiltyp)</div>
<div class="line"><a id="l02442" name="l02442"></a><span class="lineno"> 2442</span>      dksat = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a935945ddf12582dad80c67c9c88034ac">satdk</a>(soiltyp)</div>
<div class="line"><a id="l02443" name="l02443"></a><span class="lineno"> 2443</span>      dwsat = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#ab26c159cdc7754b2a7c741d846fb9e28">satdw</a>(soiltyp)</div>
<div class="line"><a id="l02444" name="l02444"></a><span class="lineno"> 2444</span>      f1 = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a5394697bf41b6a406cf68211008c2c05">f11</a>(soiltyp)</div>
<div class="line"><a id="l02445" name="l02445"></a><span class="lineno"> 2445</span>      psisat = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a2d3913e03c9d3f6dc2f1817689a70aa7">satpsi</a>(soiltyp)</div>
<div class="line"><a id="l02446" name="l02446"></a><span class="lineno"> 2446</span>      quartz = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a264ef4f6e4e0348d29a24399729c47b1">qtz</a>(soiltyp)</div>
<div class="line"><a id="l02447" name="l02447"></a><span class="lineno"> 2447</span>      smcdry = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a6e407ba242e1b07a68eb56f1180447c6">drysmc</a>(soiltyp)</div>
<div class="line"><a id="l02448" name="l02448"></a><span class="lineno"> 2448</span>      smcmax = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#ae7e9abc3699009623585d342ed700ea8">maxsmc</a>(soiltyp)</div>
<div class="line"><a id="l02449" name="l02449"></a><span class="lineno"> 2449</span>      smcref = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a7a50ad4eacd814b850f723a4b67a8ead">refsmc</a>(soiltyp)</div>
<div class="line"><a id="l02450" name="l02450"></a><span class="lineno"> 2450</span>      smcwlt = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#ab273c118cc131cacda35bba9180402f9">wltsmc</a>(soiltyp)</div>
<div class="line"><a id="l02451" name="l02451"></a><span class="lineno"> 2451</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02452" name="l02452"></a><span class="lineno"> 2452</span><span class="comment">! Set-up universal parameters (not dependent on SOILTYP, VEGTYP or</span></div>
<div class="line"><a id="l02453" name="l02453"></a><span class="lineno"> 2453</span><span class="comment">! SLOPETYP)</span></div>
<div class="line"><a id="l02454" name="l02454"></a><span class="lineno"> 2454</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02455" name="l02455"></a><span class="lineno"> 2455</span>      zbot = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a1e5f83b829493815912f8e801edd7b17">zbot_data</a></div>
<div class="line"><a id="l02456" name="l02456"></a><span class="lineno"> 2456</span>      salp = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a5e842b9c23b43bc3ccf873a9bf9612af">salp_data</a></div>
<div class="line"><a id="l02457" name="l02457"></a><span class="lineno"> 2457</span>      sbeta = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#aae70644775d8b7023c8c3a7ba90616a8">sbeta_data</a></div>
<div class="line"><a id="l02458" name="l02458"></a><span class="lineno"> 2458</span>      refdk = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#ae3fd374e34b9af10dd489dfc1965d827">refdk_data</a></div>
<div class="line"><a id="l02459" name="l02459"></a><span class="lineno"> 2459</span>      frzk = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a786fd6e5794b80a6cbb602a290a6fd6a">frzk_data</a></div>
<div class="line"><a id="l02460" name="l02460"></a><span class="lineno"> 2460</span>      fxexp = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#acc9389a964a5c2195267b0d1b6a71ced">fxexp_data</a></div>
<div class="line"><a id="l02461" name="l02461"></a><span class="lineno"> 2461</span>      refkdt = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#acbe287caffdd1287fb71954b6284d2f5">refkdt_data</a></div>
<div class="line"><a id="l02462" name="l02462"></a><span class="lineno"> 2462</span>      ptu = 0.    <span class="comment">! (not used yet) to satisify intent(out)</span></div>
<div class="line"><a id="l02463" name="l02463"></a><span class="lineno"> 2463</span>      kdt = refkdt * dksat / refdk</div>
<div class="line"><a id="l02464" name="l02464"></a><span class="lineno"> 2464</span>      czil = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a6c8c21728a7859d57a4e867f2df6d521">czil_data</a></div>
<div class="line"><a id="l02465" name="l02465"></a><span class="lineno"> 2465</span>      slope = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#ae24910d9fdc3b5b4d0ed62901e8c53bd">slope_data</a>(slopetyp)</div>
<div class="line"><a id="l02466" name="l02466"></a><span class="lineno"> 2466</span>      lvcoef = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#abfdd114973412069ebbfb3a61af8d995">lvcoef_data</a></div>
<div class="line"><a id="l02467" name="l02467"></a><span class="lineno"> 2467</span> </div>
<div class="line"><a id="l02468" name="l02468"></a><span class="lineno"> 2468</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02469" name="l02469"></a><span class="lineno"> 2469</span><span class="comment">! TO ADJUST FRZK PARAMETER TO ACTUAL SOIL TYPE: FRZK * FRZFACT</span></div>
<div class="line"><a id="l02470" name="l02470"></a><span class="lineno"> 2470</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02471" name="l02471"></a><span class="lineno"> 2471</span>      frzfact = (smcmax / smcref) * (0.412 / 0.468)</div>
<div class="line"><a id="l02472" name="l02472"></a><span class="lineno"> 2472</span>      frzx = frzk * frzfact</div>
<div class="line"><a id="l02473" name="l02473"></a><span class="lineno"> 2473</span> </div>
<div class="line"><a id="l02474" name="l02474"></a><span class="lineno"> 2474</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02475" name="l02475"></a><span class="lineno"> 2475</span><span class="comment">! SET-UP VEGETATION PARAMETERS</span></div>
<div class="line"><a id="l02476" name="l02476"></a><span class="lineno"> 2476</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02477" name="l02477"></a><span class="lineno"> 2477</span>      topt = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a9b543a894e8a65d824249871d7f936d3">topt_data</a></div>
<div class="line"><a id="l02478" name="l02478"></a><span class="lineno"> 2478</span>      cmcmax = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a0de1ade2206d62259245f281a9751200">cmcmax_data</a></div>
<div class="line"><a id="l02479" name="l02479"></a><span class="lineno"> 2479</span>      cfactr = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a49b5bd6e866a73374623128552be22ec">cfactr_data</a></div>
<div class="line"><a id="l02480" name="l02480"></a><span class="lineno"> 2480</span>      rsmax = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a0500272007439fcc4870091db509d5e0">rsmax_data</a></div>
<div class="line"><a id="l02481" name="l02481"></a><span class="lineno"> 2481</span>      nroot = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#af54c396581833689886321e9937a8b6b">nrotbl</a>(vegtyp)</div>
<div class="line"><a id="l02482" name="l02482"></a><span class="lineno"> 2482</span>      snup = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#af49267d813703d06dc522c006a0efdd8">snuptbl</a>(vegtyp)</div>
<div class="line"><a id="l02483" name="l02483"></a><span class="lineno"> 2483</span>      rsmin = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#aa0847a080464d5bff86f7fc48a8eae13">rstbl</a>(vegtyp)</div>
<div class="line"><a id="l02484" name="l02484"></a><span class="lineno"> 2484</span>      rgl = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a0f671f01ac448828a19839c29fe2a80d">rgltbl</a>(vegtyp)</div>
<div class="line"><a id="l02485" name="l02485"></a><span class="lineno"> 2485</span>      hs = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a032dea1cb1492e469ff23cf4a34170ea">hstbl</a>(vegtyp)</div>
<div class="line"><a id="l02486" name="l02486"></a><span class="lineno"> 2486</span>      emissmin  = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#aa4d4ac6f0a95c2a6bce0c39cea8fe74d">emissmintbl</a>(vegtyp)</div>
<div class="line"><a id="l02487" name="l02487"></a><span class="lineno"> 2487</span>      emissmax  = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#af6a31bb1e4de31d7e62c196cbf6dc2ee">emissmaxtbl</a>(vegtyp)</div>
<div class="line"><a id="l02488" name="l02488"></a><span class="lineno"> 2488</span>      laimin    = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#ab9a5163c0bdd9b8af04056e8b88daa4e">laimintbl</a>(vegtyp)</div>
<div class="line"><a id="l02489" name="l02489"></a><span class="lineno"> 2489</span>      laimax    = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a2c126e8a645fbfff910ba7d7415078e5">laimaxtbl</a>(vegtyp)</div>
<div class="line"><a id="l02490" name="l02490"></a><span class="lineno"> 2490</span>      z0min     = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#aef1bae6bfa7f8eb613369181f2ca0bcd">z0mintbl</a>(vegtyp)</div>
<div class="line"><a id="l02491" name="l02491"></a><span class="lineno"> 2491</span>      z0max     = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a72bf7902c4cdf8a89ad09a592be5381a">z0maxtbl</a>(vegtyp)</div>
<div class="line"><a id="l02492" name="l02492"></a><span class="lineno"> 2492</span>      albedomin = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a5620825a183522809f7fd87ce222bc75">albedomintbl</a>(vegtyp)</div>
<div class="line"><a id="l02493" name="l02493"></a><span class="lineno"> 2493</span>      albedomax = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a9cb2add5ba6296cc7aac44442d42b2d4">albedomaxtbl</a>(vegtyp)</div>
<div class="line"><a id="l02494" name="l02494"></a><span class="lineno"> 2494</span>      ztopv     = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a6eefa55e3997176fcb176348dbabfa4e">ztopvtbl</a>(vegtyp)</div>
<div class="line"><a id="l02495" name="l02495"></a><span class="lineno"> 2495</span>      zbotv     = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a5e4d45f6d99b175703cb7cf1c2485e8a">zbotvtbl</a>(vegtyp)</div>
<div class="line"><a id="l02496" name="l02496"></a><span class="lineno"> 2496</span> </div>
<div class="line"><a id="l02497" name="l02497"></a><span class="lineno"> 2497</span>               <span class="keywordflow">IF</span> (vegtyp .eq. <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#af967731a9437616e8e2b5bb6f3e1712e">bare</a>) shdfac = 0.0</div>
<div class="line"><a id="l02498" name="l02498"></a><span class="lineno"> 2498</span>               <span class="keywordflow">IF</span> (nroot .gt. nsoil) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l02499" name="l02499"></a><span class="lineno"> 2499</span>                  <span class="keyword">WRITE</span> (<a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a120cf314f9b0b4e08b223b15858faefe">err_message</a>,*) <span class="stringliteral">&#39;Error: too many root layers &#39;</span>,  &amp;</div>
<div class="line"><a id="l02500" name="l02500"></a><span class="lineno"> 2500</span>                                                 nsoil,nroot</div>
<div class="line"><a id="l02501" name="l02501"></a><span class="lineno"> 2501</span>                  fatal_error( <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a120cf314f9b0b4e08b223b15858faefe">err_message</a> )</div>
<div class="line"><a id="l02502" name="l02502"></a><span class="lineno"> 2502</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02503" name="l02503"></a><span class="lineno"> 2503</span><span class="comment">! CALCULATE ROOT DISTRIBUTION.  PRESENT VERSION ASSUMES UNIFORM</span></div>
<div class="line"><a id="l02504" name="l02504"></a><span class="lineno"> 2504</span><span class="comment">! DISTRIBUTION BASED ON SOIL LAYER DEPTHS.</span></div>
<div class="line"><a id="l02505" name="l02505"></a><span class="lineno"> 2505</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02506" name="l02506"></a><span class="lineno"> 2506</span><span class="keywordflow">               END IF</span></div>
<div class="line"><a id="l02507" name="l02507"></a><span class="lineno"> 2507</span>               <span class="keywordflow">DO</span> i = 1,nroot</div>
<div class="line"><a id="l02508" name="l02508"></a><span class="lineno"> 2508</span>                  rtdis(i) = - sldpth(i)/ zsoil(nroot)</div>
<div class="line"><a id="l02509" name="l02509"></a><span class="lineno"> 2509</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02510" name="l02510"></a><span class="lineno"> 2510</span><span class="comment">!  SET-UP SLOPE PARAMETER</span></div>
<div class="line"><a id="l02511" name="l02511"></a><span class="lineno"> 2511</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02512" name="l02512"></a><span class="lineno"> 2512</span><span class="keywordflow">               END DO</span></div>
<div class="line"><a id="l02513" name="l02513"></a><span class="lineno"> 2513</span> </div>
<div class="line"><a id="l02514" name="l02514"></a><span class="lineno"> 2514</span><span class="comment">!        print*,&#39;end of PRMRED&#39;</span></div>
<div class="line"><a id="l02515" name="l02515"></a><span class="lineno"> 2515</span><span class="comment">!       print*,&#39;VEGTYP&#39;,VEGTYP,&#39;SOILTYP&#39;,SOILTYP,&#39;SLOPETYP&#39;,SLOPETYP,    &amp;</span></div>
<div class="line"><a id="l02516" name="l02516"></a><span class="lineno"> 2516</span><span class="comment">!    &amp; &#39;CFACTR&#39;,CFACTR,&#39;CMCMAX&#39;,CMCMAX,&#39;RSMAX&#39;,RSMAX,&#39;TOPT&#39;,TOPT,        &amp;</span></div>
<div class="line"><a id="l02517" name="l02517"></a><span class="lineno"> 2517</span><span class="comment">!    &amp; &#39;REFKDT&#39;,REFKDT,&#39;KDT&#39;,KDT,&#39;SBETA&#39;,SBETA, &#39;SHDFAC&#39;,SHDFAC,         &amp;</span></div>
<div class="line"><a id="l02518" name="l02518"></a><span class="lineno"> 2518</span><span class="comment">!    &amp;  &#39;RSMIN&#39;,RSMIN,&#39;RGL&#39;,RGL,&#39;HS&#39;,HS,&#39;ZBOT&#39;,ZBOT,&#39;FRZX&#39;,FRZX,         &amp;</span></div>
<div class="line"><a id="l02519" name="l02519"></a><span class="lineno"> 2519</span><span class="comment">!    &amp;  &#39;PSISAT&#39;,PSISAT,&#39;SLOPE&#39;,SLOPE,&#39;SNUP&#39;,SNUP,&#39;SALP&#39;,SALP,&#39;BEXP&#39;,    &amp;</span></div>
<div class="line"><a id="l02520" name="l02520"></a><span class="lineno"> 2520</span><span class="comment">!    &amp;   BEXP,                                                           &amp;</span></div>
<div class="line"><a id="l02521" name="l02521"></a><span class="lineno"> 2521</span><span class="comment">!    &amp;  &#39;DKSAT&#39;,DKSAT,&#39;DWSAT&#39;,DWSAT,                                     &amp;</span></div>
<div class="line"><a id="l02522" name="l02522"></a><span class="lineno"> 2522</span><span class="comment">!    &amp;  &#39;SMCMAX&#39;,SMCMAX,&#39;SMCWLT&#39;,SMCWLT,&#39;SMCREF&#39;,SMCREF,&#39;SMCDRY&#39;,SMCDRY, &amp;</span></div>
<div class="line"><a id="l02523" name="l02523"></a><span class="lineno"> 2523</span><span class="comment">!    &amp;  &#39;F1&#39;,F1,&#39;QUARTZ&#39;,QUARTZ,&#39;FXEXP&#39;,FXEXP,                           &amp;</span></div>
<div class="line"><a id="l02524" name="l02524"></a><span class="lineno"> 2524</span><span class="comment">!    &amp;  &#39;RTDIS&#39;,RTDIS,&#39;SLDPTH&#39;,SLDPTH,&#39;ZSOIL&#39;,ZSOIL, &#39;NROOT&#39;,NROOT,      &amp;</span></div>
<div class="line"><a id="l02525" name="l02525"></a><span class="lineno"> 2525</span><span class="comment">!    &amp;  &#39;NSOIL&#39;,NSOIL,&#39;Z0&#39;,Z0,&#39;CZIL&#39;,CZIL,&#39;LAI&#39;,LAI,                     &amp;</span></div>
<div class="line"><a id="l02526" name="l02526"></a><span class="lineno"> 2526</span><span class="comment">!    &amp;  &#39;CSOIL&#39;,CSOIL,&#39;PTU&#39;,PTU,                                         &amp;</span></div>
<div class="line"><a id="l02527" name="l02527"></a><span class="lineno"> 2527</span><span class="comment">!    &amp;  &#39;LOCAL&#39;, LOCAL</span></div>
<div class="line"><a id="l02528" name="l02528"></a><span class="lineno"> 2528</span> </div>
<div class="line"><a id="l02529" name="l02529"></a><span class="lineno"> 2529</span>      <span class="keyword">END  SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a035da859804652a83bc5fd235e70b2e0">redprm</a></div>
<div class="line"><a id="l02530" name="l02530"></a><span class="lineno"> 2530</span> </div>
<div class="line"><a id="l02531" name="l02531"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#ac6e3e7bb3f0322070546653306177216"> 2531</a></span>      <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ac6e3e7bb3f0322070546653306177216">rosr12</a> (P,A,B,C,D,DELTA,NSOIL)</div>
<div class="line"><a id="l02532" name="l02532"></a><span class="lineno"> 2532</span> </div>
<div class="line"><a id="l02533" name="l02533"></a><span class="lineno"> 2533</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02534" name="l02534"></a><span class="lineno"> 2534</span><span class="comment">! SUBROUTINE ROSR12</span></div>
<div class="line"><a id="l02535" name="l02535"></a><span class="lineno"> 2535</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02536" name="l02536"></a><span class="lineno"> 2536</span><span class="comment">! INVERT (SOLVE) THE TRI-DIAGONAL MATRIX PROBLEM SHOWN BELOW:</span></div>
<div class="line"><a id="l02537" name="l02537"></a><span class="lineno"> 2537</span><span class="comment">! ###                                            ### ###  ###   ###  ###</span></div>
<div class="line"><a id="l02538" name="l02538"></a><span class="lineno"> 2538</span><span class="comment">! #B(1), C(1),  0  ,  0  ,  0  ,   . . .  ,    0   # #      #   #      #</span></div>
<div class="line"><a id="l02539" name="l02539"></a><span class="lineno"> 2539</span><span class="comment">! #A(2), B(2), C(2),  0  ,  0  ,   . . .  ,    0   # #      #   #      #</span></div>
<div class="line"><a id="l02540" name="l02540"></a><span class="lineno"> 2540</span><span class="comment">! # 0  , A(3), B(3), C(3),  0  ,   . . .  ,    0   # #      #   # D(3) #</span></div>
<div class="line"><a id="l02541" name="l02541"></a><span class="lineno"> 2541</span><span class="comment">! # 0  ,  0  , A(4), B(4), C(4),   . . .  ,    0   # # P(4) #   # D(4) #</span></div>
<div class="line"><a id="l02542" name="l02542"></a><span class="lineno"> 2542</span><span class="comment">! # 0  ,  0  ,  0  , A(5), B(5),   . . .  ,    0   # # P(5) #   # D(5) #</span></div>
<div class="line"><a id="l02543" name="l02543"></a><span class="lineno"> 2543</span><span class="comment">! # .                                          .   # #  .   # = #   .  #</span></div>
<div class="line"><a id="l02544" name="l02544"></a><span class="lineno"> 2544</span><span class="comment">! # .                                          .   # #  .   #   #   .  #</span></div>
<div class="line"><a id="l02545" name="l02545"></a><span class="lineno"> 2545</span><span class="comment">! # .                                          .   # #  .   #   #   .  #</span></div>
<div class="line"><a id="l02546" name="l02546"></a><span class="lineno"> 2546</span><span class="comment">! # 0  , . . . , 0 , A(M-2), B(M-2), C(M-2),   0   # #P(M-2)#   #D(M-2)#</span></div>
<div class="line"><a id="l02547" name="l02547"></a><span class="lineno"> 2547</span><span class="comment">! # 0  , . . . , 0 ,   0   , A(M-1), B(M-1), C(M-1)# #P(M-1)#   #D(M-1)#</span></div>
<div class="line"><a id="l02548" name="l02548"></a><span class="lineno"> 2548</span><span class="comment">! # 0  , . . . , 0 ,   0   ,   0   ,  A(M) ,  B(M) # # P(M) #   # D(M) #</span></div>
<div class="line"><a id="l02549" name="l02549"></a><span class="lineno"> 2549</span><span class="comment">! ###                                            ### ###  ###   ###  ###</span></div>
<div class="line"><a id="l02550" name="l02550"></a><span class="lineno"> 2550</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02551" name="l02551"></a><span class="lineno"> 2551</span>      <span class="keywordtype">IMPLICIT NONE</span></div>
<div class="line"><a id="l02552" name="l02552"></a><span class="lineno"> 2552</span> </div>
<div class="line"><a id="l02553" name="l02553"></a><span class="lineno"> 2553</span>      <span class="keywordtype">INTEGER</span>, <span class="keywordtype">INTENT(IN)</span>   :: NSOIL</div>
<div class="line"><a id="l02554" name="l02554"></a><span class="lineno"> 2554</span>      <span class="keywordtype">INTEGER</span>               :: K, KK</div>
<div class="line"><a id="l02555" name="l02555"></a><span class="lineno"> 2555</span> </div>
<div class="line"><a id="l02556" name="l02556"></a><span class="lineno"> 2556</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(IN)</span>:: A, B, D</div>
<div class="line"><a id="l02557" name="l02557"></a><span class="lineno"> 2557</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>,<span class="keywordtype">INTENT(INOUT)</span>:: C,P,DELTA</div>
<div class="line"><a id="l02558" name="l02558"></a><span class="lineno"> 2558</span> </div>
<div class="line"><a id="l02559" name="l02559"></a><span class="lineno"> 2559</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02560" name="l02560"></a><span class="lineno"> 2560</span><span class="comment">! INITIALIZE EQN COEF C FOR THE LOWEST SOIL LAYER</span></div>
<div class="line"><a id="l02561" name="l02561"></a><span class="lineno"> 2561</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02562" name="l02562"></a><span class="lineno"> 2562</span>      c(nsoil) = 0.0</div>
<div class="line"><a id="l02563" name="l02563"></a><span class="lineno"> 2563</span>      p(1) = - c(1) / b(1)</div>
<div class="line"><a id="l02564" name="l02564"></a><span class="lineno"> 2564</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02565" name="l02565"></a><span class="lineno"> 2565</span><span class="comment">! SOLVE THE COEFS FOR THE 1ST SOIL LAYER</span></div>
<div class="line"><a id="l02566" name="l02566"></a><span class="lineno"> 2566</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02567" name="l02567"></a><span class="lineno"> 2567</span> </div>
<div class="line"><a id="l02568" name="l02568"></a><span class="lineno"> 2568</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02569" name="l02569"></a><span class="lineno"> 2569</span><span class="comment">! SOLVE THE COEFS FOR SOIL LAYERS 2 THRU NSOIL</span></div>
<div class="line"><a id="l02570" name="l02570"></a><span class="lineno"> 2570</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02571" name="l02571"></a><span class="lineno"> 2571</span>      delta(1) = d(1) / b(1)</div>
<div class="line"><a id="l02572" name="l02572"></a><span class="lineno"> 2572</span>      <span class="keywordflow">DO</span> k = 2,nsoil</div>
<div class="line"><a id="l02573" name="l02573"></a><span class="lineno"> 2573</span>         p(k) = - c(k) * ( 1.0 / (b(k) + a(k) * p(k -1)) )</div>
<div class="line"><a id="l02574" name="l02574"></a><span class="lineno"> 2574</span>         delta(k) = (d(k) - a(k)* delta(k -1))* (1.0/ (b(k) + a(k)&amp;</div>
<div class="line"><a id="l02575" name="l02575"></a><span class="lineno"> 2575</span>                    * p(k -1)))</div>
<div class="line"><a id="l02576" name="l02576"></a><span class="lineno"> 2576</span><span class="keywordflow">      END DO</span></div>
<div class="line"><a id="l02577" name="l02577"></a><span class="lineno"> 2577</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02578" name="l02578"></a><span class="lineno"> 2578</span><span class="comment">! SET P TO DELTA FOR LOWEST SOIL LAYER</span></div>
<div class="line"><a id="l02579" name="l02579"></a><span class="lineno"> 2579</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02580" name="l02580"></a><span class="lineno"> 2580</span>      p(nsoil) = delta(nsoil)</div>
<div class="line"><a id="l02581" name="l02581"></a><span class="lineno"> 2581</span> </div>
<div class="line"><a id="l02582" name="l02582"></a><span class="lineno"> 2582</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02583" name="l02583"></a><span class="lineno"> 2583</span><span class="comment">! ADJUST P FOR SOIL LAYERS 2 THRU NSOIL</span></div>
<div class="line"><a id="l02584" name="l02584"></a><span class="lineno"> 2584</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02585" name="l02585"></a><span class="lineno"> 2585</span>      <span class="keywordflow">DO</span> k = 2,nsoil</div>
<div class="line"><a id="l02586" name="l02586"></a><span class="lineno"> 2586</span>         kk = nsoil - k + 1</div>
<div class="line"><a id="l02587" name="l02587"></a><span class="lineno"> 2587</span>         p(kk) = p(kk) * p(kk +1) + delta(kk)</div>
<div class="line"><a id="l02588" name="l02588"></a><span class="lineno"> 2588</span><span class="keywordflow">      END DO</span></div>
<div class="line"><a id="l02589" name="l02589"></a><span class="lineno"> 2589</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02590" name="l02590"></a><span class="lineno"> 2590</span>  <span class="keyword">END SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ac6e3e7bb3f0322070546653306177216">rosr12</a></div>
<div class="line"><a id="l02591" name="l02591"></a><span class="lineno"> 2591</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02592" name="l02592"></a><span class="lineno"> 2592</span> </div>
<div class="line"><a id="l02593" name="l02593"></a><span class="lineno"> 2593</span> </div>
<div class="line"><a id="l02594" name="l02594"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#aaee442f9d981b7c296c5932352365351"> 2594</a></span>      <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#aaee442f9d981b7c296c5932352365351">shflx</a> (SSOIL,STC,SMC,SMCMAX,NSOIL,T1,DT,YY,ZZ1,ZSOIL, &amp;</div>
<div class="line"><a id="l02595" name="l02595"></a><span class="lineno"> 2595</span>                         TBOT,ZBOT,SMCWLT,PSISAT,SH2O,BEXP,F1,DF1,     &amp;</div>
<div class="line"><a id="l02596" name="l02596"></a><span class="lineno"> 2596</span>                         QUARTZ,CSOIL,VEGTYP,ISURBAN,SOILTYP,OPT_THCND &amp;</div>
<div class="line"><a id="l02597" name="l02597"></a><span class="lineno"> 2597</span>                        ,HCPCT_FASDAS                                  ) <span class="comment">! fasdas</span></div>
<div class="line"><a id="l02598" name="l02598"></a><span class="lineno"> 2598</span> </div>
<div class="line"><a id="l02599" name="l02599"></a><span class="lineno"> 2599</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02600" name="l02600"></a><span class="lineno"> 2600</span><span class="comment">! SUBROUTINE SHFLX</span></div>
<div class="line"><a id="l02601" name="l02601"></a><span class="lineno"> 2601</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02602" name="l02602"></a><span class="lineno"> 2602</span><span class="comment">! UPDATE THE TEMPERATURE STATE OF THE SOIL COLUMN BASED ON THE THERMAL</span></div>
<div class="line"><a id="l02603" name="l02603"></a><span class="lineno"> 2603</span><span class="comment">! DIFFUSION EQUATION AND UPDATE THE FROZEN SOIL MOISTURE CONTENT BASED</span></div>
<div class="line"><a id="l02604" name="l02604"></a><span class="lineno"> 2604</span><span class="comment">! ON THE TEMPERATURE.</span></div>
<div class="line"><a id="l02605" name="l02605"></a><span class="lineno"> 2605</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02606" name="l02606"></a><span class="lineno"> 2606</span>      <span class="keywordtype">IMPLICIT NONE</span></div>
<div class="line"><a id="l02607" name="l02607"></a><span class="lineno"> 2607</span> </div>
<div class="line"><a id="l02608" name="l02608"></a><span class="lineno"> 2608</span>      <span class="keywordtype">INTEGER</span>, <span class="keywordtype">INTENT(IN)</span>   :: OPT_THCND</div>
<div class="line"><a id="l02609" name="l02609"></a><span class="lineno"> 2609</span>      <span class="keywordtype">INTEGER</span>, <span class="keywordtype">INTENT(IN)</span>   :: NSOIL, VEGTYP, ISURBAN, SOILTYP</div>
<div class="line"><a id="l02610" name="l02610"></a><span class="lineno"> 2610</span>      <span class="keywordtype">INTEGER</span>               :: I</div>
<div class="line"><a id="l02611" name="l02611"></a><span class="lineno"> 2611</span> </div>
<div class="line"><a id="l02612" name="l02612"></a><span class="lineno"> 2612</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(IN)</span>      :: BEXP,CSOIL,DF1,DT,F1,PSISAT,QUARTZ,     &amp;</div>
<div class="line"><a id="l02613" name="l02613"></a><span class="lineno"> 2613</span>                               SMCMAX, SMCWLT, TBOT,YY, ZBOT,ZZ1</div>
<div class="line"><a id="l02614" name="l02614"></a><span class="lineno"> 2614</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(INOUT)</span>   :: T1</div>
<div class="line"><a id="l02615" name="l02615"></a><span class="lineno"> 2615</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(OUT)</span>     :: SSOIL</div>
<div class="line"><a id="l02616" name="l02616"></a><span class="lineno"> 2616</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(IN)</span>    :: SMC,ZSOIL</div>
<div class="line"><a id="l02617" name="l02617"></a><span class="lineno"> 2617</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(INOUT)</span> :: SH2O</div>
<div class="line"><a id="l02618" name="l02618"></a><span class="lineno"> 2618</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(INOUT)</span> :: STC</div>
<div class="line"><a id="l02619" name="l02619"></a><span class="lineno"> 2619</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>             :: AI, BI, CI, STCF,RHSTS</div>
<div class="line"><a id="l02620" name="l02620"></a><span class="lineno"> 2620</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">PARAMETER</span>       :: T0 = 273.15</div>
<div class="line"><a id="l02621" name="l02621"></a><span class="lineno"> 2621</span> </div>
<div class="line"><a id="l02622" name="l02622"></a><span class="lineno"> 2622</span><span class="comment">!</span></div>
<div class="line"><a id="l02623" name="l02623"></a><span class="lineno"> 2623</span><span class="comment">! FASDAS</span></div>
<div class="line"><a id="l02624" name="l02624"></a><span class="lineno"> 2624</span><span class="comment">!</span></div>
<div class="line"><a id="l02625" name="l02625"></a><span class="lineno"> 2625</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(  OUT)</span>     :: HCPCT_FASDAS</div>
<div class="line"><a id="l02626" name="l02626"></a><span class="lineno"> 2626</span><span class="comment">!</span></div>
<div class="line"><a id="l02627" name="l02627"></a><span class="lineno"> 2627</span><span class="comment">! END FASDAS</span></div>
<div class="line"><a id="l02628" name="l02628"></a><span class="lineno"> 2628</span><span class="comment">!</span></div>
<div class="line"><a id="l02629" name="l02629"></a><span class="lineno"> 2629</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02630" name="l02630"></a><span class="lineno"> 2630</span><span class="comment">! HRT ROUTINE CALCS THE RIGHT HAND SIDE OF THE SOIL TEMP DIF EQN</span></div>
<div class="line"><a id="l02631" name="l02631"></a><span class="lineno"> 2631</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02632" name="l02632"></a><span class="lineno"> 2632</span> </div>
<div class="line"><a id="l02633" name="l02633"></a><span class="lineno"> 2633</span>      <span class="comment">! Land case</span></div>
<div class="line"><a id="l02634" name="l02634"></a><span class="lineno"> 2634</span> </div>
<div class="line"><a id="l02635" name="l02635"></a><span class="lineno"> 2635</span>      <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#af9f7c237f83a49f3981875bf59dd7816">hrt</a> (rhsts,stc,smc,smcmax,nsoil,zsoil,yy,zz1,tbot,     &amp;</div>
<div class="line"><a id="l02636" name="l02636"></a><span class="lineno"> 2636</span>                zbot,psisat,sh2o,dt,bexp,soiltyp,opt_thcnd,       &amp;</div>
<div class="line"><a id="l02637" name="l02637"></a><span class="lineno"> 2637</span>                f1,df1,quartz,csoil,ai,bi,ci,vegtyp,isurban       &amp;</div>
<div class="line"><a id="l02638" name="l02638"></a><span class="lineno"> 2638</span>               ,hcpct_fasdas                                      ) <span class="comment">!fasdas</span></div>
<div class="line"><a id="l02639" name="l02639"></a><span class="lineno"> 2639</span> </div>
<div class="line"><a id="l02640" name="l02640"></a><span class="lineno"> 2640</span>      <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#adacf01be4e33445ea186feffce24eb35">hstep</a> (stcf,stc,rhsts,dt,nsoil,ai,bi,ci)</div>
<div class="line"><a id="l02641" name="l02641"></a><span class="lineno"> 2641</span> </div>
<div class="line"><a id="l02642" name="l02642"></a><span class="lineno"> 2642</span>      <span class="keywordflow">DO</span> i = 1,nsoil</div>
<div class="line"><a id="l02643" name="l02643"></a><span class="lineno"> 2643</span>         stc(i) = stcf(i)</div>
<div class="line"><a id="l02644" name="l02644"></a><span class="lineno"> 2644</span><span class="keywordflow">      ENDDO</span></div>
<div class="line"><a id="l02645" name="l02645"></a><span class="lineno"> 2645</span> </div>
<div class="line"><a id="l02646" name="l02646"></a><span class="lineno"> 2646</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02647" name="l02647"></a><span class="lineno"> 2647</span><span class="comment">! IN THE NO SNOWPACK CASE (VIA ROUTINE NOPAC BRANCH,) UPDATE THE GRND</span></div>
<div class="line"><a id="l02648" name="l02648"></a><span class="lineno"> 2648</span><span class="comment">! (SKIN) TEMPERATURE HERE IN RESPONSE TO THE UPDATED SOIL TEMPERATURE</span></div>
<div class="line"><a id="l02649" name="l02649"></a><span class="lineno"> 2649</span><span class="comment">! PROFILE ABOVE.  (NOTE: INSPECTION OF ROUTINE SNOPAC SHOWS THAT T1</span></div>
<div class="line"><a id="l02650" name="l02650"></a><span class="lineno"> 2650</span><span class="comment">! BELOW IS A DUMMY VARIABLE ONLY, AS SKIN TEMPERATURE IS UPDATED</span></div>
<div class="line"><a id="l02651" name="l02651"></a><span class="lineno"> 2651</span><span class="comment">! DIFFERENTLY IN ROUTINE SNOPAC)</span></div>
<div class="line"><a id="l02652" name="l02652"></a><span class="lineno"> 2652</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02653" name="l02653"></a><span class="lineno"> 2653</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02654" name="l02654"></a><span class="lineno"> 2654</span><span class="comment">! CALCULATE SURFACE SOIL HEAT FLUX</span></div>
<div class="line"><a id="l02655" name="l02655"></a><span class="lineno"> 2655</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02656" name="l02656"></a><span class="lineno"> 2656</span>      t1 = (yy + (zz1- 1.0) * stc(1)) / zz1</div>
<div class="line"><a id="l02657" name="l02657"></a><span class="lineno"> 2657</span>      ssoil = df1 * (stc(1) - t1) / (0.5 * zsoil(1))</div>
<div class="line"><a id="l02658" name="l02658"></a><span class="lineno"> 2658</span> </div>
<div class="line"><a id="l02659" name="l02659"></a><span class="lineno"> 2659</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02660" name="l02660"></a><span class="lineno"> 2660</span>  <span class="keyword">END SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#aaee442f9d981b7c296c5932352365351">shflx</a></div>
<div class="line"><a id="l02661" name="l02661"></a><span class="lineno"> 2661</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02662" name="l02662"></a><span class="lineno"> 2662</span> </div>
<div class="line"><a id="l02663" name="l02663"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#a58888da8d933fe6e55e825b83159658b"> 2663</a></span>      <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a58888da8d933fe6e55e825b83159658b">smflx</a> (SMC,NSOIL,CMC,DT,PRCP1,ZSOIL,                   &amp;</div>
<div class="line"><a id="l02664" name="l02664"></a><span class="lineno"> 2664</span>     &amp;                   SH2O,SLOPE,KDT,FRZFACT,                        &amp;</div>
<div class="line"><a id="l02665" name="l02665"></a><span class="lineno"> 2665</span>     &amp;                   SMCMAX,BEXP,SMCWLT,DKSAT,DWSAT,                &amp;</div>
<div class="line"><a id="l02666" name="l02666"></a><span class="lineno"> 2666</span>     &amp;                   SHDFAC,CMCMAX,                                 &amp;</div>
<div class="line"><a id="l02667" name="l02667"></a><span class="lineno"> 2667</span>     &amp;                   RUNOFF1,RUNOFF2,RUNOFF3,                       &amp;</div>
<div class="line"><a id="l02668" name="l02668"></a><span class="lineno"> 2668</span>     &amp;                   EDIR,EC,ET,                                    &amp;</div>
<div class="line"><a id="l02669" name="l02669"></a><span class="lineno"> 2669</span>     &amp;                   DRIP, SFHEAD1RT,INFXS1RT)</div>
<div class="line"><a id="l02670" name="l02670"></a><span class="lineno"> 2670</span> </div>
<div class="line"><a id="l02671" name="l02671"></a><span class="lineno"> 2671</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02672" name="l02672"></a><span class="lineno"> 2672</span><span class="comment">! SUBROUTINE SMFLX</span></div>
<div class="line"><a id="l02673" name="l02673"></a><span class="lineno"> 2673</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02674" name="l02674"></a><span class="lineno"> 2674</span><span class="comment">! CALCULATE SOIL MOISTURE FLUX.  THE SOIL MOISTURE CONTENT (SMC - A PER</span></div>
<div class="line"><a id="l02675" name="l02675"></a><span class="lineno"> 2675</span><span class="comment">! UNIT VOLUME MEASUREMENT) IS A DEPENDENT VARIABLE THAT IS UPDATED WITH</span></div>
<div class="line"><a id="l02676" name="l02676"></a><span class="lineno"> 2676</span><span class="comment">! PROGNOSTIC EQNS. THE CANOPY MOISTURE CONTENT (CMC) IS ALSO UPDATED.</span></div>
<div class="line"><a id="l02677" name="l02677"></a><span class="lineno"> 2677</span><span class="comment">! FROZEN GROUND VERSION:  NEW STATES ADDED: SH2O, AND FROZEN GROUND</span></div>
<div class="line"><a id="l02678" name="l02678"></a><span class="lineno"> 2678</span><span class="comment">! CORRECTION FACTOR, FRZFACT AND PARAMETER SLOPE.</span></div>
<div class="line"><a id="l02679" name="l02679"></a><span class="lineno"> 2679</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02680" name="l02680"></a><span class="lineno"> 2680</span>      <span class="keywordtype">IMPLICIT NONE</span></div>
<div class="line"><a id="l02681" name="l02681"></a><span class="lineno"> 2681</span> </div>
<div class="line"><a id="l02682" name="l02682"></a><span class="lineno"> 2682</span>      <span class="keywordtype">INTEGER</span>, <span class="keywordtype">INTENT(IN)</span>   :: NSOIL</div>
<div class="line"><a id="l02683" name="l02683"></a><span class="lineno"> 2683</span>      <span class="keywordtype">INTEGER</span>               :: I,K</div>
<div class="line"><a id="l02684" name="l02684"></a><span class="lineno"> 2684</span> </div>
<div class="line"><a id="l02685" name="l02685"></a><span class="lineno"> 2685</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(IN)</span>      :: BEXP, CMCMAX, DKSAT,DWSAT, DT, EC, EDIR,  &amp;</div>
<div class="line"><a id="l02686" name="l02686"></a><span class="lineno"> 2686</span>                               KDT, PRCP1, SHDFAC, SLOPE, SMCMAX, SMCWLT</div>
<div class="line"><a id="l02687" name="l02687"></a><span class="lineno"> 2687</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(OUT)</span>                      :: DRIP, RUNOFF1, RUNOFF2, RUNOFF3</div>
<div class="line"><a id="l02688" name="l02688"></a><span class="lineno"> 2688</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(INOUT)</span>   :: CMC</div>
<div class="line"><a id="l02689" name="l02689"></a><span class="lineno"> 2689</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(IN)</span>   :: ET,ZSOIL</div>
<div class="line"><a id="l02690" name="l02690"></a><span class="lineno"> 2690</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(INOUT)</span>:: SMC, SH2O</div>
<div class="line"><a id="l02691" name="l02691"></a><span class="lineno"> 2691</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>             :: AI, BI, CI, STCF,RHSTS, RHSTT, &amp;</div>
<div class="line"><a id="l02692" name="l02692"></a><span class="lineno"> 2692</span>                                              SICE, SH2OA, SH2OFG</div>
<div class="line"><a id="l02693" name="l02693"></a><span class="lineno"> 2693</span><span class="keywordtype">      REAL</span>                  :: DUMMY, EXCESS,FRZFACT,PCPDRP,RHSCT,TRHSCT</div>
<div class="line"><a id="l02694" name="l02694"></a><span class="lineno"> 2694</span><span class="keywordtype">      REAL</span> :: FAC2</div>
<div class="line"><a id="l02695" name="l02695"></a><span class="lineno"> 2695</span><span class="keywordtype">      REAL</span> :: FLIMIT</div>
<div class="line"><a id="l02696" name="l02696"></a><span class="lineno"> 2696</span> </div>
<div class="line"><a id="l02697" name="l02697"></a><span class="lineno"> 2697</span><span class="keywordtype">      REAL</span>,    <span class="keywordtype">INTENT(INOUT)</span>                 :: SFHEAD1RT,INFXS1RT</div>
<div class="line"><a id="l02698" name="l02698"></a><span class="lineno"> 2698</span> </div>
<div class="line"><a id="l02699" name="l02699"></a><span class="lineno"> 2699</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02700" name="l02700"></a><span class="lineno"> 2700</span><span class="comment">! EXECUTABLE CODE BEGINS HERE.</span></div>
<div class="line"><a id="l02701" name="l02701"></a><span class="lineno"> 2701</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02702" name="l02702"></a><span class="lineno"> 2702</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02703" name="l02703"></a><span class="lineno"> 2703</span><span class="comment">! COMPUTE THE RIGHT HAND SIDE OF THE CANOPY EQN TERM ( RHSCT )</span></div>
<div class="line"><a id="l02704" name="l02704"></a><span class="lineno"> 2704</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02705" name="l02705"></a><span class="lineno"> 2705</span>      dummy = 0.</div>
<div class="line"><a id="l02706" name="l02706"></a><span class="lineno"> 2706</span> </div>
<div class="line"><a id="l02707" name="l02707"></a><span class="lineno"> 2707</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02708" name="l02708"></a><span class="lineno"> 2708</span><span class="comment">! CONVERT RHSCT (A RATE) TO TRHSCT (AN AMOUNT) AND ADD IT TO EXISTING</span></div>
<div class="line"><a id="l02709" name="l02709"></a><span class="lineno"> 2709</span><span class="comment">! CMC.  IF RESULTING AMT EXCEEDS MAX CAPACITY, IT BECOMES DRIP AND WILL</span></div>
<div class="line"><a id="l02710" name="l02710"></a><span class="lineno"> 2710</span><span class="comment">! FALL TO THE GRND.</span></div>
<div class="line"><a id="l02711" name="l02711"></a><span class="lineno"> 2711</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02712" name="l02712"></a><span class="lineno"> 2712</span>      rhsct = shdfac * prcp1- ec</div>
<div class="line"><a id="l02713" name="l02713"></a><span class="lineno"> 2713</span>      drip = 0.</div>
<div class="line"><a id="l02714" name="l02714"></a><span class="lineno"> 2714</span>      trhsct = dt * rhsct</div>
<div class="line"><a id="l02715" name="l02715"></a><span class="lineno"> 2715</span>      excess = cmc + trhsct</div>
<div class="line"><a id="l02716" name="l02716"></a><span class="lineno"> 2716</span> </div>
<div class="line"><a id="l02717" name="l02717"></a><span class="lineno"> 2717</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02718" name="l02718"></a><span class="lineno"> 2718</span><span class="comment">! PCPDRP IS THE COMBINED PRCP1 AND DRIP (FROM CMC) THAT GOES INTO THE</span></div>
<div class="line"><a id="l02719" name="l02719"></a><span class="lineno"> 2719</span><span class="comment">! SOIL</span></div>
<div class="line"><a id="l02720" name="l02720"></a><span class="lineno"> 2720</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02721" name="l02721"></a><span class="lineno"> 2721</span>      <span class="keywordflow">IF</span> (excess &gt; cmcmax) drip = excess - cmcmax</div>
<div class="line"><a id="l02722" name="l02722"></a><span class="lineno"> 2722</span>      pcpdrp = (1. - shdfac) * prcp1+ drip / dt</div>
<div class="line"><a id="l02723" name="l02723"></a><span class="lineno"> 2723</span> </div>
<div class="line"><a id="l02724" name="l02724"></a><span class="lineno"> 2724</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02725" name="l02725"></a><span class="lineno"> 2725</span><span class="comment">! STORE ICE CONTENT AT EACH SOIL LAYER BEFORE CALLING SRT and SSTEP</span></div>
<div class="line"><a id="l02726" name="l02726"></a><span class="lineno"> 2726</span><span class="comment">!</span></div>
<div class="line"><a id="l02727" name="l02727"></a><span class="lineno"> 2727</span>      <span class="keywordflow">DO</span> i = 1,nsoil</div>
<div class="line"><a id="l02728" name="l02728"></a><span class="lineno"> 2728</span>         sice(i) = smc(i) - sh2o(i)</div>
<div class="line"><a id="l02729" name="l02729"></a><span class="lineno"> 2729</span><span class="keywordflow">      END DO</span></div>
<div class="line"><a id="l02730" name="l02730"></a><span class="lineno"> 2730</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02731" name="l02731"></a><span class="lineno"> 2731</span><span class="comment">! CALL SUBROUTINES SRT AND SSTEP TO SOLVE THE SOIL MOISTURE</span></div>
<div class="line"><a id="l02732" name="l02732"></a><span class="lineno"> 2732</span><span class="comment">! TENDENCY EQUATIONS.</span></div>
<div class="line"><a id="l02733" name="l02733"></a><span class="lineno"> 2733</span><span class="comment">! IF THE INFILTRATING PRECIP RATE IS NONTRIVIAL,</span></div>
<div class="line"><a id="l02734" name="l02734"></a><span class="lineno"> 2734</span><span class="comment">!   (WE CONSIDER NONTRIVIAL TO BE A PRECIP TOTAL OVER THE TIME STEP</span></div>
<div class="line"><a id="l02735" name="l02735"></a><span class="lineno"> 2735</span><span class="comment">!    EXCEEDING ONE ONE-THOUSANDTH OF THE WATER HOLDING CAPACITY OF</span></div>
<div class="line"><a id="l02736" name="l02736"></a><span class="lineno"> 2736</span><span class="comment">!    THE FIRST SOIL LAYER)</span></div>
<div class="line"><a id="l02737" name="l02737"></a><span class="lineno"> 2737</span><span class="comment">! THEN CALL THE SRT/SSTEP SUBROUTINE PAIR TWICE IN THE MANNER OF</span></div>
<div class="line"><a id="l02738" name="l02738"></a><span class="lineno"> 2738</span><span class="comment">!   TIME SCHEME &quot;F&quot; (IMPLICIT STATE, AVERAGED COEFFICIENT)</span></div>
<div class="line"><a id="l02739" name="l02739"></a><span class="lineno"> 2739</span><span class="comment">!   OF SECTION 2 OF KALNAY AND KANAMITSU (1988, MWR, VOL 116,</span></div>
<div class="line"><a id="l02740" name="l02740"></a><span class="lineno"> 2740</span><span class="comment">!   PAGES 1945-1958)TO MINIMIZE 2-DELTA-T OSCILLATIONS IN THE</span></div>
<div class="line"><a id="l02741" name="l02741"></a><span class="lineno"> 2741</span><span class="comment">!   SOIL MOISTURE VALUE OF THE TOP SOIL LAYER THAT CAN ARISE BECAUSE</span></div>
<div class="line"><a id="l02742" name="l02742"></a><span class="lineno"> 2742</span><span class="comment">!   OF THE EXTREME NONLINEAR DEPENDENCE OF THE SOIL HYDRAULIC</span></div>
<div class="line"><a id="l02743" name="l02743"></a><span class="lineno"> 2743</span><span class="comment">!   DIFFUSIVITY COEFFICIENT AND THE HYDRAULIC CONDUCTIVITY ON THE</span></div>
<div class="line"><a id="l02744" name="l02744"></a><span class="lineno"> 2744</span><span class="comment">!   SOIL MOISTURE STATE</span></div>
<div class="line"><a id="l02745" name="l02745"></a><span class="lineno"> 2745</span><span class="comment">! OTHERWISE CALL THE SRT/SSTEP SUBROUTINE PAIR ONCE IN THE MANNER OF</span></div>
<div class="line"><a id="l02746" name="l02746"></a><span class="lineno"> 2746</span><span class="comment">!   TIME SCHEME &quot;D&quot; (IMPLICIT STATE, EXPLICIT COEFFICIENT)</span></div>
<div class="line"><a id="l02747" name="l02747"></a><span class="lineno"> 2747</span><span class="comment">!   OF SECTION 2 OF KALNAY AND KANAMITSU</span></div>
<div class="line"><a id="l02748" name="l02748"></a><span class="lineno"> 2748</span><span class="comment">! PCPDRP IS UNITS OF KG/M**2/S OR MM/S, ZSOIL IS NEGATIVE DEPTH IN M</span></div>
<div class="line"><a id="l02749" name="l02749"></a><span class="lineno"> 2749</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02750" name="l02750"></a><span class="lineno"> 2750</span><span class="comment">!  According to Dr. Ken Mitchell&#39;s suggestion, add the second contraint</span></div>
<div class="line"><a id="l02751" name="l02751"></a><span class="lineno"> 2751</span><span class="comment">!  to remove numerical instability of runoff and soil moisture</span></div>
<div class="line"><a id="l02752" name="l02752"></a><span class="lineno"> 2752</span><span class="comment">!  FLIMIT is a limit value for FAC2</span></div>
<div class="line"><a id="l02753" name="l02753"></a><span class="lineno"> 2753</span>      fac2=0.0</div>
<div class="line"><a id="l02754" name="l02754"></a><span class="lineno"> 2754</span>      <span class="keywordflow">DO</span> i=1,nsoil</div>
<div class="line"><a id="l02755" name="l02755"></a><span class="lineno"> 2755</span>         fac2=max(fac2,sh2o(i)/smcmax)</div>
<div class="line"><a id="l02756" name="l02756"></a><span class="lineno"> 2756</span><span class="keywordflow">      ENDDO</span></div>
<div class="line"><a id="l02757" name="l02757"></a><span class="lineno"> 2757</span>      <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ad15804ed9573673deb4f95b3f160eeb2">fac2mit</a>(smcmax,flimit)</div>
<div class="line"><a id="l02758" name="l02758"></a><span class="lineno"> 2758</span> </div>
<div class="line"><a id="l02759" name="l02759"></a><span class="lineno"> 2759</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02760" name="l02760"></a><span class="lineno"> 2760</span><span class="comment">! FROZEN GROUND VERSION:</span></div>
<div class="line"><a id="l02761" name="l02761"></a><span class="lineno"> 2761</span><span class="comment">! SMC STATES REPLACED BY SH2O STATES IN SRT SUBR.  SH2O &amp; SICE STATES</span></div>
<div class="line"><a id="l02762" name="l02762"></a><span class="lineno"> 2762</span><span class="comment">! INC&amp;UDED IN SSTEP SUBR.  FROZEN GROUND CORRECTION FACTOR, FRZFACT</span></div>
<div class="line"><a id="l02763" name="l02763"></a><span class="lineno"> 2763</span><span class="comment">! ADDED.  ALL WATER BALANCE CALCULATIONS USING UNFROZEN WATER</span></div>
<div class="line"><a id="l02764" name="l02764"></a><span class="lineno"> 2764</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02765" name="l02765"></a><span class="lineno"> 2765</span> </div>
<div class="line"><a id="l02766" name="l02766"></a><span class="lineno"> 2766</span><span class="preprocessor">#ifdef WRF_HYDRO</span></div>
<div class="line"><a id="l02767" name="l02767"></a><span class="lineno"> 2767</span><span class="preprocessor"></span><span class="comment">!DJG NDHMS/WRF-Hydro edit... Add previous ponded water to new precip drip...</span></div>
<div class="line"><a id="l02768" name="l02768"></a><span class="lineno"> 2768</span>    pcpdrp = pcpdrp + sfhead1rt/1000./dt   <span class="comment">! convert SFHEAD1RT to (m/s)</span></div>
<div class="line"><a id="l02769" name="l02769"></a><span class="lineno"> 2769</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l02770" name="l02770"></a><span class="lineno"> 2770</span><span class="preprocessor"></span> </div>
<div class="line"><a id="l02771" name="l02771"></a><span class="lineno"> 2771</span> </div>
<div class="line"><a id="l02772" name="l02772"></a><span class="lineno"> 2772</span>      <span class="keywordflow">IF</span> ( ( (pcpdrp * dt) &gt; (0.0001*1000.0* (- zsoil(1))* smcmax) )   &amp;</div>
<div class="line"><a id="l02773" name="l02773"></a><span class="lineno"> 2773</span>           .OR. (fac2 &gt; flimit) ) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l02774" name="l02774"></a><span class="lineno"> 2774</span>         <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ab19c8eb3a76242cd834222e15c519613">srt</a> (rhstt,edir,et,sh2o,sh2o,nsoil,pcpdrp,zsoil,          &amp;</div>
<div class="line"><a id="l02775" name="l02775"></a><span class="lineno"> 2775</span>                    dwsat,dksat,smcmax,bexp,runoff1,                    &amp;</div>
<div class="line"><a id="l02776" name="l02776"></a><span class="lineno"> 2776</span>                    runoff2,dt,smcwlt,slope,kdt,frzfact,sice,ai,bi,ci,  &amp;</div>
<div class="line"><a id="l02777" name="l02777"></a><span class="lineno"> 2777</span>                    sfhead1rt,infxs1rt)</div>
<div class="line"><a id="l02778" name="l02778"></a><span class="lineno"> 2778</span>         <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a2e0170eed7801b6976d18285d32a1c57">sstep</a> (sh2ofg,sh2o,dummy,rhstt,rhsct,dt,nsoil,smcmax,     &amp;</div>
<div class="line"><a id="l02779" name="l02779"></a><span class="lineno"> 2779</span>                        cmcmax,runoff3,zsoil,smc,sice,ai,bi,ci,infxs1rt)</div>
<div class="line"><a id="l02780" name="l02780"></a><span class="lineno"> 2780</span>         <span class="keywordflow">DO</span> k = 1,nsoil</div>
<div class="line"><a id="l02781" name="l02781"></a><span class="lineno"> 2781</span>            sh2oa(k) = (sh2o(k) + sh2ofg(k)) * 0.5</div>
<div class="line"><a id="l02782" name="l02782"></a><span class="lineno"> 2782</span><span class="keywordflow">         END DO</span></div>
<div class="line"><a id="l02783" name="l02783"></a><span class="lineno"> 2783</span>         <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ab19c8eb3a76242cd834222e15c519613">srt</a> (rhstt,edir,et,sh2o,sh2oa,nsoil,pcpdrp,zsoil,         &amp;</div>
<div class="line"><a id="l02784" name="l02784"></a><span class="lineno"> 2784</span>                    dwsat,dksat,smcmax,bexp,runoff1,                    &amp;</div>
<div class="line"><a id="l02785" name="l02785"></a><span class="lineno"> 2785</span>                    runoff2,dt,smcwlt,slope,kdt,frzfact,sice,ai,bi,ci,  &amp;</div>
<div class="line"><a id="l02786" name="l02786"></a><span class="lineno"> 2786</span>                    sfhead1rt,infxs1rt)</div>
<div class="line"><a id="l02787" name="l02787"></a><span class="lineno"> 2787</span>         <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a2e0170eed7801b6976d18285d32a1c57">sstep</a> (sh2o,sh2o,cmc,rhstt,rhsct,dt,nsoil,smcmax,         &amp;</div>
<div class="line"><a id="l02788" name="l02788"></a><span class="lineno"> 2788</span>                        cmcmax,runoff3,zsoil,smc,sice,ai,bi,ci,infxs1rt)</div>
<div class="line"><a id="l02789" name="l02789"></a><span class="lineno"> 2789</span> </div>
<div class="line"><a id="l02790" name="l02790"></a><span class="lineno"> 2790</span>      <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l02791" name="l02791"></a><span class="lineno"> 2791</span>         <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ab19c8eb3a76242cd834222e15c519613">srt</a> (rhstt,edir,et,sh2o,sh2o,nsoil,pcpdrp,zsoil,          &amp;</div>
<div class="line"><a id="l02792" name="l02792"></a><span class="lineno"> 2792</span>                    dwsat,dksat,smcmax,bexp,runoff1,                    &amp;</div>
<div class="line"><a id="l02793" name="l02793"></a><span class="lineno"> 2793</span>                    runoff2,dt,smcwlt,slope,kdt,frzfact,sice,ai,bi,ci,  &amp;</div>
<div class="line"><a id="l02794" name="l02794"></a><span class="lineno"> 2794</span>                   sfhead1rt,infxs1rt)</div>
<div class="line"><a id="l02795" name="l02795"></a><span class="lineno"> 2795</span>         <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a2e0170eed7801b6976d18285d32a1c57">sstep</a> (sh2o,sh2o,cmc,rhstt,rhsct,dt,nsoil,smcmax,         &amp;</div>
<div class="line"><a id="l02796" name="l02796"></a><span class="lineno"> 2796</span>                     cmcmax,runoff3,zsoil,smc,sice,ai,bi,ci,infxs1rt)</div>
<div class="line"><a id="l02797" name="l02797"></a><span class="lineno"> 2797</span><span class="comment">!      RUNOF = RUNOFF</span></div>
<div class="line"><a id="l02798" name="l02798"></a><span class="lineno"> 2798</span> </div>
<div class="line"><a id="l02799" name="l02799"></a><span class="lineno"> 2799</span><span class="keywordflow">      END IF</span></div>
<div class="line"><a id="l02800" name="l02800"></a><span class="lineno"> 2800</span> </div>
<div class="line"><a id="l02801" name="l02801"></a><span class="lineno"> 2801</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02802" name="l02802"></a><span class="lineno"> 2802</span>  <span class="keyword">END SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a58888da8d933fe6e55e825b83159658b">smflx</a></div>
<div class="line"><a id="l02803" name="l02803"></a><span class="lineno"> 2803</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02804" name="l02804"></a><span class="lineno"> 2804</span> </div>
<div class="line"><a id="l02805" name="l02805"></a><span class="lineno"> 2805</span> </div>
<div class="line"><a id="l02806" name="l02806"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#ae7ad09a03325fa6a08429faa078bb8f2"> 2806</a></span>      <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ae7ad09a03325fa6a08429faa078bb8f2">snfrac</a> (SNEQV,SNUP,SALP,SNOWH,SNCOVR, &amp;</div>
<div class="line"><a id="l02807" name="l02807"></a><span class="lineno"> 2807</span>                         XLAI,SHDFAC,FVB,GAMA,FBUR,    &amp;</div>
<div class="line"><a id="l02808" name="l02808"></a><span class="lineno"> 2808</span>                         FGSN,ZTOPV,ZBOTV,UA_PHYS)</div>
<div class="line"><a id="l02809" name="l02809"></a><span class="lineno"> 2809</span> </div>
<div class="line"><a id="l02810" name="l02810"></a><span class="lineno"> 2810</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02811" name="l02811"></a><span class="lineno"> 2811</span><span class="comment">! SUBROUTINE SNFRAC</span></div>
<div class="line"><a id="l02812" name="l02812"></a><span class="lineno"> 2812</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02813" name="l02813"></a><span class="lineno"> 2813</span><span class="comment">! CALCULATE SNOW FRACTION (0 -&gt; 1)</span></div>
<div class="line"><a id="l02814" name="l02814"></a><span class="lineno"> 2814</span><span class="comment">! SNEQV   SNOW WATER EQUIVALENT (M)</span></div>
<div class="line"><a id="l02815" name="l02815"></a><span class="lineno"> 2815</span><span class="comment">! SNUP    THRESHOLD SNEQV DEPTH ABOVE WHICH SNCOVR=1</span></div>
<div class="line"><a id="l02816" name="l02816"></a><span class="lineno"> 2816</span><span class="comment">! SALP    TUNING PARAMETER</span></div>
<div class="line"><a id="l02817" name="l02817"></a><span class="lineno"> 2817</span><span class="comment">! SNCOVR  FRACTIONAL SNOW COVER</span></div>
<div class="line"><a id="l02818" name="l02818"></a><span class="lineno"> 2818</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02819" name="l02819"></a><span class="lineno"> 2819</span>      <span class="keywordtype">IMPLICIT NONE</span></div>
<div class="line"><a id="l02820" name="l02820"></a><span class="lineno"> 2820</span> </div>
<div class="line"><a id="l02821" name="l02821"></a><span class="lineno"> 2821</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(IN)</span>     :: SNEQV,SNUP,SALP,SNOWH</div>
<div class="line"><a id="l02822" name="l02822"></a><span class="lineno"> 2822</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(OUT)</span>    :: SNCOVR</div>
<div class="line"><a id="l02823" name="l02823"></a><span class="lineno"> 2823</span><span class="keywordtype">      REAL</span>                 :: RSNOW, Z0N</div>
<div class="line"><a id="l02824" name="l02824"></a><span class="lineno"> 2824</span>      <span class="keywordtype">LOGICAL</span>, <span class="keywordtype">INTENT(IN)</span>  :: UA_PHYS  <span class="comment">! UA: flag for UA option</span></div>
<div class="line"><a id="l02825" name="l02825"></a><span class="lineno"> 2825</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(IN)</span>     :: ZTOPV    <span class="comment">! UA: height of canopy top</span></div>
<div class="line"><a id="l02826" name="l02826"></a><span class="lineno"> 2826</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(IN)</span>     :: ZBOTV    <span class="comment">! UA: height of canopy bottom</span></div>
<div class="line"><a id="l02827" name="l02827"></a><span class="lineno"> 2827</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(IN)</span>     :: SHDFAC   <span class="comment">! UA: vegetation fraction</span></div>
<div class="line"><a id="l02828" name="l02828"></a><span class="lineno"> 2828</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(INOUT)</span>  :: XLAI     <span class="comment">! UA: LAI modified by snow</span></div>
<div class="line"><a id="l02829" name="l02829"></a><span class="lineno"> 2829</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(OUT)</span>    :: FVB      <span class="comment">! UA: frac. veg. w/snow beneath</span></div>
<div class="line"><a id="l02830" name="l02830"></a><span class="lineno"> 2830</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(OUT)</span>    :: GAMA     <span class="comment">! UA: = EXP(-1.* XLAI)</span></div>
<div class="line"><a id="l02831" name="l02831"></a><span class="lineno"> 2831</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(OUT)</span>    :: FBUR     <span class="comment">! UA: fraction of canopy buried</span></div>
<div class="line"><a id="l02832" name="l02832"></a><span class="lineno"> 2832</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(OUT)</span>    :: FGSN     <span class="comment">! UA: ground snow cover fraction</span></div>
<div class="line"><a id="l02833" name="l02833"></a><span class="lineno"> 2833</span> </div>
<div class="line"><a id="l02834" name="l02834"></a><span class="lineno"> 2834</span><span class="keywordtype">      REAL</span> ::  SNUPGRD = 0.02          <span class="comment">! UA: SWE limit for ground cover</span></div>
<div class="line"><a id="l02835" name="l02835"></a><span class="lineno"> 2835</span> </div>
<div class="line"><a id="l02836" name="l02836"></a><span class="lineno"> 2836</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02837" name="l02837"></a><span class="lineno"> 2837</span><span class="comment">! SNUP IS VEG-CLASS DEPENDENT SNOWDEPTH THRESHHOLD (SET IN ROUTINE</span></div>
<div class="line"><a id="l02838" name="l02838"></a><span class="lineno"> 2838</span><span class="comment">! REDPRM) ABOVE WHICH SNOCVR=1.</span></div>
<div class="line"><a id="l02839" name="l02839"></a><span class="lineno"> 2839</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02840" name="l02840"></a><span class="lineno"> 2840</span>      <span class="keywordflow">IF</span> (sneqv &lt; snup) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l02841" name="l02841"></a><span class="lineno"> 2841</span>         rsnow = sneqv / snup</div>
<div class="line"><a id="l02842" name="l02842"></a><span class="lineno"> 2842</span>         sncovr = 1. - ( exp( - salp * rsnow) - rsnow * exp( - salp))</div>
<div class="line"><a id="l02843" name="l02843"></a><span class="lineno"> 2843</span>      <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l02844" name="l02844"></a><span class="lineno"> 2844</span>         sncovr = 1.0</div>
<div class="line"><a id="l02845" name="l02845"></a><span class="lineno"> 2845</span><span class="keywordflow">      END IF</span></div>
<div class="line"><a id="l02846" name="l02846"></a><span class="lineno"> 2846</span> </div>
<div class="line"><a id="l02847" name="l02847"></a><span class="lineno"> 2847</span><span class="comment">!     FORMULATION OF DICKINSON ET AL. 1986</span></div>
<div class="line"><a id="l02848" name="l02848"></a><span class="lineno"> 2848</span><span class="comment">!     Z0N = 0.035</span></div>
<div class="line"><a id="l02849" name="l02849"></a><span class="lineno"> 2849</span> </div>
<div class="line"><a id="l02850" name="l02850"></a><span class="lineno"> 2850</span><span class="comment">!        SNCOVR=SNOWH/(SNOWH + 5*Z0N)</span></div>
<div class="line"><a id="l02851" name="l02851"></a><span class="lineno"> 2851</span> </div>
<div class="line"><a id="l02852" name="l02852"></a><span class="lineno"> 2852</span><span class="comment">!     FORMULATION OF MARSHALL ET AL. 1994</span></div>
<div class="line"><a id="l02853" name="l02853"></a><span class="lineno"> 2853</span><span class="comment">!        SNCOVR=SNEQV/(SNEQV + 2*Z0N)</span></div>
<div class="line"><a id="l02854" name="l02854"></a><span class="lineno"> 2854</span> </div>
<div class="line"><a id="l02855" name="l02855"></a><span class="lineno"> 2855</span>      <span class="keywordflow">IF</span>(ua_phys) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l02856" name="l02856"></a><span class="lineno"> 2856</span> </div>
<div class="line"><a id="l02857" name="l02857"></a><span class="lineno"> 2857</span><span class="comment">!---------------------------------------------------------------------</span></div>
<div class="line"><a id="l02858" name="l02858"></a><span class="lineno"> 2858</span><span class="comment">! FGSN: FRACTION OF SOIL COVERED WITH SNOW</span></div>
<div class="line"><a id="l02859" name="l02859"></a><span class="lineno"> 2859</span><span class="comment">!---------------------------------------------------------------------</span></div>
<div class="line"><a id="l02860" name="l02860"></a><span class="lineno"> 2860</span>        <span class="keywordflow">IF</span> (sneqv &lt; snupgrd) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l02861" name="l02861"></a><span class="lineno"> 2861</span>         fgsn = sneqv / snupgrd</div>
<div class="line"><a id="l02862" name="l02862"></a><span class="lineno"> 2862</span>        <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l02863" name="l02863"></a><span class="lineno"> 2863</span>         fgsn = 1.0</div>
<div class="line"><a id="l02864" name="l02864"></a><span class="lineno"> 2864</span><span class="keywordflow">        END IF</span></div>
<div class="line"><a id="l02865" name="l02865"></a><span class="lineno"> 2865</span><span class="comment">!------------------------------------------------------------------</span></div>
<div class="line"><a id="l02866" name="l02866"></a><span class="lineno"> 2866</span><span class="comment">! FBUR: VERTICAL FRACTION OF VEGETATION COVERED BY SNOW</span></div>
<div class="line"><a id="l02867" name="l02867"></a><span class="lineno"> 2867</span><span class="comment">! GRASS, CROP, AND SHRUB: MULTIPLY 0.4 BY ZTOPV AND ZBOTV BECAUSE </span></div>
<div class="line"><a id="l02868" name="l02868"></a><span class="lineno"> 2868</span><span class="comment">! THEY WILL BE PRESSED DOWN BY THE SNOW.</span></div>
<div class="line"><a id="l02869" name="l02869"></a><span class="lineno"> 2869</span><span class="comment">! FOREST: DON&#39;T NEED TO CHANGE ZTOPV AND ZBOTV.</span></div>
<div class="line"><a id="l02870" name="l02870"></a><span class="lineno"> 2870</span> </div>
<div class="line"><a id="l02871" name="l02871"></a><span class="lineno"> 2871</span>        <span class="keywordflow">IF</span>(zbotv &gt; 0. .AND. snowh &gt; zbotv) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l02872" name="l02872"></a><span class="lineno"> 2872</span>          <span class="keywordflow">IF</span>(zbotv &lt;= 0.5) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l02873" name="l02873"></a><span class="lineno"> 2873</span>            fbur = (snowh - 0.4*zbotv) / (0.4*(ztopv-zbotv)) <span class="comment">! short veg.</span></div>
<div class="line"><a id="l02874" name="l02874"></a><span class="lineno"> 2874</span>          <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l02875" name="l02875"></a><span class="lineno"> 2875</span>            fbur = (snowh - zbotv) / (ztopv-zbotv)           <span class="comment">!  tall veg.</span></div>
<div class="line"><a id="l02876" name="l02876"></a><span class="lineno"> 2876</span><span class="keywordflow">          ENDIF</span></div>
<div class="line"><a id="l02877" name="l02877"></a><span class="lineno"> 2877</span>        <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l02878" name="l02878"></a><span class="lineno"> 2878</span>          fbur = 0.</div>
<div class="line"><a id="l02879" name="l02879"></a><span class="lineno"> 2879</span><span class="keywordflow">        ENDIF</span></div>
<div class="line"><a id="l02880" name="l02880"></a><span class="lineno"> 2880</span> </div>
<div class="line"><a id="l02881" name="l02881"></a><span class="lineno"> 2881</span>        fbur = min(max(fbur,0.0),1.0)</div>
<div class="line"><a id="l02882" name="l02882"></a><span class="lineno"> 2882</span> </div>
<div class="line"><a id="l02883" name="l02883"></a><span class="lineno"> 2883</span><span class="comment">! XLAI IS ADJUSTED FOR VERTICAL BURYING BY SNOW</span></div>
<div class="line"><a id="l02884" name="l02884"></a><span class="lineno"> 2884</span>        xlai = xlai * (1.0 - fbur)</div>
<div class="line"><a id="l02885" name="l02885"></a><span class="lineno"> 2885</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02886" name="l02886"></a><span class="lineno"> 2886</span><span class="comment">! SNOW-COVERED SOIL: (1-SHDFAC)*FGSN</span></div>
<div class="line"><a id="l02887" name="l02887"></a><span class="lineno"> 2887</span><span class="comment">! VEGETATION WITH SNOW ABOVE DUE TO BURIAL FVEG_SN_AB = SHDFAC*FBUR</span></div>
<div class="line"><a id="l02888" name="l02888"></a><span class="lineno"> 2888</span><span class="comment">! SNOW ON THE GROUND THAT CAN BE &quot;SEEN&quot; BY SATELLITE</span></div>
<div class="line"><a id="l02889" name="l02889"></a><span class="lineno"> 2889</span><span class="comment">! (IF XLAI GOES TO ZERO): GAMA*FVB</span></div>
<div class="line"><a id="l02890" name="l02890"></a><span class="lineno"> 2890</span><span class="comment">! Where GAMA = exp(-XLAI)</span></div>
<div class="line"><a id="l02891" name="l02891"></a><span class="lineno"> 2891</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02892" name="l02892"></a><span class="lineno"> 2892</span> </div>
<div class="line"><a id="l02893" name="l02893"></a><span class="lineno"> 2893</span><span class="comment">! VEGETATION WITH SNOW BELOW</span></div>
<div class="line"><a id="l02894" name="l02894"></a><span class="lineno"> 2894</span>        fvb = shdfac * fgsn * (1.0 - fbur)</div>
<div class="line"><a id="l02895" name="l02895"></a><span class="lineno"> 2895</span> </div>
<div class="line"><a id="l02896" name="l02896"></a><span class="lineno"> 2896</span><span class="comment">! GAMA IS USED TO DIVIDE FVB INTO TWO PARTS:</span></div>
<div class="line"><a id="l02897" name="l02897"></a><span class="lineno"> 2897</span><span class="comment">! GAMA=1 FOR XLAI=0 AND GAMA=0 FOR XLAI=6</span></div>
<div class="line"><a id="l02898" name="l02898"></a><span class="lineno"> 2898</span>        gama = exp(-1.* xlai)</div>
<div class="line"><a id="l02899" name="l02899"></a><span class="lineno"> 2899</span>      <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l02900" name="l02900"></a><span class="lineno"> 2900</span>        <span class="comment">! Define intent(out) terms for .NOT. UA_PHYS case</span></div>
<div class="line"><a id="l02901" name="l02901"></a><span class="lineno"> 2901</span>        fvb  = 0.0</div>
<div class="line"><a id="l02902" name="l02902"></a><span class="lineno"> 2902</span>        gama = 0.0</div>
<div class="line"><a id="l02903" name="l02903"></a><span class="lineno"> 2903</span>        fbur = 0.0</div>
<div class="line"><a id="l02904" name="l02904"></a><span class="lineno"> 2904</span>        fgsn = 0.0</div>
<div class="line"><a id="l02905" name="l02905"></a><span class="lineno"> 2905</span><span class="keywordflow">      END IF</span>    <span class="comment">! UA_PHYS</span></div>
<div class="line"><a id="l02906" name="l02906"></a><span class="lineno"> 2906</span> </div>
<div class="line"><a id="l02907" name="l02907"></a><span class="lineno"> 2907</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02908" name="l02908"></a><span class="lineno"> 2908</span>  <span class="keyword">END SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ae7ad09a03325fa6a08429faa078bb8f2">snfrac</a></div>
<div class="line"><a id="l02909" name="l02909"></a><span class="lineno"> 2909</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02910" name="l02910"></a><span class="lineno"> 2910</span> </div>
<div class="line"><a id="l02911" name="l02911"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#a5d089c57c48085d25b95857c682922da"> 2911</a></span>      <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a5d089c57c48085d25b95857c682922da">snksrc</a> (TSNSR,TAVG,SMC,SH2O,ZSOIL,NSOIL,               &amp;</div>
<div class="line"><a id="l02912" name="l02912"></a><span class="lineno"> 2912</span>     &amp;                      SMCMAX,PSISAT,BEXP,DT,K,QTOT)</div>
<div class="line"><a id="l02913" name="l02913"></a><span class="lineno"> 2913</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02914" name="l02914"></a><span class="lineno"> 2914</span><span class="comment">! SUBROUTINE SNKSRC</span></div>
<div class="line"><a id="l02915" name="l02915"></a><span class="lineno"> 2915</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02916" name="l02916"></a><span class="lineno"> 2916</span><span class="comment">! CALCULATE SINK/SOURCE TERM OF THE TERMAL DIFFUSION EQUATION. (SH2O) IS</span></div>
<div class="line"><a id="l02917" name="l02917"></a><span class="lineno"> 2917</span><span class="comment">! AVAILABLE LIQUED WATER.</span></div>
<div class="line"><a id="l02918" name="l02918"></a><span class="lineno"> 2918</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02919" name="l02919"></a><span class="lineno"> 2919</span>      <span class="keywordtype">IMPLICIT NONE</span></div>
<div class="line"><a id="l02920" name="l02920"></a><span class="lineno"> 2920</span> </div>
<div class="line"><a id="l02921" name="l02921"></a><span class="lineno"> 2921</span>      <span class="keywordtype">INTEGER</span>, <span class="keywordtype">INTENT(IN)</span>   :: K,NSOIL</div>
<div class="line"><a id="l02922" name="l02922"></a><span class="lineno"> 2922</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(IN)</span>      :: BEXP, DT, PSISAT, QTOT, SMC, SMCMAX,    &amp;</div>
<div class="line"><a id="l02923" name="l02923"></a><span class="lineno"> 2923</span>                               TAVG</div>
<div class="line"><a id="l02924" name="l02924"></a><span class="lineno"> 2924</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(INOUT)</span>   :: SH2O</div>
<div class="line"><a id="l02925" name="l02925"></a><span class="lineno"> 2925</span> </div>
<div class="line"><a id="l02926" name="l02926"></a><span class="lineno"> 2926</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(IN)</span>:: ZSOIL</div>
<div class="line"><a id="l02927" name="l02927"></a><span class="lineno"> 2927</span> </div>
<div class="line"><a id="l02928" name="l02928"></a><span class="lineno"> 2928</span><span class="keywordtype">      REAL</span>                  :: DF, DZ, DZH, FREE, TSNSR,               &amp;</div>
<div class="line"><a id="l02929" name="l02929"></a><span class="lineno"> 2929</span>                               TDN, TM, TUP, TZ, X0, XDN, XH2O, XUP</div>
<div class="line"><a id="l02930" name="l02930"></a><span class="lineno"> 2930</span> </div>
<div class="line"><a id="l02931" name="l02931"></a><span class="lineno"> 2931</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">PARAMETER</span>       :: DH2O = 1.0000e3, hlice = 3.3350e5,      &amp;</div>
<div class="line"><a id="l02932" name="l02932"></a><span class="lineno"> 2932</span>                               t0 = 2.7315e2</div>
<div class="line"><a id="l02933" name="l02933"></a><span class="lineno"> 2933</span> </div>
<div class="line"><a id="l02934" name="l02934"></a><span class="lineno"> 2934</span>      <span class="keywordflow">IF</span> (k == 1) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l02935" name="l02935"></a><span class="lineno"> 2935</span>         dz = - zsoil(1)</div>
<div class="line"><a id="l02936" name="l02936"></a><span class="lineno"> 2936</span>      <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l02937" name="l02937"></a><span class="lineno"> 2937</span>         dz = zsoil(k -1) - zsoil(k)</div>
<div class="line"><a id="l02938" name="l02938"></a><span class="lineno"> 2938</span><span class="keywordflow">      END IF</span></div>
<div class="line"><a id="l02939" name="l02939"></a><span class="lineno"> 2939</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02940" name="l02940"></a><span class="lineno"> 2940</span><span class="comment">! VIA FUNCTION FRH2O, COMPUTE POTENTIAL OR &#39;EQUILIBRIUM&#39; UNFROZEN</span></div>
<div class="line"><a id="l02941" name="l02941"></a><span class="lineno"> 2941</span><span class="comment">! SUPERCOOLED FREE WATER FOR GIVEN SOIL TYPE AND SOIL LAYER TEMPERATURE.</span></div>
<div class="line"><a id="l02942" name="l02942"></a><span class="lineno"> 2942</span><span class="comment">! FUNCTION FRH20 INVOKES EQN (17) FROM V. KOREN ET AL (1999, JGR, VOL.</span></div>
<div class="line"><a id="l02943" name="l02943"></a><span class="lineno"> 2943</span><span class="comment">! 104, PG 19573).  (ASIDE:  LATTER EQN IN JOURNAL IN CENTIGRADE UNITS.</span></div>
<div class="line"><a id="l02944" name="l02944"></a><span class="lineno"> 2944</span><span class="comment">! ROUTINE FRH2O USE FORM OF EQN IN KELVIN UNITS.)</span></div>
<div class="line"><a id="l02945" name="l02945"></a><span class="lineno"> 2945</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02946" name="l02946"></a><span class="lineno"> 2946</span><span class="comment">!      FREE = FRH2O(TAVG,SMC,SH2O,SMCMAX,BEXP,PSISAT)</span></div>
<div class="line"><a id="l02947" name="l02947"></a><span class="lineno"> 2947</span> </div>
<div class="line"><a id="l02948" name="l02948"></a><span class="lineno"> 2948</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02949" name="l02949"></a><span class="lineno"> 2949</span><span class="comment">! IN NEXT BLOCK OF CODE, INVOKE EQN 18 OF V. KOREN ET AL (1999, JGR,</span></div>
<div class="line"><a id="l02950" name="l02950"></a><span class="lineno"> 2950</span><span class="comment">! VOL. 104, PG 19573.)  THAT IS, FIRST ESTIMATE THE NEW AMOUNTOF LIQUID</span></div>
<div class="line"><a id="l02951" name="l02951"></a><span class="lineno"> 2951</span><span class="comment">! WATER, &#39;XH2O&#39;, IMPLIED BY THE SUM OF (1) THE LIQUID WATER AT THE BEGIN</span></div>
<div class="line"><a id="l02952" name="l02952"></a><span class="lineno"> 2952</span><span class="comment">! OF CURRENT TIME STEP, AND (2) THE FREEZE OF THAW CHANGE IN LIQUID</span></div>
<div class="line"><a id="l02953" name="l02953"></a><span class="lineno"> 2953</span><span class="comment">! WATER IMPLIED BY THE HEAT FLUX &#39;QTOT&#39; PASSED IN FROM ROUTINE HRT.</span></div>
<div class="line"><a id="l02954" name="l02954"></a><span class="lineno"> 2954</span><span class="comment">! SECOND, DETERMINE IF XH2O NEEDS TO BE BOUNDED BY &#39;FREE&#39; (EQUIL AMT) OR</span></div>
<div class="line"><a id="l02955" name="l02955"></a><span class="lineno"> 2955</span><span class="comment">! IF &#39;FREE&#39; NEEDS TO BE BOUNDED BY XH2O.</span></div>
<div class="line"><a id="l02956" name="l02956"></a><span class="lineno"> 2956</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02957" name="l02957"></a><span class="lineno"> 2957</span>      <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a5beb42f74e1a357ccfc0e904f356b33a">frh2o</a> (free,tavg,smc,sh2o,smcmax,bexp,psisat)</div>
<div class="line"><a id="l02958" name="l02958"></a><span class="lineno"> 2958</span> </div>
<div class="line"><a id="l02959" name="l02959"></a><span class="lineno"> 2959</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02960" name="l02960"></a><span class="lineno"> 2960</span><span class="comment">! FIRST, IF FREEZING AND REMAINING LIQUID LESS THAN LOWER BOUND, THEN</span></div>
<div class="line"><a id="l02961" name="l02961"></a><span class="lineno"> 2961</span><span class="comment">! REDUCE EXTENT OF FREEZING, THEREBY LETTING SOME OR ALL OF HEAT FLUX</span></div>
<div class="line"><a id="l02962" name="l02962"></a><span class="lineno"> 2962</span><span class="comment">! QTOT COOL THE SOIL TEMP LATER IN ROUTINE HRT.</span></div>
<div class="line"><a id="l02963" name="l02963"></a><span class="lineno"> 2963</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02964" name="l02964"></a><span class="lineno"> 2964</span>      xh2o = sh2o + qtot * dt / (dh2o * hlice * dz)</div>
<div class="line"><a id="l02965" name="l02965"></a><span class="lineno"> 2965</span>      <span class="keywordflow">IF</span> ( xh2o &lt; sh2o .AND. xh2o &lt; free) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l02966" name="l02966"></a><span class="lineno"> 2966</span>         <span class="keywordflow">IF</span> ( free &gt; sh2o ) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l02967" name="l02967"></a><span class="lineno"> 2967</span>            xh2o = sh2o</div>
<div class="line"><a id="l02968" name="l02968"></a><span class="lineno"> 2968</span>         <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l02969" name="l02969"></a><span class="lineno"> 2969</span>            xh2o = free</div>
<div class="line"><a id="l02970" name="l02970"></a><span class="lineno"> 2970</span><span class="keywordflow">         END IF</span></div>
<div class="line"><a id="l02971" name="l02971"></a><span class="lineno"> 2971</span><span class="keywordflow">      END IF</span></div>
<div class="line"><a id="l02972" name="l02972"></a><span class="lineno"> 2972</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02973" name="l02973"></a><span class="lineno"> 2973</span><span class="comment">! SECOND, IF THAWING AND THE INCREASE IN LIQUID WATER GREATER THAN UPPER</span></div>
<div class="line"><a id="l02974" name="l02974"></a><span class="lineno"> 2974</span><span class="comment">! BOUND, THEN REDUCE EXTENT OF THAW, THEREBY LETTING SOME OR ALL OF HEAT</span></div>
<div class="line"><a id="l02975" name="l02975"></a><span class="lineno"> 2975</span><span class="comment">! FLUX QTOT WARM THE SOIL TEMP LATER IN ROUTINE HRT.</span></div>
<div class="line"><a id="l02976" name="l02976"></a><span class="lineno"> 2976</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02977" name="l02977"></a><span class="lineno"> 2977</span>      <span class="keywordflow">IF</span> ( xh2o &gt; sh2o .AND. xh2o &gt; free ) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l02978" name="l02978"></a><span class="lineno"> 2978</span>         <span class="keywordflow">IF</span> ( free &lt; sh2o ) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l02979" name="l02979"></a><span class="lineno"> 2979</span>            xh2o = sh2o</div>
<div class="line"><a id="l02980" name="l02980"></a><span class="lineno"> 2980</span>         <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l02981" name="l02981"></a><span class="lineno"> 2981</span>            xh2o = free</div>
<div class="line"><a id="l02982" name="l02982"></a><span class="lineno"> 2982</span><span class="keywordflow">         END IF</span></div>
<div class="line"><a id="l02983" name="l02983"></a><span class="lineno"> 2983</span><span class="keywordflow">      END IF</span></div>
<div class="line"><a id="l02984" name="l02984"></a><span class="lineno"> 2984</span> </div>
<div class="line"><a id="l02985" name="l02985"></a><span class="lineno"> 2985</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02986" name="l02986"></a><span class="lineno"> 2986</span><span class="comment">! CALCULATE PHASE-CHANGE HEAT SOURCE/SINK TERM FOR USE IN ROUTINE HRT</span></div>
<div class="line"><a id="l02987" name="l02987"></a><span class="lineno"> 2987</span><span class="comment">! AND UPDATE LIQUID WATER TO REFLCET FINAL FREEZE/THAW INCREMENT.</span></div>
<div class="line"><a id="l02988" name="l02988"></a><span class="lineno"> 2988</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02989" name="l02989"></a><span class="lineno"> 2989</span><span class="comment">!      SNKSRC = -DH2O*HLICE*DZ*(XH2O-SH2O)/DT</span></div>
<div class="line"><a id="l02990" name="l02990"></a><span class="lineno"> 2990</span>      <span class="keywordflow">IF</span> (xh2o &lt; 0.) xh2o = 0.</div>
<div class="line"><a id="l02991" name="l02991"></a><span class="lineno"> 2991</span>      <span class="keywordflow">IF</span> (xh2o &gt; smc) xh2o = smc</div>
<div class="line"><a id="l02992" name="l02992"></a><span class="lineno"> 2992</span>      tsnsr = - dh2o * hlice * dz * (xh2o - sh2o)/ dt</div>
<div class="line"><a id="l02993" name="l02993"></a><span class="lineno"> 2993</span>      sh2o = xh2o</div>
<div class="line"><a id="l02994" name="l02994"></a><span class="lineno"> 2994</span> </div>
<div class="line"><a id="l02995" name="l02995"></a><span class="lineno"> 2995</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02996" name="l02996"></a><span class="lineno"> 2996</span>  <span class="keyword">END SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a5d089c57c48085d25b95857c682922da">snksrc</a></div>
<div class="line"><a id="l02997" name="l02997"></a><span class="lineno"> 2997</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02998" name="l02998"></a><span class="lineno"> 2998</span> </div>
<div class="line"><a id="l02999" name="l02999"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#ae27e8294cc66ecbb23f2a9d239a3c3d7"> 2999</a></span>      <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ae27e8294cc66ecbb23f2a9d239a3c3d7">snopac</a> (ETP,ETA,PRCP,PRCPF,SNOWNG,SMC,SMCMAX,SMCWLT,   &amp;</div>
<div class="line"><a id="l03000" name="l03000"></a><span class="lineno"> 3000</span>                          SMCREF,SMCDRY,CMC,CMCMAX,NSOIL,DT,            &amp;</div>
<div class="line"><a id="l03001" name="l03001"></a><span class="lineno"> 3001</span>                          SBETA,DF1,                                    &amp;</div>
<div class="line"><a id="l03002" name="l03002"></a><span class="lineno"> 3002</span>                          Q2,T1,SFCTMP,T24,TH2,FDOWN,F1,SSOIL,STC,EPSCA,&amp;</div>
<div class="line"><a id="l03003" name="l03003"></a><span class="lineno"> 3003</span>                         SFCPRS,BEXP,PC,RCH,RR,CFACTR,SNCOVR,ESD,SNDENS,&amp;</div>
<div class="line"><a id="l03004" name="l03004"></a><span class="lineno"> 3004</span>                          SNOWH,SH2O,SLOPE,KDT,FRZFACT,PSISAT,          &amp;</div>
<div class="line"><a id="l03005" name="l03005"></a><span class="lineno"> 3005</span>                          ZSOIL,DWSAT,DKSAT,TBOT,ZBOT,SHDFAC,RUNOFF1,   &amp;</div>
<div class="line"><a id="l03006" name="l03006"></a><span class="lineno"> 3006</span>                          RUNOFF2,RUNOFF3,EDIR,EC,ET,ETT,NROOT,SNOMLT,  &amp;</div>
<div class="line"><a id="l03007" name="l03007"></a><span class="lineno"> 3007</span>                          RTDIS,QUARTZ,FXEXP,CSOIL,                     &amp;</div>
<div class="line"><a id="l03008" name="l03008"></a><span class="lineno"> 3008</span>                          BETA,DRIP,DEW,FLX1,FLX2,FLX3,ESNOW,ETNS,EMISSI,&amp;</div>
<div class="line"><a id="l03009" name="l03009"></a><span class="lineno"> 3009</span>                          RIBB,SOLDN,                                   &amp;</div>
<div class="line"><a id="l03010" name="l03010"></a><span class="lineno"> 3010</span>                          ISURBAN,                                      &amp;</div>
<div class="line"><a id="l03011" name="l03011"></a><span class="lineno"> 3011</span>                          VEGTYP,                                       &amp;</div>
<div class="line"><a id="l03012" name="l03012"></a><span class="lineno"> 3012</span>                          ETPN,FLX4,UA_PHYS,                            &amp;</div>
<div class="line"><a id="l03013" name="l03013"></a><span class="lineno"> 3013</span>                          SFHEAD1RT,INFXS1RT,ETPND1,SOILTYP,OPT_THCND   &amp;</div>
<div class="line"><a id="l03014" name="l03014"></a><span class="lineno"> 3014</span>                         ,QFX_PHY,fasdas,HCPCT_FASDAS                   ) <span class="comment">!fasdas</span></div>
<div class="line"><a id="l03015" name="l03015"></a><span class="lineno"> 3015</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03016" name="l03016"></a><span class="lineno"> 3016</span><span class="comment">! SUBROUTINE SNOPAC</span></div>
<div class="line"><a id="l03017" name="l03017"></a><span class="lineno"> 3017</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03018" name="l03018"></a><span class="lineno"> 3018</span><span class="comment">! CALCULATE SOIL MOISTURE AND HEAT FLUX VALUES &amp; UPDATE SOIL MOISTURE</span></div>
<div class="line"><a id="l03019" name="l03019"></a><span class="lineno"> 3019</span><span class="comment">! CONTENT AND SOIL HEAT CONTENT VALUES FOR THE CASE WHEN A SNOW PACK IS</span></div>
<div class="line"><a id="l03020" name="l03020"></a><span class="lineno"> 3020</span><span class="comment">! PRESENT.</span></div>
<div class="line"><a id="l03021" name="l03021"></a><span class="lineno"> 3021</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03022" name="l03022"></a><span class="lineno"> 3022</span>      <span class="keywordtype">IMPLICIT NONE</span></div>
<div class="line"><a id="l03023" name="l03023"></a><span class="lineno"> 3023</span> </div>
<div class="line"><a id="l03024" name="l03024"></a><span class="lineno"> 3024</span>      <span class="keywordtype">INTEGER</span>, <span class="keywordtype">INTENT(IN)</span>   :: OPT_THCND</div>
<div class="line"><a id="l03025" name="l03025"></a><span class="lineno"> 3025</span>      <span class="keywordtype">INTEGER</span>, <span class="keywordtype">INTENT(IN)</span>   :: NROOT, NSOIL,VEGTYP,SOILTYP</div>
<div class="line"><a id="l03026" name="l03026"></a><span class="lineno"> 3026</span>      <span class="keywordtype">INTEGER</span>, <span class="keywordtype">INTENT(IN)</span>   :: ISURBAN</div>
<div class="line"><a id="l03027" name="l03027"></a><span class="lineno"> 3027</span>      <span class="keywordtype">INTEGER</span>               :: K</div>
<div class="line"><a id="l03028" name="l03028"></a><span class="lineno"> 3028</span><span class="comment">!</span></div>
<div class="line"><a id="l03029" name="l03029"></a><span class="lineno"> 3029</span><span class="comment">! kmh 09/03/2006 add IT16 for surface temperature iteration</span></div>
<div class="line"><a id="l03030" name="l03030"></a><span class="lineno"> 3030</span><span class="comment">!</span></div>
<div class="line"><a id="l03031" name="l03031"></a><span class="lineno"> 3031</span>      <span class="keywordtype">INTEGER</span>               :: IT16</div>
<div class="line"><a id="l03032" name="l03032"></a><span class="lineno"> 3032</span>      <span class="keywordtype">LOGICAL</span>, <span class="keywordtype">INTENT(IN)</span>   :: SNOWNG</div>
<div class="line"><a id="l03033" name="l03033"></a><span class="lineno"> 3033</span> </div>
<div class="line"><a id="l03034" name="l03034"></a><span class="lineno"> 3034</span><span class="comment">!DJG NDHMS/WRF-Hydro edit...</span></div>
<div class="line"><a id="l03035" name="l03035"></a><span class="lineno"> 3035</span><span class="keywordtype">       REAL</span>, <span class="keywordtype">INTENT(INOUT)</span>    ::  SFHEAD1RT,INFXS1RT,ETPND1</div>
<div class="line"><a id="l03036" name="l03036"></a><span class="lineno"> 3036</span> </div>
<div class="line"><a id="l03037" name="l03037"></a><span class="lineno"> 3037</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(IN)</span>      :: BEXP,CFACTR, CMCMAX,CSOIL,DF1,DKSAT,     &amp;</div>
<div class="line"><a id="l03038" name="l03038"></a><span class="lineno"> 3038</span>                               DT,DWSAT, EPSCA,FDOWN,F1,FXEXP,          &amp;</div>
<div class="line"><a id="l03039" name="l03039"></a><span class="lineno"> 3039</span>                               FRZFACT,KDT,PC, PRCP,PSISAT,Q2,QUARTZ,   &amp;</div>
<div class="line"><a id="l03040" name="l03040"></a><span class="lineno"> 3040</span>                               RCH,RR,SBETA,SFCPRS, SFCTMP, SHDFAC,     &amp;</div>
<div class="line"><a id="l03041" name="l03041"></a><span class="lineno"> 3041</span>                               SLOPE,SMCDRY,SMCMAX,SMCREF,SMCWLT, T24,  &amp;</div>
<div class="line"><a id="l03042" name="l03042"></a><span class="lineno"> 3042</span>                               TBOT,TH2,ZBOT,EMISSI,SOLDN</div>
<div class="line"><a id="l03043" name="l03043"></a><span class="lineno"> 3043</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(INOUT)</span>   :: CMC, BETA, ESD,FLX2,PRCPF,SNOWH,SNCOVR,  &amp;</div>
<div class="line"><a id="l03044" name="l03044"></a><span class="lineno"> 3044</span>                               SNDENS, T1, RIBB, ETP</div>
<div class="line"><a id="l03045" name="l03045"></a><span class="lineno"> 3045</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(OUT)</span>     :: DEW,DRIP,EC,EDIR, ETNS, ESNOW,ETT,       &amp;</div>
<div class="line"><a id="l03046" name="l03046"></a><span class="lineno"> 3046</span>                               FLX1,FLX3, RUNOFF1,RUNOFF2,RUNOFF3,      &amp;</div>
<div class="line"><a id="l03047" name="l03047"></a><span class="lineno"> 3047</span>                               SSOIL,SNOMLT</div>
<div class="line"><a id="l03048" name="l03048"></a><span class="lineno"> 3048</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>,<span class="keywordtype">INTENT(IN)</span>     :: RTDIS,ZSOIL</div>
<div class="line"><a id="l03049" name="l03049"></a><span class="lineno"> 3049</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>,<span class="keywordtype">INTENT(OUT)</span>    :: ET</div>
<div class="line"><a id="l03050" name="l03050"></a><span class="lineno"> 3050</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(INOUT)</span> :: SMC,SH2O,STC</div>
<div class="line"><a id="l03051" name="l03051"></a><span class="lineno"> 3051</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span> :: ET1</div>
<div class="line"><a id="l03052" name="l03052"></a><span class="lineno"> 3052</span><span class="keywordtype">      REAL</span>                  :: DENOM,DSOIL,DTOT,EC1,EDIR1,ESDFLX,ETA,   &amp;</div>
<div class="line"><a id="l03053" name="l03053"></a><span class="lineno"> 3053</span>                               ETT1, ESNOW1, ESNOW2, ETA1,ETP1,ETP2,    &amp;</div>
<div class="line"><a id="l03054" name="l03054"></a><span class="lineno"> 3054</span>                               ETP3, ETNS1, ETANRG, ETAX, EX, FLX3X,    &amp;</div>
<div class="line"><a id="l03055" name="l03055"></a><span class="lineno"> 3055</span>                               FRCSNO,FRCSOI, PRCP1, QSAT,RSNOW, SEH,   &amp;</div>
<div class="line"><a id="l03056" name="l03056"></a><span class="lineno"> 3056</span>                               SNCOND,SSOIL1, T11,T12, T12A, T12AX,     &amp;</div>
<div class="line"><a id="l03057" name="l03057"></a><span class="lineno"> 3057</span>                               T12B, T14, YY, ZZ1</div>
<div class="line"><a id="l03058" name="l03058"></a><span class="lineno"> 3058</span><span class="comment">!                               T12B, T14, YY, ZZ1,EMISSI_S</span></div>
<div class="line"><a id="l03059" name="l03059"></a><span class="lineno"> 3059</span><span class="comment">!</span></div>
<div class="line"><a id="l03060" name="l03060"></a><span class="lineno"> 3060</span><span class="comment">! kmh 01/11/2007 add T15, T16, and DTOT2 for SFC T iteration and snow heat flux</span></div>
<div class="line"><a id="l03061" name="l03061"></a><span class="lineno"> 3061</span><span class="comment">!</span></div>
<div class="line"><a id="l03062" name="l03062"></a><span class="lineno"> 3062</span><span class="keywordtype">      REAL</span>                  :: T15, T16, DTOT2</div>
<div class="line"><a id="l03063" name="l03063"></a><span class="lineno"> 3063</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">PARAMETER</span>       :: ESDMIN = 1.e-6, lsubc = 2.501000e+6,     &amp;</div>
<div class="line"><a id="l03064" name="l03064"></a><span class="lineno"> 3064</span>                               lsubs = 2.83e+6, tfreez = 273.15,        &amp;</div>
<div class="line"><a id="l03065" name="l03065"></a><span class="lineno"> 3065</span>                               snoexp = 2.0</div>
<div class="line"><a id="l03066" name="l03066"></a><span class="lineno"> 3066</span>      <span class="keywordtype">LOGICAL</span>, <span class="keywordtype">INTENT(IN)</span>   :: UA_PHYS  <span class="comment">! UA: flag for UA option</span></div>
<div class="line"><a id="l03067" name="l03067"></a><span class="lineno"> 3067</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(INOUT)</span>   :: FLX4     <span class="comment">! UA: energy removed by canopy</span></div>
<div class="line"><a id="l03068" name="l03068"></a><span class="lineno"> 3068</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(IN)</span>      :: ETPN     <span class="comment">! UA: adjusted pot. evap. [mm/s]</span></div>
<div class="line"><a id="l03069" name="l03069"></a><span class="lineno"> 3069</span><span class="keywordtype">      REAL</span>                  :: ETP1N    <span class="comment">! UA: adjusted pot. evap. [m/s]</span></div>
<div class="line"><a id="l03070" name="l03070"></a><span class="lineno"> 3070</span> </div>
<div class="line"><a id="l03071" name="l03071"></a><span class="lineno"> 3071</span><span class="comment">!</span></div>
<div class="line"><a id="l03072" name="l03072"></a><span class="lineno"> 3072</span><span class="comment">!  FASDAS</span></div>
<div class="line"><a id="l03073" name="l03073"></a><span class="lineno"> 3073</span><span class="comment">!</span></div>
<div class="line"><a id="l03074" name="l03074"></a><span class="lineno"> 3074</span><span class="keywordtype">      REAL</span>                  :: QFX_PHY</div>
<div class="line"><a id="l03075" name="l03075"></a><span class="lineno"> 3075</span>      <span class="keywordtype">INTEGER</span>               :: fasdas</div>
<div class="line"><a id="l03076" name="l03076"></a><span class="lineno"> 3076</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(  OUT)</span>   :: HCPCT_FASDAS</div>
<div class="line"><a id="l03077" name="l03077"></a><span class="lineno"> 3077</span><span class="comment">!</span></div>
<div class="line"><a id="l03078" name="l03078"></a><span class="lineno"> 3078</span><span class="comment">!  END FASDAS</span></div>
<div class="line"><a id="l03079" name="l03079"></a><span class="lineno"> 3079</span><span class="comment">!</span></div>
<div class="line"><a id="l03080" name="l03080"></a><span class="lineno"> 3080</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03081" name="l03081"></a><span class="lineno"> 3081</span><span class="comment">! EXECUTABLE CODE BEGINS HERE:</span></div>
<div class="line"><a id="l03082" name="l03082"></a><span class="lineno"> 3082</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03083" name="l03083"></a><span class="lineno"> 3083</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03084" name="l03084"></a><span class="lineno"> 3084</span><span class="comment">! INITIALIZE EVAP TERMS.</span></div>
<div class="line"><a id="l03085" name="l03085"></a><span class="lineno"> 3085</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03086" name="l03086"></a><span class="lineno"> 3086</span><span class="comment">! conversions:</span></div>
<div class="line"><a id="l03087" name="l03087"></a><span class="lineno"> 3087</span><span class="comment">! ESNOW [KG M-2 S-1]</span></div>
<div class="line"><a id="l03088" name="l03088"></a><span class="lineno"> 3088</span><span class="comment">! ESDFLX [KG M-2 S-1] .le. ESNOW</span></div>
<div class="line"><a id="l03089" name="l03089"></a><span class="lineno"> 3089</span><span class="comment">! ESNOW1 [M S-1]</span></div>
<div class="line"><a id="l03090" name="l03090"></a><span class="lineno"> 3090</span><span class="comment">! ESNOW2 [M]</span></div>
<div class="line"><a id="l03091" name="l03091"></a><span class="lineno"> 3091</span><span class="comment">! ETP [KG M-2 S-1]</span></div>
<div class="line"><a id="l03092" name="l03092"></a><span class="lineno"> 3092</span><span class="comment">! ETP1 [M S-1]</span></div>
<div class="line"><a id="l03093" name="l03093"></a><span class="lineno"> 3093</span><span class="comment">! ETP2 [M]</span></div>
<div class="line"><a id="l03094" name="l03094"></a><span class="lineno"> 3094</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03095" name="l03095"></a><span class="lineno"> 3095</span>      dew = 0.</div>
<div class="line"><a id="l03096" name="l03096"></a><span class="lineno"> 3096</span>      edir = 0.</div>
<div class="line"><a id="l03097" name="l03097"></a><span class="lineno"> 3097</span>      edir1 = 0.</div>
<div class="line"><a id="l03098" name="l03098"></a><span class="lineno"> 3098</span>      ec1 = 0.</div>
<div class="line"><a id="l03099" name="l03099"></a><span class="lineno"> 3099</span>      ec = 0.</div>
<div class="line"><a id="l03100" name="l03100"></a><span class="lineno"> 3100</span><span class="comment">!      EMISSI_S=0.95    ! For snow</span></div>
<div class="line"><a id="l03101" name="l03101"></a><span class="lineno"> 3101</span> </div>
<div class="line"><a id="l03102" name="l03102"></a><span class="lineno"> 3102</span>      <span class="keywordflow">DO</span> k = 1,nsoil</div>
<div class="line"><a id="l03103" name="l03103"></a><span class="lineno"> 3103</span>         et(k) = 0.</div>
<div class="line"><a id="l03104" name="l03104"></a><span class="lineno"> 3104</span>         et1(k) = 0.</div>
<div class="line"><a id="l03105" name="l03105"></a><span class="lineno"> 3105</span><span class="keywordflow">      END DO</span></div>
<div class="line"><a id="l03106" name="l03106"></a><span class="lineno"> 3106</span>      ett = 0.</div>
<div class="line"><a id="l03107" name="l03107"></a><span class="lineno"> 3107</span>      ett1 = 0.</div>
<div class="line"><a id="l03108" name="l03108"></a><span class="lineno"> 3108</span> </div>
<div class="line"><a id="l03109" name="l03109"></a><span class="lineno"> 3109</span><span class="comment">!DJG NDHMS/WRF-Hydro edit...</span></div>
<div class="line"><a id="l03110" name="l03110"></a><span class="lineno"> 3110</span>      etpnd1 = 0.</div>
<div class="line"><a id="l03111" name="l03111"></a><span class="lineno"> 3111</span> </div>
<div class="line"><a id="l03112" name="l03112"></a><span class="lineno"> 3112</span> </div>
<div class="line"><a id="l03113" name="l03113"></a><span class="lineno"> 3113</span>      etns = 0.</div>
<div class="line"><a id="l03114" name="l03114"></a><span class="lineno"> 3114</span>      etns1 = 0.</div>
<div class="line"><a id="l03115" name="l03115"></a><span class="lineno"> 3115</span>      esnow = 0.</div>
<div class="line"><a id="l03116" name="l03116"></a><span class="lineno"> 3116</span>      esnow1 = 0.</div>
<div class="line"><a id="l03117" name="l03117"></a><span class="lineno"> 3117</span>      esnow2 = 0.</div>
<div class="line"><a id="l03118" name="l03118"></a><span class="lineno"> 3118</span> </div>
<div class="line"><a id="l03119" name="l03119"></a><span class="lineno"> 3119</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03120" name="l03120"></a><span class="lineno"> 3120</span><span class="comment">! CONVERT POTENTIAL EVAP (ETP) FROM KG M-2 S-1 TO ETP1 IN M S-1</span></div>
<div class="line"><a id="l03121" name="l03121"></a><span class="lineno"> 3121</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03122" name="l03122"></a><span class="lineno"> 3122</span>      prcp1 = prcpf *0.001</div>
<div class="line"><a id="l03123" name="l03123"></a><span class="lineno"> 3123</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03124" name="l03124"></a><span class="lineno"> 3124</span><span class="comment">! IF ETP&lt;0 (DOWNWARD) THEN DEWFALL (=FROSTFALL IN THIS CASE).</span></div>
<div class="line"><a id="l03125" name="l03125"></a><span class="lineno"> 3125</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03126" name="l03126"></a><span class="lineno"> 3126</span>      beta = 1.0</div>
<div class="line"><a id="l03127" name="l03127"></a><span class="lineno"> 3127</span>      <span class="keywordflow">IF</span> (etp &lt;= 0.0) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l03128" name="l03128"></a><span class="lineno"> 3128</span>         <span class="keywordflow">IF</span> ( ( ribb &gt;= 0.1 ) .AND. ( fdown &gt; 150.0 ) ) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l03129" name="l03129"></a><span class="lineno"> 3129</span>            etp=(min(etp*(1.0-ribb),0.)*sncovr/0.980 + etp*(0.980-sncovr))/0.980</div>
<div class="line"><a id="l03130" name="l03130"></a><span class="lineno"> 3130</span><span class="keywordflow">         ENDIF</span></div>
<div class="line"><a id="l03131" name="l03131"></a><span class="lineno"> 3131</span>         <span class="keywordflow">IF</span>(etp == 0.) beta = 0.0</div>
<div class="line"><a id="l03132" name="l03132"></a><span class="lineno"> 3132</span>         etp1 = etp * 0.001</div>
<div class="line"><a id="l03133" name="l03133"></a><span class="lineno"> 3133</span>         <span class="keywordflow">IF</span>(ua_phys) etp1n = etpn * 0.001</div>
<div class="line"><a id="l03134" name="l03134"></a><span class="lineno"> 3134</span>         dew = -etp1</div>
<div class="line"><a id="l03135" name="l03135"></a><span class="lineno"> 3135</span>         esnow2 = etp1*dt</div>
<div class="line"><a id="l03136" name="l03136"></a><span class="lineno"> 3136</span>         etanrg = etp*((1.-sncovr)*lsubc + sncovr*lsubs)</div>
<div class="line"><a id="l03137" name="l03137"></a><span class="lineno"> 3137</span>      <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l03138" name="l03138"></a><span class="lineno"> 3138</span>         etp1 = etp * 0.001</div>
<div class="line"><a id="l03139" name="l03139"></a><span class="lineno"> 3139</span>         <span class="keywordflow">IF</span>(ua_phys) etp1n = etpn * 0.001</div>
<div class="line"><a id="l03140" name="l03140"></a><span class="lineno"> 3140</span>         <span class="comment">!  LAND CASE</span></div>
<div class="line"><a id="l03141" name="l03141"></a><span class="lineno"> 3141</span>         <span class="keywordflow">IF</span> (sncovr &lt;  1.) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l03142" name="l03142"></a><span class="lineno"> 3142</span>            <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ae65310d4c0555dd149f413ff42737077">evapo</a> (etns1,smc,nsoil,cmc,etp1,dt,zsoil,           &amp;</div>
<div class="line"><a id="l03143" name="l03143"></a><span class="lineno"> 3143</span>                         sh2o,                                       &amp;</div>
<div class="line"><a id="l03144" name="l03144"></a><span class="lineno"> 3144</span>                         smcmax,bexp,pc,smcwlt,dksat,dwsat,          &amp;</div>
<div class="line"><a id="l03145" name="l03145"></a><span class="lineno"> 3145</span>                         smcref,shdfac,cmcmax,                       &amp;</div>
<div class="line"><a id="l03146" name="l03146"></a><span class="lineno"> 3146</span>                         smcdry,cfactr,                              &amp;</div>
<div class="line"><a id="l03147" name="l03147"></a><span class="lineno"> 3147</span>                         edir1,ec1,et1,ett1,sfctmp,q2,nroot,rtdis,   &amp;</div>
<div class="line"><a id="l03148" name="l03148"></a><span class="lineno"> 3148</span>                         fxexp, sfhead1rt,etpnd1)</div>
<div class="line"><a id="l03149" name="l03149"></a><span class="lineno"> 3149</span><span class="comment">! ----------------------------------------------------------------------------</span></div>
<div class="line"><a id="l03150" name="l03150"></a><span class="lineno"> 3150</span>            edir1 = edir1* (1. - sncovr)</div>
<div class="line"><a id="l03151" name="l03151"></a><span class="lineno"> 3151</span>            ec1 = ec1* (1. - sncovr)</div>
<div class="line"><a id="l03152" name="l03152"></a><span class="lineno"> 3152</span>            <span class="keywordflow">DO</span> k = 1,nsoil</div>
<div class="line"><a id="l03153" name="l03153"></a><span class="lineno"> 3153</span>               et1(k) = et1(k)* (1. - sncovr)</div>
<div class="line"><a id="l03154" name="l03154"></a><span class="lineno"> 3154</span><span class="keywordflow">            END DO</span></div>
<div class="line"><a id="l03155" name="l03155"></a><span class="lineno"> 3155</span>            ett1 = ett1*(1.-sncovr)</div>
<div class="line"><a id="l03156" name="l03156"></a><span class="lineno"> 3156</span><span class="comment">!            ETNS1 = EDIR1+ EC1+ ETT1</span></div>
<div class="line"><a id="l03157" name="l03157"></a><span class="lineno"> 3157</span>            etns1 = etns1*(1.-sncovr)</div>
<div class="line"><a id="l03158" name="l03158"></a><span class="lineno"> 3158</span><span class="comment">! ----------------------------------------------------------------------------</span></div>
<div class="line"><a id="l03159" name="l03159"></a><span class="lineno"> 3159</span>            edir = edir1*1000.</div>
<div class="line"><a id="l03160" name="l03160"></a><span class="lineno"> 3160</span>            ec = ec1*1000.</div>
<div class="line"><a id="l03161" name="l03161"></a><span class="lineno"> 3161</span>            <span class="keywordflow">DO</span> k = 1,nsoil</div>
<div class="line"><a id="l03162" name="l03162"></a><span class="lineno"> 3162</span>               et(k) = et1(k)*1000.</div>
<div class="line"><a id="l03163" name="l03163"></a><span class="lineno"> 3163</span><span class="keywordflow">            END DO</span></div>
<div class="line"><a id="l03164" name="l03164"></a><span class="lineno"> 3164</span><span class="comment">!</span></div>
<div class="line"><a id="l03165" name="l03165"></a><span class="lineno"> 3165</span><span class="comment">! FASDAS</span></div>
<div class="line"><a id="l03166" name="l03166"></a><span class="lineno"> 3166</span><span class="comment">!</span></div>
<div class="line"><a id="l03167" name="l03167"></a><span class="lineno"> 3167</span>            <span class="keywordflow">if</span>( fasdas ==  1 ) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03168" name="l03168"></a><span class="lineno"> 3168</span>              qfx_phy = edir + ec</div>
<div class="line"><a id="l03169" name="l03169"></a><span class="lineno"> 3169</span>              <span class="keywordflow">DO</span> k=1,nsoil</div>
<div class="line"><a id="l03170" name="l03170"></a><span class="lineno"> 3170</span>                 qfx_phy = qfx_phy + et(k)</div>
<div class="line"><a id="l03171" name="l03171"></a><span class="lineno"> 3171</span><span class="keywordflow">              END DO</span></div>
<div class="line"><a id="l03172" name="l03172"></a><span class="lineno"> 3172</span><span class="keywordflow">            endif</span></div>
<div class="line"><a id="l03173" name="l03173"></a><span class="lineno"> 3173</span><span class="comment">!</span></div>
<div class="line"><a id="l03174" name="l03174"></a><span class="lineno"> 3174</span><span class="comment">! END FASDAS</span></div>
<div class="line"><a id="l03175" name="l03175"></a><span class="lineno"> 3175</span><span class="comment">!</span></div>
<div class="line"><a id="l03176" name="l03176"></a><span class="lineno"> 3176</span>            ett = ett1*1000.</div>
<div class="line"><a id="l03177" name="l03177"></a><span class="lineno"> 3177</span>            etns = etns1*1000.</div>
<div class="line"><a id="l03178" name="l03178"></a><span class="lineno"> 3178</span> </div>
<div class="line"><a id="l03179" name="l03179"></a><span class="lineno"> 3179</span> </div>
<div class="line"><a id="l03180" name="l03180"></a><span class="lineno"> 3180</span><span class="comment">!DJG NDHMS/WRF-Hydro edit...</span></div>
<div class="line"><a id="l03181" name="l03181"></a><span class="lineno"> 3181</span>               etpnd1 = etpnd1*1000.</div>
<div class="line"><a id="l03182" name="l03182"></a><span class="lineno"> 3182</span> </div>
<div class="line"><a id="l03183" name="l03183"></a><span class="lineno"> 3183</span> </div>
<div class="line"><a id="l03184" name="l03184"></a><span class="lineno"> 3184</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03185" name="l03185"></a><span class="lineno"> 3185</span> </div>
<div class="line"><a id="l03186" name="l03186"></a><span class="lineno"> 3186</span><span class="keywordflow">         ENDIF</span></div>
<div class="line"><a id="l03187" name="l03187"></a><span class="lineno"> 3187</span>         esnow = etp*sncovr</div>
<div class="line"><a id="l03188" name="l03188"></a><span class="lineno"> 3188</span>         <span class="keywordflow">IF</span>(ua_phys) esnow = etpn*sncovr   <span class="comment">! USE ADJUSTED ETP</span></div>
<div class="line"><a id="l03189" name="l03189"></a><span class="lineno"> 3189</span>         esnow1 = esnow*0.001</div>
<div class="line"><a id="l03190" name="l03190"></a><span class="lineno"> 3190</span>         esnow2 = esnow1*dt</div>
<div class="line"><a id="l03191" name="l03191"></a><span class="lineno"> 3191</span>         etanrg = esnow*lsubs + etns*lsubc</div>
<div class="line"><a id="l03192" name="l03192"></a><span class="lineno"> 3192</span><span class="keywordflow">      ENDIF</span></div>
<div class="line"><a id="l03193" name="l03193"></a><span class="lineno"> 3193</span> </div>
<div class="line"><a id="l03194" name="l03194"></a><span class="lineno"> 3194</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03195" name="l03195"></a><span class="lineno"> 3195</span><span class="comment">! IF PRECIP IS FALLING, CALCULATE HEAT FLUX FROM SNOW SFC TO NEWLY</span></div>
<div class="line"><a id="l03196" name="l03196"></a><span class="lineno"> 3196</span><span class="comment">! ACCUMULATING PRECIP.  NOTE THAT THIS REFLECTS THE FLUX APPROPRIATE FOR</span></div>
<div class="line"><a id="l03197" name="l03197"></a><span class="lineno"> 3197</span><span class="comment">! THE NOT-YET-UPDATED SKIN TEMPERATURE (T1).  ASSUMES TEMPERATURE OF THE</span></div>
<div class="line"><a id="l03198" name="l03198"></a><span class="lineno"> 3198</span><span class="comment">! SNOWFALL STRIKING THE GROUND IS =SFCTMP (LOWEST MODEL LEVEL AIR TEMP).</span></div>
<div class="line"><a id="l03199" name="l03199"></a><span class="lineno"> 3199</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03200" name="l03200"></a><span class="lineno"> 3200</span>      flx1 = 0.0</div>
<div class="line"><a id="l03201" name="l03201"></a><span class="lineno"> 3201</span>      <span class="keywordflow">IF</span> (snowng) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l03202" name="l03202"></a><span class="lineno"> 3202</span>         flx1 = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a653d3903e2acbd4d19387ea434944093">cpice</a> * prcp * (t1- sfctmp)</div>
<div class="line"><a id="l03203" name="l03203"></a><span class="lineno"> 3203</span>      <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l03204" name="l03204"></a><span class="lineno"> 3204</span>         <span class="keywordflow">IF</span> (prcp &gt;  0.0) flx1 = <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#ae07d087354ac15d439a02c8f0a1d24e4">cph2o</a> * prcp * (t1- sfctmp)</div>
<div class="line"><a id="l03205" name="l03205"></a><span class="lineno"> 3205</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03206" name="l03206"></a><span class="lineno"> 3206</span><span class="comment">! CALCULATE AN &#39;EFFECTIVE SNOW-GRND SFC TEMP&#39; (T12) BASED ON HEAT FLUXES</span></div>
<div class="line"><a id="l03207" name="l03207"></a><span class="lineno"> 3207</span><span class="comment">! BETWEEN THE SNOW PACK AND THE SOIL AND ON NET RADIATION.</span></div>
<div class="line"><a id="l03208" name="l03208"></a><span class="lineno"> 3208</span><span class="comment">! INCLUDE FLX1 (PRECIP-SNOW SFC) AND FLX2 (FREEZING RAIN LATENT HEAT)</span></div>
<div class="line"><a id="l03209" name="l03209"></a><span class="lineno"> 3209</span><span class="comment">! FLUXES.  FLX1 FROM ABOVE, FLX2 BROUGHT IN VIA COMMOM BLOCK RITE.</span></div>
<div class="line"><a id="l03210" name="l03210"></a><span class="lineno"> 3210</span><span class="comment">! FLX2 REFLECTS FREEZING RAIN LATENT HEAT FLUX USING T1 CALCULATED IN</span></div>
<div class="line"><a id="l03211" name="l03211"></a><span class="lineno"> 3211</span><span class="comment">! PENMAN.</span></div>
<div class="line"><a id="l03212" name="l03212"></a><span class="lineno"> 3212</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03213" name="l03213"></a><span class="lineno"> 3213</span><span class="keywordflow">      END IF</span></div>
<div class="line"><a id="l03214" name="l03214"></a><span class="lineno"> 3214</span>      dsoil = - (0.5 * zsoil(1))</div>
<div class="line"><a id="l03215" name="l03215"></a><span class="lineno"> 3215</span>      dtot = snowh + dsoil</div>
<div class="line"><a id="l03216" name="l03216"></a><span class="lineno"> 3216</span>      denom = 1.0+ df1 / (dtot * rr * rch)</div>
<div class="line"><a id="l03217" name="l03217"></a><span class="lineno"> 3217</span><span class="comment">! surface emissivity weighted by snow cover fraction</span></div>
<div class="line"><a id="l03218" name="l03218"></a><span class="lineno"> 3218</span><span class="comment">!      T12A = ( (FDOWN - FLX1 - FLX2 -                                   &amp;</span></div>
<div class="line"><a id="l03219" name="l03219"></a><span class="lineno"> 3219</span><span class="comment">!     &amp;       ((SNCOVR*EMISSI_S)+EMISSI*(1.0-SNCOVR))*SIGMA *T24)/RCH    &amp;</span></div>
<div class="line"><a id="l03220" name="l03220"></a><span class="lineno"> 3220</span><span class="comment">!     &amp;       + TH2 - SFCTMP - ETANRG/RCH ) / RR</span></div>
<div class="line"><a id="l03221" name="l03221"></a><span class="lineno"> 3221</span>      t12a = ( (fdown - flx1- flx2- emissi * <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a41b56481dda78f3181c7e40721fa79a0">sigma</a> * t24)/ rch                    &amp;</div>
<div class="line"><a id="l03222" name="l03222"></a><span class="lineno"> 3222</span>                + th2- sfctmp - etanrg / rch ) / rr</div>
<div class="line"><a id="l03223" name="l03223"></a><span class="lineno"> 3223</span> </div>
<div class="line"><a id="l03224" name="l03224"></a><span class="lineno"> 3224</span>      t12b = df1 * stc(1) / (dtot * rr * rch)</div>
<div class="line"><a id="l03225" name="l03225"></a><span class="lineno"> 3225</span> </div>
<div class="line"><a id="l03226" name="l03226"></a><span class="lineno"> 3226</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03227" name="l03227"></a><span class="lineno"> 3227</span><span class="comment">! IF THE &#39;EFFECTIVE SNOW-GRND SFC TEMP&#39; IS AT OR BELOW FREEZING, NO SNOW</span></div>
<div class="line"><a id="l03228" name="l03228"></a><span class="lineno"> 3228</span><span class="comment">! MELT WILL OCCUR.  SET THE SKIN TEMP TO THIS EFFECTIVE TEMP.  REDUCE</span></div>
<div class="line"><a id="l03229" name="l03229"></a><span class="lineno"> 3229</span><span class="comment">! (BY SUBLIMINATION ) OR INCREASE (BY FROST) THE DEPTH OF THE SNOWPACK,</span></div>
<div class="line"><a id="l03230" name="l03230"></a><span class="lineno"> 3230</span><span class="comment">! DEPENDING ON SIGN OF ETP.</span></div>
<div class="line"><a id="l03231" name="l03231"></a><span class="lineno"> 3231</span><span class="comment">! UPDATE SOIL HEAT FLUX (SSOIL) USING NEW SKIN TEMPERATURE (T1)</span></div>
<div class="line"><a id="l03232" name="l03232"></a><span class="lineno"> 3232</span><span class="comment">! SINCE NO SNOWMELT, SET ACCUMULATED SNOWMELT TO ZERO, SET &#39;EFFECTIVE&#39;</span></div>
<div class="line"><a id="l03233" name="l03233"></a><span class="lineno"> 3233</span><span class="comment">! PRECIP FROM SNOWMELT TO ZERO, SET PHASE-CHANGE HEAT FLUX FROM SNOWMELT</span></div>
<div class="line"><a id="l03234" name="l03234"></a><span class="lineno"> 3234</span><span class="comment">! TO ZERO.</span></div>
<div class="line"><a id="l03235" name="l03235"></a><span class="lineno"> 3235</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03236" name="l03236"></a><span class="lineno"> 3236</span><span class="comment">! SUB-FREEZING BLOCK</span></div>
<div class="line"><a id="l03237" name="l03237"></a><span class="lineno"> 3237</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03238" name="l03238"></a><span class="lineno"> 3238</span>      t12 = (sfctmp + t12a + t12b) / denom</div>
<div class="line"><a id="l03239" name="l03239"></a><span class="lineno"> 3239</span>      <span class="keywordflow">IF</span> (t12 &lt;=  tfreez) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l03240" name="l03240"></a><span class="lineno"> 3240</span>         t1 = t12</div>
<div class="line"><a id="l03241" name="l03241"></a><span class="lineno"> 3241</span>         ssoil = df1 * (t1- stc(1)) / dtot</div>
<div class="line"><a id="l03242" name="l03242"></a><span class="lineno"> 3242</span><span class="comment">!        ESD = MAX (0.0, ESD- ETP2)</span></div>
<div class="line"><a id="l03243" name="l03243"></a><span class="lineno"> 3243</span>         esd = max(0.0, esd-esnow2)</div>
<div class="line"><a id="l03244" name="l03244"></a><span class="lineno"> 3244</span>         flx3 = 0.0</div>
<div class="line"><a id="l03245" name="l03245"></a><span class="lineno"> 3245</span>         ex = 0.0</div>
<div class="line"><a id="l03246" name="l03246"></a><span class="lineno"> 3246</span> </div>
<div class="line"><a id="l03247" name="l03247"></a><span class="lineno"> 3247</span>         snomlt = 0.0</div>
<div class="line"><a id="l03248" name="l03248"></a><span class="lineno"> 3248</span>         <span class="keywordflow">IF</span>(ua_phys) flx4 = 0.0</div>
<div class="line"><a id="l03249" name="l03249"></a><span class="lineno"> 3249</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03250" name="l03250"></a><span class="lineno"> 3250</span><span class="comment">! IF THE &#39;EFFECTIVE SNOW-GRND SFC TEMP&#39; IS ABOVE FREEZING, SNOW MELT</span></div>
<div class="line"><a id="l03251" name="l03251"></a><span class="lineno"> 3251</span><span class="comment">! WILL OCCUR.  CALL THE SNOW MELT RATE,EX AND AMT, SNOMLT.  REVISE THE</span></div>
<div class="line"><a id="l03252" name="l03252"></a><span class="lineno"> 3252</span><span class="comment">! EFFECTIVE SNOW DEPTH.  REVISE THE SKIN TEMP BECAUSE IT WOULD HAVE CHGD</span></div>
<div class="line"><a id="l03253" name="l03253"></a><span class="lineno"> 3253</span><span class="comment">! DUE TO THE LATENT HEAT RELEASED BY THE MELTING. CALC THE LATENT HEAT</span></div>
<div class="line"><a id="l03254" name="l03254"></a><span class="lineno"> 3254</span><span class="comment">! RELEASED, FLX3. SET THE EFFECTIVE PRECIP, PRCP1 TO THE SNOW MELT RATE,</span></div>
<div class="line"><a id="l03255" name="l03255"></a><span class="lineno"> 3255</span><span class="comment">! EX FOR USE IN SMFLX.  ADJUSTMENT TO T1 TO ACCOUNT FOR SNOW PATCHES.</span></div>
<div class="line"><a id="l03256" name="l03256"></a><span class="lineno"> 3256</span><span class="comment">! CALCULATE QSAT VALID AT FREEZING POINT.  NOTE THAT ESAT (SATURATION</span></div>
<div class="line"><a id="l03257" name="l03257"></a><span class="lineno"> 3257</span><span class="comment">! VAPOR PRESSURE) VALUE OF 6.11E+2 USED HERE IS THAT VALID AT FRZZING</span></div>
<div class="line"><a id="l03258" name="l03258"></a><span class="lineno"> 3258</span><span class="comment">! POINT.  NOTE THAT ETP FROM CALL PENMAN IN SFLX IS IGNORED HERE IN</span></div>
<div class="line"><a id="l03259" name="l03259"></a><span class="lineno"> 3259</span><span class="comment">! FAVOR OF BULK ETP OVER &#39;OPEN WATER&#39; AT FREEZING TEMP.</span></div>
<div class="line"><a id="l03260" name="l03260"></a><span class="lineno"> 3260</span><span class="comment">! UPDATE SOIL HEAT FLUX (S) USING NEW SKIN TEMPERATURE (T1)</span></div>
<div class="line"><a id="l03261" name="l03261"></a><span class="lineno"> 3261</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03262" name="l03262"></a><span class="lineno"> 3262</span><span class="comment">! ABOVE FREEZING BLOCK</span></div>
<div class="line"><a id="l03263" name="l03263"></a><span class="lineno"> 3263</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03264" name="l03264"></a><span class="lineno"> 3264</span>      <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l03265" name="l03265"></a><span class="lineno"> 3265</span><span class="comment">!     From V3.9 original code (commented) replaced to allow complete melting of small snow amounts</span></div>
<div class="line"><a id="l03266" name="l03266"></a><span class="lineno"> 3266</span><span class="comment">!        T1 = TFREEZ * SNCOVR ** SNOEXP + T12 * (1.0- SNCOVR ** SNOEXP)</span></div>
<div class="line"><a id="l03267" name="l03267"></a><span class="lineno"> 3267</span>         t1 = tfreez * max(0.01,sncovr ** snoexp) + t12 * (1.0- max(0.01,sncovr ** snoexp))</div>
<div class="line"><a id="l03268" name="l03268"></a><span class="lineno"> 3268</span>         beta = 1.0</div>
<div class="line"><a id="l03269" name="l03269"></a><span class="lineno"> 3269</span> </div>
<div class="line"><a id="l03270" name="l03270"></a><span class="lineno"> 3270</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03271" name="l03271"></a><span class="lineno"> 3271</span><span class="comment">! IF POTENTIAL EVAP (SUBLIMATION) GREATER THAN DEPTH OF SNOWPACK.</span></div>
<div class="line"><a id="l03272" name="l03272"></a><span class="lineno"> 3272</span><span class="comment">! BETA&lt;1</span></div>
<div class="line"><a id="l03273" name="l03273"></a><span class="lineno"> 3273</span><span class="comment">! SNOWPACK HAS SUBLIMATED AWAY, SET DEPTH TO ZERO.</span></div>
<div class="line"><a id="l03274" name="l03274"></a><span class="lineno"> 3274</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03275" name="l03275"></a><span class="lineno"> 3275</span>         ssoil = df1 * (t1- stc(1)) / dtot</div>
<div class="line"><a id="l03276" name="l03276"></a><span class="lineno"> 3276</span>         <span class="keywordflow">IF</span> (esd-esnow2 &lt;= esdmin) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l03277" name="l03277"></a><span class="lineno"> 3277</span>            esd = 0.0</div>
<div class="line"><a id="l03278" name="l03278"></a><span class="lineno"> 3278</span>            ex = 0.0</div>
<div class="line"><a id="l03279" name="l03279"></a><span class="lineno"> 3279</span>            snomlt = 0.0</div>
<div class="line"><a id="l03280" name="l03280"></a><span class="lineno"> 3280</span>            flx3 = 0.0</div>
<div class="line"><a id="l03281" name="l03281"></a><span class="lineno"> 3281</span>            <span class="keywordflow">IF</span>(ua_phys) flx4 = 0.0</div>
<div class="line"><a id="l03282" name="l03282"></a><span class="lineno"> 3282</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03283" name="l03283"></a><span class="lineno"> 3283</span><span class="comment">! SUBLIMATION LESS THAN DEPTH OF SNOWPACK</span></div>
<div class="line"><a id="l03284" name="l03284"></a><span class="lineno"> 3284</span><span class="comment">! SNOWPACK (ESD) REDUCED BY ESNOW2 (DEPTH OF SUBLIMATED SNOW)</span></div>
<div class="line"><a id="l03285" name="l03285"></a><span class="lineno"> 3285</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03286" name="l03286"></a><span class="lineno"> 3286</span>         <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l03287" name="l03287"></a><span class="lineno"> 3287</span>            esd = esd-esnow2</div>
<div class="line"><a id="l03288" name="l03288"></a><span class="lineno"> 3288</span>            etp3 = etp * lsubc</div>
<div class="line"><a id="l03289" name="l03289"></a><span class="lineno"> 3289</span>            seh = rch * (t1- th2)</div>
<div class="line"><a id="l03290" name="l03290"></a><span class="lineno"> 3290</span>            t14 = t1* t1</div>
<div class="line"><a id="l03291" name="l03291"></a><span class="lineno"> 3291</span>            t14 = t14* t14</div>
<div class="line"><a id="l03292" name="l03292"></a><span class="lineno"> 3292</span><span class="comment">!           FLX3 = FDOWN - FLX1 - FLX2 -                                 &amp;</span></div>
<div class="line"><a id="l03293" name="l03293"></a><span class="lineno"> 3293</span><span class="comment">!                  ((SNCOVR*EMISSI_S)+EMISSI*(1-SNCOVR))*SIGMA*T14 -     &amp;</span></div>
<div class="line"><a id="l03294" name="l03294"></a><span class="lineno"> 3294</span><span class="comment">!                    SSOIL - SEH - ETANRG</span></div>
<div class="line"><a id="l03295" name="l03295"></a><span class="lineno"> 3295</span>            flx3 = fdown - flx1- flx2- emissi*<a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a41b56481dda78f3181c7e40721fa79a0">sigma</a> * t14- ssoil - seh - etanrg</div>
<div class="line"><a id="l03296" name="l03296"></a><span class="lineno"> 3296</span>            <span class="keywordflow">IF</span> (flx3 &lt;= 0.0) flx3 = 0.0</div>
<div class="line"><a id="l03297" name="l03297"></a><span class="lineno"> 3297</span> </div>
<div class="line"><a id="l03298" name="l03298"></a><span class="lineno"> 3298</span>            <span class="keywordflow">IF</span>(ua_phys .AND. flx4 &gt; 0. .AND. flx3 &gt; 0.) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l03299" name="l03299"></a><span class="lineno"> 3299</span>              <span class="keywordflow">IF</span>(flx3 &gt;= flx4) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l03300" name="l03300"></a><span class="lineno"> 3300</span>                flx3 = flx3 - flx4</div>
<div class="line"><a id="l03301" name="l03301"></a><span class="lineno"> 3301</span>              <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l03302" name="l03302"></a><span class="lineno"> 3302</span>                flx4 = flx3</div>
<div class="line"><a id="l03303" name="l03303"></a><span class="lineno"> 3303</span>                flx3 = 0.</div>
<div class="line"><a id="l03304" name="l03304"></a><span class="lineno"> 3304</span><span class="keywordflow">              ENDIF</span></div>
<div class="line"><a id="l03305" name="l03305"></a><span class="lineno"> 3305</span>            <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l03306" name="l03306"></a><span class="lineno"> 3306</span>              flx4 = 0.0</div>
<div class="line"><a id="l03307" name="l03307"></a><span class="lineno"> 3307</span><span class="keywordflow">            ENDIF</span></div>
<div class="line"><a id="l03308" name="l03308"></a><span class="lineno"> 3308</span> </div>
<div class="line"><a id="l03309" name="l03309"></a><span class="lineno"> 3309</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03310" name="l03310"></a><span class="lineno"> 3310</span><span class="comment">! SNOWMELT REDUCTION DEPENDING ON SNOW COVER</span></div>
<div class="line"><a id="l03311" name="l03311"></a><span class="lineno"> 3311</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03312" name="l03312"></a><span class="lineno"> 3312</span>            ex = flx3*0.001/ <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a81f1f2ceb78e6b6a447b394803dee3c7">lsubf</a></div>
<div class="line"><a id="l03313" name="l03313"></a><span class="lineno"> 3313</span> </div>
<div class="line"><a id="l03314" name="l03314"></a><span class="lineno"> 3314</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03315" name="l03315"></a><span class="lineno"> 3315</span><span class="comment">! ESDMIN REPRESENTS A SNOWPACK DEPTH THRESHOLD VALUE BELOW WHICH WE</span></div>
<div class="line"><a id="l03316" name="l03316"></a><span class="lineno"> 3316</span><span class="comment">! CHOOSE NOT TO RETAIN ANY SNOWPACK, AND INSTEAD INCLUDE IT IN SNOWMELT.</span></div>
<div class="line"><a id="l03317" name="l03317"></a><span class="lineno"> 3317</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03318" name="l03318"></a><span class="lineno"> 3318</span>            snomlt = ex * dt</div>
<div class="line"><a id="l03319" name="l03319"></a><span class="lineno"> 3319</span>            <span class="keywordflow">IF</span> (esd- snomlt &gt;=  esdmin) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l03320" name="l03320"></a><span class="lineno"> 3320</span>               esd = esd- snomlt</div>
<div class="line"><a id="l03321" name="l03321"></a><span class="lineno"> 3321</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03322" name="l03322"></a><span class="lineno"> 3322</span><span class="comment">! SNOWMELT EXCEEDS SNOW DEPTH</span></div>
<div class="line"><a id="l03323" name="l03323"></a><span class="lineno"> 3323</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03324" name="l03324"></a><span class="lineno"> 3324</span>            <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l03325" name="l03325"></a><span class="lineno"> 3325</span>               ex = esd / dt</div>
<div class="line"><a id="l03326" name="l03326"></a><span class="lineno"> 3326</span>               flx3 = ex *1000.0* <a class="code hl_variable" href="namespacemodule__sf__noahlsm.html#a81f1f2ceb78e6b6a447b394803dee3c7">lsubf</a></div>
<div class="line"><a id="l03327" name="l03327"></a><span class="lineno"> 3327</span>               snomlt = esd</div>
<div class="line"><a id="l03328" name="l03328"></a><span class="lineno"> 3328</span> </div>
<div class="line"><a id="l03329" name="l03329"></a><span class="lineno"> 3329</span>               esd = 0.0</div>
<div class="line"><a id="l03330" name="l03330"></a><span class="lineno"> 3330</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03331" name="l03331"></a><span class="lineno"> 3331</span><span class="comment">! END OF &#39;ESD .LE. ETP2&#39; IF-BLOCK</span></div>
<div class="line"><a id="l03332" name="l03332"></a><span class="lineno"> 3332</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03333" name="l03333"></a><span class="lineno"> 3333</span><span class="keywordflow">            END IF</span></div>
<div class="line"><a id="l03334" name="l03334"></a><span class="lineno"> 3334</span><span class="keywordflow">         END IF</span></div>
<div class="line"><a id="l03335" name="l03335"></a><span class="lineno"> 3335</span> </div>
<div class="line"><a id="l03336" name="l03336"></a><span class="lineno"> 3336</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03337" name="l03337"></a><span class="lineno"> 3337</span><span class="comment">! END OF &#39;T12 .LE. TFREEZ&#39; IF-BLOCK</span></div>
<div class="line"><a id="l03338" name="l03338"></a><span class="lineno"> 3338</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03339" name="l03339"></a><span class="lineno"> 3339</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03340" name="l03340"></a><span class="lineno"> 3340</span><span class="comment">! IF NON-GLACIAL LAND, ADD SNOWMELT RATE (EX) TO PRECIP RATE TO BE USED</span></div>
<div class="line"><a id="l03341" name="l03341"></a><span class="lineno"> 3341</span><span class="comment">! IN SUBROUTINE SMFLX (SOIL MOISTURE EVOLUTION) VIA INFILTRATION.</span></div>
<div class="line"><a id="l03342" name="l03342"></a><span class="lineno"> 3342</span><span class="comment">!</span></div>
<div class="line"><a id="l03343" name="l03343"></a><span class="lineno"> 3343</span><span class="comment">! RUNOFF/BASEFLOW LATER NEAR THE END OF SFLX (AFTER RETURN FROM CALL TO</span></div>
<div class="line"><a id="l03344" name="l03344"></a><span class="lineno"> 3344</span><span class="comment">! SUBROUTINE SNOPAC)</span></div>
<div class="line"><a id="l03345" name="l03345"></a><span class="lineno"> 3345</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03346" name="l03346"></a><span class="lineno"> 3346</span>         prcp1 = prcp1+ ex</div>
<div class="line"><a id="l03347" name="l03347"></a><span class="lineno"> 3347</span> </div>
<div class="line"><a id="l03348" name="l03348"></a><span class="lineno"> 3348</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03349" name="l03349"></a><span class="lineno"> 3349</span><span class="comment">! SET THE EFFECTIVE POTNL EVAPOTRANSP (ETP1) TO ZERO SINCE THIS IS SNOW</span></div>
<div class="line"><a id="l03350" name="l03350"></a><span class="lineno"> 3350</span><span class="comment">! CASE, SO SURFACE EVAP NOT CALCULATED FROM EDIR, EC, OR ETT IN SMFLX</span></div>
<div class="line"><a id="l03351" name="l03351"></a><span class="lineno"> 3351</span><span class="comment">! (BELOW).</span></div>
<div class="line"><a id="l03352" name="l03352"></a><span class="lineno"> 3352</span><span class="comment">! SMFLX RETURNS UPDATED SOIL MOISTURE VALUES FOR NON-GLACIAL LAND.</span></div>
<div class="line"><a id="l03353" name="l03353"></a><span class="lineno"> 3353</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03354" name="l03354"></a><span class="lineno"> 3354</span><span class="keywordflow">      END IF</span></div>
<div class="line"><a id="l03355" name="l03355"></a><span class="lineno"> 3355</span>      <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a58888da8d933fe6e55e825b83159658b">smflx</a> (smc,nsoil,cmc,dt,prcp1,zsoil,                      &amp;</div>
<div class="line"><a id="l03356" name="l03356"></a><span class="lineno"> 3356</span>                   sh2o,slope,kdt,frzfact,                           &amp;</div>
<div class="line"><a id="l03357" name="l03357"></a><span class="lineno"> 3357</span>                   smcmax,bexp,smcwlt,dksat,dwsat,                   &amp;</div>
<div class="line"><a id="l03358" name="l03358"></a><span class="lineno"> 3358</span>                   shdfac,cmcmax,                                    &amp;</div>
<div class="line"><a id="l03359" name="l03359"></a><span class="lineno"> 3359</span>                   runoff1,runoff2,runoff3,                          &amp;</div>
<div class="line"><a id="l03360" name="l03360"></a><span class="lineno"> 3360</span>                   edir1,ec1,et1,                                    &amp;</div>
<div class="line"><a id="l03361" name="l03361"></a><span class="lineno"> 3361</span>                   drip, sfhead1rt,infxs1rt)</div>
<div class="line"><a id="l03362" name="l03362"></a><span class="lineno"> 3362</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03363" name="l03363"></a><span class="lineno"> 3363</span><span class="comment">! BEFORE CALL SHFLX IN THIS SNOWPACK CASE, SET ZZ1 AND YY ARGUMENTS TO</span></div>
<div class="line"><a id="l03364" name="l03364"></a><span class="lineno"> 3364</span><span class="comment">! SPECIAL VALUES THAT ENSURE THAT GROUND HEAT FLUX CALCULATED IN SHFLX</span></div>
<div class="line"><a id="l03365" name="l03365"></a><span class="lineno"> 3365</span><span class="comment">! MATCHES THAT ALREADY COMPUTER FOR BELOW THE SNOWPACK, THUS THE SFC</span></div>
<div class="line"><a id="l03366" name="l03366"></a><span class="lineno"> 3366</span><span class="comment">! HEAT FLUX TO BE COMPUTED IN SHFLX WILL EFFECTIVELY BE THE FLUX AT THE</span></div>
<div class="line"><a id="l03367" name="l03367"></a><span class="lineno"> 3367</span><span class="comment">! SNOW TOP SURFACE.  T11 IS A DUMMY ARGUEMENT SO WE WILL NOT USE THE</span></div>
<div class="line"><a id="l03368" name="l03368"></a><span class="lineno"> 3368</span><span class="comment">! SKIN TEMP VALUE AS REVISED BY SHFLX.</span></div>
<div class="line"><a id="l03369" name="l03369"></a><span class="lineno"> 3369</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03370" name="l03370"></a><span class="lineno"> 3370</span>      zz1 = 1.0</div>
<div class="line"><a id="l03371" name="l03371"></a><span class="lineno"> 3371</span>      yy = stc(1) -0.5* ssoil * zsoil(1)* zz1/ df1</div>
<div class="line"><a id="l03372" name="l03372"></a><span class="lineno"> 3372</span> </div>
<div class="line"><a id="l03373" name="l03373"></a><span class="lineno"> 3373</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03374" name="l03374"></a><span class="lineno"> 3374</span><span class="comment">! SHFLX WILL CALC/UPDATE THE SOIL TEMPS.  NOTE:  THE SUB-SFC HEAT FLUX</span></div>
<div class="line"><a id="l03375" name="l03375"></a><span class="lineno"> 3375</span><span class="comment">! (SSOIL1) AND THE SKIN TEMP (T11) OUTPUT FROM THIS SHFLX CALL ARE NOT</span></div>
<div class="line"><a id="l03376" name="l03376"></a><span class="lineno"> 3376</span><span class="comment">! USED  IN ANY SUBSEQUENT CALCULATIONS. RATHER, THEY ARE DUMMY VARIABLES</span></div>
<div class="line"><a id="l03377" name="l03377"></a><span class="lineno"> 3377</span><span class="comment">! HERE IN THE SNOPAC CASE, SINCE THE SKIN TEMP AND SUB-SFC HEAT FLUX ARE</span></div>
<div class="line"><a id="l03378" name="l03378"></a><span class="lineno"> 3378</span><span class="comment">! UPDATED INSTEAD NEAR THE BEGINNING OF THE CALL TO SNOPAC.</span></div>
<div class="line"><a id="l03379" name="l03379"></a><span class="lineno"> 3379</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03380" name="l03380"></a><span class="lineno"> 3380</span>      t11 = t1</div>
<div class="line"><a id="l03381" name="l03381"></a><span class="lineno"> 3381</span>      <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#aaee442f9d981b7c296c5932352365351">shflx</a> (ssoil1,stc,smc,smcmax,nsoil,t11,dt,yy,zz1,zsoil,     &amp;</div>
<div class="line"><a id="l03382" name="l03382"></a><span class="lineno"> 3382</span>                   tbot,zbot,smcwlt,psisat,sh2o,bexp,f1,df1,           &amp;</div>
<div class="line"><a id="l03383" name="l03383"></a><span class="lineno"> 3383</span>                   quartz,csoil,vegtyp,isurban,soiltyp,opt_thcnd       &amp;</div>
<div class="line"><a id="l03384" name="l03384"></a><span class="lineno"> 3384</span>                  ,hcpct_fasdas                                        ) <span class="comment">!fasdas</span></div>
<div class="line"><a id="l03385" name="l03385"></a><span class="lineno"> 3385</span> </div>
<div class="line"><a id="l03386" name="l03386"></a><span class="lineno"> 3386</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03387" name="l03387"></a><span class="lineno"> 3387</span><span class="comment">! SNOW DEPTH AND DENSITY ADJUSTMENT BASED ON SNOW COMPACTION.  YY IS</span></div>
<div class="line"><a id="l03388" name="l03388"></a><span class="lineno"> 3388</span><span class="comment">! ASSUMED TO BE THE SOIL TEMPERTURE AT THE TOP OF THE SOIL COLUMN.</span></div>
<div class="line"><a id="l03389" name="l03389"></a><span class="lineno"> 3389</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03390" name="l03390"></a><span class="lineno"> 3390</span>      <span class="comment">! LAND</span></div>
<div class="line"><a id="l03391" name="l03391"></a><span class="lineno"> 3391</span>      <span class="keywordflow">IF</span> (esd &gt;  0.) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l03392" name="l03392"></a><span class="lineno"> 3392</span>         <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ae6d35ff66196a3ab369a3e87149ddcdc">snowpack</a> (esd,dt,snowh,sndens,t1,yy,snomlt,ua_phys)</div>
<div class="line"><a id="l03393" name="l03393"></a><span class="lineno"> 3393</span>      <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l03394" name="l03394"></a><span class="lineno"> 3394</span>         esd = 0.</div>
<div class="line"><a id="l03395" name="l03395"></a><span class="lineno"> 3395</span>         snowh = 0.</div>
<div class="line"><a id="l03396" name="l03396"></a><span class="lineno"> 3396</span>         sndens = 0.</div>
<div class="line"><a id="l03397" name="l03397"></a><span class="lineno"> 3397</span>         sncond = 1.</div>
<div class="line"><a id="l03398" name="l03398"></a><span class="lineno"> 3398</span>         sncovr = 0.</div>
<div class="line"><a id="l03399" name="l03399"></a><span class="lineno"> 3399</span><span class="keywordflow">      END IF</span></div>
<div class="line"><a id="l03400" name="l03400"></a><span class="lineno"> 3400</span> </div>
<div class="line"><a id="l03401" name="l03401"></a><span class="lineno"> 3401</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03402" name="l03402"></a><span class="lineno"> 3402</span>  <span class="keyword">END SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ae27e8294cc66ecbb23f2a9d239a3c3d7">snopac</a></div>
<div class="line"><a id="l03403" name="l03403"></a><span class="lineno"> 3403</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03404" name="l03404"></a><span class="lineno"> 3404</span> </div>
<div class="line"><a id="l03405" name="l03405"></a><span class="lineno"> 3405</span> </div>
<div class="line"><a id="l03406" name="l03406"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#ae6d35ff66196a3ab369a3e87149ddcdc"> 3406</a></span>      <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ae6d35ff66196a3ab369a3e87149ddcdc">snowpack</a> (ESD,DTSEC,SNOWH,SNDENS,TSNOW,TSOIL,SNOMLT,UA_PHYS)</div>
<div class="line"><a id="l03407" name="l03407"></a><span class="lineno"> 3407</span> </div>
<div class="line"><a id="l03408" name="l03408"></a><span class="lineno"> 3408</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03409" name="l03409"></a><span class="lineno"> 3409</span><span class="comment">! SUBROUTINE SNOWPACK</span></div>
<div class="line"><a id="l03410" name="l03410"></a><span class="lineno"> 3410</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03411" name="l03411"></a><span class="lineno"> 3411</span><span class="comment">! CALCULATE COMPACTION OF SNOWPACK UNDER CONDITIONS OF INCREASING SNOW</span></div>
<div class="line"><a id="l03412" name="l03412"></a><span class="lineno"> 3412</span><span class="comment">! DENSITY, AS OBTAINED FROM AN APPROXIMATE SOLUTION OF E. ANDERSON&#39;S</span></div>
<div class="line"><a id="l03413" name="l03413"></a><span class="lineno"> 3413</span><span class="comment">! DIFFERENTIAL EQUATION (3.29), NOAA TECHNICAL REPORT NWS 19, BY VICTOR</span></div>
<div class="line"><a id="l03414" name="l03414"></a><span class="lineno"> 3414</span><span class="comment">! KOREN, 03/25/95.</span></div>
<div class="line"><a id="l03415" name="l03415"></a><span class="lineno"> 3415</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03416" name="l03416"></a><span class="lineno"> 3416</span><span class="comment">! ESD     WATER EQUIVALENT OF SNOW (M)</span></div>
<div class="line"><a id="l03417" name="l03417"></a><span class="lineno"> 3417</span><span class="comment">! DTSEC   TIME STEP (SEC)</span></div>
<div class="line"><a id="l03418" name="l03418"></a><span class="lineno"> 3418</span><span class="comment">! SNOWH   SNOW DEPTH (M)</span></div>
<div class="line"><a id="l03419" name="l03419"></a><span class="lineno"> 3419</span><span class="comment">! SNDENS  SNOW DENSITY (G/CM3=DIMENSIONLESS FRACTION OF H2O DENSITY)</span></div>
<div class="line"><a id="l03420" name="l03420"></a><span class="lineno"> 3420</span><span class="comment">! TSNOW   SNOW SURFACE TEMPERATURE (K)</span></div>
<div class="line"><a id="l03421" name="l03421"></a><span class="lineno"> 3421</span><span class="comment">! TSOIL   SOIL SURFACE TEMPERATURE (K)</span></div>
<div class="line"><a id="l03422" name="l03422"></a><span class="lineno"> 3422</span> </div>
<div class="line"><a id="l03423" name="l03423"></a><span class="lineno"> 3423</span><span class="comment">! SUBROUTINE WILL RETURN NEW VALUES OF SNOWH AND SNDENS</span></div>
<div class="line"><a id="l03424" name="l03424"></a><span class="lineno"> 3424</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03425" name="l03425"></a><span class="lineno"> 3425</span>      <span class="keywordtype">IMPLICIT NONE</span></div>
<div class="line"><a id="l03426" name="l03426"></a><span class="lineno"> 3426</span> </div>
<div class="line"><a id="l03427" name="l03427"></a><span class="lineno"> 3427</span>      <span class="keywordtype">INTEGER</span>                :: IPOL, J</div>
<div class="line"><a id="l03428" name="l03428"></a><span class="lineno"> 3428</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(IN)</span>       :: ESD, DTSEC,TSNOW,TSOIL</div>
<div class="line"><a id="l03429" name="l03429"></a><span class="lineno"> 3429</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(INOUT)</span>    :: SNOWH, SNDENS</div>
<div class="line"><a id="l03430" name="l03430"></a><span class="lineno"> 3430</span><span class="keywordtype">      REAL</span>                   :: BFAC,DSX,DTHR,DW,SNOWHC,PEXP,           &amp;</div>
<div class="line"><a id="l03431" name="l03431"></a><span class="lineno"> 3431</span>                                TAVGC,TSNOWC,TSOILC,ESDC,ESDCX</div>
<div class="line"><a id="l03432" name="l03432"></a><span class="lineno"> 3432</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">PARAMETER</span>        :: C1 = 0.01, <a class="code hl_function" href="params_8m.html#a042889eb4a4c0a313ba885e8f173380d">c2</a> = 21.0, <a class="code hl_function" href="params_8m.html#a86bdec0d61a48a8ca4da1674058837cc">g</a> = 9.81,         &amp;</div>
<div class="line"><a id="l03433" name="l03433"></a><span class="lineno"> 3433</span>                                kn = 4000.0</div>
<div class="line"><a id="l03434" name="l03434"></a><span class="lineno"> 3434</span>      <span class="keywordtype">LOGICAL</span>, <span class="keywordtype">INTENT(IN)</span>    :: UA_PHYS  <span class="comment">! UA: flag for UA option</span></div>
<div class="line"><a id="l03435" name="l03435"></a><span class="lineno"> 3435</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(IN)</span>       :: SNOMLT   <span class="comment">! UA: snow melt [m]</span></div>
<div class="line"><a id="l03436" name="l03436"></a><span class="lineno"> 3436</span><span class="keywordtype">      REAL</span>                   :: SNOMLTC  <span class="comment">! UA: snow melt [cm]</span></div>
<div class="line"><a id="l03437" name="l03437"></a><span class="lineno"> 3437</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03438" name="l03438"></a><span class="lineno"> 3438</span><span class="comment">! CONVERSION INTO SIMULATION UNITS</span></div>
<div class="line"><a id="l03439" name="l03439"></a><span class="lineno"> 3439</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03440" name="l03440"></a><span class="lineno"> 3440</span>      snowhc = snowh *100.</div>
<div class="line"><a id="l03441" name="l03441"></a><span class="lineno"> 3441</span>      esdc = esd *100.</div>
<div class="line"><a id="l03442" name="l03442"></a><span class="lineno"> 3442</span>      <span class="keywordflow">IF</span>(ua_phys) snomltc = snomlt *100.</div>
<div class="line"><a id="l03443" name="l03443"></a><span class="lineno"> 3443</span>      dthr = dtsec /3600.</div>
<div class="line"><a id="l03444" name="l03444"></a><span class="lineno"> 3444</span>      tsnowc = tsnow -273.15</div>
<div class="line"><a id="l03445" name="l03445"></a><span class="lineno"> 3445</span>      tsoilc = tsoil -273.15</div>
<div class="line"><a id="l03446" name="l03446"></a><span class="lineno"> 3446</span> </div>
<div class="line"><a id="l03447" name="l03447"></a><span class="lineno"> 3447</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03448" name="l03448"></a><span class="lineno"> 3448</span><span class="comment">! CALCULATING OF AVERAGE TEMPERATURE OF SNOW PACK</span></div>
<div class="line"><a id="l03449" name="l03449"></a><span class="lineno"> 3449</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03450" name="l03450"></a><span class="lineno"> 3450</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03451" name="l03451"></a><span class="lineno"> 3451</span><span class="comment">! CALCULATING OF SNOW DEPTH AND DENSITY AS A RESULT OF COMPACTION</span></div>
<div class="line"><a id="l03452" name="l03452"></a><span class="lineno"> 3452</span><span class="comment">!  SNDENS=DS0*(EXP(BFAC*ESD)-1.)/(BFAC*ESD)</span></div>
<div class="line"><a id="l03453" name="l03453"></a><span class="lineno"> 3453</span><span class="comment">!  BFAC=DTHR*C1*EXP(0.08*TAVGC-C2*DS0)</span></div>
<div class="line"><a id="l03454" name="l03454"></a><span class="lineno"> 3454</span><span class="comment">! NOTE: BFAC*ESD IN SNDENS EQN ABOVE HAS TO BE CAREFULLY TREATED</span></div>
<div class="line"><a id="l03455" name="l03455"></a><span class="lineno"> 3455</span><span class="comment">! NUMERICALLY BELOW:</span></div>
<div class="line"><a id="l03456" name="l03456"></a><span class="lineno"> 3456</span><span class="comment">!   C1 IS THE FRACTIONAL INCREASE IN DENSITY (1/(CM*HR))</span></div>
<div class="line"><a id="l03457" name="l03457"></a><span class="lineno"> 3457</span><span class="comment">!   C2 IS A CONSTANT (CM3/G) KOJIMA ESTIMATED AS 21 CMS/G</span></div>
<div class="line"><a id="l03458" name="l03458"></a><span class="lineno"> 3458</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03459" name="l03459"></a><span class="lineno"> 3459</span>      tavgc = 0.5* (tsnowc + tsoilc)</div>
<div class="line"><a id="l03460" name="l03460"></a><span class="lineno"> 3460</span>      <span class="keywordflow">IF</span> (esdc &gt;  1.e-2) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l03461" name="l03461"></a><span class="lineno"> 3461</span>         esdcx = esdc</div>
<div class="line"><a id="l03462" name="l03462"></a><span class="lineno"> 3462</span>      <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l03463" name="l03463"></a><span class="lineno"> 3463</span>         esdcx = 1.e-2</div>
<div class="line"><a id="l03464" name="l03464"></a><span class="lineno"> 3464</span><span class="keywordflow">      END IF</span></div>
<div class="line"><a id="l03465" name="l03465"></a><span class="lineno"> 3465</span> </div>
<div class="line"><a id="l03466" name="l03466"></a><span class="lineno"> 3466</span><span class="comment">!      DSX = SNDENS*((DEXP(BFAC*ESDC)-1.)/(BFAC*ESDC))</span></div>
<div class="line"><a id="l03467" name="l03467"></a><span class="lineno"> 3467</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03468" name="l03468"></a><span class="lineno"> 3468</span><span class="comment">! THE FUNCTION OF THE FORM (e**x-1)/x EMBEDDED IN ABOVE EXPRESSION</span></div>
<div class="line"><a id="l03469" name="l03469"></a><span class="lineno"> 3469</span><span class="comment">! FOR DSX WAS CAUSING NUMERICAL DIFFICULTIES WHEN THE DENOMINATOR &quot;x&quot;</span></div>
<div class="line"><a id="l03470" name="l03470"></a><span class="lineno"> 3470</span><span class="comment">! (I.E. BFAC*ESDC) BECAME ZERO OR APPROACHED ZERO (DESPITE THE FACT THAT</span></div>
<div class="line"><a id="l03471" name="l03471"></a><span class="lineno"> 3471</span><span class="comment">! THE ANALYTICAL FUNCTION (e**x-1)/x HAS A WELL DEFINED LIMIT AS</span></div>
<div class="line"><a id="l03472" name="l03472"></a><span class="lineno"> 3472</span><span class="comment">! &quot;x&quot; APPROACHES ZERO), HENCE BELOW WE REPLACE THE (e**x-1)/x</span></div>
<div class="line"><a id="l03473" name="l03473"></a><span class="lineno"> 3473</span><span class="comment">! EXPRESSION WITH AN EQUIVALENT, NUMERICALLY WELL-BEHAVED</span></div>
<div class="line"><a id="l03474" name="l03474"></a><span class="lineno"> 3474</span><span class="comment">! POLYNOMIAL EXPANSION.</span></div>
<div class="line"><a id="l03475" name="l03475"></a><span class="lineno"> 3475</span> </div>
<div class="line"><a id="l03476" name="l03476"></a><span class="lineno"> 3476</span><span class="comment">! NUMBER OF TERMS OF POLYNOMIAL EXPANSION, AND HENCE ITS ACCURACY,</span></div>
<div class="line"><a id="l03477" name="l03477"></a><span class="lineno"> 3477</span><span class="comment">! IS GOVERNED BY ITERATION LIMIT &quot;IPOL&quot;.</span></div>
<div class="line"><a id="l03478" name="l03478"></a><span class="lineno"> 3478</span><span class="comment">!      IPOL GREATER THAN 9 ONLY MAKES A DIFFERENCE ON DOUBLE</span></div>
<div class="line"><a id="l03479" name="l03479"></a><span class="lineno"> 3479</span><span class="comment">!            PRECISION (RELATIVE ERRORS GIVEN IN PERCENT %).</span></div>
<div class="line"><a id="l03480" name="l03480"></a><span class="lineno"> 3480</span><span class="comment">!       IPOL=9, FOR REL.ERROR &lt;~ 1.6 E-6 % (8 SIGNIFICANT DIGITS)</span></div>
<div class="line"><a id="l03481" name="l03481"></a><span class="lineno"> 3481</span><span class="comment">!       IPOL=8, FOR REL.ERROR &lt;~ 1.8 E-5 % (7 SIGNIFICANT DIGITS)</span></div>
<div class="line"><a id="l03482" name="l03482"></a><span class="lineno"> 3482</span><span class="comment">!       IPOL=7, FOR REL.ERROR &lt;~ 1.8 E-4 % ...</span></div>
<div class="line"><a id="l03483" name="l03483"></a><span class="lineno"> 3483</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03484" name="l03484"></a><span class="lineno"> 3484</span>      bfac = dthr * c1* exp(0.08* tavgc - <a class="code hl_function" href="params_8m.html#a042889eb4a4c0a313ba885e8f173380d">c2</a>* sndens)</div>
<div class="line"><a id="l03485" name="l03485"></a><span class="lineno"> 3485</span>      ipol = 4</div>
<div class="line"><a id="l03486" name="l03486"></a><span class="lineno"> 3486</span>      pexp = 0.</div>
<div class="line"><a id="l03487" name="l03487"></a><span class="lineno"> 3487</span><span class="comment">!        PEXP = (1. + PEXP)*BFAC*ESDC/REAL(J+1)</span></div>
<div class="line"><a id="l03488" name="l03488"></a><span class="lineno"> 3488</span>      <span class="keywordflow">DO</span> j = ipol,1, -1</div>
<div class="line"><a id="l03489" name="l03489"></a><span class="lineno"> 3489</span>         pexp = (1. + pexp)* bfac * esdcx / <a class="code hl_typedef" href="mpas__ocn__okubo__weiss__eigenvalues_8c.html#a11d147c64891830c9e79b3315b1b2e21">real</a>(j +1)</div>
<div class="line"><a id="l03490" name="l03490"></a><span class="lineno"> 3490</span><span class="keywordflow">      END DO</span></div>
<div class="line"><a id="l03491" name="l03491"></a><span class="lineno"> 3491</span> </div>
<div class="line"><a id="l03492" name="l03492"></a><span class="lineno"> 3492</span>      pexp = pexp + 1.</div>
<div class="line"><a id="l03493" name="l03493"></a><span class="lineno"> 3493</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03494" name="l03494"></a><span class="lineno"> 3494</span><span class="comment">! ABOVE LINE ENDS POLYNOMIAL SUBSTITUTION</span></div>
<div class="line"><a id="l03495" name="l03495"></a><span class="lineno"> 3495</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03496" name="l03496"></a><span class="lineno"> 3496</span><span class="comment">!     END OF KOREAN FORMULATION</span></div>
<div class="line"><a id="l03497" name="l03497"></a><span class="lineno"> 3497</span> </div>
<div class="line"><a id="l03498" name="l03498"></a><span class="lineno"> 3498</span><span class="comment">!     BASE FORMULATION (COGLEY ET AL., 1990)</span></div>
<div class="line"><a id="l03499" name="l03499"></a><span class="lineno"> 3499</span><span class="comment">!     CONVERT DENSITY FROM G/CM3 TO KG/M3</span></div>
<div class="line"><a id="l03500" name="l03500"></a><span class="lineno"> 3500</span><span class="comment">!       DSM=SNDENS*1000.0</span></div>
<div class="line"><a id="l03501" name="l03501"></a><span class="lineno"> 3501</span> </div>
<div class="line"><a id="l03502" name="l03502"></a><span class="lineno"> 3502</span><span class="comment">!       DSX=DSM+DTSEC*0.5*DSM*G*ESD/</span></div>
<div class="line"><a id="l03503" name="l03503"></a><span class="lineno"> 3503</span><span class="comment">!    &amp;      (1E7*EXP(-0.02*DSM+KN/(TAVGC+273.16)-14.643))</span></div>
<div class="line"><a id="l03504" name="l03504"></a><span class="lineno"> 3504</span> </div>
<div class="line"><a id="l03505" name="l03505"></a><span class="lineno"> 3505</span><span class="comment">!  &amp;   CONVERT DENSITY FROM KG/M3 TO G/CM3</span></div>
<div class="line"><a id="l03506" name="l03506"></a><span class="lineno"> 3506</span><span class="comment">!       DSX=DSX/1000.0</span></div>
<div class="line"><a id="l03507" name="l03507"></a><span class="lineno"> 3507</span> </div>
<div class="line"><a id="l03508" name="l03508"></a><span class="lineno"> 3508</span><span class="comment">!     END OF COGLEY ET AL. FORMULATION</span></div>
<div class="line"><a id="l03509" name="l03509"></a><span class="lineno"> 3509</span> </div>
<div class="line"><a id="l03510" name="l03510"></a><span class="lineno"> 3510</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03511" name="l03511"></a><span class="lineno"> 3511</span><span class="comment">! SET UPPER/LOWER LIMIT ON SNOW DENSITY</span></div>
<div class="line"><a id="l03512" name="l03512"></a><span class="lineno"> 3512</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03513" name="l03513"></a><span class="lineno"> 3513</span>      dsx = sndens * (pexp)</div>
<div class="line"><a id="l03514" name="l03514"></a><span class="lineno"> 3514</span>      <span class="keywordflow">IF</span> (dsx &gt; 0.40) dsx = 0.40</div>
<div class="line"><a id="l03515" name="l03515"></a><span class="lineno"> 3515</span>      <span class="keywordflow">IF</span> (dsx &lt; 0.05) dsx = 0.05</div>
<div class="line"><a id="l03516" name="l03516"></a><span class="lineno"> 3516</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03517" name="l03517"></a><span class="lineno"> 3517</span><span class="comment">! UPDATE OF SNOW DEPTH AND DENSITY DEPENDING ON LIQUID WATER DURING</span></div>
<div class="line"><a id="l03518" name="l03518"></a><span class="lineno"> 3518</span><span class="comment">! SNOWMELT.  ASSUMED THAT 13% OF LIQUID WATER CAN BE STORED IN SNOW PER</span></div>
<div class="line"><a id="l03519" name="l03519"></a><span class="lineno"> 3519</span><span class="comment">! DAY DURING SNOWMELT TILL SNOW DENSITY 0.40.</span></div>
<div class="line"><a id="l03520" name="l03520"></a><span class="lineno"> 3520</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03521" name="l03521"></a><span class="lineno"> 3521</span>      sndens = dsx</div>
<div class="line"><a id="l03522" name="l03522"></a><span class="lineno"> 3522</span>      <span class="keywordflow">IF</span> (tsnowc &gt;=  0.) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l03523" name="l03523"></a><span class="lineno"> 3523</span>         dw = 0.13* dthr /24.</div>
<div class="line"><a id="l03524" name="l03524"></a><span class="lineno"> 3524</span>         <span class="keywordflow">IF</span> ( ua_phys .AND. tsoilc &gt;= 0.) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l03525" name="l03525"></a><span class="lineno"> 3525</span>             dw = min(dw, 0.13*snomltc/(esdcx+0.13*snomltc))</div>
<div class="line"><a id="l03526" name="l03526"></a><span class="lineno"> 3526</span><span class="keywordflow">         ENDIF</span></div>
<div class="line"><a id="l03527" name="l03527"></a><span class="lineno"> 3527</span>         sndens = sndens * (1. - dw) + dw</div>
<div class="line"><a id="l03528" name="l03528"></a><span class="lineno"> 3528</span>         <span class="keywordflow">IF</span> (sndens &gt;=  0.40) sndens = 0.40</div>
<div class="line"><a id="l03529" name="l03529"></a><span class="lineno"> 3529</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03530" name="l03530"></a><span class="lineno"> 3530</span><span class="comment">! CALCULATE SNOW DEPTH (CM) FROM SNOW WATER EQUIVALENT AND SNOW DENSITY.</span></div>
<div class="line"><a id="l03531" name="l03531"></a><span class="lineno"> 3531</span><span class="comment">! CHANGE SNOW DEPTH UNITS TO METERS</span></div>
<div class="line"><a id="l03532" name="l03532"></a><span class="lineno"> 3532</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03533" name="l03533"></a><span class="lineno"> 3533</span><span class="keywordflow">      END IF</span></div>
<div class="line"><a id="l03534" name="l03534"></a><span class="lineno"> 3534</span>      snowhc = esdc / sndens</div>
<div class="line"><a id="l03535" name="l03535"></a><span class="lineno"> 3535</span>      snowh = snowhc *0.01</div>
<div class="line"><a id="l03536" name="l03536"></a><span class="lineno"> 3536</span> </div>
<div class="line"><a id="l03537" name="l03537"></a><span class="lineno"> 3537</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03538" name="l03538"></a><span class="lineno"> 3538</span>  <span class="keyword">END SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ae6d35ff66196a3ab369a3e87149ddcdc">snowpack</a></div>
<div class="line"><a id="l03539" name="l03539"></a><span class="lineno"> 3539</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03540" name="l03540"></a><span class="lineno"> 3540</span> </div>
<div class="line"><a id="l03541" name="l03541"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#ab3693cb1c40b1bd7b4db5e96337f6eef"> 3541</a></span>      <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ab3693cb1c40b1bd7b4db5e96337f6eef">snowz0</a> (SNCOVR,Z0, Z0BRD, SNOWH,FBUR,FGSN,SHDMAX,UA_PHYS)</div>
<div class="line"><a id="l03542" name="l03542"></a><span class="lineno"> 3542</span> </div>
<div class="line"><a id="l03543" name="l03543"></a><span class="lineno"> 3543</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03544" name="l03544"></a><span class="lineno"> 3544</span><span class="comment">! SUBROUTINE SNOWZ0</span></div>
<div class="line"><a id="l03545" name="l03545"></a><span class="lineno"> 3545</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03546" name="l03546"></a><span class="lineno"> 3546</span><span class="comment">! CALCULATE TOTAL ROUGHNESS LENGTH OVER SNOW</span></div>
<div class="line"><a id="l03547" name="l03547"></a><span class="lineno"> 3547</span><span class="comment">! SNCOVR  FRACTIONAL SNOW COVER</span></div>
<div class="line"><a id="l03548" name="l03548"></a><span class="lineno"> 3548</span><span class="comment">! Z0      ROUGHNESS LENGTH (m)</span></div>
<div class="line"><a id="l03549" name="l03549"></a><span class="lineno"> 3549</span><span class="comment">! Z0S     SNOW ROUGHNESS LENGTH:=0.001 (m)</span></div>
<div class="line"><a id="l03550" name="l03550"></a><span class="lineno"> 3550</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03551" name="l03551"></a><span class="lineno"> 3551</span>      <span class="keywordtype">IMPLICIT NONE</span></div>
<div class="line"><a id="l03552" name="l03552"></a><span class="lineno"> 3552</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(IN)</span>        :: SNCOVR, Z0BRD</div>
<div class="line"><a id="l03553" name="l03553"></a><span class="lineno"> 3553</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(OUT)</span>       :: Z0</div>
<div class="line"><a id="l03554" name="l03554"></a><span class="lineno"> 3554</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">PARAMETER</span>         :: Z0S=0.001</div>
<div class="line"><a id="l03555" name="l03555"></a><span class="lineno"> 3555</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(IN)</span>        :: SNOWH</div>
<div class="line"><a id="l03556" name="l03556"></a><span class="lineno"> 3556</span><span class="keywordtype">      REAL</span>                    :: BURIAL</div>
<div class="line"><a id="l03557" name="l03557"></a><span class="lineno"> 3557</span><span class="keywordtype">      REAL</span>                    :: Z0EFF</div>
<div class="line"><a id="l03558" name="l03558"></a><span class="lineno"> 3558</span>      <span class="keywordtype">LOGICAL</span>, <span class="keywordtype">INTENT(IN)</span>     :: UA_PHYS   <span class="comment">! UA: flag for UA option</span></div>
<div class="line"><a id="l03559" name="l03559"></a><span class="lineno"> 3559</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(IN)</span>        :: FBUR      <span class="comment">! UA: fraction of canopy buried</span></div>
<div class="line"><a id="l03560" name="l03560"></a><span class="lineno"> 3560</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(IN)</span>        :: FGSN      <span class="comment">! UA: ground snow cover fraction</span></div>
<div class="line"><a id="l03561" name="l03561"></a><span class="lineno"> 3561</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(IN)</span>        :: SHDMAX    <span class="comment">! UA: maximum vegetation fraction</span></div>
<div class="line"><a id="l03562" name="l03562"></a><span class="lineno"> 3562</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">PARAMETER</span>         :: Z0G=0.01  <span class="comment">! UA: soil roughness</span></div>
<div class="line"><a id="l03563" name="l03563"></a><span class="lineno"> 3563</span><span class="keywordtype">      REAL</span>                    :: FV,A1,A2</div>
<div class="line"><a id="l03564" name="l03564"></a><span class="lineno"> 3564</span> </div>
<div class="line"><a id="l03565" name="l03565"></a><span class="lineno"> 3565</span>      <span class="keywordflow">IF</span>(ua_phys) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l03566" name="l03566"></a><span class="lineno"> 3566</span> </div>
<div class="line"><a id="l03567" name="l03567"></a><span class="lineno"> 3567</span>          fv = shdmax * (1.-fbur)</div>
<div class="line"><a id="l03568" name="l03568"></a><span class="lineno"> 3568</span>          a1 = (1.-fv)**2*((1.-fgsn**2)*log(z0g) + (fgsn**2)*log(z0s))</div>
<div class="line"><a id="l03569" name="l03569"></a><span class="lineno"> 3569</span>          a2 = (1.-(1.-fv)**2)*log(z0brd)</div>
<div class="line"><a id="l03570" name="l03570"></a><span class="lineno"> 3570</span>          z0 = exp(a1+a2)</div>
<div class="line"><a id="l03571" name="l03571"></a><span class="lineno"> 3571</span> </div>
<div class="line"><a id="l03572" name="l03572"></a><span class="lineno"> 3572</span>      <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l03573" name="l03573"></a><span class="lineno"> 3573</span> </div>
<div class="line"><a id="l03574" name="l03574"></a><span class="lineno"> 3574</span><span class="comment">!m        Z0 = (1.- SNCOVR)* Z0BRD + SNCOVR * Z0S</span></div>
<div class="line"><a id="l03575" name="l03575"></a><span class="lineno"> 3575</span>          burial = 7.0*z0brd - snowh</div>
<div class="line"><a id="l03576" name="l03576"></a><span class="lineno"> 3576</span>          <span class="keywordflow">IF</span>(burial.LE.0.0007) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l03577" name="l03577"></a><span class="lineno"> 3577</span>              z0eff = z0s</div>
<div class="line"><a id="l03578" name="l03578"></a><span class="lineno"> 3578</span>          <span class="keywordflow">ELSE</span>      </div>
<div class="line"><a id="l03579" name="l03579"></a><span class="lineno"> 3579</span>              z0eff = burial/7.0</div>
<div class="line"><a id="l03580" name="l03580"></a><span class="lineno"> 3580</span><span class="keywordflow">          ENDIF</span></div>
<div class="line"><a id="l03581" name="l03581"></a><span class="lineno"> 3581</span>      </div>
<div class="line"><a id="l03582" name="l03582"></a><span class="lineno"> 3582</span>          z0 = (1.- sncovr)* z0brd + sncovr * z0eff</div>
<div class="line"><a id="l03583" name="l03583"></a><span class="lineno"> 3583</span> </div>
<div class="line"><a id="l03584" name="l03584"></a><span class="lineno"> 3584</span><span class="keywordflow">      ENDIF</span></div>
<div class="line"><a id="l03585" name="l03585"></a><span class="lineno"> 3585</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03586" name="l03586"></a><span class="lineno"> 3586</span>  <span class="keyword">END SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ab3693cb1c40b1bd7b4db5e96337f6eef">snowz0</a></div>
<div class="line"><a id="l03587" name="l03587"></a><span class="lineno"> 3587</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03588" name="l03588"></a><span class="lineno"> 3588</span> </div>
<div class="line"><a id="l03589" name="l03589"></a><span class="lineno"> 3589</span> </div>
<div class="line"><a id="l03590" name="l03590"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#ab7e465439f409557715a28bea71551c1"> 3590</a></span>      <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ab7e465439f409557715a28bea71551c1">snow_new</a> (TEMP,NEWSN,SNOWH,SNDENS)</div>
<div class="line"><a id="l03591" name="l03591"></a><span class="lineno"> 3591</span> </div>
<div class="line"><a id="l03592" name="l03592"></a><span class="lineno"> 3592</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03593" name="l03593"></a><span class="lineno"> 3593</span><span class="comment">! SUBROUTINE SNOW_NEW</span></div>
<div class="line"><a id="l03594" name="l03594"></a><span class="lineno"> 3594</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03595" name="l03595"></a><span class="lineno"> 3595</span><span class="comment">! CALCULATE SNOW DEPTH AND DENSITY TO ACCOUNT FOR THE NEW SNOWFALL.</span></div>
<div class="line"><a id="l03596" name="l03596"></a><span class="lineno"> 3596</span><span class="comment">! NEW VALUES OF SNOW DEPTH &amp; DENSITY RETURNED.</span></div>
<div class="line"><a id="l03597" name="l03597"></a><span class="lineno"> 3597</span> </div>
<div class="line"><a id="l03598" name="l03598"></a><span class="lineno"> 3598</span><span class="comment">! TEMP    AIR TEMPERATURE (K)</span></div>
<div class="line"><a id="l03599" name="l03599"></a><span class="lineno"> 3599</span><span class="comment">! NEWSN   NEW SNOWFALL (M)</span></div>
<div class="line"><a id="l03600" name="l03600"></a><span class="lineno"> 3600</span><span class="comment">! SNOWH   SNOW DEPTH (M)</span></div>
<div class="line"><a id="l03601" name="l03601"></a><span class="lineno"> 3601</span><span class="comment">! SNDENS  SNOW DENSITY (G/CM3=DIMENSIONLESS FRACTION OF H2O DENSITY)</span></div>
<div class="line"><a id="l03602" name="l03602"></a><span class="lineno"> 3602</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03603" name="l03603"></a><span class="lineno"> 3603</span>      <span class="keywordtype">IMPLICIT NONE</span></div>
<div class="line"><a id="l03604" name="l03604"></a><span class="lineno"> 3604</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(IN)</span>        :: NEWSN, TEMP</div>
<div class="line"><a id="l03605" name="l03605"></a><span class="lineno"> 3605</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(INOUT)</span>     :: SNDENS, SNOWH</div>
<div class="line"><a id="l03606" name="l03606"></a><span class="lineno"> 3606</span><span class="keywordtype">      REAL</span>                    :: DSNEW, HNEWC, SNOWHC,NEWSNC,TEMPC</div>
<div class="line"><a id="l03607" name="l03607"></a><span class="lineno"> 3607</span> </div>
<div class="line"><a id="l03608" name="l03608"></a><span class="lineno"> 3608</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03609" name="l03609"></a><span class="lineno"> 3609</span><span class="comment">! CONVERSION INTO SIMULATION UNITS</span></div>
<div class="line"><a id="l03610" name="l03610"></a><span class="lineno"> 3610</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03611" name="l03611"></a><span class="lineno"> 3611</span>      snowhc = snowh *100.</div>
<div class="line"><a id="l03612" name="l03612"></a><span class="lineno"> 3612</span>      newsnc = newsn *100.</div>
<div class="line"><a id="l03613" name="l03613"></a><span class="lineno"> 3613</span> </div>
<div class="line"><a id="l03614" name="l03614"></a><span class="lineno"> 3614</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03615" name="l03615"></a><span class="lineno"> 3615</span><span class="comment">! CALCULATING NEW SNOWFALL DENSITY DEPENDING ON TEMPERATURE</span></div>
<div class="line"><a id="l03616" name="l03616"></a><span class="lineno"> 3616</span><span class="comment">! EQUATION FROM GOTTLIB L. &#39;A GENERAL RUNOFF MODEL FOR SNOWCOVERED</span></div>
<div class="line"><a id="l03617" name="l03617"></a><span class="lineno"> 3617</span><span class="comment">! AND GLACIERIZED BASIN&#39;, 6TH NORDIC HYDROLOGICAL CONFERENCE,</span></div>
<div class="line"><a id="l03618" name="l03618"></a><span class="lineno"> 3618</span><span class="comment">! VEMADOLEN, SWEDEN, 1980, 172-177PP.</span></div>
<div class="line"><a id="l03619" name="l03619"></a><span class="lineno"> 3619</span><span class="comment">!-----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03620" name="l03620"></a><span class="lineno"> 3620</span>      tempc = temp -273.15</div>
<div class="line"><a id="l03621" name="l03621"></a><span class="lineno"> 3621</span>      <span class="keywordflow">IF</span> (tempc &lt;=  -15.) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l03622" name="l03622"></a><span class="lineno"> 3622</span>         dsnew = 0.05</div>
<div class="line"><a id="l03623" name="l03623"></a><span class="lineno"> 3623</span>      <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l03624" name="l03624"></a><span class="lineno"> 3624</span>         dsnew = 0.05+0.0017* (tempc +15.)**1.5</div>
<div class="line"><a id="l03625" name="l03625"></a><span class="lineno"> 3625</span><span class="keywordflow">      END IF</span></div>
<div class="line"><a id="l03626" name="l03626"></a><span class="lineno"> 3626</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03627" name="l03627"></a><span class="lineno"> 3627</span><span class="comment">! ADJUSTMENT OF SNOW DENSITY DEPENDING ON NEW SNOWFALL</span></div>
<div class="line"><a id="l03628" name="l03628"></a><span class="lineno"> 3628</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03629" name="l03629"></a><span class="lineno"> 3629</span>      hnewc = newsnc / dsnew</div>
<div class="line"><a id="l03630" name="l03630"></a><span class="lineno"> 3630</span>      <span class="keywordflow">IF</span> (snowhc + hnewc .LT. 1.0e-3) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l03631" name="l03631"></a><span class="lineno"> 3631</span>         sndens = max(dsnew,sndens)</div>
<div class="line"><a id="l03632" name="l03632"></a><span class="lineno"> 3632</span>      <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l03633" name="l03633"></a><span class="lineno"> 3633</span>         sndens = (snowhc * sndens + hnewc * dsnew)/ (snowhc + hnewc)</div>
<div class="line"><a id="l03634" name="l03634"></a><span class="lineno"> 3634</span><span class="keywordflow">      ENDIF</span></div>
<div class="line"><a id="l03635" name="l03635"></a><span class="lineno"> 3635</span>      snowhc = snowhc + hnewc</div>
<div class="line"><a id="l03636" name="l03636"></a><span class="lineno"> 3636</span>      snowh = snowhc *0.01</div>
<div class="line"><a id="l03637" name="l03637"></a><span class="lineno"> 3637</span> </div>
<div class="line"><a id="l03638" name="l03638"></a><span class="lineno"> 3638</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03639" name="l03639"></a><span class="lineno"> 3639</span>  <span class="keyword">END SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ab7e465439f409557715a28bea71551c1">snow_new</a></div>
<div class="line"><a id="l03640" name="l03640"></a><span class="lineno"> 3640</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03641" name="l03641"></a><span class="lineno"> 3641</span> </div>
<div class="line"><a id="l03642" name="l03642"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#ab19c8eb3a76242cd834222e15c519613"> 3642</a></span>      <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ab19c8eb3a76242cd834222e15c519613">srt</a> (RHSTT,EDIR,ET,SH2O,SH2OA,NSOIL,PCPDRP,            &amp;</div>
<div class="line"><a id="l03643" name="l03643"></a><span class="lineno"> 3643</span>                       ZSOIL,DWSAT,DKSAT,SMCMAX,BEXP,RUNOFF1,           &amp;</div>
<div class="line"><a id="l03644" name="l03644"></a><span class="lineno"> 3644</span>                     RUNOFF2,DT,SMCWLT,SLOPE,KDT,FRZX,SICE,AI,BI,CI,  &amp;</div>
<div class="line"><a id="l03645" name="l03645"></a><span class="lineno"> 3645</span>                     SFHEAD1RT,INFXS1RT )</div>
<div class="line"><a id="l03646" name="l03646"></a><span class="lineno"> 3646</span> </div>
<div class="line"><a id="l03647" name="l03647"></a><span class="lineno"> 3647</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03648" name="l03648"></a><span class="lineno"> 3648</span><span class="comment">! SUBROUTINE SRT</span></div>
<div class="line"><a id="l03649" name="l03649"></a><span class="lineno"> 3649</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03650" name="l03650"></a><span class="lineno"> 3650</span><span class="comment">! CALCULATE THE RIGHT HAND SIDE OF THE TIME TENDENCY TERM OF THE SOIL</span></div>
<div class="line"><a id="l03651" name="l03651"></a><span class="lineno"> 3651</span><span class="comment">! WATER DIFFUSION EQUATION.  ALSO TO COMPUTE ( PREPARE ) THE MATRIX</span></div>
<div class="line"><a id="l03652" name="l03652"></a><span class="lineno"> 3652</span><span class="comment">! COEFFICIENTS FOR THE TRI-DIAGONAL MATRIX OF THE IMPLICIT TIME SCHEME.</span></div>
<div class="line"><a id="l03653" name="l03653"></a><span class="lineno"> 3653</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03654" name="l03654"></a><span class="lineno"> 3654</span>      <span class="keywordtype">IMPLICIT NONE</span></div>
<div class="line"><a id="l03655" name="l03655"></a><span class="lineno"> 3655</span>      <span class="keywordtype">INTEGER</span>, <span class="keywordtype">INTENT(IN)</span>       :: NSOIL</div>
<div class="line"><a id="l03656" name="l03656"></a><span class="lineno"> 3656</span>      <span class="keywordtype">INTEGER</span>                   :: IALP1, IOHINF, J, JJ,  K, KS</div>
<div class="line"><a id="l03657" name="l03657"></a><span class="lineno"> 3657</span> </div>
<div class="line"><a id="l03658" name="l03658"></a><span class="lineno"> 3658</span><span class="comment">!DJG NDHMS/WRF-Hydro edit... Variables used in OV routing infiltration calcs</span></div>
<div class="line"><a id="l03659" name="l03659"></a><span class="lineno"> 3659</span><span class="keywordtype">       REAL</span>, <span class="keywordtype">INTENT(INOUT)</span>     :: SFHEAD1RT, INFXS1RT</div>
<div class="line"><a id="l03660" name="l03660"></a><span class="lineno"> 3660</span><span class="keywordtype">       REAL</span>                    :: SFCWATR,chcksm</div>
<div class="line"><a id="l03661" name="l03661"></a><span class="lineno"> 3661</span> </div>
<div class="line"><a id="l03662" name="l03662"></a><span class="lineno"> 3662</span> </div>
<div class="line"><a id="l03663" name="l03663"></a><span class="lineno"> 3663</span> </div>
<div class="line"><a id="l03664" name="l03664"></a><span class="lineno"> 3664</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(IN)</span>          :: BEXP, DKSAT, DT, DWSAT, EDIR, FRZX,  &amp;</div>
<div class="line"><a id="l03665" name="l03665"></a><span class="lineno"> 3665</span>                                   KDT, PCPDRP, SLOPE, SMCMAX, SMCWLT</div>
<div class="line"><a id="l03666" name="l03666"></a><span class="lineno"> 3666</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(OUT)</span>         :: RUNOFF1, RUNOFF2</div>
<div class="line"><a id="l03667" name="l03667"></a><span class="lineno"> 3667</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(IN)</span>   :: ET, SH2O, SH2OA, SICE,  &amp;</div>
<div class="line"><a id="l03668" name="l03668"></a><span class="lineno"> 3668</span>                                                ZSOIL</div>
<div class="line"><a id="l03669" name="l03669"></a><span class="lineno"> 3669</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(OUT)</span>  :: RHSTT</div>
<div class="line"><a id="l03670" name="l03670"></a><span class="lineno"> 3670</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(OUT)</span>  :: AI, BI, CI</div>
<div class="line"><a id="l03671" name="l03671"></a><span class="lineno"> 3671</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>  :: DMAX</div>
<div class="line"><a id="l03672" name="l03672"></a><span class="lineno"> 3672</span><span class="keywordtype">      REAL</span>                      :: ACRT, DD, DDT, DDZ, DDZ2, DENOM,     &amp;</div>
<div class="line"><a id="l03673" name="l03673"></a><span class="lineno"> 3673</span>                                   DENOM2,DICE, DSMDZ, DSMDZ2, DT1,     &amp;</div>
<div class="line"><a id="l03674" name="l03674"></a><span class="lineno"> 3674</span>                                   FCR,INFMAX,MXSMC,MXSMC2,NUMER,PDDUM, &amp;</div>
<div class="line"><a id="l03675" name="l03675"></a><span class="lineno"> 3675</span>                                   PX, SICEMAX,SLOPX, SMCAV, SSTT,      &amp;</div>
<div class="line"><a id="l03676" name="l03676"></a><span class="lineno"> 3676</span>                                   SUM, VAL, WCND, WCND2, WDF, WDF2</div>
<div class="line"><a id="l03677" name="l03677"></a><span class="lineno"> 3677</span>      <span class="keywordtype">INTEGER</span>, <span class="keywordtype">PARAMETER</span>        :: CVFRZ = 3</div>
<div class="line"><a id="l03678" name="l03678"></a><span class="lineno"> 3678</span> </div>
<div class="line"><a id="l03679" name="l03679"></a><span class="lineno"> 3679</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03680" name="l03680"></a><span class="lineno"> 3680</span><span class="comment">! FROZEN GROUND VERSION:</span></div>
<div class="line"><a id="l03681" name="l03681"></a><span class="lineno"> 3681</span><span class="comment">! REFERENCE FROZEN GROUND PARAMETER, CVFRZ, IS A SHAPE PARAMETER OF</span></div>
<div class="line"><a id="l03682" name="l03682"></a><span class="lineno"> 3682</span><span class="comment">! AREAL DISTRIBUTION FUNCTION OF SOIL ICE CONTENT WHICH EQUALS 1/CV.</span></div>
<div class="line"><a id="l03683" name="l03683"></a><span class="lineno"> 3683</span><span class="comment">! CV IS A COEFFICIENT OF SPATIAL VARIATION OF SOIL ICE CONTENT.  BASED</span></div>
<div class="line"><a id="l03684" name="l03684"></a><span class="lineno"> 3684</span><span class="comment">! ON FIELD DATA CV DEPENDS ON AREAL MEAN OF FROZEN DEPTH, AND IT CLOSE</span></div>
<div class="line"><a id="l03685" name="l03685"></a><span class="lineno"> 3685</span><span class="comment">! TO CONSTANT = 0.6 IF AREAL MEAN FROZEN DEPTH IS ABOVE 20 CM.  THAT IS</span></div>
<div class="line"><a id="l03686" name="l03686"></a><span class="lineno"> 3686</span><span class="comment">! WHY PARAMETER CVFRZ = 3 (INT{1/0.6*0.6}).</span></div>
<div class="line"><a id="l03687" name="l03687"></a><span class="lineno"> 3687</span><span class="comment">! CURRENT LOGIC DOESN&#39;T ALLOW CVFRZ BE BIGGER THAN 3</span></div>
<div class="line"><a id="l03688" name="l03688"></a><span class="lineno"> 3688</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03689" name="l03689"></a><span class="lineno"> 3689</span> </div>
<div class="line"><a id="l03690" name="l03690"></a><span class="lineno"> 3690</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03691" name="l03691"></a><span class="lineno"> 3691</span><span class="comment">! DETERMINE RAINFALL INFILTRATION RATE AND RUNOFF.  INCLUDE THE</span></div>
<div class="line"><a id="l03692" name="l03692"></a><span class="lineno"> 3692</span><span class="comment">! INFILTRATION FORMULE FROM SCHAAKE AND KOREN MODEL.</span></div>
<div class="line"><a id="l03693" name="l03693"></a><span class="lineno"> 3693</span><span class="comment">! MODIFIED BY Q DUAN</span></div>
<div class="line"><a id="l03694" name="l03694"></a><span class="lineno"> 3694</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03695" name="l03695"></a><span class="lineno"> 3695</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03696" name="l03696"></a><span class="lineno"> 3696</span><span class="comment">! LET SICEMAX BE THE GREATEST, IF ANY, FROZEN WATER CONTENT WITHIN SOIL</span></div>
<div class="line"><a id="l03697" name="l03697"></a><span class="lineno"> 3697</span><span class="comment">! LAYERS.</span></div>
<div class="line"><a id="l03698" name="l03698"></a><span class="lineno"> 3698</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03699" name="l03699"></a><span class="lineno"> 3699</span>      iohinf = 1</div>
<div class="line"><a id="l03700" name="l03700"></a><span class="lineno"> 3700</span>      sicemax = 0.0</div>
<div class="line"><a id="l03701" name="l03701"></a><span class="lineno"> 3701</span>      <span class="keywordflow">DO</span> ks = 1,nsoil</div>
<div class="line"><a id="l03702" name="l03702"></a><span class="lineno"> 3702</span>         <span class="keywordflow">IF</span> (sice(ks) &gt;  sicemax) sicemax = sice(ks)</div>
<div class="line"><a id="l03703" name="l03703"></a><span class="lineno"> 3703</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03704" name="l03704"></a><span class="lineno"> 3704</span><span class="comment">! DETERMINE RAINFALL INFILTRATION RATE AND RUNOFF</span></div>
<div class="line"><a id="l03705" name="l03705"></a><span class="lineno"> 3705</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03706" name="l03706"></a><span class="lineno"> 3706</span><span class="keywordflow">      END DO</span></div>
<div class="line"><a id="l03707" name="l03707"></a><span class="lineno"> 3707</span> </div>
<div class="line"><a id="l03708" name="l03708"></a><span class="lineno"> 3708</span><span class="preprocessor">#ifdef WRF_HYDRO</span></div>
<div class="line"><a id="l03709" name="l03709"></a><span class="lineno"> 3709</span><span class="preprocessor"></span><span class="comment">!DJG NDHMS/WRF-Hydro edit...</span></div>
<div class="line"><a id="l03710" name="l03710"></a><span class="lineno"> 3710</span><span class="comment">!DJG Use previously merged Precip and Sfchead for infil. cap. calc.</span></div>
<div class="line"><a id="l03711" name="l03711"></a><span class="lineno"> 3711</span>      sfcwatr = pcpdrp</div>
<div class="line"><a id="l03712" name="l03712"></a><span class="lineno"> 3712</span>      pddum = sfcwatr</div>
<div class="line"><a id="l03713" name="l03713"></a><span class="lineno"> 3713</span><span class="comment">!DJG original   PDDUM = PCPDRP</span></div>
<div class="line"><a id="l03714" name="l03714"></a><span class="lineno"> 3714</span>      runoff1 = 0.0</div>
<div class="line"><a id="l03715" name="l03715"></a><span class="lineno"> 3715</span>      infxs1rt = 0.0</div>
<div class="line"><a id="l03716" name="l03716"></a><span class="lineno"> 3716</span><span class="preprocessor">#else</span></div>
<div class="line"><a id="l03717" name="l03717"></a><span class="lineno"> 3717</span><span class="preprocessor"></span>      pddum = pcpdrp</div>
<div class="line"><a id="l03718" name="l03718"></a><span class="lineno"> 3718</span>      runoff1 = 0.0</div>
<div class="line"><a id="l03719" name="l03719"></a><span class="lineno"> 3719</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l03720" name="l03720"></a><span class="lineno"> 3720</span><span class="preprocessor"></span> </div>
<div class="line"><a id="l03721" name="l03721"></a><span class="lineno"> 3721</span> </div>
<div class="line"><a id="l03722" name="l03722"></a><span class="lineno"> 3722</span> </div>
<div class="line"><a id="l03723" name="l03723"></a><span class="lineno"> 3723</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03724" name="l03724"></a><span class="lineno"> 3724</span><span class="comment">! MODIFIED BY Q. DUAN, 5/16/94</span></div>
<div class="line"><a id="l03725" name="l03725"></a><span class="lineno"> 3725</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03726" name="l03726"></a><span class="lineno"> 3726</span><span class="comment">!        IF (IOHINF == 1) THEN</span></div>
<div class="line"><a id="l03727" name="l03727"></a><span class="lineno"> 3727</span> </div>
<div class="line"><a id="l03728" name="l03728"></a><span class="lineno"> 3728</span><span class="preprocessor">#ifdef WRF_HYDRO</span></div>
<div class="line"><a id="l03729" name="l03729"></a><span class="lineno"> 3729</span><span class="preprocessor"></span><span class="comment">!DJG NDHMS/WRF-Hydro edit...</span></div>
<div class="line"><a id="l03730" name="l03730"></a><span class="lineno"> 3730</span><span class="comment">!DJG IF (PCPDRP /=  0.0) THEN</span></div>
<div class="line"><a id="l03731" name="l03731"></a><span class="lineno"> 3731</span>      <span class="keywordflow">IF</span> (sfcwatr /=  0.0) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l03732" name="l03732"></a><span class="lineno"> 3732</span><span class="preprocessor">#else</span></div>
<div class="line"><a id="l03733" name="l03733"></a><span class="lineno"> 3733</span><span class="preprocessor"></span>     <span class="keywordflow">IF</span> (pcpdrp /=  0.0) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l03734" name="l03734"></a><span class="lineno"> 3734</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l03735" name="l03735"></a><span class="lineno"> 3735</span><span class="preprocessor"></span>         dt1 = dt /86400.</div>
<div class="line"><a id="l03736" name="l03736"></a><span class="lineno"> 3736</span>         smcav = smcmax - smcwlt</div>
<div class="line"><a id="l03737" name="l03737"></a><span class="lineno"> 3737</span> </div>
<div class="line"><a id="l03738" name="l03738"></a><span class="lineno"> 3738</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03739" name="l03739"></a><span class="lineno"> 3739</span><span class="comment">! FROZEN GROUND VERSION:</span></div>
<div class="line"><a id="l03740" name="l03740"></a><span class="lineno"> 3740</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03741" name="l03741"></a><span class="lineno"> 3741</span>         dmax(1)= - zsoil(1)* smcav</div>
<div class="line"><a id="l03742" name="l03742"></a><span class="lineno"> 3742</span> </div>
<div class="line"><a id="l03743" name="l03743"></a><span class="lineno"> 3743</span>         dice = - zsoil(1) * sice(1)</div>
<div class="line"><a id="l03744" name="l03744"></a><span class="lineno"> 3744</span>         dmax(1)= dmax(1)* (1.0- (sh2oa(1) + sice(1) - smcwlt)/      &amp;</div>
<div class="line"><a id="l03745" name="l03745"></a><span class="lineno"> 3745</span>                    smcav)</div>
<div class="line"><a id="l03746" name="l03746"></a><span class="lineno"> 3746</span> </div>
<div class="line"><a id="l03747" name="l03747"></a><span class="lineno"> 3747</span>         dd = dmax(1)</div>
<div class="line"><a id="l03748" name="l03748"></a><span class="lineno"> 3748</span> </div>
<div class="line"><a id="l03749" name="l03749"></a><span class="lineno"> 3749</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03750" name="l03750"></a><span class="lineno"> 3750</span><span class="comment">! FROZEN GROUND VERSION:</span></div>
<div class="line"><a id="l03751" name="l03751"></a><span class="lineno"> 3751</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03752" name="l03752"></a><span class="lineno"> 3752</span>         <span class="keywordflow">DO</span> ks = 2,nsoil</div>
<div class="line"><a id="l03753" name="l03753"></a><span class="lineno"> 3753</span> </div>
<div class="line"><a id="l03754" name="l03754"></a><span class="lineno"> 3754</span>            dice = dice+ ( zsoil(ks -1) - zsoil(ks) ) * sice(ks)</div>
<div class="line"><a id="l03755" name="l03755"></a><span class="lineno"> 3755</span>            dmax(ks) = (zsoil(ks -1) - zsoil(ks))* smcav</div>
<div class="line"><a id="l03756" name="l03756"></a><span class="lineno"> 3756</span>            dmax(ks) = dmax(ks)* (1.0- (sh2oa(ks) + sice(ks)        &amp;</div>
<div class="line"><a id="l03757" name="l03757"></a><span class="lineno"> 3757</span>                        - smcwlt)/ smcav)</div>
<div class="line"><a id="l03758" name="l03758"></a><span class="lineno"> 3758</span>            dd = dd+ dmax(ks)</div>
<div class="line"><a id="l03759" name="l03759"></a><span class="lineno"> 3759</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03760" name="l03760"></a><span class="lineno"> 3760</span><span class="comment">! VAL = (1.-EXP(-KDT*SQRT(DT1)))</span></div>
<div class="line"><a id="l03761" name="l03761"></a><span class="lineno"> 3761</span><span class="comment">! IN BELOW, REMOVE THE SQRT IN ABOVE</span></div>
<div class="line"><a id="l03762" name="l03762"></a><span class="lineno"> 3762</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03763" name="l03763"></a><span class="lineno"> 3763</span><span class="keywordflow">         END DO</span></div>
<div class="line"><a id="l03764" name="l03764"></a><span class="lineno"> 3764</span>         val = (1. - exp( - kdt * dt1))</div>
<div class="line"><a id="l03765" name="l03765"></a><span class="lineno"> 3765</span>         ddt = dd * val</div>
<div class="line"><a id="l03766" name="l03766"></a><span class="lineno"> 3766</span><span class="preprocessor">#ifdef WRF_HYDRO</span></div>
<div class="line"><a id="l03767" name="l03767"></a><span class="lineno"> 3767</span><span class="preprocessor"></span><span class="comment">!DJG NDHMS/WRF-Hydro edit...</span></div>
<div class="line"><a id="l03768" name="l03768"></a><span class="lineno"> 3768</span><span class="comment">!DJG        PX = PCPDRP * DT</span></div>
<div class="line"><a id="l03769" name="l03769"></a><span class="lineno"> 3769</span>         px = sfcwatr * dt</div>
<div class="line"><a id="l03770" name="l03770"></a><span class="lineno"> 3770</span><span class="preprocessor">#else</span></div>
<div class="line"><a id="l03771" name="l03771"></a><span class="lineno"> 3771</span><span class="preprocessor"></span>         px = pcpdrp * dt</div>
<div class="line"><a id="l03772" name="l03772"></a><span class="lineno"> 3772</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l03773" name="l03773"></a><span class="lineno"> 3773</span><span class="preprocessor"></span>         <span class="keywordflow">IF</span> (px &lt;  0.0) px = 0.0</div>
<div class="line"><a id="l03774" name="l03774"></a><span class="lineno"> 3774</span> </div>
<div class="line"><a id="l03775" name="l03775"></a><span class="lineno"> 3775</span> </div>
<div class="line"><a id="l03776" name="l03776"></a><span class="lineno"> 3776</span> </div>
<div class="line"><a id="l03777" name="l03777"></a><span class="lineno"> 3777</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03778" name="l03778"></a><span class="lineno"> 3778</span><span class="comment">! FROZEN GROUND VERSION:</span></div>
<div class="line"><a id="l03779" name="l03779"></a><span class="lineno"> 3779</span><span class="comment">! REDUCTION OF INFILTRATION BASED ON FROZEN GROUND PARAMETERS</span></div>
<div class="line"><a id="l03780" name="l03780"></a><span class="lineno"> 3780</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03781" name="l03781"></a><span class="lineno"> 3781</span>         infmax = (px * (ddt / (px + ddt)))/ dt</div>
<div class="line"><a id="l03782" name="l03782"></a><span class="lineno"> 3782</span>         fcr = 1.</div>
<div class="line"><a id="l03783" name="l03783"></a><span class="lineno"> 3783</span>         <span class="keywordflow">IF</span> (dice &gt;  1.e-2) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l03784" name="l03784"></a><span class="lineno"> 3784</span>            acrt = cvfrz * frzx / dice</div>
<div class="line"><a id="l03785" name="l03785"></a><span class="lineno"> 3785</span>            sum = 1.</div>
<div class="line"><a id="l03786" name="l03786"></a><span class="lineno"> 3786</span>            ialp1 = cvfrz - 1</div>
<div class="line"><a id="l03787" name="l03787"></a><span class="lineno"> 3787</span>            <span class="keywordflow">DO</span> j = 1,ialp1</div>
<div class="line"><a id="l03788" name="l03788"></a><span class="lineno"> 3788</span>               k = 1</div>
<div class="line"><a id="l03789" name="l03789"></a><span class="lineno"> 3789</span>               <span class="keywordflow">DO</span> jj = j +1,ialp1</div>
<div class="line"><a id="l03790" name="l03790"></a><span class="lineno"> 3790</span>                  k = k * jj</div>
<div class="line"><a id="l03791" name="l03791"></a><span class="lineno"> 3791</span><span class="keywordflow">               END DO</span></div>
<div class="line"><a id="l03792" name="l03792"></a><span class="lineno"> 3792</span>               sum = sum + (acrt ** ( cvfrz - j)) / float(k)</div>
<div class="line"><a id="l03793" name="l03793"></a><span class="lineno"> 3793</span><span class="keywordflow">            END DO</span></div>
<div class="line"><a id="l03794" name="l03794"></a><span class="lineno"> 3794</span>            fcr = 1. - exp( - acrt) * sum</div>
<div class="line"><a id="l03795" name="l03795"></a><span class="lineno"> 3795</span><span class="keywordflow">         END IF</span></div>
<div class="line"><a id="l03796" name="l03796"></a><span class="lineno"> 3796</span> </div>
<div class="line"><a id="l03797" name="l03797"></a><span class="lineno"> 3797</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03798" name="l03798"></a><span class="lineno"> 3798</span><span class="comment">! CORRECTION OF INFILTRATION LIMITATION:</span></div>
<div class="line"><a id="l03799" name="l03799"></a><span class="lineno"> 3799</span><span class="comment">! IF INFMAX .LE. HYDROLIC CONDUCTIVITY ASSIGN INFMAX THE VALUE OF</span></div>
<div class="line"><a id="l03800" name="l03800"></a><span class="lineno"> 3800</span><span class="comment">! HYDROLIC CONDUCTIVITY</span></div>
<div class="line"><a id="l03801" name="l03801"></a><span class="lineno"> 3801</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03802" name="l03802"></a><span class="lineno"> 3802</span><span class="comment">!         MXSMC = MAX ( SH2OA(1), SH2OA(2) )</span></div>
<div class="line"><a id="l03803" name="l03803"></a><span class="lineno"> 3803</span>         infmax = infmax * fcr</div>
<div class="line"><a id="l03804" name="l03804"></a><span class="lineno"> 3804</span> </div>
<div class="line"><a id="l03805" name="l03805"></a><span class="lineno"> 3805</span>         mxsmc = sh2oa(1)</div>
<div class="line"><a id="l03806" name="l03806"></a><span class="lineno"> 3806</span>         <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a3b4a7f68699fbc22922e958770009b57">wdfcnd</a> (wdf,wcnd,mxsmc,smcmax,bexp,dksat,dwsat,           &amp;</div>
<div class="line"><a id="l03807" name="l03807"></a><span class="lineno"> 3807</span>                         sicemax)</div>
<div class="line"><a id="l03808" name="l03808"></a><span class="lineno"> 3808</span>         infmax = max(infmax,wcnd)</div>
<div class="line"><a id="l03809" name="l03809"></a><span class="lineno"> 3809</span> </div>
<div class="line"><a id="l03810" name="l03810"></a><span class="lineno"> 3810</span>         infmax = min(infmax,px/dt)</div>
<div class="line"><a id="l03811" name="l03811"></a><span class="lineno"> 3811</span><span class="preprocessor">#ifdef WRF_HYDRO </span></div>
<div class="line"><a id="l03812" name="l03812"></a><span class="lineno"> 3812</span><span class="preprocessor"></span><span class="comment">!DJG NDHMS/WRF-Hydro edit...</span></div>
<div class="line"><a id="l03813" name="l03813"></a><span class="lineno"> 3813</span><span class="comment">!DJG       IF (PCPDRP &gt;  INFMAX) THEN</span></div>
<div class="line"><a id="l03814" name="l03814"></a><span class="lineno"> 3814</span>         <span class="keywordflow">IF</span> (sfcwatr &gt; infmax) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l03815" name="l03815"></a><span class="lineno"> 3815</span><span class="comment">!DJG          RUNOFF1 = PCPDRP - INFMAX</span></div>
<div class="line"><a id="l03816" name="l03816"></a><span class="lineno"> 3816</span>          runoff1 = sfcwatr - infmax</div>
<div class="line"><a id="l03817" name="l03817"></a><span class="lineno"> 3817</span><span class="preprocessor">#else</span></div>
<div class="line"><a id="l03818" name="l03818"></a><span class="lineno"> 3818</span><span class="preprocessor"></span>         <span class="keywordflow">IF</span> (pcpdrp &gt;  infmax) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l03819" name="l03819"></a><span class="lineno"> 3819</span>            runoff1 = pcpdrp - infmax</div>
<div class="line"><a id="l03820" name="l03820"></a><span class="lineno"> 3820</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l03821" name="l03821"></a><span class="lineno"> 3821</span><span class="preprocessor"></span>          infxs1rt = runoff1*dt*1000.</div>
<div class="line"><a id="l03822" name="l03822"></a><span class="lineno"> 3822</span>          pddum = infmax</div>
<div class="line"><a id="l03823" name="l03823"></a><span class="lineno"> 3823</span><span class="keywordflow">         END IF</span></div>
<div class="line"><a id="l03824" name="l03824"></a><span class="lineno"> 3824</span> </div>
<div class="line"><a id="l03825" name="l03825"></a><span class="lineno"> 3825</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03826" name="l03826"></a><span class="lineno"> 3826</span><span class="comment">! TO AVOID SPURIOUS DRAINAGE BEHAVIOR, &#39;UPSTREAM DIFFERENCING&#39; IN LINE</span></div>
<div class="line"><a id="l03827" name="l03827"></a><span class="lineno"> 3827</span><span class="comment">! BELOW REPLACED WITH NEW APPROACH IN 2ND LINE:</span></div>
<div class="line"><a id="l03828" name="l03828"></a><span class="lineno"> 3828</span><span class="comment">! &#39;MXSMC = MAX(SH2OA(1), SH2OA(2))&#39;</span></div>
<div class="line"><a id="l03829" name="l03829"></a><span class="lineno"> 3829</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03830" name="l03830"></a><span class="lineno"> 3830</span><span class="keywordflow">      END IF</span></div>
<div class="line"><a id="l03831" name="l03831"></a><span class="lineno"> 3831</span> </div>
<div class="line"><a id="l03832" name="l03832"></a><span class="lineno"> 3832</span>      mxsmc = sh2oa(1)</div>
<div class="line"><a id="l03833" name="l03833"></a><span class="lineno"> 3833</span>      <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a3b4a7f68699fbc22922e958770009b57">wdfcnd</a> (wdf,wcnd,mxsmc,smcmax,bexp,dksat,dwsat,              &amp;</div>
<div class="line"><a id="l03834" name="l03834"></a><span class="lineno"> 3834</span>                    sicemax)</div>
<div class="line"><a id="l03835" name="l03835"></a><span class="lineno"> 3835</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03836" name="l03836"></a><span class="lineno"> 3836</span><span class="comment">! CALC THE MATRIX COEFFICIENTS AI, BI, AND CI FOR THE TOP LAYER</span></div>
<div class="line"><a id="l03837" name="l03837"></a><span class="lineno"> 3837</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03838" name="l03838"></a><span class="lineno"> 3838</span>      ddz = 1. / ( - .5 * zsoil(2) )</div>
<div class="line"><a id="l03839" name="l03839"></a><span class="lineno"> 3839</span>      ai(1) = 0.0</div>
<div class="line"><a id="l03840" name="l03840"></a><span class="lineno"> 3840</span>      bi(1) = wdf * ddz / ( - zsoil(1) )</div>
<div class="line"><a id="l03841" name="l03841"></a><span class="lineno"> 3841</span> </div>
<div class="line"><a id="l03842" name="l03842"></a><span class="lineno"> 3842</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03843" name="l03843"></a><span class="lineno"> 3843</span><span class="comment">! CALC RHSTT FOR THE TOP LAYER AFTER CALC&#39;NG THE VERTICAL SOIL MOISTURE</span></div>
<div class="line"><a id="l03844" name="l03844"></a><span class="lineno"> 3844</span><span class="comment">! GRADIENT BTWN THE TOP AND NEXT TO TOP LAYERS.</span></div>
<div class="line"><a id="l03845" name="l03845"></a><span class="lineno"> 3845</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03846" name="l03846"></a><span class="lineno"> 3846</span>      ci(1) = - bi(1)</div>
<div class="line"><a id="l03847" name="l03847"></a><span class="lineno"> 3847</span>      dsmdz = ( sh2o(1) - sh2o(2) ) / ( - .5 * zsoil(2) )</div>
<div class="line"><a id="l03848" name="l03848"></a><span class="lineno"> 3848</span>      rhstt(1) = (wdf * dsmdz + wcnd- pddum + edir + et(1))/ zsoil(1)</div>
<div class="line"><a id="l03849" name="l03849"></a><span class="lineno"> 3849</span> </div>
<div class="line"><a id="l03850" name="l03850"></a><span class="lineno"> 3850</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03851" name="l03851"></a><span class="lineno"> 3851</span><span class="comment">! INITIALIZE DDZ2</span></div>
<div class="line"><a id="l03852" name="l03852"></a><span class="lineno"> 3852</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03853" name="l03853"></a><span class="lineno"> 3853</span>      sstt = wdf * dsmdz + wcnd+ edir + et(1)</div>
<div class="line"><a id="l03854" name="l03854"></a><span class="lineno"> 3854</span> </div>
<div class="line"><a id="l03855" name="l03855"></a><span class="lineno"> 3855</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03856" name="l03856"></a><span class="lineno"> 3856</span><span class="comment">! LOOP THRU THE REMAINING SOIL LAYERS, REPEATING THE ABV PROCESS</span></div>
<div class="line"><a id="l03857" name="l03857"></a><span class="lineno"> 3857</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03858" name="l03858"></a><span class="lineno"> 3858</span>      ddz2 = 0.0</div>
<div class="line"><a id="l03859" name="l03859"></a><span class="lineno"> 3859</span>      <span class="keywordflow">DO</span> k = 2,nsoil</div>
<div class="line"><a id="l03860" name="l03860"></a><span class="lineno"> 3860</span>         denom2 = (zsoil(k -1) - zsoil(k))</div>
<div class="line"><a id="l03861" name="l03861"></a><span class="lineno"> 3861</span>         <span class="keywordflow">IF</span> (k /= nsoil) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l03862" name="l03862"></a><span class="lineno"> 3862</span> </div>
<div class="line"><a id="l03863" name="l03863"></a><span class="lineno"> 3863</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03864" name="l03864"></a><span class="lineno"> 3864</span><span class="comment">! AGAIN, TO AVOID SPURIOUS DRAINAGE BEHAVIOR, &#39;UPSTREAM DIFFERENCING&#39; IN</span></div>
<div class="line"><a id="l03865" name="l03865"></a><span class="lineno"> 3865</span><span class="comment">! LINE BELOW REPLACED WITH NEW APPROACH IN 2ND LINE:</span></div>
<div class="line"><a id="l03866" name="l03866"></a><span class="lineno"> 3866</span><span class="comment">! &#39;MXSMC2 = MAX (SH2OA(K), SH2OA(K+1))&#39;</span></div>
<div class="line"><a id="l03867" name="l03867"></a><span class="lineno"> 3867</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03868" name="l03868"></a><span class="lineno"> 3868</span>            slopx = 1.</div>
<div class="line"><a id="l03869" name="l03869"></a><span class="lineno"> 3869</span> </div>
<div class="line"><a id="l03870" name="l03870"></a><span class="lineno"> 3870</span>            mxsmc2 = sh2oa(k)</div>
<div class="line"><a id="l03871" name="l03871"></a><span class="lineno"> 3871</span>            <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a3b4a7f68699fbc22922e958770009b57">wdfcnd</a> (wdf2,wcnd2,mxsmc2,smcmax,bexp,dksat,dwsat,     &amp;</div>
<div class="line"><a id="l03872" name="l03872"></a><span class="lineno"> 3872</span>                          sicemax)</div>
<div class="line"><a id="l03873" name="l03873"></a><span class="lineno"> 3873</span><span class="comment">! -----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03874" name="l03874"></a><span class="lineno"> 3874</span><span class="comment">! CALC SOME PARTIAL PRODUCTS FOR LATER USE IN CALC&#39;NG RHSTT</span></div>
<div class="line"><a id="l03875" name="l03875"></a><span class="lineno"> 3875</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03876" name="l03876"></a><span class="lineno"> 3876</span>            denom = (zsoil(k -1) - zsoil(k +1))</div>
<div class="line"><a id="l03877" name="l03877"></a><span class="lineno"> 3877</span> </div>
<div class="line"><a id="l03878" name="l03878"></a><span class="lineno"> 3878</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03879" name="l03879"></a><span class="lineno"> 3879</span><span class="comment">! CALC THE MATRIX COEF, CI, AFTER CALC&#39;NG ITS PARTIAL PRODUCT</span></div>
<div class="line"><a id="l03880" name="l03880"></a><span class="lineno"> 3880</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03881" name="l03881"></a><span class="lineno"> 3881</span>            dsmdz2 = (sh2o(k) - sh2o(k +1)) / (denom * 0.5)</div>
<div class="line"><a id="l03882" name="l03882"></a><span class="lineno"> 3882</span>            ddz2 = 2.0 / denom</div>
<div class="line"><a id="l03883" name="l03883"></a><span class="lineno"> 3883</span>            ci(k) = - wdf2 * ddz2 / denom2</div>
<div class="line"><a id="l03884" name="l03884"></a><span class="lineno"> 3884</span> </div>
<div class="line"><a id="l03885" name="l03885"></a><span class="lineno"> 3885</span>         <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l03886" name="l03886"></a><span class="lineno"> 3886</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03887" name="l03887"></a><span class="lineno"> 3887</span><span class="comment">! SLOPE OF BOTTOM LAYER IS INTRODUCED</span></div>
<div class="line"><a id="l03888" name="l03888"></a><span class="lineno"> 3888</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03889" name="l03889"></a><span class="lineno"> 3889</span> </div>
<div class="line"><a id="l03890" name="l03890"></a><span class="lineno"> 3890</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03891" name="l03891"></a><span class="lineno"> 3891</span><span class="comment">! RETRIEVE THE SOIL WATER DIFFUSIVITY AND HYDRAULIC CONDUCTIVITY FOR</span></div>
<div class="line"><a id="l03892" name="l03892"></a><span class="lineno"> 3892</span><span class="comment">! THIS LAYER</span></div>
<div class="line"><a id="l03893" name="l03893"></a><span class="lineno"> 3893</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03894" name="l03894"></a><span class="lineno"> 3894</span>            slopx = slope</div>
<div class="line"><a id="l03895" name="l03895"></a><span class="lineno"> 3895</span>          <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a3b4a7f68699fbc22922e958770009b57">wdfcnd</a> (wdf2,wcnd2,sh2oa(nsoil),smcmax,bexp,dksat,dwsat,     &amp;</div>
<div class="line"><a id="l03896" name="l03896"></a><span class="lineno"> 3896</span>                            sicemax)</div>
<div class="line"><a id="l03897" name="l03897"></a><span class="lineno"> 3897</span> </div>
<div class="line"><a id="l03898" name="l03898"></a><span class="lineno"> 3898</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03899" name="l03899"></a><span class="lineno"> 3899</span><span class="comment">! CALC A PARTIAL PRODUCT FOR LATER USE IN CALC&#39;NG RHSTT</span></div>
<div class="line"><a id="l03900" name="l03900"></a><span class="lineno"> 3900</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03901" name="l03901"></a><span class="lineno"> 3901</span> </div>
<div class="line"><a id="l03902" name="l03902"></a><span class="lineno"> 3902</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03903" name="l03903"></a><span class="lineno"> 3903</span><span class="comment">! SET MATRIX COEF CI TO ZERO</span></div>
<div class="line"><a id="l03904" name="l03904"></a><span class="lineno"> 3904</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03905" name="l03905"></a><span class="lineno"> 3905</span>            dsmdz2 = 0.0</div>
<div class="line"><a id="l03906" name="l03906"></a><span class="lineno"> 3906</span>            ci(k) = 0.0</div>
<div class="line"><a id="l03907" name="l03907"></a><span class="lineno"> 3907</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03908" name="l03908"></a><span class="lineno"> 3908</span><span class="comment">! CALC RHSTT FOR THIS LAYER AFTER CALC&#39;NG ITS NUMERATOR</span></div>
<div class="line"><a id="l03909" name="l03909"></a><span class="lineno"> 3909</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03910" name="l03910"></a><span class="lineno"> 3910</span><span class="keywordflow">         END IF</span></div>
<div class="line"><a id="l03911" name="l03911"></a><span class="lineno"> 3911</span>         numer = (wdf2 * dsmdz2) + slopx * wcnd2- (wdf * dsmdz)         &amp;</div>
<div class="line"><a id="l03912" name="l03912"></a><span class="lineno"> 3912</span>                 - wcnd+ et(k)</div>
<div class="line"><a id="l03913" name="l03913"></a><span class="lineno"> 3913</span> </div>
<div class="line"><a id="l03914" name="l03914"></a><span class="lineno"> 3914</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03915" name="l03915"></a><span class="lineno"> 3915</span><span class="comment">! CALC MATRIX COEFS, AI, AND BI FOR THIS LAYER</span></div>
<div class="line"><a id="l03916" name="l03916"></a><span class="lineno"> 3916</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03917" name="l03917"></a><span class="lineno"> 3917</span>         rhstt(k) = numer / ( - denom2)</div>
<div class="line"><a id="l03918" name="l03918"></a><span class="lineno"> 3918</span>         ai(k) = - wdf * ddz / denom2</div>
<div class="line"><a id="l03919" name="l03919"></a><span class="lineno"> 3919</span> </div>
<div class="line"><a id="l03920" name="l03920"></a><span class="lineno"> 3920</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03921" name="l03921"></a><span class="lineno"> 3921</span><span class="comment">! RESET VALUES OF WDF, WCND, DSMDZ, AND DDZ FOR LOOP TO NEXT LYR</span></div>
<div class="line"><a id="l03922" name="l03922"></a><span class="lineno"> 3922</span><span class="comment">! RUNOFF2:  SUB-SURFACE OR BASEFLOW RUNOFF</span></div>
<div class="line"><a id="l03923" name="l03923"></a><span class="lineno"> 3923</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03924" name="l03924"></a><span class="lineno"> 3924</span>         bi(k) = - ( ai(k) + ci(k) )</div>
<div class="line"><a id="l03925" name="l03925"></a><span class="lineno"> 3925</span>         <span class="keywordflow">IF</span> (k .eq. nsoil) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l03926" name="l03926"></a><span class="lineno"> 3926</span>            runoff2 = slopx * wcnd2</div>
<div class="line"><a id="l03927" name="l03927"></a><span class="lineno"> 3927</span><span class="keywordflow">         END IF</span></div>
<div class="line"><a id="l03928" name="l03928"></a><span class="lineno"> 3928</span>         <span class="keywordflow">IF</span> (k .ne. nsoil) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l03929" name="l03929"></a><span class="lineno"> 3929</span>            wdf = wdf2</div>
<div class="line"><a id="l03930" name="l03930"></a><span class="lineno"> 3930</span>            wcnd = wcnd2</div>
<div class="line"><a id="l03931" name="l03931"></a><span class="lineno"> 3931</span>            dsmdz = dsmdz2</div>
<div class="line"><a id="l03932" name="l03932"></a><span class="lineno"> 3932</span>            ddz = ddz2</div>
<div class="line"><a id="l03933" name="l03933"></a><span class="lineno"> 3933</span><span class="keywordflow">         END IF</span></div>
<div class="line"><a id="l03934" name="l03934"></a><span class="lineno"> 3934</span><span class="keywordflow">      END DO</span></div>
<div class="line"><a id="l03935" name="l03935"></a><span class="lineno"> 3935</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03936" name="l03936"></a><span class="lineno"> 3936</span>  <span class="keyword">END SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ab19c8eb3a76242cd834222e15c519613">srt</a></div>
<div class="line"><a id="l03937" name="l03937"></a><span class="lineno"> 3937</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03938" name="l03938"></a><span class="lineno"> 3938</span> </div>
<div class="line"><a id="l03939" name="l03939"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#a2e0170eed7801b6976d18285d32a1c57"> 3939</a></span>      <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a2e0170eed7801b6976d18285d32a1c57">sstep</a> (SH2OOUT,SH2OIN,CMC,RHSTT,RHSCT,DT,              &amp;</div>
<div class="line"><a id="l03940" name="l03940"></a><span class="lineno"> 3940</span>                        NSOIL,SMCMAX,CMCMAX,RUNOFF3,ZSOIL,SMC,SICE,     &amp;</div>
<div class="line"><a id="l03941" name="l03941"></a><span class="lineno"> 3941</span>                        AI,BI,CI, INFXS1RT)</div>
<div class="line"><a id="l03942" name="l03942"></a><span class="lineno"> 3942</span> </div>
<div class="line"><a id="l03943" name="l03943"></a><span class="lineno"> 3943</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03944" name="l03944"></a><span class="lineno"> 3944</span><span class="comment">! SUBROUTINE SSTEP</span></div>
<div class="line"><a id="l03945" name="l03945"></a><span class="lineno"> 3945</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03946" name="l03946"></a><span class="lineno"> 3946</span><span class="comment">! CALCULATE/UPDATE SOIL MOISTURE CONTENT VALUES AND CANOPY MOISTURE</span></div>
<div class="line"><a id="l03947" name="l03947"></a><span class="lineno"> 3947</span><span class="comment">! CONTENT VALUES.</span></div>
<div class="line"><a id="l03948" name="l03948"></a><span class="lineno"> 3948</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03949" name="l03949"></a><span class="lineno"> 3949</span>      <span class="keywordtype">IMPLICIT NONE</span></div>
<div class="line"><a id="l03950" name="l03950"></a><span class="lineno"> 3950</span>      <span class="keywordtype">INTEGER</span>, <span class="keywordtype">INTENT(IN)</span>       :: NSOIL</div>
<div class="line"><a id="l03951" name="l03951"></a><span class="lineno"> 3951</span>      <span class="keywordtype">INTEGER</span>                   :: I, K, KK11</div>
<div class="line"><a id="l03952" name="l03952"></a><span class="lineno"> 3952</span> </div>
<div class="line"><a id="l03953" name="l03953"></a><span class="lineno"> 3953</span><span class="comment">!!DJG NDHMS/WRF-Hydro edit...</span></div>
<div class="line"><a id="l03954" name="l03954"></a><span class="lineno"> 3954</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(INOUT)</span>       :: INFXS1RT</div>
<div class="line"><a id="l03955" name="l03955"></a><span class="lineno"> 3955</span><span class="keywordtype">      REAL</span>                      :: AVAIL</div>
<div class="line"><a id="l03956" name="l03956"></a><span class="lineno"> 3956</span> </div>
<div class="line"><a id="l03957" name="l03957"></a><span class="lineno"> 3957</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(IN)</span>          :: CMCMAX, DT, SMCMAX</div>
<div class="line"><a id="l03958" name="l03958"></a><span class="lineno"> 3958</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(OUT)</span>         :: RUNOFF3</div>
<div class="line"><a id="l03959" name="l03959"></a><span class="lineno"> 3959</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(INOUT)</span>       :: CMC</div>
<div class="line"><a id="l03960" name="l03960"></a><span class="lineno"> 3960</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(IN)</span>     :: SH2OIN, SICE, ZSOIL</div>
<div class="line"><a id="l03961" name="l03961"></a><span class="lineno"> 3961</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(OUT)</span>    :: SH2OOUT</div>
<div class="line"><a id="l03962" name="l03962"></a><span class="lineno"> 3962</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(INOUT)</span>  :: RHSTT, SMC</div>
<div class="line"><a id="l03963" name="l03963"></a><span class="lineno"> 3963</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(INOUT)</span>  :: AI, BI, CI</div>
<div class="line"><a id="l03964" name="l03964"></a><span class="lineno"> 3964</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>  :: RHSTTin</div>
<div class="line"><a id="l03965" name="l03965"></a><span class="lineno"> 3965</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>  :: CIin</div>
<div class="line"><a id="l03966" name="l03966"></a><span class="lineno"> 3966</span><span class="keywordtype">      REAL</span>                      :: DDZ, RHSCT, STOT, WPLUS</div>
<div class="line"><a id="l03967" name="l03967"></a><span class="lineno"> 3967</span> </div>
<div class="line"><a id="l03968" name="l03968"></a><span class="lineno"> 3968</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03969" name="l03969"></a><span class="lineno"> 3969</span><span class="comment">! CREATE &#39;AMOUNT&#39; VALUES OF VARIABLES TO BE INPUT TO THE</span></div>
<div class="line"><a id="l03970" name="l03970"></a><span class="lineno"> 3970</span><span class="comment">! TRI-DIAGONAL MATRIX ROUTINE.</span></div>
<div class="line"><a id="l03971" name="l03971"></a><span class="lineno"> 3971</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03972" name="l03972"></a><span class="lineno"> 3972</span>      <span class="keywordflow">DO</span> k = 1,nsoil</div>
<div class="line"><a id="l03973" name="l03973"></a><span class="lineno"> 3973</span>         rhstt(k) = rhstt(k) * dt</div>
<div class="line"><a id="l03974" name="l03974"></a><span class="lineno"> 3974</span>         ai(k) = ai(k) * dt</div>
<div class="line"><a id="l03975" name="l03975"></a><span class="lineno"> 3975</span>         bi(k) = 1. + bi(k) * dt</div>
<div class="line"><a id="l03976" name="l03976"></a><span class="lineno"> 3976</span>         ci(k) = ci(k) * dt</div>
<div class="line"><a id="l03977" name="l03977"></a><span class="lineno"> 3977</span><span class="keywordflow">      END DO</span></div>
<div class="line"><a id="l03978" name="l03978"></a><span class="lineno"> 3978</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03979" name="l03979"></a><span class="lineno"> 3979</span><span class="comment">! COPY VALUES FOR INPUT VARIABLES BEFORE CALL TO ROSR12</span></div>
<div class="line"><a id="l03980" name="l03980"></a><span class="lineno"> 3980</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03981" name="l03981"></a><span class="lineno"> 3981</span>      <span class="keywordflow">DO</span> k = 1,nsoil</div>
<div class="line"><a id="l03982" name="l03982"></a><span class="lineno"> 3982</span>         rhsttin(k) = rhstt(k)</div>
<div class="line"><a id="l03983" name="l03983"></a><span class="lineno"> 3983</span><span class="keywordflow">      END DO</span></div>
<div class="line"><a id="l03984" name="l03984"></a><span class="lineno"> 3984</span>      <span class="keywordflow">DO</span> k = 1,nsoil</div>
<div class="line"><a id="l03985" name="l03985"></a><span class="lineno"> 3985</span>         ciin(k) = ci(k)</div>
<div class="line"><a id="l03986" name="l03986"></a><span class="lineno"> 3986</span><span class="keywordflow">      END DO</span></div>
<div class="line"><a id="l03987" name="l03987"></a><span class="lineno"> 3987</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03988" name="l03988"></a><span class="lineno"> 3988</span><span class="comment">! CALL ROSR12 TO SOLVE THE TRI-DIAGONAL MATRIX</span></div>
<div class="line"><a id="l03989" name="l03989"></a><span class="lineno"> 3989</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03990" name="l03990"></a><span class="lineno"> 3990</span>      <span class="keyword">CALL </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ac6e3e7bb3f0322070546653306177216">rosr12</a> (ci,ai,bi,ciin,rhsttin,rhstt,nsoil)</div>
<div class="line"><a id="l03991" name="l03991"></a><span class="lineno"> 3991</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03992" name="l03992"></a><span class="lineno"> 3992</span><span class="comment">! SUM THE PREVIOUS SMC VALUE AND THE MATRIX SOLUTION TO GET A</span></div>
<div class="line"><a id="l03993" name="l03993"></a><span class="lineno"> 3993</span><span class="comment">! NEW VALUE.  MIN ALLOWABLE VALUE OF SMC WILL BE 0.02.</span></div>
<div class="line"><a id="l03994" name="l03994"></a><span class="lineno"> 3994</span><span class="comment">! RUNOFF3: RUNOFF WITHIN SOIL LAYERS</span></div>
<div class="line"><a id="l03995" name="l03995"></a><span class="lineno"> 3995</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03996" name="l03996"></a><span class="lineno"> 3996</span>      wplus = 0.0</div>
<div class="line"><a id="l03997" name="l03997"></a><span class="lineno"> 3997</span>      runoff3 = 0.</div>
<div class="line"><a id="l03998" name="l03998"></a><span class="lineno"> 3998</span> </div>
<div class="line"><a id="l03999" name="l03999"></a><span class="lineno"> 3999</span>      ddz = - zsoil(1)</div>
<div class="line"><a id="l04000" name="l04000"></a><span class="lineno"> 4000</span>      <span class="keywordflow">DO</span> k = 1,nsoil</div>
<div class="line"><a id="l04001" name="l04001"></a><span class="lineno"> 4001</span>         <span class="keywordflow">IF</span> (k /= 1) ddz = zsoil(k - 1) - zsoil(k)</div>
<div class="line"><a id="l04002" name="l04002"></a><span class="lineno"> 4002</span>         sh2oout(k) = sh2oin(k) + ci(k) + wplus / ddz</div>
<div class="line"><a id="l04003" name="l04003"></a><span class="lineno"> 4003</span>         stot = sh2oout(k) + sice(k)</div>
<div class="line"><a id="l04004" name="l04004"></a><span class="lineno"> 4004</span>         <span class="keywordflow">IF</span> (stot &gt; smcmax) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l04005" name="l04005"></a><span class="lineno"> 4005</span>            <span class="keywordflow">IF</span> (k .eq. 1) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l04006" name="l04006"></a><span class="lineno"> 4006</span>               ddz = - zsoil(1)</div>
<div class="line"><a id="l04007" name="l04007"></a><span class="lineno"> 4007</span>            <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l04008" name="l04008"></a><span class="lineno"> 4008</span>               kk11 = k - 1</div>
<div class="line"><a id="l04009" name="l04009"></a><span class="lineno"> 4009</span>               ddz = - zsoil(k) + zsoil(kk11)</div>
<div class="line"><a id="l04010" name="l04010"></a><span class="lineno"> 4010</span><span class="keywordflow">            END IF</span></div>
<div class="line"><a id="l04011" name="l04011"></a><span class="lineno"> 4011</span>            wplus = (stot - smcmax) * ddz</div>
<div class="line"><a id="l04012" name="l04012"></a><span class="lineno"> 4012</span>         <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l04013" name="l04013"></a><span class="lineno"> 4013</span>            wplus = 0.</div>
<div class="line"><a id="l04014" name="l04014"></a><span class="lineno"> 4014</span><span class="keywordflow">         END IF</span></div>
<div class="line"><a id="l04015" name="l04015"></a><span class="lineno"> 4015</span>         smc(k) = max( min(stot,smcmax),0.02 )</div>
<div class="line"><a id="l04016" name="l04016"></a><span class="lineno"> 4016</span>         sh2oout(k) = max( (smc(k) - sice(k)),0.0)</div>
<div class="line"><a id="l04017" name="l04017"></a><span class="lineno"> 4017</span><span class="keywordflow">      END DO</span></div>
<div class="line"><a id="l04018" name="l04018"></a><span class="lineno"> 4018</span><span class="preprocessor">#ifdef WRF_HYDRO</span></div>
<div class="line"><a id="l04019" name="l04019"></a><span class="lineno"> 4019</span><span class="preprocessor"></span><span class="comment">!DJG NDHMS/WRF-Hydro edit...</span></div>
<div class="line"><a id="l04020" name="l04020"></a><span class="lineno"> 4020</span><span class="comment">!DJG Modifications to redstribute WPLUS/RUNOFF3 (soil moisture closure error) to soil profile</span></div>
<div class="line"><a id="l04021" name="l04021"></a><span class="lineno"> 4021</span><span class="comment">!DJG beginning at bottom layer (NSOIL)</span></div>
<div class="line"><a id="l04022" name="l04022"></a><span class="lineno"> 4022</span>         <span class="keywordflow">IF</span> (wplus &gt; 0.) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l04023" name="l04023"></a><span class="lineno"> 4023</span>           <span class="keywordflow">DO</span> k=nsoil,2,-1</div>
<div class="line"><a id="l04024" name="l04024"></a><span class="lineno"> 4024</span> </div>
<div class="line"><a id="l04025" name="l04025"></a><span class="lineno"> 4025</span>               <span class="keywordflow">IF</span> (k .eq. 2) <span class="keywordflow">THEN</span>     <span class="comment">!Assign soil depths</span></div>
<div class="line"><a id="l04026" name="l04026"></a><span class="lineno"> 4026</span>                 ddz = -zsoil(1)</div>
<div class="line"><a id="l04027" name="l04027"></a><span class="lineno"> 4027</span>               <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l04028" name="l04028"></a><span class="lineno"> 4028</span>                 ddz = zsoil(k-2)-zsoil(k-1)</div>
<div class="line"><a id="l04029" name="l04029"></a><span class="lineno"> 4029</span><span class="keywordflow">               END IF</span></div>
<div class="line"><a id="l04030" name="l04030"></a><span class="lineno"> 4030</span> </div>
<div class="line"><a id="l04031" name="l04031"></a><span class="lineno"> 4031</span>               avail = (smcmax - smc(k-1)) * ddz    <span class="comment">!Det. Avail. Stor.</span></div>
<div class="line"><a id="l04032" name="l04032"></a><span class="lineno"> 4032</span> </div>
<div class="line"><a id="l04033" name="l04033"></a><span class="lineno"> 4033</span><span class="comment">!               print *, &quot;ZZZZZ&quot;, K,DDZ,AVAIL,WPLUS,SMC(K),SMC(K-1),SMCMAX</span></div>
<div class="line"><a id="l04034" name="l04034"></a><span class="lineno"> 4034</span> </div>
<div class="line"><a id="l04035" name="l04035"></a><span class="lineno"> 4035</span>               <span class="keywordflow">IF</span> (wplus &lt;= avail) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l04036" name="l04036"></a><span class="lineno"> 4036</span>                 smc(k-1) = smc(k-1) + wplus/ddz</div>
<div class="line"><a id="l04037" name="l04037"></a><span class="lineno"> 4037</span>                 wplus = 0.</div>
<div class="line"><a id="l04038" name="l04038"></a><span class="lineno"> 4038</span>               <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l04039" name="l04039"></a><span class="lineno"> 4039</span>                 smc(k-1) = smcmax</div>
<div class="line"><a id="l04040" name="l04040"></a><span class="lineno"> 4040</span>                 wplus = wplus - avail</div>
<div class="line"><a id="l04041" name="l04041"></a><span class="lineno"> 4041</span>                 <span class="keywordflow">IF</span> (k-1 .eq. 1) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l04042" name="l04042"></a><span class="lineno"> 4042</span>                   infxs1rt = infxs1rt + wplus*1000</div>
<div class="line"><a id="l04043" name="l04043"></a><span class="lineno"> 4043</span>                   wplus = 0.</div>
<div class="line"><a id="l04044" name="l04044"></a><span class="lineno"> 4044</span><span class="keywordflow">                 END IF</span></div>
<div class="line"><a id="l04045" name="l04045"></a><span class="lineno"> 4045</span><span class="keywordflow">               END IF</span></div>
<div class="line"><a id="l04046" name="l04046"></a><span class="lineno"> 4046</span> </div>
<div class="line"><a id="l04047" name="l04047"></a><span class="lineno"> 4047</span><span class="comment">!             SMC (K) = MAX ( MIN (STOT,SMCMAX),0.02 )</span></div>
<div class="line"><a id="l04048" name="l04048"></a><span class="lineno"> 4048</span>             sh2oout(k) = max( (smc(k) - sice(k)),0.0)</div>
<div class="line"><a id="l04049" name="l04049"></a><span class="lineno"> 4049</span> </div>
<div class="line"><a id="l04050" name="l04050"></a><span class="lineno"> 4050</span><span class="keywordflow">           END DO</span></div>
<div class="line"><a id="l04051" name="l04051"></a><span class="lineno"> 4051</span><span class="keywordflow">         END IF</span></div>
<div class="line"><a id="l04052" name="l04052"></a><span class="lineno"> 4052</span><span class="comment">!DJG NDHMS/WRF-Hydro edit...End of modification</span></div>
<div class="line"><a id="l04053" name="l04053"></a><span class="lineno"> 4053</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l04054" name="l04054"></a><span class="lineno"> 4054</span><span class="preprocessor"></span> </div>
<div class="line"><a id="l04055" name="l04055"></a><span class="lineno"> 4055</span> </div>
<div class="line"><a id="l04056" name="l04056"></a><span class="lineno"> 4056</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04057" name="l04057"></a><span class="lineno"> 4057</span><span class="comment">! UPDATE CANOPY WATER CONTENT/INTERCEPTION (CMC).  CONVERT RHSCT TO</span></div>
<div class="line"><a id="l04058" name="l04058"></a><span class="lineno"> 4058</span><span class="comment">! AN &#39;AMOUNT&#39; VALUE AND ADD TO PREVIOUS CMC VALUE TO GET NEW CMC.</span></div>
<div class="line"><a id="l04059" name="l04059"></a><span class="lineno"> 4059</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04060" name="l04060"></a><span class="lineno"> 4060</span>      runoff3 = wplus</div>
<div class="line"><a id="l04061" name="l04061"></a><span class="lineno"> 4061</span>      cmc = cmc + dt * rhsct</div>
<div class="line"><a id="l04062" name="l04062"></a><span class="lineno"> 4062</span>      <span class="keywordflow">IF</span> (cmc &lt; 1.e-20) cmc = 0.0</div>
<div class="line"><a id="l04063" name="l04063"></a><span class="lineno"> 4063</span>      cmc = min(cmc,cmcmax)</div>
<div class="line"><a id="l04064" name="l04064"></a><span class="lineno"> 4064</span> </div>
<div class="line"><a id="l04065" name="l04065"></a><span class="lineno"> 4065</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04066" name="l04066"></a><span class="lineno"> 4066</span>  <span class="keyword">END SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a2e0170eed7801b6976d18285d32a1c57">sstep</a></div>
<div class="line"><a id="l04067" name="l04067"></a><span class="lineno"> 4067</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04068" name="l04068"></a><span class="lineno"> 4068</span> </div>
<div class="line"><a id="l04069" name="l04069"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#a578d0dc05848d5bc7fb823e379da5cdd"> 4069</a></span>      <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a578d0dc05848d5bc7fb823e379da5cdd">tbnd</a> (TU,TB,ZSOIL,ZBOT,K,NSOIL,TBND1)</div>
<div class="line"><a id="l04070" name="l04070"></a><span class="lineno"> 4070</span> </div>
<div class="line"><a id="l04071" name="l04071"></a><span class="lineno"> 4071</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04072" name="l04072"></a><span class="lineno"> 4072</span><span class="comment">! SUBROUTINE TBND</span></div>
<div class="line"><a id="l04073" name="l04073"></a><span class="lineno"> 4073</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04074" name="l04074"></a><span class="lineno"> 4074</span><span class="comment">! CALCULATE TEMPERATURE ON THE BOUNDARY OF THE LAYER BY INTERPOLATION OF</span></div>
<div class="line"><a id="l04075" name="l04075"></a><span class="lineno"> 4075</span><span class="comment">! THE MIDDLE LAYER TEMPERATURES</span></div>
<div class="line"><a id="l04076" name="l04076"></a><span class="lineno"> 4076</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04077" name="l04077"></a><span class="lineno"> 4077</span>      <span class="keywordtype">IMPLICIT NONE</span></div>
<div class="line"><a id="l04078" name="l04078"></a><span class="lineno"> 4078</span>      <span class="keywordtype">INTEGER</span>, <span class="keywordtype">INTENT(IN)</span>       :: NSOIL</div>
<div class="line"><a id="l04079" name="l04079"></a><span class="lineno"> 4079</span>      <span class="keywordtype">INTEGER</span>                   :: K</div>
<div class="line"><a id="l04080" name="l04080"></a><span class="lineno"> 4080</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(IN)</span>          :: TB, TU, ZBOT</div>
<div class="line"><a id="l04081" name="l04081"></a><span class="lineno"> 4081</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(OUT)</span>         :: TBND1</div>
<div class="line"><a id="l04082" name="l04082"></a><span class="lineno"> 4082</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">DIMENSION(1:NSOIL)</span>, <span class="keywordtype">INTENT(IN)</span>   :: ZSOIL</div>
<div class="line"><a id="l04083" name="l04083"></a><span class="lineno"> 4083</span><span class="keywordtype">      REAL</span>                      :: ZB, ZUP</div>
<div class="line"><a id="l04084" name="l04084"></a><span class="lineno"> 4084</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">PARAMETER</span>           :: T0 = 273.15</div>
<div class="line"><a id="l04085" name="l04085"></a><span class="lineno"> 4085</span> </div>
<div class="line"><a id="l04086" name="l04086"></a><span class="lineno"> 4086</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04087" name="l04087"></a><span class="lineno"> 4087</span><span class="comment">! USE SURFACE TEMPERATURE ON THE TOP OF THE FIRST LAYER</span></div>
<div class="line"><a id="l04088" name="l04088"></a><span class="lineno"> 4088</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04089" name="l04089"></a><span class="lineno"> 4089</span>     <span class="keywordflow">IF</span> (k == 1) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l04090" name="l04090"></a><span class="lineno"> 4090</span>         zup = 0.</div>
<div class="line"><a id="l04091" name="l04091"></a><span class="lineno"> 4091</span>      <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l04092" name="l04092"></a><span class="lineno"> 4092</span>         zup = zsoil(k -1)</div>
<div class="line"><a id="l04093" name="l04093"></a><span class="lineno"> 4093</span><span class="keywordflow">      END IF</span></div>
<div class="line"><a id="l04094" name="l04094"></a><span class="lineno"> 4094</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04095" name="l04095"></a><span class="lineno"> 4095</span><span class="comment">! USE DEPTH OF THE CONSTANT BOTTOM TEMPERATURE WHEN INTERPOLATE</span></div>
<div class="line"><a id="l04096" name="l04096"></a><span class="lineno"> 4096</span><span class="comment">! TEMPERATURE INTO THE LAST LAYER BOUNDARY</span></div>
<div class="line"><a id="l04097" name="l04097"></a><span class="lineno"> 4097</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04098" name="l04098"></a><span class="lineno"> 4098</span>      <span class="keywordflow">IF</span> (k ==  nsoil) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l04099" name="l04099"></a><span class="lineno"> 4099</span>         zb = 2.* zbot - zsoil(k)</div>
<div class="line"><a id="l04100" name="l04100"></a><span class="lineno"> 4100</span>      <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l04101" name="l04101"></a><span class="lineno"> 4101</span>         zb = zsoil(k +1)</div>
<div class="line"><a id="l04102" name="l04102"></a><span class="lineno"> 4102</span><span class="keywordflow">      END IF</span></div>
<div class="line"><a id="l04103" name="l04103"></a><span class="lineno"> 4103</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04104" name="l04104"></a><span class="lineno"> 4104</span><span class="comment">! LINEAR INTERPOLATION BETWEEN THE AVERAGE LAYER TEMPERATURES</span></div>
<div class="line"><a id="l04105" name="l04105"></a><span class="lineno"> 4105</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04106" name="l04106"></a><span class="lineno"> 4106</span> </div>
<div class="line"><a id="l04107" name="l04107"></a><span class="lineno"> 4107</span>      tbnd1 = tu + (tb - tu)* (zup - zsoil(k))/ (zup - zb)</div>
<div class="line"><a id="l04108" name="l04108"></a><span class="lineno"> 4108</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04109" name="l04109"></a><span class="lineno"> 4109</span>  <span class="keyword">END SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a578d0dc05848d5bc7fb823e379da5cdd">tbnd</a></div>
<div class="line"><a id="l04110" name="l04110"></a><span class="lineno"> 4110</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04111" name="l04111"></a><span class="lineno"> 4111</span> </div>
<div class="line"><a id="l04112" name="l04112"></a><span class="lineno"> 4112</span> </div>
<div class="line"><a id="l04113" name="l04113"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#a7946ddfb3b6fc624a9e87acbfa08fe1b"> 4113</a></span>      <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a7946ddfb3b6fc624a9e87acbfa08fe1b">tdfcnd</a> ( DF, SMC, QZ, SMCMAX, SH2O, BEXP, PSISAT, SOILTYP, OPT_THCND)</div>
<div class="line"><a id="l04114" name="l04114"></a><span class="lineno"> 4114</span> </div>
<div class="line"><a id="l04115" name="l04115"></a><span class="lineno"> 4115</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04116" name="l04116"></a><span class="lineno"> 4116</span><span class="comment">! SUBROUTINE TDFCND</span></div>
<div class="line"><a id="l04117" name="l04117"></a><span class="lineno"> 4117</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04118" name="l04118"></a><span class="lineno"> 4118</span><span class="comment">! CALCULATE THERMAL DIFFUSIVITY AND CONDUCTIVITY OF THE SOIL FOR A GIVEN</span></div>
<div class="line"><a id="l04119" name="l04119"></a><span class="lineno"> 4119</span><span class="comment">! POINT AND TIME.</span></div>
<div class="line"><a id="l04120" name="l04120"></a><span class="lineno"> 4120</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04121" name="l04121"></a><span class="lineno"> 4121</span><span class="comment">! PETERS-LIDARD APPROACH (PETERS-LIDARD et al., 1998)</span></div>
<div class="line"><a id="l04122" name="l04122"></a><span class="lineno"> 4122</span><span class="comment">! June 2001 CHANGES: FROZEN SOIL CONDITION.</span></div>
<div class="line"><a id="l04123" name="l04123"></a><span class="lineno"> 4123</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04124" name="l04124"></a><span class="lineno"> 4124</span>      <span class="keywordtype">IMPLICIT NONE</span></div>
<div class="line"><a id="l04125" name="l04125"></a><span class="lineno"> 4125</span>      <span class="keywordtype">INTEGER</span>, <span class="keywordtype">INTENT(IN)</span>       :: SOILTYP, OPT_THCND  </div>
<div class="line"><a id="l04126" name="l04126"></a><span class="lineno"> 4126</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(IN)</span>          :: QZ,  SMC, SMCMAX, SH2O, BEXP, PSISAT</div>
<div class="line"><a id="l04127" name="l04127"></a><span class="lineno"> 4127</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(OUT)</span>         :: DF</div>
<div class="line"><a id="l04128" name="l04128"></a><span class="lineno"> 4128</span><span class="keywordtype">      REAL</span>                      :: AKE, GAMMD, THKDRY, THKICE, THKO,    &amp;</div>
<div class="line"><a id="l04129" name="l04129"></a><span class="lineno"> 4129</span>                                   THKQTZ,THKSAT,THKS,THKW,SATRATIO,XU, &amp;</div>
<div class="line"><a id="l04130" name="l04130"></a><span class="lineno"> 4130</span>                                   XUNFROZ,AKEI,AKEL,PSIF,PF  </div>
<div class="line"><a id="l04131" name="l04131"></a><span class="lineno"> 4131</span> </div>
<div class="line"><a id="l04132" name="l04132"></a><span class="lineno"> 4132</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04133" name="l04133"></a><span class="lineno"> 4133</span><span class="comment">! WE NOW GET QUARTZ AS AN INPUT ARGUMENT (SET IN ROUTINE REDPRM):</span></div>
<div class="line"><a id="l04134" name="l04134"></a><span class="lineno"> 4134</span><span class="comment">!      DATA QUARTZ /0.82, 0.10, 0.25, 0.60, 0.52,</span></div>
<div class="line"><a id="l04135" name="l04135"></a><span class="lineno"> 4135</span><span class="comment">!     &amp;             0.35, 0.60, 0.40, 0.82/</span></div>
<div class="line"><a id="l04136" name="l04136"></a><span class="lineno"> 4136</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04137" name="l04137"></a><span class="lineno"> 4137</span><span class="comment">! IF THE SOIL HAS ANY MOISTURE CONTENT COMPUTE A PARTIAL SUM/PRODUCT</span></div>
<div class="line"><a id="l04138" name="l04138"></a><span class="lineno"> 4138</span><span class="comment">! OTHERWISE USE A CONSTANT VALUE WHICH WORKS WELL WITH MOST SOILS</span></div>
<div class="line"><a id="l04139" name="l04139"></a><span class="lineno"> 4139</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04140" name="l04140"></a><span class="lineno"> 4140</span><span class="comment">!  THKW ......WATER THERMAL CONDUCTIVITY</span></div>
<div class="line"><a id="l04141" name="l04141"></a><span class="lineno"> 4141</span><span class="comment">!  THKQTZ ....THERMAL CONDUCTIVITY FOR QUARTZ</span></div>
<div class="line"><a id="l04142" name="l04142"></a><span class="lineno"> 4142</span><span class="comment">!  THKO ......THERMAL CONDUCTIVITY FOR OTHER SOIL COMPONENTS</span></div>
<div class="line"><a id="l04143" name="l04143"></a><span class="lineno"> 4143</span><span class="comment">!  THKS ......THERMAL CONDUCTIVITY FOR THE SOLIDS COMBINED(QUARTZ+OTHER)</span></div>
<div class="line"><a id="l04144" name="l04144"></a><span class="lineno"> 4144</span><span class="comment">!  THKICE ....ICE THERMAL CONDUCTIVITY</span></div>
<div class="line"><a id="l04145" name="l04145"></a><span class="lineno"> 4145</span><span class="comment">!  SMCMAX ....POROSITY (= SMCMAX)</span></div>
<div class="line"><a id="l04146" name="l04146"></a><span class="lineno"> 4146</span><span class="comment">!  QZ .........QUARTZ CONTENT (SOIL TYPE DEPENDENT)</span></div>
<div class="line"><a id="l04147" name="l04147"></a><span class="lineno"> 4147</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04148" name="l04148"></a><span class="lineno"> 4148</span><span class="comment">! USE AS IN PETERS-LIDARD, 1998 (MODIF. FROM JOHANSEN, 1975).</span></div>
<div class="line"><a id="l04149" name="l04149"></a><span class="lineno"> 4149</span> </div>
<div class="line"><a id="l04150" name="l04150"></a><span class="lineno"> 4150</span><span class="comment">!                                  PABLO GRUNMANN, 08/17/98</span></div>
<div class="line"><a id="l04151" name="l04151"></a><span class="lineno"> 4151</span><span class="comment">! REFS.:</span></div>
<div class="line"><a id="l04152" name="l04152"></a><span class="lineno"> 4152</span><span class="comment">!      FAROUKI, O.T.,1986: THERMAL PROPERTIES OF SOILS. SERIES ON ROCK</span></div>
<div class="line"><a id="l04153" name="l04153"></a><span class="lineno"> 4153</span><span class="comment">!              AND SOIL MECHANICS, VOL. 11, TRANS TECH, 136 PP.</span></div>
<div class="line"><a id="l04154" name="l04154"></a><span class="lineno"> 4154</span><span class="comment">!      JOHANSEN, O., 1975: THERMAL CONDUCTIVITY OF SOILS. PH.D. THESIS,</span></div>
<div class="line"><a id="l04155" name="l04155"></a><span class="lineno"> 4155</span><span class="comment">!              UNIVERSITY OF TRONDHEIM,</span></div>
<div class="line"><a id="l04156" name="l04156"></a><span class="lineno"> 4156</span><span class="comment">!      PETERS-LIDARD, C. D., ET AL., 1998: THE EFFECT OF SOIL THERMAL</span></div>
<div class="line"><a id="l04157" name="l04157"></a><span class="lineno"> 4157</span><span class="comment">!              CONDUCTIVITY PARAMETERIZATION ON SURFACE ENERGY FLUXES</span></div>
<div class="line"><a id="l04158" name="l04158"></a><span class="lineno"> 4158</span><span class="comment">!              AND TEMPERATURES. JOURNAL OF THE ATMOSPHERIC SCIENCES,</span></div>
<div class="line"><a id="l04159" name="l04159"></a><span class="lineno"> 4159</span><span class="comment">!              VOL. 55, PP. 1209-1224.</span></div>
<div class="line"><a id="l04160" name="l04160"></a><span class="lineno"> 4160</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04161" name="l04161"></a><span class="lineno"> 4161</span> </div>
<div class="line"><a id="l04162" name="l04162"></a><span class="lineno"> 4162</span><span class="keywordflow">IF</span> ( opt_thcnd == 1 .OR. ( opt_thcnd == 2 .AND. (soiltyp /= 4 .AND. soiltyp /= 3)) )<span class="keywordflow">THEN</span></div>
<div class="line"><a id="l04163" name="l04163"></a><span class="lineno"> 4163</span> </div>
<div class="line"><a id="l04164" name="l04164"></a><span class="lineno"> 4164</span><span class="comment">! NEEDS PARAMETERS</span></div>
<div class="line"><a id="l04165" name="l04165"></a><span class="lineno"> 4165</span><span class="comment">! POROSITY(SOIL TYPE):</span></div>
<div class="line"><a id="l04166" name="l04166"></a><span class="lineno"> 4166</span><span class="comment">!      POROS = SMCMAX</span></div>
<div class="line"><a id="l04167" name="l04167"></a><span class="lineno"> 4167</span><span class="comment">! SATURATION RATIO:</span></div>
<div class="line"><a id="l04168" name="l04168"></a><span class="lineno"> 4168</span><span class="comment">! PARAMETERS  W/(M.K)</span></div>
<div class="line"><a id="l04169" name="l04169"></a><span class="lineno"> 4169</span>      satratio = smc / smcmax</div>
<div class="line"><a id="l04170" name="l04170"></a><span class="lineno"> 4170</span><span class="comment">! ICE CONDUCTIVITY:</span></div>
<div class="line"><a id="l04171" name="l04171"></a><span class="lineno"> 4171</span>      thkice = 2.2</div>
<div class="line"><a id="l04172" name="l04172"></a><span class="lineno"> 4172</span><span class="comment">! WATER CONDUCTIVITY:</span></div>
<div class="line"><a id="l04173" name="l04173"></a><span class="lineno"> 4173</span>      thkw = 0.57</div>
<div class="line"><a id="l04174" name="l04174"></a><span class="lineno"> 4174</span><span class="comment">! THERMAL CONDUCTIVITY OF &quot;OTHER&quot; SOIL COMPONENTS</span></div>
<div class="line"><a id="l04175" name="l04175"></a><span class="lineno"> 4175</span><span class="comment">!      IF (QZ .LE. 0.2) THKO = 3.0</span></div>
<div class="line"><a id="l04176" name="l04176"></a><span class="lineno"> 4176</span>      thko = 2.0</div>
<div class="line"><a id="l04177" name="l04177"></a><span class="lineno"> 4177</span><span class="comment">! QUARTZ&#39; CONDUCTIVITY</span></div>
<div class="line"><a id="l04178" name="l04178"></a><span class="lineno"> 4178</span>      thkqtz = 7.7</div>
<div class="line"><a id="l04179" name="l04179"></a><span class="lineno"> 4179</span><span class="comment">! SOLIDS&#39; CONDUCTIVITY</span></div>
<div class="line"><a id="l04180" name="l04180"></a><span class="lineno"> 4180</span>      thks = (thkqtz ** qz)* (thko ** (1. - qz))</div>
<div class="line"><a id="l04181" name="l04181"></a><span class="lineno"> 4181</span> </div>
<div class="line"><a id="l04182" name="l04182"></a><span class="lineno"> 4182</span><span class="comment">! UNFROZEN FRACTION (FROM 1., i.e., 100%LIQUID, TO 0. (100% FROZEN))</span></div>
<div class="line"><a id="l04183" name="l04183"></a><span class="lineno"> 4183</span>      xunfroz = sh2o / smc</div>
<div class="line"><a id="l04184" name="l04184"></a><span class="lineno"> 4184</span><span class="comment">! UNFROZEN VOLUME FOR SATURATION (POROSITY*XUNFROZ)</span></div>
<div class="line"><a id="l04185" name="l04185"></a><span class="lineno"> 4185</span>      xu = xunfroz * smcmax</div>
<div class="line"><a id="l04186" name="l04186"></a><span class="lineno"> 4186</span> </div>
<div class="line"><a id="l04187" name="l04187"></a><span class="lineno"> 4187</span><span class="comment">! SATURATED THERMAL CONDUCTIVITY</span></div>
<div class="line"><a id="l04188" name="l04188"></a><span class="lineno"> 4188</span>      thksat = thks ** (1. - smcmax)* thkice ** (smcmax - xu)* thkw **   &amp;</div>
<div class="line"><a id="l04189" name="l04189"></a><span class="lineno"> 4189</span>         (xu)</div>
<div class="line"><a id="l04190" name="l04190"></a><span class="lineno"> 4190</span> </div>
<div class="line"><a id="l04191" name="l04191"></a><span class="lineno"> 4191</span><span class="comment">! DRY DENSITY IN KG/M3</span></div>
<div class="line"><a id="l04192" name="l04192"></a><span class="lineno"> 4192</span>      gammd = (1. - smcmax)*2700.</div>
<div class="line"><a id="l04193" name="l04193"></a><span class="lineno"> 4193</span> </div>
<div class="line"><a id="l04194" name="l04194"></a><span class="lineno"> 4194</span><span class="comment">! DRY THERMAL CONDUCTIVITY IN W.M-1.K-1</span></div>
<div class="line"><a id="l04195" name="l04195"></a><span class="lineno"> 4195</span>      thkdry = (0.135* gammd+ 64.7)/ (2700. - 0.947* gammd)</div>
<div class="line"><a id="l04196" name="l04196"></a><span class="lineno"> 4196</span><span class="comment">! FROZEN</span></div>
<div class="line"><a id="l04197" name="l04197"></a><span class="lineno"> 4197</span>         akei = satratio</div>
<div class="line"><a id="l04198" name="l04198"></a><span class="lineno"> 4198</span><span class="comment">! UNFROZEN</span></div>
<div class="line"><a id="l04199" name="l04199"></a><span class="lineno"> 4199</span><span class="comment">! RANGE OF VALIDITY FOR THE KERSTEN NUMBER (AKE)</span></div>
<div class="line"><a id="l04200" name="l04200"></a><span class="lineno"> 4200</span> </div>
<div class="line"><a id="l04201" name="l04201"></a><span class="lineno"> 4201</span><span class="comment">! KERSTEN NUMBER (USING &quot;FINE&quot; FORMULA, VALID FOR SOILS CONTAINING AT</span></div>
<div class="line"><a id="l04202" name="l04202"></a><span class="lineno"> 4202</span><span class="comment">! LEAST 5% OF PARTICLES WITH DIAMETER LESS THAN 2.E-6 METERS.)</span></div>
<div class="line"><a id="l04203" name="l04203"></a><span class="lineno"> 4203</span><span class="comment">! (FOR &quot;COARSE&quot; FORMULA, SEE PETERS-LIDARD ET AL., 1998).</span></div>
<div class="line"><a id="l04204" name="l04204"></a><span class="lineno"> 4204</span> </div>
<div class="line"><a id="l04205" name="l04205"></a><span class="lineno"> 4205</span>         <span class="keywordflow">IF</span> ( satratio &gt;  0.1 ) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l04206" name="l04206"></a><span class="lineno"> 4206</span> </div>
<div class="line"><a id="l04207" name="l04207"></a><span class="lineno"> 4207</span>            akel = log10(satratio) + 1.0</div>
<div class="line"><a id="l04208" name="l04208"></a><span class="lineno"> 4208</span> </div>
<div class="line"><a id="l04209" name="l04209"></a><span class="lineno"> 4209</span><span class="comment">! USE K = KDRY</span></div>
<div class="line"><a id="l04210" name="l04210"></a><span class="lineno"> 4210</span>         <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l04211" name="l04211"></a><span class="lineno"> 4211</span> </div>
<div class="line"><a id="l04212" name="l04212"></a><span class="lineno"> 4212</span>            akel = 0.0</div>
<div class="line"><a id="l04213" name="l04213"></a><span class="lineno"> 4213</span><span class="keywordflow">         END IF</span></div>
<div class="line"><a id="l04214" name="l04214"></a><span class="lineno"> 4214</span>      ake = ((smc-sh2o)*akei + sh2o*akel)/smc</div>
<div class="line"><a id="l04215" name="l04215"></a><span class="lineno"> 4215</span><span class="comment">!  THERMAL CONDUCTIVITY</span></div>
<div class="line"><a id="l04216" name="l04216"></a><span class="lineno"> 4216</span> </div>
<div class="line"><a id="l04217" name="l04217"></a><span class="lineno"> 4217</span> </div>
<div class="line"><a id="l04218" name="l04218"></a><span class="lineno"> 4218</span>      df = ake * (thksat - thkdry) + thkdry</div>
<div class="line"><a id="l04219" name="l04219"></a><span class="lineno"> 4219</span> </div>
<div class="line"><a id="l04220" name="l04220"></a><span class="lineno"> 4220</span>    <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l04221" name="l04221"></a><span class="lineno"> 4221</span> </div>
<div class="line"><a id="l04222" name="l04222"></a><span class="lineno"> 4222</span><span class="comment">! use the Mccumber and Pielke approach for silt loam (4), sandy loam (3)</span></div>
<div class="line"><a id="l04223" name="l04223"></a><span class="lineno"> 4223</span> </div>
<div class="line"><a id="l04224" name="l04224"></a><span class="lineno"> 4224</span>         psif = psisat*100.*(smcmax/(smc))**bexp</div>
<div class="line"><a id="l04225" name="l04225"></a><span class="lineno"> 4225</span><span class="comment">!--- PSIF should be in [CM] to compute PF</span></div>
<div class="line"><a id="l04226" name="l04226"></a><span class="lineno"> 4226</span>           pf=log10(abs(psif))</div>
<div class="line"><a id="l04227" name="l04227"></a><span class="lineno"> 4227</span><span class="comment">!--- HK is for McCumber thermal conductivity</span></div>
<div class="line"><a id="l04228" name="l04228"></a><span class="lineno"> 4228</span>         <span class="keywordflow">IF</span>(pf.LE.5.1) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l04229" name="l04229"></a><span class="lineno"> 4229</span>           df=420.*exp(-(pf+2.7))</div>
<div class="line"><a id="l04230" name="l04230"></a><span class="lineno"> 4230</span>         <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l04231" name="l04231"></a><span class="lineno"> 4231</span>           df=.1744</div>
<div class="line"><a id="l04232" name="l04232"></a><span class="lineno"> 4232</span><span class="keywordflow">         END IF</span></div>
<div class="line"><a id="l04233" name="l04233"></a><span class="lineno"> 4233</span> </div>
<div class="line"><a id="l04234" name="l04234"></a><span class="lineno"> 4234</span><span class="keywordflow">    ENDIF</span>  <span class="comment">! for OPT_THCND OPTIONS             </span></div>
<div class="line"><a id="l04235" name="l04235"></a><span class="lineno"> 4235</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04236" name="l04236"></a><span class="lineno"> 4236</span>  <span class="keyword">END SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a7946ddfb3b6fc624a9e87acbfa08fe1b">tdfcnd</a></div>
<div class="line"><a id="l04237" name="l04237"></a><span class="lineno"> 4237</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04238" name="l04238"></a><span class="lineno"> 4238</span> </div>
<div class="line"><a id="l04239" name="l04239"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#ab786b4f52dbea2106470993f2ea20e69"> 4239</a></span>      <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ab786b4f52dbea2106470993f2ea20e69">tmpavg</a> (TAVG,TUP,TM,TDN,ZSOIL,NSOIL,K)</div>
<div class="line"><a id="l04240" name="l04240"></a><span class="lineno"> 4240</span> </div>
<div class="line"><a id="l04241" name="l04241"></a><span class="lineno"> 4241</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04242" name="l04242"></a><span class="lineno"> 4242</span><span class="comment">! SUBROUTINE TMPAVG</span></div>
<div class="line"><a id="l04243" name="l04243"></a><span class="lineno"> 4243</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04244" name="l04244"></a><span class="lineno"> 4244</span><span class="comment">! CALCULATE SOIL LAYER AVERAGE TEMPERATURE (TAVG) IN FREEZING/THAWING</span></div>
<div class="line"><a id="l04245" name="l04245"></a><span class="lineno"> 4245</span><span class="comment">! LAYER USING UP, DOWN, AND MIDDLE LAYER TEMPERATURES (TUP, TDN, TM),</span></div>
<div class="line"><a id="l04246" name="l04246"></a><span class="lineno"> 4246</span><span class="comment">! WHERE TUP IS AT TOP BOUNDARY OF LAYER, TDN IS AT BOTTOM BOUNDARY OF</span></div>
<div class="line"><a id="l04247" name="l04247"></a><span class="lineno"> 4247</span><span class="comment">! LAYER.  TM IS LAYER PROGNOSTIC STATE TEMPERATURE.</span></div>
<div class="line"><a id="l04248" name="l04248"></a><span class="lineno"> 4248</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04249" name="l04249"></a><span class="lineno"> 4249</span>      <span class="keywordtype">IMPLICIT NONE</span></div>
<div class="line"><a id="l04250" name="l04250"></a><span class="lineno"> 4250</span>      <span class="keywordtype">INTEGER</span>  K</div>
<div class="line"><a id="l04251" name="l04251"></a><span class="lineno"> 4251</span> </div>
<div class="line"><a id="l04252" name="l04252"></a><span class="lineno"> 4252</span>      <span class="keywordtype">INTEGER</span>  NSOIL</div>
<div class="line"><a id="l04253" name="l04253"></a><span class="lineno"> 4253</span><span class="keywordtype">      REAL</span>     DZ</div>
<div class="line"><a id="l04254" name="l04254"></a><span class="lineno"> 4254</span><span class="keywordtype">      REAL</span>     DZH</div>
<div class="line"><a id="l04255" name="l04255"></a><span class="lineno"> 4255</span><span class="keywordtype">      REAL</span>     T0</div>
<div class="line"><a id="l04256" name="l04256"></a><span class="lineno"> 4256</span><span class="keywordtype">      REAL</span>     TAVG</div>
<div class="line"><a id="l04257" name="l04257"></a><span class="lineno"> 4257</span><span class="keywordtype">      REAL</span>     TDN</div>
<div class="line"><a id="l04258" name="l04258"></a><span class="lineno"> 4258</span><span class="keywordtype">      REAL</span>     TM</div>
<div class="line"><a id="l04259" name="l04259"></a><span class="lineno"> 4259</span><span class="keywordtype">      REAL</span>     TUP</div>
<div class="line"><a id="l04260" name="l04260"></a><span class="lineno"> 4260</span><span class="keywordtype">      REAL</span>     X0</div>
<div class="line"><a id="l04261" name="l04261"></a><span class="lineno"> 4261</span><span class="keywordtype">      REAL</span>     XDN</div>
<div class="line"><a id="l04262" name="l04262"></a><span class="lineno"> 4262</span><span class="keywordtype">      REAL</span>     XUP</div>
<div class="line"><a id="l04263" name="l04263"></a><span class="lineno"> 4263</span> </div>
<div class="line"><a id="l04264" name="l04264"></a><span class="lineno"> 4264</span><span class="keywordtype">      REAL</span>     ZSOIL (NSOIL)</div>
<div class="line"><a id="l04265" name="l04265"></a><span class="lineno"> 4265</span> </div>
<div class="line"><a id="l04266" name="l04266"></a><span class="lineno"> 4266</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04267" name="l04267"></a><span class="lineno"> 4267</span>      parameter(t0 = 2.7315e2)</div>
<div class="line"><a id="l04268" name="l04268"></a><span class="lineno"> 4268</span>      <span class="keywordflow">IF</span> (k .eq. 1) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l04269" name="l04269"></a><span class="lineno"> 4269</span>         dz = - zsoil(1)</div>
<div class="line"><a id="l04270" name="l04270"></a><span class="lineno"> 4270</span>      <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l04271" name="l04271"></a><span class="lineno"> 4271</span>         dz = zsoil(k -1) - zsoil(k)</div>
<div class="line"><a id="l04272" name="l04272"></a><span class="lineno"> 4272</span><span class="keywordflow">      END IF</span></div>
<div class="line"><a id="l04273" name="l04273"></a><span class="lineno"> 4273</span> </div>
<div class="line"><a id="l04274" name="l04274"></a><span class="lineno"> 4274</span>      dzh = dz *0.5</div>
<div class="line"><a id="l04275" name="l04275"></a><span class="lineno"> 4275</span>      <span class="keywordflow">IF</span> (tup .lt. t0) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l04276" name="l04276"></a><span class="lineno"> 4276</span>         <span class="keywordflow">IF</span> (tm .lt. t0) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l04277" name="l04277"></a><span class="lineno"> 4277</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04278" name="l04278"></a><span class="lineno"> 4278</span><span class="comment">! TUP, TM, TDN &lt; T0</span></div>
<div class="line"><a id="l04279" name="l04279"></a><span class="lineno"> 4279</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04280" name="l04280"></a><span class="lineno"> 4280</span>            <span class="keywordflow">IF</span> (tdn .lt. t0) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l04281" name="l04281"></a><span class="lineno"> 4281</span>               tavg = (tup + 2.0* tm + tdn)/ 4.0</div>
<div class="line"><a id="l04282" name="l04282"></a><span class="lineno"> 4282</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04283" name="l04283"></a><span class="lineno"> 4283</span><span class="comment">! TUP &amp; TM &lt; T0,  TDN .ge. T0</span></div>
<div class="line"><a id="l04284" name="l04284"></a><span class="lineno"> 4284</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04285" name="l04285"></a><span class="lineno"> 4285</span>            <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l04286" name="l04286"></a><span class="lineno"> 4286</span>               x0 = (t0- tm) * dzh / (tdn - tm)</div>
<div class="line"><a id="l04287" name="l04287"></a><span class="lineno"> 4287</span>               tavg = 0.5 * (tup * dzh + tm * (dzh + x0) + t0* (        &amp;</div>
<div class="line"><a id="l04288" name="l04288"></a><span class="lineno"> 4288</span>     &amp;               2.* dzh - x0)) / dz</div>
<div class="line"><a id="l04289" name="l04289"></a><span class="lineno"> 4289</span><span class="keywordflow">            END IF</span></div>
<div class="line"><a id="l04290" name="l04290"></a><span class="lineno"> 4290</span>         <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l04291" name="l04291"></a><span class="lineno"> 4291</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04292" name="l04292"></a><span class="lineno"> 4292</span><span class="comment">! TUP &lt; T0, TM .ge. T0, TDN &lt; T0</span></div>
<div class="line"><a id="l04293" name="l04293"></a><span class="lineno"> 4293</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04294" name="l04294"></a><span class="lineno"> 4294</span>            <span class="keywordflow">IF</span> (tdn .lt. t0) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l04295" name="l04295"></a><span class="lineno"> 4295</span>               xup = (t0- tup) * dzh / (tm - tup)</div>
<div class="line"><a id="l04296" name="l04296"></a><span class="lineno"> 4296</span>               xdn = dzh - (t0- tm) * dzh / (tdn - tm)</div>
<div class="line"><a id="l04297" name="l04297"></a><span class="lineno"> 4297</span>               tavg = 0.5 * (tup * xup + t0* (2.* dz - xup - xdn)       &amp;</div>
<div class="line"><a id="l04298" name="l04298"></a><span class="lineno"> 4298</span>     &amp;                + tdn * xdn) / dz</div>
<div class="line"><a id="l04299" name="l04299"></a><span class="lineno"> 4299</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04300" name="l04300"></a><span class="lineno"> 4300</span><span class="comment">! TUP &lt; T0, TM .ge. T0, TDN .ge. T0</span></div>
<div class="line"><a id="l04301" name="l04301"></a><span class="lineno"> 4301</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04302" name="l04302"></a><span class="lineno"> 4302</span>            <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l04303" name="l04303"></a><span class="lineno"> 4303</span>               xup = (t0- tup) * dzh / (tm - tup)</div>
<div class="line"><a id="l04304" name="l04304"></a><span class="lineno"> 4304</span>               tavg = 0.5 * (tup * xup + t0* (2.* dz - xup)) / dz</div>
<div class="line"><a id="l04305" name="l04305"></a><span class="lineno"> 4305</span><span class="keywordflow">            END IF</span></div>
<div class="line"><a id="l04306" name="l04306"></a><span class="lineno"> 4306</span><span class="keywordflow">         END IF</span></div>
<div class="line"><a id="l04307" name="l04307"></a><span class="lineno"> 4307</span>      <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l04308" name="l04308"></a><span class="lineno"> 4308</span>         <span class="keywordflow">IF</span> (tm .lt. t0) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l04309" name="l04309"></a><span class="lineno"> 4309</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04310" name="l04310"></a><span class="lineno"> 4310</span><span class="comment">! TUP .ge. T0, TM &lt; T0, TDN &lt; T0</span></div>
<div class="line"><a id="l04311" name="l04311"></a><span class="lineno"> 4311</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04312" name="l04312"></a><span class="lineno"> 4312</span>            <span class="keywordflow">IF</span> (tdn .lt. t0) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l04313" name="l04313"></a><span class="lineno"> 4313</span>               xup = dzh - (t0- tup) * dzh / (tm - tup)</div>
<div class="line"><a id="l04314" name="l04314"></a><span class="lineno"> 4314</span>               tavg = 0.5 * (t0* (dz - xup) + tm * (dzh + xup)          &amp;</div>
<div class="line"><a id="l04315" name="l04315"></a><span class="lineno"> 4315</span>     &amp;                + tdn * dzh) / dz</div>
<div class="line"><a id="l04316" name="l04316"></a><span class="lineno"> 4316</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04317" name="l04317"></a><span class="lineno"> 4317</span><span class="comment">! TUP .ge. T0, TM &lt; T0, TDN .ge. T0</span></div>
<div class="line"><a id="l04318" name="l04318"></a><span class="lineno"> 4318</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04319" name="l04319"></a><span class="lineno"> 4319</span>            <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l04320" name="l04320"></a><span class="lineno"> 4320</span>               xup = dzh - (t0- tup) * dzh / (tm - tup)</div>
<div class="line"><a id="l04321" name="l04321"></a><span class="lineno"> 4321</span>               xdn = (t0- tm) * dzh / (tdn - tm)</div>
<div class="line"><a id="l04322" name="l04322"></a><span class="lineno"> 4322</span>               tavg = 0.5 * (t0* (2.* dz - xup - xdn) + tm *            &amp;</div>
<div class="line"><a id="l04323" name="l04323"></a><span class="lineno"> 4323</span>     &amp; (xup + xdn)) / dz</div>
<div class="line"><a id="l04324" name="l04324"></a><span class="lineno"> 4324</span><span class="keywordflow">            END IF</span></div>
<div class="line"><a id="l04325" name="l04325"></a><span class="lineno"> 4325</span>         <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l04326" name="l04326"></a><span class="lineno"> 4326</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04327" name="l04327"></a><span class="lineno"> 4327</span><span class="comment">! TUP .ge. T0, TM .ge. T0, TDN &lt; T0</span></div>
<div class="line"><a id="l04328" name="l04328"></a><span class="lineno"> 4328</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04329" name="l04329"></a><span class="lineno"> 4329</span>            <span class="keywordflow">IF</span> (tdn .lt. t0) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l04330" name="l04330"></a><span class="lineno"> 4330</span>               xdn = dzh - (t0- tm) * dzh / (tdn - tm)</div>
<div class="line"><a id="l04331" name="l04331"></a><span class="lineno"> 4331</span>               tavg = (t0* (dz - xdn) +0.5* (t0+ tdn)* xdn) / dz</div>
<div class="line"><a id="l04332" name="l04332"></a><span class="lineno"> 4332</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04333" name="l04333"></a><span class="lineno"> 4333</span><span class="comment">! TUP .ge. T0, TM .ge. T0, TDN .ge. T0</span></div>
<div class="line"><a id="l04334" name="l04334"></a><span class="lineno"> 4334</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04335" name="l04335"></a><span class="lineno"> 4335</span>            <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l04336" name="l04336"></a><span class="lineno"> 4336</span>               tavg = (tup + 2.0* tm + tdn) / 4.0</div>
<div class="line"><a id="l04337" name="l04337"></a><span class="lineno"> 4337</span><span class="keywordflow">            END IF</span></div>
<div class="line"><a id="l04338" name="l04338"></a><span class="lineno"> 4338</span><span class="keywordflow">         END IF</span></div>
<div class="line"><a id="l04339" name="l04339"></a><span class="lineno"> 4339</span><span class="keywordflow">      END IF</span></div>
<div class="line"><a id="l04340" name="l04340"></a><span class="lineno"> 4340</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04341" name="l04341"></a><span class="lineno"> 4341</span>  <span class="keyword">END SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#ab786b4f52dbea2106470993f2ea20e69">tmpavg</a></div>
<div class="line"><a id="l04342" name="l04342"></a><span class="lineno"> 4342</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04343" name="l04343"></a><span class="lineno"> 4343</span> </div>
<div class="line"><a id="l04344" name="l04344"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#aa418d6be3fc3de942821faf6fb68e3f8"> 4344</a></span>      <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#aa418d6be3fc3de942821faf6fb68e3f8">transp</a> (ET,NSOIL,ETP1,SMC,CMC,ZSOIL,SHDFAC,SMCWLT,     &amp;</div>
<div class="line"><a id="l04345" name="l04345"></a><span class="lineno"> 4345</span>     &amp;                      CMCMAX,PC,CFACTR,SMCREF,SFCTMP,Q2,NROOT,    &amp;</div>
<div class="line"><a id="l04346" name="l04346"></a><span class="lineno"> 4346</span>     &amp;                      RTDIS)</div>
<div class="line"><a id="l04347" name="l04347"></a><span class="lineno"> 4347</span> </div>
<div class="line"><a id="l04348" name="l04348"></a><span class="lineno"> 4348</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04349" name="l04349"></a><span class="lineno"> 4349</span><span class="comment">! SUBROUTINE TRANSP</span></div>
<div class="line"><a id="l04350" name="l04350"></a><span class="lineno"> 4350</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04351" name="l04351"></a><span class="lineno"> 4351</span><span class="comment">! CALCULATE TRANSPIRATION FOR THE VEG CLASS.</span></div>
<div class="line"><a id="l04352" name="l04352"></a><span class="lineno"> 4352</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04353" name="l04353"></a><span class="lineno"> 4353</span>      <span class="keywordtype">IMPLICIT NONE</span></div>
<div class="line"><a id="l04354" name="l04354"></a><span class="lineno"> 4354</span>      <span class="keywordtype">INTEGER</span>  I</div>
<div class="line"><a id="l04355" name="l04355"></a><span class="lineno"> 4355</span>      <span class="keywordtype">INTEGER</span>  K</div>
<div class="line"><a id="l04356" name="l04356"></a><span class="lineno"> 4356</span>      <span class="keywordtype">INTEGER</span>  NSOIL</div>
<div class="line"><a id="l04357" name="l04357"></a><span class="lineno"> 4357</span> </div>
<div class="line"><a id="l04358" name="l04358"></a><span class="lineno"> 4358</span>      <span class="keywordtype">INTEGER</span>  NROOT</div>
<div class="line"><a id="l04359" name="l04359"></a><span class="lineno"> 4359</span><span class="keywordtype">      REAL</span>     CFACTR</div>
<div class="line"><a id="l04360" name="l04360"></a><span class="lineno"> 4360</span><span class="keywordtype">      REAL</span>     CMC</div>
<div class="line"><a id="l04361" name="l04361"></a><span class="lineno"> 4361</span><span class="keywordtype">      REAL</span>     CMCMAX</div>
<div class="line"><a id="l04362" name="l04362"></a><span class="lineno"> 4362</span><span class="keywordtype">      REAL</span>     DENOM</div>
<div class="line"><a id="l04363" name="l04363"></a><span class="lineno"> 4363</span><span class="keywordtype">      REAL</span>     ET (NSOIL)</div>
<div class="line"><a id="l04364" name="l04364"></a><span class="lineno"> 4364</span><span class="keywordtype">      REAL</span>     ETP1</div>
<div class="line"><a id="l04365" name="l04365"></a><span class="lineno"> 4365</span><span class="keywordtype">      REAL</span>     ETP1A</div>
<div class="line"><a id="l04366" name="l04366"></a><span class="lineno"> 4366</span><span class="comment">!.....REAL PART(NSOIL)</span></div>
<div class="line"><a id="l04367" name="l04367"></a><span class="lineno"> 4367</span><span class="keywordtype">      REAL</span>     GX (NROOT)</div>
<div class="line"><a id="l04368" name="l04368"></a><span class="lineno"> 4368</span><span class="keywordtype">      REAL</span>     PC</div>
<div class="line"><a id="l04369" name="l04369"></a><span class="lineno"> 4369</span><span class="keywordtype">      REAL</span>     Q2</div>
<div class="line"><a id="l04370" name="l04370"></a><span class="lineno"> 4370</span><span class="keywordtype">      REAL</span>     RTDIS (NSOIL)</div>
<div class="line"><a id="l04371" name="l04371"></a><span class="lineno"> 4371</span><span class="keywordtype">      REAL</span>     RTX</div>
<div class="line"><a id="l04372" name="l04372"></a><span class="lineno"> 4372</span><span class="keywordtype">      REAL</span>     SFCTMP</div>
<div class="line"><a id="l04373" name="l04373"></a><span class="lineno"> 4373</span><span class="keywordtype">      REAL</span>     SGX</div>
<div class="line"><a id="l04374" name="l04374"></a><span class="lineno"> 4374</span><span class="keywordtype">      REAL</span>     SHDFAC</div>
<div class="line"><a id="l04375" name="l04375"></a><span class="lineno"> 4375</span><span class="keywordtype">      REAL</span>     SMC (NSOIL)</div>
<div class="line"><a id="l04376" name="l04376"></a><span class="lineno"> 4376</span><span class="keywordtype">      REAL</span>     SMCREF</div>
<div class="line"><a id="l04377" name="l04377"></a><span class="lineno"> 4377</span><span class="keywordtype">      REAL</span>     SMCWLT</div>
<div class="line"><a id="l04378" name="l04378"></a><span class="lineno"> 4378</span> </div>
<div class="line"><a id="l04379" name="l04379"></a><span class="lineno"> 4379</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04380" name="l04380"></a><span class="lineno"> 4380</span><span class="comment">! INITIALIZE PLANT TRANSP TO ZERO FOR ALL SOIL LAYERS.</span></div>
<div class="line"><a id="l04381" name="l04381"></a><span class="lineno"> 4381</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04382" name="l04382"></a><span class="lineno"> 4382</span><span class="keywordtype">      REAL</span>     ZSOIL (NSOIL)</div>
<div class="line"><a id="l04383" name="l04383"></a><span class="lineno"> 4383</span>      <span class="keywordflow">DO</span> k = 1,nsoil</div>
<div class="line"><a id="l04384" name="l04384"></a><span class="lineno"> 4384</span>         et(k) = 0.</div>
<div class="line"><a id="l04385" name="l04385"></a><span class="lineno"> 4385</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04386" name="l04386"></a><span class="lineno"> 4386</span><span class="comment">! CALCULATE AN &#39;ADJUSTED&#39; POTENTIAL TRANSPIRATION</span></div>
<div class="line"><a id="l04387" name="l04387"></a><span class="lineno"> 4387</span><span class="comment">! IF STATEMENT BELOW TO AVOID TANGENT LINEAR PROBLEMS NEAR ZERO</span></div>
<div class="line"><a id="l04388" name="l04388"></a><span class="lineno"> 4388</span><span class="comment">! NOTE: GX AND OTHER TERMS BELOW REDISTRIBUTE TRANSPIRATION BY LAYER,</span></div>
<div class="line"><a id="l04389" name="l04389"></a><span class="lineno"> 4389</span><span class="comment">! ET(K), AS A FUNCTION OF SOIL MOISTURE AVAILABILITY, WHILE PRESERVING</span></div>
<div class="line"><a id="l04390" name="l04390"></a><span class="lineno"> 4390</span><span class="comment">! TOTAL ETP1A.</span></div>
<div class="line"><a id="l04391" name="l04391"></a><span class="lineno"> 4391</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04392" name="l04392"></a><span class="lineno"> 4392</span><span class="keywordflow">      END DO</span></div>
<div class="line"><a id="l04393" name="l04393"></a><span class="lineno"> 4393</span>      <span class="keywordflow">IF</span> (cmc .ne. 0.0) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l04394" name="l04394"></a><span class="lineno"> 4394</span>         etp1a = shdfac * pc * etp1 * (1.0- (cmc / cmcmax) ** cfactr)</div>
<div class="line"><a id="l04395" name="l04395"></a><span class="lineno"> 4395</span>      <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l04396" name="l04396"></a><span class="lineno"> 4396</span>         etp1a = shdfac * pc * etp1</div>
<div class="line"><a id="l04397" name="l04397"></a><span class="lineno"> 4397</span><span class="keywordflow">      END IF</span></div>
<div class="line"><a id="l04398" name="l04398"></a><span class="lineno"> 4398</span>      sgx = 0.0</div>
<div class="line"><a id="l04399" name="l04399"></a><span class="lineno"> 4399</span>      <span class="keywordflow">DO</span> i = 1,nroot</div>
<div class="line"><a id="l04400" name="l04400"></a><span class="lineno"> 4400</span>         gx(i) = ( smc(i) - smcwlt ) / ( smcref - smcwlt )</div>
<div class="line"><a id="l04401" name="l04401"></a><span class="lineno"> 4401</span>         gx(i) = max( min( gx(i), 1. ), 0. )</div>
<div class="line"><a id="l04402" name="l04402"></a><span class="lineno"> 4402</span>         sgx = sgx + gx(i)</div>
<div class="line"><a id="l04403" name="l04403"></a><span class="lineno"> 4403</span><span class="keywordflow">      END DO</span></div>
<div class="line"><a id="l04404" name="l04404"></a><span class="lineno"> 4404</span> </div>
<div class="line"><a id="l04405" name="l04405"></a><span class="lineno"> 4405</span>      sgx = sgx / nroot</div>
<div class="line"><a id="l04406" name="l04406"></a><span class="lineno"> 4406</span>      denom = 0.</div>
<div class="line"><a id="l04407" name="l04407"></a><span class="lineno"> 4407</span>      <span class="keywordflow">DO</span> i = 1,nroot</div>
<div class="line"><a id="l04408" name="l04408"></a><span class="lineno"> 4408</span>         rtx = rtdis(i) + gx(i) - sgx</div>
<div class="line"><a id="l04409" name="l04409"></a><span class="lineno"> 4409</span>         gx(i) = gx(i) * max( rtx, 0. )</div>
<div class="line"><a id="l04410" name="l04410"></a><span class="lineno"> 4410</span>         denom = denom + gx(i)</div>
<div class="line"><a id="l04411" name="l04411"></a><span class="lineno"> 4411</span><span class="keywordflow">      END DO</span></div>
<div class="line"><a id="l04412" name="l04412"></a><span class="lineno"> 4412</span> </div>
<div class="line"><a id="l04413" name="l04413"></a><span class="lineno"> 4413</span>      <span class="keywordflow">IF</span> (denom .le. 0.0) denom = 1.</div>
<div class="line"><a id="l04414" name="l04414"></a><span class="lineno"> 4414</span>      <span class="keywordflow">DO</span> i = 1,nroot</div>
<div class="line"><a id="l04415" name="l04415"></a><span class="lineno"> 4415</span>         et(i) = etp1a * gx(i) / denom</div>
<div class="line"><a id="l04416" name="l04416"></a><span class="lineno"> 4416</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04417" name="l04417"></a><span class="lineno"> 4417</span><span class="comment">! ABOVE CODE ASSUMES A VERTICALLY UNIFORM ROOT DISTRIBUTION</span></div>
<div class="line"><a id="l04418" name="l04418"></a><span class="lineno"> 4418</span><span class="comment">! CODE BELOW TESTS A VARIABLE ROOT DISTRIBUTION</span></div>
<div class="line"><a id="l04419" name="l04419"></a><span class="lineno"> 4419</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04420" name="l04420"></a><span class="lineno"> 4420</span><span class="comment">!      ET(1) = ( ZSOIL(1) / ZSOIL(NROOT) ) * GX * ETP1A</span></div>
<div class="line"><a id="l04421" name="l04421"></a><span class="lineno"> 4421</span><span class="comment">!      ET(1) = ( ZSOIL(1) / ZSOIL(NROOT) ) * ETP1A</span></div>
<div class="line"><a id="l04422" name="l04422"></a><span class="lineno"> 4422</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04423" name="l04423"></a><span class="lineno"> 4423</span><span class="comment">! USING ROOT DISTRIBUTION AS WEIGHTING FACTOR</span></div>
<div class="line"><a id="l04424" name="l04424"></a><span class="lineno"> 4424</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04425" name="l04425"></a><span class="lineno"> 4425</span><span class="comment">!      ET(1) = RTDIS(1) * ETP1A</span></div>
<div class="line"><a id="l04426" name="l04426"></a><span class="lineno"> 4426</span><span class="comment">!      ET(1) = ETP1A * PART(1)</span></div>
<div class="line"><a id="l04427" name="l04427"></a><span class="lineno"> 4427</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04428" name="l04428"></a><span class="lineno"> 4428</span><span class="comment">! LOOP DOWN THRU THE SOIL LAYERS REPEATING THE OPERATION ABOVE,</span></div>
<div class="line"><a id="l04429" name="l04429"></a><span class="lineno"> 4429</span><span class="comment">! BUT USING THE THICKNESS OF THE SOIL LAYER (RATHER THAN THE</span></div>
<div class="line"><a id="l04430" name="l04430"></a><span class="lineno"> 4430</span><span class="comment">! ABSOLUTE DEPTH OF EACH LAYER) IN THE FINAL CALCULATION.</span></div>
<div class="line"><a id="l04431" name="l04431"></a><span class="lineno"> 4431</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04432" name="l04432"></a><span class="lineno"> 4432</span><span class="comment">!      DO K = 2,NROOT</span></div>
<div class="line"><a id="l04433" name="l04433"></a><span class="lineno"> 4433</span><span class="comment">!        GX = ( SMC(K) - SMCWLT ) / ( SMCREF - SMCWLT )</span></div>
<div class="line"><a id="l04434" name="l04434"></a><span class="lineno"> 4434</span><span class="comment">!        GX = MAX ( MIN ( GX, 1. ), 0. )</span></div>
<div class="line"><a id="l04435" name="l04435"></a><span class="lineno"> 4435</span><span class="comment">! TEST CANOPY RESISTANCE</span></div>
<div class="line"><a id="l04436" name="l04436"></a><span class="lineno"> 4436</span><span class="comment">!        GX = 1.0</span></div>
<div class="line"><a id="l04437" name="l04437"></a><span class="lineno"> 4437</span><span class="comment">!        ET(K) = ((ZSOIL(K)-ZSOIL(K-1))/ZSOIL(NROOT))*GX*ETP1A</span></div>
<div class="line"><a id="l04438" name="l04438"></a><span class="lineno"> 4438</span><span class="comment">!        ET(K) = ((ZSOIL(K)-ZSOIL(K-1))/ZSOIL(NROOT))*ETP1A</span></div>
<div class="line"><a id="l04439" name="l04439"></a><span class="lineno"> 4439</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04440" name="l04440"></a><span class="lineno"> 4440</span><span class="comment">! USING ROOT DISTRIBUTION AS WEIGHTING FACTOR</span></div>
<div class="line"><a id="l04441" name="l04441"></a><span class="lineno"> 4441</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04442" name="l04442"></a><span class="lineno"> 4442</span><span class="comment">!        ET(K) = RTDIS(K) * ETP1A</span></div>
<div class="line"><a id="l04443" name="l04443"></a><span class="lineno"> 4443</span><span class="comment">!        ET(K) = ETP1A*PART(K)</span></div>
<div class="line"><a id="l04444" name="l04444"></a><span class="lineno"> 4444</span><span class="comment">!      END DO</span></div>
<div class="line"><a id="l04445" name="l04445"></a><span class="lineno"> 4445</span><span class="keywordflow">      END DO</span></div>
<div class="line"><a id="l04446" name="l04446"></a><span class="lineno"> 4446</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04447" name="l04447"></a><span class="lineno"> 4447</span>  <span class="keyword">END SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#aa418d6be3fc3de942821faf6fb68e3f8">transp</a></div>
<div class="line"><a id="l04448" name="l04448"></a><span class="lineno"> 4448</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04449" name="l04449"></a><span class="lineno"> 4449</span> </div>
<div class="line"><a id="l04450" name="l04450"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#a3b4a7f68699fbc22922e958770009b57"> 4450</a></span>      <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a3b4a7f68699fbc22922e958770009b57">wdfcnd</a> (WDF,WCND,SMC,SMCMAX,BEXP,DKSAT,DWSAT,          &amp;</div>
<div class="line"><a id="l04451" name="l04451"></a><span class="lineno"> 4451</span>     &amp;                      SICEMAX)</div>
<div class="line"><a id="l04452" name="l04452"></a><span class="lineno"> 4452</span> </div>
<div class="line"><a id="l04453" name="l04453"></a><span class="lineno"> 4453</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04454" name="l04454"></a><span class="lineno"> 4454</span><span class="comment">! SUBROUTINE WDFCND</span></div>
<div class="line"><a id="l04455" name="l04455"></a><span class="lineno"> 4455</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04456" name="l04456"></a><span class="lineno"> 4456</span><span class="comment">! CALCULATE SOIL WATER DIFFUSIVITY AND SOIL HYDRAULIC CONDUCTIVITY.</span></div>
<div class="line"><a id="l04457" name="l04457"></a><span class="lineno"> 4457</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04458" name="l04458"></a><span class="lineno"> 4458</span>      <span class="keywordtype">IMPLICIT NONE</span></div>
<div class="line"><a id="l04459" name="l04459"></a><span class="lineno"> 4459</span><span class="keywordtype">      REAL</span>     BEXP</div>
<div class="line"><a id="l04460" name="l04460"></a><span class="lineno"> 4460</span><span class="keywordtype">      REAL</span>     DKSAT</div>
<div class="line"><a id="l04461" name="l04461"></a><span class="lineno"> 4461</span><span class="keywordtype">      REAL</span>     DWSAT</div>
<div class="line"><a id="l04462" name="l04462"></a><span class="lineno"> 4462</span><span class="keywordtype">      REAL</span>     EXPON</div>
<div class="line"><a id="l04463" name="l04463"></a><span class="lineno"> 4463</span><span class="keywordtype">      REAL</span>     FACTR1</div>
<div class="line"><a id="l04464" name="l04464"></a><span class="lineno"> 4464</span><span class="keywordtype">      REAL</span>     FACTR2</div>
<div class="line"><a id="l04465" name="l04465"></a><span class="lineno"> 4465</span><span class="keywordtype">      REAL</span>     SICEMAX</div>
<div class="line"><a id="l04466" name="l04466"></a><span class="lineno"> 4466</span><span class="keywordtype">      REAL</span>     SMC</div>
<div class="line"><a id="l04467" name="l04467"></a><span class="lineno"> 4467</span><span class="keywordtype">      REAL</span>     SMCMAX</div>
<div class="line"><a id="l04468" name="l04468"></a><span class="lineno"> 4468</span><span class="keywordtype">      REAL</span>     VKwgt</div>
<div class="line"><a id="l04469" name="l04469"></a><span class="lineno"> 4469</span><span class="keywordtype">      REAL</span>     WCND</div>
<div class="line"><a id="l04470" name="l04470"></a><span class="lineno"> 4470</span> </div>
<div class="line"><a id="l04471" name="l04471"></a><span class="lineno"> 4471</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04472" name="l04472"></a><span class="lineno"> 4472</span><span class="comment">!     CALC THE RATIO OF THE ACTUAL TO THE MAX PSBL SOIL H2O CONTENT</span></div>
<div class="line"><a id="l04473" name="l04473"></a><span class="lineno"> 4473</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04474" name="l04474"></a><span class="lineno"> 4474</span><span class="keywordtype">      REAL</span>     WDF</div>
<div class="line"><a id="l04475" name="l04475"></a><span class="lineno"> 4475</span>      factr1 = 0.05 / smcmax</div>
<div class="line"><a id="l04476" name="l04476"></a><span class="lineno"> 4476</span> </div>
<div class="line"><a id="l04477" name="l04477"></a><span class="lineno"> 4477</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04478" name="l04478"></a><span class="lineno"> 4478</span><span class="comment">! PREP AN EXPNTL COEF AND CALC THE SOIL WATER DIFFUSIVITY</span></div>
<div class="line"><a id="l04479" name="l04479"></a><span class="lineno"> 4479</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04480" name="l04480"></a><span class="lineno"> 4480</span>      factr2 = smc / smcmax</div>
<div class="line"><a id="l04481" name="l04481"></a><span class="lineno"> 4481</span>      factr1 = min(factr1,factr2)</div>
<div class="line"><a id="l04482" name="l04482"></a><span class="lineno"> 4482</span>      expon = bexp + 2.0</div>
<div class="line"><a id="l04483" name="l04483"></a><span class="lineno"> 4483</span> </div>
<div class="line"><a id="l04484" name="l04484"></a><span class="lineno"> 4484</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04485" name="l04485"></a><span class="lineno"> 4485</span><span class="comment">! FROZEN SOIL HYDRAULIC DIFFUSIVITY.  VERY SENSITIVE TO THE VERTICAL</span></div>
<div class="line"><a id="l04486" name="l04486"></a><span class="lineno"> 4486</span><span class="comment">! GRADIENT OF UNFROZEN WATER. THE LATTER GRADIENT CAN BECOME VERY</span></div>
<div class="line"><a id="l04487" name="l04487"></a><span class="lineno"> 4487</span><span class="comment">! EXTREME IN FREEZING/THAWING SITUATIONS, AND GIVEN THE RELATIVELY</span></div>
<div class="line"><a id="l04488" name="l04488"></a><span class="lineno"> 4488</span><span class="comment">! FEW AND THICK SOIL LAYERS, THIS GRADIENT SUFFERES SERIOUS</span></div>
<div class="line"><a id="l04489" name="l04489"></a><span class="lineno"> 4489</span><span class="comment">! TRUNCTION ERRORS YIELDING ERRONEOUSLY HIGH VERTICAL TRANSPORTS OF</span></div>
<div class="line"><a id="l04490" name="l04490"></a><span class="lineno"> 4490</span><span class="comment">! UNFROZEN WATER IN BOTH DIRECTIONS FROM HUGE HYDRAULIC DIFFUSIVITY.</span></div>
<div class="line"><a id="l04491" name="l04491"></a><span class="lineno"> 4491</span><span class="comment">! THEREFORE, WE FOUND WE HAD TO ARBITRARILY CONSTRAIN WDF</span></div>
<div class="line"><a id="l04492" name="l04492"></a><span class="lineno"> 4492</span><span class="comment">! --</span></div>
<div class="line"><a id="l04493" name="l04493"></a><span class="lineno"> 4493</span><span class="comment">! VERSION D_10CM: ........  FACTR1 = 0.2/SMCMAX</span></div>
<div class="line"><a id="l04494" name="l04494"></a><span class="lineno"> 4494</span><span class="comment">! WEIGHTED APPROACH...................... PABLO GRUNMANN, 28_SEP_1999.</span></div>
<div class="line"><a id="l04495" name="l04495"></a><span class="lineno"> 4495</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04496" name="l04496"></a><span class="lineno"> 4496</span>      wdf = dwsat * factr2 ** expon</div>
<div class="line"><a id="l04497" name="l04497"></a><span class="lineno"> 4497</span>      <span class="keywordflow">IF</span> (sicemax .gt. 0.0) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l04498" name="l04498"></a><span class="lineno"> 4498</span>         vkwgt = 1./ (1. + (500.* sicemax)**3.)</div>
<div class="line"><a id="l04499" name="l04499"></a><span class="lineno"> 4499</span>         wdf = vkwgt * wdf + (1. - vkwgt)* dwsat * factr1** expon</div>
<div class="line"><a id="l04500" name="l04500"></a><span class="lineno"> 4500</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04501" name="l04501"></a><span class="lineno"> 4501</span><span class="comment">! RESET THE EXPNTL COEF AND CALC THE HYDRAULIC CONDUCTIVITY</span></div>
<div class="line"><a id="l04502" name="l04502"></a><span class="lineno"> 4502</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04503" name="l04503"></a><span class="lineno"> 4503</span><span class="keywordflow">      END IF</span></div>
<div class="line"><a id="l04504" name="l04504"></a><span class="lineno"> 4504</span>      expon = (2.0 * bexp) + 3.0</div>
<div class="line"><a id="l04505" name="l04505"></a><span class="lineno"> 4505</span>      wcnd = dksat * factr2 ** expon</div>
<div class="line"><a id="l04506" name="l04506"></a><span class="lineno"> 4506</span> </div>
<div class="line"><a id="l04507" name="l04507"></a><span class="lineno"> 4507</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04508" name="l04508"></a><span class="lineno"> 4508</span>  <span class="keyword">END SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#a3b4a7f68699fbc22922e958770009b57">wdfcnd</a></div>
<div class="line"><a id="l04509" name="l04509"></a><span class="lineno"> 4509</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04510" name="l04510"></a><span class="lineno"> 4510</span> </div>
<div class="line"><a id="l04511" name="l04511"></a><span class="lineno"><a class="line" href="namespacemodule__sf__noahlsm.html#aa9d68d330c3a7476f326ead707abd9a8"> 4511</a></span>      <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#aa9d68d330c3a7476f326ead707abd9a8">sfcdif_off</a> (ZLM,Z0,THZ0,THLM,SFCSPD,CZIL,AKMS,AKHS)</div>
<div class="line"><a id="l04512" name="l04512"></a><span class="lineno"> 4512</span> </div>
<div class="line"><a id="l04513" name="l04513"></a><span class="lineno"> 4513</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04514" name="l04514"></a><span class="lineno"> 4514</span><span class="comment">! SUBROUTINE SFCDIF (renamed SFCDIF_off to avoid clash with Eta PBL)</span></div>
<div class="line"><a id="l04515" name="l04515"></a><span class="lineno"> 4515</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04516" name="l04516"></a><span class="lineno"> 4516</span><span class="comment">! CALCULATE SURFACE LAYER EXCHANGE COEFFICIENTS VIA ITERATIVE PROCESS.</span></div>
<div class="line"><a id="l04517" name="l04517"></a><span class="lineno"> 4517</span><span class="comment">! SEE CHEN ET AL (1997, BLM)</span></div>
<div class="line"><a id="l04518" name="l04518"></a><span class="lineno"> 4518</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04519" name="l04519"></a><span class="lineno"> 4519</span> </div>
<div class="line"><a id="l04520" name="l04520"></a><span class="lineno"> 4520</span>      <span class="keywordtype">IMPLICIT NONE</span></div>
<div class="line"><a id="l04521" name="l04521"></a><span class="lineno"> 4521</span><span class="keywordtype">      REAL</span>     WWST, WWST2, G, VKRM, EXCM, BETA, BTG, ELFC, WOLD, WNEW</div>
<div class="line"><a id="l04522" name="l04522"></a><span class="lineno"> 4522</span><span class="keywordtype">      REAL</span>     PIHF, EPSU2, EPSUST, EPSIT, EPSA, ZTMIN, ZTMAX, HPBL,     &amp;</div>
<div class="line"><a id="l04523" name="l04523"></a><span class="lineno"> 4523</span>     &amp; SQVISC</div>
<div class="line"><a id="l04524" name="l04524"></a><span class="lineno"> 4524</span>      <span class="keywordtype">REAL</span>     RIC, RRIC, FHNEU, RFC, RFAC, ZZ, PSLMU, PSLMS, PSLHU,     &amp;</div>
<div class="line"><a id="l04525" name="l04525"></a><span class="lineno"> 4525</span>     &amp; PSLHS</div>
<div class="line"><a id="l04526" name="l04526"></a><span class="lineno"> 4526</span>      <span class="keywordtype">REAL</span>     XX, PSPMU, YY, PSPMS, PSPHU, PSPHS, ZLM, Z0, THZ0, THLM</div>
<div class="line"><a id="l04527" name="l04527"></a><span class="lineno"> 4527</span><span class="keywordtype">      REAL</span>     SFCSPD, CZIL, AKMS, AKHS, ZILFC, ZU, ZT, RDZ, CXCH</div>
<div class="line"><a id="l04528" name="l04528"></a><span class="lineno"> 4528</span><span class="keywordtype">      REAL</span>     DTHV, DU2, BTGH, WSTAR2, USTAR, ZSLU, ZSLT, RLOGU, RLOGT</div>
<div class="line"><a id="l04529" name="l04529"></a><span class="lineno"> 4529</span><span class="keywordtype">      REAL</span>     RLMO, ZETALT, ZETALU, ZETAU, ZETAT, XLU4, XLT4, XU4, XT4</div>
<div class="line"><a id="l04530" name="l04530"></a><span class="lineno"> 4530</span><span class="comment">!CC   ......REAL ZTFC</span></div>
<div class="line"><a id="l04531" name="l04531"></a><span class="lineno"> 4531</span> </div>
<div class="line"><a id="l04532" name="l04532"></a><span class="lineno"> 4532</span><span class="keywordtype">      REAL</span>     XLU, XLT, XU, XT, PSMZ, SIMM, PSHZ, SIMH, USTARK, RLMN,  &amp;</div>
<div class="line"><a id="l04533" name="l04533"></a><span class="lineno"> 4533</span>     &amp;         RLMA</div>
<div class="line"><a id="l04534" name="l04534"></a><span class="lineno"> 4534</span> </div>
<div class="line"><a id="l04535" name="l04535"></a><span class="lineno"> 4535</span>      <span class="keywordtype">INTEGER</span>  ITRMX, ILECH, ITR</div>
<div class="line"><a id="l04536" name="l04536"></a><span class="lineno"> 4536</span>      <span class="keywordtype">PARAMETER</span>                                                         &amp;</div>
<div class="line"><a id="l04537" name="l04537"></a><span class="lineno"> 4537</span>     &amp;        (wwst = 1.2,wwst2 = wwst * wwst,g = 9.8,vkrm = 0.40,      &amp;</div>
<div class="line"><a id="l04538" name="l04538"></a><span class="lineno"> 4538</span>     &amp;         excm = 0.001                                             &amp;</div>
<div class="line"><a id="l04539" name="l04539"></a><span class="lineno"> 4539</span>     &amp;        ,beta = 1./270.,btg = beta * g,elfc = vkrm * btg          &amp;</div>
<div class="line"><a id="l04540" name="l04540"></a><span class="lineno"> 4540</span>     &amp;                  ,wold =.15,wnew = 1. - wold,itrmx = 05,         &amp;</div>
<div class="line"><a id="l04541" name="l04541"></a><span class="lineno"> 4541</span>     &amp;                   pihf = 3.14159265/2.)</div>
<div class="line"><a id="l04542" name="l04542"></a><span class="lineno"> 4542</span>      <span class="keywordtype">PARAMETER</span>                                                         &amp;</div>
<div class="line"><a id="l04543" name="l04543"></a><span class="lineno"> 4543</span>     &amp;         (epsu2 = 1.e-4,epsust = 0.07,epsit = 1.e-4,epsa = 1.e-8  &amp;</div>
<div class="line"><a id="l04544" name="l04544"></a><span class="lineno"> 4544</span>     &amp;         ,ztmin = -5.,ztmax = 1.,hpbl = 1000.0                    &amp;</div>
<div class="line"><a id="l04545" name="l04545"></a><span class="lineno"> 4545</span>     &amp;          ,sqvisc = 258.2)</div>
<div class="line"><a id="l04546" name="l04546"></a><span class="lineno"> 4546</span>      <span class="keywordtype">PARAMETER</span>                                                         &amp;</div>
<div class="line"><a id="l04547" name="l04547"></a><span class="lineno"> 4547</span>     &amp;       (ric = 0.183,rric = 1.0/ ric,fhneu = 0.8,rfc = 0.191       &amp;</div>
<div class="line"><a id="l04548" name="l04548"></a><span class="lineno"> 4548</span>     &amp;        ,rfac = ric / (fhneu * rfc * rfc))</div>
<div class="line"><a id="l04549" name="l04549"></a><span class="lineno"> 4549</span> </div>
<div class="line"><a id="l04550" name="l04550"></a><span class="lineno"> 4550</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04551" name="l04551"></a><span class="lineno"> 4551</span><span class="comment">! NOTE: THE TWO CODE BLOCKS BELOW DEFINE FUNCTIONS</span></div>
<div class="line"><a id="l04552" name="l04552"></a><span class="lineno"> 4552</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04553" name="l04553"></a><span class="lineno"> 4553</span><span class="comment">! LECH&#39;S SURFACE FUNCTIONS</span></div>
<div class="line"><a id="l04554" name="l04554"></a><span class="lineno"> 4554</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04555" name="l04555"></a><span class="lineno"> 4555</span>      pslmu(zz)= -0.96* log(1.0-4.5* zz)</div>
<div class="line"><a id="l04556" name="l04556"></a><span class="lineno"> 4556</span>      pslms(zz)= zz * rric -2.076* (1. -1./ (zz +1.))</div>
<div class="line"><a id="l04557" name="l04557"></a><span class="lineno"> 4557</span>      pslhu(zz)= -0.96* log(1.0-4.5* zz)</div>
<div class="line"><a id="l04558" name="l04558"></a><span class="lineno"> 4558</span> </div>
<div class="line"><a id="l04559" name="l04559"></a><span class="lineno"> 4559</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04560" name="l04560"></a><span class="lineno"> 4560</span><span class="comment">! PAULSON&#39;S SURFACE FUNCTIONS</span></div>
<div class="line"><a id="l04561" name="l04561"></a><span class="lineno"> 4561</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04562" name="l04562"></a><span class="lineno"> 4562</span>      pslhs(zz)= zz * rfac -2.076* (1. -1./ (zz +1.))</div>
<div class="line"><a id="l04563" name="l04563"></a><span class="lineno"> 4563</span>      pspmu(xx)= -2.* log( (xx +1.)*0.5) - log( (xx * xx +1.)*0.5)   &amp;</div>
<div class="line"><a id="l04564" name="l04564"></a><span class="lineno"> 4564</span>     &amp;        +2.* atan(xx)                                            &amp;</div>
<div class="line"><a id="l04565" name="l04565"></a><span class="lineno"> 4565</span>     &amp;- pihf</div>
<div class="line"><a id="l04566" name="l04566"></a><span class="lineno"> 4566</span>      pspms(yy)= 5.* yy</div>
<div class="line"><a id="l04567" name="l04567"></a><span class="lineno"> 4567</span>      psphu(xx)= -2.* log( (xx * xx +1.)*0.5)</div>
<div class="line"><a id="l04568" name="l04568"></a><span class="lineno"> 4568</span> </div>
<div class="line"><a id="l04569" name="l04569"></a><span class="lineno"> 4569</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04570" name="l04570"></a><span class="lineno"> 4570</span><span class="comment">! THIS ROUTINE SFCDIF CAN HANDLE BOTH OVER OPEN WATER (SEA, OCEAN) AND</span></div>
<div class="line"><a id="l04571" name="l04571"></a><span class="lineno"> 4571</span><span class="comment">! OVER SOLID SURFACE (LAND, SEA-ICE).</span></div>
<div class="line"><a id="l04572" name="l04572"></a><span class="lineno"> 4572</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04573" name="l04573"></a><span class="lineno"> 4573</span>      psphs(yy)= 5.* yy</div>
<div class="line"><a id="l04574" name="l04574"></a><span class="lineno"> 4574</span> </div>
<div class="line"><a id="l04575" name="l04575"></a><span class="lineno"> 4575</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04576" name="l04576"></a><span class="lineno"> 4576</span><span class="comment">!     ZTFC: RATIO OF ZOH/ZOM  LESS OR EQUAL THAN 1</span></div>
<div class="line"><a id="l04577" name="l04577"></a><span class="lineno"> 4577</span><span class="comment">!     C......ZTFC=0.1</span></div>
<div class="line"><a id="l04578" name="l04578"></a><span class="lineno"> 4578</span><span class="comment">!     CZIL: CONSTANT C IN Zilitinkevich, S. S.1995,:NOTE ABOUT ZT</span></div>
<div class="line"><a id="l04579" name="l04579"></a><span class="lineno"> 4579</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04580" name="l04580"></a><span class="lineno"> 4580</span>      ilech = 0</div>
<div class="line"><a id="l04581" name="l04581"></a><span class="lineno"> 4581</span> </div>
<div class="line"><a id="l04582" name="l04582"></a><span class="lineno"> 4582</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04583" name="l04583"></a><span class="lineno"> 4583</span>      zilfc = - czil * vkrm * sqvisc</div>
<div class="line"><a id="l04584" name="l04584"></a><span class="lineno"> 4584</span><span class="comment">!     C.......ZT=Z0*ZTFC</span></div>
<div class="line"><a id="l04585" name="l04585"></a><span class="lineno"> 4585</span>      zu = z0</div>
<div class="line"><a id="l04586" name="l04586"></a><span class="lineno"> 4586</span>      rdz = 1./ zlm</div>
<div class="line"><a id="l04587" name="l04587"></a><span class="lineno"> 4587</span>      cxch = excm * rdz</div>
<div class="line"><a id="l04588" name="l04588"></a><span class="lineno"> 4588</span>      dthv = thlm - thz0</div>
<div class="line"><a id="l04589" name="l04589"></a><span class="lineno"> 4589</span> </div>
<div class="line"><a id="l04590" name="l04590"></a><span class="lineno"> 4590</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04591" name="l04591"></a><span class="lineno"> 4591</span><span class="comment">! BELJARS CORRECTION OF USTAR</span></div>
<div class="line"><a id="l04592" name="l04592"></a><span class="lineno"> 4592</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04593" name="l04593"></a><span class="lineno"> 4593</span>      du2 = max(sfcspd * sfcspd,epsu2)</div>
<div class="line"><a id="l04594" name="l04594"></a><span class="lineno"> 4594</span><span class="comment">!cc   If statements to avoid TANGENT LINEAR problems near zero</span></div>
<div class="line"><a id="l04595" name="l04595"></a><span class="lineno"> 4595</span>      btgh = btg * hpbl</div>
<div class="line"><a id="l04596" name="l04596"></a><span class="lineno"> 4596</span>      <span class="keywordflow">IF</span> (btgh * akhs * dthv .ne. 0.0) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l04597" name="l04597"></a><span class="lineno"> 4597</span>         wstar2 = wwst2* abs(btgh * akhs * dthv)** (2./3.)</div>
<div class="line"><a id="l04598" name="l04598"></a><span class="lineno"> 4598</span>      <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l04599" name="l04599"></a><span class="lineno"> 4599</span>         wstar2 = 0.0</div>
<div class="line"><a id="l04600" name="l04600"></a><span class="lineno"> 4600</span><span class="keywordflow">      END IF</span></div>
<div class="line"><a id="l04601" name="l04601"></a><span class="lineno"> 4601</span> </div>
<div class="line"><a id="l04602" name="l04602"></a><span class="lineno"> 4602</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04603" name="l04603"></a><span class="lineno"> 4603</span><span class="comment">! ZILITINKEVITCH APPROACH FOR ZT</span></div>
<div class="line"><a id="l04604" name="l04604"></a><span class="lineno"> 4604</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04605" name="l04605"></a><span class="lineno"> 4605</span>      ustar = max(sqrt(akms * sqrt(du2+ wstar2)),epsust)</div>
<div class="line"><a id="l04606" name="l04606"></a><span class="lineno"> 4606</span> </div>
<div class="line"><a id="l04607" name="l04607"></a><span class="lineno"> 4607</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04608" name="l04608"></a><span class="lineno"> 4608</span>      zt = exp(zilfc * sqrt(ustar * z0))* z0</div>
<div class="line"><a id="l04609" name="l04609"></a><span class="lineno"> 4609</span>      zslu = zlm + zu</div>
<div class="line"><a id="l04610" name="l04610"></a><span class="lineno"> 4610</span><span class="comment">!     PRINT*,&#39;ZSLT=&#39;,ZSLT</span></div>
<div class="line"><a id="l04611" name="l04611"></a><span class="lineno"> 4611</span><span class="comment">!     PRINT*,&#39;ZLM=&#39;,ZLM</span></div>
<div class="line"><a id="l04612" name="l04612"></a><span class="lineno"> 4612</span><span class="comment">!     PRINT*,&#39;ZT=&#39;,ZT</span></div>
<div class="line"><a id="l04613" name="l04613"></a><span class="lineno"> 4613</span> </div>
<div class="line"><a id="l04614" name="l04614"></a><span class="lineno"> 4614</span>      zslt = zlm + zt</div>
<div class="line"><a id="l04615" name="l04615"></a><span class="lineno"> 4615</span>      rlogu = log(zslu / zu)</div>
<div class="line"><a id="l04616" name="l04616"></a><span class="lineno"> 4616</span> </div>
<div class="line"><a id="l04617" name="l04617"></a><span class="lineno"> 4617</span>      rlogt = log(zslt / zt)</div>
<div class="line"><a id="l04618" name="l04618"></a><span class="lineno"> 4618</span><span class="comment">!     PRINT*,&#39;RLMO=&#39;,RLMO</span></div>
<div class="line"><a id="l04619" name="l04619"></a><span class="lineno"> 4619</span><span class="comment">!     PRINT*,&#39;ELFC=&#39;,ELFC</span></div>
<div class="line"><a id="l04620" name="l04620"></a><span class="lineno"> 4620</span><span class="comment">!     PRINT*,&#39;AKHS=&#39;,AKHS</span></div>
<div class="line"><a id="l04621" name="l04621"></a><span class="lineno"> 4621</span><span class="comment">!     PRINT*,&#39;DTHV=&#39;,DTHV</span></div>
<div class="line"><a id="l04622" name="l04622"></a><span class="lineno"> 4622</span><span class="comment">!     PRINT*,&#39;USTAR=&#39;,USTAR</span></div>
<div class="line"><a id="l04623" name="l04623"></a><span class="lineno"> 4623</span> </div>
<div class="line"><a id="l04624" name="l04624"></a><span class="lineno"> 4624</span>      rlmo = elfc * akhs * dthv / ustar **3</div>
<div class="line"><a id="l04625" name="l04625"></a><span class="lineno"> 4625</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04626" name="l04626"></a><span class="lineno"> 4626</span><span class="comment">! 1./MONIN-OBUKKHOV LENGTH-SCALE</span></div>
<div class="line"><a id="l04627" name="l04627"></a><span class="lineno"> 4627</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04628" name="l04628"></a><span class="lineno"> 4628</span>      <span class="keywordflow">DO</span> itr = 1,itrmx</div>
<div class="line"><a id="l04629" name="l04629"></a><span class="lineno"> 4629</span>         zetalt = max(zslt * rlmo,ztmin)</div>
<div class="line"><a id="l04630" name="l04630"></a><span class="lineno"> 4630</span>         rlmo = zetalt / zslt</div>
<div class="line"><a id="l04631" name="l04631"></a><span class="lineno"> 4631</span>         zetalu = zslu * rlmo</div>
<div class="line"><a id="l04632" name="l04632"></a><span class="lineno"> 4632</span>         zetau = zu * rlmo</div>
<div class="line"><a id="l04633" name="l04633"></a><span class="lineno"> 4633</span> </div>
<div class="line"><a id="l04634" name="l04634"></a><span class="lineno"> 4634</span>         zetat = zt * rlmo</div>
<div class="line"><a id="l04635" name="l04635"></a><span class="lineno"> 4635</span>         <span class="keywordflow">IF</span> (ilech .eq. 0) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l04636" name="l04636"></a><span class="lineno"> 4636</span>            <span class="keywordflow">IF</span> (rlmo .lt. 0.)<span class="keywordflow">THEN</span></div>
<div class="line"><a id="l04637" name="l04637"></a><span class="lineno"> 4637</span>               xlu4 = 1. -16.* zetalu</div>
<div class="line"><a id="l04638" name="l04638"></a><span class="lineno"> 4638</span>               xlt4 = 1. -16.* zetalt</div>
<div class="line"><a id="l04639" name="l04639"></a><span class="lineno"> 4639</span>               xu4 = 1. -16.* zetau</div>
<div class="line"><a id="l04640" name="l04640"></a><span class="lineno"> 4640</span> </div>
<div class="line"><a id="l04641" name="l04641"></a><span class="lineno"> 4641</span>               xt4 = 1. -16.* zetat</div>
<div class="line"><a id="l04642" name="l04642"></a><span class="lineno"> 4642</span>               xlu = sqrt(sqrt(xlu4))</div>
<div class="line"><a id="l04643" name="l04643"></a><span class="lineno"> 4643</span>               xlt = sqrt(sqrt(xlt4))</div>
<div class="line"><a id="l04644" name="l04644"></a><span class="lineno"> 4644</span>               xu = sqrt(sqrt(xu4))</div>
<div class="line"><a id="l04645" name="l04645"></a><span class="lineno"> 4645</span> </div>
<div class="line"><a id="l04646" name="l04646"></a><span class="lineno"> 4646</span>               xt = sqrt(sqrt(xt4))</div>
<div class="line"><a id="l04647" name="l04647"></a><span class="lineno"> 4647</span><span class="comment">!     PRINT*,&#39;-----------1------------&#39;</span></div>
<div class="line"><a id="l04648" name="l04648"></a><span class="lineno"> 4648</span><span class="comment">!     PRINT*,&#39;PSMZ=&#39;,PSMZ</span></div>
<div class="line"><a id="l04649" name="l04649"></a><span class="lineno"> 4649</span><span class="comment">!     PRINT*,&#39;PSPMU(ZETAU)=&#39;,PSPMU(ZETAU)</span></div>
<div class="line"><a id="l04650" name="l04650"></a><span class="lineno"> 4650</span><span class="comment">!     PRINT*,&#39;XU=&#39;,XU</span></div>
<div class="line"><a id="l04651" name="l04651"></a><span class="lineno"> 4651</span><span class="comment">!     PRINT*,&#39;------------------------&#39;</span></div>
<div class="line"><a id="l04652" name="l04652"></a><span class="lineno"> 4652</span>               psmz = pspmu(xu)</div>
<div class="line"><a id="l04653" name="l04653"></a><span class="lineno"> 4653</span>               simm = pspmu(xlu) - psmz + rlogu</div>
<div class="line"><a id="l04654" name="l04654"></a><span class="lineno"> 4654</span>               pshz = psphu(xt)</div>
<div class="line"><a id="l04655" name="l04655"></a><span class="lineno"> 4655</span>               simh = psphu(xlt) - pshz + rlogt</div>
<div class="line"><a id="l04656" name="l04656"></a><span class="lineno"> 4656</span>            <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l04657" name="l04657"></a><span class="lineno"> 4657</span>               zetalu = min(zetalu,ztmax)</div>
<div class="line"><a id="l04658" name="l04658"></a><span class="lineno"> 4658</span>               zetalt = min(zetalt,ztmax)</div>
<div class="line"><a id="l04659" name="l04659"></a><span class="lineno"> 4659</span><span class="comment">!     PRINT*,&#39;-----------2------------&#39;</span></div>
<div class="line"><a id="l04660" name="l04660"></a><span class="lineno"> 4660</span><span class="comment">!     PRINT*,&#39;PSMZ=&#39;,PSMZ</span></div>
<div class="line"><a id="l04661" name="l04661"></a><span class="lineno"> 4661</span><span class="comment">!     PRINT*,&#39;PSPMS(ZETAU)=&#39;,PSPMS(ZETAU)</span></div>
<div class="line"><a id="l04662" name="l04662"></a><span class="lineno"> 4662</span><span class="comment">!     PRINT*,&#39;ZETAU=&#39;,ZETAU</span></div>
<div class="line"><a id="l04663" name="l04663"></a><span class="lineno"> 4663</span><span class="comment">!     PRINT*,&#39;------------------------&#39;</span></div>
<div class="line"><a id="l04664" name="l04664"></a><span class="lineno"> 4664</span>               psmz = pspms(zetau)</div>
<div class="line"><a id="l04665" name="l04665"></a><span class="lineno"> 4665</span>               simm = pspms(zetalu) - psmz + rlogu</div>
<div class="line"><a id="l04666" name="l04666"></a><span class="lineno"> 4666</span>               pshz = psphs(zetat)</div>
<div class="line"><a id="l04667" name="l04667"></a><span class="lineno"> 4667</span>               simh = psphs(zetalt) - pshz + rlogt</div>
<div class="line"><a id="l04668" name="l04668"></a><span class="lineno"> 4668</span><span class="keywordflow">            END IF</span></div>
<div class="line"><a id="l04669" name="l04669"></a><span class="lineno"> 4669</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04670" name="l04670"></a><span class="lineno"> 4670</span><span class="comment">! LECH&#39;S FUNCTIONS</span></div>
<div class="line"><a id="l04671" name="l04671"></a><span class="lineno"> 4671</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04672" name="l04672"></a><span class="lineno"> 4672</span>         <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l04673" name="l04673"></a><span class="lineno"> 4673</span>            <span class="keywordflow">IF</span> (rlmo .lt. 0.)<span class="keywordflow">THEN</span></div>
<div class="line"><a id="l04674" name="l04674"></a><span class="lineno"> 4674</span><span class="comment">!     PRINT*,&#39;-----------3------------&#39;</span></div>
<div class="line"><a id="l04675" name="l04675"></a><span class="lineno"> 4675</span><span class="comment">!     PRINT*,&#39;PSMZ=&#39;,PSMZ</span></div>
<div class="line"><a id="l04676" name="l04676"></a><span class="lineno"> 4676</span><span class="comment">!     PRINT*,&#39;PSLMU(ZETAU)=&#39;,PSLMU(ZETAU)</span></div>
<div class="line"><a id="l04677" name="l04677"></a><span class="lineno"> 4677</span><span class="comment">!     PRINT*,&#39;ZETAU=&#39;,ZETAU</span></div>
<div class="line"><a id="l04678" name="l04678"></a><span class="lineno"> 4678</span><span class="comment">!     PRINT*,&#39;------------------------&#39;</span></div>
<div class="line"><a id="l04679" name="l04679"></a><span class="lineno"> 4679</span>               psmz = pslmu(zetau)</div>
<div class="line"><a id="l04680" name="l04680"></a><span class="lineno"> 4680</span>               simm = pslmu(zetalu) - psmz + rlogu</div>
<div class="line"><a id="l04681" name="l04681"></a><span class="lineno"> 4681</span>               pshz = pslhu(zetat)</div>
<div class="line"><a id="l04682" name="l04682"></a><span class="lineno"> 4682</span>               simh = pslhu(zetalt) - pshz + rlogt</div>
<div class="line"><a id="l04683" name="l04683"></a><span class="lineno"> 4683</span>            <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l04684" name="l04684"></a><span class="lineno"> 4684</span>               zetalu = min(zetalu,ztmax)</div>
<div class="line"><a id="l04685" name="l04685"></a><span class="lineno"> 4685</span> </div>
<div class="line"><a id="l04686" name="l04686"></a><span class="lineno"> 4686</span>               zetalt = min(zetalt,ztmax)</div>
<div class="line"><a id="l04687" name="l04687"></a><span class="lineno"> 4687</span><span class="comment">!     PRINT*,&#39;-----------4------------&#39;</span></div>
<div class="line"><a id="l04688" name="l04688"></a><span class="lineno"> 4688</span><span class="comment">!     PRINT*,&#39;PSMZ=&#39;,PSMZ</span></div>
<div class="line"><a id="l04689" name="l04689"></a><span class="lineno"> 4689</span><span class="comment">!     PRINT*,&#39;PSLMS(ZETAU)=&#39;,PSLMS(ZETAU)</span></div>
<div class="line"><a id="l04690" name="l04690"></a><span class="lineno"> 4690</span><span class="comment">!     PRINT*,&#39;ZETAU=&#39;,ZETAU</span></div>
<div class="line"><a id="l04691" name="l04691"></a><span class="lineno"> 4691</span><span class="comment">!     PRINT*,&#39;------------------------&#39;</span></div>
<div class="line"><a id="l04692" name="l04692"></a><span class="lineno"> 4692</span>               psmz = pslms(zetau)</div>
<div class="line"><a id="l04693" name="l04693"></a><span class="lineno"> 4693</span>               simm = pslms(zetalu) - psmz + rlogu</div>
<div class="line"><a id="l04694" name="l04694"></a><span class="lineno"> 4694</span>               pshz = pslhs(zetat)</div>
<div class="line"><a id="l04695" name="l04695"></a><span class="lineno"> 4695</span>               simh = pslhs(zetalt) - pshz + rlogt</div>
<div class="line"><a id="l04696" name="l04696"></a><span class="lineno"> 4696</span><span class="keywordflow">            END IF</span></div>
<div class="line"><a id="l04697" name="l04697"></a><span class="lineno"> 4697</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04698" name="l04698"></a><span class="lineno"> 4698</span><span class="comment">! BELJAARS CORRECTION FOR USTAR</span></div>
<div class="line"><a id="l04699" name="l04699"></a><span class="lineno"> 4699</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04700" name="l04700"></a><span class="lineno"> 4700</span><span class="keywordflow">         END IF</span></div>
<div class="line"><a id="l04701" name="l04701"></a><span class="lineno"> 4701</span> </div>
<div class="line"><a id="l04702" name="l04702"></a><span class="lineno"> 4702</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04703" name="l04703"></a><span class="lineno"> 4703</span><span class="comment">! ZILITINKEVITCH FIX FOR ZT</span></div>
<div class="line"><a id="l04704" name="l04704"></a><span class="lineno"> 4704</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04705" name="l04705"></a><span class="lineno"> 4705</span>         ustar = max(sqrt(akms * sqrt(du2+ wstar2)),epsust)</div>
<div class="line"><a id="l04706" name="l04706"></a><span class="lineno"> 4706</span> </div>
<div class="line"><a id="l04707" name="l04707"></a><span class="lineno"> 4707</span>         zt = exp(zilfc * sqrt(ustar * z0))* z0</div>
<div class="line"><a id="l04708" name="l04708"></a><span class="lineno"> 4708</span>         zslt = zlm + zt</div>
<div class="line"><a id="l04709" name="l04709"></a><span class="lineno"> 4709</span><span class="comment">!-----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04710" name="l04710"></a><span class="lineno"> 4710</span>         rlogt = log(zslt / zt)</div>
<div class="line"><a id="l04711" name="l04711"></a><span class="lineno"> 4711</span>         ustark = ustar * vkrm</div>
<div class="line"><a id="l04712" name="l04712"></a><span class="lineno"> 4712</span>         akms = max(ustark / simm,cxch)</div>
<div class="line"><a id="l04713" name="l04713"></a><span class="lineno"> 4713</span><span class="comment">!-----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04714" name="l04714"></a><span class="lineno"> 4714</span><span class="comment">! IF STATEMENTS TO AVOID TANGENT LINEAR PROBLEMS NEAR ZERO</span></div>
<div class="line"><a id="l04715" name="l04715"></a><span class="lineno"> 4715</span><span class="comment">!-----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04716" name="l04716"></a><span class="lineno"> 4716</span>         akhs = max(ustark / simh,cxch)</div>
<div class="line"><a id="l04717" name="l04717"></a><span class="lineno"> 4717</span>         <span class="keywordflow">IF</span> (btgh * akhs * dthv .ne. 0.0) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l04718" name="l04718"></a><span class="lineno"> 4718</span>            wstar2 = wwst2* abs(btgh * akhs * dthv)** (2./3.)</div>
<div class="line"><a id="l04719" name="l04719"></a><span class="lineno"> 4719</span>         <span class="keywordflow">ELSE</span></div>
<div class="line"><a id="l04720" name="l04720"></a><span class="lineno"> 4720</span>            wstar2 = 0.0</div>
<div class="line"><a id="l04721" name="l04721"></a><span class="lineno"> 4721</span><span class="keywordflow">         END IF</span></div>
<div class="line"><a id="l04722" name="l04722"></a><span class="lineno"> 4722</span><span class="comment">!-----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04723" name="l04723"></a><span class="lineno"> 4723</span>         rlmn = elfc * akhs * dthv / ustar **3</div>
<div class="line"><a id="l04724" name="l04724"></a><span class="lineno"> 4724</span><span class="comment">!-----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04725" name="l04725"></a><span class="lineno"> 4725</span><span class="comment">!     IF(ABS((RLMN-RLMO)/RLMA).LT.EPSIT)    GO TO 110</span></div>
<div class="line"><a id="l04726" name="l04726"></a><span class="lineno"> 4726</span><span class="comment">!-----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04727" name="l04727"></a><span class="lineno"> 4727</span>         rlma = rlmo * wold+ rlmn * wnew</div>
<div class="line"><a id="l04728" name="l04728"></a><span class="lineno"> 4728</span><span class="comment">!-----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04729" name="l04729"></a><span class="lineno"> 4729</span>         rlmo = rlma</div>
<div class="line"><a id="l04730" name="l04730"></a><span class="lineno"> 4730</span><span class="comment">!     PRINT*,&#39;----------------------------&#39;</span></div>
<div class="line"><a id="l04731" name="l04731"></a><span class="lineno"> 4731</span><span class="comment">!     PRINT*,&#39;SFCDIF OUTPUT !  ! ! ! ! ! ! ! !  !   !    !&#39;</span></div>
<div class="line"><a id="l04732" name="l04732"></a><span class="lineno"> 4732</span> </div>
<div class="line"><a id="l04733" name="l04733"></a><span class="lineno"> 4733</span><span class="comment">!     PRINT*,&#39;ZLM=&#39;,ZLM</span></div>
<div class="line"><a id="l04734" name="l04734"></a><span class="lineno"> 4734</span><span class="comment">!     PRINT*,&#39;Z0=&#39;,Z0</span></div>
<div class="line"><a id="l04735" name="l04735"></a><span class="lineno"> 4735</span><span class="comment">!     PRINT*,&#39;THZ0=&#39;,THZ0</span></div>
<div class="line"><a id="l04736" name="l04736"></a><span class="lineno"> 4736</span><span class="comment">!     PRINT*,&#39;THLM=&#39;,THLM</span></div>
<div class="line"><a id="l04737" name="l04737"></a><span class="lineno"> 4737</span><span class="comment">!     PRINT*,&#39;SFCSPD=&#39;,SFCSPD</span></div>
<div class="line"><a id="l04738" name="l04738"></a><span class="lineno"> 4738</span><span class="comment">!     PRINT*,&#39;CZIL=&#39;,CZIL</span></div>
<div class="line"><a id="l04739" name="l04739"></a><span class="lineno"> 4739</span><span class="comment">!     PRINT*,&#39;AKMS=&#39;,AKMS</span></div>
<div class="line"><a id="l04740" name="l04740"></a><span class="lineno"> 4740</span><span class="comment">!     PRINT*,&#39;AKHS=&#39;,AKHS</span></div>
<div class="line"><a id="l04741" name="l04741"></a><span class="lineno"> 4741</span><span class="comment">!     PRINT*,&#39;----------------------------&#39;</span></div>
<div class="line"><a id="l04742" name="l04742"></a><span class="lineno"> 4742</span> </div>
<div class="line"><a id="l04743" name="l04743"></a><span class="lineno"> 4743</span><span class="keywordflow">      END DO</span></div>
<div class="line"><a id="l04744" name="l04744"></a><span class="lineno"> 4744</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04745" name="l04745"></a><span class="lineno"> 4745</span>  <span class="keyword">END SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__noahlsm.html#aa9d68d330c3a7476f326ead707abd9a8">sfcdif_off</a></div>
<div class="line"><a id="l04746" name="l04746"></a><span class="lineno"> 4746</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04747" name="l04747"></a><span class="lineno"> 4747</span> </div>
<div class="line"><a id="l04748" name="l04748"></a><span class="lineno"> 4748</span><span class="keyword">END MODULE </span><a class="code hl_namespace" href="namespacemodule__sf__noahlsm.html">module_sf_noahlsm</a></div>
<div class="ttc" id="ampas__ocn__okubo__weiss__eigenvalues_8c_html_a11d147c64891830c9e79b3315b1b2e21"><div class="ttname"><a href="mpas__ocn__okubo__weiss__eigenvalues_8c.html#a11d147c64891830c9e79b3315b1b2e21">real</a></div><div class="ttdeci">double real</div><div class="ttdef"><b>Definition:</b> <a href="mpas__ocn__okubo__weiss__eigenvalues_8c_source.html#l00050">mpas_ocn_okubo_weiss_eigenvalues.c:50</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html">module_sf_noahlsm</a></div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00001">module_sf_noahlsm.F:1</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a010cd10c8d345760dec2a6bddbb5170f"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a010cd10c8d345760dec2a6bddbb5170f">module_sf_noahlsm::nopac</a></div><div class="ttdeci">subroutine nopac(ETP, ETA, PRCP, SMC, SMCMAX, SMCWLT, SMCREF, SMCDRY, CMC, CMCMAX, NSOIL, DT, SHDFAC, SBETA, Q2, T1, SFCTMP, T24, TH2, FDOWN, F1, EMISSI, SSOIL, STC, EPSCA, BEXP, PC, RCH, RR, CFACTR, SH2O, SLOPE, KDT, FRZFACT, PSISAT, ZSOIL, DKSAT, DWSAT, TBOT, ZBOT, RUNOFF1, RUNOFF2, RUNOFF3, EDIR, EC, ET, ETT, NROOT, RTDIS, QUARTZ, FXEXP, CSOIL, BETA, DRIP, DEW, FLX1, FLX3, VEGTYP, ISURBAN, SFHEAD1RT, INFXS1RT, ETPND1, SOILTYP, OPT_THCND, XSDA_QFX, QFX_PHY, XQNORM, fasdas, HCPCT_FASDAS)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l01900">module_sf_noahlsm.F:1912</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a032dea1cb1492e469ff23cf4a34170ea"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a032dea1cb1492e469ff23cf4a34170ea">module_sf_noahlsm::hstbl</a></div><div class="ttdeci">real, dimension(1:nlus) hstbl</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00036">module_sf_noahlsm.F:36</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a035da859804652a83bc5fd235e70b2e0"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a035da859804652a83bc5fd235e70b2e0">module_sf_noahlsm::redprm</a></div><div class="ttdeci">subroutine redprm(VEGTYP, SOILTYP, SLOPETYP, CFACTR, CMCMAX, RSMAX, TOPT, REFKDT, KDT, SBETA, SHDFAC, RSMIN, RGL, HS, ZBOT, FRZX, PSISAT, SLOPE, SNUP, SALP, BEXP, DKSAT, DWSAT, SMCMAX, SMCWLT, SMCREF, SMCDRY, F1, QUARTZ, FXEXP, RTDIS, SLDPTH, ZSOIL, NROOT, NSOIL, CZIL, LAIMIN, LAIMAX, EMISSMIN, EMISSMAX, ALBEDOMIN, ALBEDOMAX, Z0MIN, Z0MAX, CSOIL, PTU, LLANDUSE, LSOIL, LOCAL, LVCOEF, ZTOPV, ZBOTV)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l02309">module_sf_noahlsm.F:2318</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a0500272007439fcc4870091db509d5e0"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a0500272007439fcc4870091db509d5e0">module_sf_noahlsm::rsmax_data</a></div><div class="ttdeci">real rsmax_data</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00043">module_sf_noahlsm.F:43</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a0de1ade2206d62259245f281a9751200"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a0de1ade2206d62259245f281a9751200">module_sf_noahlsm::cmcmax_data</a></div><div class="ttdeci">real cmcmax_data</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00043">module_sf_noahlsm.F:43</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a0f671f01ac448828a19839c29fe2a80d"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a0f671f01ac448828a19839c29fe2a80d">module_sf_noahlsm::rgltbl</a></div><div class="ttdeci">real, dimension(1:nlus) rgltbl</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00036">module_sf_noahlsm.F:36</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a120cf314f9b0b4e08b223b15858faefe"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a120cf314f9b0b4e08b223b15858faefe">module_sf_noahlsm::err_message</a></div><div class="ttdeci">character *256 err_message</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00061">module_sf_noahlsm.F:61</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a162eaa508d912b165fd5d5b59f9c8276"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a162eaa508d912b165fd5d5b59f9c8276">module_sf_noahlsm::high_density_residential</a></div><div class="ttdeci">integer high_density_residential</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00032">module_sf_noahlsm.F:32</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a1e5f83b829493815912f8e801edd7b17"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a1e5f83b829493815912f8e801edd7b17">module_sf_noahlsm::zbot_data</a></div><div class="ttdeci">real zbot_data</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00056">module_sf_noahlsm.F:56</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a1f4bae7bb5581ef61d8c22e58df4c88f"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a1f4bae7bb5581ef61d8c22e58df4c88f">module_sf_noahlsm::devap</a></div><div class="ttdeci">subroutine devap(EDIR, ETP1, SMC, ZSOIL, SHDFAC, SMCMAX, BEXP, DKSAT, DWSAT, SMCDRY, SMCREF, SMCWLT, FXEXP)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l01185">module_sf_noahlsm.F:1187</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a264ef4f6e4e0348d29a24399729c47b1"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a264ef4f6e4e0348d29a24399729c47b1">module_sf_noahlsm::qtz</a></div><div class="ttdeci">real, dimension(1:nsltype) qtz</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00049">module_sf_noahlsm.F:49</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a2b8557df16e078c40e5bea80224b951c"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a2b8557df16e078c40e5bea80224b951c">module_sf_noahlsm::nsltype</a></div><div class="ttdeci">integer, parameter nsltype</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00047">module_sf_noahlsm.F:47</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a2c126e8a645fbfff910ba7d7415078e5"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a2c126e8a645fbfff910ba7d7415078e5">module_sf_noahlsm::laimaxtbl</a></div><div class="ttdeci">real, dimension(1:nlus) laimaxtbl</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00036">module_sf_noahlsm.F:36</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a2d3913e03c9d3f6dc2f1817689a70aa7"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a2d3913e03c9d3f6dc2f1817689a70aa7">module_sf_noahlsm::satpsi</a></div><div class="ttdeci">real, dimension(1:nsltype) satpsi</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00049">module_sf_noahlsm.F:49</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a2e0170eed7801b6976d18285d32a1c57"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a2e0170eed7801b6976d18285d32a1c57">module_sf_noahlsm::sstep</a></div><div class="ttdeci">subroutine sstep(SH2OOUT, SH2OIN, CMC, RHSTT, RHSCT, DT, NSOIL, SMCMAX, CMCMAX, RUNOFF3, ZSOIL, SMC, SICE, AI, BI, CI, INFXS1RT)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l03939">module_sf_noahlsm.F:3942</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a347f1f27afb384360fada49937ebf1cc"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a347f1f27afb384360fada49937ebf1cc">module_sf_noahlsm::slpcats</a></div><div class="ttdeci">integer slpcats</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00053">module_sf_noahlsm.F:53</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a3b4a7f68699fbc22922e958770009b57"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a3b4a7f68699fbc22922e958770009b57">module_sf_noahlsm::wdfcnd</a></div><div class="ttdeci">subroutine wdfcnd(WDF, WCND, SMC, SMCMAX, BEXP, DKSAT, DWSAT, SICEMAX)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l04450">module_sf_noahlsm.F:4452</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a3d56b3f7eeeccda9e1d6f7d0aecfb149"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a3d56b3f7eeeccda9e1d6f7d0aecfb149">module_sf_noahlsm::smlow_data</a></div><div class="ttdeci">real smlow_data</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00056">module_sf_noahlsm.F:56</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a41b56481dda78f3181c7e40721fa79a0"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a41b56481dda78f3181c7e40721fa79a0">module_sf_noahlsm::sigma</a></div><div class="ttdeci">real, parameter sigma</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00024">module_sf_noahlsm.F:24</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a421c11109bef5a1c768d721cb746c495"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a421c11109bef5a1c768d721cb746c495">module_sf_noahlsm::bb</a></div><div class="ttdeci">real, dimension(1:nsltype) bb</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00049">module_sf_noahlsm.F:49</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a433b2b986f9e11459dc99a8a99db6ba7"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a433b2b986f9e11459dc99a8a99db6ba7">module_sf_noahlsm::canres</a></div><div class="ttdeci">subroutine canres(SOLAR, CH, SFCTMP, Q2, SFCPRS, SMC, ZSOIL, NSOIL, SMCWLT, SMCREF, RSMIN, RC, PC, NROOT, Q2SAT, DQSDT2, TOPT, RSMAX, RGL, HS, XLAI, RCS, RCT, RCQ, RCSOIL, EMISSI)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l01005">module_sf_noahlsm.F:1009</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a49b5bd6e866a73374623128552be22ec"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a49b5bd6e866a73374623128552be22ec">module_sf_noahlsm::cfactr_data</a></div><div class="ttdeci">real cfactr_data</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00043">module_sf_noahlsm.F:43</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a5312fbbf31302c20e6823a3d2e97033b"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a5312fbbf31302c20e6823a3d2e97033b">module_sf_noahlsm::penman</a></div><div class="ttdeci">subroutine penman(SFCTMP, SFCPRS, CH, T2V, TH2, PRCP, FDOWN, T24, SSOIL, Q2, Q2SAT, ETP, RCH, EPSCA, RR, SNOWNG, FRZGRA, DQSDT2, FLX2, EMISSI_IN, SNEQV, T1, SNCOVR, AOASIS, ALBEDO, SOLDN, FVB, GAMA, STC1, ETPN, FLX4, UA_PHYS)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l02189">module_sf_noahlsm.F:2193</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a5394697bf41b6a406cf68211008c2c05"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a5394697bf41b6a406cf68211008c2c05">module_sf_noahlsm::f11</a></div><div class="ttdeci">real, dimension(1:nsltype) f11</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00049">module_sf_noahlsm.F:49</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a54e48804c7badd0dd8544b8c1dbcdf5f"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a54e48804c7badd0dd8544b8c1dbcdf5f">module_sf_noahlsm::emissi_s</a></div><div class="ttdeci">real, parameter emissi_s</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00024">module_sf_noahlsm.F:24</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a5620825a183522809f7fd87ce222bc75"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a5620825a183522809f7fd87ce222bc75">module_sf_noahlsm::albedomintbl</a></div><div class="ttdeci">real, dimension(1:nlus) albedomintbl</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00036">module_sf_noahlsm.F:36</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a578d0dc05848d5bc7fb823e379da5cdd"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a578d0dc05848d5bc7fb823e379da5cdd">module_sf_noahlsm::tbnd</a></div><div class="ttdeci">subroutine tbnd(TU, TB, ZSOIL, ZBOT, K, NSOIL, TBND1)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l04069">module_sf_noahlsm.F:4070</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a58888da8d933fe6e55e825b83159658b"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a58888da8d933fe6e55e825b83159658b">module_sf_noahlsm::smflx</a></div><div class="ttdeci">subroutine smflx(SMC, NSOIL, CMC, DT, PRCP1, ZSOIL, SH2O, SLOPE, KDT, FRZFACT, SMCMAX, BEXP, SMCWLT, DKSAT, DWSAT, SHDFAC, CMCMAX, RUNOFF1, RUNOFF2, RUNOFF3, EDIR, EC, ET, DRIP, SFHEAD1RT, INFXS1RT)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l02663">module_sf_noahlsm.F:2670</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a5beb42f74e1a357ccfc0e904f356b33a"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a5beb42f74e1a357ccfc0e904f356b33a">module_sf_noahlsm::frh2o</a></div><div class="ttdeci">subroutine frh2o(FREE, TKELV, SMC, SH2O, SMCMAX, BEXP, PSIS)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l01443">module_sf_noahlsm.F:1444</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a5d089c57c48085d25b95857c682922da"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a5d089c57c48085d25b95857c682922da">module_sf_noahlsm::snksrc</a></div><div class="ttdeci">subroutine snksrc(TSNSR, TAVG, SMC, SH2O, ZSOIL, NSOIL, SMCMAX, PSISAT, BEXP, DT, K, QTOT)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l02911">module_sf_noahlsm.F:2913</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a5e4d45f6d99b175703cb7cf1c2485e8a"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a5e4d45f6d99b175703cb7cf1c2485e8a">module_sf_noahlsm::zbotvtbl</a></div><div class="ttdeci">real, dimension(1:nlus) zbotvtbl</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00036">module_sf_noahlsm.F:36</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a5e842b9c23b43bc3ccf873a9bf9612af"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a5e842b9c23b43bc3ccf873a9bf9612af">module_sf_noahlsm::salp_data</a></div><div class="ttdeci">real salp_data</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00056">module_sf_noahlsm.F:56</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a6029894190d9a2de7f0bfe83f84821ed"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a6029894190d9a2de7f0bfe83f84821ed">module_sf_noahlsm::low_density_residential</a></div><div class="ttdeci">integer low_density_residential</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00032">module_sf_noahlsm.F:32</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a653d3903e2acbd4d19387ea434944093"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a653d3903e2acbd4d19387ea434944093">module_sf_noahlsm::cpice</a></div><div class="ttdeci">real, parameter cpice</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00024">module_sf_noahlsm.F:24</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a66770731f9d207f81564cc084cdcd40e"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a66770731f9d207f81564cc084cdcd40e">module_sf_noahlsm::nslope</a></div><div class="ttdeci">integer, parameter nslope</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00054">module_sf_noahlsm.F:54</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a6c8c21728a7859d57a4e867f2df6d521"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a6c8c21728a7859d57a4e867f2df6d521">module_sf_noahlsm::czil_data</a></div><div class="ttdeci">real czil_data</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00056">module_sf_noahlsm.F:56</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a6e407ba242e1b07a68eb56f1180447c6"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a6e407ba242e1b07a68eb56f1180447c6">module_sf_noahlsm::drysmc</a></div><div class="ttdeci">real, dimension(1:nsltype) drysmc</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00049">module_sf_noahlsm.F:49</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a6eb802ec31e08c8d45492d3057202b09"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a6eb802ec31e08c8d45492d3057202b09">module_sf_noahlsm::nlus</a></div><div class="ttdeci">integer, parameter nlus</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00033">module_sf_noahlsm.F:33</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a6eefa55e3997176fcb176348dbabfa4e"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a6eefa55e3997176fcb176348dbabfa4e">module_sf_noahlsm::ztopvtbl</a></div><div class="ttdeci">real, dimension(1:nlus) ztopvtbl</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00036">module_sf_noahlsm.F:36</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a72bf7902c4cdf8a89ad09a592be5381a"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a72bf7902c4cdf8a89ad09a592be5381a">module_sf_noahlsm::z0maxtbl</a></div><div class="ttdeci">real, dimension(1:nlus) z0maxtbl</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00036">module_sf_noahlsm.F:36</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a786fd6e5794b80a6cbb602a290a6fd6a"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a786fd6e5794b80a6cbb602a290a6fd6a">module_sf_noahlsm::frzk_data</a></div><div class="ttdeci">real frzk_data</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00056">module_sf_noahlsm.F:56</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a7946ddfb3b6fc624a9e87acbfa08fe1b"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a7946ddfb3b6fc624a9e87acbfa08fe1b">module_sf_noahlsm::tdfcnd</a></div><div class="ttdeci">subroutine tdfcnd(DF, SMC, QZ, SMCMAX, SH2O, BEXP, PSISAT, SOILTYP, OPT_THCND)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l04113">module_sf_noahlsm.F:4114</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a7a50ad4eacd814b850f723a4b67a8ead"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a7a50ad4eacd814b850f723a4b67a8ead">module_sf_noahlsm::refsmc</a></div><div class="ttdeci">real, dimension(1:nsltype) refsmc</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00049">module_sf_noahlsm.F:49</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a7a78bcce992262a6c96711208974f7f1"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a7a78bcce992262a6c96711208974f7f1">module_sf_noahlsm::alcalc</a></div><div class="ttdeci">subroutine alcalc(ALB, SNOALB, EMBRD, SHDFAC, SHDMIN, SNCOVR, TSNOW, ALBEDO, EMISSI, DT, SNOWNG, SNOTIME1, LVCOEF)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00887">module_sf_noahlsm.F:889</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a80bccc6a8e3641348467b3867a35ca00"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a80bccc6a8e3641348467b3867a35ca00">module_sf_noahlsm::high_intensity_industrial</a></div><div class="ttdeci">integer high_intensity_industrial</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00032">module_sf_noahlsm.F:32</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a81f1f2ceb78e6b6a447b394803dee3c7"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a81f1f2ceb78e6b6a447b394803dee3c7">module_sf_noahlsm::lsubf</a></div><div class="ttdeci">real, parameter lsubf</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00024">module_sf_noahlsm.F:24</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a86862de601c92fc02c2501c1827c3da4"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a86862de601c92fc02c2501c1827c3da4">module_sf_noahlsm::slcats</a></div><div class="ttdeci">integer slcats</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00046">module_sf_noahlsm.F:46</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a89de2b557283473efeeec5d3d49c7e7e"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a89de2b557283473efeeec5d3d49c7e7e">module_sf_noahlsm::sflx</a></div><div class="ttdeci">subroutine sflx(IILOC, JJLOC, FFROZP, ISURBAN, DT, ZLVL, NSOIL, SLDPTH, LOCAL, LLANDUSE, LSOIL, LWDN, SOLDN, SOLNET, SFCPRS, PRCP, SFCTMP, Q2, SFCSPD, COSZ, PRCPRAIN, SOLARDIRECT, TH2, Q2SAT, DQSDT2, VEGTYP, SOILTYP, SLOPETYP, SHDFAC, SHDMIN, SHDMAX, ALB, SNOALB, TBOT, Z0BRD, Z0, EMISSI, EMBRD, CMC, T1, STC, SMC, SH2O, SNOWH, SNEQV, ALBEDO, CH, CM, ETA, SHEAT, ETA_KINEMATIC, FDOWN, EC, EDIR, ET, ETT, ESNOW, DRIP, DEW, BETA, ETP, SSOIL, FLX1, FLX2, FLX3, FLX4, FVB, FBUR, FGSN, UA_PHYS, SNOMLT, SNCOVR, RUNOFF1, RUNOFF2, RUNOFF3, RC, PC, RSMIN, XLAI, RCS, RCT, RCQ, RCSOIL, SOILW, SOILM, Q1, SMAV, RDLAI2D, USEMONALB, SNOTIME1, RIBB, SMCWLT, SMCDRY, SMCREF, SMCMAX, NROOT, SFHEAD1RT, INFXS1RT, ETPND1, OPT_THCND, AOASIS, XSDA_QFX, HFX_PHY, QFX_PHY, XQNORM, fasdas, HCPCT_FASDAS)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00069">module_sf_noahlsm.F:100</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a8df53633c056358bfa76c698ee182f17"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a8df53633c056358bfa76c698ee182f17">module_sf_noahlsm::rd</a></div><div class="ttdeci">real, parameter rd</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00024">module_sf_noahlsm.F:24</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a901df854f3a4654ea71bfa71ad88282f"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a901df854f3a4654ea71bfa71ad88282f">module_sf_noahlsm::shdtbl</a></div><div class="ttdeci">real, dimension(1:nlus) shdtbl</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00036">module_sf_noahlsm.F:36</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a935945ddf12582dad80c67c9c88034ac"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a935945ddf12582dad80c67c9c88034ac">module_sf_noahlsm::satdk</a></div><div class="ttdeci">real, dimension(1:nsltype) satdk</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00049">module_sf_noahlsm.F:49</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a9b543a894e8a65d824249871d7f936d3"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a9b543a894e8a65d824249871d7f936d3">module_sf_noahlsm::topt_data</a></div><div class="ttdeci">real topt_data</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00043">module_sf_noahlsm.F:43</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_a9cb2add5ba6296cc7aac44442d42b2d4"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#a9cb2add5ba6296cc7aac44442d42b2d4">module_sf_noahlsm::albedomaxtbl</a></div><div class="ttdeci">real, dimension(1:nlus) albedomaxtbl</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00036">module_sf_noahlsm.F:36</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_aa0847a080464d5bff86f7fc48a8eae13"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#aa0847a080464d5bff86f7fc48a8eae13">module_sf_noahlsm::rstbl</a></div><div class="ttdeci">real, dimension(1:nlus) rstbl</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00036">module_sf_noahlsm.F:36</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_aa1474706df3973c92ce572eb5517a6ca"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#aa1474706df3973c92ce572eb5517a6ca">module_sf_noahlsm::lucats</a></div><div class="ttdeci">integer lucats</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00030">module_sf_noahlsm.F:30</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_aa418d6be3fc3de942821faf6fb68e3f8"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#aa418d6be3fc3de942821faf6fb68e3f8">module_sf_noahlsm::transp</a></div><div class="ttdeci">subroutine transp(ET, NSOIL, ETP1, SMC, CMC, ZSOIL, SHDFAC, SMCWLT, CMCMAX, PC, CFACTR, SMCREF, SFCTMP, Q2, NROOT, RTDIS)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l04344">module_sf_noahlsm.F:4347</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_aa4d4ac6f0a95c2a6bce0c39cea8fe74d"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#aa4d4ac6f0a95c2a6bce0c39cea8fe74d">module_sf_noahlsm::emissmintbl</a></div><div class="ttdeci">real, dimension(1:nlus) emissmintbl</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00036">module_sf_noahlsm.F:36</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_aa9d68d330c3a7476f326ead707abd9a8"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#aa9d68d330c3a7476f326ead707abd9a8">module_sf_noahlsm::sfcdif_off</a></div><div class="ttdeci">subroutine sfcdif_off(ZLM, Z0, THZ0, THLM, SFCSPD, CZIL, AKMS, AKHS)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l04511">module_sf_noahlsm.F:4512</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_aae70644775d8b7023c8c3a7ba90616a8"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#aae70644775d8b7023c8c3a7ba90616a8">module_sf_noahlsm::sbeta_data</a></div><div class="ttdeci">real sbeta_data</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00056">module_sf_noahlsm.F:56</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_aaee442f9d981b7c296c5932352365351"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#aaee442f9d981b7c296c5932352365351">module_sf_noahlsm::shflx</a></div><div class="ttdeci">subroutine shflx(SSOIL, STC, SMC, SMCMAX, NSOIL, T1, DT, YY, ZZ1, ZSOIL, TBOT, ZBOT, SMCWLT, PSISAT, SH2O, BEXP, F1, DF1, QUARTZ, CSOIL, VEGTYP, ISURBAN, SOILTYP, OPT_THCND, HCPCT_FASDAS)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l02594">module_sf_noahlsm.F:2598</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_aaf2ec4ae19423d4c1b907274266e1f75"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#aaf2ec4ae19423d4c1b907274266e1f75">module_sf_noahlsm::maxalb</a></div><div class="ttdeci">real, dimension(1:nlus) maxalb</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00036">module_sf_noahlsm.F:36</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_ab19c8eb3a76242cd834222e15c519613"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#ab19c8eb3a76242cd834222e15c519613">module_sf_noahlsm::srt</a></div><div class="ttdeci">subroutine srt(RHSTT, EDIR, ET, SH2O, SH2OA, NSOIL, PCPDRP, ZSOIL, DWSAT, DKSAT, SMCMAX, BEXP, RUNOFF1, RUNOFF2, DT, SMCWLT, SLOPE, KDT, FRZX, SICE, AI, BI, CI, SFHEAD1RT, INFXS1RT)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l03642">module_sf_noahlsm.F:3646</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_ab26c159cdc7754b2a7c741d846fb9e28"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#ab26c159cdc7754b2a7c741d846fb9e28">module_sf_noahlsm::satdw</a></div><div class="ttdeci">real, dimension(1:nsltype) satdw</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00049">module_sf_noahlsm.F:49</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_ab273c118cc131cacda35bba9180402f9"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#ab273c118cc131cacda35bba9180402f9">module_sf_noahlsm::wltsmc</a></div><div class="ttdeci">real, dimension(1:nsltype) wltsmc</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00049">module_sf_noahlsm.F:49</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_ab3693cb1c40b1bd7b4db5e96337f6eef"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#ab3693cb1c40b1bd7b4db5e96337f6eef">module_sf_noahlsm::snowz0</a></div><div class="ttdeci">subroutine snowz0(SNCOVR, Z0, Z0BRD, SNOWH, FBUR, FGSN, SHDMAX, UA_PHYS)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l03541">module_sf_noahlsm.F:3542</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_ab786b4f52dbea2106470993f2ea20e69"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#ab786b4f52dbea2106470993f2ea20e69">module_sf_noahlsm::tmpavg</a></div><div class="ttdeci">subroutine tmpavg(TAVG, TUP, TM, TDN, ZSOIL, NSOIL, K)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l04239">module_sf_noahlsm.F:4240</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_ab7e465439f409557715a28bea71551c1"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#ab7e465439f409557715a28bea71551c1">module_sf_noahlsm::snow_new</a></div><div class="ttdeci">subroutine snow_new(TEMP, NEWSN, SNOWH, SNDENS)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l03590">module_sf_noahlsm.F:3591</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_ab98144204f7c38b7c42ae05ce73403b2"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#ab98144204f7c38b7c42ae05ce73403b2">module_sf_noahlsm::natural</a></div><div class="ttdeci">integer natural</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00031">module_sf_noahlsm.F:31</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_ab9a5163c0bdd9b8af04056e8b88daa4e"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#ab9a5163c0bdd9b8af04056e8b88daa4e">module_sf_noahlsm::laimintbl</a></div><div class="ttdeci">real, dimension(1:nlus) laimintbl</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00036">module_sf_noahlsm.F:36</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_aba39fbf0ed9d113693d485869fc69bad"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#aba39fbf0ed9d113693d485869fc69bad">module_sf_noahlsm::devap_hydro</a></div><div class="ttdeci">subroutine devap_hydro(EDIR, ETP1, SMC, ZSOIL, SHDFAC, SMCMAX, BEXP, DKSAT, DWSAT, SMCDRY, SMCREF, SMCWLT, FXEXP, SFHEAD1RT, ETPND1, DT)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l01226">module_sf_noahlsm.F:1229</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_abb6e84ee87a6fdb3281c33e8e8457a04"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#abb6e84ee87a6fdb3281c33e8e8457a04">module_sf_noahlsm::csnow</a></div><div class="ttdeci">subroutine csnow(SNCOND, DSNOW)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l01144">module_sf_noahlsm.F:1145</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_abe6654781f59a713e1ac61fda3eb633b"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#abe6654781f59a713e1ac61fda3eb633b">module_sf_noahlsm::sltype</a></div><div class="ttdeci">character(len=256) sltype</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00048">module_sf_noahlsm.F:48</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_abfdd114973412069ebbfb3a61af8d995"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#abfdd114973412069ebbfb3a61af8d995">module_sf_noahlsm::lvcoef_data</a></div><div class="ttdeci">real lvcoef_data</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00059">module_sf_noahlsm.F:59</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_ac05feb2a0ff4bb9285433492b2eb10f4"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#ac05feb2a0ff4bb9285433492b2eb10f4">module_sf_noahlsm::csoil_data</a></div><div class="ttdeci">real csoil_data</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00056">module_sf_noahlsm.F:56</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_ac6e3e7bb3f0322070546653306177216"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#ac6e3e7bb3f0322070546653306177216">module_sf_noahlsm::rosr12</a></div><div class="ttdeci">subroutine rosr12(P, A, B, C, D, DELTA, NSOIL)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l02531">module_sf_noahlsm.F:2532</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_acbe287caffdd1287fb71954b6284d2f5"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#acbe287caffdd1287fb71954b6284d2f5">module_sf_noahlsm::refkdt_data</a></div><div class="ttdeci">real refkdt_data</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00056">module_sf_noahlsm.F:56</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_acc9389a964a5c2195267b0d1b6a71ced"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#acc9389a964a5c2195267b0d1b6a71ced">module_sf_noahlsm::fxexp_data</a></div><div class="ttdeci">real fxexp_data</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00056">module_sf_noahlsm.F:56</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_ad15804ed9573673deb4f95b3f160eeb2"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#ad15804ed9573673deb4f95b3f160eeb2">module_sf_noahlsm::fac2mit</a></div><div class="ttdeci">subroutine fac2mit(SMCMAX, FLIMIT)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l01420">module_sf_noahlsm.F:1421</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_ad1881be5e002e66566e6119f6ca6e032"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#ad1881be5e002e66566e6119f6ca6e032">module_sf_noahlsm::smhigh_data</a></div><div class="ttdeci">real smhigh_data</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00056">module_sf_noahlsm.F:56</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_adacf01be4e33445ea186feffce24eb35"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#adacf01be4e33445ea186feffce24eb35">module_sf_noahlsm::hstep</a></div><div class="ttdeci">subroutine hstep(STCOUT, STCIN, RHSTS, DT, NSOIL, AI, BI, CI)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l01849">module_sf_noahlsm.F:1850</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_ae07d087354ac15d439a02c8f0a1d24e4"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#ae07d087354ac15d439a02c8f0a1d24e4">module_sf_noahlsm::cph2o</a></div><div class="ttdeci">real, parameter cph2o</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00024">module_sf_noahlsm.F:24</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_ae24910d9fdc3b5b4d0ed62901e8c53bd"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#ae24910d9fdc3b5b4d0ed62901e8c53bd">module_sf_noahlsm::slope_data</a></div><div class="ttdeci">real, dimension(1:nslope) slope_data</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00055">module_sf_noahlsm.F:55</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_ae27e8294cc66ecbb23f2a9d239a3c3d7"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#ae27e8294cc66ecbb23f2a9d239a3c3d7">module_sf_noahlsm::snopac</a></div><div class="ttdeci">subroutine snopac(ETP, ETA, PRCP, PRCPF, SNOWNG, SMC, SMCMAX, SMCWLT, SMCREF, SMCDRY, CMC, CMCMAX, NSOIL, DT, SBETA, DF1, Q2, T1, SFCTMP, T24, TH2, FDOWN, F1, SSOIL, STC, EPSCA, SFCPRS, BEXP, PC, RCH, RR, CFACTR, SNCOVR, ESD, SNDENS, SNOWH, SH2O, SLOPE, KDT, FRZFACT, PSISAT, ZSOIL, DWSAT, DKSAT, TBOT, ZBOT, SHDFAC, RUNOFF1, RUNOFF2, RUNOFF3, EDIR, EC, ET, ETT, NROOT, SNOMLT, RTDIS, QUARTZ, FXEXP, CSOIL, BETA, DRIP, DEW, FLX1, FLX2, FLX3, ESNOW, ETNS, EMISSI, RIBB, SOLDN, ISURBAN, VEGTYP, ETPN, FLX4, UA_PHYS, SFHEAD1RT, INFXS1RT, ETPND1, SOILTYP, OPT_THCND, QFX_PHY, fasdas, HCPCT_FASDAS)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l02999">module_sf_noahlsm.F:3015</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_ae38d77ba0e04158bf5681f63787f5615"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#ae38d77ba0e04158bf5681f63787f5615">module_sf_noahlsm::lutype</a></div><div class="ttdeci">character(len=256) lutype</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00034">module_sf_noahlsm.F:34</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_ae3fd374e34b9af10dd489dfc1965d827"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#ae3fd374e34b9af10dd489dfc1965d827">module_sf_noahlsm::refdk_data</a></div><div class="ttdeci">real refdk_data</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00056">module_sf_noahlsm.F:56</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_ae65310d4c0555dd149f413ff42737077"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#ae65310d4c0555dd149f413ff42737077">module_sf_noahlsm::evapo</a></div><div class="ttdeci">subroutine evapo(ETA1, SMC, NSOIL, CMC, ETP1, DT, ZSOIL, SH2O, SMCMAX, BEXP, PC, SMCWLT, DKSAT, DWSAT, SMCREF, SHDFAC, CMCMAX, SMCDRY, CFACTR, EDIR, EC, ET, ETT, SFCTMP, Q2, NROOT, RTDIS, FXEXP, SFHEAD1RT, ETPND1)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l01319">module_sf_noahlsm.F:1326</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_ae6d35ff66196a3ab369a3e87149ddcdc"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#ae6d35ff66196a3ab369a3e87149ddcdc">module_sf_noahlsm::snowpack</a></div><div class="ttdeci">subroutine snowpack(ESD, DTSEC, SNOWH, SNDENS, TSNOW, TSOIL, SNOMLT, UA_PHYS)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l03406">module_sf_noahlsm.F:3407</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_ae7ad09a03325fa6a08429faa078bb8f2"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#ae7ad09a03325fa6a08429faa078bb8f2">module_sf_noahlsm::snfrac</a></div><div class="ttdeci">subroutine snfrac(SNEQV, SNUP, SALP, SNOWH, SNCOVR, XLAI, SHDFAC, FVB, GAMA, FBUR, FGSN, ZTOPV, ZBOTV, UA_PHYS)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l02806">module_sf_noahlsm.F:2809</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_ae7e9abc3699009623585d342ed700ea8"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#ae7e9abc3699009623585d342ed700ea8">module_sf_noahlsm::maxsmc</a></div><div class="ttdeci">real, dimension(1:nsltype) maxsmc</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00049">module_sf_noahlsm.F:49</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_aef1bae6bfa7f8eb613369181f2ca0bcd"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#aef1bae6bfa7f8eb613369181f2ca0bcd">module_sf_noahlsm::z0mintbl</a></div><div class="ttdeci">real, dimension(1:nlus) z0mintbl</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00036">module_sf_noahlsm.F:36</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_af49267d813703d06dc522c006a0efdd8"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#af49267d813703d06dc522c006a0efdd8">module_sf_noahlsm::snuptbl</a></div><div class="ttdeci">real, dimension(1:nlus) snuptbl</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00036">module_sf_noahlsm.F:36</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_af54c396581833689886321e9937a8b6b"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#af54c396581833689886321e9937a8b6b">module_sf_noahlsm::nrotbl</a></div><div class="ttdeci">integer, dimension(1:nlus) nrotbl</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00035">module_sf_noahlsm.F:35</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_af6a31bb1e4de31d7e62c196cbf6dc2ee"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#af6a31bb1e4de31d7e62c196cbf6dc2ee">module_sf_noahlsm::emissmaxtbl</a></div><div class="ttdeci">real, dimension(1:nlus) emissmaxtbl</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00036">module_sf_noahlsm.F:36</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_af967731a9437616e8e2b5bb6f3e1712e"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#af967731a9437616e8e2b5bb6f3e1712e">module_sf_noahlsm::bare</a></div><div class="ttdeci">integer bare</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l00030">module_sf_noahlsm.F:30</a></div></div>
<div class="ttc" id="anamespacemodule__sf__noahlsm_html_af9f7c237f83a49f3981875bf59dd7816"><div class="ttname"><a href="namespacemodule__sf__noahlsm.html#af9f7c237f83a49f3981875bf59dd7816">module_sf_noahlsm::hrt</a></div><div class="ttdeci">subroutine hrt(RHSTS, STC, SMC, SMCMAX, NSOIL, ZSOIL, YY, ZZ1, TBOT, ZBOT, PSISAT, SH2O, DT, BEXP, SOILTYP, OPT_THCND, F1, DF1, QUARTZ, CSOIL, AI, BI, CI, VEGTYP, ISURBAN, HCPCT_FASDAS)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__noahlsm_8F_source.html#l01584">module_sf_noahlsm.F:1588</a></div></div>
<div class="ttc" id="anamespacempas__atmphys__constants_html"><div class="ttname"><a href="namespacempas__atmphys__constants.html">mpas_atmphys_constants</a></div><div class="ttdef"><b>Definition:</b> <a href="core__atmosphere_2physics_2mpas__atmphys__constants_8F_source.html#l00009">mpas_atmphys_constants.F:9</a></div></div>
<div class="ttc" id="anamespacempas__atmphys__constants_html_a08b81a4441d9a2086b9caea75cea1285"><div class="ttname"><a href="namespacempas__atmphys__constants.html#a08b81a4441d9a2086b9caea75cea1285">mpas_atmphys_constants::cice</a></div><div class="ttdeci">real(kind=rkind), parameter cice</div><div class="ttdef"><b>Definition:</b> <a href="core__atmosphere_2physics_2mpas__atmphys__constants_8F_source.html#l00074">mpas_atmphys_constants.F:74</a></div></div>
<div class="ttc" id="anamespacempas__atmphys__constants_html_a29666893866b300a606b1d995d182d4e"><div class="ttname"><a href="namespacempas__atmphys__constants.html#a29666893866b300a606b1d995d182d4e">mpas_atmphys_constants::stbolt</a></div><div class="ttdeci">real(kind=rkind), parameter stbolt</div><div class="ttdef"><b>Definition:</b> <a href="core__atmosphere_2physics_2mpas__atmphys__constants_8F_source.html#l00071">mpas_atmphys_constants.F:71</a></div></div>
<div class="ttc" id="anamespacempas__atmphys__constants_html_a31b4d2a264901a4cbf284076c4828c0f"><div class="ttname"><a href="namespacempas__atmphys__constants.html#a31b4d2a264901a4cbf284076c4828c0f">mpas_atmphys_constants::xlv</a></div><div class="ttdeci">real(kind=rkind), parameter xlv</div><div class="ttdef"><b>Definition:</b> <a href="core__atmosphere_2physics_2mpas__atmphys__constants_8F_source.html#l00060">mpas_atmphys_constants.F:60</a></div></div>
<div class="ttc" id="anamespacempas__atmphys__constants_html_a92d08f338230a59f1a7b897a6bef4eed"><div class="ttname"><a href="namespacempas__atmphys__constants.html#a92d08f338230a59f1a7b897a6bef4eed">mpas_atmphys_constants::rho_w</a></div><div class="ttdeci">real(kind=rkind), parameter rho_w</div><div class="ttdef"><b>Definition:</b> <a href="core__atmosphere_2physics_2mpas__atmphys__constants_8F_source.html#l00053">mpas_atmphys_constants.F:53</a></div></div>
<div class="ttc" id="anamespacempas__atmphys__constants_html_aba58e22ad60aaeebff0afae9c623c38b"><div class="ttname"><a href="namespacempas__atmphys__constants.html#aba58e22ad60aaeebff0afae9c623c38b">mpas_atmphys_constants::xlf</a></div><div class="ttdeci">real(kind=rkind), parameter xlf</div><div class="ttdef"><b>Definition:</b> <a href="core__atmosphere_2physics_2mpas__atmphys__constants_8F_source.html#l00061">mpas_atmphys_constants.F:61</a></div></div>
<div class="ttc" id="anamespacempas__atmphys__constants_html_acc1b2857ee04cca1a37455c80fbd10bf"><div class="ttname"><a href="namespacempas__atmphys__constants.html#acc1b2857ee04cca1a37455c80fbd10bf">mpas_atmphys_constants::karman</a></div><div class="ttdeci">real(kind=rkind), parameter karman</div><div class="ttdef"><b>Definition:</b> <a href="core__atmosphere_2physics_2mpas__atmphys__constants_8F_source.html#l00069">mpas_atmphys_constants.F:69</a></div></div>
<div class="ttc" id="anamespacempas__atmphys__utilities_html"><div class="ttname"><a href="namespacempas__atmphys__utilities.html">mpas_atmphys_utilities</a></div><div class="ttdef"><b>Definition:</b> <a href="core__atmosphere_2physics_2mpas__atmphys__utilities_8F_source.html#l00009">mpas_atmphys_utilities.F:9</a></div></div>
<div class="ttc" id="anamespacempas__atmphys__utilities_html_aa49abb89b6ebc760010e08cbdade2706"><div class="ttname"><a href="namespacempas__atmphys__utilities.html#aa49abb89b6ebc760010e08cbdade2706">mpas_atmphys_utilities::physics_error_fatal</a></div><div class="ttdeci">subroutine, public physics_error_fatal(str)</div><div class="ttdef"><b>Definition:</b> <a href="core__atmosphere_2physics_2mpas__atmphys__utilities_8F_source.html#l00044">mpas_atmphys_utilities.F:45</a></div></div>
<div class="ttc" id="aparams_8m_html_a042889eb4a4c0a313ba885e8f173380d"><div class="ttname"><a href="params_8m.html#a042889eb4a4c0a313ba885e8f173380d">c2</a></div><div class="ttdeci">id c2()</div></div>
<div class="ttc" id="aparams_8m_html_a86bdec0d61a48a8ca4da1674058837cc"><div class="ttname"><a href="params_8m.html#a86bdec0d61a48a8ca4da1674058837cc">g</a></div><div class="ttdeci">id g()</div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5
</small></address>
</body>
</html>
