<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MPAS-analisys: src/core_atmosphere/physics/physics_wrf/module_sf_bep.F Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="logoMonanColor_75x75.png"/></td>
  <td id="projectalign">
   <div id="projectname">MPAS-analisys<span id="projectnumber">&#160;teste</span>
   </div>
   <div id="projectbrief">teste</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="dir_c53e21b94733dd8451b4d2db251c70bc.html">core_atmosphere</a></li><li class="navelem"><a class="el" href="dir_195703cd1d38332c0a06b72eede84187.html">physics</a></li><li class="navelem"><a class="el" href="dir_bc4ff68999f89a5d7c146546ef3424c5.html">physics_wrf</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle"><div class="title">module_sf_bep.F</div></div>
</div><!--header-->
<div class="contents">
<a href="module__sf__bep_8F.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a id="l00001" name="l00001"></a><span class="lineno"><a class="line" href="namespacemodule__sf__bep.html">    1</a></span><span class="keyword">MODULE</span> <a class="code hl_namespace" href="namespacemodule__sf__bep.html">module_sf_bep</a></div>
<div class="line"><a id="l00002" name="l00002"></a><span class="lineno">    2</span><span class="preprocessor">#if defined(mpas)</span></div>
<div class="line"><a id="l00003" name="l00003"></a><span class="lineno">    3</span><span class="preprocessor"></span><span class="keywordtype">use </span><a class="code hl_namespace" href="namespacempas__atmphys__utilities.html">mpas_atmphys_utilities</a>, <span class="keywordtype">only</span>: <a class="code hl_function" href="namespacempas__atmphys__utilities.html#aa49abb89b6ebc760010e08cbdade2706">physics_error_fatal</a></div>
<div class="line"><a id="l00004" name="l00004"></a><span class="lineno">    4</span><span class="preprocessor">#define FATAL_ERROR(M) call physics_error_fatal( M )</span></div>
<div class="line"><a id="l00005" name="l00005"></a><span class="lineno">    5</span><span class="preprocessor"></span><span class="preprocessor">#else</span></div>
<div class="line"><a id="l00006" name="l00006"></a><span class="lineno">    6</span><span class="preprocessor"></span><span class="keywordtype">use </span>module_wrf_error</div>
<div class="line"><a id="l00007" name="l00007"></a><span class="lineno">    7</span><span class="preprocessor">#define FATAL_ERROR(M) call wrf_error_fatal( M)</span></div>
<div class="line"><a id="l00008" name="l00008"></a><span class="lineno">    8</span><span class="preprocessor"></span><span class="comment">!USE module_model_constants</span></div>
<div class="line"><a id="l00009" name="l00009"></a><span class="lineno">    9</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l00010" name="l00010"></a><span class="lineno">   10</span><span class="preprocessor"></span> <span class="keywordtype">USE </span><a class="code hl_namespace" href="namespacemodule__sf__urban.html">module_sf_urban</a></div>
<div class="line"><a id="l00011" name="l00011"></a><span class="lineno">   11</span> </div>
<div class="line"><a id="l00012" name="l00012"></a><span class="lineno">   12</span><span class="comment">! SGClarke 09/11/2008</span></div>
<div class="line"><a id="l00013" name="l00013"></a><span class="lineno">   13</span><span class="comment">! Access urban_param.tbl values through calling urban_param_init in module_physics_init</span></div>
<div class="line"><a id="l00014" name="l00014"></a><span class="lineno">   14</span><span class="comment">! for CASE (BEPSCHEME) select sf_urban_physics</span></div>
<div class="line"><a id="l00015" name="l00015"></a><span class="lineno">   15</span><span class="comment">!</span></div>
<div class="line"><a id="l00016" name="l00016"></a><span class="lineno">   16</span><span class="comment">! -----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00017" name="l00017"></a><span class="lineno">   17</span><span class="comment">!  Dimension for the array used in the BEP module</span></div>
<div class="line"><a id="l00018" name="l00018"></a><span class="lineno">   18</span><span class="comment">! -----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00019" name="l00019"></a><span class="lineno">   19</span> </div>
<div class="line"><a id="l00020" name="l00020"></a><span class="lineno"><a class="line" href="namespacemodule__sf__bep.html#aed1522acfe1cfcab63a7734d8ebb32ae">   20</a></span>      <span class="keywordtype">integer</span> <a class="code hl_variable" href="namespacemodule__sf__bep.html#aed1522acfe1cfcab63a7734d8ebb32ae">nurbm</a>           <span class="comment">! Maximum number of urban classes    </span></div>
<div class="line"><a id="l00021" name="l00021"></a><span class="lineno">   21</span>      parameter(<a class="code hl_variable" href="namespacemodule__sf__bep.html#aed1522acfe1cfcab63a7734d8ebb32ae">nurbm</a>=3)</div>
<div class="line"><a id="l00022" name="l00022"></a><span class="lineno">   22</span> </div>
<div class="line"><a id="l00023" name="l00023"></a><span class="lineno"><a class="line" href="namespacemodule__sf__bep.html#abfc00f67431c88cb28d213407cda5fca">   23</a></span>      <span class="keywordtype">integer</span> <a class="code hl_variable" href="namespacemodule__sf__bep.html#abfc00f67431c88cb28d213407cda5fca">ndm</a>             <span class="comment">! Maximum number of street directions </span></div>
<div class="line"><a id="l00024" name="l00024"></a><span class="lineno">   24</span>      parameter(<a class="code hl_variable" href="namespacemodule__sf__bep.html#abfc00f67431c88cb28d213407cda5fca">ndm</a>=2)</div>
<div class="line"><a id="l00025" name="l00025"></a><span class="lineno">   25</span> </div>
<div class="line"><a id="l00026" name="l00026"></a><span class="lineno"><a class="line" href="namespacemodule__sf__bep.html#ab6b1a75584ebf7aec548086a00f5a3a2">   26</a></span>      <span class="keywordtype">integer</span> <a class="code hl_variable" href="namespacemodule__sf__bep.html#ab6b1a75584ebf7aec548086a00f5a3a2">nz_um</a>           <span class="comment">! Maximum number of vertical levels in the urban grid</span></div>
<div class="line"><a id="l00027" name="l00027"></a><span class="lineno">   27</span>      parameter(<a class="code hl_variable" href="namespacemodule__sf__bep.html#ab6b1a75584ebf7aec548086a00f5a3a2">nz_um</a>=18)</div>
<div class="line"><a id="l00028" name="l00028"></a><span class="lineno">   28</span> </div>
<div class="line"><a id="l00029" name="l00029"></a><span class="lineno"><a class="line" href="namespacemodule__sf__bep.html#a69dc7055b69f77f55dfcb82ac9770c56">   29</a></span>      <span class="keywordtype">integer</span> <a class="code hl_variable" href="namespacemodule__sf__bep.html#a69dc7055b69f77f55dfcb82ac9770c56">ng_u</a>            <span class="comment">! Number of grid levels in the ground</span></div>
<div class="line"><a id="l00030" name="l00030"></a><span class="lineno">   30</span>      parameter(<a class="code hl_variable" href="namespacemodule__sf__bep.html#a69dc7055b69f77f55dfcb82ac9770c56">ng_u</a>=10)</div>
<div class="line"><a id="l00031" name="l00031"></a><span class="lineno"><a class="line" href="namespacemodule__sf__bep.html#a6a0ea959e93ebb64bda9dfe38ce92994">   31</a></span>      <span class="keywordtype">integer</span> <a class="code hl_variable" href="namespacemodule__sf__bep.html#a6a0ea959e93ebb64bda9dfe38ce92994">nwr_u</a>            <span class="comment">! Number of grid levels in the walls or roofs</span></div>
<div class="line"><a id="l00032" name="l00032"></a><span class="lineno">   32</span>      parameter(<a class="code hl_variable" href="namespacemodule__sf__bep.html#a6a0ea959e93ebb64bda9dfe38ce92994">nwr_u</a>=10)</div>
<div class="line"><a id="l00033" name="l00033"></a><span class="lineno">   33</span> </div>
<div class="line"><a id="l00034" name="l00034"></a><span class="lineno"><a class="line" href="namespacemodule__sf__bep.html#a0d52a26f82bd0c0cf8a76bea001c9905">   34</a></span><span class="keywordtype">      real</span> <a class="code hl_variable" href="namespacemodule__sf__bep.html#a0d52a26f82bd0c0cf8a76bea001c9905">dz_u</a>                 <span class="comment">! Urban grid resolution</span></div>
<div class="line"><a id="l00035" name="l00035"></a><span class="lineno">   35</span>      parameter(<a class="code hl_variable" href="namespacemodule__sf__bep.html#a0d52a26f82bd0c0cf8a76bea001c9905">dz_u</a>=5.)</div>
<div class="line"><a id="l00036" name="l00036"></a><span class="lineno">   36</span> </div>
<div class="line"><a id="l00037" name="l00037"></a><span class="lineno">   37</span><span class="comment">! The change of ng_u, nwr_u should be done in agreement with the block data</span></div>
<div class="line"><a id="l00038" name="l00038"></a><span class="lineno">   38</span><span class="comment">!  in the routine &quot;surf_temp&quot; </span></div>
<div class="line"><a id="l00039" name="l00039"></a><span class="lineno">   39</span><span class="comment">! -----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00040" name="l00040"></a><span class="lineno">   40</span><span class="comment">!  Constant used in the BEP module</span></div>
<div class="line"><a id="l00041" name="l00041"></a><span class="lineno">   41</span><span class="comment">! -----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00042" name="l00042"></a><span class="lineno">   42</span>           </div>
<div class="line"><a id="l00043" name="l00043"></a><span class="lineno"><a class="line" href="namespacemodule__sf__bep.html#ac956b0ccc4743b9847b8f9e2c5e5ad63">   43</a></span><span class="keywordtype">      real</span> <a class="code hl_variable" href="namespacemodule__sf__bep.html#ac956b0ccc4743b9847b8f9e2c5e5ad63">vk</a>                 <span class="comment">! von Karman constant</span></div>
<div class="line"><a id="l00044" name="l00044"></a><span class="lineno"><a class="line" href="namespacemodule__sf__bep.html#accfe04a9ac7c32180691c196e2e00d4a">   44</a></span><span class="keywordtype">      real</span> <a class="code hl_variable" href="namespacemodule__sf__bep.html#accfe04a9ac7c32180691c196e2e00d4a">g_u</a>                  <span class="comment">! Gravity acceleration</span></div>
<div class="line"><a id="l00045" name="l00045"></a><span class="lineno"><a class="line" href="namespacemodule__sf__bep.html#a43054ed4c98f3ac9e3a5dc324ec7458f">   45</a></span><span class="keywordtype">      real</span> <a class="code hl_variable" href="namespacemodule__sf__bep.html#a43054ed4c98f3ac9e3a5dc324ec7458f">pi</a>                 <span class="comment">!</span></div>
<div class="line"><a id="l00046" name="l00046"></a><span class="lineno"><a class="line" href="namespacemodule__sf__bep.html#addfda01e830adb3a757aaecb94b26f64">   46</a></span><span class="keywordtype">      real</span> <a class="code hl_variable" href="namespacemodule__sf__bep.html#addfda01e830adb3a757aaecb94b26f64">r</a>                  <span class="comment">! Perfect gas constant</span></div>
<div class="line"><a id="l00047" name="l00047"></a><span class="lineno"><a class="line" href="namespacemodule__sf__bep.html#ae322728a3b7be919f956d83fcfbcc60a">   47</a></span><span class="keywordtype">      real</span> <a class="code hl_variable" href="namespacemodule__sf__bep.html#ae322728a3b7be919f956d83fcfbcc60a">cp_u</a>                 <span class="comment">! Specific heat at constant pressure</span></div>
<div class="line"><a id="l00048" name="l00048"></a><span class="lineno"><a class="line" href="namespacemodule__sf__bep.html#a36c77ea97f8e0c964f324b610af15a08">   48</a></span><span class="keywordtype">      real</span> <a class="code hl_variable" href="namespacemodule__sf__bep.html#a36c77ea97f8e0c964f324b610af15a08">rcp_u</a>                <span class="comment">!</span></div>
<div class="line"><a id="l00049" name="l00049"></a><span class="lineno"><a class="line" href="namespacemodule__sf__bep.html#a14b87836842c0cf3cccb0b78fde9b2b0">   49</a></span><span class="keywordtype">      real</span> <a class="code hl_variable" href="namespacemodule__sf__bep.html#a14b87836842c0cf3cccb0b78fde9b2b0">sigma</a>              <span class="comment">!</span></div>
<div class="line"><a id="l00050" name="l00050"></a><span class="lineno"><a class="line" href="namespacemodule__sf__bep.html#a52e6a0727e773b3279ac06328ae60b3b">   50</a></span><span class="keywordtype">      real</span> <a class="code hl_variable" href="namespacemodule__sf__bep.html#a52e6a0727e773b3279ac06328ae60b3b">p0</a>                 <span class="comment">! Reference pressure at the sea level</span></div>
<div class="line"><a id="l00051" name="l00051"></a><span class="lineno"><a class="line" href="namespacemodule__sf__bep.html#ab1764f8546c93ef96e065809e96f5999">   51</a></span><span class="keywordtype">      real</span> <a class="code hl_variable" href="namespacemodule__sf__bep.html#ab1764f8546c93ef96e065809e96f5999">cdrag</a>              <span class="comment">! Drag force constant</span></div>
<div class="line"><a id="l00052" name="l00052"></a><span class="lineno">   52</span>      parameter(<a class="code hl_variable" href="namespacemodule__sf__bep.html#ac956b0ccc4743b9847b8f9e2c5e5ad63">vk</a>=0.40,<a class="code hl_variable" href="namespacemodule__sf__bep.html#accfe04a9ac7c32180691c196e2e00d4a">g_u</a>=9.81,<a class="code hl_variable" href="namespacemodule__sf__bep.html#a43054ed4c98f3ac9e3a5dc324ec7458f">pi</a>=3.141592653,<a class="code hl_variable" href="namespacemodule__sf__bep.html#addfda01e830adb3a757aaecb94b26f64">r</a>=287.,<a class="code hl_variable" href="namespacemodule__sf__bep.html#ae322728a3b7be919f956d83fcfbcc60a">cp_u</a>=1004.)        </div>
<div class="line"><a id="l00053" name="l00053"></a><span class="lineno">   53</span>      parameter(<a class="code hl_variable" href="namespacemodule__sf__bep.html#a36c77ea97f8e0c964f324b610af15a08">rcp_u</a>=<a class="code hl_variable" href="namespacemodule__sf__bep.html#addfda01e830adb3a757aaecb94b26f64">r</a>/<a class="code hl_variable" href="namespacemodule__sf__bep.html#ae322728a3b7be919f956d83fcfbcc60a">cp_u</a>,<a class="code hl_variable" href="namespacemodule__sf__bep.html#a14b87836842c0cf3cccb0b78fde9b2b0">sigma</a>=5.67e-08,<a class="code hl_variable" href="namespacemodule__sf__bep.html#a52e6a0727e773b3279ac06328ae60b3b">p0</a>=1.e+5,<a class="code hl_variable" href="namespacemodule__sf__bep.html#ab1764f8546c93ef96e065809e96f5999">cdrag</a>=0.4)</div>
<div class="line"><a id="l00054" name="l00054"></a><span class="lineno">   54</span> </div>
<div class="line"><a id="l00055" name="l00055"></a><span class="lineno">   55</span><span class="comment">! -----------------------------------------------------------------------     </span></div>
<div class="line"><a id="l00056" name="l00056"></a><span class="lineno">   56</span> </div>
<div class="line"><a id="l00057" name="l00057"></a><span class="lineno">   57</span> </div>
<div class="line"><a id="l00058" name="l00058"></a><span class="lineno">   58</span> </div>
<div class="line"><a id="l00059" name="l00059"></a><span class="lineno">   59</span> </div>
<div class="line"><a id="l00060" name="l00060"></a><span class="lineno">   60</span>   <span class="keyword">CONTAINS</span></div>
<div class="line"><a id="l00061" name="l00061"></a><span class="lineno">   61</span> </div>
<div class="line"><a id="l00062" name="l00062"></a><span class="lineno"><a class="line" href="namespacemodule__sf__bep.html#a4e43ca6e75172d2dc55705c6adc6ed0d">   62</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a4e43ca6e75172d2dc55705c6adc6ed0d">bep</a>(FRC_URB2D,UTYPE_URB2D,itimestep,dz8w,dt,u_phy,v_phy,      &amp;</div>
<div class="line"><a id="l00063" name="l00063"></a><span class="lineno">   63</span>                      th_phy,rho,p_phy,swdown,glw,                    &amp;</div>
<div class="line"><a id="l00064" name="l00064"></a><span class="lineno">   64</span>                      gmt,julday,xlong,xlat,                          &amp;</div>
<div class="line"><a id="l00065" name="l00065"></a><span class="lineno">   65</span>                      declin_urb,cosz_urb2d,omg_urb2d,                &amp;</div>
<div class="line"><a id="l00066" name="l00066"></a><span class="lineno">   66</span>                      num_urban_layers,num_urban_hi,                  &amp;</div>
<div class="line"><a id="l00067" name="l00067"></a><span class="lineno">   67</span>                      trb_urb4d,tw1_urb4d,tw2_urb4d,tgb_urb4d,        &amp;</div>
<div class="line"><a id="l00068" name="l00068"></a><span class="lineno">   68</span>                      sfw1_urb3d,sfw2_urb3d,sfr_urb3d,sfg_urb3d,      &amp;</div>
<div class="line"><a id="l00069" name="l00069"></a><span class="lineno">   69</span>                      lp_urb2d,hi_urb2d,lb_urb2d,hgt_urb2d,           &amp;</div>
<div class="line"><a id="l00070" name="l00070"></a><span class="lineno">   70</span>                      a_u,a_v,a_t,a_e,b_u,b_v,                        &amp;</div>
<div class="line"><a id="l00071" name="l00071"></a><span class="lineno">   71</span>                      b_t,b_e,b_q,dlg,dl_u,sf,vl,                     &amp;</div>
<div class="line"><a id="l00072" name="l00072"></a><span class="lineno">   72</span>                      rl_up,rs_abs,emiss,grdflx_urb,                  &amp;</div>
<div class="line"><a id="l00073" name="l00073"></a><span class="lineno">   73</span>                      ids,ide, jds,jde, kds,kde,                      &amp;</div>
<div class="line"><a id="l00074" name="l00074"></a><span class="lineno">   74</span>                      ims,ime, jms,jme, kms,kme,                      &amp;</div>
<div class="line"><a id="l00075" name="l00075"></a><span class="lineno">   75</span>                      its,ite, jts,jte, kts,kte)                    </div>
<div class="line"><a id="l00076" name="l00076"></a><span class="lineno">   76</span> </div>
<div class="line"><a id="l00077" name="l00077"></a><span class="lineno">   77</span>      <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l00078" name="l00078"></a><span class="lineno">   78</span> </div>
<div class="line"><a id="l00079" name="l00079"></a><span class="lineno">   79</span><span class="comment">!------------------------------------------------------------------------</span></div>
<div class="line"><a id="l00080" name="l00080"></a><span class="lineno">   80</span><span class="comment">!     Input</span></div>
<div class="line"><a id="l00081" name="l00081"></a><span class="lineno">   81</span><span class="comment">!------------------------------------------------------------------------</span></div>
<div class="line"><a id="l00082" name="l00082"></a><span class="lineno">   82</span>   <span class="keywordtype">INTEGER</span> ::                       ids,ide, jds,jde, kds,kde,  &amp;</div>
<div class="line"><a id="l00083" name="l00083"></a><span class="lineno">   83</span>                                    ims,ime, jms,jme, kms,kme,  &amp;</div>
<div class="line"><a id="l00084" name="l00084"></a><span class="lineno">   84</span>                                    its,ite, jts,jte, kts,kte,  &amp;</div>
<div class="line"><a id="l00085" name="l00085"></a><span class="lineno">   85</span>                                    itimestep</div>
<div class="line"><a id="l00086" name="l00086"></a><span class="lineno">   86</span> </div>
<div class="line"><a id="l00087" name="l00087"></a><span class="lineno">   87</span> </div>
<div class="line"><a id="l00088" name="l00088"></a><span class="lineno">   88</span><span class="keywordtype">   REAL</span>, <span class="keywordtype">DIMENSION( ims:ime, kms:kme, jms:jme )</span>::   DZ8W</div>
<div class="line"><a id="l00089" name="l00089"></a><span class="lineno">   89</span><span class="keywordtype">   REAL</span>, <span class="keywordtype">DIMENSION( ims:ime, kms:kme, jms:jme )</span>::   P_PHY</div>
<div class="line"><a id="l00090" name="l00090"></a><span class="lineno">   90</span><span class="keywordtype">   REAL</span>, <span class="keywordtype">DIMENSION( ims:ime, kms:kme, jms:jme )</span>::   RHO</div>
<div class="line"><a id="l00091" name="l00091"></a><span class="lineno">   91</span><span class="keywordtype">   REAL</span>, <span class="keywordtype">DIMENSION( ims:ime, kms:kme, jms:jme )</span>::   TH_PHY</div>
<div class="line"><a id="l00092" name="l00092"></a><span class="lineno">   92</span><span class="keywordtype">   REAL</span>, <span class="keywordtype">DIMENSION( ims:ime, kms:kme, jms:jme )</span>::   T_PHY</div>
<div class="line"><a id="l00093" name="l00093"></a><span class="lineno">   93</span><span class="keywordtype">   REAL</span>, <span class="keywordtype">DIMENSION( ims:ime, kms:kme, jms:jme )</span>::   U_PHY</div>
<div class="line"><a id="l00094" name="l00094"></a><span class="lineno">   94</span><span class="keywordtype">   REAL</span>, <span class="keywordtype">DIMENSION( ims:ime, kms:kme, jms:jme )</span>::   V_PHY</div>
<div class="line"><a id="l00095" name="l00095"></a><span class="lineno">   95</span><span class="keywordtype">   REAL</span>, <span class="keywordtype">DIMENSION( ims:ime, kms:kme, jms:jme )</span>::   U</div>
<div class="line"><a id="l00096" name="l00096"></a><span class="lineno">   96</span><span class="keywordtype">   REAL</span>, <span class="keywordtype">DIMENSION( ims:ime, kms:kme, jms:jme )</span>::   V</div>
<div class="line"><a id="l00097" name="l00097"></a><span class="lineno">   97</span><span class="keywordtype">   REAL</span>, <span class="keywordtype">DIMENSION( ims:ime , jms:jme )</span>        ::   GLW</div>
<div class="line"><a id="l00098" name="l00098"></a><span class="lineno">   98</span><span class="keywordtype">   REAL</span>, <span class="keywordtype">DIMENSION( ims:ime , jms:jme )</span>        ::   swdown</div>
<div class="line"><a id="l00099" name="l00099"></a><span class="lineno">   99</span><span class="keywordtype">   REAL</span>, <span class="keywordtype">DIMENSION( ims:ime, jms:jme )</span>         ::   UST</div>
<div class="line"><a id="l00100" name="l00100"></a><span class="lineno">  100</span>   <span class="keywordtype">INTEGER</span>, <span class="keywordtype">DIMENSION( ims:ime , jms:jme )</span>, <span class="keywordtype">INTENT(IN )</span>::   UTYPE_URB2D</div>
<div class="line"><a id="l00101" name="l00101"></a><span class="lineno">  101</span><span class="keywordtype">   REAL</span>, <span class="keywordtype">DIMENSION( ims:ime , jms:jme )</span>, <span class="keywordtype">INTENT(IN )</span>::   FRC_URB2D</div>
<div class="line"><a id="l00102" name="l00102"></a><span class="lineno">  102</span><span class="keywordtype">   REAL</span>, <span class="keywordtype">INTENT(IN  )</span>   ::                                   GMT </div>
<div class="line"><a id="l00103" name="l00103"></a><span class="lineno">  103</span>   <span class="keywordtype">INTEGER</span>, <span class="keywordtype">INTENT(IN  )</span> ::                               JULDAY</div>
<div class="line"><a id="l00104" name="l00104"></a><span class="lineno">  104</span><span class="keywordtype">   REAL</span>, <span class="keywordtype">DIMENSION( ims:ime, jms:jme )</span>,                           &amp;</div>
<div class="line"><a id="l00105" name="l00105"></a><span class="lineno">  105</span>         <span class="keywordtype">INTENT(IN   )</span>  ::                           XLAT, XLONG</div>
<div class="line"><a id="l00106" name="l00106"></a><span class="lineno">  106</span><span class="keywordtype">   REAL</span>, <span class="keywordtype">INTENT(IN)</span> :: DECLIN_URB</div>
<div class="line"><a id="l00107" name="l00107"></a><span class="lineno">  107</span><span class="keywordtype">   REAL</span>, <span class="keywordtype">DIMENSION( ims:ime, jms:jme )</span>, <span class="keywordtype">INTENT(IN)</span> :: COSZ_URB2D</div>
<div class="line"><a id="l00108" name="l00108"></a><span class="lineno">  108</span><span class="keywordtype">   REAL</span>, <span class="keywordtype">DIMENSION( ims:ime, jms:jme )</span>, <span class="keywordtype">INTENT(IN)</span> :: OMG_URB2D</div>
<div class="line"><a id="l00109" name="l00109"></a><span class="lineno">  109</span>   <span class="keywordtype">INTEGER</span>, <span class="keywordtype">INTENT(IN  )</span> :: num_urban_layers</div>
<div class="line"><a id="l00110" name="l00110"></a><span class="lineno">  110</span>   <span class="keywordtype">INTEGER</span>, <span class="keywordtype">INTENT(IN  )</span> :: num_urban_hi</div>
<div class="line"><a id="l00111" name="l00111"></a><span class="lineno">  111</span><span class="keywordtype">   REAL</span>, <span class="keywordtype">DIMENSION( ims:ime, 1:num_urban_layers, jms:jme )</span>, <span class="keywordtype">INTENT(INOUT)</span> :: trb_urb4d</div>
<div class="line"><a id="l00112" name="l00112"></a><span class="lineno">  112</span><span class="keywordtype">   REAL</span>, <span class="keywordtype">DIMENSION( ims:ime, 1:num_urban_layers, jms:jme )</span>, <span class="keywordtype">INTENT(INOUT)</span> :: tw1_urb4d</div>
<div class="line"><a id="l00113" name="l00113"></a><span class="lineno">  113</span><span class="keywordtype">   REAL</span>, <span class="keywordtype">DIMENSION( ims:ime, 1:num_urban_layers, jms:jme )</span>, <span class="keywordtype">INTENT(INOUT)</span> :: tw2_urb4d</div>
<div class="line"><a id="l00114" name="l00114"></a><span class="lineno">  114</span><span class="keywordtype">   REAL</span>, <span class="keywordtype">DIMENSION( ims:ime, 1:num_urban_layers, jms:jme )</span>, <span class="keywordtype">INTENT(INOUT)</span> :: tgb_urb4d</div>
<div class="line"><a id="l00115" name="l00115"></a><span class="lineno">  115</span><span class="keywordtype">   REAL</span>, <span class="keywordtype">DIMENSION( ims:ime, 1:num_urban_layers, jms:jme )</span>, <span class="keywordtype">INTENT(INOUT)</span> :: sfw1_urb3d</div>
<div class="line"><a id="l00116" name="l00116"></a><span class="lineno">  116</span><span class="keywordtype">   REAL</span>, <span class="keywordtype">DIMENSION( ims:ime, 1:num_urban_layers, jms:jme )</span>, <span class="keywordtype">INTENT(INOUT)</span> :: sfw2_urb3d</div>
<div class="line"><a id="l00117" name="l00117"></a><span class="lineno">  117</span><span class="keywordtype">   REAL</span>, <span class="keywordtype">DIMENSION( ims:ime, 1:num_urban_layers, jms:jme )</span>, <span class="keywordtype">INTENT(INOUT)</span> :: sfr_urb3d</div>
<div class="line"><a id="l00118" name="l00118"></a><span class="lineno">  118</span><span class="keywordtype">   REAL</span>, <span class="keywordtype">DIMENSION( ims:ime, 1:num_urban_layers, jms:jme )</span>, <span class="keywordtype">INTENT(INOUT)</span> :: sfg_urb3d</div>
<div class="line"><a id="l00119" name="l00119"></a><span class="lineno">  119</span><span class="keywordtype">   REAL</span>, <span class="keywordtype">DIMENSION( ims:ime, 1:num_urban_hi, jms:jme )</span>, <span class="keywordtype">INTENT(IN)</span> :: hi_urb2d</div>
<div class="line"><a id="l00120" name="l00120"></a><span class="lineno">  120</span><span class="keywordtype">   REAL</span>, <span class="keywordtype">DIMENSION( ims:ime,jms:jme)</span>, <span class="keywordtype">INTENT(IN)</span> :: lp_urb2d</div>
<div class="line"><a id="l00121" name="l00121"></a><span class="lineno">  121</span><span class="keywordtype">   REAL</span>, <span class="keywordtype">DIMENSION( ims:ime,jms:jme)</span>, <span class="keywordtype">INTENT(IN)</span> :: lb_urb2d</div>
<div class="line"><a id="l00122" name="l00122"></a><span class="lineno">  122</span><span class="keywordtype">   REAL</span>, <span class="keywordtype">DIMENSION( ims:ime,jms:jme)</span>, <span class="keywordtype">INTENT(IN)</span> :: hgt_urb2d</div>
<div class="line"><a id="l00123" name="l00123"></a><span class="lineno">  123</span> </div>
<div class="line"><a id="l00124" name="l00124"></a><span class="lineno">  124</span><span class="comment">!      integer nx,ny,nz              ! Number of points in the mesocsale grid</span></div>
<div class="line"><a id="l00125" name="l00125"></a><span class="lineno">  125</span><span class="keywordtype">      real</span> z(ims:ime,kms:kme,jms:jme)            <span class="comment">! Vertical coordinates</span></div>
<div class="line"><a id="l00126" name="l00126"></a><span class="lineno">  126</span><span class="keywordtype">      REAL</span>, <span class="keywordtype">INTENT(IN )</span>::   DT      <span class="comment">! Time step</span></div>
<div class="line"><a id="l00127" name="l00127"></a><span class="lineno">  127</span><span class="comment">!      real zr(ims:ime,jms:jme)                ! Solar zenith angle</span></div>
<div class="line"><a id="l00128" name="l00128"></a><span class="lineno">  128</span><span class="comment">!      real deltar(ims:ime,jms:jme)            ! Declination of the sun</span></div>
<div class="line"><a id="l00129" name="l00129"></a><span class="lineno">  129</span><span class="comment">!      real ah(ims:ime,jms:jme)                ! Hour angle</span></div>
<div class="line"><a id="l00130" name="l00130"></a><span class="lineno">  130</span><span class="comment">!      real rs(ims:ime,jms:jme)                ! Solar radiation</span></div>
<div class="line"><a id="l00131" name="l00131"></a><span class="lineno">  131</span><span class="comment">!------------------------------------------------------------------------</span></div>
<div class="line"><a id="l00132" name="l00132"></a><span class="lineno">  132</span><span class="comment">!     Output</span></div>
<div class="line"><a id="l00133" name="l00133"></a><span class="lineno">  133</span><span class="comment">!------------------------------------------------------------------------ </span></div>
<div class="line"><a id="l00134" name="l00134"></a><span class="lineno">  134</span><span class="comment">!      real tsk(ims:ime,jms:jme)           ! Average of surface temperatures (roads and roofs)</span></div>
<div class="line"><a id="l00135" name="l00135"></a><span class="lineno">  135</span><span class="comment">!</span></div>
<div class="line"><a id="l00136" name="l00136"></a><span class="lineno">  136</span><span class="comment">!    Implicit and explicit components of the source and sink terms at each levels,</span></div>
<div class="line"><a id="l00137" name="l00137"></a><span class="lineno">  137</span><span class="comment">!     the fluxes can be computed as follow: FX = A*X + B   example: t_fluxes = a_t * pt + b_t</span></div>
<div class="line"><a id="l00138" name="l00138"></a><span class="lineno">  138</span><span class="keywordtype">      real</span> a_u(ims:ime,kms:kme,jms:jme)         <span class="comment">! Implicit component for the momemtum in X-direction (center)</span></div>
<div class="line"><a id="l00139" name="l00139"></a><span class="lineno">  139</span><span class="keywordtype">      real</span> a_v(ims:ime,kms:kme,jms:jme)         <span class="comment">! Implicit component for the momemtum in Y-direction (center)</span></div>
<div class="line"><a id="l00140" name="l00140"></a><span class="lineno">  140</span><span class="keywordtype">      real</span> a_t(ims:ime,kms:kme,jms:jme)         <span class="comment">! Implicit component for the temperature</span></div>
<div class="line"><a id="l00141" name="l00141"></a><span class="lineno">  141</span><span class="keywordtype">      real</span> a_e(ims:ime,kms:kme,jms:jme)         <span class="comment">! Implicit component for the TKE</span></div>
<div class="line"><a id="l00142" name="l00142"></a><span class="lineno">  142</span><span class="keywordtype">      real</span> b_u(ims:ime,kms:kme,jms:jme)         <span class="comment">! Explicit component for the momemtum in X-direction (center)</span></div>
<div class="line"><a id="l00143" name="l00143"></a><span class="lineno">  143</span><span class="keywordtype">      real</span> b_v(ims:ime,kms:kme,jms:jme)         <span class="comment">! Explicit component for the momemtum in Y-direction (center)</span></div>
<div class="line"><a id="l00144" name="l00144"></a><span class="lineno">  144</span><span class="keywordtype">      real</span> b_t(ims:ime,kms:kme,jms:jme)         <span class="comment">! Explicit component for the temperature</span></div>
<div class="line"><a id="l00145" name="l00145"></a><span class="lineno">  145</span><span class="keywordtype">      real</span> b_e(ims:ime,kms:kme,jms:jme)         <span class="comment">! Explicit component for the TKE</span></div>
<div class="line"><a id="l00146" name="l00146"></a><span class="lineno">  146</span><span class="keywordtype">      real</span> b_q(ims:ime,kms:kme,jms:jme)         <span class="comment">! Explicit component for the humidity</span></div>
<div class="line"><a id="l00147" name="l00147"></a><span class="lineno">  147</span><span class="keywordtype">      real</span> dlg(ims:ime,kms:kme,jms:jme)         <span class="comment">! Height above ground (L_ground in formula (24) of the BLM paper). </span></div>
<div class="line"><a id="l00148" name="l00148"></a><span class="lineno">  148</span><span class="keywordtype">      real</span> dl_u(ims:ime,kms:kme,jms:jme)        <span class="comment">! Length scale (lb in formula (22) ofthe BLM paper).</span></div>
<div class="line"><a id="l00149" name="l00149"></a><span class="lineno">  149</span><span class="comment">! urban surface and volumes        </span></div>
<div class="line"><a id="l00150" name="l00150"></a><span class="lineno">  150</span><span class="keywordtype">      real</span> sf(ims:ime,kms:kme,jms:jme)           <span class="comment">! surface of the urban grid cells</span></div>
<div class="line"><a id="l00151" name="l00151"></a><span class="lineno">  151</span><span class="keywordtype">      real</span> vl(ims:ime,kms:kme,jms:jme)             <span class="comment">! volume of the urban grid cells</span></div>
<div class="line"><a id="l00152" name="l00152"></a><span class="lineno">  152</span><span class="comment">! urban fluxes</span></div>
<div class="line"><a id="l00153" name="l00153"></a><span class="lineno">  153</span><span class="keywordtype">      real</span> rl_up(its:ite,jts:jte) <span class="comment">! upward long wave radiation</span></div>
<div class="line"><a id="l00154" name="l00154"></a><span class="lineno">  154</span><span class="keywordtype">      real</span> rs_abs(its:ite,jts:jte) <span class="comment">! absorbed short wave radiation</span></div>
<div class="line"><a id="l00155" name="l00155"></a><span class="lineno">  155</span><span class="keywordtype">      real</span> emiss(its:ite,jts:jte)  <span class="comment">! emissivity averaged for urban surfaces</span></div>
<div class="line"><a id="l00156" name="l00156"></a><span class="lineno">  156</span><span class="keywordtype">      real</span> grdflx_urb(its:ite,jts:jte)  <span class="comment">! ground heat flux for urban areas</span></div>
<div class="line"><a id="l00157" name="l00157"></a><span class="lineno">  157</span><span class="comment">!------------------------------------------------------------------------</span></div>
<div class="line"><a id="l00158" name="l00158"></a><span class="lineno">  158</span><span class="comment">!     Local</span></div>
<div class="line"><a id="l00159" name="l00159"></a><span class="lineno">  159</span><span class="comment">!------------------------------------------------------------------------</span></div>
<div class="line"><a id="l00160" name="l00160"></a><span class="lineno">  160</span><span class="comment">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></div>
<div class="line"><a id="l00161" name="l00161"></a><span class="lineno">  161</span> </div>
<div class="line"><a id="l00162" name="l00162"></a><span class="lineno">  162</span><span class="keywordtype">      real</span> hi_urb(its:ite,1:nz_um,jts:jte)    <span class="comment">! Height histograms of buildings</span></div>
<div class="line"><a id="l00163" name="l00163"></a><span class="lineno">  163</span><span class="keywordtype">      real</span> hi_urb1D(nz_um)                    <span class="comment">! Height histograms of buildings</span></div>
<div class="line"><a id="l00164" name="l00164"></a><span class="lineno">  164</span><span class="keywordtype">      real</span> hb_u(nz_um)                        <span class="comment">! Bulding&#39;s heights</span></div>
<div class="line"><a id="l00165" name="l00165"></a><span class="lineno">  165</span><span class="keywordtype">      real</span> ss_urb(nz_um)  <span class="comment">! Probability that a building has an height equal to z</span></div>
<div class="line"><a id="l00166" name="l00166"></a><span class="lineno">  166</span><span class="keywordtype">      real</span> pb_urb(nz_um)  <span class="comment">! Probability that a building has an height greater or equal to z</span></div>
<div class="line"><a id="l00167" name="l00167"></a><span class="lineno">  167</span>      <span class="keywordtype">integer</span> nz_urb(nurbm)                   <span class="comment">! Number of layer in the urban grid</span></div>
<div class="line"><a id="l00168" name="l00168"></a><span class="lineno">  168</span>      <span class="keywordtype">integer</span> nzurban(nurbm)                  </div>
<div class="line"><a id="l00169" name="l00169"></a><span class="lineno">  169</span> </div>
<div class="line"><a id="l00170" name="l00170"></a><span class="lineno">  170</span><span class="comment">!    Building parameters      </span></div>
<div class="line"><a id="l00171" name="l00171"></a><span class="lineno">  171</span><span class="keywordtype">      real</span> alag_u(nurbm)                      <span class="comment">! Ground thermal diffusivity [m^2 s^-1]</span></div>
<div class="line"><a id="l00172" name="l00172"></a><span class="lineno">  172</span><span class="keywordtype">      real</span> alaw_u(nurbm)                      <span class="comment">! Wall thermal diffusivity [m^2 s^-1]</span></div>
<div class="line"><a id="l00173" name="l00173"></a><span class="lineno">  173</span><span class="keywordtype">      real</span> alar_u(nurbm)                      <span class="comment">! Roof thermal diffusivity [m^2 s^-1]</span></div>
<div class="line"><a id="l00174" name="l00174"></a><span class="lineno">  174</span><span class="keywordtype">      real</span> csg_u(nurbm)                       <span class="comment">! Specific heat of the ground material [J m^3 K^-1]</span></div>
<div class="line"><a id="l00175" name="l00175"></a><span class="lineno">  175</span><span class="keywordtype">      real</span> csw_u(nurbm)                       <span class="comment">! Specific heat of the wall material [J m^3 K^-1]</span></div>
<div class="line"><a id="l00176" name="l00176"></a><span class="lineno">  176</span><span class="keywordtype">      real</span> csr_u(nurbm)                       <span class="comment">! Specific heat of the roof material [J m^3 K^-1]</span></div>
<div class="line"><a id="l00177" name="l00177"></a><span class="lineno">  177</span><span class="keywordtype">      real</span> twini_u(nurbm)                     <span class="comment">! Initial temperature inside the building&#39;s wall [K]</span></div>
<div class="line"><a id="l00178" name="l00178"></a><span class="lineno">  178</span><span class="keywordtype">      real</span> trini_u(nurbm)                     <span class="comment">! Initial temperature inside the building&#39;s roof [K]</span></div>
<div class="line"><a id="l00179" name="l00179"></a><span class="lineno">  179</span><span class="keywordtype">      real</span> tgini_u(nurbm)                     <span class="comment">! Initial road temperature</span></div>
<div class="line"><a id="l00180" name="l00180"></a><span class="lineno">  180</span><span class="comment">!</span></div>
<div class="line"><a id="l00181" name="l00181"></a><span class="lineno">  181</span><span class="comment">!   Building materials</span></div>
<div class="line"><a id="l00182" name="l00182"></a><span class="lineno">  182</span><span class="comment">!</span></div>
<div class="line"><a id="l00183" name="l00183"></a><span class="lineno">  183</span><span class="keywordtype">      real</span> csg(ng_u)                          <span class="comment">! Specific heat of the ground material [J m^3 K^-1]</span></div>
<div class="line"><a id="l00184" name="l00184"></a><span class="lineno">  184</span><span class="keywordtype">      real</span> csr(nwr_u)                         <span class="comment">! Specific heat of the roof material [J m^3 K^-1]</span></div>
<div class="line"><a id="l00185" name="l00185"></a><span class="lineno">  185</span><span class="keywordtype">      real</span> csw(nwr_u)                         <span class="comment">! Specific heat of the wall material [J m^3 K^-1]</span></div>
<div class="line"><a id="l00186" name="l00186"></a><span class="lineno">  186</span><span class="keywordtype">      real</span> alag(ng_u)                         <span class="comment">! Ground thermal diffusivity [m^2 s^-1]</span></div>
<div class="line"><a id="l00187" name="l00187"></a><span class="lineno">  187</span><span class="keywordtype">      real</span> alaw(nwr_u)                        <span class="comment">! Wall thermal diffusivity [m^2 s^-1]</span></div>
<div class="line"><a id="l00188" name="l00188"></a><span class="lineno">  188</span><span class="keywordtype">      real</span> alar(nwr_u)                        <span class="comment">! Roof thermal diffusivity [m^2 s^-1]</span></div>
<div class="line"><a id="l00189" name="l00189"></a><span class="lineno">  189</span><span class="comment">!</span></div>
<div class="line"><a id="l00190" name="l00190"></a><span class="lineno">  190</span><span class="comment">! for twini_u, and trini_u the initial value at the deepest level is kept constant during the simulation</span></div>
<div class="line"><a id="l00191" name="l00191"></a><span class="lineno">  191</span><span class="comment">!</span></div>
<div class="line"><a id="l00192" name="l00192"></a><span class="lineno">  192</span><span class="comment">!    Radiation parameters</span></div>
<div class="line"><a id="l00193" name="l00193"></a><span class="lineno">  193</span><span class="keywordtype">      real</span> albg_u(nurbm)                      <span class="comment">! Albedo of the ground</span></div>
<div class="line"><a id="l00194" name="l00194"></a><span class="lineno">  194</span><span class="keywordtype">      real</span> albw_u(nurbm)                      <span class="comment">! Albedo of the wall</span></div>
<div class="line"><a id="l00195" name="l00195"></a><span class="lineno">  195</span><span class="keywordtype">      real</span> albr_u(nurbm)                      <span class="comment">! Albedo of the roof</span></div>
<div class="line"><a id="l00196" name="l00196"></a><span class="lineno">  196</span><span class="keywordtype">      real</span> emg_u(nurbm)                       <span class="comment">! Emissivity of ground</span></div>
<div class="line"><a id="l00197" name="l00197"></a><span class="lineno">  197</span><span class="keywordtype">      real</span> emw_u(nurbm)                       <span class="comment">! Emissivity of wall</span></div>
<div class="line"><a id="l00198" name="l00198"></a><span class="lineno">  198</span><span class="keywordtype">      real</span> emr_u(nurbm)                       <span class="comment">! Emissivity of roof</span></div>
<div class="line"><a id="l00199" name="l00199"></a><span class="lineno">  199</span> </div>
<div class="line"><a id="l00200" name="l00200"></a><span class="lineno">  200</span><span class="comment">!   fww_u,fwg_u,fgw_u,fsw_u,fsg_u are the view factors used to compute the long wave</span></div>
<div class="line"><a id="l00201" name="l00201"></a><span class="lineno">  201</span><span class="comment">!   and the short wave radation. </span></div>
<div class="line"><a id="l00202" name="l00202"></a><span class="lineno">  202</span><span class="keywordtype">      real</span> fww_u(nz_um,nz_um,ndm,nurbm)         <span class="comment">!  from wall to wall</span></div>
<div class="line"><a id="l00203" name="l00203"></a><span class="lineno">  203</span><span class="keywordtype">      real</span> fwg_u(nz_um,ndm,nurbm)               <span class="comment">!  from wall to ground</span></div>
<div class="line"><a id="l00204" name="l00204"></a><span class="lineno">  204</span><span class="keywordtype">      real</span> fgw_u(nz_um,ndm,nurbm)               <span class="comment">!  from ground to wall</span></div>
<div class="line"><a id="l00205" name="l00205"></a><span class="lineno">  205</span><span class="keywordtype">      real</span> fsw_u(nz_um,ndm,nurbm)               <span class="comment">!  from sky to wall</span></div>
<div class="line"><a id="l00206" name="l00206"></a><span class="lineno">  206</span><span class="keywordtype">      real</span> fws_u(nz_um,ndm,nurbm)               <span class="comment">!  from sky to wall</span></div>
<div class="line"><a id="l00207" name="l00207"></a><span class="lineno">  207</span><span class="keywordtype">      real</span> fsg_u(ndm,nurbm)                     <span class="comment">!  from sky to ground</span></div>
<div class="line"><a id="l00208" name="l00208"></a><span class="lineno">  208</span> </div>
<div class="line"><a id="l00209" name="l00209"></a><span class="lineno">  209</span><span class="comment">!    Roughness parameters</span></div>
<div class="line"><a id="l00210" name="l00210"></a><span class="lineno">  210</span><span class="keywordtype">      real</span> z0g_u(nurbm)         <span class="comment">! The ground&#39;s roughness length</span></div>
<div class="line"><a id="l00211" name="l00211"></a><span class="lineno">  211</span><span class="keywordtype">      real</span> z0r_u(nurbm)         <span class="comment">! The roof&#39;s roughness length</span></div>
<div class="line"><a id="l00212" name="l00212"></a><span class="lineno">  212</span> </div>
<div class="line"><a id="l00213" name="l00213"></a><span class="lineno">  213</span><span class="comment">!    Roughness parameters</span></div>
<div class="line"><a id="l00214" name="l00214"></a><span class="lineno">  214</span><span class="keywordtype">      real</span> z0(ndm,nz_um)           <span class="comment">! Roughness lengths &quot;profiles&quot;</span></div>
<div class="line"><a id="l00215" name="l00215"></a><span class="lineno">  215</span> </div>
<div class="line"><a id="l00216" name="l00216"></a><span class="lineno">  216</span><span class="comment">!    Street parameters</span></div>
<div class="line"><a id="l00217" name="l00217"></a><span class="lineno">  217</span>      <span class="keywordtype">integer</span> nd_u(nurbm)       <span class="comment">! Number of street direction for each urban class </span></div>
<div class="line"><a id="l00218" name="l00218"></a><span class="lineno">  218</span><span class="keywordtype">      real</span> strd_u(ndm,nurbm)    <span class="comment">! Street length (fix to greater value to the horizontal length of the cells)</span></div>
<div class="line"><a id="l00219" name="l00219"></a><span class="lineno">  219</span><span class="keywordtype">      real</span> drst_u(ndm,nurbm)    <span class="comment">! Street direction</span></div>
<div class="line"><a id="l00220" name="l00220"></a><span class="lineno">  220</span><span class="keywordtype">      real</span> ws_u(ndm,nurbm)      <span class="comment">! Street width</span></div>
<div class="line"><a id="l00221" name="l00221"></a><span class="lineno">  221</span><span class="keywordtype">      real</span> bs_u(ndm,nurbm)      <span class="comment">! Building width</span></div>
<div class="line"><a id="l00222" name="l00222"></a><span class="lineno">  222</span><span class="keywordtype">      real</span> h_b(nz_um,nurbm)     <span class="comment">! Bulding&#39;s heights</span></div>
<div class="line"><a id="l00223" name="l00223"></a><span class="lineno">  223</span><span class="keywordtype">      real</span> d_b(nz_um,nurbm)     <span class="comment">! Probability that a building has an height h_b</span></div>
<div class="line"><a id="l00224" name="l00224"></a><span class="lineno">  224</span><span class="keywordtype">      real</span> ss_u(nz_um,nurbm)  <span class="comment">! Probability that a building has an height equal to z</span></div>
<div class="line"><a id="l00225" name="l00225"></a><span class="lineno">  225</span><span class="keywordtype">      real</span> pb_u(nz_um,nurbm)  <span class="comment">! Probability that a building has an height greater or equal to z</span></div>
<div class="line"><a id="l00226" name="l00226"></a><span class="lineno">  226</span><span class="comment">!</span></div>
<div class="line"><a id="l00227" name="l00227"></a><span class="lineno">  227</span><span class="comment">!    Street parameters</span></div>
<div class="line"><a id="l00228" name="l00228"></a><span class="lineno">  228</span><span class="comment">!</span></div>
<div class="line"><a id="l00229" name="l00229"></a><span class="lineno">  229</span><span class="keywordtype">      real</span> bs(ndm)                 <span class="comment">! Building width </span></div>
<div class="line"><a id="l00230" name="l00230"></a><span class="lineno">  230</span><span class="keywordtype">      real</span> ws(ndm)                 <span class="comment">! Street width</span></div>
<div class="line"><a id="l00231" name="l00231"></a><span class="lineno">  231</span><span class="keywordtype">      real</span> drst(ndm)               <span class="comment">! street directions </span></div>
<div class="line"><a id="l00232" name="l00232"></a><span class="lineno">  232</span><span class="keywordtype">      real</span> strd(ndm)               <span class="comment">! Street lengths </span></div>
<div class="line"><a id="l00233" name="l00233"></a><span class="lineno">  233</span><span class="keywordtype">      real</span> ss(nz_um)               <span class="comment">! Probability to have a building with height h</span></div>
<div class="line"><a id="l00234" name="l00234"></a><span class="lineno">  234</span><span class="keywordtype">      real</span> pb(nz_um)               <span class="comment">! Probability to have a building with an height equal</span></div>
<div class="line"><a id="l00235" name="l00235"></a><span class="lineno">  235</span> </div>
<div class="line"><a id="l00236" name="l00236"></a><span class="lineno">  236</span><span class="comment">!    Grid parameters</span></div>
<div class="line"><a id="l00237" name="l00237"></a><span class="lineno">  237</span> </div>
<div class="line"><a id="l00238" name="l00238"></a><span class="lineno">  238</span>      <span class="keywordtype">integer</span> nz_u(nurbm)       <span class="comment">! Number of layer in the urban grid</span></div>
<div class="line"><a id="l00239" name="l00239"></a><span class="lineno">  239</span>      </div>
<div class="line"><a id="l00240" name="l00240"></a><span class="lineno">  240</span><span class="keywordtype">      real</span> z_u(nz_um)         <span class="comment">! Height of the urban grid levels</span></div>
<div class="line"><a id="l00241" name="l00241"></a><span class="lineno">  241</span> </div>
<div class="line"><a id="l00242" name="l00242"></a><span class="lineno">  242</span><span class="comment">! 1D array used for the input and output of the routine &quot;urban&quot;</span></div>
<div class="line"><a id="l00243" name="l00243"></a><span class="lineno">  243</span> </div>
<div class="line"><a id="l00244" name="l00244"></a><span class="lineno">  244</span><span class="keywordtype">      real</span> z1D(kms:kme)               <span class="comment">! vertical coordinates</span></div>
<div class="line"><a id="l00245" name="l00245"></a><span class="lineno">  245</span><span class="keywordtype">      real</span> ua1D(kms:kme)                <span class="comment">! wind speed in the x directions</span></div>
<div class="line"><a id="l00246" name="l00246"></a><span class="lineno">  246</span><span class="keywordtype">      real</span> va1D(kms:kme)                <span class="comment">! wind speed in the y directions</span></div>
<div class="line"><a id="l00247" name="l00247"></a><span class="lineno">  247</span><span class="keywordtype">      real</span> pt1D(kms:kme)                <span class="comment">! potential temperature</span></div>
<div class="line"><a id="l00248" name="l00248"></a><span class="lineno">  248</span><span class="keywordtype">      real</span> da1D(kms:kme)                <span class="comment">! air density</span></div>
<div class="line"><a id="l00249" name="l00249"></a><span class="lineno">  249</span><span class="keywordtype">      real</span> pr1D(kms:kme)                <span class="comment">! air pressure</span></div>
<div class="line"><a id="l00250" name="l00250"></a><span class="lineno">  250</span><span class="keywordtype">      real</span> pt01D(kms:kme)               <span class="comment">! reference potential temperature</span></div>
<div class="line"><a id="l00251" name="l00251"></a><span class="lineno">  251</span><span class="keywordtype">      real</span> zr1D                    <span class="comment">! zenith angle</span></div>
<div class="line"><a id="l00252" name="l00252"></a><span class="lineno">  252</span><span class="keywordtype">      real</span> deltar1D                <span class="comment">! declination of the sun</span></div>
<div class="line"><a id="l00253" name="l00253"></a><span class="lineno">  253</span><span class="keywordtype">      real</span> ah1D                    <span class="comment">! hour angle (it should come from the radiation routine)</span></div>
<div class="line"><a id="l00254" name="l00254"></a><span class="lineno">  254</span><span class="keywordtype">      real</span> rs1D                    <span class="comment">! solar radiation</span></div>
<div class="line"><a id="l00255" name="l00255"></a><span class="lineno">  255</span><span class="keywordtype">      real</span> rld1D                   <span class="comment">! downward flux of the longwave radiation</span></div>
<div class="line"><a id="l00256" name="l00256"></a><span class="lineno">  256</span> </div>
<div class="line"><a id="l00257" name="l00257"></a><span class="lineno">  257</span> </div>
<div class="line"><a id="l00258" name="l00258"></a><span class="lineno">  258</span><span class="keywordtype">      real</span> tw1D(2*ndm,nz_um,nwr_u)  <span class="comment">! temperature in each layer of the wall</span></div>
<div class="line"><a id="l00259" name="l00259"></a><span class="lineno">  259</span><span class="keywordtype">      real</span> tg1D(ndm,ng_u)          <span class="comment">! temperature in each layer of the ground</span></div>
<div class="line"><a id="l00260" name="l00260"></a><span class="lineno">  260</span><span class="keywordtype">      real</span> tr1D(ndm,nz_um,nwr_u)  <span class="comment">! temperature in each layer of the roof</span></div>
<div class="line"><a id="l00261" name="l00261"></a><span class="lineno">  261</span><span class="keywordtype">      real</span> sfw1D(2*ndm,nz_um)      <span class="comment">! sensible heat flux from walls</span></div>
<div class="line"><a id="l00262" name="l00262"></a><span class="lineno">  262</span><span class="keywordtype">      real</span> sfg1D(ndm)              <span class="comment">! sensible heat flux from ground (road)</span></div>
<div class="line"><a id="l00263" name="l00263"></a><span class="lineno">  263</span><span class="keywordtype">      real</span> sfr1D(ndm,nz_um)      <span class="comment">! sensible heat flux from roofs</span></div>
<div class="line"><a id="l00264" name="l00264"></a><span class="lineno">  264</span><span class="keywordtype">      real</span> sf1D(kms:kme)              <span class="comment">! surface of the urban grid cells</span></div>
<div class="line"><a id="l00265" name="l00265"></a><span class="lineno">  265</span><span class="keywordtype">      real</span> vl1D(kms:kme)                <span class="comment">! volume of the urban grid cells</span></div>
<div class="line"><a id="l00266" name="l00266"></a><span class="lineno">  266</span><span class="keywordtype">      real</span> a_u1D(kms:kme)               <span class="comment">! Implicit component of the momentum sources or sinks in the X-direction</span></div>
<div class="line"><a id="l00267" name="l00267"></a><span class="lineno">  267</span><span class="keywordtype">      real</span> a_v1D(kms:kme)               <span class="comment">! Implicit component of the momentum sources or sinks in the Y-direction</span></div>
<div class="line"><a id="l00268" name="l00268"></a><span class="lineno">  268</span><span class="keywordtype">      real</span> a_t1D(kms:kme)               <span class="comment">! Implicit component of the heat sources or sinks</span></div>
<div class="line"><a id="l00269" name="l00269"></a><span class="lineno">  269</span><span class="keywordtype">      real</span> a_e1D(kms:kme)               <span class="comment">! Implicit component of the TKE sources or sinks</span></div>
<div class="line"><a id="l00270" name="l00270"></a><span class="lineno">  270</span><span class="keywordtype">      real</span> b_u1D(kms:kme)               <span class="comment">! Explicit component of the momentum sources or sinks in the X-direction</span></div>
<div class="line"><a id="l00271" name="l00271"></a><span class="lineno">  271</span><span class="keywordtype">      real</span> b_v1D(kms:kme)               <span class="comment">! Explicit component of the momentum sources or sinks in the Y-direction</span></div>
<div class="line"><a id="l00272" name="l00272"></a><span class="lineno">  272</span><span class="keywordtype">      real</span> b_t1D(kms:kme)               <span class="comment">! Explicit component of the heat sources or sinks</span></div>
<div class="line"><a id="l00273" name="l00273"></a><span class="lineno">  273</span><span class="keywordtype">      real</span> b_e1D(kms:kme)               <span class="comment">! Explicit component of the TKE sources or sinks</span></div>
<div class="line"><a id="l00274" name="l00274"></a><span class="lineno">  274</span><span class="keywordtype">      real</span> dlg1D(kms:kme)               <span class="comment">! Height above ground (L_ground in formula (24) of the BLM paper). </span></div>
<div class="line"><a id="l00275" name="l00275"></a><span class="lineno">  275</span><span class="keywordtype">      real</span> dl_u1D(kms:kme)              <span class="comment">! Length scale (lb in formula (22) ofthe BLM paper)</span></div>
<div class="line"><a id="l00276" name="l00276"></a><span class="lineno">  276</span><span class="keywordtype">      real</span> time_bep</div>
<div class="line"><a id="l00277" name="l00277"></a><span class="lineno">  277</span><span class="comment">! arrays used to collapse indexes</span></div>
<div class="line"><a id="l00278" name="l00278"></a><span class="lineno">  278</span>      <span class="keywordtype">integer</span> ind_zwd(nz_um,nwr_u,ndm)</div>
<div class="line"><a id="l00279" name="l00279"></a><span class="lineno">  279</span>      <span class="keywordtype">integer</span> ind_gd(ng_u,ndm)</div>
<div class="line"><a id="l00280" name="l00280"></a><span class="lineno">  280</span>      <span class="keywordtype">integer</span> ind_zd(nz_um,ndm)</div>
<div class="line"><a id="l00281" name="l00281"></a><span class="lineno">  281</span><span class="comment">!</span></div>
<div class="line"><a id="l00282" name="l00282"></a><span class="lineno">  282</span>      <span class="keywordtype">integer</span> ix,iy,iz,iurb,id,iz_u,iw,ig,ir,ix1,iy1,k</div>
<div class="line"><a id="l00283" name="l00283"></a><span class="lineno">  283</span>      <span class="keywordtype">integer</span> it, nint</div>
<div class="line"><a id="l00284" name="l00284"></a><span class="lineno">  284</span>      <span class="keywordtype">integer</span> iii</div>
<div class="line"><a id="l00285" name="l00285"></a><span class="lineno">  285</span><span class="keywordtype">      real</span> time_h,tempo</div>
<div class="line"><a id="l00286" name="l00286"></a><span class="lineno">  286</span>      <span class="keywordtype">logical</span> first</div>
<div class="line"><a id="l00287" name="l00287"></a><span class="lineno">  287</span>      <span class="keywordtype">character(len=80)</span> :: text</div>
<div class="line"><a id="l00288" name="l00288"></a><span class="lineno">  288</span>      <span class="keyword">data</span> first/.true./</div>
<div class="line"><a id="l00289" name="l00289"></a><span class="lineno">  289</span>      <span class="keywordtype">save</span> first,time_bep </div>
<div class="line"><a id="l00290" name="l00290"></a><span class="lineno">  290</span> </div>
<div class="line"><a id="l00291" name="l00291"></a><span class="lineno">  291</span>      <span class="keywordtype">save</span> alag_u,alaw_u,alar_u,csg_u,csw_u,csr_u,                      &amp;</div>
<div class="line"><a id="l00292" name="l00292"></a><span class="lineno">  292</span>           albg_u,albw_u,albr_u,emg_u,emw_u,emr_u,                      &amp;</div>
<div class="line"><a id="l00293" name="l00293"></a><span class="lineno">  293</span>           z0g_u,z0r_u, nd_u,strd_u,drst_u,ws_u,bs_u,h_b,d_b,ss_u,pb_u, &amp;</div>
<div class="line"><a id="l00294" name="l00294"></a><span class="lineno">  294</span>           nz_u,z_u </div>
<div class="line"><a id="l00295" name="l00295"></a><span class="lineno">  295</span> </div>
<div class="line"><a id="l00296" name="l00296"></a><span class="lineno">  296</span><span class="comment">!------------------------------------------------------------------------</span></div>
<div class="line"><a id="l00297" name="l00297"></a><span class="lineno">  297</span><span class="comment">!    Calculation of the momentum, heat and turbulent kinetic fluxes</span></div>
<div class="line"><a id="l00298" name="l00298"></a><span class="lineno">  298</span><span class="comment">!     produced by builgings</span></div>
<div class="line"><a id="l00299" name="l00299"></a><span class="lineno">  299</span><span class="comment">!</span></div>
<div class="line"><a id="l00300" name="l00300"></a><span class="lineno">  300</span><span class="comment">! Reference:</span></div>
<div class="line"><a id="l00301" name="l00301"></a><span class="lineno">  301</span><span class="comment">! Martilli, A., Clappier, A., Rotach, M.W.:2002, &#39;AN URBAN SURFACE EXCHANGE</span></div>
<div class="line"><a id="l00302" name="l00302"></a><span class="lineno">  302</span><span class="comment">! PARAMETERISATION FOR MESOSCALE MODELS&#39;, Boundary-Layer Meteorolgy 104:</span></div>
<div class="line"><a id="l00303" name="l00303"></a><span class="lineno">  303</span><span class="comment">! 261-304</span></div>
<div class="line"><a id="l00304" name="l00304"></a><span class="lineno">  304</span><span class="comment">!------------------------------------------------------------------------</span></div>
<div class="line"><a id="l00305" name="l00305"></a><span class="lineno">  305</span><span class="comment">!prepare the arrays to collapse indexes</span></div>
<div class="line"><a id="l00306" name="l00306"></a><span class="lineno">  306</span> </div>
<div class="line"><a id="l00307" name="l00307"></a><span class="lineno">  307</span>      <span class="keywordflow">if</span>(num_urban_layers.lt.nz_um*ndm*nwr_u)<span class="keywordflow">then</span></div>
<div class="line"><a id="l00308" name="l00308"></a><span class="lineno">  308</span>        <span class="keyword">write</span>(*,*)<span class="stringliteral">&#39;num_urban_layers too small, please increase to at least &#39;</span>, nz_um*ndm*nwr_u</div>
<div class="line"><a id="l00309" name="l00309"></a><span class="lineno">  309</span>        stop</div>
<div class="line"><a id="l00310" name="l00310"></a><span class="lineno">  310</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l00311" name="l00311"></a><span class="lineno">  311</span>      iii=0</div>
<div class="line"><a id="l00312" name="l00312"></a><span class="lineno">  312</span>      <span class="keywordflow">do</span> iz_u=1,nz_um</div>
<div class="line"><a id="l00313" name="l00313"></a><span class="lineno">  313</span>      <span class="keywordflow">do</span> iw=1,nwr_u</div>
<div class="line"><a id="l00314" name="l00314"></a><span class="lineno">  314</span>      <span class="keywordflow">do</span> id=1,ndm</div>
<div class="line"><a id="l00315" name="l00315"></a><span class="lineno">  315</span>       iii=iii+1</div>
<div class="line"><a id="l00316" name="l00316"></a><span class="lineno">  316</span>       ind_zwd(iz_u,iw,id)=iii</div>
<div class="line"><a id="l00317" name="l00317"></a><span class="lineno">  317</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l00318" name="l00318"></a><span class="lineno">  318</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l00319" name="l00319"></a><span class="lineno">  319</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l00320" name="l00320"></a><span class="lineno">  320</span> </div>
<div class="line"><a id="l00321" name="l00321"></a><span class="lineno">  321</span>      iii=0</div>
<div class="line"><a id="l00322" name="l00322"></a><span class="lineno">  322</span>      <span class="keywordflow">do</span> ig=1,ng_u</div>
<div class="line"><a id="l00323" name="l00323"></a><span class="lineno">  323</span>      <span class="keywordflow">do</span> id=1,ndm</div>
<div class="line"><a id="l00324" name="l00324"></a><span class="lineno">  324</span>       iii=iii+1</div>
<div class="line"><a id="l00325" name="l00325"></a><span class="lineno">  325</span>       ind_gd(ig,id)=iii</div>
<div class="line"><a id="l00326" name="l00326"></a><span class="lineno">  326</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l00327" name="l00327"></a><span class="lineno">  327</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l00328" name="l00328"></a><span class="lineno">  328</span> </div>
<div class="line"><a id="l00329" name="l00329"></a><span class="lineno">  329</span>      iii=0</div>
<div class="line"><a id="l00330" name="l00330"></a><span class="lineno">  330</span>      <span class="keywordflow">do</span> iz_u=1,nz_um</div>
<div class="line"><a id="l00331" name="l00331"></a><span class="lineno">  331</span>      <span class="keywordflow">do</span> id=1,ndm</div>
<div class="line"><a id="l00332" name="l00332"></a><span class="lineno">  332</span>       iii=iii+1</div>
<div class="line"><a id="l00333" name="l00333"></a><span class="lineno">  333</span>       ind_zd(iz_u,id)=iii</div>
<div class="line"><a id="l00334" name="l00334"></a><span class="lineno">  334</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l00335" name="l00335"></a><span class="lineno">  335</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l00336" name="l00336"></a><span class="lineno">  336</span> </div>
<div class="line"><a id="l00337" name="l00337"></a><span class="lineno">  337</span>      <span class="keywordflow">if</span> (num_urban_hi.ge.nz_um)<span class="keywordflow">then</span></div>
<div class="line"><a id="l00338" name="l00338"></a><span class="lineno">  338</span>          <span class="keyword">write</span>(*,*)<span class="stringliteral">&#39;nz_um too small, please increase to at least &#39;</span>, num_urban_hi+1</div>
<div class="line"><a id="l00339" name="l00339"></a><span class="lineno">  339</span>          stop         </div>
<div class="line"><a id="l00340" name="l00340"></a><span class="lineno">  340</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l00341" name="l00341"></a><span class="lineno">  341</span> </div>
<div class="line"><a id="l00342" name="l00342"></a><span class="lineno">  342</span>      <span class="keywordflow">do</span> ix=its,ite</div>
<div class="line"><a id="l00343" name="l00343"></a><span class="lineno">  343</span>          <span class="keywordflow">do</span> iy=jts,jte</div>
<div class="line"><a id="l00344" name="l00344"></a><span class="lineno">  344</span>              <span class="keywordflow">do</span> iz_u=1,nz_um</div>
<div class="line"><a id="l00345" name="l00345"></a><span class="lineno">  345</span>                  hi_urb(ix,iz_u,iy)=0.</div>
<div class="line"><a id="l00346" name="l00346"></a><span class="lineno">  346</span><span class="keywordflow">              enddo</span></div>
<div class="line"><a id="l00347" name="l00347"></a><span class="lineno">  347</span><span class="keywordflow">          enddo</span></div>
<div class="line"><a id="l00348" name="l00348"></a><span class="lineno">  348</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l00349" name="l00349"></a><span class="lineno">  349</span>      </div>
<div class="line"><a id="l00350" name="l00350"></a><span class="lineno">  350</span>      <span class="keywordflow">do</span> ix=its,ite</div>
<div class="line"><a id="l00351" name="l00351"></a><span class="lineno">  351</span>      <span class="keywordflow">do</span> iy=jts,jte</div>
<div class="line"><a id="l00352" name="l00352"></a><span class="lineno">  352</span>       z(ix,kts,iy)=0.</div>
<div class="line"><a id="l00353" name="l00353"></a><span class="lineno">  353</span>       <span class="keywordflow">do</span> iz=kts+1,kte+1</div>
<div class="line"><a id="l00354" name="l00354"></a><span class="lineno">  354</span>        z(ix,iz,iy)=z(ix,iz-1,iy)+dz8w(ix,iz-1,iy)</div>
<div class="line"><a id="l00355" name="l00355"></a><span class="lineno">  355</span><span class="keywordflow">       enddo</span> <span class="comment">!iz</span></div>
<div class="line"><a id="l00356" name="l00356"></a><span class="lineno">  356</span>       <span class="keywordflow">do</span> iz_u=1,num_urban_hi</div>
<div class="line"><a id="l00357" name="l00357"></a><span class="lineno">  357</span>          hi_urb(ix,iz_u,iy)= hi_urb2d(ix,iz_u,iy)</div>
<div class="line"><a id="l00358" name="l00358"></a><span class="lineno">  358</span><span class="keywordflow">       enddo</span> <span class="comment">!iz_u</span></div>
<div class="line"><a id="l00359" name="l00359"></a><span class="lineno">  359</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l00360" name="l00360"></a><span class="lineno">  360</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l00361" name="l00361"></a><span class="lineno">  361</span> </div>
<div class="line"><a id="l00362" name="l00362"></a><span class="lineno">  362</span> </div>
<div class="line"><a id="l00363" name="l00363"></a><span class="lineno">  363</span>      <span class="keywordflow">if</span> (first) <span class="keywordflow">then</span>                           <span class="comment">! True only on first call</span></div>
<div class="line"><a id="l00364" name="l00364"></a><span class="lineno">  364</span>         </div>
<div class="line"><a id="l00365" name="l00365"></a><span class="lineno">  365</span>         <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a567630d423883a8646b493e79e507f79">init_para</a>(alag_u,alaw_u,alar_u,csg_u,csw_u,csr_u,&amp;</div>
<div class="line"><a id="l00366" name="l00366"></a><span class="lineno">  366</span>                twini_u,trini_u,tgini_u,albg_u,albw_u,albr_u,emg_u,emw_u,&amp;</div>
<div class="line"><a id="l00367" name="l00367"></a><span class="lineno">  367</span>                emr_u,z0g_u,z0r_u,nd_u,strd_u,drst_u,ws_u,bs_u,h_b,d_b)</div>
<div class="line"><a id="l00368" name="l00368"></a><span class="lineno">  368</span> </div>
<div class="line"><a id="l00369" name="l00369"></a><span class="lineno">  369</span><span class="comment">!      Initialisation of the urban parameters and calculation of the view factors</span></div>
<div class="line"><a id="l00370" name="l00370"></a><span class="lineno">  370</span>             </div>
<div class="line"><a id="l00371" name="l00371"></a><span class="lineno">  371</span>         <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#ac457b6929ba12db21a3d49ebbacc2508">icbep</a>(nd_u,h_b,d_b,ss_u,pb_u,nz_u,z_u)                                  </div>
<div class="line"><a id="l00372" name="l00372"></a><span class="lineno">  372</span>          </div>
<div class="line"><a id="l00373" name="l00373"></a><span class="lineno">  373</span>         first=.false.</div>
<div class="line"><a id="l00374" name="l00374"></a><span class="lineno">  374</span> </div>
<div class="line"><a id="l00375" name="l00375"></a><span class="lineno">  375</span><span class="keywordflow">      endif</span> <span class="comment">! first</span></div>
<div class="line"><a id="l00376" name="l00376"></a><span class="lineno">  376</span> </div>
<div class="line"><a id="l00377" name="l00377"></a><span class="lineno">  377</span>      <span class="keywordflow">do</span> ix=its,ite</div>
<div class="line"><a id="l00378" name="l00378"></a><span class="lineno">  378</span>      <span class="keywordflow">do</span> iy=jts,jte</div>
<div class="line"><a id="l00379" name="l00379"></a><span class="lineno">  379</span>        <span class="keywordflow">if</span> (frc_urb2d(ix,iy).gt.0.) <span class="keywordflow">then</span>    <span class="comment">! Calling BEP only for existing urban classes.  </span></div>
<div class="line"><a id="l00380" name="l00380"></a><span class="lineno">  380</span>           iurb=utype_urb2d(ix,iy)</div>
<div class="line"><a id="l00381" name="l00381"></a><span class="lineno">  381</span> </div>
<div class="line"><a id="l00382" name="l00382"></a><span class="lineno">  382</span>           hi_urb1d=0.</div>
<div class="line"><a id="l00383" name="l00383"></a><span class="lineno">  383</span>           <span class="keywordflow">do</span> iz_u=1,nz_um</div>
<div class="line"><a id="l00384" name="l00384"></a><span class="lineno">  384</span>              hi_urb1d(iz_u)=hi_urb(ix,iz_u,iy)</div>
<div class="line"><a id="l00385" name="l00385"></a><span class="lineno">  385</span><span class="keywordflow">           enddo</span></div>
<div class="line"><a id="l00386" name="l00386"></a><span class="lineno">  386</span> </div>
<div class="line"><a id="l00387" name="l00387"></a><span class="lineno">  387</span>           <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a63ffc10bf9f3e98abc45ec2cea796270">icbephi_xy</a>(hb_u,hi_urb1d,ss_urb,pb_urb,    &amp;</div>
<div class="line"><a id="l00388" name="l00388"></a><span class="lineno">  388</span>                           nz_urb(iurb),z_u)</div>
<div class="line"><a id="l00389" name="l00389"></a><span class="lineno">  389</span>           </div>
<div class="line"><a id="l00390" name="l00390"></a><span class="lineno">  390</span>           <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a851f0f918177ac23c73ff631fd96683a">param</a>(iurb,nz_u(iurb),nz_urb(iurb),nzurban(iurb),    &amp;</div>
<div class="line"><a id="l00391" name="l00391"></a><span class="lineno">  391</span>                      nd_u(iurb),csg_u,csg,alag_u,alag,csr_u,csr,    &amp;</div>
<div class="line"><a id="l00392" name="l00392"></a><span class="lineno">  392</span>                      alar_u,alar,csw_u,csw,alaw_u,alaw,             &amp;</div>
<div class="line"><a id="l00393" name="l00393"></a><span class="lineno">  393</span>                      ws_u,ws,bs_u,bs,z0g_u,z0r_u,z0,                &amp;</div>
<div class="line"><a id="l00394" name="l00394"></a><span class="lineno">  394</span>                      strd_u,strd,drst_u,drst,ss_u,ss_urb,ss,pb_u,   &amp;</div>
<div class="line"><a id="l00395" name="l00395"></a><span class="lineno">  395</span>                      pb_urb,pb,lp_urb2d(ix,iy),                     &amp;</div>
<div class="line"><a id="l00396" name="l00396"></a><span class="lineno">  396</span>                      lb_urb2d(ix,iy),hgt_urb2d(ix,iy),frc_urb2d(ix,iy))  </div>
<div class="line"><a id="l00397" name="l00397"></a><span class="lineno">  397</span><span class="comment">!</span></div>
<div class="line"><a id="l00398" name="l00398"></a><span class="lineno">  398</span><span class="comment">!We compute the view factors in the icBEP_XY routine</span></div>
<div class="line"><a id="l00399" name="l00399"></a><span class="lineno">  399</span><span class="comment">!           </span></div>
<div class="line"><a id="l00400" name="l00400"></a><span class="lineno">  400</span>         </div>
<div class="line"><a id="l00401" name="l00401"></a><span class="lineno">  401</span>           <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a16b39e122a77024dc176887d083e8528">icbep_xy</a>(iurb,fww_u,fwg_u,fgw_u,fsw_u,fws_u,fsg_u,   &amp;</div>
<div class="line"><a id="l00402" name="l00402"></a><span class="lineno">  402</span>                         nd_u(iurb),strd,ws,nzurban(iurb),z_u)   </div>
<div class="line"><a id="l00403" name="l00403"></a><span class="lineno">  403</span> </div>
<div class="line"><a id="l00404" name="l00404"></a><span class="lineno">  404</span>       <span class="keywordflow">do</span> iz= kts,kte</div>
<div class="line"><a id="l00405" name="l00405"></a><span class="lineno">  405</span>          ua1d(iz)=u_phy(ix,iz,iy)</div>
<div class="line"><a id="l00406" name="l00406"></a><span class="lineno">  406</span>          va1d(iz)=v_phy(ix,iz,iy)</div>
<div class="line"><a id="l00407" name="l00407"></a><span class="lineno">  407</span>      pt1d(iz)=th_phy(ix,iz,iy)</div>
<div class="line"><a id="l00408" name="l00408"></a><span class="lineno">  408</span>      da1d(iz)=rho(ix,iz,iy)</div>
<div class="line"><a id="l00409" name="l00409"></a><span class="lineno">  409</span>      pr1d(iz)=p_phy(ix,iz,iy)</div>
<div class="line"><a id="l00410" name="l00410"></a><span class="lineno">  410</span><span class="comment">!     pt01D(iz)=th_phy(ix,iz,iy)</span></div>
<div class="line"><a id="l00411" name="l00411"></a><span class="lineno">  411</span>      pt01d(iz)=300.</div>
<div class="line"><a id="l00412" name="l00412"></a><span class="lineno">  412</span>      z1d(iz)=z(ix,iz,iy)</div>
<div class="line"><a id="l00413" name="l00413"></a><span class="lineno">  413</span>          a_u1d(iz)=0.</div>
<div class="line"><a id="l00414" name="l00414"></a><span class="lineno">  414</span>          a_v1d(iz)=0.</div>
<div class="line"><a id="l00415" name="l00415"></a><span class="lineno">  415</span>          a_t1d(iz)=0.</div>
<div class="line"><a id="l00416" name="l00416"></a><span class="lineno">  416</span>          a_e1d(iz)=0.</div>
<div class="line"><a id="l00417" name="l00417"></a><span class="lineno">  417</span>          b_u1d(iz)=0.</div>
<div class="line"><a id="l00418" name="l00418"></a><span class="lineno">  418</span>          b_v1d(iz)=0.</div>
<div class="line"><a id="l00419" name="l00419"></a><span class="lineno">  419</span>          b_t1d(iz)=0.</div>
<div class="line"><a id="l00420" name="l00420"></a><span class="lineno">  420</span>          b_e1d(iz)=0.           </div>
<div class="line"><a id="l00421" name="l00421"></a><span class="lineno">  421</span><span class="keywordflow">         enddo</span></div>
<div class="line"><a id="l00422" name="l00422"></a><span class="lineno">  422</span>     z1d(kte+1)=z(ix,kte+1,iy)</div>
<div class="line"><a id="l00423" name="l00423"></a><span class="lineno">  423</span> </div>
<div class="line"><a id="l00424" name="l00424"></a><span class="lineno">  424</span>         <span class="keywordflow">do</span> id=1,ndm</div>
<div class="line"><a id="l00425" name="l00425"></a><span class="lineno">  425</span>         <span class="keywordflow">do</span> iz_u=1,nz_um</div>
<div class="line"><a id="l00426" name="l00426"></a><span class="lineno">  426</span>         <span class="keywordflow">do</span> iw=1,nwr_u</div>
<div class="line"><a id="l00427" name="l00427"></a><span class="lineno">  427</span><span class="comment">!          tw1D(2*id-1,iz_u,iw)=tw1_u(ix,iy,ind_zwd(iz_u,iw,id))</span></div>
<div class="line"><a id="l00428" name="l00428"></a><span class="lineno">  428</span><span class="comment">!          tw1D(2*id,iz_u,iw)=tw2_u(ix,iy,ind_zwd(iz_u,iw,id))</span></div>
<div class="line"><a id="l00429" name="l00429"></a><span class="lineno">  429</span>            <span class="keywordflow">if</span>(ind_zwd(iz_u,iw,id).gt.num_urban_layers)<span class="keyword">write</span>(*,*)<span class="stringliteral">&#39;ind_zwd too big w&#39;</span>,ind_zwd(iz_u,iw,id)</div>
<div class="line"><a id="l00430" name="l00430"></a><span class="lineno">  430</span>          tw1d(2*id-1,iz_u,iw)=tw1_urb4d(ix,ind_zwd(iz_u,iw,id),iy)</div>
<div class="line"><a id="l00431" name="l00431"></a><span class="lineno">  431</span>          tw1d(2*id,iz_u,iw)=tw2_urb4d(ix,ind_zwd(iz_u,iw,id),iy)</div>
<div class="line"><a id="l00432" name="l00432"></a><span class="lineno">  432</span><span class="keywordflow">         enddo</span></div>
<div class="line"><a id="l00433" name="l00433"></a><span class="lineno">  433</span><span class="keywordflow">         enddo</span></div>
<div class="line"><a id="l00434" name="l00434"></a><span class="lineno">  434</span><span class="keywordflow">         enddo</span></div>
<div class="line"><a id="l00435" name="l00435"></a><span class="lineno">  435</span>    </div>
<div class="line"><a id="l00436" name="l00436"></a><span class="lineno">  436</span>         <span class="keywordflow">do</span> id=1,ndm</div>
<div class="line"><a id="l00437" name="l00437"></a><span class="lineno">  437</span>          <span class="keywordflow">do</span> ig=1,ng_u</div>
<div class="line"><a id="l00438" name="l00438"></a><span class="lineno">  438</span><span class="comment">!           tg1D(id,ig)=tg_u(ix,iy,ind_gd(ig,id))</span></div>
<div class="line"><a id="l00439" name="l00439"></a><span class="lineno">  439</span>            tg1d(id,ig)=tgb_urb4d(ix,ind_gd(ig,id),iy)</div>
<div class="line"><a id="l00440" name="l00440"></a><span class="lineno">  440</span><span class="keywordflow">          enddo</span></div>
<div class="line"><a id="l00441" name="l00441"></a><span class="lineno">  441</span>          <span class="keywordflow">do</span> iz_u=1,nz_um</div>
<div class="line"><a id="l00442" name="l00442"></a><span class="lineno">  442</span>          <span class="keywordflow">do</span> ir=1,nwr_u</div>
<div class="line"><a id="l00443" name="l00443"></a><span class="lineno">  443</span><span class="comment">!           tr1D(id,iz_u,ir)=tr_u(ix,iy,ind_zwd(iz_u,ir,id))</span></div>
<div class="line"><a id="l00444" name="l00444"></a><span class="lineno">  444</span>            <span class="keywordflow">if</span>(ind_zwd(iz_u,ir,id).gt.num_urban_layers)<span class="keyword">write</span>(*,*)<span class="stringliteral">&#39;ind_zwd too big r&#39;</span>,ind_zwd(iz_u,ir,id)</div>
<div class="line"><a id="l00445" name="l00445"></a><span class="lineno">  445</span>            tr1d(id,iz_u,ir)=trb_urb4d(ix,ind_zwd(iz_u,ir,id),iy)</div>
<div class="line"><a id="l00446" name="l00446"></a><span class="lineno">  446</span><span class="keywordflow">          enddo</span></div>
<div class="line"><a id="l00447" name="l00447"></a><span class="lineno">  447</span><span class="keywordflow">          enddo</span></div>
<div class="line"><a id="l00448" name="l00448"></a><span class="lineno">  448</span><span class="keywordflow">         enddo</span></div>
<div class="line"><a id="l00449" name="l00449"></a><span class="lineno">  449</span> </div>
<div class="line"><a id="l00450" name="l00450"></a><span class="lineno">  450</span>         <span class="keywordflow">do</span> id=1,ndm</div>
<div class="line"><a id="l00451" name="l00451"></a><span class="lineno">  451</span>     <span class="keywordflow">do</span> iz=1,nz_um</div>
<div class="line"><a id="l00452" name="l00452"></a><span class="lineno">  452</span><span class="comment">!     sfw1D(2*id-1,iz)=sfw1(ix,iy,ind_zd(iz,id))</span></div>
<div class="line"><a id="l00453" name="l00453"></a><span class="lineno">  453</span><span class="comment">!     sfw1D(2*id,iz)=sfw2(ix,iy,ind_zd(iz,id))</span></div>
<div class="line"><a id="l00454" name="l00454"></a><span class="lineno">  454</span>      sfw1d(2*id-1,iz)=sfw1_urb3d(ix,ind_zd(iz,id),iy)</div>
<div class="line"><a id="l00455" name="l00455"></a><span class="lineno">  455</span>      sfw1d(2*id,iz)=sfw2_urb3d(ix,ind_zd(iz,id),iy)</div>
<div class="line"><a id="l00456" name="l00456"></a><span class="lineno">  456</span><span class="keywordflow">     enddo</span></div>
<div class="line"><a id="l00457" name="l00457"></a><span class="lineno">  457</span><span class="keywordflow">     enddo</span></div>
<div class="line"><a id="l00458" name="l00458"></a><span class="lineno">  458</span>     </div>
<div class="line"><a id="l00459" name="l00459"></a><span class="lineno">  459</span>     <span class="keywordflow">do</span> id=1,ndm</div>
<div class="line"><a id="l00460" name="l00460"></a><span class="lineno">  460</span><span class="comment">!     sfg1D(id)=sfg(ix,iy,id)</span></div>
<div class="line"><a id="l00461" name="l00461"></a><span class="lineno">  461</span>      sfg1d(id)=sfg_urb3d(ix,id,iy)</div>
<div class="line"><a id="l00462" name="l00462"></a><span class="lineno">  462</span><span class="keywordflow">     enddo</span></div>
<div class="line"><a id="l00463" name="l00463"></a><span class="lineno">  463</span>     </div>
<div class="line"><a id="l00464" name="l00464"></a><span class="lineno">  464</span>     <span class="keywordflow">do</span> id=1,ndm</div>
<div class="line"><a id="l00465" name="l00465"></a><span class="lineno">  465</span>     <span class="keywordflow">do</span> iz=1,nz_um</div>
<div class="line"><a id="l00466" name="l00466"></a><span class="lineno">  466</span><span class="comment">!     sfr1D(id,iz)=sfr(ix,iy,ind_zd(iz,id))</span></div>
<div class="line"><a id="l00467" name="l00467"></a><span class="lineno">  467</span>      sfr1d(id,iz)=sfr_urb3d(ix,ind_zd(iz,id),iy)</div>
<div class="line"><a id="l00468" name="l00468"></a><span class="lineno">  468</span><span class="keywordflow">     enddo</span></div>
<div class="line"><a id="l00469" name="l00469"></a><span class="lineno">  469</span><span class="keywordflow">     enddo</span></div>
<div class="line"><a id="l00470" name="l00470"></a><span class="lineno">  470</span> </div>
<div class="line"><a id="l00471" name="l00471"></a><span class="lineno">  471</span>         </div>
<div class="line"><a id="l00472" name="l00472"></a><span class="lineno">  472</span>         rs1d=swdown(ix,iy)</div>
<div class="line"><a id="l00473" name="l00473"></a><span class="lineno">  473</span>         rld1d=glw(ix,iy)</div>
<div class="line"><a id="l00474" name="l00474"></a><span class="lineno">  474</span>         time_h=(itimestep*dt)/3600.+gmt</div>
<div class="line"><a id="l00475" name="l00475"></a><span class="lineno">  475</span> </div>
<div class="line"><a id="l00476" name="l00476"></a><span class="lineno">  476</span>         zr1d=acos(cosz_urb2d(ix,iy))</div>
<div class="line"><a id="l00477" name="l00477"></a><span class="lineno">  477</span>         deltar1d=declin_urb</div>
<div class="line"><a id="l00478" name="l00478"></a><span class="lineno">  478</span>         ah1d=omg_urb2d(ix,iy)</div>
<div class="line"><a id="l00479" name="l00479"></a><span class="lineno">  479</span><span class="comment">!    call angle(xlong(ix,iy),xlat(ix,iy),julday,time_h,zr1D,deltar1D,ah1D)</span></div>
<div class="line"><a id="l00480" name="l00480"></a><span class="lineno">  480</span><span class="comment">!        write(*,*) &#39;entro en BEP1D&#39;</span></div>
<div class="line"><a id="l00481" name="l00481"></a><span class="lineno">  481</span>         <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a82297fd79f7a6627963d8b172f2a9c56">bep1d</a>(iurb,kms,kme,kts,kte,z1d,dt,ua1d,va1d,pt1d,da1d,pr1d,pt01d,  &amp;</div>
<div class="line"><a id="l00482" name="l00482"></a><span class="lineno">  482</span>                   zr1d,deltar1d,ah1d,rs1d,rld1d,                   &amp; </div>
<div class="line"><a id="l00483" name="l00483"></a><span class="lineno">  483</span>                   alag,alaw,alar,csg,csw,csr,                      &amp; </div>
<div class="line"><a id="l00484" name="l00484"></a><span class="lineno">  484</span>                   albg_u(iurb),albw_u(iurb),albr_u(iurb),          &amp;</div>
<div class="line"><a id="l00485" name="l00485"></a><span class="lineno">  485</span>                   emg_u(iurb),emw_u(iurb),emr_u(iurb),             &amp; </div>
<div class="line"><a id="l00486" name="l00486"></a><span class="lineno">  486</span>                   fww_u,fwg_u,fgw_u,fsw_u,                         &amp;                    </div>
<div class="line"><a id="l00487" name="l00487"></a><span class="lineno">  487</span>                   fws_u,fsg_u,z0,                                  &amp;                               </div>
<div class="line"><a id="l00488" name="l00488"></a><span class="lineno">  488</span>                   nd_u(iurb),strd,drst,ws,bs,ss,pb,                &amp; </div>
<div class="line"><a id="l00489" name="l00489"></a><span class="lineno">  489</span>                   nzurban(iurb),z_u,                               &amp; </div>
<div class="line"><a id="l00490" name="l00490"></a><span class="lineno">  490</span>                   tw1d,tg1d,tr1d,sfw1d,sfg1d,sfr1d,                &amp; </div>
<div class="line"><a id="l00491" name="l00491"></a><span class="lineno">  491</span>                   a_u1d,a_v1d,a_t1d,a_e1d,                         &amp; </div>
<div class="line"><a id="l00492" name="l00492"></a><span class="lineno">  492</span>                   b_u1d,b_v1d,b_t1d,b_e1d,                         &amp; </div>
<div class="line"><a id="l00493" name="l00493"></a><span class="lineno">  493</span>                   dlg1d,dl_u1d,sf1d,vl1d,rl_up(ix,iy),             &amp;</div>
<div class="line"><a id="l00494" name="l00494"></a><span class="lineno">  494</span>                   rs_abs(ix,iy),emiss(ix,iy),grdflx_urb(ix,iy))                            </div>
<div class="line"><a id="l00495" name="l00495"></a><span class="lineno">  495</span><span class="comment">!        write(*,*) &#39;salgo de BEP1D&#39;</span></div>
<div class="line"><a id="l00496" name="l00496"></a><span class="lineno">  496</span>         <span class="keywordflow">do</span> id=1,ndm</div>
<div class="line"><a id="l00497" name="l00497"></a><span class="lineno">  497</span>     <span class="keywordflow">do</span> iz=1,nz_um</div>
<div class="line"><a id="l00498" name="l00498"></a><span class="lineno">  498</span>      sfw1_urb3d(ix,ind_zd(iz,id),iy)=sfw1d(2*id-1,iz) </div>
<div class="line"><a id="l00499" name="l00499"></a><span class="lineno">  499</span>      sfw2_urb3d(ix,ind_zd(iz,id),iy)=sfw1d(2*id,iz) </div>
<div class="line"><a id="l00500" name="l00500"></a><span class="lineno">  500</span><span class="keywordflow">     enddo</span></div>
<div class="line"><a id="l00501" name="l00501"></a><span class="lineno">  501</span><span class="keywordflow">     enddo</span></div>
<div class="line"><a id="l00502" name="l00502"></a><span class="lineno">  502</span> </div>
<div class="line"><a id="l00503" name="l00503"></a><span class="lineno">  503</span>     <span class="keywordflow">do</span> id=1,ndm</div>
<div class="line"><a id="l00504" name="l00504"></a><span class="lineno">  504</span>      sfg_urb3d(ix,id,iy)=sfg1d(id) </div>
<div class="line"><a id="l00505" name="l00505"></a><span class="lineno">  505</span><span class="keywordflow">     enddo</span></div>
<div class="line"><a id="l00506" name="l00506"></a><span class="lineno">  506</span>    </div>
<div class="line"><a id="l00507" name="l00507"></a><span class="lineno">  507</span>     <span class="keywordflow">do</span> id=1,ndm</div>
<div class="line"><a id="l00508" name="l00508"></a><span class="lineno">  508</span>     <span class="keywordflow">do</span> iz=1,nz_um</div>
<div class="line"><a id="l00509" name="l00509"></a><span class="lineno">  509</span>      sfr_urb3d(ix,ind_zd(iz,id),iy)=sfr1d(id,iz)</div>
<div class="line"><a id="l00510" name="l00510"></a><span class="lineno">  510</span><span class="keywordflow">     enddo</span></div>
<div class="line"><a id="l00511" name="l00511"></a><span class="lineno">  511</span><span class="keywordflow">     enddo</span></div>
<div class="line"><a id="l00512" name="l00512"></a><span class="lineno">  512</span><span class="comment">!</span></div>
<div class="line"><a id="l00513" name="l00513"></a><span class="lineno">  513</span>         <span class="keywordflow">do</span> id=1,ndm</div>
<div class="line"><a id="l00514" name="l00514"></a><span class="lineno">  514</span>         <span class="keywordflow">do</span> iz_u=1,nz_um</div>
<div class="line"><a id="l00515" name="l00515"></a><span class="lineno">  515</span>         <span class="keywordflow">do</span> iw=1,nwr_u</div>
<div class="line"><a id="l00516" name="l00516"></a><span class="lineno">  516</span>          tw1_urb4d(ix,ind_zwd(iz_u,iw,id),iy)=tw1d(2*id-1,iz_u,iw)</div>
<div class="line"><a id="l00517" name="l00517"></a><span class="lineno">  517</span>          tw2_urb4d(ix,ind_zwd(iz_u,iw,id),iy)=tw1d(2*id,iz_u,iw)</div>
<div class="line"><a id="l00518" name="l00518"></a><span class="lineno">  518</span><span class="keywordflow">         enddo</span></div>
<div class="line"><a id="l00519" name="l00519"></a><span class="lineno">  519</span><span class="keywordflow">         enddo</span></div>
<div class="line"><a id="l00520" name="l00520"></a><span class="lineno">  520</span><span class="keywordflow">         enddo</span></div>
<div class="line"><a id="l00521" name="l00521"></a><span class="lineno">  521</span>        </div>
<div class="line"><a id="l00522" name="l00522"></a><span class="lineno">  522</span>         <span class="keywordflow">do</span> id=1,ndm</div>
<div class="line"><a id="l00523" name="l00523"></a><span class="lineno">  523</span>          <span class="keywordflow">do</span> ig=1,ng_u</div>
<div class="line"><a id="l00524" name="l00524"></a><span class="lineno">  524</span>           tgb_urb4d(ix,ind_gd(ig,id),iy)=tg1d(id,ig)</div>
<div class="line"><a id="l00525" name="l00525"></a><span class="lineno">  525</span><span class="keywordflow">          enddo</span></div>
<div class="line"><a id="l00526" name="l00526"></a><span class="lineno">  526</span>          <span class="keywordflow">do</span> iz_u=1,nz_um</div>
<div class="line"><a id="l00527" name="l00527"></a><span class="lineno">  527</span>          <span class="keywordflow">do</span> ir=1,nwr_u</div>
<div class="line"><a id="l00528" name="l00528"></a><span class="lineno">  528</span>           trb_urb4d(ix,ind_zwd(iz_u,ir,id),iy)=tr1d(id,iz_u,ir)</div>
<div class="line"><a id="l00529" name="l00529"></a><span class="lineno">  529</span><span class="keywordflow">          enddo</span></div>
<div class="line"><a id="l00530" name="l00530"></a><span class="lineno">  530</span><span class="keywordflow">          enddo</span></div>
<div class="line"><a id="l00531" name="l00531"></a><span class="lineno">  531</span><span class="keywordflow">         enddo</span></div>
<div class="line"><a id="l00532" name="l00532"></a><span class="lineno">  532</span>        </div>
<div class="line"><a id="l00533" name="l00533"></a><span class="lineno">  533</span>          sf(ix,kts:kte,iy)=0.</div>
<div class="line"><a id="l00534" name="l00534"></a><span class="lineno">  534</span>          vl(ix,kts:kte,iy)=0.</div>
<div class="line"><a id="l00535" name="l00535"></a><span class="lineno">  535</span>          a_u(ix,kts:kte,iy)=0.</div>
<div class="line"><a id="l00536" name="l00536"></a><span class="lineno">  536</span>          a_v(ix,kts:kte,iy)=0.</div>
<div class="line"><a id="l00537" name="l00537"></a><span class="lineno">  537</span>          a_t(ix,kts:kte,iy)=0.</div>
<div class="line"><a id="l00538" name="l00538"></a><span class="lineno">  538</span>          a_e(ix,kts:kte,iy)=0.</div>
<div class="line"><a id="l00539" name="l00539"></a><span class="lineno">  539</span>          b_u(ix,kts:kte,iy)=0.</div>
<div class="line"><a id="l00540" name="l00540"></a><span class="lineno">  540</span>          b_v(ix,kts:kte,iy)=0.</div>
<div class="line"><a id="l00541" name="l00541"></a><span class="lineno">  541</span>          b_t(ix,kts:kte,iy)=0.</div>
<div class="line"><a id="l00542" name="l00542"></a><span class="lineno">  542</span>          b_e(ix,kts:kte,iy)=0.</div>
<div class="line"><a id="l00543" name="l00543"></a><span class="lineno">  543</span>          b_q(ix,kts:kte,iy)=0.</div>
<div class="line"><a id="l00544" name="l00544"></a><span class="lineno">  544</span>          dlg(ix,kts:kte,iy)=0.</div>
<div class="line"><a id="l00545" name="l00545"></a><span class="lineno">  545</span>          dl_u(ix,kts:kte,iy)=0.</div>
<div class="line"><a id="l00546" name="l00546"></a><span class="lineno">  546</span> </div>
<div class="line"><a id="l00547" name="l00547"></a><span class="lineno">  547</span>        <span class="keywordflow">do</span> iz= kts,kte</div>
<div class="line"><a id="l00548" name="l00548"></a><span class="lineno">  548</span>          sf(ix,iz,iy)=sf1d(iz)</div>
<div class="line"><a id="l00549" name="l00549"></a><span class="lineno">  549</span>          vl(ix,iz,iy)=vl1d(iz)</div>
<div class="line"><a id="l00550" name="l00550"></a><span class="lineno">  550</span>          a_u(ix,iz,iy)=a_u1d(iz)</div>
<div class="line"><a id="l00551" name="l00551"></a><span class="lineno">  551</span>          a_v(ix,iz,iy)=a_v1d(iz)</div>
<div class="line"><a id="l00552" name="l00552"></a><span class="lineno">  552</span>          a_t(ix,iz,iy)=a_t1d(iz)</div>
<div class="line"><a id="l00553" name="l00553"></a><span class="lineno">  553</span>          a_e(ix,iz,iy)=a_e1d(iz)</div>
<div class="line"><a id="l00554" name="l00554"></a><span class="lineno">  554</span>          b_u(ix,iz,iy)=b_u1d(iz)</div>
<div class="line"><a id="l00555" name="l00555"></a><span class="lineno">  555</span>          b_v(ix,iz,iy)=b_v1d(iz)</div>
<div class="line"><a id="l00556" name="l00556"></a><span class="lineno">  556</span>          b_t(ix,iz,iy)=b_t1d(iz)</div>
<div class="line"><a id="l00557" name="l00557"></a><span class="lineno">  557</span>          b_e(ix,iz,iy)=b_e1d(iz)</div>
<div class="line"><a id="l00558" name="l00558"></a><span class="lineno">  558</span>          dlg(ix,iz,iy)=dlg1d(iz)</div>
<div class="line"><a id="l00559" name="l00559"></a><span class="lineno">  559</span>          dl_u(ix,iz,iy)=dl_u1d(iz)</div>
<div class="line"><a id="l00560" name="l00560"></a><span class="lineno">  560</span><span class="keywordflow">         enddo</span></div>
<div class="line"><a id="l00561" name="l00561"></a><span class="lineno">  561</span>         sf(ix,kte+1,iy)=sf1d(kte+1)</div>
<div class="line"><a id="l00562" name="l00562"></a><span class="lineno">  562</span><span class="comment">!</span></div>
<div class="line"><a id="l00563" name="l00563"></a><span class="lineno">  563</span><span class="keywordflow">         endif</span> <span class="comment">! FRC_URB2D</span></div>
<div class="line"><a id="l00564" name="l00564"></a><span class="lineno">  564</span>   </div>
<div class="line"><a id="l00565" name="l00565"></a><span class="lineno">  565</span><span class="keywordflow">      enddo</span>  <span class="comment">! iy</span></div>
<div class="line"><a id="l00566" name="l00566"></a><span class="lineno">  566</span><span class="keywordflow">      enddo</span>  <span class="comment">! ix</span></div>
<div class="line"><a id="l00567" name="l00567"></a><span class="lineno">  567</span> </div>
<div class="line"><a id="l00568" name="l00568"></a><span class="lineno">  568</span> </div>
<div class="line"><a id="l00569" name="l00569"></a><span class="lineno">  569</span>        time_bep=time_bep+dt</div>
<div class="line"><a id="l00570" name="l00570"></a><span class="lineno">  570</span>         </div>
<div class="line"><a id="l00571" name="l00571"></a><span class="lineno">  571</span>         </div>
<div class="line"><a id="l00572" name="l00572"></a><span class="lineno">  572</span>      <span class="keywordflow">return</span></div>
<div class="line"><a id="l00573" name="l00573"></a><span class="lineno">  573</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a4e43ca6e75172d2dc55705c6adc6ed0d">bep</a></div>
<div class="line"><a id="l00574" name="l00574"></a><span class="lineno">  574</span>            </div>
<div class="line"><a id="l00575" name="l00575"></a><span class="lineno">  575</span><span class="comment">! ===6=8===============================================================72</span></div>
<div class="line"><a id="l00576" name="l00576"></a><span class="lineno">  576</span> </div>
<div class="line"><a id="l00577" name="l00577"></a><span class="lineno"><a class="line" href="namespacemodule__sf__bep.html#a82297fd79f7a6627963d8b172f2a9c56">  577</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a82297fd79f7a6627963d8b172f2a9c56">bep1d</a>(iurb,kms,kme,kts,kte,z,dt,ua,va,pt,da,pr,pt0,  &amp;  </div>
<div class="line"><a id="l00578" name="l00578"></a><span class="lineno">  578</span>                      zr,deltar,ah,rs,rld,                            &amp; </div>
<div class="line"><a id="l00579" name="l00579"></a><span class="lineno">  579</span>                      alag,alaw,alar,csg,csw,csr,                     &amp; </div>
<div class="line"><a id="l00580" name="l00580"></a><span class="lineno">  580</span>                      albg,albw,albr,emg,emw,emr,                     &amp; </div>
<div class="line"><a id="l00581" name="l00581"></a><span class="lineno">  581</span>                      fww,fwg,fgw,fsw,fws,fsg,z0,                     &amp;                                             </div>
<div class="line"><a id="l00582" name="l00582"></a><span class="lineno">  582</span>                      ndu,strd,drst,ws,bs,ss,pb,                      &amp; </div>
<div class="line"><a id="l00583" name="l00583"></a><span class="lineno">  583</span>                      nzu,z_u,                                        &amp; </div>
<div class="line"><a id="l00584" name="l00584"></a><span class="lineno">  584</span>                      tw,tg,tr,sfw,sfg,sfr,                           &amp; </div>
<div class="line"><a id="l00585" name="l00585"></a><span class="lineno">  585</span>                      a_u,a_v,a_t,a_e,                                &amp;</div>
<div class="line"><a id="l00586" name="l00586"></a><span class="lineno">  586</span>                      b_u,b_v,b_t,b_e,                                &amp; </div>
<div class="line"><a id="l00587" name="l00587"></a><span class="lineno">  587</span>                      dlg,dl_u,sf,vl,rl_up,rs_abs,emiss,grdflx_urb)                             </div>
<div class="line"><a id="l00588" name="l00588"></a><span class="lineno">  588</span> </div>
<div class="line"><a id="l00589" name="l00589"></a><span class="lineno">  589</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00590" name="l00590"></a><span class="lineno">  590</span><span class="comment">! This routine computes the effects of buildings on momentum, heat and</span></div>
<div class="line"><a id="l00591" name="l00591"></a><span class="lineno">  591</span><span class="comment">!  TKE (turbulent kinetic energy) sources or sinks and on the mixing length.</span></div>
<div class="line"><a id="l00592" name="l00592"></a><span class="lineno">  592</span><span class="comment">! It provides momentum, heat and TKE sources or sinks at different levels of a</span></div>
<div class="line"><a id="l00593" name="l00593"></a><span class="lineno">  593</span><span class="comment">!  mesoscale grid defined by the altitude of its cell interfaces &quot;z&quot; and</span></div>
<div class="line"><a id="l00594" name="l00594"></a><span class="lineno">  594</span><span class="comment">!  its number of levels &quot;nz&quot;.</span></div>
<div class="line"><a id="l00595" name="l00595"></a><span class="lineno">  595</span><span class="comment">! The meteorological input parameters (wind, temperature, solar radiation)</span></div>
<div class="line"><a id="l00596" name="l00596"></a><span class="lineno">  596</span><span class="comment">!  are specified on the &quot;mesoscale grid&quot;.</span></div>
<div class="line"><a id="l00597" name="l00597"></a><span class="lineno">  597</span><span class="comment">! The inputs concerning the building and street charateristics are defined</span></div>
<div class="line"><a id="l00598" name="l00598"></a><span class="lineno">  598</span><span class="comment">!  on a &quot;urban grid&quot;. The &quot;urban grid&quot; is defined with its number of levels</span></div>
<div class="line"><a id="l00599" name="l00599"></a><span class="lineno">  599</span><span class="comment">!  &quot;nz_u&quot; and its space step &quot;dz_u&quot;.</span></div>
<div class="line"><a id="l00600" name="l00600"></a><span class="lineno">  600</span><span class="comment">! The input parameters are interpolated on the &quot;urban grid&quot;. The sources or sinks</span></div>
<div class="line"><a id="l00601" name="l00601"></a><span class="lineno">  601</span><span class="comment">!  are calculated on the &quot;urban grid&quot;. Finally the sources or sinks are </span></div>
<div class="line"><a id="l00602" name="l00602"></a><span class="lineno">  602</span><span class="comment">!  interpolated on the &quot;mesoscale grid&quot;.</span></div>
<div class="line"><a id="l00603" name="l00603"></a><span class="lineno">  603</span> </div>
<div class="line"><a id="l00604" name="l00604"></a><span class="lineno">  604</span> </div>
<div class="line"><a id="l00605" name="l00605"></a><span class="lineno">  605</span><span class="comment">!  Mesoscale grid            Urban grid             Mesoscale grid</span></div>
<div class="line"><a id="l00606" name="l00606"></a><span class="lineno">  606</span><span class="comment">!  </span></div>
<div class="line"><a id="l00607" name="l00607"></a><span class="lineno">  607</span><span class="comment">! z(4)    ---                                               ---</span></div>
<div class="line"><a id="l00608" name="l00608"></a><span class="lineno">  608</span><span class="comment">!          |                                                 |</span></div>
<div class="line"><a id="l00609" name="l00609"></a><span class="lineno">  609</span><span class="comment">!          |                                                 |</span></div>
<div class="line"><a id="l00610" name="l00610"></a><span class="lineno">  610</span><span class="comment">!          |   Interpolation                  Interpolation  |</span></div>
<div class="line"><a id="l00611" name="l00611"></a><span class="lineno">  611</span><span class="comment">!          |            Sources or sinks calculation         |</span></div>
<div class="line"><a id="l00612" name="l00612"></a><span class="lineno">  612</span><span class="comment">! z(3)    ---                                               ---</span></div>
<div class="line"><a id="l00613" name="l00613"></a><span class="lineno">  613</span><span class="comment">!          | ua               ua_u  ---  uv_a         a_u    |</span></div>
<div class="line"><a id="l00614" name="l00614"></a><span class="lineno">  614</span><span class="comment">!          | va               va_u   |   uv_b         b_u    |</span></div>
<div class="line"><a id="l00615" name="l00615"></a><span class="lineno">  615</span><span class="comment">!          | pt               pt_u  ---  uh_b         a_v    |</span></div>
<div class="line"><a id="l00616" name="l00616"></a><span class="lineno">  616</span><span class="comment">! z(2)    ---                        |    etc...      etc...---</span></div>
<div class="line"><a id="l00617" name="l00617"></a><span class="lineno">  617</span><span class="comment">!          |                 z_u(1) ---                      |</span></div>
<div class="line"><a id="l00618" name="l00618"></a><span class="lineno">  618</span><span class="comment">!          |                         |                       |</span></div>
<div class="line"><a id="l00619" name="l00619"></a><span class="lineno">  619</span><span class="comment">! z(1) ------------------------------------------------------------</span></div>
<div class="line"><a id="l00620" name="l00620"></a><span class="lineno">  620</span> </div>
<div class="line"><a id="l00621" name="l00621"></a><span class="lineno">  621</span><span class="comment">!     </span></div>
<div class="line"><a id="l00622" name="l00622"></a><span class="lineno">  622</span><span class="comment">! Reference:</span></div>
<div class="line"><a id="l00623" name="l00623"></a><span class="lineno">  623</span><span class="comment">! Martilli, A., Clappier, A., Rotach, M.W.:2002, &#39;AN URBAN SURFACE EXCHANGE</span></div>
<div class="line"><a id="l00624" name="l00624"></a><span class="lineno">  624</span><span class="comment">! PARAMETERISATION FOR MESOSCALE MODELS&#39;, Boundary-Layer Meteorolgy 104:</span></div>
<div class="line"><a id="l00625" name="l00625"></a><span class="lineno">  625</span><span class="comment">! 261-304</span></div>
<div class="line"><a id="l00626" name="l00626"></a><span class="lineno">  626</span> </div>
<div class="line"><a id="l00627" name="l00627"></a><span class="lineno">  627</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00628" name="l00628"></a><span class="lineno">  628</span> </div>
<div class="line"><a id="l00629" name="l00629"></a><span class="lineno">  629</span>      <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l00630" name="l00630"></a><span class="lineno">  630</span> </div>
<div class="line"><a id="l00631" name="l00631"></a><span class="lineno">  631</span> </div>
<div class="line"><a id="l00632" name="l00632"></a><span class="lineno">  632</span> </div>
<div class="line"><a id="l00633" name="l00633"></a><span class="lineno">  633</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00634" name="l00634"></a><span class="lineno">  634</span><span class="comment">! INPUT:</span></div>
<div class="line"><a id="l00635" name="l00635"></a><span class="lineno">  635</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00636" name="l00636"></a><span class="lineno">  636</span> </div>
<div class="line"><a id="l00637" name="l00637"></a><span class="lineno">  637</span><span class="comment">! Data relative to the &quot;mesoscale grid&quot;</span></div>
<div class="line"><a id="l00638" name="l00638"></a><span class="lineno">  638</span> </div>
<div class="line"><a id="l00639" name="l00639"></a><span class="lineno">  639</span><span class="comment">!      integer nz                 ! Number of vertical levels</span></div>
<div class="line"><a id="l00640" name="l00640"></a><span class="lineno">  640</span>      <span class="keywordtype">integer</span> kms,kme,kts,kte</div>
<div class="line"><a id="l00641" name="l00641"></a><span class="lineno">  641</span><span class="keywordtype">      real</span> z(kms:kme)               <span class="comment">! Altitude above the ground of the cell interfaces.</span></div>
<div class="line"><a id="l00642" name="l00642"></a><span class="lineno">  642</span><span class="keywordtype">      real</span> ua(kms:kme)                <span class="comment">! Wind speed in the x direction</span></div>
<div class="line"><a id="l00643" name="l00643"></a><span class="lineno">  643</span><span class="keywordtype">      real</span> va(kms:kme)                <span class="comment">! Wind speed in the y direction</span></div>
<div class="line"><a id="l00644" name="l00644"></a><span class="lineno">  644</span><span class="keywordtype">      real</span> pt(kms:kme)                <span class="comment">! Potential temperature</span></div>
<div class="line"><a id="l00645" name="l00645"></a><span class="lineno">  645</span><span class="keywordtype">      real</span> da(kms:kme)                <span class="comment">! Air density</span></div>
<div class="line"><a id="l00646" name="l00646"></a><span class="lineno">  646</span><span class="keywordtype">      real</span> pr(kms:kme)                <span class="comment">! Air pressure</span></div>
<div class="line"><a id="l00647" name="l00647"></a><span class="lineno">  647</span><span class="keywordtype">      real</span> pt0(kms:kme)               <span class="comment">! Reference potential temperature (could be equal to &quot;pt&quot;)</span></div>
<div class="line"><a id="l00648" name="l00648"></a><span class="lineno">  648</span><span class="keywordtype">      real</span> dt                    <span class="comment">! Time step</span></div>
<div class="line"><a id="l00649" name="l00649"></a><span class="lineno">  649</span><span class="keywordtype">      real</span> zr                    <span class="comment">! Zenith angle</span></div>
<div class="line"><a id="l00650" name="l00650"></a><span class="lineno">  650</span><span class="keywordtype">      real</span> deltar                <span class="comment">! Declination of the sun</span></div>
<div class="line"><a id="l00651" name="l00651"></a><span class="lineno">  651</span><span class="keywordtype">      real</span> ah                    <span class="comment">! Hour angle</span></div>
<div class="line"><a id="l00652" name="l00652"></a><span class="lineno">  652</span><span class="keywordtype">      real</span> rs                    <span class="comment">! Solar radiation</span></div>
<div class="line"><a id="l00653" name="l00653"></a><span class="lineno">  653</span><span class="keywordtype">      real</span> rld                   <span class="comment">! Downward flux of the longwave radiation</span></div>
<div class="line"><a id="l00654" name="l00654"></a><span class="lineno">  654</span> </div>
<div class="line"><a id="l00655" name="l00655"></a><span class="lineno">  655</span><span class="comment">! Data relative to the &quot;urban grid&quot;</span></div>
<div class="line"><a id="l00656" name="l00656"></a><span class="lineno">  656</span> </div>
<div class="line"><a id="l00657" name="l00657"></a><span class="lineno">  657</span>      <span class="keywordtype">integer</span> iurb               <span class="comment">! Current urban class</span></div>
<div class="line"><a id="l00658" name="l00658"></a><span class="lineno">  658</span> </div>
<div class="line"><a id="l00659" name="l00659"></a><span class="lineno">  659</span><span class="comment">!    Building parameters      </span></div>
<div class="line"><a id="l00660" name="l00660"></a><span class="lineno">  660</span><span class="keywordtype">      real</span> alag(ng_u)            <span class="comment">! Ground thermal diffusivity [m^2 s^-1]</span></div>
<div class="line"><a id="l00661" name="l00661"></a><span class="lineno">  661</span><span class="keywordtype">      real</span> alaw(nwr_u)           <span class="comment">! Wall thermal diffusivity [m^2 s^-1]</span></div>
<div class="line"><a id="l00662" name="l00662"></a><span class="lineno">  662</span><span class="keywordtype">      real</span> alar(nwr_u)           <span class="comment">! Roof thermal diffusivity [m^2 s^-1]</span></div>
<div class="line"><a id="l00663" name="l00663"></a><span class="lineno">  663</span><span class="keywordtype">      real</span> csg(ng_u)             <span class="comment">! Specific heat of the ground material [J m^3 K^-1]</span></div>
<div class="line"><a id="l00664" name="l00664"></a><span class="lineno">  664</span><span class="keywordtype">      real</span> csw(nwr_u)            <span class="comment">! Specific heat of the wall material [J m^3 K^-1]</span></div>
<div class="line"><a id="l00665" name="l00665"></a><span class="lineno">  665</span><span class="keywordtype">      real</span> csr(nwr_u)            <span class="comment">! Specific heat of the roof material [J m^3 K^-1]</span></div>
<div class="line"><a id="l00666" name="l00666"></a><span class="lineno">  666</span> </div>
<div class="line"><a id="l00667" name="l00667"></a><span class="lineno">  667</span><span class="comment">!    Radiation parameters</span></div>
<div class="line"><a id="l00668" name="l00668"></a><span class="lineno">  668</span><span class="keywordtype">      real</span> albg                  <span class="comment">! Albedo of the ground</span></div>
<div class="line"><a id="l00669" name="l00669"></a><span class="lineno">  669</span><span class="keywordtype">      real</span> albw                  <span class="comment">! Albedo of the wall</span></div>
<div class="line"><a id="l00670" name="l00670"></a><span class="lineno">  670</span><span class="keywordtype">      real</span> albr                  <span class="comment">! Albedo of the roof</span></div>
<div class="line"><a id="l00671" name="l00671"></a><span class="lineno">  671</span><span class="keywordtype">      real</span> emg                   <span class="comment">! Emissivity of ground</span></div>
<div class="line"><a id="l00672" name="l00672"></a><span class="lineno">  672</span><span class="keywordtype">      real</span> emw                   <span class="comment">! Emissivity of wall</span></div>
<div class="line"><a id="l00673" name="l00673"></a><span class="lineno">  673</span><span class="keywordtype">      real</span> emr                   <span class="comment">! Emissivity of roof</span></div>
<div class="line"><a id="l00674" name="l00674"></a><span class="lineno">  674</span> </div>
<div class="line"><a id="l00675" name="l00675"></a><span class="lineno">  675</span><span class="comment">!    fww,fwg,fgw,fsw,fsg are the view factors used to compute the long and </span></div>
<div class="line"><a id="l00676" name="l00676"></a><span class="lineno">  676</span><span class="comment">!    short wave radation. </span></div>
<div class="line"><a id="l00677" name="l00677"></a><span class="lineno">  677</span><span class="comment">!    The calculation of these factor is explained in the Appendix A of the BLM paper</span></div>
<div class="line"><a id="l00678" name="l00678"></a><span class="lineno">  678</span><span class="keywordtype">      real</span> fww(nz_um,nz_um,ndm,nurbm)  <span class="comment">!  from wall to wall</span></div>
<div class="line"><a id="l00679" name="l00679"></a><span class="lineno">  679</span><span class="keywordtype">      real</span> fwg(nz_um,ndm,nurbm)        <span class="comment">!  from wall to ground</span></div>
<div class="line"><a id="l00680" name="l00680"></a><span class="lineno">  680</span><span class="keywordtype">      real</span> fgw(nz_um,ndm,nurbm)        <span class="comment">!  from ground to wall</span></div>
<div class="line"><a id="l00681" name="l00681"></a><span class="lineno">  681</span><span class="keywordtype">      real</span> fsw(nz_um,ndm,nurbm)        <span class="comment">!  from sky to wall</span></div>
<div class="line"><a id="l00682" name="l00682"></a><span class="lineno">  682</span><span class="keywordtype">      real</span> fws(nz_um,ndm,nurbm)        <span class="comment">!  from wall to sky</span></div>
<div class="line"><a id="l00683" name="l00683"></a><span class="lineno">  683</span><span class="keywordtype">      real</span> fsg(ndm,nurbm)              <span class="comment">!  from sky to ground</span></div>
<div class="line"><a id="l00684" name="l00684"></a><span class="lineno">  684</span> </div>
<div class="line"><a id="l00685" name="l00685"></a><span class="lineno">  685</span><span class="comment">!    Roughness parameters</span></div>
<div class="line"><a id="l00686" name="l00686"></a><span class="lineno">  686</span><span class="keywordtype">      real</span> z0(ndm,nz_um)           <span class="comment">! Roughness lengths &quot;profiles&quot;</span></div>
<div class="line"><a id="l00687" name="l00687"></a><span class="lineno">  687</span>      </div>
<div class="line"><a id="l00688" name="l00688"></a><span class="lineno">  688</span><span class="comment">!    Street parameters</span></div>
<div class="line"><a id="l00689" name="l00689"></a><span class="lineno">  689</span>      <span class="keywordtype">integer</span> ndu                  <span class="comment">! Number of street direction for each urban class </span></div>
<div class="line"><a id="l00690" name="l00690"></a><span class="lineno">  690</span><span class="keywordtype">      real</span> strd(ndm)               <span class="comment">! Street length (set to a greater value then the horizontal length of the cells)</span></div>
<div class="line"><a id="l00691" name="l00691"></a><span class="lineno">  691</span><span class="keywordtype">      real</span> drst(ndm)               <span class="comment">! Street direction</span></div>
<div class="line"><a id="l00692" name="l00692"></a><span class="lineno">  692</span><span class="keywordtype">      real</span> ws(ndm)                 <span class="comment">! Street width</span></div>
<div class="line"><a id="l00693" name="l00693"></a><span class="lineno">  693</span><span class="keywordtype">      real</span> bs(ndm)                 <span class="comment">! Building width</span></div>
<div class="line"><a id="l00694" name="l00694"></a><span class="lineno">  694</span><span class="keywordtype">      real</span> ss(nz_um)               <span class="comment">! The probability that a building has an height equal to &quot;z&quot;</span></div>
<div class="line"><a id="l00695" name="l00695"></a><span class="lineno">  695</span><span class="keywordtype">      real</span> pb(nz_um)               <span class="comment">! The probability that a building has an height greater or equal to &quot;z&quot;</span></div>
<div class="line"><a id="l00696" name="l00696"></a><span class="lineno">  696</span>        </div>
<div class="line"><a id="l00697" name="l00697"></a><span class="lineno">  697</span><span class="comment">!    Grid parameters</span></div>
<div class="line"><a id="l00698" name="l00698"></a><span class="lineno">  698</span>      <span class="keywordtype">integer</span> nzu                  <span class="comment">! Number of layer in the urban grid</span></div>
<div class="line"><a id="l00699" name="l00699"></a><span class="lineno">  699</span><span class="keywordtype">      real</span> z_u(nz_um)              <span class="comment">! Height of the urban grid levels</span></div>
<div class="line"><a id="l00700" name="l00700"></a><span class="lineno">  700</span> </div>
<div class="line"><a id="l00701" name="l00701"></a><span class="lineno">  701</span> </div>
<div class="line"><a id="l00702" name="l00702"></a><span class="lineno">  702</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00703" name="l00703"></a><span class="lineno">  703</span><span class="comment">! INPUT-OUTPUT</span></div>
<div class="line"><a id="l00704" name="l00704"></a><span class="lineno">  704</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00705" name="l00705"></a><span class="lineno">  705</span> </div>
<div class="line"><a id="l00706" name="l00706"></a><span class="lineno">  706</span><span class="comment">! Data relative to the &quot;urban grid&quot; which should be stored from the current time step to the next one</span></div>
<div class="line"><a id="l00707" name="l00707"></a><span class="lineno">  707</span> </div>
<div class="line"><a id="l00708" name="l00708"></a><span class="lineno">  708</span><span class="keywordtype">      real</span> tw(2*ndm,nz_um,nwr_u)  <span class="comment">! Temperature in each layer of the wall [K]</span></div>
<div class="line"><a id="l00709" name="l00709"></a><span class="lineno">  709</span><span class="keywordtype">      real</span> tr(ndm,nz_um,nwr_u)  <span class="comment">! Temperature in each layer of the roof [K]</span></div>
<div class="line"><a id="l00710" name="l00710"></a><span class="lineno">  710</span><span class="keywordtype">      real</span> tg(ndm,ng_u)          <span class="comment">! Temperature in each layer of the ground [K]</span></div>
<div class="line"><a id="l00711" name="l00711"></a><span class="lineno">  711</span><span class="keywordtype">      real</span> sfw(2*ndm,nz_um)      <span class="comment">! Sensible heat flux from walls</span></div>
<div class="line"><a id="l00712" name="l00712"></a><span class="lineno">  712</span><span class="keywordtype">      real</span> sfg(ndm)              <span class="comment">! Sensible heat flux from ground (road)</span></div>
<div class="line"><a id="l00713" name="l00713"></a><span class="lineno">  713</span><span class="keywordtype">      real</span> sfr(ndm,nz_um)      <span class="comment">! Sensible heat flux from roofs</span></div>
<div class="line"><a id="l00714" name="l00714"></a><span class="lineno">  714</span><span class="keywordtype">      real</span> gfg(ndm)             <span class="comment">! Heat flux transferred from the surface of the ground (road) towards the interior</span></div>
<div class="line"><a id="l00715" name="l00715"></a><span class="lineno">  715</span><span class="keywordtype">      real</span> gfr(ndm,nz_um)     <span class="comment">! Heat flux transferred from the surface of the roof towards the interior</span></div>
<div class="line"><a id="l00716" name="l00716"></a><span class="lineno">  716</span><span class="keywordtype">      real</span> gfw(2*ndm,nz_um)     <span class="comment">! Heat flux transfered from the surface of the walls towards the interior</span></div>
<div class="line"><a id="l00717" name="l00717"></a><span class="lineno">  717</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00718" name="l00718"></a><span class="lineno">  718</span><span class="comment">! OUTPUT:</span></div>
<div class="line"><a id="l00719" name="l00719"></a><span class="lineno">  719</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00720" name="l00720"></a><span class="lineno">  720</span> </div>
<div class="line"><a id="l00721" name="l00721"></a><span class="lineno">  721</span><span class="comment">! Data relative to the &quot;mesoscale grid&quot;</span></div>
<div class="line"><a id="l00722" name="l00722"></a><span class="lineno">  722</span> </div>
<div class="line"><a id="l00723" name="l00723"></a><span class="lineno">  723</span><span class="keywordtype">      real</span> sf(kms:kme)             <span class="comment">! Surface of the &quot;mesoscale grid&quot; cells taking into account the buildings</span></div>
<div class="line"><a id="l00724" name="l00724"></a><span class="lineno">  724</span><span class="keywordtype">      real</span> vl(kms:kme)               <span class="comment">! Volume of the &quot;mesoscale grid&quot; cells taking into account the buildings</span></div>
<div class="line"><a id="l00725" name="l00725"></a><span class="lineno">  725</span>     </div>
<div class="line"><a id="l00726" name="l00726"></a><span class="lineno">  726</span><span class="comment">!    Implicit and explicit components of the source and sink terms at each levels,</span></div>
<div class="line"><a id="l00727" name="l00727"></a><span class="lineno">  727</span><span class="comment">!     the fluxes can be computed as follow: FX = A*X + B   example: Heat fluxes = a_t * pt + b_t</span></div>
<div class="line"><a id="l00728" name="l00728"></a><span class="lineno">  728</span><span class="keywordtype">      real</span> a_u(kms:kme)              <span class="comment">! Implicit component of the momentum sources or sinks in the X-direction</span></div>
<div class="line"><a id="l00729" name="l00729"></a><span class="lineno">  729</span><span class="keywordtype">      real</span> a_v(kms:kme)              <span class="comment">! Implicit component of the momentum sources or sinks in the Y-direction</span></div>
<div class="line"><a id="l00730" name="l00730"></a><span class="lineno">  730</span><span class="keywordtype">      real</span> a_t(kms:kme)              <span class="comment">! Implicit component of the heat sources or sinks</span></div>
<div class="line"><a id="l00731" name="l00731"></a><span class="lineno">  731</span><span class="keywordtype">      real</span> a_e(kms:kme)              <span class="comment">! Implicit component of the TKE sources or sinks</span></div>
<div class="line"><a id="l00732" name="l00732"></a><span class="lineno">  732</span><span class="keywordtype">      real</span> b_u(kms:kme)              <span class="comment">! Explicit component of the momentum sources or sinks in the X-direction</span></div>
<div class="line"><a id="l00733" name="l00733"></a><span class="lineno">  733</span><span class="keywordtype">      real</span> b_v(kms:kme)              <span class="comment">! Explicit component of the momentum sources or sinks in the Y-direction</span></div>
<div class="line"><a id="l00734" name="l00734"></a><span class="lineno">  734</span><span class="keywordtype">      real</span> b_t(kms:kme)              <span class="comment">! Explicit component of the heat sources or sinks</span></div>
<div class="line"><a id="l00735" name="l00735"></a><span class="lineno">  735</span><span class="keywordtype">      real</span> b_e(kms:kme)              <span class="comment">! Explicit component of the TKE sources or sinks</span></div>
<div class="line"><a id="l00736" name="l00736"></a><span class="lineno">  736</span><span class="keywordtype">      real</span> dlg(kms:kme)              <span class="comment">! Height above ground (L_ground in formula (24) of the BLM paper). </span></div>
<div class="line"><a id="l00737" name="l00737"></a><span class="lineno">  737</span><span class="keywordtype">      real</span> dl_u(kms:kme)             <span class="comment">! Length scale (lb in formula (22) ofthe BLM paper).</span></div>
<div class="line"><a id="l00738" name="l00738"></a><span class="lineno">  738</span>      </div>
<div class="line"><a id="l00739" name="l00739"></a><span class="lineno">  739</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00740" name="l00740"></a><span class="lineno">  740</span><span class="comment">! LOCAL:</span></div>
<div class="line"><a id="l00741" name="l00741"></a><span class="lineno">  741</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00742" name="l00742"></a><span class="lineno">  742</span> </div>
<div class="line"><a id="l00743" name="l00743"></a><span class="lineno">  743</span><span class="keywordtype">      real</span> dz(kms:kme)               <span class="comment">! vertical space steps of the &quot;mesoscale grid&quot;</span></div>
<div class="line"><a id="l00744" name="l00744"></a><span class="lineno">  744</span> </div>
<div class="line"><a id="l00745" name="l00745"></a><span class="lineno">  745</span><span class="comment">! Data interpolated from the &quot;mesoscale grid&quot; to the &quot;urban grid&quot;</span></div>
<div class="line"><a id="l00746" name="l00746"></a><span class="lineno">  746</span> </div>
<div class="line"><a id="l00747" name="l00747"></a><span class="lineno">  747</span><span class="keywordtype">      real</span> ua_u(nz_um)          <span class="comment">! Wind speed in the x direction</span></div>
<div class="line"><a id="l00748" name="l00748"></a><span class="lineno">  748</span><span class="keywordtype">      real</span> va_u(nz_um)          <span class="comment">! Wind speed in the y direction</span></div>
<div class="line"><a id="l00749" name="l00749"></a><span class="lineno">  749</span><span class="keywordtype">      real</span> pt_u(nz_um)          <span class="comment">! Potential temperature</span></div>
<div class="line"><a id="l00750" name="l00750"></a><span class="lineno">  750</span><span class="keywordtype">      real</span> da_u(nz_um)          <span class="comment">! Air density</span></div>
<div class="line"><a id="l00751" name="l00751"></a><span class="lineno">  751</span><span class="keywordtype">      real</span> pt0_u(nz_um)         <span class="comment">! Reference potential temperature</span></div>
<div class="line"><a id="l00752" name="l00752"></a><span class="lineno">  752</span><span class="keywordtype">      real</span> pr_u(nz_um)          <span class="comment">! Air pressure</span></div>
<div class="line"><a id="l00753" name="l00753"></a><span class="lineno">  753</span> </div>
<div class="line"><a id="l00754" name="l00754"></a><span class="lineno">  754</span><span class="comment">! Solar radiation at each level of the &quot;urban grid&quot;</span></div>
<div class="line"><a id="l00755" name="l00755"></a><span class="lineno">  755</span> </div>
<div class="line"><a id="l00756" name="l00756"></a><span class="lineno">  756</span><span class="keywordtype">      real</span> rsg(ndm)             <span class="comment">! Short wave radiation from the ground</span></div>
<div class="line"><a id="l00757" name="l00757"></a><span class="lineno">  757</span><span class="keywordtype">      real</span> rsw(2*ndm,nz_um)     <span class="comment">! Short wave radiation from the walls</span></div>
<div class="line"><a id="l00758" name="l00758"></a><span class="lineno">  758</span><span class="keywordtype">      real</span> rlg(ndm)             <span class="comment">! Long wave radiation from the ground</span></div>
<div class="line"><a id="l00759" name="l00759"></a><span class="lineno">  759</span><span class="keywordtype">      real</span> rlw(2*ndm,nz_um)     <span class="comment">! Long wave radiation from the walls</span></div>
<div class="line"><a id="l00760" name="l00760"></a><span class="lineno">  760</span> </div>
<div class="line"><a id="l00761" name="l00761"></a><span class="lineno">  761</span><span class="comment">! Potential temperature of the surfaces at each level of the &quot;urban grid&quot;</span></div>
<div class="line"><a id="l00762" name="l00762"></a><span class="lineno">  762</span> </div>
<div class="line"><a id="l00763" name="l00763"></a><span class="lineno">  763</span><span class="keywordtype">      real</span> ptg(ndm)             <span class="comment">! Ground potential temperatures </span></div>
<div class="line"><a id="l00764" name="l00764"></a><span class="lineno">  764</span><span class="keywordtype">      real</span> ptr(ndm,nz_um)     <span class="comment">! Roof potential temperatures </span></div>
<div class="line"><a id="l00765" name="l00765"></a><span class="lineno">  765</span><span class="keywordtype">      real</span> ptw(2*ndm,nz_um)     <span class="comment">! Walls potential temperatures </span></div>
<div class="line"><a id="l00766" name="l00766"></a><span class="lineno">  766</span> </div>
<div class="line"><a id="l00767" name="l00767"></a><span class="lineno">  767</span> </div>
<div class="line"><a id="l00768" name="l00768"></a><span class="lineno">  768</span><span class="comment">! Explicit and implicit component of the momentum, temperature and TKE sources or sinks on</span></div>
<div class="line"><a id="l00769" name="l00769"></a><span class="lineno">  769</span><span class="comment">!  vertical surfaces (walls) ans horizontal surfaces (roofs and street)</span></div>
<div class="line"><a id="l00770" name="l00770"></a><span class="lineno">  770</span><span class="comment">! The fluxes can be computed as follow: Fluxes of X = A*X + B</span></div>
<div class="line"><a id="l00771" name="l00771"></a><span class="lineno">  771</span><span class="comment">!  Example: Momentum fluxes on vertical surfaces = uva_u * ua_u + uvb_u</span></div>
<div class="line"><a id="l00772" name="l00772"></a><span class="lineno">  772</span> </div>
<div class="line"><a id="l00773" name="l00773"></a><span class="lineno">  773</span><span class="keywordtype">      real</span> uhb_u(ndm,nz_um)   <span class="comment">! U (wind component) Horizontal surfaces, B (explicit) term</span></div>
<div class="line"><a id="l00774" name="l00774"></a><span class="lineno">  774</span><span class="keywordtype">      real</span> uva_u(2*ndm,nz_um)   <span class="comment">! U (wind component)   Vertical surfaces, A (implicit) term</span></div>
<div class="line"><a id="l00775" name="l00775"></a><span class="lineno">  775</span><span class="keywordtype">      real</span> uvb_u(2*ndm,nz_um)   <span class="comment">! U (wind component)   Vertical surfaces, B (explicit) term</span></div>
<div class="line"><a id="l00776" name="l00776"></a><span class="lineno">  776</span><span class="keywordtype">      real</span> vhb_u(ndm,nz_um)   <span class="comment">! V (wind component) Horizontal surfaces, B (explicit) term</span></div>
<div class="line"><a id="l00777" name="l00777"></a><span class="lineno">  777</span><span class="keywordtype">      real</span> vva_u(2*ndm,nz_um)   <span class="comment">! V (wind component)   Vertical surfaces, A (implicit) term</span></div>
<div class="line"><a id="l00778" name="l00778"></a><span class="lineno">  778</span><span class="keywordtype">      real</span> vvb_u(2*ndm,nz_um)   <span class="comment">! V (wind component)   Vertical surfaces, B (explicit) term</span></div>
<div class="line"><a id="l00779" name="l00779"></a><span class="lineno">  779</span><span class="keywordtype">      real</span> thb_u(ndm,nz_um)   <span class="comment">! Temperature        Horizontal surfaces, B (explicit) term</span></div>
<div class="line"><a id="l00780" name="l00780"></a><span class="lineno">  780</span><span class="keywordtype">      real</span> tva_u(2*ndm,nz_um)   <span class="comment">! Temperature          Vertical surfaces, A (implicit) term</span></div>
<div class="line"><a id="l00781" name="l00781"></a><span class="lineno">  781</span><span class="keywordtype">      real</span> tvb_u(2*ndm,nz_um)   <span class="comment">! Temperature          Vertical surfaces, B (explicit) term</span></div>
<div class="line"><a id="l00782" name="l00782"></a><span class="lineno">  782</span><span class="keywordtype">      real</span> ehb_u(ndm,nz_um)   <span class="comment">! Energy (TKE)       Horizontal surfaces, B (explicit) term</span></div>
<div class="line"><a id="l00783" name="l00783"></a><span class="lineno">  783</span><span class="keywordtype">      real</span> evb_u(2*ndm,nz_um)   <span class="comment">! Energy (TKE)         Vertical surfaces, B (explicit) term</span></div>
<div class="line"><a id="l00784" name="l00784"></a><span class="lineno">  784</span>      </div>
<div class="line"><a id="l00785" name="l00785"></a><span class="lineno">  785</span><span class="comment">!</span></div>
<div class="line"><a id="l00786" name="l00786"></a><span class="lineno">  786</span><span class="keywordtype">      real</span> rs_abs <span class="comment">! solar radiation absorbed by urban surfaces </span></div>
<div class="line"><a id="l00787" name="l00787"></a><span class="lineno">  787</span><span class="keywordtype">      real</span> rl_up <span class="comment">! longwave radiation emitted by urban surface to the atmosphere </span></div>
<div class="line"><a id="l00788" name="l00788"></a><span class="lineno">  788</span><span class="keywordtype">      real</span> emiss <span class="comment">! mean emissivity of the urban surface</span></div>
<div class="line"><a id="l00789" name="l00789"></a><span class="lineno">  789</span><span class="keywordtype">      real</span> grdflx_urb <span class="comment">! ground heat flux</span></div>
<div class="line"><a id="l00790" name="l00790"></a><span class="lineno">  790</span>      <span class="keywordtype">integer</span> iz,id</div>
<div class="line"><a id="l00791" name="l00791"></a><span class="lineno">  791</span>      <span class="keywordtype">integer</span> iw,ix,iy</div>
<div class="line"><a id="l00792" name="l00792"></a><span class="lineno">  792</span> </div>
<div class="line"><a id="l00793" name="l00793"></a><span class="lineno">  793</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00794" name="l00794"></a><span class="lineno">  794</span><span class="comment">! END VARIABLES DEFINITIONS</span></div>
<div class="line"><a id="l00795" name="l00795"></a><span class="lineno">  795</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00796" name="l00796"></a><span class="lineno">  796</span> </div>
<div class="line"><a id="l00797" name="l00797"></a><span class="lineno">  797</span><span class="comment">! Fix some usefull parameters for the computation of the sources or sinks</span></div>
<div class="line"><a id="l00798" name="l00798"></a><span class="lineno">  798</span> </div>
<div class="line"><a id="l00799" name="l00799"></a><span class="lineno">  799</span>      <span class="keywordflow">do</span> iz=kts,kte</div>
<div class="line"><a id="l00800" name="l00800"></a><span class="lineno">  800</span>         dz(iz)=z(iz+1)-z(iz)</div>
<div class="line"><a id="l00801" name="l00801"></a><span class="lineno">  801</span><span class="keywordflow">      end do</span></div>
<div class="line"><a id="l00802" name="l00802"></a><span class="lineno">  802</span> </div>
<div class="line"><a id="l00803" name="l00803"></a><span class="lineno">  803</span><span class="comment">! Interpolation on the &quot;urban grid&quot;</span></div>
<div class="line"><a id="l00804" name="l00804"></a><span class="lineno">  804</span>      <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a05f8a759b52266ba041fde12cecc7962">interpol</a>(kms,kme,kts,kte,nzu,z,z_u,ua,ua_u)</div>
<div class="line"><a id="l00805" name="l00805"></a><span class="lineno">  805</span>      <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a05f8a759b52266ba041fde12cecc7962">interpol</a>(kms,kme,kts,kte,nzu,z,z_u,va,va_u)</div>
<div class="line"><a id="l00806" name="l00806"></a><span class="lineno">  806</span>      <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a05f8a759b52266ba041fde12cecc7962">interpol</a>(kms,kme,kts,kte,nzu,z,z_u,pt,pt_u)</div>
<div class="line"><a id="l00807" name="l00807"></a><span class="lineno">  807</span>      <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a05f8a759b52266ba041fde12cecc7962">interpol</a>(kms,kme,kts,kte,nzu,z,z_u,pt0,pt0_u)</div>
<div class="line"><a id="l00808" name="l00808"></a><span class="lineno">  808</span>      <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a05f8a759b52266ba041fde12cecc7962">interpol</a>(kms,kme,kts,kte,nzu,z,z_u,pr,pr_u)</div>
<div class="line"><a id="l00809" name="l00809"></a><span class="lineno">  809</span>      <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a05f8a759b52266ba041fde12cecc7962">interpol</a>(kms,kme,kts,kte,nzu,z,z_u,da,da_u)</div>
<div class="line"><a id="l00810" name="l00810"></a><span class="lineno">  810</span> </div>
<div class="line"><a id="l00811" name="l00811"></a><span class="lineno">  811</span>                   </div>
<div class="line"><a id="l00812" name="l00812"></a><span class="lineno">  812</span><span class="comment">! Compute the modification of the radiation due to the buildings</span></div>
<div class="line"><a id="l00813" name="l00813"></a><span class="lineno">  813</span> </div>
<div class="line"><a id="l00814" name="l00814"></a><span class="lineno">  814</span>      <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a646e15d96f3e4929948bbb9babe74044">modif_rad</a>(iurb,ndu,nzu,z_u,ws,               &amp;</div>
<div class="line"><a id="l00815" name="l00815"></a><span class="lineno">  815</span>                    drst,strd,ss,pb,                    &amp;</div>
<div class="line"><a id="l00816" name="l00816"></a><span class="lineno">  816</span>                    tw,tg,albg,albw,emw,emg,            &amp;</div>
<div class="line"><a id="l00817" name="l00817"></a><span class="lineno">  817</span>                    fww,fwg,fgw,fsw,fsg,                &amp;</div>
<div class="line"><a id="l00818" name="l00818"></a><span class="lineno">  818</span>                    zr,deltar,ah,                       &amp;</div>
<div class="line"><a id="l00819" name="l00819"></a><span class="lineno">  819</span>                    rs,rld,rsw,rsg,rlw,rlg)                       </div>
<div class="line"><a id="l00820" name="l00820"></a><span class="lineno">  820</span> </div>
<div class="line"><a id="l00821" name="l00821"></a><span class="lineno">  821</span><span class="comment">! calculation of the urban albedo and the upward long wave radiation</span></div>
<div class="line"><a id="l00822" name="l00822"></a><span class="lineno">  822</span>       </div>
<div class="line"><a id="l00823" name="l00823"></a><span class="lineno">  823</span>       <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a996c8ba8d9641d03e68ae303c9470ff8">upward_rad</a>(ndu,nzu,ws,bs,                   &amp;</div>
<div class="line"><a id="l00824" name="l00824"></a><span class="lineno">  824</span>                       <a class="code hl_variable" href="namespacemodule__sf__bep.html#a14b87836842c0cf3cccb0b78fde9b2b0">sigma</a>,pb,ss,                     &amp;</div>
<div class="line"><a id="l00825" name="l00825"></a><span class="lineno">  825</span>                       tg,emg,albg,rlg,rsg,sfg,         &amp; </div>
<div class="line"><a id="l00826" name="l00826"></a><span class="lineno">  826</span>                       tw,emw,albw,rlw,rsw,sfw,         &amp; </div>
<div class="line"><a id="l00827" name="l00827"></a><span class="lineno">  827</span>                       tr,emr,albr,rld,rs,sfr,          &amp; </div>
<div class="line"><a id="l00828" name="l00828"></a><span class="lineno">  828</span>                       rs_abs,rl_up,emiss,grdflx_urb)               </div>
<div class="line"><a id="l00829" name="l00829"></a><span class="lineno">  829</span>        </div>
<div class="line"><a id="l00830" name="l00830"></a><span class="lineno">  830</span><span class="comment">! Compute the surface temperatures</span></div>
<div class="line"><a id="l00831" name="l00831"></a><span class="lineno">  831</span>     </div>
<div class="line"><a id="l00832" name="l00832"></a><span class="lineno">  832</span> </div>
<div class="line"><a id="l00833" name="l00833"></a><span class="lineno">  833</span>      <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a6c06d5d98aed63db0cb89c197392c812">surf_temp</a>(nzu,ndu,pr_u,dt,ss,                &amp; </div>
<div class="line"><a id="l00834" name="l00834"></a><span class="lineno">  834</span>                    rs,rld,rsg,rlg,rsw,rlw,             &amp;</div>
<div class="line"><a id="l00835" name="l00835"></a><span class="lineno">  835</span>                    tg,alag,csg,emg,albg,ptg,sfg,gfg,   &amp;</div>
<div class="line"><a id="l00836" name="l00836"></a><span class="lineno">  836</span>                    tr,alar,csr,emr,albr,ptr,sfr,gfr,   &amp;</div>
<div class="line"><a id="l00837" name="l00837"></a><span class="lineno">  837</span>                    tw,alaw,csw,emw,albw,ptw,sfw,gfw)  </div>
<div class="line"><a id="l00838" name="l00838"></a><span class="lineno">  838</span>      </div>
<div class="line"><a id="l00839" name="l00839"></a><span class="lineno">  839</span>      </div>
<div class="line"><a id="l00840" name="l00840"></a><span class="lineno">  840</span><span class="comment">! Compute the implicit and explicit components of the sources or sinks on the &quot;urban grid&quot;</span></div>
<div class="line"><a id="l00841" name="l00841"></a><span class="lineno">  841</span>       </div>
<div class="line"><a id="l00842" name="l00842"></a><span class="lineno">  842</span>      <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a873560a1932723dc6c6a6e31bebd91af">buildings</a>(ndu,nzu,z0,ua_u,va_u,                       &amp; </div>
<div class="line"><a id="l00843" name="l00843"></a><span class="lineno">  843</span>                     pt_u,pt0_u,ptg,ptr,da_u,ptw,drst,           &amp;                      </div>
<div class="line"><a id="l00844" name="l00844"></a><span class="lineno">  844</span>                     uva_u,vva_u,uvb_u,vvb_u,tva_u,tvb_u,evb_u,  &amp; </div>
<div class="line"><a id="l00845" name="l00845"></a><span class="lineno">  845</span>                     uhb_u,vhb_u,thb_u,ehb_u,ss,dt)                        </div>
<div class="line"><a id="l00846" name="l00846"></a><span class="lineno">  846</span> </div>
<div class="line"><a id="l00847" name="l00847"></a><span class="lineno">  847</span>         </div>
<div class="line"><a id="l00848" name="l00848"></a><span class="lineno">  848</span><span class="comment">! Calculation of the sensible heat fluxes for the ground, the wall and roof</span></div>
<div class="line"><a id="l00849" name="l00849"></a><span class="lineno">  849</span><span class="comment">! Sensible Heat Flux = density * Cp_U * ( A* potential temperature + B )</span></div>
<div class="line"><a id="l00850" name="l00850"></a><span class="lineno">  850</span><span class="comment">! where A and B are the implicit and explicit components of the heat sources or sinks.</span></div>
<div class="line"><a id="l00851" name="l00851"></a><span class="lineno">  851</span><span class="comment">!  </span></div>
<div class="line"><a id="l00852" name="l00852"></a><span class="lineno">  852</span><span class="comment">! </span></div>
<div class="line"><a id="l00853" name="l00853"></a><span class="lineno">  853</span> </div>
<div class="line"><a id="l00854" name="l00854"></a><span class="lineno">  854</span>      <span class="keywordflow">do</span> id=1,ndu         </div>
<div class="line"><a id="l00855" name="l00855"></a><span class="lineno">  855</span>         sfg(id)=-da_u(1)*<a class="code hl_variable" href="namespacemodule__sf__bep.html#ae322728a3b7be919f956d83fcfbcc60a">cp_u</a>*thb_u(id,1)</div>
<div class="line"><a id="l00856" name="l00856"></a><span class="lineno">  856</span>         <span class="keywordflow">do</span> iz=2,nzu</div>
<div class="line"><a id="l00857" name="l00857"></a><span class="lineno">  857</span>            sfr(id,iz)=-da_u(iz)*<a class="code hl_variable" href="namespacemodule__sf__bep.html#ae322728a3b7be919f956d83fcfbcc60a">cp_u</a>*thb_u(id,iz)</div>
<div class="line"><a id="l00858" name="l00858"></a><span class="lineno">  858</span><span class="keywordflow">         enddo</span></div>
<div class="line"><a id="l00859" name="l00859"></a><span class="lineno">  859</span>         </div>
<div class="line"><a id="l00860" name="l00860"></a><span class="lineno">  860</span>         <span class="keywordflow">do</span> iz=1,nzu</div>
<div class="line"><a id="l00861" name="l00861"></a><span class="lineno">  861</span>            sfw(2*id-1,iz)=-da_u(iz)*<a class="code hl_variable" href="namespacemodule__sf__bep.html#ae322728a3b7be919f956d83fcfbcc60a">cp_u</a>*(tvb_u(2*id-1,iz)+     &amp;</div>
<div class="line"><a id="l00862" name="l00862"></a><span class="lineno">  862</span>                tva_u(2*id-1,iz)*pt_u(iz))</div>
<div class="line"><a id="l00863" name="l00863"></a><span class="lineno">  863</span>            sfw(2*id,iz)=-da_u(iz)*<a class="code hl_variable" href="namespacemodule__sf__bep.html#ae322728a3b7be919f956d83fcfbcc60a">cp_u</a>*(tvb_u(2*id,iz)+         &amp;</div>
<div class="line"><a id="l00864" name="l00864"></a><span class="lineno">  864</span>                tva_u(2*id,iz)*pt_u(iz)) </div>
<div class="line"><a id="l00865" name="l00865"></a><span class="lineno">  865</span><span class="keywordflow">         enddo</span></div>
<div class="line"><a id="l00866" name="l00866"></a><span class="lineno">  866</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l00867" name="l00867"></a><span class="lineno">  867</span>      </div>
<div class="line"><a id="l00868" name="l00868"></a><span class="lineno">  868</span><span class="comment">! calculation of the urban albedo and the upward long wave radiation</span></div>
<div class="line"><a id="l00869" name="l00869"></a><span class="lineno">  869</span>          </div>
<div class="line"><a id="l00870" name="l00870"></a><span class="lineno">  870</span><span class="comment">!!       call upward_rad(ndu,nzu,ws,bs,                      &amp;</span></div>
<div class="line"><a id="l00871" name="l00871"></a><span class="lineno">  871</span><span class="comment">!!                       sigma,pb,ss,                        &amp;</span></div>
<div class="line"><a id="l00872" name="l00872"></a><span class="lineno">  872</span><span class="comment">!!                       tg,emg,albg,rlg,rsg,sfg,            &amp; </span></div>
<div class="line"><a id="l00873" name="l00873"></a><span class="lineno">  873</span><span class="comment">!!                       tw,emw,albw,rlw,rsw,sfw,            &amp; </span></div>
<div class="line"><a id="l00874" name="l00874"></a><span class="lineno">  874</span><span class="comment">!!                       tr,emr,albr,rld,rs,sfr,             &amp; </span></div>
<div class="line"><a id="l00875" name="l00875"></a><span class="lineno">  875</span><span class="comment">!!                       rs_abs,rl_up,emiss,grdflx_urb)             </span></div>
<div class="line"><a id="l00876" name="l00876"></a><span class="lineno">  876</span> </div>
<div class="line"><a id="l00877" name="l00877"></a><span class="lineno">  877</span><span class="comment">! Interpolation on the &quot;mesoscale grid&quot;</span></div>
<div class="line"><a id="l00878" name="l00878"></a><span class="lineno">  878</span> </div>
<div class="line"><a id="l00879" name="l00879"></a><span class="lineno">  879</span>      <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a279edcc0de78c52ec1a201aa9996e23f">urban_meso</a>(ndu,kms,kme,kts,kte,nzu,z,dz,z_u,pb,ss,bs,ws,sf, &amp; </div>
<div class="line"><a id="l00880" name="l00880"></a><span class="lineno">  880</span>                     vl,uva_u,vva_u,uvb_u,vvb_u,tva_u,tvb_u,evb_u,     &amp;</div>
<div class="line"><a id="l00881" name="l00881"></a><span class="lineno">  881</span>                     uhb_u,vhb_u,thb_u,ehb_u,                          &amp;</div>
<div class="line"><a id="l00882" name="l00882"></a><span class="lineno">  882</span>                     a_u,a_v,a_t,a_e,b_u,b_v,b_t,b_e)                    </div>
<div class="line"><a id="l00883" name="l00883"></a><span class="lineno">  883</span>       </div>
<div class="line"><a id="l00884" name="l00884"></a><span class="lineno">  884</span> </div>
<div class="line"><a id="l00885" name="l00885"></a><span class="lineno">  885</span><span class="comment">! computation of the mean road temperature tsk (this value could be used </span></div>
<div class="line"><a id="l00886" name="l00886"></a><span class="lineno">  886</span><span class="comment">! to replace the surface temperature in the radiation routines, if needed).</span></div>
<div class="line"><a id="l00887" name="l00887"></a><span class="lineno">  887</span> </div>
<div class="line"><a id="l00888" name="l00888"></a><span class="lineno">  888</span><span class="comment">! Calculation of the length scale taking into account the buildings effects</span></div>
<div class="line"><a id="l00889" name="l00889"></a><span class="lineno">  889</span> </div>
<div class="line"><a id="l00890" name="l00890"></a><span class="lineno">  890</span>      <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#ab4c5155d2e31a1453a93508d2b63de18">interp_length</a>(ndu,kms,kme,kts,kte,nzu,z_u,z,ss,ws,bs,dlg,dl_u)</div>
<div class="line"><a id="l00891" name="l00891"></a><span class="lineno">  891</span> </div>
<div class="line"><a id="l00892" name="l00892"></a><span class="lineno">  892</span>      <span class="keywordflow">return</span></div>
<div class="line"><a id="l00893" name="l00893"></a><span class="lineno">  893</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a82297fd79f7a6627963d8b172f2a9c56">bep1d</a></div>
<div class="line"><a id="l00894" name="l00894"></a><span class="lineno">  894</span> </div>
<div class="line"><a id="l00895" name="l00895"></a><span class="lineno">  895</span><span class="comment">! ===6=8===============================================================72</span></div>
<div class="line"><a id="l00896" name="l00896"></a><span class="lineno">  896</span><span class="comment">! ===6=8===============================================================72</span></div>
<div class="line"><a id="l00897" name="l00897"></a><span class="lineno">  897</span> </div>
<div class="line"><a id="l00898" name="l00898"></a><span class="lineno"><a class="line" href="namespacemodule__sf__bep.html#a851f0f918177ac23c73ff631fd96683a">  898</a></span>       <span class="keyword">subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a851f0f918177ac23c73ff631fd96683a">param</a>(iurb,nzu,nzurb,nzurban,ndu,                   &amp;</div>
<div class="line"><a id="l00899" name="l00899"></a><span class="lineno">  899</span>                       csg_u,csg,alag_u,alag,csr_u,csr,               &amp;</div>
<div class="line"><a id="l00900" name="l00900"></a><span class="lineno">  900</span>                       alar_u,alar,csw_u,csw,alaw_u,alaw,             &amp;</div>
<div class="line"><a id="l00901" name="l00901"></a><span class="lineno">  901</span>                       ws_u,ws,bs_u,bs,z0g_u,z0r_u,z0,                &amp;  </div>
<div class="line"><a id="l00902" name="l00902"></a><span class="lineno">  902</span>                       strd_u,strd,drst_u,drst,ss_u,ss_urb,ss,pb_u,   &amp;</div>
<div class="line"><a id="l00903" name="l00903"></a><span class="lineno">  903</span>                       pb_urb,pb,lp_urb,lb_urb,hgt_urb,frc_urb)        </div>
<div class="line"><a id="l00904" name="l00904"></a><span class="lineno">  904</span> </div>
<div class="line"><a id="l00905" name="l00905"></a><span class="lineno">  905</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00906" name="l00906"></a><span class="lineno">  906</span><span class="comment">!    This routine prepare some usefull parameters       </span></div>
<div class="line"><a id="l00907" name="l00907"></a><span class="lineno">  907</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00908" name="l00908"></a><span class="lineno">  908</span> </div>
<div class="line"><a id="l00909" name="l00909"></a><span class="lineno">  909</span>      <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l00910" name="l00910"></a><span class="lineno">  910</span> </div>
<div class="line"><a id="l00911" name="l00911"></a><span class="lineno">  911</span>  </div>
<div class="line"><a id="l00912" name="l00912"></a><span class="lineno">  912</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00913" name="l00913"></a><span class="lineno">  913</span><span class="comment">! INPUT:</span></div>
<div class="line"><a id="l00914" name="l00914"></a><span class="lineno">  914</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00915" name="l00915"></a><span class="lineno">  915</span>      <span class="keywordtype">integer</span> iurb                 <span class="comment">! Current urban class</span></div>
<div class="line"><a id="l00916" name="l00916"></a><span class="lineno">  916</span>      <span class="keywordtype">integer</span> nzu                  <span class="comment">! Number of vertical urban levels in the current class</span></div>
<div class="line"><a id="l00917" name="l00917"></a><span class="lineno">  917</span>      <span class="keywordtype">integer</span> nzurb                <span class="comment">! Number of vertical urban levels in the current class</span></div>
<div class="line"><a id="l00918" name="l00918"></a><span class="lineno">  918</span>      <span class="keywordtype">integer</span> ndu                  <span class="comment">! Number of street direction for the current urban class</span></div>
<div class="line"><a id="l00919" name="l00919"></a><span class="lineno">  919</span><span class="keywordtype">      real</span> alag_u(nurbm)           <span class="comment">! Ground thermal diffusivity [m^2 s^-1]</span></div>
<div class="line"><a id="l00920" name="l00920"></a><span class="lineno">  920</span><span class="keywordtype">      real</span> alar_u(nurbm)           <span class="comment">! Roof thermal diffusivity [m^2 s^-1]</span></div>
<div class="line"><a id="l00921" name="l00921"></a><span class="lineno">  921</span><span class="keywordtype">      real</span> alaw_u(nurbm)           <span class="comment">! Wall thermal diffusivity [m^2 s^-1]</span></div>
<div class="line"><a id="l00922" name="l00922"></a><span class="lineno">  922</span><span class="keywordtype">      real</span> bs_u(ndm,nurbm)         <span class="comment">! Building width</span></div>
<div class="line"><a id="l00923" name="l00923"></a><span class="lineno">  923</span><span class="keywordtype">      real</span> csg_u(nurbm)            <span class="comment">! Specific heat of the ground material [J m^3 K^-1]</span></div>
<div class="line"><a id="l00924" name="l00924"></a><span class="lineno">  924</span><span class="keywordtype">      real</span> csr_u(nurbm)            <span class="comment">! Specific heat of the roof material [J m^3 K^-1]</span></div>
<div class="line"><a id="l00925" name="l00925"></a><span class="lineno">  925</span><span class="keywordtype">      real</span> csw_u(nurbm)            <span class="comment">! Specific heat of the wall material [J m^3 K^-1]</span></div>
<div class="line"><a id="l00926" name="l00926"></a><span class="lineno">  926</span><span class="keywordtype">      real</span> drst_u(ndm,nurbm)       <span class="comment">! Street direction</span></div>
<div class="line"><a id="l00927" name="l00927"></a><span class="lineno">  927</span><span class="keywordtype">      real</span> strd_u(ndm,nurbm)       <span class="comment">! Street length </span></div>
<div class="line"><a id="l00928" name="l00928"></a><span class="lineno">  928</span><span class="keywordtype">      real</span> ws_u(ndm,nurbm)         <span class="comment">! Street width</span></div>
<div class="line"><a id="l00929" name="l00929"></a><span class="lineno">  929</span><span class="keywordtype">      real</span> z0g_u(nurbm)            <span class="comment">! The ground&#39;s roughness length</span></div>
<div class="line"><a id="l00930" name="l00930"></a><span class="lineno">  930</span><span class="keywordtype">      real</span> z0r_u(nurbm)            <span class="comment">! The roof&#39;s roughness length</span></div>
<div class="line"><a id="l00931" name="l00931"></a><span class="lineno">  931</span><span class="keywordtype">      real</span> ss_u(nz_um,nurbm)     <span class="comment">! The probability that a building has an height equal to &quot;z&quot;</span></div>
<div class="line"><a id="l00932" name="l00932"></a><span class="lineno">  932</span><span class="keywordtype">      real</span> pb_u(nz_um,nurbm)     <span class="comment">! The probability that a building has an height greater or equal to &quot;z&quot;</span></div>
<div class="line"><a id="l00933" name="l00933"></a><span class="lineno">  933</span><span class="keywordtype">      real</span> ss_urb(nz_um)     <span class="comment">! The probability that a building has an height equal to &quot;z&quot;</span></div>
<div class="line"><a id="l00934" name="l00934"></a><span class="lineno">  934</span><span class="keywordtype">      real</span> pb_urb(nz_um)     <span class="comment">! The probability that a building has an height greater or equal to &quot;z&quot;</span></div>
<div class="line"><a id="l00935" name="l00935"></a><span class="lineno">  935</span><span class="keywordtype">      real</span> lp_urb                <span class="comment">! Building plan area density</span></div>
<div class="line"><a id="l00936" name="l00936"></a><span class="lineno">  936</span><span class="keywordtype">      real</span> lb_urb                <span class="comment">! Building surface area to plan area ratio</span></div>
<div class="line"><a id="l00937" name="l00937"></a><span class="lineno">  937</span><span class="keywordtype">      real</span> hgt_urb               <span class="comment">! Average building height weighted by building plan area [m]</span></div>
<div class="line"><a id="l00938" name="l00938"></a><span class="lineno">  938</span><span class="keywordtype">      real</span> frc_urb               <span class="comment">! Urban fraction</span></div>
<div class="line"><a id="l00939" name="l00939"></a><span class="lineno">  939</span>     </div>
<div class="line"><a id="l00940" name="l00940"></a><span class="lineno">  940</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00941" name="l00941"></a><span class="lineno">  941</span><span class="comment">! OUTPUT:</span></div>
<div class="line"><a id="l00942" name="l00942"></a><span class="lineno">  942</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00943" name="l00943"></a><span class="lineno">  943</span><span class="keywordtype">      real</span> alag(ng_u)           <span class="comment">! Ground thermal diffusivity at each ground levels</span></div>
<div class="line"><a id="l00944" name="l00944"></a><span class="lineno">  944</span><span class="keywordtype">      real</span> alar(nwr_u)           <span class="comment">! Roof thermal diffusivity at each roof levels</span></div>
<div class="line"><a id="l00945" name="l00945"></a><span class="lineno">  945</span><span class="keywordtype">      real</span> alaw(nwr_u)           <span class="comment">! Wall thermal diffusivity at each wall levels</span></div>
<div class="line"><a id="l00946" name="l00946"></a><span class="lineno">  946</span><span class="keywordtype">      real</span> csg(ng_u)            <span class="comment">! Specific heat of the ground material at each ground levels</span></div>
<div class="line"><a id="l00947" name="l00947"></a><span class="lineno">  947</span><span class="keywordtype">      real</span> csr(nwr_u)            <span class="comment">! Specific heat of the roof material at each roof levels</span></div>
<div class="line"><a id="l00948" name="l00948"></a><span class="lineno">  948</span><span class="keywordtype">      real</span> csw(nwr_u)            <span class="comment">! Specific heat of the wall material at each wall levels</span></div>
<div class="line"><a id="l00949" name="l00949"></a><span class="lineno">  949</span><span class="keywordtype">      real</span> bs(ndm)              <span class="comment">! Building width for the current urban class</span></div>
<div class="line"><a id="l00950" name="l00950"></a><span class="lineno">  950</span><span class="keywordtype">      real</span> drst(ndm)            <span class="comment">! street directions for the current urban class</span></div>
<div class="line"><a id="l00951" name="l00951"></a><span class="lineno">  951</span><span class="keywordtype">      real</span> strd(ndm)            <span class="comment">! Street lengths for the current urban class</span></div>
<div class="line"><a id="l00952" name="l00952"></a><span class="lineno">  952</span><span class="keywordtype">      real</span> ws(ndm)              <span class="comment">! Street widths of the current urban class</span></div>
<div class="line"><a id="l00953" name="l00953"></a><span class="lineno">  953</span><span class="keywordtype">      real</span> z0(ndm,nz_um)      <span class="comment">! Roughness lengths &quot;profiles&quot;</span></div>
<div class="line"><a id="l00954" name="l00954"></a><span class="lineno">  954</span><span class="keywordtype">      real</span> ss(nz_um)          <span class="comment">! Probability to have a building with height h</span></div>
<div class="line"><a id="l00955" name="l00955"></a><span class="lineno">  955</span><span class="keywordtype">      real</span> pb(nz_um)          <span class="comment">! Probability to have a building with an height equal</span></div>
<div class="line"><a id="l00956" name="l00956"></a><span class="lineno">  956</span>      <span class="keywordtype">integer</span> nzurban</div>
<div class="line"><a id="l00957" name="l00957"></a><span class="lineno">  957</span> </div>
<div class="line"><a id="l00958" name="l00958"></a><span class="lineno">  958</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00959" name="l00959"></a><span class="lineno">  959</span><span class="comment">! LOCAL:</span></div>
<div class="line"><a id="l00960" name="l00960"></a><span class="lineno">  960</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00961" name="l00961"></a><span class="lineno">  961</span>      <span class="keywordtype">integer</span> id,ig,ir,iw,iz,ihu</div>
<div class="line"><a id="l00962" name="l00962"></a><span class="lineno">  962</span> </div>
<div class="line"><a id="l00963" name="l00963"></a><span class="lineno">  963</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l00964" name="l00964"></a><span class="lineno">  964</span><span class="comment">! END VARIABLES DEFINITIONS</span></div>
<div class="line"><a id="l00965" name="l00965"></a><span class="lineno">  965</span><span class="comment">! ----------------------------------------------------------------------     </span></div>
<div class="line"><a id="l00966" name="l00966"></a><span class="lineno">  966</span><span class="comment">!</span></div>
<div class="line"><a id="l00967" name="l00967"></a><span class="lineno">  967</span><span class="comment">!Initialize</span></div>
<div class="line"><a id="l00968" name="l00968"></a><span class="lineno">  968</span><span class="comment">!</span></div>
<div class="line"><a id="l00969" name="l00969"></a><span class="lineno">  969</span>      ss=0.</div>
<div class="line"><a id="l00970" name="l00970"></a><span class="lineno">  970</span>      pb=0.</div>
<div class="line"><a id="l00971" name="l00971"></a><span class="lineno">  971</span>      csg=0.</div>
<div class="line"><a id="l00972" name="l00972"></a><span class="lineno">  972</span>      alag=0.</div>
<div class="line"><a id="l00973" name="l00973"></a><span class="lineno">  973</span>      csr=0.</div>
<div class="line"><a id="l00974" name="l00974"></a><span class="lineno">  974</span>      alar=0.</div>
<div class="line"><a id="l00975" name="l00975"></a><span class="lineno">  975</span>      csw=0.</div>
<div class="line"><a id="l00976" name="l00976"></a><span class="lineno">  976</span>      alaw=0.</div>
<div class="line"><a id="l00977" name="l00977"></a><span class="lineno">  977</span>      z0=0.</div>
<div class="line"><a id="l00978" name="l00978"></a><span class="lineno">  978</span>      ws=0.</div>
<div class="line"><a id="l00979" name="l00979"></a><span class="lineno">  979</span>      bs=0.</div>
<div class="line"><a id="l00980" name="l00980"></a><span class="lineno">  980</span>      strd=0.</div>
<div class="line"><a id="l00981" name="l00981"></a><span class="lineno">  981</span>      drst=0.</div>
<div class="line"><a id="l00982" name="l00982"></a><span class="lineno">  982</span>      nzurban=0</div>
<div class="line"><a id="l00983" name="l00983"></a><span class="lineno">  983</span>      </div>
<div class="line"><a id="l00984" name="l00984"></a><span class="lineno">  984</span>      ihu=0</div>
<div class="line"><a id="l00985" name="l00985"></a><span class="lineno">  985</span> </div>
<div class="line"><a id="l00986" name="l00986"></a><span class="lineno">  986</span>       <span class="keywordflow">do</span> iz=1,nz_um</div>
<div class="line"><a id="l00987" name="l00987"></a><span class="lineno">  987</span>          <span class="keywordflow">if</span> (ss_urb(iz)/=0.) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00988" name="l00988"></a><span class="lineno">  988</span>             ihu=1</div>
<div class="line"><a id="l00989" name="l00989"></a><span class="lineno">  989</span>             <span class="keywordflow">exit</span></div>
<div class="line"><a id="l00990" name="l00990"></a><span class="lineno">  990</span>          <span class="keywordflow">else</span></div>
<div class="line"><a id="l00991" name="l00991"></a><span class="lineno">  991</span>             <span class="keywordflow">continue</span></div>
<div class="line"><a id="l00992" name="l00992"></a><span class="lineno">  992</span><span class="keywordflow">          endif</span></div>
<div class="line"><a id="l00993" name="l00993"></a><span class="lineno">  993</span><span class="keywordflow">       enddo</span></div>
<div class="line"><a id="l00994" name="l00994"></a><span class="lineno">  994</span>           </div>
<div class="line"><a id="l00995" name="l00995"></a><span class="lineno">  995</span>       <span class="keywordflow">if</span> (ihu==1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00996" name="l00996"></a><span class="lineno">  996</span>          <span class="keywordflow">do</span> iz=1,nzurb+1</div>
<div class="line"><a id="l00997" name="l00997"></a><span class="lineno">  997</span>             ss(iz)=ss_urb(iz)</div>
<div class="line"><a id="l00998" name="l00998"></a><span class="lineno">  998</span>             pb(iz)=pb_urb(iz)</div>
<div class="line"><a id="l00999" name="l00999"></a><span class="lineno">  999</span><span class="keywordflow">          enddo</span></div>
<div class="line"><a id="l01000" name="l01000"></a><span class="lineno"> 1000</span>          nzurban=nzurb</div>
<div class="line"><a id="l01001" name="l01001"></a><span class="lineno"> 1001</span>       <span class="keywordflow">else</span></div>
<div class="line"><a id="l01002" name="l01002"></a><span class="lineno"> 1002</span>          <span class="keywordflow">do</span> iz=1,nzu+1</div>
<div class="line"><a id="l01003" name="l01003"></a><span class="lineno"> 1003</span>             ss(iz)=ss_u(iz,iurb)</div>
<div class="line"><a id="l01004" name="l01004"></a><span class="lineno"> 1004</span>             pb(iz)=pb_u(iz,iurb)</div>
<div class="line"><a id="l01005" name="l01005"></a><span class="lineno"> 1005</span><span class="keywordflow">          end do</span> </div>
<div class="line"><a id="l01006" name="l01006"></a><span class="lineno"> 1006</span>          nzurban=nzu</div>
<div class="line"><a id="l01007" name="l01007"></a><span class="lineno"> 1007</span><span class="keywordflow">       endif</span></div>
<div class="line"><a id="l01008" name="l01008"></a><span class="lineno"> 1008</span> </div>
<div class="line"><a id="l01009" name="l01009"></a><span class="lineno"> 1009</span>       <span class="keywordflow">do</span> id=1,ndu</div>
<div class="line"><a id="l01010" name="l01010"></a><span class="lineno"> 1010</span>        z0(id,1)=z0g_u(iurb)</div>
<div class="line"><a id="l01011" name="l01011"></a><span class="lineno"> 1011</span>        <span class="keywordflow">do</span> iz=2,nzurban+1</div>
<div class="line"><a id="l01012" name="l01012"></a><span class="lineno"> 1012</span>           z0(id,iz)=z0r_u(iurb)</div>
<div class="line"><a id="l01013" name="l01013"></a><span class="lineno"> 1013</span><span class="keywordflow">        enddo</span></div>
<div class="line"><a id="l01014" name="l01014"></a><span class="lineno"> 1014</span><span class="keywordflow">       enddo</span></div>
<div class="line"><a id="l01015" name="l01015"></a><span class="lineno"> 1015</span>                 </div>
<div class="line"><a id="l01016" name="l01016"></a><span class="lineno"> 1016</span>       <span class="keywordflow">do</span> ig=1,ng_u</div>
<div class="line"><a id="l01017" name="l01017"></a><span class="lineno"> 1017</span>        csg(ig)=csg_u(iurb)</div>
<div class="line"><a id="l01018" name="l01018"></a><span class="lineno"> 1018</span>        alag(ig)=alag_u(iurb)</div>
<div class="line"><a id="l01019" name="l01019"></a><span class="lineno"> 1019</span><span class="keywordflow">       enddo</span></div>
<div class="line"><a id="l01020" name="l01020"></a><span class="lineno"> 1020</span>       </div>
<div class="line"><a id="l01021" name="l01021"></a><span class="lineno"> 1021</span>       <span class="keywordflow">do</span> ir=1,nwr_u</div>
<div class="line"><a id="l01022" name="l01022"></a><span class="lineno"> 1022</span>        csr(ir)=csr_u(iurb)</div>
<div class="line"><a id="l01023" name="l01023"></a><span class="lineno"> 1023</span>        alar(ir)=alar_u(iurb)</div>
<div class="line"><a id="l01024" name="l01024"></a><span class="lineno"> 1024</span><span class="keywordflow">       enddo</span></div>
<div class="line"><a id="l01025" name="l01025"></a><span class="lineno"> 1025</span>       </div>
<div class="line"><a id="l01026" name="l01026"></a><span class="lineno"> 1026</span>       <span class="keywordflow">do</span> iw=1,nwr_u</div>
<div class="line"><a id="l01027" name="l01027"></a><span class="lineno"> 1027</span>        csw(iw)=csw_u(iurb)</div>
<div class="line"><a id="l01028" name="l01028"></a><span class="lineno"> 1028</span>        alaw(iw)=alaw_u(iurb)</div>
<div class="line"><a id="l01029" name="l01029"></a><span class="lineno"> 1029</span><span class="keywordflow">       enddo</span></div>
<div class="line"><a id="l01030" name="l01030"></a><span class="lineno"> 1030</span>      </div>
<div class="line"><a id="l01031" name="l01031"></a><span class="lineno"> 1031</span>       <span class="keywordflow">do</span> id=1,ndu</div>
<div class="line"><a id="l01032" name="l01032"></a><span class="lineno"> 1032</span>        strd(id)=strd_u(id,iurb)</div>
<div class="line"><a id="l01033" name="l01033"></a><span class="lineno"> 1033</span>        drst(id)=drst_u(id,iurb)     </div>
<div class="line"><a id="l01034" name="l01034"></a><span class="lineno"> 1034</span><span class="keywordflow">       enddo</span></div>
<div class="line"><a id="l01035" name="l01035"></a><span class="lineno"> 1035</span>    </div>
<div class="line"><a id="l01036" name="l01036"></a><span class="lineno"> 1036</span>       <span class="keywordflow">do</span> id=1,ndu</div>
<div class="line"><a id="l01037" name="l01037"></a><span class="lineno"> 1037</span>          <span class="keywordflow">if</span> ((hgt_urb&lt;=0.).OR.(lp_urb&lt;=0.).OR.(lb_urb&lt;=0.)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l01038" name="l01038"></a><span class="lineno"> 1038</span>             ws(id)=ws_u(id,iurb)</div>
<div class="line"><a id="l01039" name="l01039"></a><span class="lineno"> 1039</span>             bs(id)=bs_u(id,iurb)</div>
<div class="line"><a id="l01040" name="l01040"></a><span class="lineno"> 1040</span>          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((lp_urb/frc_urb&lt;1.).and.(lp_urb&lt;lb_urb)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l01041" name="l01041"></a><span class="lineno"> 1041</span>                  bs(id)=2.*hgt_urb*lp_urb/(lb_urb-lp_urb)</div>
<div class="line"><a id="l01042" name="l01042"></a><span class="lineno"> 1042</span>                  ws(id)=2.*hgt_urb*lp_urb*((frc_urb/lp_urb)-1.)/(lb_urb-lp_urb)</div>
<div class="line"><a id="l01043" name="l01043"></a><span class="lineno"> 1043</span>               <span class="keywordflow">else</span></div>
<div class="line"><a id="l01044" name="l01044"></a><span class="lineno"> 1044</span>                  ws(id)=ws_u(id,iurb)</div>
<div class="line"><a id="l01045" name="l01045"></a><span class="lineno"> 1045</span>                  bs(id)=bs_u(id,iurb) </div>
<div class="line"><a id="l01046" name="l01046"></a><span class="lineno"> 1046</span><span class="keywordflow">          endif</span></div>
<div class="line"><a id="l01047" name="l01047"></a><span class="lineno"> 1047</span><span class="keywordflow">       enddo</span></div>
<div class="line"><a id="l01048" name="l01048"></a><span class="lineno"> 1048</span>       <span class="keywordflow">do</span> id=1,ndu</div>
<div class="line"><a id="l01049" name="l01049"></a><span class="lineno"> 1049</span>          <span class="keywordflow">if</span> ((bs(id)&lt;=1.).OR.(bs(id)&gt;=150.)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l01050" name="l01050"></a><span class="lineno"> 1050</span><span class="comment">!            write(*,*) &#39;WARNING, WIDTH OF THE BUILDING WRONG&#39;,id,bs(id)</span></div>
<div class="line"><a id="l01051" name="l01051"></a><span class="lineno"> 1051</span><span class="comment">!            write(*,*) &#39;WIDTH OF THE STREET&#39;,id,ws(id)</span></div>
<div class="line"><a id="l01052" name="l01052"></a><span class="lineno"> 1052</span>             bs(id)=bs_u(id,iurb)</div>
<div class="line"><a id="l01053" name="l01053"></a><span class="lineno"> 1053</span>             ws(id)=ws_u(id,iurb)</div>
<div class="line"><a id="l01054" name="l01054"></a><span class="lineno"> 1054</span><span class="keywordflow">          endif</span></div>
<div class="line"><a id="l01055" name="l01055"></a><span class="lineno"> 1055</span>          <span class="keywordflow">if</span> ((ws(id)&lt;=1.).OR.(ws(id)&gt;=150.)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l01056" name="l01056"></a><span class="lineno"> 1056</span><span class="comment">!            write(*,*) &#39;WARNING, WIDTH OF THE STREET WRONG&#39;,id,ws(id)</span></div>
<div class="line"><a id="l01057" name="l01057"></a><span class="lineno"> 1057</span><span class="comment">!            write(*,*) &#39;WIDTH OF THE BUILDING&#39;,id,bs(id)</span></div>
<div class="line"><a id="l01058" name="l01058"></a><span class="lineno"> 1058</span>             bs(id)=bs_u(id,iurb)</div>
<div class="line"><a id="l01059" name="l01059"></a><span class="lineno"> 1059</span>             ws(id)=ws_u(id,iurb)</div>
<div class="line"><a id="l01060" name="l01060"></a><span class="lineno"> 1060</span><span class="keywordflow">          endif</span></div>
<div class="line"><a id="l01061" name="l01061"></a><span class="lineno"> 1061</span><span class="keywordflow">       enddo</span></div>
<div class="line"><a id="l01062" name="l01062"></a><span class="lineno"> 1062</span>       <span class="keywordflow">return</span></div>
<div class="line"><a id="l01063" name="l01063"></a><span class="lineno"> 1063</span>       <span class="keyword">end subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a851f0f918177ac23c73ff631fd96683a">param</a></div>
<div class="line"><a id="l01064" name="l01064"></a><span class="lineno"> 1064</span>       </div>
<div class="line"><a id="l01065" name="l01065"></a><span class="lineno"> 1065</span><span class="comment">! ===6=8===============================================================72</span></div>
<div class="line"><a id="l01066" name="l01066"></a><span class="lineno"> 1066</span><span class="comment">! ===6=8===============================================================72</span></div>
<div class="line"><a id="l01067" name="l01067"></a><span class="lineno"> 1067</span> </div>
<div class="line"><a id="l01068" name="l01068"></a><span class="lineno"><a class="line" href="namespacemodule__sf__bep.html#a05f8a759b52266ba041fde12cecc7962"> 1068</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a05f8a759b52266ba041fde12cecc7962">interpol</a>(kms,kme,kts,kte,nz_u,z,z_u,c,c_u)</div>
<div class="line"><a id="l01069" name="l01069"></a><span class="lineno"> 1069</span> </div>
<div class="line"><a id="l01070" name="l01070"></a><span class="lineno"> 1070</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01071" name="l01071"></a><span class="lineno"> 1071</span><span class="comment">!  This routine interpolate para</span></div>
<div class="line"><a id="l01072" name="l01072"></a><span class="lineno"> 1072</span><span class="comment">!  meters from the &quot;mesoscale grid&quot; to</span></div>
<div class="line"><a id="l01073" name="l01073"></a><span class="lineno"> 1073</span><span class="comment">!  the &quot;urban grid&quot;.</span></div>
<div class="line"><a id="l01074" name="l01074"></a><span class="lineno"> 1074</span><span class="comment">!  See p300 Appendix B.1 of the BLM paper.</span></div>
<div class="line"><a id="l01075" name="l01075"></a><span class="lineno"> 1075</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01076" name="l01076"></a><span class="lineno"> 1076</span> </div>
<div class="line"><a id="l01077" name="l01077"></a><span class="lineno"> 1077</span>      <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l01078" name="l01078"></a><span class="lineno"> 1078</span> </div>
<div class="line"><a id="l01079" name="l01079"></a><span class="lineno"> 1079</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01080" name="l01080"></a><span class="lineno"> 1080</span><span class="comment">! INPUT:</span></div>
<div class="line"><a id="l01081" name="l01081"></a><span class="lineno"> 1081</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01082" name="l01082"></a><span class="lineno"> 1082</span><span class="comment">! Data relative to the &quot;mesoscale grid&quot;</span></div>
<div class="line"><a id="l01083" name="l01083"></a><span class="lineno"> 1083</span>      <span class="keywordtype">integer</span> kts,kte,kms,kme            </div>
<div class="line"><a id="l01084" name="l01084"></a><span class="lineno"> 1084</span><span class="keywordtype">      real</span> z(kms:kme)          <span class="comment">! Altitude of the cell interface</span></div>
<div class="line"><a id="l01085" name="l01085"></a><span class="lineno"> 1085</span><span class="keywordtype">      real</span> c(kms:kme)            <span class="comment">! Parameter which has to be interpolated</span></div>
<div class="line"><a id="l01086" name="l01086"></a><span class="lineno"> 1086</span><span class="comment">! Data relative to the &quot;urban grid&quot;</span></div>
<div class="line"><a id="l01087" name="l01087"></a><span class="lineno"> 1087</span>      <span class="keywordtype">integer</span> nz_u          <span class="comment">! Number of levels</span></div>
<div class="line"><a id="l01088" name="l01088"></a><span class="lineno"> 1088</span><span class="comment">!!    real z_u(nz_u+1)      ! Altitude of the cell interface</span></div>
<div class="line"><a id="l01089" name="l01089"></a><span class="lineno"> 1089</span><span class="keywordtype">      real</span> z_u(nz_um)       <span class="comment">! Altitude of the cell interface</span></div>
<div class="line"><a id="l01090" name="l01090"></a><span class="lineno"> 1090</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01091" name="l01091"></a><span class="lineno"> 1091</span><span class="comment">! OUTPUT:</span></div>
<div class="line"><a id="l01092" name="l01092"></a><span class="lineno"> 1092</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01093" name="l01093"></a><span class="lineno"> 1093</span><span class="comment">!!    real c_u(nz_u)        ! Interpolated paramters in the &quot;urban grid&quot;</span></div>
<div class="line"><a id="l01094" name="l01094"></a><span class="lineno"> 1094</span><span class="keywordtype">      real</span> c_u(nz_um)       <span class="comment">! Interpolated paramters in the &quot;urban grid&quot;</span></div>
<div class="line"><a id="l01095" name="l01095"></a><span class="lineno"> 1095</span> </div>
<div class="line"><a id="l01096" name="l01096"></a><span class="lineno"> 1096</span>       </div>
<div class="line"><a id="l01097" name="l01097"></a><span class="lineno"> 1097</span><span class="comment">! LOCAL:</span></div>
<div class="line"><a id="l01098" name="l01098"></a><span class="lineno"> 1098</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01099" name="l01099"></a><span class="lineno"> 1099</span>      <span class="keywordtype">integer</span> iz_u,iz</div>
<div class="line"><a id="l01100" name="l01100"></a><span class="lineno"> 1100</span><span class="keywordtype">      real</span> ctot,dz</div>
<div class="line"><a id="l01101" name="l01101"></a><span class="lineno"> 1101</span> </div>
<div class="line"><a id="l01102" name="l01102"></a><span class="lineno"> 1102</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01103" name="l01103"></a><span class="lineno"> 1103</span><span class="comment">! END VARIABLES DEFINITIONS</span></div>
<div class="line"><a id="l01104" name="l01104"></a><span class="lineno"> 1104</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01105" name="l01105"></a><span class="lineno"> 1105</span> </div>
<div class="line"><a id="l01106" name="l01106"></a><span class="lineno"> 1106</span>       <span class="keywordflow">do</span> iz_u=1,nz_u</div>
<div class="line"><a id="l01107" name="l01107"></a><span class="lineno"> 1107</span>        ctot=0.</div>
<div class="line"><a id="l01108" name="l01108"></a><span class="lineno"> 1108</span>        <span class="keywordflow">do</span> iz=kts,kte</div>
<div class="line"><a id="l01109" name="l01109"></a><span class="lineno"> 1109</span>         dz=max(min(z(iz+1),z_u(iz_u+1))-max(z(iz),z_u(iz_u)),0.)</div>
<div class="line"><a id="l01110" name="l01110"></a><span class="lineno"> 1110</span>         ctot=ctot+c(iz)*dz</div>
<div class="line"><a id="l01111" name="l01111"></a><span class="lineno"> 1111</span><span class="keywordflow">        enddo</span></div>
<div class="line"><a id="l01112" name="l01112"></a><span class="lineno"> 1112</span>        c_u(iz_u)=ctot/(z_u(iz_u+1)-z_u(iz_u))</div>
<div class="line"><a id="l01113" name="l01113"></a><span class="lineno"> 1113</span><span class="keywordflow">       enddo</span></div>
<div class="line"><a id="l01114" name="l01114"></a><span class="lineno"> 1114</span>       </div>
<div class="line"><a id="l01115" name="l01115"></a><span class="lineno"> 1115</span>       <span class="keywordflow">return</span></div>
<div class="line"><a id="l01116" name="l01116"></a><span class="lineno"> 1116</span>       <span class="keyword">end subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a05f8a759b52266ba041fde12cecc7962">interpol</a></div>
<div class="line"><a id="l01117" name="l01117"></a><span class="lineno"> 1117</span>         </div>
<div class="line"><a id="l01118" name="l01118"></a><span class="lineno"> 1118</span><span class="comment">! ===6=8===============================================================72       </span></div>
<div class="line"><a id="l01119" name="l01119"></a><span class="lineno"> 1119</span><span class="comment">! ===6=8===============================================================72     </span></div>
<div class="line"><a id="l01120" name="l01120"></a><span class="lineno"> 1120</span> </div>
<div class="line"><a id="l01121" name="l01121"></a><span class="lineno"><a class="line" href="namespacemodule__sf__bep.html#a646e15d96f3e4929948bbb9babe74044"> 1121</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a646e15d96f3e4929948bbb9babe74044">modif_rad</a>(iurb,nd,nz_u,z,ws,drst,strd,ss,pb,    &amp;</div>
<div class="line"><a id="l01122" name="l01122"></a><span class="lineno"> 1122</span>                          tw,tg,albg,albw,emw,emg,               &amp;</div>
<div class="line"><a id="l01123" name="l01123"></a><span class="lineno"> 1123</span>                          fww,fwg,fgw,fsw,fsg,                   &amp;</div>
<div class="line"><a id="l01124" name="l01124"></a><span class="lineno"> 1124</span>                          zr,deltar,ah,                          &amp;    </div>
<div class="line"><a id="l01125" name="l01125"></a><span class="lineno"> 1125</span>                          rs,rl,rsw,rsg,rlw,rlg)                       </div>
<div class="line"><a id="l01126" name="l01126"></a><span class="lineno"> 1126</span> </div>
<div class="line"><a id="l01127" name="l01127"></a><span class="lineno"> 1127</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01128" name="l01128"></a><span class="lineno"> 1128</span><span class="comment">! This routine computes the modification of the short wave and </span></div>
<div class="line"><a id="l01129" name="l01129"></a><span class="lineno"> 1129</span><span class="comment">!  long wave radiation due to the buildings.</span></div>
<div class="line"><a id="l01130" name="l01130"></a><span class="lineno"> 1130</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01131" name="l01131"></a><span class="lineno"> 1131</span> </div>
<div class="line"><a id="l01132" name="l01132"></a><span class="lineno"> 1132</span>      <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l01133" name="l01133"></a><span class="lineno"> 1133</span> </div>
<div class="line"><a id="l01134" name="l01134"></a><span class="lineno"> 1134</span> </div>
<div class="line"><a id="l01135" name="l01135"></a><span class="lineno"> 1135</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01136" name="l01136"></a><span class="lineno"> 1136</span><span class="comment">! INPUT:</span></div>
<div class="line"><a id="l01137" name="l01137"></a><span class="lineno"> 1137</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01138" name="l01138"></a><span class="lineno"> 1138</span>      <span class="keywordtype">integer</span> iurb              <span class="comment">! current urban class</span></div>
<div class="line"><a id="l01139" name="l01139"></a><span class="lineno"> 1139</span>      <span class="keywordtype">integer</span> nd                <span class="comment">! Number of street direction for the current urban class</span></div>
<div class="line"><a id="l01140" name="l01140"></a><span class="lineno"> 1140</span>      <span class="keywordtype">integer</span> nz_u              <span class="comment">! Number of layer in the urban grid</span></div>
<div class="line"><a id="l01141" name="l01141"></a><span class="lineno"> 1141</span><span class="keywordtype">      real</span> z(nz_um)           <span class="comment">! Height of the urban grid levels</span></div>
<div class="line"><a id="l01142" name="l01142"></a><span class="lineno"> 1142</span><span class="keywordtype">      real</span> ws(ndm)              <span class="comment">! Street widths of the current urban class</span></div>
<div class="line"><a id="l01143" name="l01143"></a><span class="lineno"> 1143</span><span class="keywordtype">      real</span> drst(ndm)            <span class="comment">! street directions for the current urban class</span></div>
<div class="line"><a id="l01144" name="l01144"></a><span class="lineno"> 1144</span><span class="keywordtype">      real</span> strd(ndm)            <span class="comment">! Street lengths for the current urban class</span></div>
<div class="line"><a id="l01145" name="l01145"></a><span class="lineno"> 1145</span><span class="keywordtype">      real</span> ss(nz_um)          <span class="comment">! probability to have a building with height h</span></div>
<div class="line"><a id="l01146" name="l01146"></a><span class="lineno"> 1146</span><span class="keywordtype">      real</span> pb(nz_um)          <span class="comment">! probability to have a building with an height equal</span></div>
<div class="line"><a id="l01147" name="l01147"></a><span class="lineno"> 1147</span><span class="keywordtype">      real</span> tw(2*ndm,nz_um,nwr_u) <span class="comment">! Temperature in each layer of the wall [K]</span></div>
<div class="line"><a id="l01148" name="l01148"></a><span class="lineno"> 1148</span><span class="keywordtype">      real</span> tg(ndm,ng_u)         <span class="comment">! Temperature in each layer of the ground [K]</span></div>
<div class="line"><a id="l01149" name="l01149"></a><span class="lineno"> 1149</span><span class="keywordtype">      real</span> albg                 <span class="comment">! Albedo of the ground for the current urban class</span></div>
<div class="line"><a id="l01150" name="l01150"></a><span class="lineno"> 1150</span><span class="keywordtype">      real</span> albw                 <span class="comment">! Albedo of the wall for the current urban class</span></div>
<div class="line"><a id="l01151" name="l01151"></a><span class="lineno"> 1151</span><span class="keywordtype">      real</span> emg                  <span class="comment">! Emissivity of ground for the current urban class</span></div>
<div class="line"><a id="l01152" name="l01152"></a><span class="lineno"> 1152</span><span class="keywordtype">      real</span> emw                  <span class="comment">! Emissivity of wall for the current urban class</span></div>
<div class="line"><a id="l01153" name="l01153"></a><span class="lineno"> 1153</span><span class="keywordtype">      real</span> fgw(nz_um,ndm,nurbm)       <span class="comment">! View factors from ground to wall</span></div>
<div class="line"><a id="l01154" name="l01154"></a><span class="lineno"> 1154</span><span class="keywordtype">      real</span> fsg(ndm,nurbm)             <span class="comment">! View factors from sky to ground</span></div>
<div class="line"><a id="l01155" name="l01155"></a><span class="lineno"> 1155</span><span class="keywordtype">      real</span> fsw(nz_um,ndm,nurbm)       <span class="comment">! View factors from sky to wall</span></div>
<div class="line"><a id="l01156" name="l01156"></a><span class="lineno"> 1156</span><span class="keywordtype">      real</span> fws(nz_um,ndm,nurbm)       <span class="comment">! View factors from wall to sky</span></div>
<div class="line"><a id="l01157" name="l01157"></a><span class="lineno"> 1157</span><span class="keywordtype">      real</span> fwg(nz_um,ndm,nurbm)       <span class="comment">! View factors from wall to ground</span></div>
<div class="line"><a id="l01158" name="l01158"></a><span class="lineno"> 1158</span><span class="keywordtype">      real</span> fww(nz_um,nz_um,ndm,nurbm) <span class="comment">! View factors from wall to wall</span></div>
<div class="line"><a id="l01159" name="l01159"></a><span class="lineno"> 1159</span><span class="keywordtype">      real</span> ah                   <span class="comment">! Hour angle (it should come from the radiation routine)</span></div>
<div class="line"><a id="l01160" name="l01160"></a><span class="lineno"> 1160</span><span class="keywordtype">      real</span> zr                   <span class="comment">! zenith angle</span></div>
<div class="line"><a id="l01161" name="l01161"></a><span class="lineno"> 1161</span><span class="keywordtype">      real</span> deltar               <span class="comment">! Declination of the sun</span></div>
<div class="line"><a id="l01162" name="l01162"></a><span class="lineno"> 1162</span><span class="keywordtype">      real</span> rs                   <span class="comment">! solar radiation</span></div>
<div class="line"><a id="l01163" name="l01163"></a><span class="lineno"> 1163</span><span class="keywordtype">      real</span> rl                   <span class="comment">! downward flux of the longwave radiation</span></div>
<div class="line"><a id="l01164" name="l01164"></a><span class="lineno"> 1164</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01165" name="l01165"></a><span class="lineno"> 1165</span><span class="comment">! OUTPUT:</span></div>
<div class="line"><a id="l01166" name="l01166"></a><span class="lineno"> 1166</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01167" name="l01167"></a><span class="lineno"> 1167</span><span class="keywordtype">      real</span> rlg(ndm)             <span class="comment">! Long wave radiation at the ground</span></div>
<div class="line"><a id="l01168" name="l01168"></a><span class="lineno"> 1168</span><span class="keywordtype">      real</span> rlw(2*ndm,nz_um)     <span class="comment">! Long wave radiation at the walls</span></div>
<div class="line"><a id="l01169" name="l01169"></a><span class="lineno"> 1169</span><span class="keywordtype">      real</span> rsg(ndm)             <span class="comment">! Short wave radiation at the ground</span></div>
<div class="line"><a id="l01170" name="l01170"></a><span class="lineno"> 1170</span><span class="keywordtype">      real</span> rsw(2*ndm,nz_um)     <span class="comment">! Short wave radiation at the walls</span></div>
<div class="line"><a id="l01171" name="l01171"></a><span class="lineno"> 1171</span> </div>
<div class="line"><a id="l01172" name="l01172"></a><span class="lineno"> 1172</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01173" name="l01173"></a><span class="lineno"> 1173</span><span class="comment">! LOCAL:</span></div>
<div class="line"><a id="l01174" name="l01174"></a><span class="lineno"> 1174</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01175" name="l01175"></a><span class="lineno"> 1175</span> </div>
<div class="line"><a id="l01176" name="l01176"></a><span class="lineno"> 1176</span>      <span class="keywordtype">integer</span> id,iz</div>
<div class="line"><a id="l01177" name="l01177"></a><span class="lineno"> 1177</span> </div>
<div class="line"><a id="l01178" name="l01178"></a><span class="lineno"> 1178</span><span class="comment">!  Calculation of the shadow effects</span></div>
<div class="line"><a id="l01179" name="l01179"></a><span class="lineno"> 1179</span> </div>
<div class="line"><a id="l01180" name="l01180"></a><span class="lineno"> 1180</span>      <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#adc1740fecdbbc88a536fda2c456b1e2d">shadow_mas</a>(nd,nz_u,zr,deltar,ah,drst,ws,ss,pb,z,           &amp;</div>
<div class="line"><a id="l01181" name="l01181"></a><span class="lineno"> 1181</span>                     rs,rsw,rsg)</div>
<div class="line"><a id="l01182" name="l01182"></a><span class="lineno"> 1182</span> </div>
<div class="line"><a id="l01183" name="l01183"></a><span class="lineno"> 1183</span><span class="comment">! Calculation of the reflection effects          </span></div>
<div class="line"><a id="l01184" name="l01184"></a><span class="lineno"> 1184</span>      <span class="keywordflow">do</span> id=1,nd</div>
<div class="line"><a id="l01185" name="l01185"></a><span class="lineno"> 1185</span>         <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#acaecbbdf8792abde301dc5b78589ba9f">long_rad</a>(iurb,nz_u,id,emw,emg,                 &amp;</div>
<div class="line"><a id="l01186" name="l01186"></a><span class="lineno"> 1186</span>                      fwg,fww,fgw,fsw,fsg,tg,tw,rlg,rlw,rl,pb)</div>
<div class="line"><a id="l01187" name="l01187"></a><span class="lineno"> 1187</span>         </div>
<div class="line"><a id="l01188" name="l01188"></a><span class="lineno"> 1188</span>         <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#abd3776b0304ce044cb0513a63aa99b07">short_rad</a>(iurb,nz_u,id,albw,albg,fwg,fww,fgw,rsg,rsw,pb)</div>
<div class="line"><a id="l01189" name="l01189"></a><span class="lineno"> 1189</span>  </div>
<div class="line"><a id="l01190" name="l01190"></a><span class="lineno"> 1190</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l01191" name="l01191"></a><span class="lineno"> 1191</span>      </div>
<div class="line"><a id="l01192" name="l01192"></a><span class="lineno"> 1192</span>      <span class="keywordflow">return</span></div>
<div class="line"><a id="l01193" name="l01193"></a><span class="lineno"> 1193</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a646e15d96f3e4929948bbb9babe74044">modif_rad</a></div>
<div class="line"><a id="l01194" name="l01194"></a><span class="lineno"> 1194</span> </div>
<div class="line"><a id="l01195" name="l01195"></a><span class="lineno"> 1195</span> </div>
<div class="line"><a id="l01196" name="l01196"></a><span class="lineno"> 1196</span><span class="comment">! ===6=8===============================================================72  </span></div>
<div class="line"><a id="l01197" name="l01197"></a><span class="lineno"> 1197</span><span class="comment">! ===6=8===============================================================72     </span></div>
<div class="line"><a id="l01198" name="l01198"></a><span class="lineno"> 1198</span> </div>
<div class="line"><a id="l01199" name="l01199"></a><span class="lineno"><a class="line" href="namespacemodule__sf__bep.html#a6c06d5d98aed63db0cb89c197392c812"> 1199</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a6c06d5d98aed63db0cb89c197392c812">surf_temp</a>(nz_u,nd,pr,dt,ss,rs,rl,rsg,rlg,rsw,rlw,     &amp;</div>
<div class="line"><a id="l01200" name="l01200"></a><span class="lineno"> 1200</span>                          tg,alag,csg,emg,albg,ptg,sfg,gfg,             &amp;</div>
<div class="line"><a id="l01201" name="l01201"></a><span class="lineno"> 1201</span>                          tr,alar,csr,emr,albr,ptr,sfr,gfr,             &amp;</div>
<div class="line"><a id="l01202" name="l01202"></a><span class="lineno"> 1202</span>                          tw,alaw,csw,emw,albw,ptw,sfw,gfw)             </div>
<div class="line"><a id="l01203" name="l01203"></a><span class="lineno"> 1203</span>                 </div>
<div class="line"><a id="l01204" name="l01204"></a><span class="lineno"> 1204</span> </div>
<div class="line"><a id="l01205" name="l01205"></a><span class="lineno"> 1205</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01206" name="l01206"></a><span class="lineno"> 1206</span><span class="comment">! Computation of the surface temperatures for walls, ground and roofs </span></div>
<div class="line"><a id="l01207" name="l01207"></a><span class="lineno"> 1207</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01208" name="l01208"></a><span class="lineno"> 1208</span> </div>
<div class="line"><a id="l01209" name="l01209"></a><span class="lineno"> 1209</span>      <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l01210" name="l01210"></a><span class="lineno"> 1210</span>      </div>
<div class="line"><a id="l01211" name="l01211"></a><span class="lineno"> 1211</span>      </div>
<div class="line"><a id="l01212" name="l01212"></a><span class="lineno"> 1212</span>      </div>
<div class="line"><a id="l01213" name="l01213"></a><span class="lineno"> 1213</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01214" name="l01214"></a><span class="lineno"> 1214</span><span class="comment">! INPUT:</span></div>
<div class="line"><a id="l01215" name="l01215"></a><span class="lineno"> 1215</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01216" name="l01216"></a><span class="lineno"> 1216</span>      <span class="keywordtype">integer</span> nz_u              <span class="comment">! Number of vertical layers defined in the urban grid</span></div>
<div class="line"><a id="l01217" name="l01217"></a><span class="lineno"> 1217</span>      <span class="keywordtype">integer</span> nd                <span class="comment">! Number of street direction for the current urban class</span></div>
<div class="line"><a id="l01218" name="l01218"></a><span class="lineno"> 1218</span><span class="keywordtype">      real</span> alag(ng_u)           <span class="comment">! Ground thermal diffusivity for the current urban class [m^2 s^-1] </span></div>
<div class="line"><a id="l01219" name="l01219"></a><span class="lineno"> 1219</span><span class="keywordtype">      real</span> alar(nwr_u)           <span class="comment">! Roof thermal diffusivity for the current urban class [m^2 s^-1]  </span></div>
<div class="line"><a id="l01220" name="l01220"></a><span class="lineno"> 1220</span><span class="keywordtype">      real</span> alaw(nwr_u)           <span class="comment">! Wall thermal diffusivity for the current urban class [m^2 s^-1]  </span></div>
<div class="line"><a id="l01221" name="l01221"></a><span class="lineno"> 1221</span><span class="keywordtype">      real</span> albg                 <span class="comment">! Albedo of the ground for the current urban class</span></div>
<div class="line"><a id="l01222" name="l01222"></a><span class="lineno"> 1222</span><span class="keywordtype">      real</span> albr                 <span class="comment">! Albedo of the roof for the current urban class</span></div>
<div class="line"><a id="l01223" name="l01223"></a><span class="lineno"> 1223</span><span class="keywordtype">      real</span> albw                 <span class="comment">! Albedo of the wall for the current urban class</span></div>
<div class="line"><a id="l01224" name="l01224"></a><span class="lineno"> 1224</span><span class="keywordtype">      real</span> csg(ng_u)            <span class="comment">! Specific heat of the ground material of the current urban class [J m^3 K^-1]</span></div>
<div class="line"><a id="l01225" name="l01225"></a><span class="lineno"> 1225</span><span class="keywordtype">      real</span> csr(nwr_u)            <span class="comment">! Specific heat of the roof material for the current urban class [J m^3 K^-1]</span></div>
<div class="line"><a id="l01226" name="l01226"></a><span class="lineno"> 1226</span><span class="keywordtype">      real</span> csw(nwr_u)            <span class="comment">! Specific heat of the wall material for the current urban class [J m^3 K^-1]</span></div>
<div class="line"><a id="l01227" name="l01227"></a><span class="lineno"> 1227</span><span class="keywordtype">      real</span> dt                   <span class="comment">! Time step</span></div>
<div class="line"><a id="l01228" name="l01228"></a><span class="lineno"> 1228</span><span class="keywordtype">      real</span> emg                  <span class="comment">! Emissivity of ground for the current urban class</span></div>
<div class="line"><a id="l01229" name="l01229"></a><span class="lineno"> 1229</span><span class="keywordtype">      real</span> emr                  <span class="comment">! Emissivity of roof for the current urban class</span></div>
<div class="line"><a id="l01230" name="l01230"></a><span class="lineno"> 1230</span><span class="keywordtype">      real</span> emw                  <span class="comment">! Emissivity of wall for the current urban class</span></div>
<div class="line"><a id="l01231" name="l01231"></a><span class="lineno"> 1231</span><span class="keywordtype">      real</span> pr(nz_um)            <span class="comment">! Air pressure</span></div>
<div class="line"><a id="l01232" name="l01232"></a><span class="lineno"> 1232</span><span class="keywordtype">      real</span> rs                   <span class="comment">! Solar radiation</span></div>
<div class="line"><a id="l01233" name="l01233"></a><span class="lineno"> 1233</span><span class="keywordtype">      real</span> rl                   <span class="comment">! Downward flux of the longwave radiation</span></div>
<div class="line"><a id="l01234" name="l01234"></a><span class="lineno"> 1234</span><span class="keywordtype">      real</span> rlg(ndm)             <span class="comment">! Long wave radiation at the ground</span></div>
<div class="line"><a id="l01235" name="l01235"></a><span class="lineno"> 1235</span><span class="keywordtype">      real</span> rlw(2*ndm,nz_um)     <span class="comment">! Long wave radiation at the walls</span></div>
<div class="line"><a id="l01236" name="l01236"></a><span class="lineno"> 1236</span><span class="keywordtype">      real</span> rsg(ndm)             <span class="comment">! Short wave radiation at the ground</span></div>
<div class="line"><a id="l01237" name="l01237"></a><span class="lineno"> 1237</span><span class="keywordtype">      real</span> rsw(2*ndm,nz_um)     <span class="comment">! Short wave radiation at the walls</span></div>
<div class="line"><a id="l01238" name="l01238"></a><span class="lineno"> 1238</span><span class="keywordtype">      real</span> sfg(ndm)             <span class="comment">! Sensible heat flux from ground (road)</span></div>
<div class="line"><a id="l01239" name="l01239"></a><span class="lineno"> 1239</span><span class="keywordtype">      real</span> sfr(ndm,nz_um)     <span class="comment">! Sensible heat flux from roofs</span></div>
<div class="line"><a id="l01240" name="l01240"></a><span class="lineno"> 1240</span><span class="keywordtype">      real</span> sfw(2*ndm,nz_um)     <span class="comment">! Sensible heat flux from walls</span></div>
<div class="line"><a id="l01241" name="l01241"></a><span class="lineno"> 1241</span><span class="keywordtype">      real</span> gfg(ndm)             <span class="comment">! Heat flux transferred from the surface of the ground (road) toward the interior</span></div>
<div class="line"><a id="l01242" name="l01242"></a><span class="lineno"> 1242</span><span class="keywordtype">      real</span> gfr(ndm,nz_um)     <span class="comment">! Heat flux transferred from the surface of the roof toward the interior</span></div>
<div class="line"><a id="l01243" name="l01243"></a><span class="lineno"> 1243</span><span class="keywordtype">      real</span> gfw(2*ndm,nz_um)     <span class="comment">! Heat flux transfered from the surface of the walls toward the interior</span></div>
<div class="line"><a id="l01244" name="l01244"></a><span class="lineno"> 1244</span><span class="keywordtype">      real</span> ss(nz_um)          <span class="comment">! Probability to have a building with height h</span></div>
<div class="line"><a id="l01245" name="l01245"></a><span class="lineno"> 1245</span><span class="keywordtype">      real</span> tg(ndm,ng_u)         <span class="comment">! Temperature in each layer of the ground [K]</span></div>
<div class="line"><a id="l01246" name="l01246"></a><span class="lineno"> 1246</span><span class="keywordtype">      real</span> tr(ndm,nz_um,nwr_u) <span class="comment">! Temperature in each layer of the roof [K]</span></div>
<div class="line"><a id="l01247" name="l01247"></a><span class="lineno"> 1247</span><span class="keywordtype">      real</span> tw(2*ndm,nz_um,nwr_u) <span class="comment">! Temperature in each layer of the wall [K]</span></div>
<div class="line"><a id="l01248" name="l01248"></a><span class="lineno"> 1248</span>      </div>
<div class="line"><a id="l01249" name="l01249"></a><span class="lineno"> 1249</span> </div>
<div class="line"><a id="l01250" name="l01250"></a><span class="lineno"> 1250</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01251" name="l01251"></a><span class="lineno"> 1251</span><span class="comment">! OUTPUT:</span></div>
<div class="line"><a id="l01252" name="l01252"></a><span class="lineno"> 1252</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01253" name="l01253"></a><span class="lineno"> 1253</span><span class="keywordtype">      real</span> ptg(ndm)             <span class="comment">! Ground potential temperatures </span></div>
<div class="line"><a id="l01254" name="l01254"></a><span class="lineno"> 1254</span><span class="keywordtype">      real</span> ptr(ndm,nz_um)     <span class="comment">! Roof potential temperatures </span></div>
<div class="line"><a id="l01255" name="l01255"></a><span class="lineno"> 1255</span><span class="keywordtype">      real</span> ptw(2*ndm,nz_um)     <span class="comment">! Walls potential temperatures </span></div>
<div class="line"><a id="l01256" name="l01256"></a><span class="lineno"> 1256</span> </div>
<div class="line"><a id="l01257" name="l01257"></a><span class="lineno"> 1257</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01258" name="l01258"></a><span class="lineno"> 1258</span><span class="comment">! LOCAL:</span></div>
<div class="line"><a id="l01259" name="l01259"></a><span class="lineno"> 1259</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01260" name="l01260"></a><span class="lineno"> 1260</span>      <span class="keywordtype">integer</span> id,ig,ir,iw,iz</div>
<div class="line"><a id="l01261" name="l01261"></a><span class="lineno"> 1261</span> </div>
<div class="line"><a id="l01262" name="l01262"></a><span class="lineno"> 1262</span><span class="keywordtype">      real</span> rtg(ndm)             <span class="comment">! Total radiation at ground(road) surface (solar+incoming long+outgoing long)</span></div>
<div class="line"><a id="l01263" name="l01263"></a><span class="lineno"> 1263</span><span class="keywordtype">      real</span> rtr(ndm,nz_um)     <span class="comment">! Total radiation at roof surface (solar+incoming long+outgoing long)</span></div>
<div class="line"><a id="l01264" name="l01264"></a><span class="lineno"> 1264</span><span class="keywordtype">      real</span> rtw(2*ndm,nz_um)     <span class="comment">! Radiation at walls surface (solar+incoming long+outgoing long)</span></div>
<div class="line"><a id="l01265" name="l01265"></a><span class="lineno"> 1265</span><span class="keywordtype">      real</span> tg_tmp(ng_u)</div>
<div class="line"><a id="l01266" name="l01266"></a><span class="lineno"> 1266</span><span class="keywordtype">      real</span> tr_tmp(nwr_u)</div>
<div class="line"><a id="l01267" name="l01267"></a><span class="lineno"> 1267</span><span class="keywordtype">      real</span> tw_tmp(nwr_u)</div>
<div class="line"><a id="l01268" name="l01268"></a><span class="lineno"> 1268</span> </div>
<div class="line"><a id="l01269" name="l01269"></a><span class="lineno"> 1269</span><span class="keywordtype">      real</span> dzg_u(ng_u)          <span class="comment">! Layer sizes in the ground</span></div>
<div class="line"><a id="l01270" name="l01270"></a><span class="lineno"> 1270</span> </div>
<div class="line"><a id="l01271" name="l01271"></a><span class="lineno"> 1271</span><span class="keywordtype">      real</span> dzr_u(nwr_u)          <span class="comment">! Layers sizes in the roof</span></div>
<div class="line"><a id="l01272" name="l01272"></a><span class="lineno"> 1272</span>         </div>
<div class="line"><a id="l01273" name="l01273"></a><span class="lineno"> 1273</span><span class="keywordtype">      real</span> dzw_u(nwr_u)          <span class="comment">! Layer sizes in the wall</span></div>
<div class="line"><a id="l01274" name="l01274"></a><span class="lineno"> 1274</span>      </div>
<div class="line"><a id="l01275" name="l01275"></a><span class="lineno"> 1275</span> </div>
<div class="line"><a id="l01276" name="l01276"></a><span class="lineno"> 1276</span>      <span class="keyword">data</span> dzg_u /0.2,0.12,0.08,0.05,0.03,0.02,0.02,0.01,0.005,0.0025/</div>
<div class="line"><a id="l01277" name="l01277"></a><span class="lineno"> 1277</span>      <span class="keyword">data</span> dzr_u /0.02,0.02,0.02,0.02,0.02,0.02,0.02,0.01,0.005,0.0025/   </div>
<div class="line"><a id="l01278" name="l01278"></a><span class="lineno"> 1278</span>      <span class="keyword">data</span> dzw_u /0.02,0.02,0.02,0.02,0.02,0.02,0.02,0.01,0.005,0.0025/</div>
<div class="line"><a id="l01279" name="l01279"></a><span class="lineno"> 1279</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01280" name="l01280"></a><span class="lineno"> 1280</span><span class="comment">! END VARIABLES DEFINITIONS</span></div>
<div class="line"><a id="l01281" name="l01281"></a><span class="lineno"> 1281</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01282" name="l01282"></a><span class="lineno"> 1282</span> </div>
<div class="line"><a id="l01283" name="l01283"></a><span class="lineno"> 1283</span>        </div>
<div class="line"><a id="l01284" name="l01284"></a><span class="lineno"> 1284</span>   </div>
<div class="line"><a id="l01285" name="l01285"></a><span class="lineno"> 1285</span>      <span class="keywordflow">do</span> id=1,nd</div>
<div class="line"><a id="l01286" name="l01286"></a><span class="lineno"> 1286</span> </div>
<div class="line"><a id="l01287" name="l01287"></a><span class="lineno"> 1287</span><span class="comment">!      Calculation for the ground surfaces</span></div>
<div class="line"><a id="l01288" name="l01288"></a><span class="lineno"> 1288</span>       <span class="keywordflow">do</span> ig=1,ng_u</div>
<div class="line"><a id="l01289" name="l01289"></a><span class="lineno"> 1289</span>        tg_tmp(ig)=tg(id,ig)</div>
<div class="line"><a id="l01290" name="l01290"></a><span class="lineno"> 1290</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l01291" name="l01291"></a><span class="lineno"> 1291</span><span class="comment">!           </span></div>
<div class="line"><a id="l01292" name="l01292"></a><span class="lineno"> 1292</span>       <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a0928487326d9735901c0825abfec3b5e">soil_temp</a>(ng_u,dzg_u,tg_tmp,ptg(id),alag,csg,        &amp;</div>
<div class="line"><a id="l01293" name="l01293"></a><span class="lineno"> 1293</span>                     rsg(id),rlg(id),pr(1),                    &amp;</div>
<div class="line"><a id="l01294" name="l01294"></a><span class="lineno"> 1294</span>                     dt,emg,albg,                              &amp;</div>
<div class="line"><a id="l01295" name="l01295"></a><span class="lineno"> 1295</span>                     rtg(id),sfg(id),gfg(id))    </div>
<div class="line"><a id="l01296" name="l01296"></a><span class="lineno"> 1296</span>       <span class="keywordflow">do</span> ig=1,ng_u</div>
<div class="line"><a id="l01297" name="l01297"></a><span class="lineno"> 1297</span>        tg(id,ig)=tg_tmp(ig)</div>
<div class="line"><a id="l01298" name="l01298"></a><span class="lineno"> 1298</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l01299" name="l01299"></a><span class="lineno"> 1299</span> </div>
<div class="line"><a id="l01300" name="l01300"></a><span class="lineno"> 1300</span><span class="comment">!      Calculation for the roofs surfaces</span></div>
<div class="line"><a id="l01301" name="l01301"></a><span class="lineno"> 1301</span>         </div>
<div class="line"><a id="l01302" name="l01302"></a><span class="lineno"> 1302</span>       <span class="keywordflow">do</span> iz=2,nz_u</div>
<div class="line"><a id="l01303" name="l01303"></a><span class="lineno"> 1303</span>            </div>
<div class="line"><a id="l01304" name="l01304"></a><span class="lineno"> 1304</span>        <span class="keywordflow">if</span>(ss(iz).gt.0.)<span class="keywordflow">then</span></div>
<div class="line"><a id="l01305" name="l01305"></a><span class="lineno"> 1305</span>         <span class="keywordflow">do</span> ir=1,nwr_u        </div>
<div class="line"><a id="l01306" name="l01306"></a><span class="lineno"> 1306</span>          tr_tmp(ir)=tr(id,iz,ir)</div>
<div class="line"><a id="l01307" name="l01307"></a><span class="lineno"> 1307</span><span class="keywordflow">         end do</span></div>
<div class="line"><a id="l01308" name="l01308"></a><span class="lineno"> 1308</span>        </div>
<div class="line"><a id="l01309" name="l01309"></a><span class="lineno"> 1309</span>         <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a0928487326d9735901c0825abfec3b5e">soil_temp</a>(nwr_u,dzr_u,tr_tmp,ptr(id,iz),          &amp;</div>
<div class="line"><a id="l01310" name="l01310"></a><span class="lineno"> 1310</span>                       alar,csr,rs,rl,pr(iz),dt,emr,albr,    &amp;</div>
<div class="line"><a id="l01311" name="l01311"></a><span class="lineno"> 1311</span>                       rtr(id,iz),sfr(id,iz),gfr(id,iz))     </div>
<div class="line"><a id="l01312" name="l01312"></a><span class="lineno"> 1312</span>         <span class="keywordflow">do</span> ir=1,nwr_u        </div>
<div class="line"><a id="l01313" name="l01313"></a><span class="lineno"> 1313</span>          tr(id,iz,ir)=tr_tmp(ir)</div>
<div class="line"><a id="l01314" name="l01314"></a><span class="lineno"> 1314</span><span class="keywordflow">         end do</span></div>
<div class="line"><a id="l01315" name="l01315"></a><span class="lineno"> 1315</span>       </div>
<div class="line"><a id="l01316" name="l01316"></a><span class="lineno"> 1316</span><span class="keywordflow">        end if</span></div>
<div class="line"><a id="l01317" name="l01317"></a><span class="lineno"> 1317</span>            </div>
<div class="line"><a id="l01318" name="l01318"></a><span class="lineno"> 1318</span><span class="keywordflow">       end do</span> <span class="comment">!iz</span></div>
<div class="line"><a id="l01319" name="l01319"></a><span class="lineno"> 1319</span> </div>
<div class="line"><a id="l01320" name="l01320"></a><span class="lineno"> 1320</span><span class="comment">!      Calculation for the walls surfaces</span></div>
<div class="line"><a id="l01321" name="l01321"></a><span class="lineno"> 1321</span>         </div>
<div class="line"><a id="l01322" name="l01322"></a><span class="lineno"> 1322</span>       <span class="keywordflow">do</span> iz=1,nz_u</div>
<div class="line"><a id="l01323" name="l01323"></a><span class="lineno"> 1323</span>            </div>
<div class="line"><a id="l01324" name="l01324"></a><span class="lineno"> 1324</span>        <span class="keywordflow">do</span> iw=1,nwr_u        </div>
<div class="line"><a id="l01325" name="l01325"></a><span class="lineno"> 1325</span>         tw_tmp(iw)=tw(2*id-1,iz,iw)</div>
<div class="line"><a id="l01326" name="l01326"></a><span class="lineno"> 1326</span><span class="keywordflow">        end do</span></div>
<div class="line"><a id="l01327" name="l01327"></a><span class="lineno"> 1327</span>        <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a0928487326d9735901c0825abfec3b5e">soil_temp</a>(nwr_u,dzw_u,tw_tmp,ptw(2*id-1,iz),alaw,          &amp;</div>
<div class="line"><a id="l01328" name="l01328"></a><span class="lineno"> 1328</span>                      csw,                                           &amp;     </div>
<div class="line"><a id="l01329" name="l01329"></a><span class="lineno"> 1329</span>                      rsw(2*id-1,iz),rlw(2*id-1,iz),                 &amp;     </div>
<div class="line"><a id="l01330" name="l01330"></a><span class="lineno"> 1330</span>                      pr(iz),dt,emw,                                 &amp;    </div>
<div class="line"><a id="l01331" name="l01331"></a><span class="lineno"> 1331</span>                albw,rtw(2*id-1,iz),sfw(2*id-1,iz),gfw(2*id-1,iz))   </div>
<div class="line"><a id="l01332" name="l01332"></a><span class="lineno"> 1332</span> </div>
<div class="line"><a id="l01333" name="l01333"></a><span class="lineno"> 1333</span>        <span class="keywordflow">do</span> iw=1,nwr_u        </div>
<div class="line"><a id="l01334" name="l01334"></a><span class="lineno"> 1334</span>         tw(2*id-1,iz,iw)=tw_tmp(iw)</div>
<div class="line"><a id="l01335" name="l01335"></a><span class="lineno"> 1335</span><span class="keywordflow">        end do</span></div>
<div class="line"><a id="l01336" name="l01336"></a><span class="lineno"> 1336</span>            </div>
<div class="line"><a id="l01337" name="l01337"></a><span class="lineno"> 1337</span>        <span class="keywordflow">do</span> iw=1,nwr_u        </div>
<div class="line"><a id="l01338" name="l01338"></a><span class="lineno"> 1338</span>         tw_tmp(iw)=tw(2*id,iz,iw)</div>
<div class="line"><a id="l01339" name="l01339"></a><span class="lineno"> 1339</span><span class="keywordflow">        end do</span></div>
<div class="line"><a id="l01340" name="l01340"></a><span class="lineno"> 1340</span>            </div>
<div class="line"><a id="l01341" name="l01341"></a><span class="lineno"> 1341</span>        <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a0928487326d9735901c0825abfec3b5e">soil_temp</a>(nwr_u,dzw_u,tw_tmp,ptw(2*id,iz),alaw,          &amp;      </div>
<div class="line"><a id="l01342" name="l01342"></a><span class="lineno"> 1342</span>                      csw,                                         &amp;     </div>
<div class="line"><a id="l01343" name="l01343"></a><span class="lineno"> 1343</span>                      rsw(2*id,iz),rlw(2*id,iz),                   &amp;     </div>
<div class="line"><a id="l01344" name="l01344"></a><span class="lineno"> 1344</span>                      pr(iz),dt,emw,                               &amp;     </div>
<div class="line"><a id="l01345" name="l01345"></a><span class="lineno"> 1345</span>               albw,rtw(2*id,iz),sfw(2*id,iz),gfw(2*id,iz))        </div>
<div class="line"><a id="l01346" name="l01346"></a><span class="lineno"> 1346</span>         <span class="keywordflow">do</span> iw=1,nwr_u        </div>
<div class="line"><a id="l01347" name="l01347"></a><span class="lineno"> 1347</span>          tw(2*id,iz,iw)=tw_tmp(iw)</div>
<div class="line"><a id="l01348" name="l01348"></a><span class="lineno"> 1348</span><span class="keywordflow">         end do</span></div>
<div class="line"><a id="l01349" name="l01349"></a><span class="lineno"> 1349</span>                   </div>
<div class="line"><a id="l01350" name="l01350"></a><span class="lineno"> 1350</span><span class="keywordflow">        end do</span> <span class="comment">!iz</span></div>
<div class="line"><a id="l01351" name="l01351"></a><span class="lineno"> 1351</span>    </div>
<div class="line"><a id="l01352" name="l01352"></a><span class="lineno"> 1352</span><span class="keywordflow">      end do</span> <span class="comment">!id</span></div>
<div class="line"><a id="l01353" name="l01353"></a><span class="lineno"> 1353</span>      </div>
<div class="line"><a id="l01354" name="l01354"></a><span class="lineno"> 1354</span>      <span class="keywordflow">return</span></div>
<div class="line"><a id="l01355" name="l01355"></a><span class="lineno"> 1355</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a6c06d5d98aed63db0cb89c197392c812">surf_temp</a></div>
<div class="line"><a id="l01356" name="l01356"></a><span class="lineno"> 1356</span>     </div>
<div class="line"><a id="l01357" name="l01357"></a><span class="lineno"> 1357</span><span class="comment">! ===6=8===============================================================72     </span></div>
<div class="line"><a id="l01358" name="l01358"></a><span class="lineno"> 1358</span><span class="comment">! ===6=8===============================================================72  </span></div>
<div class="line"><a id="l01359" name="l01359"></a><span class="lineno"> 1359</span> </div>
<div class="line"><a id="l01360" name="l01360"></a><span class="lineno"><a class="line" href="namespacemodule__sf__bep.html#a873560a1932723dc6c6a6e31bebd91af"> 1360</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a873560a1932723dc6c6a6e31bebd91af">buildings</a>(nd,nz,z0,ua_u,va_u,pt_u,pt0_u,         &amp;</div>
<div class="line"><a id="l01361" name="l01361"></a><span class="lineno"> 1361</span>                        ptg,ptr,da_u,ptw,                            &amp;</div>
<div class="line"><a id="l01362" name="l01362"></a><span class="lineno"> 1362</span>                        drst,uva_u,vva_u,uvb_u,vvb_u,                &amp;</div>
<div class="line"><a id="l01363" name="l01363"></a><span class="lineno"> 1363</span>                        tva_u,tvb_u,evb_u,                           &amp;</div>
<div class="line"><a id="l01364" name="l01364"></a><span class="lineno"> 1364</span>                        uhb_u,vhb_u,thb_u,ehb_u,ss,dt)                  </div>
<div class="line"><a id="l01365" name="l01365"></a><span class="lineno"> 1365</span> </div>
<div class="line"><a id="l01366" name="l01366"></a><span class="lineno"> 1366</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01367" name="l01367"></a><span class="lineno"> 1367</span><span class="comment">! This routine computes the sources or sinks of the different quantities </span></div>
<div class="line"><a id="l01368" name="l01368"></a><span class="lineno"> 1368</span><span class="comment">! on the urban grid. The actual calculation is done in the subroutines </span></div>
<div class="line"><a id="l01369" name="l01369"></a><span class="lineno"> 1369</span><span class="comment">! called flux_wall, and flux_flat.</span></div>
<div class="line"><a id="l01370" name="l01370"></a><span class="lineno"> 1370</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01371" name="l01371"></a><span class="lineno"> 1371</span> </div>
<div class="line"><a id="l01372" name="l01372"></a><span class="lineno"> 1372</span>      <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l01373" name="l01373"></a><span class="lineno"> 1373</span> </div>
<div class="line"><a id="l01374" name="l01374"></a><span class="lineno"> 1374</span>        </div>
<div class="line"><a id="l01375" name="l01375"></a><span class="lineno"> 1375</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01376" name="l01376"></a><span class="lineno"> 1376</span><span class="comment">! INPUT:</span></div>
<div class="line"><a id="l01377" name="l01377"></a><span class="lineno"> 1377</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01378" name="l01378"></a><span class="lineno"> 1378</span>      <span class="keywordtype">integer</span> nd                <span class="comment">! Number of street direction for the current urban class</span></div>
<div class="line"><a id="l01379" name="l01379"></a><span class="lineno"> 1379</span>      <span class="keywordtype">integer</span> nz                <span class="comment">! number of vertical space steps</span></div>
<div class="line"><a id="l01380" name="l01380"></a><span class="lineno"> 1380</span><span class="keywordtype">      real</span> ua_u(nz_um)          <span class="comment">! Wind speed in the x direction on the urban grid</span></div>
<div class="line"><a id="l01381" name="l01381"></a><span class="lineno"> 1381</span><span class="keywordtype">      real</span> va_u(nz_um)          <span class="comment">! Wind speed in the y direction on the urban grid</span></div>
<div class="line"><a id="l01382" name="l01382"></a><span class="lineno"> 1382</span><span class="keywordtype">      real</span> da_u(nz_um)          <span class="comment">! air density on the urban grid</span></div>
<div class="line"><a id="l01383" name="l01383"></a><span class="lineno"> 1383</span><span class="keywordtype">      real</span> drst(ndm)            <span class="comment">! Street directions for the current urban class</span></div>
<div class="line"><a id="l01384" name="l01384"></a><span class="lineno"> 1384</span><span class="keywordtype">      real</span> dz</div>
<div class="line"><a id="l01385" name="l01385"></a><span class="lineno"> 1385</span><span class="keywordtype">      real</span> pt_u(nz_um)          <span class="comment">! Potential temperature on the urban grid</span></div>
<div class="line"><a id="l01386" name="l01386"></a><span class="lineno"> 1386</span><span class="keywordtype">      real</span> pt0_u(nz_um)         <span class="comment">! reference potential temperature on the urban grid</span></div>
<div class="line"><a id="l01387" name="l01387"></a><span class="lineno"> 1387</span><span class="keywordtype">      real</span> ptg(ndm)             <span class="comment">! Ground potential temperatures </span></div>
<div class="line"><a id="l01388" name="l01388"></a><span class="lineno"> 1388</span><span class="keywordtype">      real</span> ptr(ndm,nz_um)     <span class="comment">! Roof potential temperatures </span></div>
<div class="line"><a id="l01389" name="l01389"></a><span class="lineno"> 1389</span><span class="keywordtype">      real</span> ptw(2*ndm,nz_um)     <span class="comment">! Walls potential temperatures </span></div>
<div class="line"><a id="l01390" name="l01390"></a><span class="lineno"> 1390</span><span class="keywordtype">      real</span> ss(nz_um)          <span class="comment">! probability to have a building with height h</span></div>
<div class="line"><a id="l01391" name="l01391"></a><span class="lineno"> 1391</span><span class="keywordtype">      real</span> z0(ndm,nz_um)      <span class="comment">! Roughness lengths &quot;profiles&quot;</span></div>
<div class="line"><a id="l01392" name="l01392"></a><span class="lineno"> 1392</span><span class="keywordtype">      real</span> dt <span class="comment">! time step</span></div>
<div class="line"><a id="l01393" name="l01393"></a><span class="lineno"> 1393</span> </div>
<div class="line"><a id="l01394" name="l01394"></a><span class="lineno"> 1394</span> </div>
<div class="line"><a id="l01395" name="l01395"></a><span class="lineno"> 1395</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01396" name="l01396"></a><span class="lineno"> 1396</span><span class="comment">! OUTPUT:</span></div>
<div class="line"><a id="l01397" name="l01397"></a><span class="lineno"> 1397</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01398" name="l01398"></a><span class="lineno"> 1398</span><span class="comment">! Explicit and implicit component of the momentum, temperature and TKE sources or sinks on</span></div>
<div class="line"><a id="l01399" name="l01399"></a><span class="lineno"> 1399</span><span class="comment">! vertical surfaces (walls) and horizontal surfaces (roofs and street)</span></div>
<div class="line"><a id="l01400" name="l01400"></a><span class="lineno"> 1400</span><span class="comment">! The fluxes can be computed as follow: Fluxes of X = A*X + B</span></div>
<div class="line"><a id="l01401" name="l01401"></a><span class="lineno"> 1401</span><span class="comment">!  Example: Momentum fluxes on vertical surfaces = uva_u * ua_u + uvb_u</span></div>
<div class="line"><a id="l01402" name="l01402"></a><span class="lineno"> 1402</span> </div>
<div class="line"><a id="l01403" name="l01403"></a><span class="lineno"> 1403</span><span class="keywordtype">      real</span> uhb_u(ndm,nz_um)   <span class="comment">! U (wind component) Horizontal surfaces, B (explicit) term</span></div>
<div class="line"><a id="l01404" name="l01404"></a><span class="lineno"> 1404</span><span class="keywordtype">      real</span> uva_u(2*ndm,nz_um)   <span class="comment">! U (wind component)   Vertical surfaces, A (implicit) term</span></div>
<div class="line"><a id="l01405" name="l01405"></a><span class="lineno"> 1405</span><span class="keywordtype">      real</span> uvb_u(2*ndm,nz_um)   <span class="comment">! U (wind component)   Vertical surfaces, B (explicit) term</span></div>
<div class="line"><a id="l01406" name="l01406"></a><span class="lineno"> 1406</span><span class="keywordtype">      real</span> vhb_u(ndm,nz_um)   <span class="comment">! V (wind component) Horizontal surfaces, B (explicit) term</span></div>
<div class="line"><a id="l01407" name="l01407"></a><span class="lineno"> 1407</span><span class="keywordtype">      real</span> vva_u(2*ndm,nz_um)   <span class="comment">! V (wind component)   Vertical surfaces, A (implicit) term</span></div>
<div class="line"><a id="l01408" name="l01408"></a><span class="lineno"> 1408</span><span class="keywordtype">      real</span> vvb_u(2*ndm,nz_um)   <span class="comment">! V (wind component)   Vertical surfaces, B (explicit) term</span></div>
<div class="line"><a id="l01409" name="l01409"></a><span class="lineno"> 1409</span><span class="keywordtype">      real</span> thb_u(ndm,nz_um)   <span class="comment">! Temperature        Horizontal surfaces, B (explicit) term</span></div>
<div class="line"><a id="l01410" name="l01410"></a><span class="lineno"> 1410</span><span class="keywordtype">      real</span> tva_u(2*ndm,nz_um)   <span class="comment">! Temperature          Vertical surfaces, A (implicit) term</span></div>
<div class="line"><a id="l01411" name="l01411"></a><span class="lineno"> 1411</span><span class="keywordtype">      real</span> tvb_u(2*ndm,nz_um)   <span class="comment">! Temperature          Vertical surfaces, B (explicit) term</span></div>
<div class="line"><a id="l01412" name="l01412"></a><span class="lineno"> 1412</span><span class="keywordtype">      real</span> ehb_u(ndm,nz_um)   <span class="comment">! Energy (TKE)       Horizontal surfaces, B (explicit) term</span></div>
<div class="line"><a id="l01413" name="l01413"></a><span class="lineno"> 1413</span><span class="keywordtype">      real</span> evb_u(2*ndm,nz_um)   <span class="comment">! Energy (TKE)         Vertical surfaces, B (explicit) term</span></div>
<div class="line"><a id="l01414" name="l01414"></a><span class="lineno"> 1414</span>  </div>
<div class="line"><a id="l01415" name="l01415"></a><span class="lineno"> 1415</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01416" name="l01416"></a><span class="lineno"> 1416</span><span class="comment">! LOCAL:</span></div>
<div class="line"><a id="l01417" name="l01417"></a><span class="lineno"> 1417</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01418" name="l01418"></a><span class="lineno"> 1418</span>      <span class="keywordtype">integer</span> id,iz</div>
<div class="line"><a id="l01419" name="l01419"></a><span class="lineno"> 1419</span> </div>
<div class="line"><a id="l01420" name="l01420"></a><span class="lineno"> 1420</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01421" name="l01421"></a><span class="lineno"> 1421</span><span class="comment">! END VARIABLES DEFINITIONS</span></div>
<div class="line"><a id="l01422" name="l01422"></a><span class="lineno"> 1422</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01423" name="l01423"></a><span class="lineno"> 1423</span>       dz=<a class="code hl_variable" href="namespacemodule__sf__bep.html#a0d52a26f82bd0c0cf8a76bea001c9905">dz_u</a></div>
<div class="line"><a id="l01424" name="l01424"></a><span class="lineno"> 1424</span> </div>
<div class="line"><a id="l01425" name="l01425"></a><span class="lineno"> 1425</span>      <span class="keywordflow">do</span> id=1,nd</div>
<div class="line"><a id="l01426" name="l01426"></a><span class="lineno"> 1426</span> </div>
<div class="line"><a id="l01427" name="l01427"></a><span class="lineno"> 1427</span><span class="comment">!        Calculation at the ground surfaces</span></div>
<div class="line"><a id="l01428" name="l01428"></a><span class="lineno"> 1428</span>         <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a6de67ff4391d9d6c0f924fb424e6b208">flux_flat</a>(dz,z0(id,1),ua_u(1),va_u(1),pt_u(1),pt0_u(1),  &amp;</div>
<div class="line"><a id="l01429" name="l01429"></a><span class="lineno"> 1429</span>                       ptg(id),uhb_u(id,1),                            &amp; </div>
<div class="line"><a id="l01430" name="l01430"></a><span class="lineno"> 1430</span>                       vhb_u(id,1),thb_u(id,1),ehb_u(id,1))            </div>
<div class="line"><a id="l01431" name="l01431"></a><span class="lineno"> 1431</span> </div>
<div class="line"><a id="l01432" name="l01432"></a><span class="lineno"> 1432</span><span class="comment">!        Calculation at the roof surfaces    </span></div>
<div class="line"><a id="l01433" name="l01433"></a><span class="lineno"> 1433</span>         <span class="keywordflow">do</span> iz=2,nz</div>
<div class="line"><a id="l01434" name="l01434"></a><span class="lineno"> 1434</span>            <span class="keywordflow">if</span>(ss(iz).gt.0)<span class="keywordflow">then</span></div>
<div class="line"><a id="l01435" name="l01435"></a><span class="lineno"> 1435</span>               <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a6de67ff4391d9d6c0f924fb424e6b208">flux_flat</a>(dz,z0(id,iz),ua_u(iz),                  &amp;              </div>
<div class="line"><a id="l01436" name="l01436"></a><span class="lineno"> 1436</span>                       va_u(iz),pt_u(iz),pt0_u(iz),                   &amp;   </div>
<div class="line"><a id="l01437" name="l01437"></a><span class="lineno"> 1437</span>                       ptr(id,iz),uhb_u(id,iz),                       &amp;   </div>
<div class="line"><a id="l01438" name="l01438"></a><span class="lineno"> 1438</span>                       vhb_u(id,iz),thb_u(id,iz),ehb_u(id,iz))        </div>
<div class="line"><a id="l01439" name="l01439"></a><span class="lineno"> 1439</span>            <span class="keywordflow">else</span></div>
<div class="line"><a id="l01440" name="l01440"></a><span class="lineno"> 1440</span>               uhb_u(id,iz) = 0.0</div>
<div class="line"><a id="l01441" name="l01441"></a><span class="lineno"> 1441</span>               vhb_u(id,iz) = 0.0</div>
<div class="line"><a id="l01442" name="l01442"></a><span class="lineno"> 1442</span>               thb_u(id,iz) = 0.0</div>
<div class="line"><a id="l01443" name="l01443"></a><span class="lineno"> 1443</span>               ehb_u(id,iz) = 0.0</div>
<div class="line"><a id="l01444" name="l01444"></a><span class="lineno"> 1444</span><span class="keywordflow">            endif</span></div>
<div class="line"><a id="l01445" name="l01445"></a><span class="lineno"> 1445</span><span class="keywordflow">         end do</span></div>
<div class="line"><a id="l01446" name="l01446"></a><span class="lineno"> 1446</span> </div>
<div class="line"><a id="l01447" name="l01447"></a><span class="lineno"> 1447</span><span class="comment">!        Calculation at the wall surfaces         </span></div>
<div class="line"><a id="l01448" name="l01448"></a><span class="lineno"> 1448</span>         <span class="keywordflow">do</span> iz=1,nz         </div>
<div class="line"><a id="l01449" name="l01449"></a><span class="lineno"> 1449</span>            <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#afad1f5b9f81d43acb300a4ff02b17d33">flux_wall</a>(ua_u(iz),va_u(iz),pt_u(iz),da_u(iz),     &amp;  </div>
<div class="line"><a id="l01450" name="l01450"></a><span class="lineno"> 1450</span>                        ptw(2*id-1,iz),                             &amp;   </div>
<div class="line"><a id="l01451" name="l01451"></a><span class="lineno"> 1451</span>                        uva_u(2*id-1,iz),vva_u(2*id-1,iz),          &amp;   </div>
<div class="line"><a id="l01452" name="l01452"></a><span class="lineno"> 1452</span>                        uvb_u(2*id-1,iz),vvb_u(2*id-1,iz),          &amp;   </div>
<div class="line"><a id="l01453" name="l01453"></a><span class="lineno"> 1453</span>                        tva_u(2*id-1,iz),tvb_u(2*id-1,iz),          &amp;   </div>
<div class="line"><a id="l01454" name="l01454"></a><span class="lineno"> 1454</span>                        evb_u(2*id-1,iz),drst(id),dt)                  </div>
<div class="line"><a id="l01455" name="l01455"></a><span class="lineno"> 1455</span>                    </div>
<div class="line"><a id="l01456" name="l01456"></a><span class="lineno"> 1456</span>            <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#afad1f5b9f81d43acb300a4ff02b17d33">flux_wall</a>(ua_u(iz),va_u(iz),pt_u(iz),da_u(iz),    &amp;   </div>
<div class="line"><a id="l01457" name="l01457"></a><span class="lineno"> 1457</span>                        ptw(2*id,iz),                              &amp;    </div>
<div class="line"><a id="l01458" name="l01458"></a><span class="lineno"> 1458</span>                        uva_u(2*id,iz),vva_u(2*id,iz),             &amp;    </div>
<div class="line"><a id="l01459" name="l01459"></a><span class="lineno"> 1459</span>                        uvb_u(2*id,iz),vvb_u(2*id,iz),             &amp;    </div>
<div class="line"><a id="l01460" name="l01460"></a><span class="lineno"> 1460</span>                        tva_u(2*id,iz),tvb_u(2*id,iz),             &amp;   </div>
<div class="line"><a id="l01461" name="l01461"></a><span class="lineno"> 1461</span>                        evb_u(2*id,iz),drst(id),dt) </div>
<div class="line"><a id="l01462" name="l01462"></a><span class="lineno"> 1462</span><span class="comment">!</span></div>
<div class="line"><a id="l01463" name="l01463"></a><span class="lineno"> 1463</span>       </div>
<div class="line"><a id="l01464" name="l01464"></a><span class="lineno"> 1464</span><span class="keywordflow">         end do</span></div>
<div class="line"><a id="l01465" name="l01465"></a><span class="lineno"> 1465</span>         </div>
<div class="line"><a id="l01466" name="l01466"></a><span class="lineno"> 1466</span><span class="keywordflow">      end do</span></div>
<div class="line"><a id="l01467" name="l01467"></a><span class="lineno"> 1467</span>                </div>
<div class="line"><a id="l01468" name="l01468"></a><span class="lineno"> 1468</span>      <span class="keywordflow">return</span></div>
<div class="line"><a id="l01469" name="l01469"></a><span class="lineno"> 1469</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a873560a1932723dc6c6a6e31bebd91af">buildings</a></div>
<div class="line"><a id="l01470" name="l01470"></a><span class="lineno"> 1470</span>      </div>
<div class="line"><a id="l01471" name="l01471"></a><span class="lineno"> 1471</span> </div>
<div class="line"><a id="l01472" name="l01472"></a><span class="lineno"> 1472</span><span class="comment">! ===6=8===============================================================72</span></div>
<div class="line"><a id="l01473" name="l01473"></a><span class="lineno"> 1473</span><span class="comment">! ===6=8===============================================================72</span></div>
<div class="line"><a id="l01474" name="l01474"></a><span class="lineno"> 1474</span> </div>
<div class="line"><a id="l01475" name="l01475"></a><span class="lineno"><a class="line" href="namespacemodule__sf__bep.html#a279edcc0de78c52ec1a201aa9996e23f"> 1475</a></span>        <span class="keyword">subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a279edcc0de78c52ec1a201aa9996e23f">urban_meso</a>(nd,kms,kme,kts,kte,nz_u,z,dz,z_u,pb,ss,bs,ws,sf,vl,    &amp;</div>
<div class="line"><a id="l01476" name="l01476"></a><span class="lineno"> 1476</span>                             uva_u,vva_u,uvb_u,vvb_u,tva_u,tvb_u,evb_u, &amp;       </div>
<div class="line"><a id="l01477" name="l01477"></a><span class="lineno"> 1477</span>                             uhb_u,vhb_u,thb_u,ehb_u,                   &amp;      </div>
<div class="line"><a id="l01478" name="l01478"></a><span class="lineno"> 1478</span>                             a_u,a_v,a_t,a_e,b_u,b_v,b_t,b_e)           </div>
<div class="line"><a id="l01479" name="l01479"></a><span class="lineno"> 1479</span> </div>
<div class="line"><a id="l01480" name="l01480"></a><span class="lineno"> 1480</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01481" name="l01481"></a><span class="lineno"> 1481</span><span class="comment">!  This routine interpolates the parameters from the &quot;urban grid&quot; to the</span></div>
<div class="line"><a id="l01482" name="l01482"></a><span class="lineno"> 1482</span><span class="comment">!  &quot;mesoscale grid&quot;.</span></div>
<div class="line"><a id="l01483" name="l01483"></a><span class="lineno"> 1483</span><span class="comment">!  See p300-301 Appendix B.2 of the BLM paper.  </span></div>
<div class="line"><a id="l01484" name="l01484"></a><span class="lineno"> 1484</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01485" name="l01485"></a><span class="lineno"> 1485</span> </div>
<div class="line"><a id="l01486" name="l01486"></a><span class="lineno"> 1486</span>      <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l01487" name="l01487"></a><span class="lineno"> 1487</span> </div>
<div class="line"><a id="l01488" name="l01488"></a><span class="lineno"> 1488</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01489" name="l01489"></a><span class="lineno"> 1489</span><span class="comment">! INPUT:</span></div>
<div class="line"><a id="l01490" name="l01490"></a><span class="lineno"> 1490</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01491" name="l01491"></a><span class="lineno"> 1491</span><span class="comment">! Data relative to the &quot;mesoscale grid&quot;</span></div>
<div class="line"><a id="l01492" name="l01492"></a><span class="lineno"> 1492</span>      <span class="keywordtype">integer</span> kms,kme,kts,kte               </div>
<div class="line"><a id="l01493" name="l01493"></a><span class="lineno"> 1493</span><span class="keywordtype">      real</span> z(kms:kme)              <span class="comment">! Altitude above the ground of the cell interface</span></div>
<div class="line"><a id="l01494" name="l01494"></a><span class="lineno"> 1494</span><span class="keywordtype">      real</span> dz(kms:kme)               <span class="comment">! Vertical space steps</span></div>
<div class="line"><a id="l01495" name="l01495"></a><span class="lineno"> 1495</span> </div>
<div class="line"><a id="l01496" name="l01496"></a><span class="lineno"> 1496</span><span class="comment">! Data relative to the &quot;uban grid&quot;</span></div>
<div class="line"><a id="l01497" name="l01497"></a><span class="lineno"> 1497</span>      <span class="keywordtype">integer</span> nz_u              <span class="comment">! Number of layer in the urban grid</span></div>
<div class="line"><a id="l01498" name="l01498"></a><span class="lineno"> 1498</span>      <span class="keywordtype">integer</span> nd                <span class="comment">! Number of street direction for the current urban class</span></div>
<div class="line"><a id="l01499" name="l01499"></a><span class="lineno"> 1499</span><span class="keywordtype">      real</span> bs(ndm)              <span class="comment">! Building widths of the current urban class</span></div>
<div class="line"><a id="l01500" name="l01500"></a><span class="lineno"> 1500</span><span class="keywordtype">      real</span> ws(ndm)              <span class="comment">! Street widths of the current urban class</span></div>
<div class="line"><a id="l01501" name="l01501"></a><span class="lineno"> 1501</span><span class="keywordtype">      real</span> z_u(nz_um)         <span class="comment">! Height of the urban grid levels</span></div>
<div class="line"><a id="l01502" name="l01502"></a><span class="lineno"> 1502</span><span class="keywordtype">      real</span> pb(nz_um)          <span class="comment">! Probability to have a building with an height equal</span></div>
<div class="line"><a id="l01503" name="l01503"></a><span class="lineno"> 1503</span><span class="keywordtype">      real</span> ss(nz_um)          <span class="comment">! Probability to have a building with height h</span></div>
<div class="line"><a id="l01504" name="l01504"></a><span class="lineno"> 1504</span><span class="keywordtype">      real</span> uhb_u(ndm,nz_um)   <span class="comment">! U (x-wind component) Horizontal surfaces, B (explicit) term</span></div>
<div class="line"><a id="l01505" name="l01505"></a><span class="lineno"> 1505</span><span class="keywordtype">      real</span> uva_u(2*ndm,nz_um)   <span class="comment">! U (x-wind component) Vertical surfaces, A (implicit) term</span></div>
<div class="line"><a id="l01506" name="l01506"></a><span class="lineno"> 1506</span><span class="keywordtype">      real</span> uvb_u(2*ndm,nz_um)   <span class="comment">! U (x-wind component) Vertical surfaces, B (explicit) term</span></div>
<div class="line"><a id="l01507" name="l01507"></a><span class="lineno"> 1507</span><span class="keywordtype">      real</span> vhb_u(ndm,nz_um)   <span class="comment">! V (y-wind component) Horizontal surfaces, B (explicit) term</span></div>
<div class="line"><a id="l01508" name="l01508"></a><span class="lineno"> 1508</span><span class="keywordtype">      real</span> vva_u(2*ndm,nz_um)   <span class="comment">! V (y-wind component) Vertical surfaces, A (implicit) term</span></div>
<div class="line"><a id="l01509" name="l01509"></a><span class="lineno"> 1509</span><span class="keywordtype">      real</span> vvb_u(2*ndm,nz_um)   <span class="comment">! V (y-wind component) Vertical surfaces, B (explicit) term</span></div>
<div class="line"><a id="l01510" name="l01510"></a><span class="lineno"> 1510</span><span class="keywordtype">      real</span> thb_u(ndm,nz_um)   <span class="comment">! Temperature        Horizontal surfaces, B (explicit) term</span></div>
<div class="line"><a id="l01511" name="l01511"></a><span class="lineno"> 1511</span><span class="keywordtype">      real</span> tva_u(2*ndm,nz_um)   <span class="comment">! Temperature          Vertical surfaces, A (implicit) term</span></div>
<div class="line"><a id="l01512" name="l01512"></a><span class="lineno"> 1512</span><span class="keywordtype">      real</span> tvb_u(2*ndm,nz_um)   <span class="comment">! Temperature          Vertical surfaces, B (explicit) term</span></div>
<div class="line"><a id="l01513" name="l01513"></a><span class="lineno"> 1513</span><span class="keywordtype">      real</span> ehb_u(ndm,nz_um)   <span class="comment">! Energy (TKE)       Horizontal surfaces, B (explicit) term</span></div>
<div class="line"><a id="l01514" name="l01514"></a><span class="lineno"> 1514</span><span class="keywordtype">      real</span> evb_u(2*ndm,nz_um)   <span class="comment">! Energy (TKE)         Vertical surfaces, B (explicit) term</span></div>
<div class="line"><a id="l01515" name="l01515"></a><span class="lineno"> 1515</span> </div>
<div class="line"><a id="l01516" name="l01516"></a><span class="lineno"> 1516</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01517" name="l01517"></a><span class="lineno"> 1517</span><span class="comment">! OUTPUT:</span></div>
<div class="line"><a id="l01518" name="l01518"></a><span class="lineno"> 1518</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01519" name="l01519"></a><span class="lineno"> 1519</span><span class="comment">! Data relative to the &quot;mesoscale grid&quot;</span></div>
<div class="line"><a id="l01520" name="l01520"></a><span class="lineno"> 1520</span><span class="keywordtype">      real</span> sf(kms:kme)             <span class="comment">! Surface of the &quot;mesoscale grid&quot; cells taking into account the buildings</span></div>
<div class="line"><a id="l01521" name="l01521"></a><span class="lineno"> 1521</span><span class="keywordtype">      real</span> vl(kms:kme)               <span class="comment">! Volume of the &quot;mesoscale grid&quot; cells taking into account the buildings</span></div>
<div class="line"><a id="l01522" name="l01522"></a><span class="lineno"> 1522</span><span class="keywordtype">      real</span> a_u(kms:kme)              <span class="comment">! Implicit component of the momentum sources or sinks in the X-direction</span></div>
<div class="line"><a id="l01523" name="l01523"></a><span class="lineno"> 1523</span><span class="keywordtype">      real</span> a_v(kms:kme)              <span class="comment">! Implicit component of the momentum sources or sinks in the Y-direction</span></div>
<div class="line"><a id="l01524" name="l01524"></a><span class="lineno"> 1524</span><span class="keywordtype">      real</span> a_t(kms:kme)              <span class="comment">! Implicit component of the heat sources or sinks</span></div>
<div class="line"><a id="l01525" name="l01525"></a><span class="lineno"> 1525</span><span class="keywordtype">      real</span> a_e(kms:kme)              <span class="comment">! Implicit component of the TKE sources or sinks</span></div>
<div class="line"><a id="l01526" name="l01526"></a><span class="lineno"> 1526</span><span class="keywordtype">      real</span> b_u(kms:kme)              <span class="comment">! Explicit component of the momentum sources or sinks in the X-direction</span></div>
<div class="line"><a id="l01527" name="l01527"></a><span class="lineno"> 1527</span><span class="keywordtype">      real</span> b_v(kms:kme)              <span class="comment">! Explicit component of the momentum sources or sinks in the Y-direction</span></div>
<div class="line"><a id="l01528" name="l01528"></a><span class="lineno"> 1528</span><span class="keywordtype">      real</span> b_t(kms:kme)              <span class="comment">! Explicit component of the heat sources or sinks</span></div>
<div class="line"><a id="l01529" name="l01529"></a><span class="lineno"> 1529</span><span class="keywordtype">      real</span> b_e(kms:kme)              <span class="comment">! Explicit component of the TKE sources or sinks</span></div>
<div class="line"><a id="l01530" name="l01530"></a><span class="lineno"> 1530</span>      </div>
<div class="line"><a id="l01531" name="l01531"></a><span class="lineno"> 1531</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01532" name="l01532"></a><span class="lineno"> 1532</span><span class="comment">! LOCAL:</span></div>
<div class="line"><a id="l01533" name="l01533"></a><span class="lineno"> 1533</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01534" name="l01534"></a><span class="lineno"> 1534</span><span class="keywordtype">      real</span> dzz</div>
<div class="line"><a id="l01535" name="l01535"></a><span class="lineno"> 1535</span><span class="keywordtype">      real</span> fact</div>
<div class="line"><a id="l01536" name="l01536"></a><span class="lineno"> 1536</span>      <span class="keywordtype">integer</span> id,iz,iz_u</div>
<div class="line"><a id="l01537" name="l01537"></a><span class="lineno"> 1537</span><span class="keywordtype">      real</span> se,sr,st,su,sv</div>
<div class="line"><a id="l01538" name="l01538"></a><span class="lineno"> 1538</span><span class="keywordtype">      real</span> uet(kms:kme)                <span class="comment">! Contribution to TKE due to walls</span></div>
<div class="line"><a id="l01539" name="l01539"></a><span class="lineno"> 1539</span><span class="keywordtype">      real</span> veb,vta,vtb,vte,vtot,vua,vub,vva,vvb</div>
<div class="line"><a id="l01540" name="l01540"></a><span class="lineno"> 1540</span> </div>
<div class="line"><a id="l01541" name="l01541"></a><span class="lineno"> 1541</span> </div>
<div class="line"><a id="l01542" name="l01542"></a><span class="lineno"> 1542</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01543" name="l01543"></a><span class="lineno"> 1543</span><span class="comment">! END VARIABLES DEFINITIONS</span></div>
<div class="line"><a id="l01544" name="l01544"></a><span class="lineno"> 1544</span><span class="comment">! ---------------------------------------------------------------------- </span></div>
<div class="line"><a id="l01545" name="l01545"></a><span class="lineno"> 1545</span> </div>
<div class="line"><a id="l01546" name="l01546"></a><span class="lineno"> 1546</span><span class="comment">! initialisation</span></div>
<div class="line"><a id="l01547" name="l01547"></a><span class="lineno"> 1547</span> </div>
<div class="line"><a id="l01548" name="l01548"></a><span class="lineno"> 1548</span>      <span class="keywordflow">do</span> iz=kts,kte</div>
<div class="line"><a id="l01549" name="l01549"></a><span class="lineno"> 1549</span>         a_u(iz)=0.</div>
<div class="line"><a id="l01550" name="l01550"></a><span class="lineno"> 1550</span>         a_v(iz)=0.</div>
<div class="line"><a id="l01551" name="l01551"></a><span class="lineno"> 1551</span>         a_t(iz)=0.</div>
<div class="line"><a id="l01552" name="l01552"></a><span class="lineno"> 1552</span>         a_e(iz)=0.</div>
<div class="line"><a id="l01553" name="l01553"></a><span class="lineno"> 1553</span>         b_u(iz)=0.</div>
<div class="line"><a id="l01554" name="l01554"></a><span class="lineno"> 1554</span>         b_v(iz)=0.</div>
<div class="line"><a id="l01555" name="l01555"></a><span class="lineno"> 1555</span>         b_e(iz)=0.</div>
<div class="line"><a id="l01556" name="l01556"></a><span class="lineno"> 1556</span>         b_t(iz)=0.</div>
<div class="line"><a id="l01557" name="l01557"></a><span class="lineno"> 1557</span>         uet(iz)=0.</div>
<div class="line"><a id="l01558" name="l01558"></a><span class="lineno"> 1558</span><span class="keywordflow">      end do</span></div>
<div class="line"><a id="l01559" name="l01559"></a><span class="lineno"> 1559</span>            </div>
<div class="line"><a id="l01560" name="l01560"></a><span class="lineno"> 1560</span><span class="comment">! horizontal surfaces</span></div>
<div class="line"><a id="l01561" name="l01561"></a><span class="lineno"> 1561</span>      <span class="keywordflow">do</span> iz=kts,kte</div>
<div class="line"><a id="l01562" name="l01562"></a><span class="lineno"> 1562</span>         sf(iz)=0.</div>
<div class="line"><a id="l01563" name="l01563"></a><span class="lineno"> 1563</span>         vl(iz)=0.</div>
<div class="line"><a id="l01564" name="l01564"></a><span class="lineno"> 1564</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l01565" name="l01565"></a><span class="lineno"> 1565</span>      sf(kte+1)=0. </div>
<div class="line"><a id="l01566" name="l01566"></a><span class="lineno"> 1566</span>      </div>
<div class="line"><a id="l01567" name="l01567"></a><span class="lineno"> 1567</span>      <span class="keywordflow">do</span> id=1,nd      </div>
<div class="line"><a id="l01568" name="l01568"></a><span class="lineno"> 1568</span>         <span class="keywordflow">do</span> iz=kts+1,kte+1</div>
<div class="line"><a id="l01569" name="l01569"></a><span class="lineno"> 1569</span>            sr=0.</div>
<div class="line"><a id="l01570" name="l01570"></a><span class="lineno"> 1570</span>            <span class="keywordflow">do</span> iz_u=2,nz_u</div>
<div class="line"><a id="l01571" name="l01571"></a><span class="lineno"> 1571</span>               <span class="keywordflow">if</span>(z(iz).lt.z_u(iz_u).and.z(iz).ge.z_u(iz_u-1))<span class="keywordflow">then</span></div>
<div class="line"><a id="l01572" name="l01572"></a><span class="lineno"> 1572</span>                  sr=pb(iz_u)</div>
<div class="line"><a id="l01573" name="l01573"></a><span class="lineno"> 1573</span><span class="keywordflow">               endif</span></div>
<div class="line"><a id="l01574" name="l01574"></a><span class="lineno"> 1574</span><span class="keywordflow">            enddo</span></div>
<div class="line"><a id="l01575" name="l01575"></a><span class="lineno"> 1575</span>            sf(iz)=sf(iz)+((ws(id)+(1.-sr)*bs(id))/(ws(id)+bs(id)))/nd</div>
<div class="line"><a id="l01576" name="l01576"></a><span class="lineno"> 1576</span><span class="keywordflow">         enddo</span></div>
<div class="line"><a id="l01577" name="l01577"></a><span class="lineno"> 1577</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l01578" name="l01578"></a><span class="lineno"> 1578</span> </div>
<div class="line"><a id="l01579" name="l01579"></a><span class="lineno"> 1579</span><span class="comment">! volume      </span></div>
<div class="line"><a id="l01580" name="l01580"></a><span class="lineno"> 1580</span>      <span class="keywordflow">do</span> iz=kts,kte</div>
<div class="line"><a id="l01581" name="l01581"></a><span class="lineno"> 1581</span>         <span class="keywordflow">do</span> id=1,nd</div>
<div class="line"><a id="l01582" name="l01582"></a><span class="lineno"> 1582</span>            vtot=0.</div>
<div class="line"><a id="l01583" name="l01583"></a><span class="lineno"> 1583</span>            <span class="keywordflow">do</span> iz_u=1,nz_u</div>
<div class="line"><a id="l01584" name="l01584"></a><span class="lineno"> 1584</span>               dzz=max(min(z_u(iz_u+1),z(iz+1))-max(z_u(iz_u),z(iz)),0.)</div>
<div class="line"><a id="l01585" name="l01585"></a><span class="lineno"> 1585</span>               vtot=vtot+pb(iz_u+1)*dzz</div>
<div class="line"><a id="l01586" name="l01586"></a><span class="lineno"> 1586</span><span class="keywordflow">            enddo</span></div>
<div class="line"><a id="l01587" name="l01587"></a><span class="lineno"> 1587</span>            vtot=vtot/(z(iz+1)-z(iz))</div>
<div class="line"><a id="l01588" name="l01588"></a><span class="lineno"> 1588</span>            vl(iz)=vl(iz)+(1.-vtot*bs(id)/(ws(id)+bs(id)))/nd</div>
<div class="line"><a id="l01589" name="l01589"></a><span class="lineno"> 1589</span><span class="keywordflow">         enddo</span></div>
<div class="line"><a id="l01590" name="l01590"></a><span class="lineno"> 1590</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l01591" name="l01591"></a><span class="lineno"> 1591</span>      </div>
<div class="line"><a id="l01592" name="l01592"></a><span class="lineno"> 1592</span><span class="comment">! horizontal surface impact  </span></div>
<div class="line"><a id="l01593" name="l01593"></a><span class="lineno"> 1593</span> </div>
<div class="line"><a id="l01594" name="l01594"></a><span class="lineno"> 1594</span>      <span class="keywordflow">do</span> id=1,nd</div>
<div class="line"><a id="l01595" name="l01595"></a><span class="lineno"> 1595</span>      </div>
<div class="line"><a id="l01596" name="l01596"></a><span class="lineno"> 1596</span>         fact=1./vl(kts)/dz(kts)*ws(id)/(ws(id)+bs(id))/nd</div>
<div class="line"><a id="l01597" name="l01597"></a><span class="lineno"> 1597</span>         b_t(kts)=b_t(kts)+thb_u(id,1)*fact</div>
<div class="line"><a id="l01598" name="l01598"></a><span class="lineno"> 1598</span>         b_u(kts)=b_u(kts)+uhb_u(id,1)*fact</div>
<div class="line"><a id="l01599" name="l01599"></a><span class="lineno"> 1599</span>         b_v(kts)=b_v(kts)+vhb_u(id,1)*fact </div>
<div class="line"><a id="l01600" name="l01600"></a><span class="lineno"> 1600</span>         b_e(kts)=b_e(kts)+ehb_u(id,1)*fact*(z_u(2)-z_u(1))</div>
<div class="line"><a id="l01601" name="l01601"></a><span class="lineno"> 1601</span>         </div>
<div class="line"><a id="l01602" name="l01602"></a><span class="lineno"> 1602</span>         <span class="keywordflow">do</span> iz=kts,kte</div>
<div class="line"><a id="l01603" name="l01603"></a><span class="lineno"> 1603</span>            st=0.</div>
<div class="line"><a id="l01604" name="l01604"></a><span class="lineno"> 1604</span>            su=0.</div>
<div class="line"><a id="l01605" name="l01605"></a><span class="lineno"> 1605</span>            sv=0.</div>
<div class="line"><a id="l01606" name="l01606"></a><span class="lineno"> 1606</span>            se=0.</div>
<div class="line"><a id="l01607" name="l01607"></a><span class="lineno"> 1607</span>            <span class="keywordflow">do</span> iz_u=2,nz_u</div>
<div class="line"><a id="l01608" name="l01608"></a><span class="lineno"> 1608</span>               <span class="keywordflow">if</span>(z(iz).le.z_u(iz_u).and.z(iz+1).gt.z_u(iz_u))<span class="keywordflow">then</span></div>
<div class="line"><a id="l01609" name="l01609"></a><span class="lineno"> 1609</span>                  st=st+ss(iz_u)*thb_u(id,iz_u)</div>
<div class="line"><a id="l01610" name="l01610"></a><span class="lineno"> 1610</span>                  su=su+ss(iz_u)*uhb_u(id,iz_u)</div>
<div class="line"><a id="l01611" name="l01611"></a><span class="lineno"> 1611</span>                  sv=sv+ss(iz_u)*vhb_u(id,iz_u)          </div>
<div class="line"><a id="l01612" name="l01612"></a><span class="lineno"> 1612</span>                  se=se+ss(iz_u)*ehb_u(id,iz_u)*(z_u(iz_u+1)-z_u(iz_u))</div>
<div class="line"><a id="l01613" name="l01613"></a><span class="lineno"> 1613</span><span class="keywordflow">               endif</span></div>
<div class="line"><a id="l01614" name="l01614"></a><span class="lineno"> 1614</span><span class="keywordflow">            enddo</span></div>
<div class="line"><a id="l01615" name="l01615"></a><span class="lineno"> 1615</span>      </div>
<div class="line"><a id="l01616" name="l01616"></a><span class="lineno"> 1616</span>            fact=bs(id)/(ws(id)+bs(id))/vl(iz)/dz(iz)/nd</div>
<div class="line"><a id="l01617" name="l01617"></a><span class="lineno"> 1617</span>            b_t(iz)=b_t(iz)+st*fact</div>
<div class="line"><a id="l01618" name="l01618"></a><span class="lineno"> 1618</span>            b_u(iz)=b_u(iz)+su*fact</div>
<div class="line"><a id="l01619" name="l01619"></a><span class="lineno"> 1619</span>            b_v(iz)=b_v(iz)+sv*fact</div>
<div class="line"><a id="l01620" name="l01620"></a><span class="lineno"> 1620</span>            b_e(iz)=b_e(iz)+se*fact</div>
<div class="line"><a id="l01621" name="l01621"></a><span class="lineno"> 1621</span><span class="keywordflow">         enddo</span></div>
<div class="line"><a id="l01622" name="l01622"></a><span class="lineno"> 1622</span><span class="keywordflow">      enddo</span>              </div>
<div class="line"><a id="l01623" name="l01623"></a><span class="lineno"> 1623</span> </div>
<div class="line"><a id="l01624" name="l01624"></a><span class="lineno"> 1624</span><span class="comment">! vertical surface impact</span></div>
<div class="line"><a id="l01625" name="l01625"></a><span class="lineno"> 1625</span>           </div>
<div class="line"><a id="l01626" name="l01626"></a><span class="lineno"> 1626</span>      <span class="keywordflow">do</span> iz=kts,kte </div>
<div class="line"><a id="l01627" name="l01627"></a><span class="lineno"> 1627</span>         uet(iz)=0.</div>
<div class="line"><a id="l01628" name="l01628"></a><span class="lineno"> 1628</span>         <span class="keywordflow">do</span> id=1,nd              </div>
<div class="line"><a id="l01629" name="l01629"></a><span class="lineno"> 1629</span>            vtb=0.</div>
<div class="line"><a id="l01630" name="l01630"></a><span class="lineno"> 1630</span>            vta=0.</div>
<div class="line"><a id="l01631" name="l01631"></a><span class="lineno"> 1631</span>            vua=0.</div>
<div class="line"><a id="l01632" name="l01632"></a><span class="lineno"> 1632</span>            vub=0.</div>
<div class="line"><a id="l01633" name="l01633"></a><span class="lineno"> 1633</span>            vva=0.</div>
<div class="line"><a id="l01634" name="l01634"></a><span class="lineno"> 1634</span>            vvb=0.</div>
<div class="line"><a id="l01635" name="l01635"></a><span class="lineno"> 1635</span>            veb=0.</div>
<div class="line"><a id="l01636" name="l01636"></a><span class="lineno"> 1636</span>        vte=0.</div>
<div class="line"><a id="l01637" name="l01637"></a><span class="lineno"> 1637</span>            <span class="keywordflow">do</span> iz_u=1,nz_u</div>
<div class="line"><a id="l01638" name="l01638"></a><span class="lineno"> 1638</span>               dzz=max(min(z_u(iz_u+1),z(iz+1))-max(z_u(iz_u),z(iz)),0.)</div>
<div class="line"><a id="l01639" name="l01639"></a><span class="lineno"> 1639</span>               fact=dzz/(ws(id)+bs(id))</div>
<div class="line"><a id="l01640" name="l01640"></a><span class="lineno"> 1640</span>               vtb=vtb+pb(iz_u+1)*                                  &amp;        </div>
<div class="line"><a id="l01641" name="l01641"></a><span class="lineno"> 1641</span>                    (tvb_u(2*id-1,iz_u)+tvb_u(2*id,iz_u))*fact   </div>
<div class="line"><a id="l01642" name="l01642"></a><span class="lineno"> 1642</span>               vta=vta+pb(iz_u+1)*                                  &amp;        </div>
<div class="line"><a id="l01643" name="l01643"></a><span class="lineno"> 1643</span>                   (tva_u(2*id-1,iz_u)+tva_u(2*id,iz_u))*fact</div>
<div class="line"><a id="l01644" name="l01644"></a><span class="lineno"> 1644</span>               vua=vua+pb(iz_u+1)*                                  &amp;        </div>
<div class="line"><a id="l01645" name="l01645"></a><span class="lineno"> 1645</span>                    (uva_u(2*id-1,iz_u)+uva_u(2*id,iz_u))*fact</div>
<div class="line"><a id="l01646" name="l01646"></a><span class="lineno"> 1646</span>               vva=vva+pb(iz_u+1)*                                  &amp;        </div>
<div class="line"><a id="l01647" name="l01647"></a><span class="lineno"> 1647</span>                    (vva_u(2*id-1,iz_u)+vva_u(2*id,iz_u))*fact</div>
<div class="line"><a id="l01648" name="l01648"></a><span class="lineno"> 1648</span>               vub=vub+pb(iz_u+1)*                                  &amp;        </div>
<div class="line"><a id="l01649" name="l01649"></a><span class="lineno"> 1649</span>                    (uvb_u(2*id-1,iz_u)+uvb_u(2*id,iz_u))*fact</div>
<div class="line"><a id="l01650" name="l01650"></a><span class="lineno"> 1650</span>               vvb=vvb+pb(iz_u+1)*                                  &amp;        </div>
<div class="line"><a id="l01651" name="l01651"></a><span class="lineno"> 1651</span>                    (vvb_u(2*id-1,iz_u)+vvb_u(2*id,iz_u))*fact</div>
<div class="line"><a id="l01652" name="l01652"></a><span class="lineno"> 1652</span>               veb=veb+pb(iz_u+1)*                                  &amp;        </div>
<div class="line"><a id="l01653" name="l01653"></a><span class="lineno"> 1653</span>                    (evb_u(2*id-1,iz_u)+evb_u(2*id,iz_u))*fact</div>
<div class="line"><a id="l01654" name="l01654"></a><span class="lineno"> 1654</span><span class="keywordflow">            enddo</span></div>
<div class="line"><a id="l01655" name="l01655"></a><span class="lineno"> 1655</span>           </div>
<div class="line"><a id="l01656" name="l01656"></a><span class="lineno"> 1656</span>            fact=1./vl(iz)/dz(iz)/nd</div>
<div class="line"><a id="l01657" name="l01657"></a><span class="lineno"> 1657</span>            b_t(iz)=b_t(iz)+vtb*fact</div>
<div class="line"><a id="l01658" name="l01658"></a><span class="lineno"> 1658</span>            a_t(iz)=a_t(iz)+vta*fact</div>
<div class="line"><a id="l01659" name="l01659"></a><span class="lineno"> 1659</span>            a_u(iz)=a_u(iz)+vua*fact</div>
<div class="line"><a id="l01660" name="l01660"></a><span class="lineno"> 1660</span>            a_v(iz)=a_v(iz)+vva*fact</div>
<div class="line"><a id="l01661" name="l01661"></a><span class="lineno"> 1661</span>            b_u(iz)=b_u(iz)+vub*fact</div>
<div class="line"><a id="l01662" name="l01662"></a><span class="lineno"> 1662</span>            b_v(iz)=b_v(iz)+vvb*fact</div>
<div class="line"><a id="l01663" name="l01663"></a><span class="lineno"> 1663</span>            b_e(iz)=b_e(iz)+veb*fact</div>
<div class="line"><a id="l01664" name="l01664"></a><span class="lineno"> 1664</span>            uet(iz)=uet(iz)+vte*fact</div>
<div class="line"><a id="l01665" name="l01665"></a><span class="lineno"> 1665</span><span class="keywordflow">         enddo</span>              </div>
<div class="line"><a id="l01666" name="l01666"></a><span class="lineno"> 1666</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l01667" name="l01667"></a><span class="lineno"> 1667</span>      </div>
<div class="line"><a id="l01668" name="l01668"></a><span class="lineno"> 1668</span> </div>
<div class="line"><a id="l01669" name="l01669"></a><span class="lineno"> 1669</span>      </div>
<div class="line"><a id="l01670" name="l01670"></a><span class="lineno"> 1670</span>      <span class="keywordflow">return</span></div>
<div class="line"><a id="l01671" name="l01671"></a><span class="lineno"> 1671</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a279edcc0de78c52ec1a201aa9996e23f">urban_meso</a></div>
<div class="line"><a id="l01672" name="l01672"></a><span class="lineno"> 1672</span> </div>
<div class="line"><a id="l01673" name="l01673"></a><span class="lineno"> 1673</span><span class="comment">! ===6=8===============================================================72 </span></div>
<div class="line"><a id="l01674" name="l01674"></a><span class="lineno"> 1674</span> </div>
<div class="line"><a id="l01675" name="l01675"></a><span class="lineno"> 1675</span><span class="comment">! ===6=8===============================================================72 </span></div>
<div class="line"><a id="l01676" name="l01676"></a><span class="lineno"> 1676</span> </div>
<div class="line"><a id="l01677" name="l01677"></a><span class="lineno"><a class="line" href="namespacemodule__sf__bep.html#ab4c5155d2e31a1453a93508d2b63de18"> 1677</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#ab4c5155d2e31a1453a93508d2b63de18">interp_length</a>(nd,kms,kme,kts,kte,nz_u,z_u,z,ss,ws,bs,              &amp;</div>
<div class="line"><a id="l01678" name="l01678"></a><span class="lineno"> 1678</span>                             dlg,dl_u)</div>
<div class="line"><a id="l01679" name="l01679"></a><span class="lineno"> 1679</span> </div>
<div class="line"><a id="l01680" name="l01680"></a><span class="lineno"> 1680</span><span class="comment">! ----------------------------------------------------------------------     </span></div>
<div class="line"><a id="l01681" name="l01681"></a><span class="lineno"> 1681</span><span class="comment">!    Calculation of the length scales</span></div>
<div class="line"><a id="l01682" name="l01682"></a><span class="lineno"> 1682</span><span class="comment">!    See p272-274 formula (22) and (24) of the BLM paper    </span></div>
<div class="line"><a id="l01683" name="l01683"></a><span class="lineno"> 1683</span><span class="comment">! ----------------------------------------------------------------------     </span></div>
<div class="line"><a id="l01684" name="l01684"></a><span class="lineno"> 1684</span>     </div>
<div class="line"><a id="l01685" name="l01685"></a><span class="lineno"> 1685</span>      <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l01686" name="l01686"></a><span class="lineno"> 1686</span> </div>
<div class="line"><a id="l01687" name="l01687"></a><span class="lineno"> 1687</span> </div>
<div class="line"><a id="l01688" name="l01688"></a><span class="lineno"> 1688</span><span class="comment">! ----------------------------------------------------------------------     </span></div>
<div class="line"><a id="l01689" name="l01689"></a><span class="lineno"> 1689</span><span class="comment">! INPUT:</span></div>
<div class="line"><a id="l01690" name="l01690"></a><span class="lineno"> 1690</span><span class="comment">! ----------------------------------------------------------------------     </span></div>
<div class="line"><a id="l01691" name="l01691"></a><span class="lineno"> 1691</span>      <span class="keywordtype">integer</span> kms,kme,kts,kte                </div>
<div class="line"><a id="l01692" name="l01692"></a><span class="lineno"> 1692</span><span class="keywordtype">      real</span> z(kms:kme)              <span class="comment">! Altitude above the ground of the cell interface</span></div>
<div class="line"><a id="l01693" name="l01693"></a><span class="lineno"> 1693</span>      <span class="keywordtype">integer</span> nd                <span class="comment">! Number of street direction for the current urban class</span></div>
<div class="line"><a id="l01694" name="l01694"></a><span class="lineno"> 1694</span>      <span class="keywordtype">integer</span> nz_u              <span class="comment">! Number of levels in the &quot;urban grid&quot;</span></div>
<div class="line"><a id="l01695" name="l01695"></a><span class="lineno"> 1695</span><span class="keywordtype">      real</span> z_u(nz_um)         <span class="comment">! Height of the urban grid levels</span></div>
<div class="line"><a id="l01696" name="l01696"></a><span class="lineno"> 1696</span><span class="keywordtype">      real</span> bs(ndm)              <span class="comment">! Building widths of the current urban class</span></div>
<div class="line"><a id="l01697" name="l01697"></a><span class="lineno"> 1697</span><span class="keywordtype">      real</span> ss(nz_um)          <span class="comment">! Probability to have a building with height h</span></div>
<div class="line"><a id="l01698" name="l01698"></a><span class="lineno"> 1698</span><span class="keywordtype">      real</span> ws(ndm)              <span class="comment">! Street widths of the current urban class</span></div>
<div class="line"><a id="l01699" name="l01699"></a><span class="lineno"> 1699</span> </div>
<div class="line"><a id="l01700" name="l01700"></a><span class="lineno"> 1700</span> </div>
<div class="line"><a id="l01701" name="l01701"></a><span class="lineno"> 1701</span><span class="comment">! ----------------------------------------------------------------------     </span></div>
<div class="line"><a id="l01702" name="l01702"></a><span class="lineno"> 1702</span><span class="comment">! OUTPUT:</span></div>
<div class="line"><a id="l01703" name="l01703"></a><span class="lineno"> 1703</span><span class="comment">! ----------------------------------------------------------------------     </span></div>
<div class="line"><a id="l01704" name="l01704"></a><span class="lineno"> 1704</span><span class="keywordtype">      real</span> dlg(kms:kme)              <span class="comment">! Height above ground (L_ground in formula (24) of the BLM paper). </span></div>
<div class="line"><a id="l01705" name="l01705"></a><span class="lineno"> 1705</span><span class="keywordtype">      real</span> dl_u(kms:kme)             <span class="comment">! Length scale (lb in formula (22) ofthe BLM paper).</span></div>
<div class="line"><a id="l01706" name="l01706"></a><span class="lineno"> 1706</span> </div>
<div class="line"><a id="l01707" name="l01707"></a><span class="lineno"> 1707</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01708" name="l01708"></a><span class="lineno"> 1708</span><span class="comment">! LOCAL:</span></div>
<div class="line"><a id="l01709" name="l01709"></a><span class="lineno"> 1709</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01710" name="l01710"></a><span class="lineno"> 1710</span><span class="keywordtype">      real</span> dlgtmp</div>
<div class="line"><a id="l01711" name="l01711"></a><span class="lineno"> 1711</span>      <span class="keywordtype">integer</span> id,iz,iz_u</div>
<div class="line"><a id="l01712" name="l01712"></a><span class="lineno"> 1712</span><span class="keywordtype">      real</span> sftot</div>
<div class="line"><a id="l01713" name="l01713"></a><span class="lineno"> 1713</span><span class="keywordtype">      real</span> ulu,ssl</div>
<div class="line"><a id="l01714" name="l01714"></a><span class="lineno"> 1714</span> </div>
<div class="line"><a id="l01715" name="l01715"></a><span class="lineno"> 1715</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01716" name="l01716"></a><span class="lineno"> 1716</span><span class="comment">! END VARIABLES DEFINITIONS</span></div>
<div class="line"><a id="l01717" name="l01717"></a><span class="lineno"> 1717</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01718" name="l01718"></a><span class="lineno"> 1718</span>   </div>
<div class="line"><a id="l01719" name="l01719"></a><span class="lineno"> 1719</span>        <span class="keywordflow">do</span> iz=kts,kte</div>
<div class="line"><a id="l01720" name="l01720"></a><span class="lineno"> 1720</span>         ulu=0.</div>
<div class="line"><a id="l01721" name="l01721"></a><span class="lineno"> 1721</span>         ssl=0.</div>
<div class="line"><a id="l01722" name="l01722"></a><span class="lineno"> 1722</span>         <span class="keywordflow">do</span> id=1,nd        </div>
<div class="line"><a id="l01723" name="l01723"></a><span class="lineno"> 1723</span>          <span class="keywordflow">do</span> iz_u=2,nz_u</div>
<div class="line"><a id="l01724" name="l01724"></a><span class="lineno"> 1724</span>           <span class="keywordflow">if</span>(z_u(iz_u).gt.z(iz))<span class="keywordflow">then</span></div>
<div class="line"><a id="l01725" name="l01725"></a><span class="lineno"> 1725</span>            ulu=ulu+ss(iz_u)/z_u(iz_u)/nd</div>
<div class="line"><a id="l01726" name="l01726"></a><span class="lineno"> 1726</span>            ssl=ssl+ss(iz_u)/nd</div>
<div class="line"><a id="l01727" name="l01727"></a><span class="lineno"> 1727</span><span class="keywordflow">           endif</span></div>
<div class="line"><a id="l01728" name="l01728"></a><span class="lineno"> 1728</span><span class="keywordflow">          enddo</span></div>
<div class="line"><a id="l01729" name="l01729"></a><span class="lineno"> 1729</span><span class="keywordflow">         enddo</span></div>
<div class="line"><a id="l01730" name="l01730"></a><span class="lineno"> 1730</span> </div>
<div class="line"><a id="l01731" name="l01731"></a><span class="lineno"> 1731</span>        <span class="keywordflow">if</span>(ulu.ne.0)<span class="keywordflow">then</span></div>
<div class="line"><a id="l01732" name="l01732"></a><span class="lineno"> 1732</span>          dl_u(iz)=ssl/ulu</div>
<div class="line"><a id="l01733" name="l01733"></a><span class="lineno"> 1733</span>         <span class="keywordflow">else</span></div>
<div class="line"><a id="l01734" name="l01734"></a><span class="lineno"> 1734</span>          dl_u(iz)=0.</div>
<div class="line"><a id="l01735" name="l01735"></a><span class="lineno"> 1735</span><span class="keywordflow">         endif</span></div>
<div class="line"><a id="l01736" name="l01736"></a><span class="lineno"> 1736</span><span class="keywordflow">        enddo</span></div>
<div class="line"><a id="l01737" name="l01737"></a><span class="lineno"> 1737</span>       </div>
<div class="line"><a id="l01738" name="l01738"></a><span class="lineno"> 1738</span> </div>
<div class="line"><a id="l01739" name="l01739"></a><span class="lineno"> 1739</span>        <span class="keywordflow">do</span> iz=kts,kte</div>
<div class="line"><a id="l01740" name="l01740"></a><span class="lineno"> 1740</span>         dlg(iz)=0.</div>
<div class="line"><a id="l01741" name="l01741"></a><span class="lineno"> 1741</span>          <span class="keywordflow">do</span> id=1,nd</div>
<div class="line"><a id="l01742" name="l01742"></a><span class="lineno"> 1742</span>           sftot=ws(id)  </div>
<div class="line"><a id="l01743" name="l01743"></a><span class="lineno"> 1743</span>           dlgtmp=ws(id)/((z(iz)+z(iz+1))/2.)</div>
<div class="line"><a id="l01744" name="l01744"></a><span class="lineno"> 1744</span>           <span class="keywordflow">do</span> iz_u=1,nz_u</div>
<div class="line"><a id="l01745" name="l01745"></a><span class="lineno"> 1745</span>            <span class="keywordflow">if</span>((z(iz)+z(iz+1))/2..gt.z_u(iz_u))<span class="keywordflow">then</span></div>
<div class="line"><a id="l01746" name="l01746"></a><span class="lineno"> 1746</span>             dlgtmp=dlgtmp+ss(iz_u)*bs(id)/                           &amp;                </div>
<div class="line"><a id="l01747" name="l01747"></a><span class="lineno"> 1747</span>                    ((z(iz)+z(iz+1))/2.-z_u(iz_u))</div>
<div class="line"><a id="l01748" name="l01748"></a><span class="lineno"> 1748</span>             sftot=sftot+ss(iz_u)*bs(id)</div>
<div class="line"><a id="l01749" name="l01749"></a><span class="lineno"> 1749</span><span class="keywordflow">            endif</span></div>
<div class="line"><a id="l01750" name="l01750"></a><span class="lineno"> 1750</span><span class="keywordflow">           enddo</span></div>
<div class="line"><a id="l01751" name="l01751"></a><span class="lineno"> 1751</span>           dlg(iz)=dlg(iz)+dlgtmp/sftot/nd</div>
<div class="line"><a id="l01752" name="l01752"></a><span class="lineno"> 1752</span><span class="keywordflow">         enddo</span></div>
<div class="line"><a id="l01753" name="l01753"></a><span class="lineno"> 1753</span>         dlg(iz)=1./dlg(iz)</div>
<div class="line"><a id="l01754" name="l01754"></a><span class="lineno"> 1754</span><span class="keywordflow">        enddo</span></div>
<div class="line"><a id="l01755" name="l01755"></a><span class="lineno"> 1755</span>        </div>
<div class="line"><a id="l01756" name="l01756"></a><span class="lineno"> 1756</span>       <span class="keywordflow">return</span></div>
<div class="line"><a id="l01757" name="l01757"></a><span class="lineno"> 1757</span>       <span class="keyword">end subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#ab4c5155d2e31a1453a93508d2b63de18">interp_length</a></div>
<div class="line"><a id="l01758" name="l01758"></a><span class="lineno"> 1758</span> </div>
<div class="line"><a id="l01759" name="l01759"></a><span class="lineno"> 1759</span><span class="comment">! ===6=8===============================================================72</span></div>
<div class="line"><a id="l01760" name="l01760"></a><span class="lineno"> 1760</span><span class="comment">! ===6=8===============================================================72   </span></div>
<div class="line"><a id="l01761" name="l01761"></a><span class="lineno"> 1761</span> </div>
<div class="line"><a id="l01762" name="l01762"></a><span class="lineno"><a class="line" href="namespacemodule__sf__bep.html#adc1740fecdbbc88a536fda2c456b1e2d"> 1762</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#adc1740fecdbbc88a536fda2c456b1e2d">shadow_mas</a>(nd,nz_u,zr,deltar,ah,drst,ws,ss,pb,z,         &amp;</div>
<div class="line"><a id="l01763" name="l01763"></a><span class="lineno"> 1763</span>                           rs,rsw,rsg)</div>
<div class="line"><a id="l01764" name="l01764"></a><span class="lineno"> 1764</span>        </div>
<div class="line"><a id="l01765" name="l01765"></a><span class="lineno"> 1765</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01766" name="l01766"></a><span class="lineno"> 1766</span><span class="comment">!         Modification of short wave radiation to take into account</span></div>
<div class="line"><a id="l01767" name="l01767"></a><span class="lineno"> 1767</span><span class="comment">!         the shadow produced by the buildings</span></div>
<div class="line"><a id="l01768" name="l01768"></a><span class="lineno"> 1768</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01769" name="l01769"></a><span class="lineno"> 1769</span> </div>
<div class="line"><a id="l01770" name="l01770"></a><span class="lineno"> 1770</span>      <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l01771" name="l01771"></a><span class="lineno"> 1771</span>     </div>
<div class="line"><a id="l01772" name="l01772"></a><span class="lineno"> 1772</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01773" name="l01773"></a><span class="lineno"> 1773</span><span class="comment">! INPUT:</span></div>
<div class="line"><a id="l01774" name="l01774"></a><span class="lineno"> 1774</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01775" name="l01775"></a><span class="lineno"> 1775</span>      <span class="keywordtype">integer</span> nd                <span class="comment">! Number of street direction for the current urban class</span></div>
<div class="line"><a id="l01776" name="l01776"></a><span class="lineno"> 1776</span>      <span class="keywordtype">integer</span> nz_u              <span class="comment">! number of vertical layers defined in the urban grid</span></div>
<div class="line"><a id="l01777" name="l01777"></a><span class="lineno"> 1777</span><span class="keywordtype">      real</span> ah                   <span class="comment">! Hour angle (it should come from the radiation routine)</span></div>
<div class="line"><a id="l01778" name="l01778"></a><span class="lineno"> 1778</span><span class="keywordtype">      real</span> deltar               <span class="comment">! Declination of the sun</span></div>
<div class="line"><a id="l01779" name="l01779"></a><span class="lineno"> 1779</span><span class="keywordtype">      real</span> drst(ndm)            <span class="comment">! street directions for the current urban class</span></div>
<div class="line"><a id="l01780" name="l01780"></a><span class="lineno"> 1780</span><span class="keywordtype">      real</span> rs                   <span class="comment">! solar radiation</span></div>
<div class="line"><a id="l01781" name="l01781"></a><span class="lineno"> 1781</span><span class="keywordtype">      real</span> ss(nz_um)          <span class="comment">! probability to have a building with height h</span></div>
<div class="line"><a id="l01782" name="l01782"></a><span class="lineno"> 1782</span><span class="keywordtype">      real</span> pb(nz_um)          <span class="comment">! Probability that a building has an height greater or equal to h</span></div>
<div class="line"><a id="l01783" name="l01783"></a><span class="lineno"> 1783</span><span class="keywordtype">      real</span> ws(ndm)              <span class="comment">! Street width of the current urban class</span></div>
<div class="line"><a id="l01784" name="l01784"></a><span class="lineno"> 1784</span><span class="keywordtype">      real</span> z(nz_um)           <span class="comment">! Height of the urban grid levels</span></div>
<div class="line"><a id="l01785" name="l01785"></a><span class="lineno"> 1785</span><span class="keywordtype">      real</span> zr                   <span class="comment">! zenith angle</span></div>
<div class="line"><a id="l01786" name="l01786"></a><span class="lineno"> 1786</span> </div>
<div class="line"><a id="l01787" name="l01787"></a><span class="lineno"> 1787</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01788" name="l01788"></a><span class="lineno"> 1788</span><span class="comment">! OUTPUT:</span></div>
<div class="line"><a id="l01789" name="l01789"></a><span class="lineno"> 1789</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01790" name="l01790"></a><span class="lineno"> 1790</span><span class="keywordtype">      real</span> rsg(ndm)             <span class="comment">! Short wave radiation at the ground</span></div>
<div class="line"><a id="l01791" name="l01791"></a><span class="lineno"> 1791</span><span class="keywordtype">      real</span> rsw(2*ndm,nz_um)     <span class="comment">! Short wave radiation at the walls</span></div>
<div class="line"><a id="l01792" name="l01792"></a><span class="lineno"> 1792</span> </div>
<div class="line"><a id="l01793" name="l01793"></a><span class="lineno"> 1793</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01794" name="l01794"></a><span class="lineno"> 1794</span><span class="comment">! LOCAL:</span></div>
<div class="line"><a id="l01795" name="l01795"></a><span class="lineno"> 1795</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01796" name="l01796"></a><span class="lineno"> 1796</span>      <span class="keywordtype">integer</span> id,iz,jz</div>
<div class="line"><a id="l01797" name="l01797"></a><span class="lineno"> 1797</span><span class="keywordtype">      real</span> aae,aaw,bbb,phix,rd,rtot,wsd</div>
<div class="line"><a id="l01798" name="l01798"></a><span class="lineno"> 1798</span>      </div>
<div class="line"><a id="l01799" name="l01799"></a><span class="lineno"> 1799</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01800" name="l01800"></a><span class="lineno"> 1800</span><span class="comment">! END VARIABLES DEFINITIONS</span></div>
<div class="line"><a id="l01801" name="l01801"></a><span class="lineno"> 1801</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01802" name="l01802"></a><span class="lineno"> 1802</span> </div>
<div class="line"><a id="l01803" name="l01803"></a><span class="lineno"> 1803</span>      <span class="keywordflow">if</span>(rs.eq.0.or.sin(zr).eq.1)<span class="keywordflow">then</span></div>
<div class="line"><a id="l01804" name="l01804"></a><span class="lineno"> 1804</span>         <span class="keywordflow">do</span> id=1,nd</div>
<div class="line"><a id="l01805" name="l01805"></a><span class="lineno"> 1805</span>            rsg(id)=0.</div>
<div class="line"><a id="l01806" name="l01806"></a><span class="lineno"> 1806</span>            <span class="keywordflow">do</span> iz=1,nz_u</div>
<div class="line"><a id="l01807" name="l01807"></a><span class="lineno"> 1807</span>               rsw(2*id-1,iz)=0.</div>
<div class="line"><a id="l01808" name="l01808"></a><span class="lineno"> 1808</span>               rsw(2*id,iz)=0.</div>
<div class="line"><a id="l01809" name="l01809"></a><span class="lineno"> 1809</span><span class="keywordflow">            enddo</span></div>
<div class="line"><a id="l01810" name="l01810"></a><span class="lineno"> 1810</span><span class="keywordflow">         enddo</span></div>
<div class="line"><a id="l01811" name="l01811"></a><span class="lineno"> 1811</span>      <span class="keywordflow">else</span>            </div>
<div class="line"><a id="l01812" name="l01812"></a><span class="lineno"> 1812</span><span class="comment">!test              </span></div>
<div class="line"><a id="l01813" name="l01813"></a><span class="lineno"> 1813</span>         <span class="keywordflow">if</span>(abs(sin(zr)).gt.1.e-10)<span class="keywordflow">then</span></div>
<div class="line"><a id="l01814" name="l01814"></a><span class="lineno"> 1814</span>          <span class="keywordflow">if</span>(cos(deltar)*sin(ah)/sin(zr).ge.1)<span class="keywordflow">then</span></div>
<div class="line"><a id="l01815" name="l01815"></a><span class="lineno"> 1815</span>           bbb=<a class="code hl_variable" href="namespacemodule__sf__bep.html#a43054ed4c98f3ac9e3a5dc324ec7458f">pi</a>/2.</div>
<div class="line"><a id="l01816" name="l01816"></a><span class="lineno"> 1816</span>          <span class="keywordflow">elseif</span>(cos(deltar)*sin(ah)/sin(zr).le.-1)<span class="keywordflow">then</span></div>
<div class="line"><a id="l01817" name="l01817"></a><span class="lineno"> 1817</span>           bbb=-<a class="code hl_variable" href="namespacemodule__sf__bep.html#a43054ed4c98f3ac9e3a5dc324ec7458f">pi</a>/2.</div>
<div class="line"><a id="l01818" name="l01818"></a><span class="lineno"> 1818</span>          <span class="keywordflow">else</span></div>
<div class="line"><a id="l01819" name="l01819"></a><span class="lineno"> 1819</span>           bbb=asin(cos(deltar)*sin(ah)/sin(zr))</div>
<div class="line"><a id="l01820" name="l01820"></a><span class="lineno"> 1820</span><span class="keywordflow">          endif</span></div>
<div class="line"><a id="l01821" name="l01821"></a><span class="lineno"> 1821</span>         <span class="keywordflow">else</span></div>
<div class="line"><a id="l01822" name="l01822"></a><span class="lineno"> 1822</span>          <span class="keywordflow">if</span>(cos(deltar)*sin(ah).ge.0)<span class="keywordflow">then</span></div>
<div class="line"><a id="l01823" name="l01823"></a><span class="lineno"> 1823</span>           bbb=<a class="code hl_variable" href="namespacemodule__sf__bep.html#a43054ed4c98f3ac9e3a5dc324ec7458f">pi</a>/2.</div>
<div class="line"><a id="l01824" name="l01824"></a><span class="lineno"> 1824</span>          <span class="keywordflow">elseif</span>(cos(deltar)*sin(ah).lt.0)<span class="keywordflow">then</span></div>
<div class="line"><a id="l01825" name="l01825"></a><span class="lineno"> 1825</span>           bbb=-<a class="code hl_variable" href="namespacemodule__sf__bep.html#a43054ed4c98f3ac9e3a5dc324ec7458f">pi</a>/2.</div>
<div class="line"><a id="l01826" name="l01826"></a><span class="lineno"> 1826</span><span class="keywordflow">          endif</span></div>
<div class="line"><a id="l01827" name="l01827"></a><span class="lineno"> 1827</span><span class="keywordflow">         endif</span></div>
<div class="line"><a id="l01828" name="l01828"></a><span class="lineno"> 1828</span> </div>
<div class="line"><a id="l01829" name="l01829"></a><span class="lineno"> 1829</span>         phix=zr</div>
<div class="line"><a id="l01830" name="l01830"></a><span class="lineno"> 1830</span>           </div>
<div class="line"><a id="l01831" name="l01831"></a><span class="lineno"> 1831</span>         <span class="keywordflow">do</span> id=1,nd</div>
<div class="line"><a id="l01832" name="l01832"></a><span class="lineno"> 1832</span>        </div>
<div class="line"><a id="l01833" name="l01833"></a><span class="lineno"> 1833</span>            rsg(id)=0.</div>
<div class="line"><a id="l01834" name="l01834"></a><span class="lineno"> 1834</span>           </div>
<div class="line"><a id="l01835" name="l01835"></a><span class="lineno"> 1835</span>            aae=bbb-drst(id)</div>
<div class="line"><a id="l01836" name="l01836"></a><span class="lineno"> 1836</span>            aaw=bbb-drst(id)+<a class="code hl_variable" href="namespacemodule__sf__bep.html#a43054ed4c98f3ac9e3a5dc324ec7458f">pi</a></div>
<div class="line"><a id="l01837" name="l01837"></a><span class="lineno"> 1837</span>                    </div>
<div class="line"><a id="l01838" name="l01838"></a><span class="lineno"> 1838</span>            <span class="keywordflow">do</span> iz=1,nz_u</div>
<div class="line"><a id="l01839" name="l01839"></a><span class="lineno"> 1839</span>               rsw(2*id-1,iz)=0.</div>
<div class="line"><a id="l01840" name="l01840"></a><span class="lineno"> 1840</span>               rsw(2*id,iz)=0.          </div>
<div class="line"><a id="l01841" name="l01841"></a><span class="lineno"> 1841</span>            <span class="keywordflow">if</span>(pb(iz+1).gt.0.)<span class="keywordflow">then</span>           </div>
<div class="line"><a id="l01842" name="l01842"></a><span class="lineno"> 1842</span>               <span class="keywordflow">do</span> jz=1,nz_u                    </div>
<div class="line"><a id="l01843" name="l01843"></a><span class="lineno"> 1843</span>                <span class="keywordflow">if</span>(abs(sin(aae)).gt.1.e-10)<span class="keywordflow">then</span></div>
<div class="line"><a id="l01844" name="l01844"></a><span class="lineno"> 1844</span>                  <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#aad179c533a1745a0d54a5dac9fe675a8">shade_wall</a>(z(iz),z(iz+1),z(jz+1),phix,aae,   &amp;    </div>
<div class="line"><a id="l01845" name="l01845"></a><span class="lineno"> 1845</span>                      ws(id),rd)                  </div>
<div class="line"><a id="l01846" name="l01846"></a><span class="lineno"> 1846</span>                  rsw(2*id-1,iz)=rsw(2*id-1,iz)+rs*rd*ss(jz+1)/pb(iz+1)</div>
<div class="line"><a id="l01847" name="l01847"></a><span class="lineno"> 1847</span><span class="keywordflow">                endif</span></div>
<div class="line"><a id="l01848" name="l01848"></a><span class="lineno"> 1848</span>              </div>
<div class="line"><a id="l01849" name="l01849"></a><span class="lineno"> 1849</span>                <span class="keywordflow">if</span>(abs(sin(aaw)).gt.1.e-10)<span class="keywordflow">then</span></div>
<div class="line"><a id="l01850" name="l01850"></a><span class="lineno"> 1850</span>                  <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#aad179c533a1745a0d54a5dac9fe675a8">shade_wall</a>(z(iz),z(iz+1),z(jz+1),phix,aaw,   &amp;    </div>
<div class="line"><a id="l01851" name="l01851"></a><span class="lineno"> 1851</span>                      ws(id),rd)</div>
<div class="line"><a id="l01852" name="l01852"></a><span class="lineno"> 1852</span>                  rsw(2*id,iz)=rsw(2*id,iz)+rs*rd*ss(jz+1)/pb(iz+1)                  </div>
<div class="line"><a id="l01853" name="l01853"></a><span class="lineno"> 1853</span><span class="keywordflow">                endif</span></div>
<div class="line"><a id="l01854" name="l01854"></a><span class="lineno"> 1854</span><span class="keywordflow">               enddo</span>             </div>
<div class="line"><a id="l01855" name="l01855"></a><span class="lineno"> 1855</span><span class="keywordflow">            endif</span>  </div>
<div class="line"><a id="l01856" name="l01856"></a><span class="lineno"> 1856</span><span class="keywordflow">            enddo</span></div>
<div class="line"><a id="l01857" name="l01857"></a><span class="lineno"> 1857</span>        <span class="keywordflow">if</span>(abs(sin(aae)).gt.1.e-10)<span class="keywordflow">then</span></div>
<div class="line"><a id="l01858" name="l01858"></a><span class="lineno"> 1858</span>            wsd=abs(ws(id)/sin(aae))</div>
<div class="line"><a id="l01859" name="l01859"></a><span class="lineno"> 1859</span>              </div>
<div class="line"><a id="l01860" name="l01860"></a><span class="lineno"> 1860</span>            <span class="keywordflow">do</span> jz=1,nz_u           </div>
<div class="line"><a id="l01861" name="l01861"></a><span class="lineno"> 1861</span>               rd=max(0.,wsd-z(jz+1)*tan(phix))</div>
<div class="line"><a id="l01862" name="l01862"></a><span class="lineno"> 1862</span>               rsg(id)=rsg(id)+rs*rd*ss(jz+1)/wsd          </div>
<div class="line"><a id="l01863" name="l01863"></a><span class="lineno"> 1863</span><span class="keywordflow">            enddo</span></div>
<div class="line"><a id="l01864" name="l01864"></a><span class="lineno"> 1864</span>            rtot=0.</div>
<div class="line"><a id="l01865" name="l01865"></a><span class="lineno"> 1865</span>           </div>
<div class="line"><a id="l01866" name="l01866"></a><span class="lineno"> 1866</span>            <span class="keywordflow">do</span> iz=1,nz_u</div>
<div class="line"><a id="l01867" name="l01867"></a><span class="lineno"> 1867</span>               rtot=rtot+(rsw(2*id,iz)+rsw(2*id-1,iz))*            &amp;</div>
<div class="line"><a id="l01868" name="l01868"></a><span class="lineno"> 1868</span>                         (z(iz+1)-z(iz))</div>
<div class="line"><a id="l01869" name="l01869"></a><span class="lineno"> 1869</span><span class="keywordflow">            enddo</span></div>
<div class="line"><a id="l01870" name="l01870"></a><span class="lineno"> 1870</span>            rtot=rtot+rsg(id)*ws(id)</div>
<div class="line"><a id="l01871" name="l01871"></a><span class="lineno"> 1871</span>        <span class="keywordflow">else</span></div>
<div class="line"><a id="l01872" name="l01872"></a><span class="lineno"> 1872</span>            rsg(id)=rs</div>
<div class="line"><a id="l01873" name="l01873"></a><span class="lineno"> 1873</span><span class="keywordflow">        endif</span></div>
<div class="line"><a id="l01874" name="l01874"></a><span class="lineno"> 1874</span>            </div>
<div class="line"><a id="l01875" name="l01875"></a><span class="lineno"> 1875</span><span class="keywordflow">         enddo</span></div>
<div class="line"><a id="l01876" name="l01876"></a><span class="lineno"> 1876</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l01877" name="l01877"></a><span class="lineno"> 1877</span>         </div>
<div class="line"><a id="l01878" name="l01878"></a><span class="lineno"> 1878</span>      <span class="keywordflow">return</span></div>
<div class="line"><a id="l01879" name="l01879"></a><span class="lineno"> 1879</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#adc1740fecdbbc88a536fda2c456b1e2d">shadow_mas</a></div>
<div class="line"><a id="l01880" name="l01880"></a><span class="lineno"> 1880</span>         </div>
<div class="line"><a id="l01881" name="l01881"></a><span class="lineno"> 1881</span><span class="comment">! ===6=8===============================================================72     </span></div>
<div class="line"><a id="l01882" name="l01882"></a><span class="lineno"> 1882</span><span class="comment">! ===6=8===============================================================72     </span></div>
<div class="line"><a id="l01883" name="l01883"></a><span class="lineno"> 1883</span> </div>
<div class="line"><a id="l01884" name="l01884"></a><span class="lineno"><a class="line" href="namespacemodule__sf__bep.html#aad179c533a1745a0d54a5dac9fe675a8"> 1884</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#aad179c533a1745a0d54a5dac9fe675a8">shade_wall</a>(z1,z2,hu,phix,aa,ws,rd)</div>
<div class="line"><a id="l01885" name="l01885"></a><span class="lineno"> 1885</span> </div>
<div class="line"><a id="l01886" name="l01886"></a><span class="lineno"> 1886</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01887" name="l01887"></a><span class="lineno"> 1887</span><span class="comment">! This routine computes the effects of a shadow induced by a building of </span></div>
<div class="line"><a id="l01888" name="l01888"></a><span class="lineno"> 1888</span><span class="comment">! height hu, on a portion of wall between z1 and z2. See equation A10, </span></div>
<div class="line"><a id="l01889" name="l01889"></a><span class="lineno"> 1889</span><span class="comment">! and correction described below formula A11, and figure A1. Basically rd</span></div>
<div class="line"><a id="l01890" name="l01890"></a><span class="lineno"> 1890</span><span class="comment">! is the ratio between the horizontal surface illuminated and the portion</span></div>
<div class="line"><a id="l01891" name="l01891"></a><span class="lineno"> 1891</span><span class="comment">! of wall. Referring to figure A1, multiplying radiation flux density on </span></div>
<div class="line"><a id="l01892" name="l01892"></a><span class="lineno"> 1892</span><span class="comment">! a horizontal surface (rs) by x1-x2 we have the radiation energy per </span></div>
<div class="line"><a id="l01893" name="l01893"></a><span class="lineno"> 1893</span><span class="comment">! unit time. Dividing this by z2-z1, we obtain the radiation flux </span></div>
<div class="line"><a id="l01894" name="l01894"></a><span class="lineno"> 1894</span><span class="comment">! density reaching the portion of the wall between z2 and z1 </span></div>
<div class="line"><a id="l01895" name="l01895"></a><span class="lineno"> 1895</span><span class="comment">! (everything is assumed in 2D)</span></div>
<div class="line"><a id="l01896" name="l01896"></a><span class="lineno"> 1896</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01897" name="l01897"></a><span class="lineno"> 1897</span> </div>
<div class="line"><a id="l01898" name="l01898"></a><span class="lineno"> 1898</span>      <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l01899" name="l01899"></a><span class="lineno"> 1899</span>      </div>
<div class="line"><a id="l01900" name="l01900"></a><span class="lineno"> 1900</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01901" name="l01901"></a><span class="lineno"> 1901</span><span class="comment">! INPUT:</span></div>
<div class="line"><a id="l01902" name="l01902"></a><span class="lineno"> 1902</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01903" name="l01903"></a><span class="lineno"> 1903</span><span class="keywordtype">      real</span> aa                   <span class="comment">! Angle between the sun direction and the face of the wall (A12)</span></div>
<div class="line"><a id="l01904" name="l01904"></a><span class="lineno"> 1904</span><span class="keywordtype">      real</span> hu                   <span class="comment">! Height of the building that generates the shadow</span></div>
<div class="line"><a id="l01905" name="l01905"></a><span class="lineno"> 1905</span><span class="keywordtype">      real</span> phix                 <span class="comment">! Solar zenith angle</span></div>
<div class="line"><a id="l01906" name="l01906"></a><span class="lineno"> 1906</span><span class="keywordtype">      real</span> ws                   <span class="comment">! Width of the street</span></div>
<div class="line"><a id="l01907" name="l01907"></a><span class="lineno"> 1907</span><span class="keywordtype">      real</span> z1                   <span class="comment">! Height of the level z(iz)</span></div>
<div class="line"><a id="l01908" name="l01908"></a><span class="lineno"> 1908</span><span class="keywordtype">      real</span> z2                   <span class="comment">! Height of the level z(iz+1)</span></div>
<div class="line"><a id="l01909" name="l01909"></a><span class="lineno"> 1909</span> </div>
<div class="line"><a id="l01910" name="l01910"></a><span class="lineno"> 1910</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01911" name="l01911"></a><span class="lineno"> 1911</span><span class="comment">! OUTPUT:</span></div>
<div class="line"><a id="l01912" name="l01912"></a><span class="lineno"> 1912</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01913" name="l01913"></a><span class="lineno"> 1913</span><span class="keywordtype">      real</span> rd                   <span class="comment">! Ratio between (x1-x2)/(z2-z1), see Fig. 1A. </span></div>
<div class="line"><a id="l01914" name="l01914"></a><span class="lineno"> 1914</span>                                <span class="comment">! Multiplying rd by rs (radiation flux </span></div>
<div class="line"><a id="l01915" name="l01915"></a><span class="lineno"> 1915</span>                                <span class="comment">! density on a horizontal surface) gives </span></div>
<div class="line"><a id="l01916" name="l01916"></a><span class="lineno"> 1916</span>                                <span class="comment">! the radiation flux density on the </span></div>
<div class="line"><a id="l01917" name="l01917"></a><span class="lineno"> 1917</span>                                <span class="comment">! portion of wall between z1 and z2. </span></div>
<div class="line"><a id="l01918" name="l01918"></a><span class="lineno"> 1918</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01919" name="l01919"></a><span class="lineno"> 1919</span><span class="comment">! LOCAL:</span></div>
<div class="line"><a id="l01920" name="l01920"></a><span class="lineno"> 1920</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01921" name="l01921"></a><span class="lineno"> 1921</span><span class="keywordtype">      real</span> x1,x2                <span class="comment">! x1,x2 see Fig. A1.</span></div>
<div class="line"><a id="l01922" name="l01922"></a><span class="lineno"> 1922</span> </div>
<div class="line"><a id="l01923" name="l01923"></a><span class="lineno"> 1923</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01924" name="l01924"></a><span class="lineno"> 1924</span><span class="comment">! END VARIABLES DEFINITIONS</span></div>
<div class="line"><a id="l01925" name="l01925"></a><span class="lineno"> 1925</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01926" name="l01926"></a><span class="lineno"> 1926</span> </div>
<div class="line"><a id="l01927" name="l01927"></a><span class="lineno"> 1927</span>      x1=min((hu-z1)*tan(phix),max(0.,ws/sin(aa)))</div>
<div class="line"><a id="l01928" name="l01928"></a><span class="lineno"> 1928</span>      </div>
<div class="line"><a id="l01929" name="l01929"></a><span class="lineno"> 1929</span>      x2=max((hu-z2)*tan(phix),0.)</div>
<div class="line"><a id="l01930" name="l01930"></a><span class="lineno"> 1930</span> </div>
<div class="line"><a id="l01931" name="l01931"></a><span class="lineno"> 1931</span>      rd=max(0.,sin(aa)*(max(0.,x1-x2))/(z2-z1))</div>
<div class="line"><a id="l01932" name="l01932"></a><span class="lineno"> 1932</span>      </div>
<div class="line"><a id="l01933" name="l01933"></a><span class="lineno"> 1933</span>      <span class="keywordflow">return</span></div>
<div class="line"><a id="l01934" name="l01934"></a><span class="lineno"> 1934</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#aad179c533a1745a0d54a5dac9fe675a8">shade_wall</a></div>
<div class="line"><a id="l01935" name="l01935"></a><span class="lineno"> 1935</span> </div>
<div class="line"><a id="l01936" name="l01936"></a><span class="lineno"> 1936</span><span class="comment">! ===6=8===============================================================72     </span></div>
<div class="line"><a id="l01937" name="l01937"></a><span class="lineno"> 1937</span><span class="comment">! ===6=8===============================================================72     </span></div>
<div class="line"><a id="l01938" name="l01938"></a><span class="lineno"> 1938</span> </div>
<div class="line"><a id="l01939" name="l01939"></a><span class="lineno"><a class="line" href="namespacemodule__sf__bep.html#acaecbbdf8792abde301dc5b78589ba9f"> 1939</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#acaecbbdf8792abde301dc5b78589ba9f">long_rad</a>(iurb,nz_u,id,emw,emg,                  &amp;</div>
<div class="line"><a id="l01940" name="l01940"></a><span class="lineno"> 1940</span>                         fwg,fww,fgw,fsw,fsg,tg,tw,rlg,rlw,rl,pb)</div>
<div class="line"><a id="l01941" name="l01941"></a><span class="lineno"> 1941</span> </div>
<div class="line"><a id="l01942" name="l01942"></a><span class="lineno"> 1942</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01943" name="l01943"></a><span class="lineno"> 1943</span><span class="comment">! This routine computes the effects of the reflections of long-wave </span></div>
<div class="line"><a id="l01944" name="l01944"></a><span class="lineno"> 1944</span><span class="comment">! radiation in the street canyon by solving the system </span></div>
<div class="line"><a id="l01945" name="l01945"></a><span class="lineno"> 1945</span><span class="comment">! of 2*nz_u+1 eqn. in 2*nz_u+1</span></div>
<div class="line"><a id="l01946" name="l01946"></a><span class="lineno"> 1946</span><span class="comment">! unkonwn defined in A4, A5 and A6 of the paper (pages 295 and 296).</span></div>
<div class="line"><a id="l01947" name="l01947"></a><span class="lineno"> 1947</span><span class="comment">! The system is solved by solving A X= B,</span></div>
<div class="line"><a id="l01948" name="l01948"></a><span class="lineno"> 1948</span><span class="comment">! with A matrix B vector, and X solution. </span></div>
<div class="line"><a id="l01949" name="l01949"></a><span class="lineno"> 1949</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01950" name="l01950"></a><span class="lineno"> 1950</span> </div>
<div class="line"><a id="l01951" name="l01951"></a><span class="lineno"> 1951</span>      <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l01952" name="l01952"></a><span class="lineno"> 1952</span> </div>
<div class="line"><a id="l01953" name="l01953"></a><span class="lineno"> 1953</span>  </div>
<div class="line"><a id="l01954" name="l01954"></a><span class="lineno"> 1954</span>      </div>
<div class="line"><a id="l01955" name="l01955"></a><span class="lineno"> 1955</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01956" name="l01956"></a><span class="lineno"> 1956</span><span class="comment">! INPUT:</span></div>
<div class="line"><a id="l01957" name="l01957"></a><span class="lineno"> 1957</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01958" name="l01958"></a><span class="lineno"> 1958</span><span class="keywordtype">      real</span> emg                        <span class="comment">! Emissivity of ground for the current urban class</span></div>
<div class="line"><a id="l01959" name="l01959"></a><span class="lineno"> 1959</span><span class="keywordtype">      real</span> emw                        <span class="comment">! Emissivity of wall for the current urban class</span></div>
<div class="line"><a id="l01960" name="l01960"></a><span class="lineno"> 1960</span><span class="keywordtype">      real</span> fgw(nz_um,ndm,nurbm)       <span class="comment">! View factors from ground to wall</span></div>
<div class="line"><a id="l01961" name="l01961"></a><span class="lineno"> 1961</span><span class="keywordtype">      real</span> fsg(ndm,nurbm)             <span class="comment">! View factors from sky to ground</span></div>
<div class="line"><a id="l01962" name="l01962"></a><span class="lineno"> 1962</span><span class="keywordtype">      real</span> fsw(nz_um,ndm,nurbm)       <span class="comment">! View factors from sky to wall</span></div>
<div class="line"><a id="l01963" name="l01963"></a><span class="lineno"> 1963</span><span class="keywordtype">      real</span> fwg(nz_um,ndm,nurbm)       <span class="comment">! View factors from wall to ground</span></div>
<div class="line"><a id="l01964" name="l01964"></a><span class="lineno"> 1964</span><span class="keywordtype">      real</span> fww(nz_um,nz_um,ndm,nurbm) <span class="comment">! View factors from wall to wall</span></div>
<div class="line"><a id="l01965" name="l01965"></a><span class="lineno"> 1965</span>      <span class="keywordtype">integer</span> id                      <span class="comment">! Current street direction</span></div>
<div class="line"><a id="l01966" name="l01966"></a><span class="lineno"> 1966</span>      <span class="keywordtype">integer</span> iurb                    <span class="comment">! Current urban class</span></div>
<div class="line"><a id="l01967" name="l01967"></a><span class="lineno"> 1967</span>      <span class="keywordtype">integer</span> nz_u                    <span class="comment">! Number of layer in the urban grid</span></div>
<div class="line"><a id="l01968" name="l01968"></a><span class="lineno"> 1968</span><span class="keywordtype">      real</span> pb(nz_um)                <span class="comment">! Probability to have a building with an height equal</span></div>
<div class="line"><a id="l01969" name="l01969"></a><span class="lineno"> 1969</span><span class="keywordtype">      real</span> rl                         <span class="comment">! Downward flux of the longwave radiation</span></div>
<div class="line"><a id="l01970" name="l01970"></a><span class="lineno"> 1970</span><span class="keywordtype">      real</span> tg(ndm,ng_u)               <span class="comment">! Temperature in each layer of the ground [K]</span></div>
<div class="line"><a id="l01971" name="l01971"></a><span class="lineno"> 1971</span><span class="keywordtype">      real</span> tw(2*ndm,nz_um,nwr_u)       <span class="comment">! Temperature in each layer of the wall [K]</span></div>
<div class="line"><a id="l01972" name="l01972"></a><span class="lineno"> 1972</span>      </div>
<div class="line"><a id="l01973" name="l01973"></a><span class="lineno"> 1973</span> </div>
<div class="line"><a id="l01974" name="l01974"></a><span class="lineno"> 1974</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01975" name="l01975"></a><span class="lineno"> 1975</span><span class="comment">! OUTPUT:</span></div>
<div class="line"><a id="l01976" name="l01976"></a><span class="lineno"> 1976</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01977" name="l01977"></a><span class="lineno"> 1977</span><span class="keywordtype">      real</span> rlg(ndm)                   <span class="comment">! Long wave radiation at the ground</span></div>
<div class="line"><a id="l01978" name="l01978"></a><span class="lineno"> 1978</span><span class="keywordtype">      real</span> rlw(2*ndm,nz_um)           <span class="comment">! Long wave radiation at the walls</span></div>
<div class="line"><a id="l01979" name="l01979"></a><span class="lineno"> 1979</span> </div>
<div class="line"><a id="l01980" name="l01980"></a><span class="lineno"> 1980</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01981" name="l01981"></a><span class="lineno"> 1981</span><span class="comment">! LOCAL:</span></div>
<div class="line"><a id="l01982" name="l01982"></a><span class="lineno"> 1982</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01983" name="l01983"></a><span class="lineno"> 1983</span>      <span class="keywordtype">integer</span> i,j</div>
<div class="line"><a id="l01984" name="l01984"></a><span class="lineno"> 1984</span><span class="keywordtype">      real</span> aaa(2*nz_um+1,2*nz_um+1)   <span class="comment">! terms of the matrix</span></div>
<div class="line"><a id="l01985" name="l01985"></a><span class="lineno"> 1985</span><span class="keywordtype">      real</span> bbb(2*nz_um+1)             <span class="comment">! terms of the vector</span></div>
<div class="line"><a id="l01986" name="l01986"></a><span class="lineno"> 1986</span> </div>
<div class="line"><a id="l01987" name="l01987"></a><span class="lineno"> 1987</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01988" name="l01988"></a><span class="lineno"> 1988</span><span class="comment">! END VARIABLES DEFINITIONS</span></div>
<div class="line"><a id="l01989" name="l01989"></a><span class="lineno"> 1989</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01990" name="l01990"></a><span class="lineno"> 1990</span> </div>
<div class="line"><a id="l01991" name="l01991"></a><span class="lineno"> 1991</span> </div>
<div class="line"><a id="l01992" name="l01992"></a><span class="lineno"> 1992</span><span class="comment">! west wall</span></div>
<div class="line"><a id="l01993" name="l01993"></a><span class="lineno"> 1993</span>       </div>
<div class="line"><a id="l01994" name="l01994"></a><span class="lineno"> 1994</span>      <span class="keywordflow">do</span> i=1,nz_u</div>
<div class="line"><a id="l01995" name="l01995"></a><span class="lineno"> 1995</span>        </div>
<div class="line"><a id="l01996" name="l01996"></a><span class="lineno"> 1996</span>        <span class="keywordflow">do</span> j=1,nz_u</div>
<div class="line"><a id="l01997" name="l01997"></a><span class="lineno"> 1997</span>         aaa(i,j)=0.</div>
<div class="line"><a id="l01998" name="l01998"></a><span class="lineno"> 1998</span><span class="keywordflow">        enddo</span></div>
<div class="line"><a id="l01999" name="l01999"></a><span class="lineno"> 1999</span>        </div>
<div class="line"><a id="l02000" name="l02000"></a><span class="lineno"> 2000</span>        aaa(i,i)=1.        </div>
<div class="line"><a id="l02001" name="l02001"></a><span class="lineno"> 2001</span>       </div>
<div class="line"><a id="l02002" name="l02002"></a><span class="lineno"> 2002</span>        <span class="keywordflow">do</span> j=nz_u+1,2*nz_u</div>
<div class="line"><a id="l02003" name="l02003"></a><span class="lineno"> 2003</span>         aaa(i,j)=-(1.-emw)*fww(j-nz_u,i,id,iurb)*pb(j-nz_u+1)</div>
<div class="line"><a id="l02004" name="l02004"></a><span class="lineno"> 2004</span><span class="keywordflow">        enddo</span></div>
<div class="line"><a id="l02005" name="l02005"></a><span class="lineno"> 2005</span>        </div>
<div class="line"><a id="l02006" name="l02006"></a><span class="lineno"> 2006</span><span class="comment">!!      aaa(i,2*nz_u+1)=-(1.-emg)*fgw(i,id,iurb)*pb(i+1)</span></div>
<div class="line"><a id="l02007" name="l02007"></a><span class="lineno"> 2007</span>        aaa(i,2*nz_u+1)=-(1.-emg)*fgw(i,id,iurb)</div>
<div class="line"><a id="l02008" name="l02008"></a><span class="lineno"> 2008</span>        </div>
<div class="line"><a id="l02009" name="l02009"></a><span class="lineno"> 2009</span>        bbb(i)=fsw(i,id,iurb)*rl+emg*fgw(i,id,iurb)*<a class="code hl_variable" href="namespacemodule__sf__bep.html#a14b87836842c0cf3cccb0b78fde9b2b0">sigma</a>*tg(id,ng_u)**4</div>
<div class="line"><a id="l02010" name="l02010"></a><span class="lineno"> 2010</span>        <span class="keywordflow">do</span> j=1,nz_u</div>
<div class="line"><a id="l02011" name="l02011"></a><span class="lineno"> 2011</span>         bbb(i)=bbb(i)+pb(j+1)*emw*<a class="code hl_variable" href="namespacemodule__sf__bep.html#a14b87836842c0cf3cccb0b78fde9b2b0">sigma</a>*fww(j,i,id,iurb)*       &amp;</div>
<div class="line"><a id="l02012" name="l02012"></a><span class="lineno"> 2012</span>               tw(2*id,j,nwr_u)**4+                              &amp;</div>
<div class="line"><a id="l02013" name="l02013"></a><span class="lineno"> 2013</span>               fww(j,i,id,iurb)*rl*(1.-pb(j+1))</div>
<div class="line"><a id="l02014" name="l02014"></a><span class="lineno"> 2014</span><span class="keywordflow">        enddo</span></div>
<div class="line"><a id="l02015" name="l02015"></a><span class="lineno"> 2015</span>        </div>
<div class="line"><a id="l02016" name="l02016"></a><span class="lineno"> 2016</span><span class="keywordflow">       enddo</span></div>
<div class="line"><a id="l02017" name="l02017"></a><span class="lineno"> 2017</span>       </div>
<div class="line"><a id="l02018" name="l02018"></a><span class="lineno"> 2018</span><span class="comment">! east wall</span></div>
<div class="line"><a id="l02019" name="l02019"></a><span class="lineno"> 2019</span> </div>
<div class="line"><a id="l02020" name="l02020"></a><span class="lineno"> 2020</span>       <span class="keywordflow">do</span> i=1+nz_u,2*nz_u</div>
<div class="line"><a id="l02021" name="l02021"></a><span class="lineno"> 2021</span>        </div>
<div class="line"><a id="l02022" name="l02022"></a><span class="lineno"> 2022</span>        <span class="keywordflow">do</span> j=1,nz_u</div>
<div class="line"><a id="l02023" name="l02023"></a><span class="lineno"> 2023</span>         aaa(i,j)=-(1.-emw)*fww(j,i-nz_u,id,iurb)*pb(j+1)</div>
<div class="line"><a id="l02024" name="l02024"></a><span class="lineno"> 2024</span><span class="keywordflow">        enddo</span></div>
<div class="line"><a id="l02025" name="l02025"></a><span class="lineno"> 2025</span>        </div>
<div class="line"><a id="l02026" name="l02026"></a><span class="lineno"> 2026</span>        <span class="keywordflow">do</span> j=1+nz_u,2*nz_u</div>
<div class="line"><a id="l02027" name="l02027"></a><span class="lineno"> 2027</span>         aaa(i,j)=0.</div>
<div class="line"><a id="l02028" name="l02028"></a><span class="lineno"> 2028</span><span class="keywordflow">        enddo</span></div>
<div class="line"><a id="l02029" name="l02029"></a><span class="lineno"> 2029</span>        </div>
<div class="line"><a id="l02030" name="l02030"></a><span class="lineno"> 2030</span>        aaa(i,i)=1.</div>
<div class="line"><a id="l02031" name="l02031"></a><span class="lineno"> 2031</span>        </div>
<div class="line"><a id="l02032" name="l02032"></a><span class="lineno"> 2032</span><span class="comment">!!      aaa(i,2*nz_u+1)=-(1.-emg)*fgw(i-nz_u,id,iurb)*pb(i-nz_u+1)</span></div>
<div class="line"><a id="l02033" name="l02033"></a><span class="lineno"> 2033</span>        aaa(i,2*nz_u+1)=-(1.-emg)*fgw(i-nz_u,id,iurb)</div>
<div class="line"><a id="l02034" name="l02034"></a><span class="lineno"> 2034</span>        </div>
<div class="line"><a id="l02035" name="l02035"></a><span class="lineno"> 2035</span>        bbb(i)=fsw(i-nz_u,id,iurb)*rl+                           &amp;     </div>
<div class="line"><a id="l02036" name="l02036"></a><span class="lineno"> 2036</span>              emg*fgw(i-nz_u,id,iurb)*<a class="code hl_variable" href="namespacemodule__sf__bep.html#a14b87836842c0cf3cccb0b78fde9b2b0">sigma</a>*tg(id,ng_u)**4</div>
<div class="line"><a id="l02037" name="l02037"></a><span class="lineno"> 2037</span> </div>
<div class="line"><a id="l02038" name="l02038"></a><span class="lineno"> 2038</span>        <span class="keywordflow">do</span> j=1,nz_u</div>
<div class="line"><a id="l02039" name="l02039"></a><span class="lineno"> 2039</span>         bbb(i)=bbb(i)+pb(j+1)*emw*<a class="code hl_variable" href="namespacemodule__sf__bep.html#a14b87836842c0cf3cccb0b78fde9b2b0">sigma</a>*fww(j,i-nz_u,id,iurb)*  &amp;   </div>
<div class="line"><a id="l02040" name="l02040"></a><span class="lineno"> 2040</span>                tw(2*id-1,j,nwr_u)**4+                           &amp;   </div>
<div class="line"><a id="l02041" name="l02041"></a><span class="lineno"> 2041</span>                fww(j,i-nz_u,id,iurb)*rl*(1.-pb(j+1))</div>
<div class="line"><a id="l02042" name="l02042"></a><span class="lineno"> 2042</span><span class="keywordflow">        enddo</span></div>
<div class="line"><a id="l02043" name="l02043"></a><span class="lineno"> 2043</span>       </div>
<div class="line"><a id="l02044" name="l02044"></a><span class="lineno"> 2044</span><span class="keywordflow">       enddo</span></div>
<div class="line"><a id="l02045" name="l02045"></a><span class="lineno"> 2045</span> </div>
<div class="line"><a id="l02046" name="l02046"></a><span class="lineno"> 2046</span><span class="comment">! ground</span></div>
<div class="line"><a id="l02047" name="l02047"></a><span class="lineno"> 2047</span>       <span class="keywordflow">do</span> j=1,nz_u</div>
<div class="line"><a id="l02048" name="l02048"></a><span class="lineno"> 2048</span>        aaa(2*nz_u+1,j)=-(1.-emw)*fwg(j,id,iurb)*pb(j+1)</div>
<div class="line"><a id="l02049" name="l02049"></a><span class="lineno"> 2049</span><span class="keywordflow">       enddo</span></div>
<div class="line"><a id="l02050" name="l02050"></a><span class="lineno"> 2050</span>       </div>
<div class="line"><a id="l02051" name="l02051"></a><span class="lineno"> 2051</span>       <span class="keywordflow">do</span> j=nz_u+1,2*nz_u</div>
<div class="line"><a id="l02052" name="l02052"></a><span class="lineno"> 2052</span>        aaa(2*nz_u+1,j)=-(1.-emw)*fwg(j-nz_u,id,iurb)*pb(j-nz_u+1)</div>
<div class="line"><a id="l02053" name="l02053"></a><span class="lineno"> 2053</span><span class="keywordflow">       enddo</span></div>
<div class="line"><a id="l02054" name="l02054"></a><span class="lineno"> 2054</span>       </div>
<div class="line"><a id="l02055" name="l02055"></a><span class="lineno"> 2055</span>       aaa(2*nz_u+1,2*nz_u+1)=1.</div>
<div class="line"><a id="l02056" name="l02056"></a><span class="lineno"> 2056</span>       </div>
<div class="line"><a id="l02057" name="l02057"></a><span class="lineno"> 2057</span>       bbb(2*nz_u+1)=fsg(id,iurb)*rl</div>
<div class="line"><a id="l02058" name="l02058"></a><span class="lineno"> 2058</span>       </div>
<div class="line"><a id="l02059" name="l02059"></a><span class="lineno"> 2059</span>       <span class="keywordflow">do</span> i=1,nz_u</div>
<div class="line"><a id="l02060" name="l02060"></a><span class="lineno"> 2060</span>        bbb(2*nz_u+1)=bbb(2*nz_u+1)+emw*<a class="code hl_variable" href="namespacemodule__sf__bep.html#a14b87836842c0cf3cccb0b78fde9b2b0">sigma</a>*fwg(i,id,iurb)*pb(i+1)*    &amp;</div>
<div class="line"><a id="l02061" name="l02061"></a><span class="lineno"> 2061</span>                      (tw(2*id-1,i,nwr_u)**4+tw(2*id,i,nwr_u)**4)+       &amp;</div>
<div class="line"><a id="l02062" name="l02062"></a><span class="lineno"> 2062</span>                      2.*fwg(i,id,iurb)*(1.-pb(i+1))*rl                  </div>
<div class="line"><a id="l02063" name="l02063"></a><span class="lineno"> 2063</span><span class="keywordflow">       enddo</span></div>
<div class="line"><a id="l02064" name="l02064"></a><span class="lineno"> 2064</span>   </div>
<div class="line"><a id="l02065" name="l02065"></a><span class="lineno"> 2065</span> </div>
<div class="line"><a id="l02066" name="l02066"></a><span class="lineno"> 2066</span>     </div>
<div class="line"><a id="l02067" name="l02067"></a><span class="lineno"> 2067</span>       <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a5cf51c22bc40ad348fdc4c82f859a375">gaussj</a>(aaa,2*nz_u+1,bbb,2*nz_um+1)</div>
<div class="line"><a id="l02068" name="l02068"></a><span class="lineno"> 2068</span> </div>
<div class="line"><a id="l02069" name="l02069"></a><span class="lineno"> 2069</span>       <span class="keywordflow">do</span> i=1,nz_u</div>
<div class="line"><a id="l02070" name="l02070"></a><span class="lineno"> 2070</span>        rlw(2*id-1,i)=bbb(i)</div>
<div class="line"><a id="l02071" name="l02071"></a><span class="lineno"> 2071</span><span class="keywordflow">       enddo</span></div>
<div class="line"><a id="l02072" name="l02072"></a><span class="lineno"> 2072</span>       </div>
<div class="line"><a id="l02073" name="l02073"></a><span class="lineno"> 2073</span>       <span class="keywordflow">do</span> i=nz_u+1,2*nz_u</div>
<div class="line"><a id="l02074" name="l02074"></a><span class="lineno"> 2074</span>        rlw(2*id,i-nz_u)=bbb(i)</div>
<div class="line"><a id="l02075" name="l02075"></a><span class="lineno"> 2075</span><span class="keywordflow">       enddo</span></div>
<div class="line"><a id="l02076" name="l02076"></a><span class="lineno"> 2076</span>       </div>
<div class="line"><a id="l02077" name="l02077"></a><span class="lineno"> 2077</span>       rlg(id)=bbb(2*nz_u+1)</div>
<div class="line"><a id="l02078" name="l02078"></a><span class="lineno"> 2078</span>  </div>
<div class="line"><a id="l02079" name="l02079"></a><span class="lineno"> 2079</span>       <span class="keywordflow">return</span></div>
<div class="line"><a id="l02080" name="l02080"></a><span class="lineno"> 2080</span>       <span class="keyword">end subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#acaecbbdf8792abde301dc5b78589ba9f">long_rad</a></div>
<div class="line"><a id="l02081" name="l02081"></a><span class="lineno"> 2081</span>             </div>
<div class="line"><a id="l02082" name="l02082"></a><span class="lineno"> 2082</span><span class="comment">! ===6=8===============================================================72</span></div>
<div class="line"><a id="l02083" name="l02083"></a><span class="lineno"> 2083</span><span class="comment">! ===6=8===============================================================72</span></div>
<div class="line"><a id="l02084" name="l02084"></a><span class="lineno"> 2084</span> </div>
<div class="line"><a id="l02085" name="l02085"></a><span class="lineno"><a class="line" href="namespacemodule__sf__bep.html#abd3776b0304ce044cb0513a63aa99b07"> 2085</a></span>       <span class="keyword">subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#abd3776b0304ce044cb0513a63aa99b07">short_rad</a>(iurb,nz_u,id,albw,                        &amp; </div>
<div class="line"><a id="l02086" name="l02086"></a><span class="lineno"> 2086</span>                           albg,fwg,fww,fgw,rsg,rsw,pb)</div>
<div class="line"><a id="l02087" name="l02087"></a><span class="lineno"> 2087</span> </div>
<div class="line"><a id="l02088" name="l02088"></a><span class="lineno"> 2088</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02089" name="l02089"></a><span class="lineno"> 2089</span><span class="comment">! This routine computes the effects of the reflections of short-wave </span></div>
<div class="line"><a id="l02090" name="l02090"></a><span class="lineno"> 2090</span><span class="comment">! (solar) radiation in the street canyon by solving the system </span></div>
<div class="line"><a id="l02091" name="l02091"></a><span class="lineno"> 2091</span><span class="comment">! of 2*nz_u+1 eqn. in 2*nz_u+1</span></div>
<div class="line"><a id="l02092" name="l02092"></a><span class="lineno"> 2092</span><span class="comment">! unkonwn defined in A4, A5 and A6 of the paper (pages 295 and 296).</span></div>
<div class="line"><a id="l02093" name="l02093"></a><span class="lineno"> 2093</span><span class="comment">! The system is solved by solving A X= B,</span></div>
<div class="line"><a id="l02094" name="l02094"></a><span class="lineno"> 2094</span><span class="comment">! with A matrix B vector, and X solution. </span></div>
<div class="line"><a id="l02095" name="l02095"></a><span class="lineno"> 2095</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02096" name="l02096"></a><span class="lineno"> 2096</span> </div>
<div class="line"><a id="l02097" name="l02097"></a><span class="lineno"> 2097</span>      <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l02098" name="l02098"></a><span class="lineno"> 2098</span> </div>
<div class="line"><a id="l02099" name="l02099"></a><span class="lineno"> 2099</span>  </div>
<div class="line"><a id="l02100" name="l02100"></a><span class="lineno"> 2100</span>      </div>
<div class="line"><a id="l02101" name="l02101"></a><span class="lineno"> 2101</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02102" name="l02102"></a><span class="lineno"> 2102</span><span class="comment">! INPUT:</span></div>
<div class="line"><a id="l02103" name="l02103"></a><span class="lineno"> 2103</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02104" name="l02104"></a><span class="lineno"> 2104</span><span class="keywordtype">      real</span> albg                 <span class="comment">! Albedo of the ground for the current urban class</span></div>
<div class="line"><a id="l02105" name="l02105"></a><span class="lineno"> 2105</span><span class="keywordtype">      real</span> albw                 <span class="comment">! Albedo of the wall for the current urban class</span></div>
<div class="line"><a id="l02106" name="l02106"></a><span class="lineno"> 2106</span><span class="keywordtype">      real</span> fgw(nz_um,ndm,nurbm)       <span class="comment">! View factors from ground to wall</span></div>
<div class="line"><a id="l02107" name="l02107"></a><span class="lineno"> 2107</span><span class="keywordtype">      real</span> fwg(nz_um,ndm,nurbm)       <span class="comment">! View factors from wall to ground</span></div>
<div class="line"><a id="l02108" name="l02108"></a><span class="lineno"> 2108</span><span class="keywordtype">      real</span> fww(nz_um,nz_um,ndm,nurbm) <span class="comment">! View factors from wall to wall</span></div>
<div class="line"><a id="l02109" name="l02109"></a><span class="lineno"> 2109</span>      <span class="keywordtype">integer</span> id                <span class="comment">! current street direction </span></div>
<div class="line"><a id="l02110" name="l02110"></a><span class="lineno"> 2110</span>      <span class="keywordtype">integer</span> iurb              <span class="comment">! current urban class</span></div>
<div class="line"><a id="l02111" name="l02111"></a><span class="lineno"> 2111</span>      <span class="keywordtype">integer</span> nz_u              <span class="comment">! Number of layer in the urban grid</span></div>
<div class="line"><a id="l02112" name="l02112"></a><span class="lineno"> 2112</span><span class="keywordtype">      real</span> pb(nz_um)          <span class="comment">! probability to have a building with an height equal</span></div>
<div class="line"><a id="l02113" name="l02113"></a><span class="lineno"> 2113</span> </div>
<div class="line"><a id="l02114" name="l02114"></a><span class="lineno"> 2114</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02115" name="l02115"></a><span class="lineno"> 2115</span><span class="comment">! OUTPUT:</span></div>
<div class="line"><a id="l02116" name="l02116"></a><span class="lineno"> 2116</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02117" name="l02117"></a><span class="lineno"> 2117</span><span class="keywordtype">      real</span> rsg(ndm)             <span class="comment">! Short wave radiation at the ground</span></div>
<div class="line"><a id="l02118" name="l02118"></a><span class="lineno"> 2118</span><span class="keywordtype">      real</span> rsw(2*ndm,nz_um)     <span class="comment">! Short wave radiation at the walls</span></div>
<div class="line"><a id="l02119" name="l02119"></a><span class="lineno"> 2119</span> </div>
<div class="line"><a id="l02120" name="l02120"></a><span class="lineno"> 2120</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02121" name="l02121"></a><span class="lineno"> 2121</span><span class="comment">! LOCAL:</span></div>
<div class="line"><a id="l02122" name="l02122"></a><span class="lineno"> 2122</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02123" name="l02123"></a><span class="lineno"> 2123</span>      <span class="keywordtype">integer</span> i,j</div>
<div class="line"><a id="l02124" name="l02124"></a><span class="lineno"> 2124</span><span class="keywordtype">      real</span> aaa(2*nz_um+1,2*nz_um+1)  <span class="comment">! terms of the matrix</span></div>
<div class="line"><a id="l02125" name="l02125"></a><span class="lineno"> 2125</span><span class="keywordtype">      real</span> bbb(2*nz_um+1)            <span class="comment">! terms of the vector</span></div>
<div class="line"><a id="l02126" name="l02126"></a><span class="lineno"> 2126</span> </div>
<div class="line"><a id="l02127" name="l02127"></a><span class="lineno"> 2127</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02128" name="l02128"></a><span class="lineno"> 2128</span><span class="comment">! END VARIABLES DEFINITIONS</span></div>
<div class="line"><a id="l02129" name="l02129"></a><span class="lineno"> 2129</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02130" name="l02130"></a><span class="lineno"> 2130</span> </div>
<div class="line"><a id="l02131" name="l02131"></a><span class="lineno"> 2131</span>      </div>
<div class="line"><a id="l02132" name="l02132"></a><span class="lineno"> 2132</span><span class="comment">! west wall</span></div>
<div class="line"><a id="l02133" name="l02133"></a><span class="lineno"> 2133</span>       </div>
<div class="line"><a id="l02134" name="l02134"></a><span class="lineno"> 2134</span>      <span class="keywordflow">do</span> i=1,nz_u</div>
<div class="line"><a id="l02135" name="l02135"></a><span class="lineno"> 2135</span>         <span class="keywordflow">do</span> j=1,nz_u</div>
<div class="line"><a id="l02136" name="l02136"></a><span class="lineno"> 2136</span>            aaa(i,j)=0.</div>
<div class="line"><a id="l02137" name="l02137"></a><span class="lineno"> 2137</span><span class="keywordflow">         enddo</span></div>
<div class="line"><a id="l02138" name="l02138"></a><span class="lineno"> 2138</span>         </div>
<div class="line"><a id="l02139" name="l02139"></a><span class="lineno"> 2139</span>         aaa(i,i)=1.        </div>
<div class="line"><a id="l02140" name="l02140"></a><span class="lineno"> 2140</span>         </div>
<div class="line"><a id="l02141" name="l02141"></a><span class="lineno"> 2141</span>         <span class="keywordflow">do</span> j=nz_u+1,2*nz_u</div>
<div class="line"><a id="l02142" name="l02142"></a><span class="lineno"> 2142</span>            aaa(i,j)=-albw*fww(j-nz_u,i,id,iurb)*pb(j-nz_u+1)</div>
<div class="line"><a id="l02143" name="l02143"></a><span class="lineno"> 2143</span><span class="keywordflow">         enddo</span></div>
<div class="line"><a id="l02144" name="l02144"></a><span class="lineno"> 2144</span>         </div>
<div class="line"><a id="l02145" name="l02145"></a><span class="lineno"> 2145</span>         aaa(i,2*nz_u+1)=-albg*fgw(i,id,iurb)</div>
<div class="line"><a id="l02146" name="l02146"></a><span class="lineno"> 2146</span>         bbb(i)=rsw(2*id-1,i)</div>
<div class="line"><a id="l02147" name="l02147"></a><span class="lineno"> 2147</span>         </div>
<div class="line"><a id="l02148" name="l02148"></a><span class="lineno"> 2148</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l02149" name="l02149"></a><span class="lineno"> 2149</span>       </div>
<div class="line"><a id="l02150" name="l02150"></a><span class="lineno"> 2150</span><span class="comment">! east wall</span></div>
<div class="line"><a id="l02151" name="l02151"></a><span class="lineno"> 2151</span> </div>
<div class="line"><a id="l02152" name="l02152"></a><span class="lineno"> 2152</span>      <span class="keywordflow">do</span> i=1+nz_u,2*nz_u</div>
<div class="line"><a id="l02153" name="l02153"></a><span class="lineno"> 2153</span>         <span class="keywordflow">do</span> j=1,nz_u</div>
<div class="line"><a id="l02154" name="l02154"></a><span class="lineno"> 2154</span>            aaa(i,j)=-albw*fww(j,i-nz_u,id,iurb)*pb(j+1)</div>
<div class="line"><a id="l02155" name="l02155"></a><span class="lineno"> 2155</span><span class="keywordflow">         enddo</span></div>
<div class="line"><a id="l02156" name="l02156"></a><span class="lineno"> 2156</span>         </div>
<div class="line"><a id="l02157" name="l02157"></a><span class="lineno"> 2157</span>         <span class="keywordflow">do</span> j=1+nz_u,2*nz_u</div>
<div class="line"><a id="l02158" name="l02158"></a><span class="lineno"> 2158</span>            aaa(i,j)=0.</div>
<div class="line"><a id="l02159" name="l02159"></a><span class="lineno"> 2159</span><span class="keywordflow">         enddo</span></div>
<div class="line"><a id="l02160" name="l02160"></a><span class="lineno"> 2160</span>         </div>
<div class="line"><a id="l02161" name="l02161"></a><span class="lineno"> 2161</span>        aaa(i,i)=1.</div>
<div class="line"><a id="l02162" name="l02162"></a><span class="lineno"> 2162</span>        aaa(i,2*nz_u+1)=-albg*fgw(i-nz_u,id,iurb)</div>
<div class="line"><a id="l02163" name="l02163"></a><span class="lineno"> 2163</span>        bbb(i)=rsw(2*id,i-nz_u)</div>
<div class="line"><a id="l02164" name="l02164"></a><span class="lineno"> 2164</span>        </div>
<div class="line"><a id="l02165" name="l02165"></a><span class="lineno"> 2165</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l02166" name="l02166"></a><span class="lineno"> 2166</span> </div>
<div class="line"><a id="l02167" name="l02167"></a><span class="lineno"> 2167</span><span class="comment">! ground</span></div>
<div class="line"><a id="l02168" name="l02168"></a><span class="lineno"> 2168</span> </div>
<div class="line"><a id="l02169" name="l02169"></a><span class="lineno"> 2169</span>      <span class="keywordflow">do</span> j=1,nz_u</div>
<div class="line"><a id="l02170" name="l02170"></a><span class="lineno"> 2170</span>         aaa(2*nz_u+1,j)=-albw*fwg(j,id,iurb)*pb(j+1)</div>
<div class="line"><a id="l02171" name="l02171"></a><span class="lineno"> 2171</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l02172" name="l02172"></a><span class="lineno"> 2172</span>       </div>
<div class="line"><a id="l02173" name="l02173"></a><span class="lineno"> 2173</span>      <span class="keywordflow">do</span> j=nz_u+1,2*nz_u</div>
<div class="line"><a id="l02174" name="l02174"></a><span class="lineno"> 2174</span>         aaa(2*nz_u+1,j)=-albw*fwg(j-nz_u,id,iurb)*pb(j-nz_u+1)</div>
<div class="line"><a id="l02175" name="l02175"></a><span class="lineno"> 2175</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l02176" name="l02176"></a><span class="lineno"> 2176</span>       </div>
<div class="line"><a id="l02177" name="l02177"></a><span class="lineno"> 2177</span>      aaa(2*nz_u+1,2*nz_u+1)=1.</div>
<div class="line"><a id="l02178" name="l02178"></a><span class="lineno"> 2178</span>      bbb(2*nz_u+1)=rsg(id)</div>
<div class="line"><a id="l02179" name="l02179"></a><span class="lineno"> 2179</span>       </div>
<div class="line"><a id="l02180" name="l02180"></a><span class="lineno"> 2180</span>      <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a5cf51c22bc40ad348fdc4c82f859a375">gaussj</a>(aaa,2*nz_u+1,bbb,2*nz_um+1)</div>
<div class="line"><a id="l02181" name="l02181"></a><span class="lineno"> 2181</span> </div>
<div class="line"><a id="l02182" name="l02182"></a><span class="lineno"> 2182</span>      <span class="keywordflow">do</span> i=1,nz_u</div>
<div class="line"><a id="l02183" name="l02183"></a><span class="lineno"> 2183</span>         rsw(2*id-1,i)=bbb(i)</div>
<div class="line"><a id="l02184" name="l02184"></a><span class="lineno"> 2184</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l02185" name="l02185"></a><span class="lineno"> 2185</span>       </div>
<div class="line"><a id="l02186" name="l02186"></a><span class="lineno"> 2186</span>      <span class="keywordflow">do</span> i=nz_u+1,2*nz_u</div>
<div class="line"><a id="l02187" name="l02187"></a><span class="lineno"> 2187</span>         rsw(2*id,i-nz_u)=bbb(i) </div>
<div class="line"><a id="l02188" name="l02188"></a><span class="lineno"> 2188</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l02189" name="l02189"></a><span class="lineno"> 2189</span>       </div>
<div class="line"><a id="l02190" name="l02190"></a><span class="lineno"> 2190</span>      rsg(id)=bbb(2*nz_u+1)</div>
<div class="line"><a id="l02191" name="l02191"></a><span class="lineno"> 2191</span>       </div>
<div class="line"><a id="l02192" name="l02192"></a><span class="lineno"> 2192</span>      <span class="keywordflow">return</span></div>
<div class="line"><a id="l02193" name="l02193"></a><span class="lineno"> 2193</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#abd3776b0304ce044cb0513a63aa99b07">short_rad</a></div>
<div class="line"><a id="l02194" name="l02194"></a><span class="lineno"> 2194</span>             </div>
<div class="line"><a id="l02195" name="l02195"></a><span class="lineno"> 2195</span> </div>
<div class="line"><a id="l02196" name="l02196"></a><span class="lineno"> 2196</span><span class="comment">! ===6=8===============================================================72     </span></div>
<div class="line"><a id="l02197" name="l02197"></a><span class="lineno"> 2197</span><span class="comment">! ===6=8===============================================================72     </span></div>
<div class="line"><a id="l02198" name="l02198"></a><span class="lineno"> 2198</span>      </div>
<div class="line"><a id="l02199" name="l02199"></a><span class="lineno"><a class="line" href="namespacemodule__sf__bep.html#a5cf51c22bc40ad348fdc4c82f859a375"> 2199</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a5cf51c22bc40ad348fdc4c82f859a375">gaussj</a>(a,n,b,np)</div>
<div class="line"><a id="l02200" name="l02200"></a><span class="lineno"> 2200</span> </div>
<div class="line"><a id="l02201" name="l02201"></a><span class="lineno"> 2201</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02202" name="l02202"></a><span class="lineno"> 2202</span><span class="comment">! This routine solve a linear system of n equations of the form</span></div>
<div class="line"><a id="l02203" name="l02203"></a><span class="lineno"> 2203</span><span class="comment">!              A X = B</span></div>
<div class="line"><a id="l02204" name="l02204"></a><span class="lineno"> 2204</span><span class="comment">!  where  A is a matrix a(i,j)</span></div>
<div class="line"><a id="l02205" name="l02205"></a><span class="lineno"> 2205</span><span class="comment">!         B a vector and X the solution</span></div>
<div class="line"><a id="l02206" name="l02206"></a><span class="lineno"> 2206</span><span class="comment">! In output b is replaced by the solution     </span></div>
<div class="line"><a id="l02207" name="l02207"></a><span class="lineno"> 2207</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02208" name="l02208"></a><span class="lineno"> 2208</span> </div>
<div class="line"><a id="l02209" name="l02209"></a><span class="lineno"> 2209</span>      <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l02210" name="l02210"></a><span class="lineno"> 2210</span> </div>
<div class="line"><a id="l02211" name="l02211"></a><span class="lineno"> 2211</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02212" name="l02212"></a><span class="lineno"> 2212</span><span class="comment">! INPUT:</span></div>
<div class="line"><a id="l02213" name="l02213"></a><span class="lineno"> 2213</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02214" name="l02214"></a><span class="lineno"> 2214</span>      <span class="keywordtype">integer</span> np</div>
<div class="line"><a id="l02215" name="l02215"></a><span class="lineno"> 2215</span><span class="keywordtype">      real</span> a(np,np)</div>
<div class="line"><a id="l02216" name="l02216"></a><span class="lineno"> 2216</span> </div>
<div class="line"><a id="l02217" name="l02217"></a><span class="lineno"> 2217</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02218" name="l02218"></a><span class="lineno"> 2218</span><span class="comment">! OUTPUT:</span></div>
<div class="line"><a id="l02219" name="l02219"></a><span class="lineno"> 2219</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02220" name="l02220"></a><span class="lineno"> 2220</span><span class="keywordtype">      real</span> b(np)</div>
<div class="line"><a id="l02221" name="l02221"></a><span class="lineno"> 2221</span> </div>
<div class="line"><a id="l02222" name="l02222"></a><span class="lineno"> 2222</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02223" name="l02223"></a><span class="lineno"> 2223</span><span class="comment">! LOCAL:</span></div>
<div class="line"><a id="l02224" name="l02224"></a><span class="lineno"> 2224</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02225" name="l02225"></a><span class="lineno"> 2225</span>      <span class="keywordtype">integer</span> nmax</div>
<div class="line"><a id="l02226" name="l02226"></a><span class="lineno"> 2226</span>      parameter(nmax=150)</div>
<div class="line"><a id="l02227" name="l02227"></a><span class="lineno"> 2227</span> </div>
<div class="line"><a id="l02228" name="l02228"></a><span class="lineno"> 2228</span><span class="keywordtype">      real</span> big,dum</div>
<div class="line"><a id="l02229" name="l02229"></a><span class="lineno"> 2229</span>      <span class="keywordtype">integer</span> i,icol,irow</div>
<div class="line"><a id="l02230" name="l02230"></a><span class="lineno"> 2230</span>      <span class="keywordtype">integer</span> j,k,l,ll,n</div>
<div class="line"><a id="l02231" name="l02231"></a><span class="lineno"> 2231</span>      <span class="keywordtype">integer</span> ipiv(nmax)</div>
<div class="line"><a id="l02232" name="l02232"></a><span class="lineno"> 2232</span><span class="keywordtype">      real</span> pivinv</div>
<div class="line"><a id="l02233" name="l02233"></a><span class="lineno"> 2233</span> </div>
<div class="line"><a id="l02234" name="l02234"></a><span class="lineno"> 2234</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02235" name="l02235"></a><span class="lineno"> 2235</span><span class="comment">! END VARIABLES DEFINITIONS</span></div>
<div class="line"><a id="l02236" name="l02236"></a><span class="lineno"> 2236</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02237" name="l02237"></a><span class="lineno"> 2237</span>       </div>
<div class="line"><a id="l02238" name="l02238"></a><span class="lineno"> 2238</span>      <span class="keywordflow">do</span> j=1,n</div>
<div class="line"><a id="l02239" name="l02239"></a><span class="lineno"> 2239</span>         ipiv(j)=0.</div>
<div class="line"><a id="l02240" name="l02240"></a><span class="lineno"> 2240</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l02241" name="l02241"></a><span class="lineno"> 2241</span>       </div>
<div class="line"><a id="l02242" name="l02242"></a><span class="lineno"> 2242</span>      <span class="keywordflow">do</span> i=1,n</div>
<div class="line"><a id="l02243" name="l02243"></a><span class="lineno"> 2243</span>         big=0.</div>
<div class="line"><a id="l02244" name="l02244"></a><span class="lineno"> 2244</span>         <span class="keywordflow">do</span> j=1,n</div>
<div class="line"><a id="l02245" name="l02245"></a><span class="lineno"> 2245</span>            <span class="keywordflow">if</span>(ipiv(j).ne.1)<span class="keywordflow">then</span></div>
<div class="line"><a id="l02246" name="l02246"></a><span class="lineno"> 2246</span>               <span class="keywordflow">do</span> k=1,n</div>
<div class="line"><a id="l02247" name="l02247"></a><span class="lineno"> 2247</span>                  <span class="keywordflow">if</span>(ipiv(k).eq.0)<span class="keywordflow">then</span></div>
<div class="line"><a id="l02248" name="l02248"></a><span class="lineno"> 2248</span>                     <span class="keywordflow">if</span>(abs(a(j,k)).ge.big)<span class="keywordflow">then</span></div>
<div class="line"><a id="l02249" name="l02249"></a><span class="lineno"> 2249</span>                        big=abs(a(j,k))</div>
<div class="line"><a id="l02250" name="l02250"></a><span class="lineno"> 2250</span>                        irow=j</div>
<div class="line"><a id="l02251" name="l02251"></a><span class="lineno"> 2251</span>                        icol=k</div>
<div class="line"><a id="l02252" name="l02252"></a><span class="lineno"> 2252</span><span class="keywordflow">                     endif</span></div>
<div class="line"><a id="l02253" name="l02253"></a><span class="lineno"> 2253</span>                  <span class="keywordflow">elseif</span>(ipiv(k).gt.1)<span class="keywordflow">then</span></div>
<div class="line"><a id="l02254" name="l02254"></a><span class="lineno"> 2254</span>                     fatal_error(<span class="stringliteral">&#39;singular matrix in gaussj&#39;</span>)</div>
<div class="line"><a id="l02255" name="l02255"></a><span class="lineno"> 2255</span><span class="keywordflow">                  endif</span></div>
<div class="line"><a id="l02256" name="l02256"></a><span class="lineno"> 2256</span><span class="keywordflow">               enddo</span></div>
<div class="line"><a id="l02257" name="l02257"></a><span class="lineno"> 2257</span><span class="keywordflow">            endif</span></div>
<div class="line"><a id="l02258" name="l02258"></a><span class="lineno"> 2258</span><span class="keywordflow">         enddo</span></div>
<div class="line"><a id="l02259" name="l02259"></a><span class="lineno"> 2259</span>         </div>
<div class="line"><a id="l02260" name="l02260"></a><span class="lineno"> 2260</span>         ipiv(icol)=ipiv(icol)+1</div>
<div class="line"><a id="l02261" name="l02261"></a><span class="lineno"> 2261</span>         </div>
<div class="line"><a id="l02262" name="l02262"></a><span class="lineno"> 2262</span>         <span class="keywordflow">if</span>(irow.ne.icol)<span class="keywordflow">then</span></div>
<div class="line"><a id="l02263" name="l02263"></a><span class="lineno"> 2263</span>            <span class="keywordflow">do</span> l=1,n</div>
<div class="line"><a id="l02264" name="l02264"></a><span class="lineno"> 2264</span>               dum=a(irow,l)</div>
<div class="line"><a id="l02265" name="l02265"></a><span class="lineno"> 2265</span>               a(irow,l)=a(icol,l)</div>
<div class="line"><a id="l02266" name="l02266"></a><span class="lineno"> 2266</span>               a(icol,l)=dum</div>
<div class="line"><a id="l02267" name="l02267"></a><span class="lineno"> 2267</span><span class="keywordflow">            enddo</span></div>
<div class="line"><a id="l02268" name="l02268"></a><span class="lineno"> 2268</span>            </div>
<div class="line"><a id="l02269" name="l02269"></a><span class="lineno"> 2269</span>            dum=b(irow)</div>
<div class="line"><a id="l02270" name="l02270"></a><span class="lineno"> 2270</span>            b(irow)=b(icol)</div>
<div class="line"><a id="l02271" name="l02271"></a><span class="lineno"> 2271</span>            b(icol)=dum</div>
<div class="line"><a id="l02272" name="l02272"></a><span class="lineno"> 2272</span>          </div>
<div class="line"><a id="l02273" name="l02273"></a><span class="lineno"> 2273</span><span class="keywordflow">         endif</span></div>
<div class="line"><a id="l02274" name="l02274"></a><span class="lineno"> 2274</span>         </div>
<div class="line"><a id="l02275" name="l02275"></a><span class="lineno"> 2275</span>         <span class="keywordflow">if</span>(a(icol,icol).eq.0) fatal_error(<span class="stringliteral">&#39;singular matrix in gaussj&#39;</span>)</div>
<div class="line"><a id="l02276" name="l02276"></a><span class="lineno"> 2276</span>         </div>
<div class="line"><a id="l02277" name="l02277"></a><span class="lineno"> 2277</span>         pivinv=1./a(icol,icol)</div>
<div class="line"><a id="l02278" name="l02278"></a><span class="lineno"> 2278</span>         a(icol,icol)=1</div>
<div class="line"><a id="l02279" name="l02279"></a><span class="lineno"> 2279</span>         </div>
<div class="line"><a id="l02280" name="l02280"></a><span class="lineno"> 2280</span>         <span class="keywordflow">do</span> l=1,n</div>
<div class="line"><a id="l02281" name="l02281"></a><span class="lineno"> 2281</span>            a(icol,l)=a(icol,l)*pivinv</div>
<div class="line"><a id="l02282" name="l02282"></a><span class="lineno"> 2282</span><span class="keywordflow">         enddo</span></div>
<div class="line"><a id="l02283" name="l02283"></a><span class="lineno"> 2283</span>         </div>
<div class="line"><a id="l02284" name="l02284"></a><span class="lineno"> 2284</span>         b(icol)=b(icol)*pivinv</div>
<div class="line"><a id="l02285" name="l02285"></a><span class="lineno"> 2285</span>         </div>
<div class="line"><a id="l02286" name="l02286"></a><span class="lineno"> 2286</span>         <span class="keywordflow">do</span> ll=1,n</div>
<div class="line"><a id="l02287" name="l02287"></a><span class="lineno"> 2287</span>            <span class="keywordflow">if</span>(ll.ne.icol)<span class="keywordflow">then</span></div>
<div class="line"><a id="l02288" name="l02288"></a><span class="lineno"> 2288</span>               dum=a(ll,icol)</div>
<div class="line"><a id="l02289" name="l02289"></a><span class="lineno"> 2289</span>               a(ll,icol)=0.</div>
<div class="line"><a id="l02290" name="l02290"></a><span class="lineno"> 2290</span>               <span class="keywordflow">do</span> l=1,n</div>
<div class="line"><a id="l02291" name="l02291"></a><span class="lineno"> 2291</span>                  a(ll,l)=a(ll,l)-a(icol,l)*dum</div>
<div class="line"><a id="l02292" name="l02292"></a><span class="lineno"> 2292</span><span class="keywordflow">               enddo</span></div>
<div class="line"><a id="l02293" name="l02293"></a><span class="lineno"> 2293</span>               </div>
<div class="line"><a id="l02294" name="l02294"></a><span class="lineno"> 2294</span>               b(ll)=b(ll)-b(icol)*dum</div>
<div class="line"><a id="l02295" name="l02295"></a><span class="lineno"> 2295</span>               </div>
<div class="line"><a id="l02296" name="l02296"></a><span class="lineno"> 2296</span><span class="keywordflow">            endif</span></div>
<div class="line"><a id="l02297" name="l02297"></a><span class="lineno"> 2297</span><span class="keywordflow">         enddo</span></div>
<div class="line"><a id="l02298" name="l02298"></a><span class="lineno"> 2298</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l02299" name="l02299"></a><span class="lineno"> 2299</span>      </div>
<div class="line"><a id="l02300" name="l02300"></a><span class="lineno"> 2300</span>      <span class="keywordflow">return</span></div>
<div class="line"><a id="l02301" name="l02301"></a><span class="lineno"> 2301</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a5cf51c22bc40ad348fdc4c82f859a375">gaussj</a></div>
<div class="line"><a id="l02302" name="l02302"></a><span class="lineno"> 2302</span>         </div>
<div class="line"><a id="l02303" name="l02303"></a><span class="lineno"> 2303</span><span class="comment">! ===6=8===============================================================72     </span></div>
<div class="line"><a id="l02304" name="l02304"></a><span class="lineno"> 2304</span><span class="comment">! ===6=8===============================================================72     </span></div>
<div class="line"><a id="l02305" name="l02305"></a><span class="lineno"> 2305</span>       </div>
<div class="line"><a id="l02306" name="l02306"></a><span class="lineno"><a class="line" href="namespacemodule__sf__bep.html#a0928487326d9735901c0825abfec3b5e"> 2306</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a0928487326d9735901c0825abfec3b5e">soil_temp</a>(nz,dz,temp,pt,ala,cs,                       &amp;</div>
<div class="line"><a id="l02307" name="l02307"></a><span class="lineno"> 2307</span>                          rs,rl,press,dt,em,alb,rt,sf,gf)</div>
<div class="line"><a id="l02308" name="l02308"></a><span class="lineno"> 2308</span> </div>
<div class="line"><a id="l02309" name="l02309"></a><span class="lineno"> 2309</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02310" name="l02310"></a><span class="lineno"> 2310</span><span class="comment">! This routine solves the Fourier diffusion equation for heat in </span></div>
<div class="line"><a id="l02311" name="l02311"></a><span class="lineno"> 2311</span><span class="comment">! the material (wall, roof, or ground). Resolution is done implicitely.</span></div>
<div class="line"><a id="l02312" name="l02312"></a><span class="lineno"> 2312</span><span class="comment">! Boundary conditions are: </span></div>
<div class="line"><a id="l02313" name="l02313"></a><span class="lineno"> 2313</span><span class="comment">! - fixed temperature at the interior</span></div>
<div class="line"><a id="l02314" name="l02314"></a><span class="lineno"> 2314</span><span class="comment">! - energy budget at the surface</span></div>
<div class="line"><a id="l02315" name="l02315"></a><span class="lineno"> 2315</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02316" name="l02316"></a><span class="lineno"> 2316</span> </div>
<div class="line"><a id="l02317" name="l02317"></a><span class="lineno"> 2317</span>      <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l02318" name="l02318"></a><span class="lineno"> 2318</span> </div>
<div class="line"><a id="l02319" name="l02319"></a><span class="lineno"> 2319</span>     </div>
<div class="line"><a id="l02320" name="l02320"></a><span class="lineno"> 2320</span>                </div>
<div class="line"><a id="l02321" name="l02321"></a><span class="lineno"> 2321</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02322" name="l02322"></a><span class="lineno"> 2322</span><span class="comment">! INPUT:</span></div>
<div class="line"><a id="l02323" name="l02323"></a><span class="lineno"> 2323</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02324" name="l02324"></a><span class="lineno"> 2324</span>      <span class="keywordtype">integer</span> nz                <span class="comment">! Number of layers</span></div>
<div class="line"><a id="l02325" name="l02325"></a><span class="lineno"> 2325</span><span class="keywordtype">      real</span> ala(nz)              <span class="comment">! Thermal diffusivity in each layers [m^2 s^-1] </span></div>
<div class="line"><a id="l02326" name="l02326"></a><span class="lineno"> 2326</span><span class="keywordtype">      real</span> alb                  <span class="comment">! Albedo of the surface</span></div>
<div class="line"><a id="l02327" name="l02327"></a><span class="lineno"> 2327</span><span class="keywordtype">      real</span> cs(nz)               <span class="comment">! Specific heat of the material [J m^3 K^-1]</span></div>
<div class="line"><a id="l02328" name="l02328"></a><span class="lineno"> 2328</span><span class="keywordtype">      real</span> dt                   <span class="comment">! Time step</span></div>
<div class="line"><a id="l02329" name="l02329"></a><span class="lineno"> 2329</span><span class="keywordtype">      real</span> em                   <span class="comment">! Emissivity of the surface</span></div>
<div class="line"><a id="l02330" name="l02330"></a><span class="lineno"> 2330</span><span class="keywordtype">      real</span> press                <span class="comment">! Pressure at ground level</span></div>
<div class="line"><a id="l02331" name="l02331"></a><span class="lineno"> 2331</span><span class="keywordtype">      real</span> rl                   <span class="comment">! Downward flux of the longwave radiation</span></div>
<div class="line"><a id="l02332" name="l02332"></a><span class="lineno"> 2332</span><span class="keywordtype">      real</span> rs                   <span class="comment">! Solar radiation</span></div>
<div class="line"><a id="l02333" name="l02333"></a><span class="lineno"> 2333</span><span class="keywordtype">      real</span> sf                   <span class="comment">! Sensible heat flux at the surface</span></div>
<div class="line"><a id="l02334" name="l02334"></a><span class="lineno"> 2334</span><span class="keywordtype">      real</span> temp(nz)             <span class="comment">! Temperature in each layer [K]</span></div>
<div class="line"><a id="l02335" name="l02335"></a><span class="lineno"> 2335</span><span class="keywordtype">      real</span> dz(nz)               <span class="comment">! Layer sizes [m]</span></div>
<div class="line"><a id="l02336" name="l02336"></a><span class="lineno"> 2336</span> </div>
<div class="line"><a id="l02337" name="l02337"></a><span class="lineno"> 2337</span> </div>
<div class="line"><a id="l02338" name="l02338"></a><span class="lineno"> 2338</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02339" name="l02339"></a><span class="lineno"> 2339</span><span class="comment">! OUTPUT:</span></div>
<div class="line"><a id="l02340" name="l02340"></a><span class="lineno"> 2340</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02341" name="l02341"></a><span class="lineno"> 2341</span><span class="keywordtype">      real</span> gf                   <span class="comment">! Heat flux transferred from the surface toward the interior</span></div>
<div class="line"><a id="l02342" name="l02342"></a><span class="lineno"> 2342</span><span class="keywordtype">      real</span> pt                   <span class="comment">! Potential temperature at the surface</span></div>
<div class="line"><a id="l02343" name="l02343"></a><span class="lineno"> 2343</span><span class="keywordtype">      real</span> rt                   <span class="comment">! Total radiation at the surface (solar+incoming long+outgoing long)</span></div>
<div class="line"><a id="l02344" name="l02344"></a><span class="lineno"> 2344</span> </div>
<div class="line"><a id="l02345" name="l02345"></a><span class="lineno"> 2345</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02346" name="l02346"></a><span class="lineno"> 2346</span><span class="comment">! LOCAL:</span></div>
<div class="line"><a id="l02347" name="l02347"></a><span class="lineno"> 2347</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02348" name="l02348"></a><span class="lineno"> 2348</span>      <span class="keywordtype">integer</span> iz</div>
<div class="line"><a id="l02349" name="l02349"></a><span class="lineno"> 2349</span><span class="keywordtype">      real</span> a(nz,3)</div>
<div class="line"><a id="l02350" name="l02350"></a><span class="lineno"> 2350</span><span class="keywordtype">      real</span> alpha</div>
<div class="line"><a id="l02351" name="l02351"></a><span class="lineno"> 2351</span><span class="keywordtype">      real</span> c(nz)</div>
<div class="line"><a id="l02352" name="l02352"></a><span class="lineno"> 2352</span><span class="keywordtype">      real</span> cddz(nz+2)</div>
<div class="line"><a id="l02353" name="l02353"></a><span class="lineno"> 2353</span><span class="keywordtype">      real</span> tsig</div>
<div class="line"><a id="l02354" name="l02354"></a><span class="lineno"> 2354</span> </div>
<div class="line"><a id="l02355" name="l02355"></a><span class="lineno"> 2355</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02356" name="l02356"></a><span class="lineno"> 2356</span><span class="comment">! END VARIABLES DEFINITIONS</span></div>
<div class="line"><a id="l02357" name="l02357"></a><span class="lineno"> 2357</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02358" name="l02358"></a><span class="lineno"> 2358</span>       </div>
<div class="line"><a id="l02359" name="l02359"></a><span class="lineno"> 2359</span>      tsig=temp(nz)</div>
<div class="line"><a id="l02360" name="l02360"></a><span class="lineno"> 2360</span>      alpha=(1.-alb)*rs+em*rl-em*<a class="code hl_variable" href="namespacemodule__sf__bep.html#a14b87836842c0cf3cccb0b78fde9b2b0">sigma</a>*(tsig**4)+sf</div>
<div class="line"><a id="l02361" name="l02361"></a><span class="lineno"> 2361</span><span class="comment">! Compute cddz=2*cd/dz  </span></div>
<div class="line"><a id="l02362" name="l02362"></a><span class="lineno"> 2362</span>        </div>
<div class="line"><a id="l02363" name="l02363"></a><span class="lineno"> 2363</span>      cddz(1)=ala(1)/dz(1)</div>
<div class="line"><a id="l02364" name="l02364"></a><span class="lineno"> 2364</span>      <span class="keywordflow">do</span> iz=2,nz</div>
<div class="line"><a id="l02365" name="l02365"></a><span class="lineno"> 2365</span>         cddz(iz)=2.*ala(iz)/(dz(iz)+dz(iz-1))</div>
<div class="line"><a id="l02366" name="l02366"></a><span class="lineno"> 2366</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l02367" name="l02367"></a><span class="lineno"> 2367</span><span class="comment">!        cddz(nz+1)=ala(nz+1)/dz(nz)</span></div>
<div class="line"><a id="l02368" name="l02368"></a><span class="lineno"> 2368</span>       </div>
<div class="line"><a id="l02369" name="l02369"></a><span class="lineno"> 2369</span>      a(1,1)=0.</div>
<div class="line"><a id="l02370" name="l02370"></a><span class="lineno"> 2370</span>      a(1,2)=1.</div>
<div class="line"><a id="l02371" name="l02371"></a><span class="lineno"> 2371</span>      a(1,3)=0.</div>
<div class="line"><a id="l02372" name="l02372"></a><span class="lineno"> 2372</span>      c(1)=temp(1)</div>
<div class="line"><a id="l02373" name="l02373"></a><span class="lineno"> 2373</span>          </div>
<div class="line"><a id="l02374" name="l02374"></a><span class="lineno"> 2374</span>      <span class="keywordflow">do</span> iz=2,nz-1</div>
<div class="line"><a id="l02375" name="l02375"></a><span class="lineno"> 2375</span>         a(iz,1)=-cddz(iz)*dt/dz(iz)</div>
<div class="line"><a id="l02376" name="l02376"></a><span class="lineno"> 2376</span>         a(iz,2)=1+dt*(cddz(iz)+cddz(iz+1))/dz(iz)          </div>
<div class="line"><a id="l02377" name="l02377"></a><span class="lineno"> 2377</span>         a(iz,3)=-cddz(iz+1)*dt/dz(iz)</div>
<div class="line"><a id="l02378" name="l02378"></a><span class="lineno"> 2378</span>         c(iz)=temp(iz)</div>
<div class="line"><a id="l02379" name="l02379"></a><span class="lineno"> 2379</span><span class="keywordflow">      enddo</span>          </div>
<div class="line"><a id="l02380" name="l02380"></a><span class="lineno"> 2380</span>                     </div>
<div class="line"><a id="l02381" name="l02381"></a><span class="lineno"> 2381</span>      a(nz,1)=-dt*cddz(nz)/dz(nz)</div>
<div class="line"><a id="l02382" name="l02382"></a><span class="lineno"> 2382</span>      a(nz,2)=1.+dt*cddz(nz)/dz(nz)</div>
<div class="line"><a id="l02383" name="l02383"></a><span class="lineno"> 2383</span>      a(nz,3)=0.</div>
<div class="line"><a id="l02384" name="l02384"></a><span class="lineno"> 2384</span>      c(nz)=temp(nz)+dt*alpha/cs(nz)/dz(nz)</div>
<div class="line"><a id="l02385" name="l02385"></a><span class="lineno"> 2385</span> </div>
<div class="line"><a id="l02386" name="l02386"></a><span class="lineno"> 2386</span>      </div>
<div class="line"><a id="l02387" name="l02387"></a><span class="lineno"> 2387</span>      <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a7ede93d00f17bd1c407a69e2f1f566cc">invert</a>(nz,a,c,temp)</div>
<div class="line"><a id="l02388" name="l02388"></a><span class="lineno"> 2388</span> </div>
<div class="line"><a id="l02389" name="l02389"></a><span class="lineno"> 2389</span>           </div>
<div class="line"><a id="l02390" name="l02390"></a><span class="lineno"> 2390</span>      pt=temp(nz)*(press/1.e+5)**(-<a class="code hl_variable" href="namespacemodule__sf__bep.html#a36c77ea97f8e0c964f324b610af15a08">rcp_u</a>)</div>
<div class="line"><a id="l02391" name="l02391"></a><span class="lineno"> 2391</span> </div>
<div class="line"><a id="l02392" name="l02392"></a><span class="lineno"> 2392</span>      rt=(1.-alb)*rs+em*rl-em*<a class="code hl_variable" href="namespacemodule__sf__bep.html#a14b87836842c0cf3cccb0b78fde9b2b0">sigma</a>*(tsig**4)</div>
<div class="line"><a id="l02393" name="l02393"></a><span class="lineno"> 2393</span>                        </div>
<div class="line"><a id="l02394" name="l02394"></a><span class="lineno"> 2394</span><span class="comment">!      gf=-cddz(nz)*(temp(nz)-temp(nz-1))*cs(nz)</span></div>
<div class="line"><a id="l02395" name="l02395"></a><span class="lineno"> 2395</span>       gf=(1.-alb)*rs+em*rl-em*<a class="code hl_variable" href="namespacemodule__sf__bep.html#a14b87836842c0cf3cccb0b78fde9b2b0">sigma</a>*(tsig**4)+sf                                   </div>
<div class="line"><a id="l02396" name="l02396"></a><span class="lineno"> 2396</span>      <span class="keywordflow">return</span></div>
<div class="line"><a id="l02397" name="l02397"></a><span class="lineno"> 2397</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a0928487326d9735901c0825abfec3b5e">soil_temp</a></div>
<div class="line"><a id="l02398" name="l02398"></a><span class="lineno"> 2398</span> </div>
<div class="line"><a id="l02399" name="l02399"></a><span class="lineno"> 2399</span><span class="comment">! ===6=8===============================================================72 </span></div>
<div class="line"><a id="l02400" name="l02400"></a><span class="lineno"> 2400</span><span class="comment">! ===6=8===============================================================72 </span></div>
<div class="line"><a id="l02401" name="l02401"></a><span class="lineno"> 2401</span> </div>
<div class="line"><a id="l02402" name="l02402"></a><span class="lineno"><a class="line" href="namespacemodule__sf__bep.html#a7ede93d00f17bd1c407a69e2f1f566cc"> 2402</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a7ede93d00f17bd1c407a69e2f1f566cc">invert</a>(n,a,c,x)</div>
<div class="line"><a id="l02403" name="l02403"></a><span class="lineno"> 2403</span> </div>
<div class="line"><a id="l02404" name="l02404"></a><span class="lineno"> 2404</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02405" name="l02405"></a><span class="lineno"> 2405</span><span class="comment">!        Inversion and resolution of a tridiagonal matrix</span></div>
<div class="line"><a id="l02406" name="l02406"></a><span class="lineno"> 2406</span><span class="comment">!                   A X = C</span></div>
<div class="line"><a id="l02407" name="l02407"></a><span class="lineno"> 2407</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02408" name="l02408"></a><span class="lineno"> 2408</span> </div>
<div class="line"><a id="l02409" name="l02409"></a><span class="lineno"> 2409</span>      <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l02410" name="l02410"></a><span class="lineno"> 2410</span>                </div>
<div class="line"><a id="l02411" name="l02411"></a><span class="lineno"> 2411</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02412" name="l02412"></a><span class="lineno"> 2412</span><span class="comment">! INPUT:</span></div>
<div class="line"><a id="l02413" name="l02413"></a><span class="lineno"> 2413</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02414" name="l02414"></a><span class="lineno"> 2414</span>       <span class="keywordtype">integer</span> n</div>
<div class="line"><a id="l02415" name="l02415"></a><span class="lineno"> 2415</span><span class="keywordtype">       real</span> a(n,3)              <span class="comment">!  a(*,1) lower diagonal (Ai,i-1)</span></div>
<div class="line"><a id="l02416" name="l02416"></a><span class="lineno"> 2416</span>                                <span class="comment">!  a(*,2) principal diagonal (Ai,i)</span></div>
<div class="line"><a id="l02417" name="l02417"></a><span class="lineno"> 2417</span>                                <span class="comment">!  a(*,3) upper diagonal (Ai,i+1)</span></div>
<div class="line"><a id="l02418" name="l02418"></a><span class="lineno"> 2418</span><span class="keywordtype">       real</span> c(n)</div>
<div class="line"><a id="l02419" name="l02419"></a><span class="lineno"> 2419</span> </div>
<div class="line"><a id="l02420" name="l02420"></a><span class="lineno"> 2420</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02421" name="l02421"></a><span class="lineno"> 2421</span><span class="comment">! OUTPUT:</span></div>
<div class="line"><a id="l02422" name="l02422"></a><span class="lineno"> 2422</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02423" name="l02423"></a><span class="lineno"> 2423</span><span class="keywordtype">       real</span> x(n)    </div>
<div class="line"><a id="l02424" name="l02424"></a><span class="lineno"> 2424</span> </div>
<div class="line"><a id="l02425" name="l02425"></a><span class="lineno"> 2425</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02426" name="l02426"></a><span class="lineno"> 2426</span><span class="comment">! LOCAL:</span></div>
<div class="line"><a id="l02427" name="l02427"></a><span class="lineno"> 2427</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02428" name="l02428"></a><span class="lineno"> 2428</span>       <span class="keywordtype">integer</span> i</div>
<div class="line"><a id="l02429" name="l02429"></a><span class="lineno"> 2429</span> </div>
<div class="line"><a id="l02430" name="l02430"></a><span class="lineno"> 2430</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02431" name="l02431"></a><span class="lineno"> 2431</span><span class="comment">! END VARIABLES DEFINITIONS</span></div>
<div class="line"><a id="l02432" name="l02432"></a><span class="lineno"> 2432</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02433" name="l02433"></a><span class="lineno"> 2433</span>                     </div>
<div class="line"><a id="l02434" name="l02434"></a><span class="lineno"> 2434</span>       <span class="keywordflow">do</span> i=n-1,1,-1                 </div>
<div class="line"><a id="l02435" name="l02435"></a><span class="lineno"> 2435</span>          c(i)=c(i)-a(i,3)*c(i+1)/a(i+1,2)</div>
<div class="line"><a id="l02436" name="l02436"></a><span class="lineno"> 2436</span>          a(i,2)=a(i,2)-a(i,3)*a(i+1,1)/a(i+1,2)</div>
<div class="line"><a id="l02437" name="l02437"></a><span class="lineno"> 2437</span><span class="keywordflow">       enddo</span></div>
<div class="line"><a id="l02438" name="l02438"></a><span class="lineno"> 2438</span>       </div>
<div class="line"><a id="l02439" name="l02439"></a><span class="lineno"> 2439</span>       <span class="keywordflow">do</span> i=2,n        </div>
<div class="line"><a id="l02440" name="l02440"></a><span class="lineno"> 2440</span>          c(i)=c(i)-a(i,1)*c(i-1)/a(i-1,2)</div>
<div class="line"><a id="l02441" name="l02441"></a><span class="lineno"> 2441</span><span class="keywordflow">       enddo</span></div>
<div class="line"><a id="l02442" name="l02442"></a><span class="lineno"> 2442</span>        </div>
<div class="line"><a id="l02443" name="l02443"></a><span class="lineno"> 2443</span>       <span class="keywordflow">do</span> i=1,n</div>
<div class="line"><a id="l02444" name="l02444"></a><span class="lineno"> 2444</span>          x(i)=c(i)/a(i,2)</div>
<div class="line"><a id="l02445" name="l02445"></a><span class="lineno"> 2445</span><span class="keywordflow">       enddo</span></div>
<div class="line"><a id="l02446" name="l02446"></a><span class="lineno"> 2446</span> </div>
<div class="line"><a id="l02447" name="l02447"></a><span class="lineno"> 2447</span>       <span class="keywordflow">return</span></div>
<div class="line"><a id="l02448" name="l02448"></a><span class="lineno"> 2448</span>       <span class="keyword">end subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a7ede93d00f17bd1c407a69e2f1f566cc">invert</a></div>
<div class="line"><a id="l02449" name="l02449"></a><span class="lineno"> 2449</span>  </div>
<div class="line"><a id="l02450" name="l02450"></a><span class="lineno"> 2450</span> </div>
<div class="line"><a id="l02451" name="l02451"></a><span class="lineno"> 2451</span><span class="comment">! ===6=8===============================================================72  </span></div>
<div class="line"><a id="l02452" name="l02452"></a><span class="lineno"> 2452</span><span class="comment">! ===6=8===============================================================72</span></div>
<div class="line"><a id="l02453" name="l02453"></a><span class="lineno"> 2453</span>  </div>
<div class="line"><a id="l02454" name="l02454"></a><span class="lineno"><a class="line" href="namespacemodule__sf__bep.html#afad1f5b9f81d43acb300a4ff02b17d33"> 2454</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#afad1f5b9f81d43acb300a4ff02b17d33">flux_wall</a>(ua,va,pt,da,ptw,uva,vva,uvb,vvb,            &amp;</div>
<div class="line"><a id="l02455" name="l02455"></a><span class="lineno"> 2455</span>                                  tva,tvb,evb,drst,dt)      </div>
<div class="line"><a id="l02456" name="l02456"></a><span class="lineno"> 2456</span>       </div>
<div class="line"><a id="l02457" name="l02457"></a><span class="lineno"> 2457</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02458" name="l02458"></a><span class="lineno"> 2458</span><span class="comment">! This routine computes the surface sources or sinks of momentum, tke,</span></div>
<div class="line"><a id="l02459" name="l02459"></a><span class="lineno"> 2459</span><span class="comment">! and heat from vertical surfaces (walls).   </span></div>
<div class="line"><a id="l02460" name="l02460"></a><span class="lineno"> 2460</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02461" name="l02461"></a><span class="lineno"> 2461</span> </div>
<div class="line"><a id="l02462" name="l02462"></a><span class="lineno"> 2462</span>      <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l02463" name="l02463"></a><span class="lineno"> 2463</span> </div>
<div class="line"><a id="l02464" name="l02464"></a><span class="lineno"> 2464</span>    </div>
<div class="line"><a id="l02465" name="l02465"></a><span class="lineno"> 2465</span>         </div>
<div class="line"><a id="l02466" name="l02466"></a><span class="lineno"> 2466</span><span class="comment">! INPUT:</span></div>
<div class="line"><a id="l02467" name="l02467"></a><span class="lineno"> 2467</span><span class="comment">! -----</span></div>
<div class="line"><a id="l02468" name="l02468"></a><span class="lineno"> 2468</span><span class="keywordtype">      real</span> drst                 <span class="comment">! street directions for the current urban class</span></div>
<div class="line"><a id="l02469" name="l02469"></a><span class="lineno"> 2469</span><span class="keywordtype">      real</span> da                   <span class="comment">! air density</span></div>
<div class="line"><a id="l02470" name="l02470"></a><span class="lineno"> 2470</span><span class="keywordtype">      real</span> pt                   <span class="comment">! potential temperature</span></div>
<div class="line"><a id="l02471" name="l02471"></a><span class="lineno"> 2471</span><span class="keywordtype">      real</span> ptw                  <span class="comment">! Walls potential temperatures </span></div>
<div class="line"><a id="l02472" name="l02472"></a><span class="lineno"> 2472</span><span class="keywordtype">      real</span> ua                   <span class="comment">! wind speed</span></div>
<div class="line"><a id="l02473" name="l02473"></a><span class="lineno"> 2473</span><span class="keywordtype">      real</span> va                   <span class="comment">! wind speed</span></div>
<div class="line"><a id="l02474" name="l02474"></a><span class="lineno"> 2474</span> </div>
<div class="line"><a id="l02475" name="l02475"></a><span class="lineno"> 2475</span><span class="keywordtype">      real</span> dt                   <span class="comment">!time step</span></div>
<div class="line"><a id="l02476" name="l02476"></a><span class="lineno"> 2476</span><span class="comment">! OUTPUT:</span></div>
<div class="line"><a id="l02477" name="l02477"></a><span class="lineno"> 2477</span><span class="comment">! ------</span></div>
<div class="line"><a id="l02478" name="l02478"></a><span class="lineno"> 2478</span><span class="comment">! Explicit and implicit component of the momentum, temperature and TKE sources or sinks on</span></div>
<div class="line"><a id="l02479" name="l02479"></a><span class="lineno"> 2479</span><span class="comment">! vertical surfaces (walls).</span></div>
<div class="line"><a id="l02480" name="l02480"></a><span class="lineno"> 2480</span><span class="comment">! The fluxes can be computed as follow: Fluxes of X = A*X + B</span></div>
<div class="line"><a id="l02481" name="l02481"></a><span class="lineno"> 2481</span><span class="comment">!  Example: Momentum fluxes on vertical surfaces = uva_u * ua_u + uvb_u</span></div>
<div class="line"><a id="l02482" name="l02482"></a><span class="lineno"> 2482</span><span class="keywordtype">      real</span> uva                  <span class="comment">! U (wind component)   Vertical surfaces, A (implicit) term</span></div>
<div class="line"><a id="l02483" name="l02483"></a><span class="lineno"> 2483</span><span class="keywordtype">      real</span> uvb                  <span class="comment">! U (wind component)   Vertical surfaces, B (explicit) term</span></div>
<div class="line"><a id="l02484" name="l02484"></a><span class="lineno"> 2484</span><span class="keywordtype">      real</span> vva                  <span class="comment">! V (wind component)   Vertical surfaces, A (implicit) term</span></div>
<div class="line"><a id="l02485" name="l02485"></a><span class="lineno"> 2485</span><span class="keywordtype">      real</span> vvb                  <span class="comment">! V (wind component)   Vertical surfaces, B (explicit) term</span></div>
<div class="line"><a id="l02486" name="l02486"></a><span class="lineno"> 2486</span><span class="keywordtype">      real</span> tva                  <span class="comment">! Temperature          Vertical surfaces, A (implicit) term</span></div>
<div class="line"><a id="l02487" name="l02487"></a><span class="lineno"> 2487</span><span class="keywordtype">      real</span> tvb                  <span class="comment">! Temperature          Vertical surfaces, B (explicit) term</span></div>
<div class="line"><a id="l02488" name="l02488"></a><span class="lineno"> 2488</span><span class="keywordtype">      real</span> evb                  <span class="comment">! Energy (TKE)         Vertical surfaces, B (explicit) term</span></div>
<div class="line"><a id="l02489" name="l02489"></a><span class="lineno"> 2489</span> </div>
<div class="line"><a id="l02490" name="l02490"></a><span class="lineno"> 2490</span><span class="comment">! LOCAL:</span></div>
<div class="line"><a id="l02491" name="l02491"></a><span class="lineno"> 2491</span><span class="comment">! -----</span></div>
<div class="line"><a id="l02492" name="l02492"></a><span class="lineno"> 2492</span><span class="keywordtype">      real</span> hc</div>
<div class="line"><a id="l02493" name="l02493"></a><span class="lineno"> 2493</span><span class="keywordtype">      real</span> u_ort</div>
<div class="line"><a id="l02494" name="l02494"></a><span class="lineno"> 2494</span><span class="keywordtype">      real</span> vett</div>
<div class="line"><a id="l02495" name="l02495"></a><span class="lineno"> 2495</span> </div>
<div class="line"><a id="l02496" name="l02496"></a><span class="lineno"> 2496</span><span class="comment">! -------------------------</span></div>
<div class="line"><a id="l02497" name="l02497"></a><span class="lineno"> 2497</span><span class="comment">! END VARIABLES DEFINITIONS</span></div>
<div class="line"><a id="l02498" name="l02498"></a><span class="lineno"> 2498</span><span class="comment">! -------------------------</span></div>
<div class="line"><a id="l02499" name="l02499"></a><span class="lineno"> 2499</span> </div>
<div class="line"><a id="l02500" name="l02500"></a><span class="lineno"> 2500</span>      vett=(ua**2+va**2)**.5         </div>
<div class="line"><a id="l02501" name="l02501"></a><span class="lineno"> 2501</span>         </div>
<div class="line"><a id="l02502" name="l02502"></a><span class="lineno"> 2502</span>      u_ort=abs((cos(drst)*ua-sin(drst)*va))</div>
<div class="line"><a id="l02503" name="l02503"></a><span class="lineno"> 2503</span>       </div>
<div class="line"><a id="l02504" name="l02504"></a><span class="lineno"> 2504</span>      uva=-<a class="code hl_variable" href="namespacemodule__sf__bep.html#ab1764f8546c93ef96e065809e96f5999">cdrag</a>*u_ort/2.*cos(drst)*cos(drst)</div>
<div class="line"><a id="l02505" name="l02505"></a><span class="lineno"> 2505</span>      vva=-<a class="code hl_variable" href="namespacemodule__sf__bep.html#ab1764f8546c93ef96e065809e96f5999">cdrag</a>*u_ort/2.*sin(drst)*sin(drst)</div>
<div class="line"><a id="l02506" name="l02506"></a><span class="lineno"> 2506</span>         </div>
<div class="line"><a id="l02507" name="l02507"></a><span class="lineno"> 2507</span>      uvb=<a class="code hl_variable" href="namespacemodule__sf__bep.html#ab1764f8546c93ef96e065809e96f5999">cdrag</a>*u_ort/2.*sin(drst)*cos(drst)*va</div>
<div class="line"><a id="l02508" name="l02508"></a><span class="lineno"> 2508</span>      vvb=<a class="code hl_variable" href="namespacemodule__sf__bep.html#ab1764f8546c93ef96e065809e96f5999">cdrag</a>*u_ort/2.*sin(drst)*cos(drst)*ua</div>
<div class="line"><a id="l02509" name="l02509"></a><span class="lineno"> 2509</span>         </div>
<div class="line"><a id="l02510" name="l02510"></a><span class="lineno"> 2510</span>      hc=5.678*(1.09+0.23*(vett/0.3048))  </div>
<div class="line"><a id="l02511" name="l02511"></a><span class="lineno"> 2511</span> </div>
<div class="line"><a id="l02512" name="l02512"></a><span class="lineno"> 2512</span>      <span class="keywordflow">if</span>(hc.gt.da*<a class="code hl_variable" href="namespacemodule__sf__bep.html#ae322728a3b7be919f956d83fcfbcc60a">cp_u</a>/dt)<span class="keywordflow">then</span></div>
<div class="line"><a id="l02513" name="l02513"></a><span class="lineno"> 2513</span>        hc=da*<a class="code hl_variable" href="namespacemodule__sf__bep.html#ae322728a3b7be919f956d83fcfbcc60a">cp_u</a>/dt</div>
<div class="line"><a id="l02514" name="l02514"></a><span class="lineno"> 2514</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l02515" name="l02515"></a><span class="lineno"> 2515</span>         </div>
<div class="line"><a id="l02516" name="l02516"></a><span class="lineno"> 2516</span><span class="comment">!         tvb=hc*ptw/da/cp_u</span></div>
<div class="line"><a id="l02517" name="l02517"></a><span class="lineno"> 2517</span><span class="comment">!         tva=-hc/da/cp_u</span></div>
<div class="line"><a id="l02518" name="l02518"></a><span class="lineno"> 2518</span><span class="comment">!!!!!!!!!!!!!!!!!!!!</span></div>
<div class="line"><a id="l02519" name="l02519"></a><span class="lineno"> 2519</span><span class="comment">! explicit </span></div>
<div class="line"><a id="l02520" name="l02520"></a><span class="lineno"> 2520</span>      tvb=hc*ptw/da/<a class="code hl_variable" href="namespacemodule__sf__bep.html#ae322728a3b7be919f956d83fcfbcc60a">cp_u</a>-hc/da/<a class="code hl_variable" href="namespacemodule__sf__bep.html#ae322728a3b7be919f956d83fcfbcc60a">cp_u</a>*pt <span class="comment">!c</span></div>
<div class="line"><a id="l02521" name="l02521"></a><span class="lineno"> 2521</span>      tva = 0.                  <span class="comment">!c</span></div>
<div class="line"><a id="l02522" name="l02522"></a><span class="lineno"> 2522</span>         </div>
<div class="line"><a id="l02523" name="l02523"></a><span class="lineno"> 2523</span>      evb=<a class="code hl_variable" href="namespacemodule__sf__bep.html#ab1764f8546c93ef96e065809e96f5999">cdrag</a>*(abs(u_ort)**3.)/2.</div>
<div class="line"><a id="l02524" name="l02524"></a><span class="lineno"> 2524</span>              </div>
<div class="line"><a id="l02525" name="l02525"></a><span class="lineno"> 2525</span>      <span class="keywordflow">return</span></div>
<div class="line"><a id="l02526" name="l02526"></a><span class="lineno"> 2526</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#afad1f5b9f81d43acb300a4ff02b17d33">flux_wall</a></div>
<div class="line"><a id="l02527" name="l02527"></a><span class="lineno"> 2527</span>         </div>
<div class="line"><a id="l02528" name="l02528"></a><span class="lineno"> 2528</span><span class="comment">! ===6=8===============================================================72</span></div>
<div class="line"><a id="l02529" name="l02529"></a><span class="lineno"> 2529</span> </div>
<div class="line"><a id="l02530" name="l02530"></a><span class="lineno"> 2530</span><span class="comment">! ===6=8===============================================================72</span></div>
<div class="line"><a id="l02531" name="l02531"></a><span class="lineno"> 2531</span> </div>
<div class="line"><a id="l02532" name="l02532"></a><span class="lineno"><a class="line" href="namespacemodule__sf__bep.html#a6de67ff4391d9d6c0f924fb424e6b208"> 2532</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a6de67ff4391d9d6c0f924fb424e6b208">flux_flat</a>(dz,z0,ua,va,pt,pt0,ptg,                     &amp;</div>
<div class="line"><a id="l02533" name="l02533"></a><span class="lineno"> 2533</span>                          uhb,vhb,thb,ehb)</div>
<div class="line"><a id="l02534" name="l02534"></a><span class="lineno"> 2534</span>                                </div>
<div class="line"><a id="l02535" name="l02535"></a><span class="lineno"> 2535</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02536" name="l02536"></a><span class="lineno"> 2536</span><span class="comment">!           Calculation of the flux at the ground </span></div>
<div class="line"><a id="l02537" name="l02537"></a><span class="lineno"> 2537</span><span class="comment">!           Formulation of Louis (Louis, 1979)       </span></div>
<div class="line"><a id="l02538" name="l02538"></a><span class="lineno"> 2538</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02539" name="l02539"></a><span class="lineno"> 2539</span> </div>
<div class="line"><a id="l02540" name="l02540"></a><span class="lineno"> 2540</span>      <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l02541" name="l02541"></a><span class="lineno"> 2541</span> </div>
<div class="line"><a id="l02542" name="l02542"></a><span class="lineno"> 2542</span>     </div>
<div class="line"><a id="l02543" name="l02543"></a><span class="lineno"> 2543</span> </div>
<div class="line"><a id="l02544" name="l02544"></a><span class="lineno"> 2544</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02545" name="l02545"></a><span class="lineno"> 2545</span><span class="comment">! INPUT:</span></div>
<div class="line"><a id="l02546" name="l02546"></a><span class="lineno"> 2546</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02547" name="l02547"></a><span class="lineno"> 2547</span><span class="keywordtype">      real</span> dz                   <span class="comment">! first vertical level</span></div>
<div class="line"><a id="l02548" name="l02548"></a><span class="lineno"> 2548</span><span class="keywordtype">      real</span> pt                   <span class="comment">! potential temperature</span></div>
<div class="line"><a id="l02549" name="l02549"></a><span class="lineno"> 2549</span><span class="keywordtype">      real</span> pt0                  <span class="comment">! reference potential temperature</span></div>
<div class="line"><a id="l02550" name="l02550"></a><span class="lineno"> 2550</span><span class="keywordtype">      real</span> ptg                  <span class="comment">! ground potential temperature</span></div>
<div class="line"><a id="l02551" name="l02551"></a><span class="lineno"> 2551</span><span class="keywordtype">      real</span> ua                   <span class="comment">! wind speed</span></div>
<div class="line"><a id="l02552" name="l02552"></a><span class="lineno"> 2552</span><span class="keywordtype">      real</span> va                   <span class="comment">! wind speed</span></div>
<div class="line"><a id="l02553" name="l02553"></a><span class="lineno"> 2553</span><span class="keywordtype">      real</span> z0                   <span class="comment">! Roughness length</span></div>
<div class="line"><a id="l02554" name="l02554"></a><span class="lineno"> 2554</span> </div>
<div class="line"><a id="l02555" name="l02555"></a><span class="lineno"> 2555</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02556" name="l02556"></a><span class="lineno"> 2556</span><span class="comment">! OUTPUT:</span></div>
<div class="line"><a id="l02557" name="l02557"></a><span class="lineno"> 2557</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02558" name="l02558"></a><span class="lineno"> 2558</span><span class="comment">! Explicit component of the momentum, temperature and TKE sources or sinks on horizontal </span></div>
<div class="line"><a id="l02559" name="l02559"></a><span class="lineno"> 2559</span><span class="comment">!  surfaces (roofs and street)</span></div>
<div class="line"><a id="l02560" name="l02560"></a><span class="lineno"> 2560</span><span class="comment">! The fluxes can be computed as follow: Fluxes of X = B</span></div>
<div class="line"><a id="l02561" name="l02561"></a><span class="lineno"> 2561</span><span class="comment">!  Example: Momentum fluxes on horizontal surfaces =  uhb_u</span></div>
<div class="line"><a id="l02562" name="l02562"></a><span class="lineno"> 2562</span><span class="keywordtype">      real</span> uhb                  <span class="comment">! U (wind component) Horizontal surfaces, B (explicit) term</span></div>
<div class="line"><a id="l02563" name="l02563"></a><span class="lineno"> 2563</span><span class="keywordtype">      real</span> vhb                  <span class="comment">! V (wind component) Horizontal surfaces, B (explicit) term</span></div>
<div class="line"><a id="l02564" name="l02564"></a><span class="lineno"> 2564</span><span class="keywordtype">      real</span> thb                  <span class="comment">! Temperature        Horizontal surfaces, B (explicit) term</span></div>
<div class="line"><a id="l02565" name="l02565"></a><span class="lineno"> 2565</span><span class="keywordtype">      real</span> tva                  <span class="comment">! Temperature          Vertical surfaces, A (implicit) term</span></div>
<div class="line"><a id="l02566" name="l02566"></a><span class="lineno"> 2566</span><span class="keywordtype">      real</span> tvb                  <span class="comment">! Temperature          Vertical surfaces, B (explicit) term</span></div>
<div class="line"><a id="l02567" name="l02567"></a><span class="lineno"> 2567</span><span class="keywordtype">      real</span> ehb                  <span class="comment">! Energy (TKE)       Horizontal surfaces, B (explicit) term</span></div>
<div class="line"><a id="l02568" name="l02568"></a><span class="lineno"> 2568</span> </div>
<div class="line"><a id="l02569" name="l02569"></a><span class="lineno"> 2569</span> </div>
<div class="line"><a id="l02570" name="l02570"></a><span class="lineno"> 2570</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02571" name="l02571"></a><span class="lineno"> 2571</span><span class="comment">! LOCAL:</span></div>
<div class="line"><a id="l02572" name="l02572"></a><span class="lineno"> 2572</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02573" name="l02573"></a><span class="lineno"> 2573</span><span class="keywordtype">      real</span> aa</div>
<div class="line"><a id="l02574" name="l02574"></a><span class="lineno"> 2574</span><span class="keywordtype">      real</span> al</div>
<div class="line"><a id="l02575" name="l02575"></a><span class="lineno"> 2575</span><span class="keywordtype">      real</span> buu</div>
<div class="line"><a id="l02576" name="l02576"></a><span class="lineno"> 2576</span><span class="keywordtype">      real</span> c</div>
<div class="line"><a id="l02577" name="l02577"></a><span class="lineno"> 2577</span><span class="keywordtype">      real</span> fbuw</div>
<div class="line"><a id="l02578" name="l02578"></a><span class="lineno"> 2578</span><span class="keywordtype">      real</span> fbpt</div>
<div class="line"><a id="l02579" name="l02579"></a><span class="lineno"> 2579</span><span class="keywordtype">      real</span> fh</div>
<div class="line"><a id="l02580" name="l02580"></a><span class="lineno"> 2580</span><span class="keywordtype">      real</span> fm</div>
<div class="line"><a id="l02581" name="l02581"></a><span class="lineno"> 2581</span><span class="keywordtype">      real</span> ric</div>
<div class="line"><a id="l02582" name="l02582"></a><span class="lineno"> 2582</span><span class="keywordtype">      real</span> tstar</div>
<div class="line"><a id="l02583" name="l02583"></a><span class="lineno"> 2583</span><span class="keywordtype">      real</span> ustar</div>
<div class="line"><a id="l02584" name="l02584"></a><span class="lineno"> 2584</span><span class="keywordtype">      real</span> utot</div>
<div class="line"><a id="l02585" name="l02585"></a><span class="lineno"> 2585</span><span class="keywordtype">      real</span> wstar</div>
<div class="line"><a id="l02586" name="l02586"></a><span class="lineno"> 2586</span><span class="keywordtype">      real</span> zz</div>
<div class="line"><a id="l02587" name="l02587"></a><span class="lineno"> 2587</span>      </div>
<div class="line"><a id="l02588" name="l02588"></a><span class="lineno"> 2588</span><span class="keywordtype">      real</span> b,cm,ch,rr,tol</div>
<div class="line"><a id="l02589" name="l02589"></a><span class="lineno"> 2589</span>      parameter(b=9.4,cm=7.4,ch=5.3,rr=0.74,tol=.001)</div>
<div class="line"><a id="l02590" name="l02590"></a><span class="lineno"> 2590</span> </div>
<div class="line"><a id="l02591" name="l02591"></a><span class="lineno"> 2591</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02592" name="l02592"></a><span class="lineno"> 2592</span><span class="comment">! END VARIABLES DEFINITIONS</span></div>
<div class="line"><a id="l02593" name="l02593"></a><span class="lineno"> 2593</span><span class="comment">! ----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02594" name="l02594"></a><span class="lineno"> 2594</span> </div>
<div class="line"><a id="l02595" name="l02595"></a><span class="lineno"> 2595</span> </div>
<div class="line"><a id="l02596" name="l02596"></a><span class="lineno"> 2596</span><span class="comment">! computation of the ground temperature</span></div>
<div class="line"><a id="l02597" name="l02597"></a><span class="lineno"> 2597</span>         </div>
<div class="line"><a id="l02598" name="l02598"></a><span class="lineno"> 2598</span>      utot=(ua**2+va**2)**.5</div>
<div class="line"><a id="l02599" name="l02599"></a><span class="lineno"> 2599</span>        </div>
<div class="line"><a id="l02600" name="l02600"></a><span class="lineno"> 2600</span>      </div>
<div class="line"><a id="l02601" name="l02601"></a><span class="lineno"> 2601</span><span class="comment">!!!! Louis formulation</span></div>
<div class="line"><a id="l02602" name="l02602"></a><span class="lineno"> 2602</span><span class="comment">!</span></div>
<div class="line"><a id="l02603" name="l02603"></a><span class="lineno"> 2603</span><span class="comment">! compute the bulk Richardson Number</span></div>
<div class="line"><a id="l02604" name="l02604"></a><span class="lineno"> 2604</span> </div>
<div class="line"><a id="l02605" name="l02605"></a><span class="lineno"> 2605</span>      zz=dz/2.</div>
<div class="line"><a id="l02606" name="l02606"></a><span class="lineno"> 2606</span>   </div>
<div class="line"><a id="l02607" name="l02607"></a><span class="lineno"> 2607</span><span class="comment">!        if(tstar.lt.0.)then</span></div>
<div class="line"><a id="l02608" name="l02608"></a><span class="lineno"> 2608</span><span class="comment">!         wstar=(-ustar*tstar*g*hii/pt)**(1./3.)</span></div>
<div class="line"><a id="l02609" name="l02609"></a><span class="lineno"> 2609</span><span class="comment">!        else</span></div>
<div class="line"><a id="l02610" name="l02610"></a><span class="lineno"> 2610</span><span class="comment">!         wstar=0.</span></div>
<div class="line"><a id="l02611" name="l02611"></a><span class="lineno"> 2611</span><span class="comment">!        endif</span></div>
<div class="line"><a id="l02612" name="l02612"></a><span class="lineno"> 2612</span><span class="comment">!        </span></div>
<div class="line"><a id="l02613" name="l02613"></a><span class="lineno"> 2613</span><span class="comment">!      if (utot.le.0.7*wstar) utot=max(0.7*wstar,0.00001)</span></div>
<div class="line"><a id="l02614" name="l02614"></a><span class="lineno"> 2614</span> </div>
<div class="line"><a id="l02615" name="l02615"></a><span class="lineno"> 2615</span>      utot=max(utot,0.01)</div>
<div class="line"><a id="l02616" name="l02616"></a><span class="lineno"> 2616</span>          </div>
<div class="line"><a id="l02617" name="l02617"></a><span class="lineno"> 2617</span>      ric=2.*<a class="code hl_variable" href="namespacemodule__sf__bep.html#accfe04a9ac7c32180691c196e2e00d4a">g_u</a>*zz*(pt-ptg)/((pt+ptg)*(utot**2))</div>
<div class="line"><a id="l02618" name="l02618"></a><span class="lineno"> 2618</span>              </div>
<div class="line"><a id="l02619" name="l02619"></a><span class="lineno"> 2619</span>      aa=<a class="code hl_variable" href="namespacemodule__sf__bep.html#ac956b0ccc4743b9847b8f9e2c5e5ad63">vk</a>/log(zz/z0)</div>
<div class="line"><a id="l02620" name="l02620"></a><span class="lineno"> 2620</span> </div>
<div class="line"><a id="l02621" name="l02621"></a><span class="lineno"> 2621</span><span class="comment">! determine the parameters fm and fh for stable, neutral and unstable conditions</span></div>
<div class="line"><a id="l02622" name="l02622"></a><span class="lineno"> 2622</span> </div>
<div class="line"><a id="l02623" name="l02623"></a><span class="lineno"> 2623</span>      <span class="keywordflow">if</span>(ric.gt.0)<span class="keywordflow">then</span></div>
<div class="line"><a id="l02624" name="l02624"></a><span class="lineno"> 2624</span>         fm=1/(1+0.5*b*ric)**2</div>
<div class="line"><a id="l02625" name="l02625"></a><span class="lineno"> 2625</span>         fh=fm</div>
<div class="line"><a id="l02626" name="l02626"></a><span class="lineno"> 2626</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l02627" name="l02627"></a><span class="lineno"> 2627</span>         c=b*cm*aa*aa*(zz/z0)**.5</div>
<div class="line"><a id="l02628" name="l02628"></a><span class="lineno"> 2628</span>         fm=1-b*ric/(1+c*(-ric)**.5)</div>
<div class="line"><a id="l02629" name="l02629"></a><span class="lineno"> 2629</span>         c=c*ch/cm</div>
<div class="line"><a id="l02630" name="l02630"></a><span class="lineno"> 2630</span>         fh=1-b*ric/(1+c*(-ric)**.5)</div>
<div class="line"><a id="l02631" name="l02631"></a><span class="lineno"> 2631</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l02632" name="l02632"></a><span class="lineno"> 2632</span>      </div>
<div class="line"><a id="l02633" name="l02633"></a><span class="lineno"> 2633</span>      fbuw=-aa*aa*utot*utot*fm</div>
<div class="line"><a id="l02634" name="l02634"></a><span class="lineno"> 2634</span>      fbpt=-aa*aa*utot*(pt-ptg)*fh/rr</div>
<div class="line"><a id="l02635" name="l02635"></a><span class="lineno"> 2635</span>                     </div>
<div class="line"><a id="l02636" name="l02636"></a><span class="lineno"> 2636</span>      ustar=(-fbuw)**.5</div>
<div class="line"><a id="l02637" name="l02637"></a><span class="lineno"> 2637</span>      tstar=-fbpt/ustar</div>
<div class="line"><a id="l02638" name="l02638"></a><span class="lineno"> 2638</span> </div>
<div class="line"><a id="l02639" name="l02639"></a><span class="lineno"> 2639</span>      al=(<a class="code hl_variable" href="namespacemodule__sf__bep.html#ac956b0ccc4743b9847b8f9e2c5e5ad63">vk</a>*<a class="code hl_variable" href="namespacemodule__sf__bep.html#accfe04a9ac7c32180691c196e2e00d4a">g_u</a>*tstar)/(pt*ustar*ustar)                      </div>
<div class="line"><a id="l02640" name="l02640"></a><span class="lineno"> 2640</span>      </div>
<div class="line"><a id="l02641" name="l02641"></a><span class="lineno"> 2641</span>      buu=-<a class="code hl_variable" href="namespacemodule__sf__bep.html#accfe04a9ac7c32180691c196e2e00d4a">g_u</a>/pt0*ustar*tstar</div>
<div class="line"><a id="l02642" name="l02642"></a><span class="lineno"> 2642</span>       </div>
<div class="line"><a id="l02643" name="l02643"></a><span class="lineno"> 2643</span>      uhb=-ustar*ustar*ua/utot</div>
<div class="line"><a id="l02644" name="l02644"></a><span class="lineno"> 2644</span>      vhb=-ustar*ustar*va/utot </div>
<div class="line"><a id="l02645" name="l02645"></a><span class="lineno"> 2645</span>      thb=-ustar*tstar       </div>
<div class="line"><a id="l02646" name="l02646"></a><span class="lineno"> 2646</span><span class="comment">!      thb= 0.      </span></div>
<div class="line"><a id="l02647" name="l02647"></a><span class="lineno"> 2647</span>      ehb=buu</div>
<div class="line"><a id="l02648" name="l02648"></a><span class="lineno"> 2648</span><span class="comment">!!!!!!!!!!!!!!!</span></div>
<div class="line"><a id="l02649" name="l02649"></a><span class="lineno"> 2649</span>         </div>
<div class="line"><a id="l02650" name="l02650"></a><span class="lineno"> 2650</span>      <span class="keywordflow">return</span></div>
<div class="line"><a id="l02651" name="l02651"></a><span class="lineno"> 2651</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a6de67ff4391d9d6c0f924fb424e6b208">flux_flat</a></div>
<div class="line"><a id="l02652" name="l02652"></a><span class="lineno"> 2652</span> </div>
<div class="line"><a id="l02653" name="l02653"></a><span class="lineno"> 2653</span><span class="comment">! ===6=8===============================================================72</span></div>
<div class="line"><a id="l02654" name="l02654"></a><span class="lineno"> 2654</span><span class="comment">! ===6=8===============================================================72</span></div>
<div class="line"><a id="l02655" name="l02655"></a><span class="lineno"> 2655</span> </div>
<div class="line"><a id="l02656" name="l02656"></a><span class="lineno"><a class="line" href="namespacemodule__sf__bep.html#ac457b6929ba12db21a3d49ebbacc2508"> 2656</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#ac457b6929ba12db21a3d49ebbacc2508">icbep</a> (nd_u,h_b,d_b,ss_u,pb_u,nz_u,z_u)                               </div>
<div class="line"><a id="l02657" name="l02657"></a><span class="lineno"> 2657</span> </div>
<div class="line"><a id="l02658" name="l02658"></a><span class="lineno"> 2658</span>      <span class="keywordtype">implicit none</span>       </div>
<div class="line"><a id="l02659" name="l02659"></a><span class="lineno"> 2659</span>        </div>
<div class="line"><a id="l02660" name="l02660"></a><span class="lineno"> 2660</span> </div>
<div class="line"><a id="l02661" name="l02661"></a><span class="lineno"> 2661</span><span class="comment">!    Street parameters</span></div>
<div class="line"><a id="l02662" name="l02662"></a><span class="lineno"> 2662</span>      <span class="keywordtype">integer</span> nd_u(nurbm)     <span class="comment">! Number of street direction for each urban class</span></div>
<div class="line"><a id="l02663" name="l02663"></a><span class="lineno"> 2663</span><span class="keywordtype">      real</span> h_b(nz_um,nurbm)   <span class="comment">! Bulding&#39;s heights [m]</span></div>
<div class="line"><a id="l02664" name="l02664"></a><span class="lineno"> 2664</span><span class="keywordtype">      real</span> d_b(nz_um,nurbm)   <span class="comment">! The probability that a building has an height h_b</span></div>
<div class="line"><a id="l02665" name="l02665"></a><span class="lineno"> 2665</span><span class="comment">! -----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02666" name="l02666"></a><span class="lineno"> 2666</span><span class="comment">!     Output</span></div>
<div class="line"><a id="l02667" name="l02667"></a><span class="lineno"> 2667</span><span class="comment">!------------------------------------------------------------------------</span></div>
<div class="line"><a id="l02668" name="l02668"></a><span class="lineno"> 2668</span> </div>
<div class="line"><a id="l02669" name="l02669"></a><span class="lineno"> 2669</span><span class="keywordtype">      real</span> ss_u(nz_um,nurbm)     <span class="comment">! The probability that a building has an height equal to z</span></div>
<div class="line"><a id="l02670" name="l02670"></a><span class="lineno"> 2670</span><span class="keywordtype">      real</span> pb_u(nz_um,nurbm)     <span class="comment">! The probability that a building has an height greater or equal to z</span></div>
<div class="line"><a id="l02671" name="l02671"></a><span class="lineno"> 2671</span>        </div>
<div class="line"><a id="l02672" name="l02672"></a><span class="lineno"> 2672</span><span class="comment">!    Grid parameters</span></div>
<div class="line"><a id="l02673" name="l02673"></a><span class="lineno"> 2673</span>      <span class="keywordtype">integer</span> nz_u(nurbm)     <span class="comment">! Number of layer in the urban grid</span></div>
<div class="line"><a id="l02674" name="l02674"></a><span class="lineno"> 2674</span><span class="keywordtype">      real</span> z_u(nz_um)       <span class="comment">! Height of the urban grid levels</span></div>
<div class="line"><a id="l02675" name="l02675"></a><span class="lineno"> 2675</span> </div>
<div class="line"><a id="l02676" name="l02676"></a><span class="lineno"> 2676</span> </div>
<div class="line"><a id="l02677" name="l02677"></a><span class="lineno"> 2677</span><span class="comment">! -----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02678" name="l02678"></a><span class="lineno"> 2678</span><span class="comment">!     Local</span></div>
<div class="line"><a id="l02679" name="l02679"></a><span class="lineno"> 2679</span><span class="comment">!------------------------------------------------------------------------</span></div>
<div class="line"><a id="l02680" name="l02680"></a><span class="lineno"> 2680</span> </div>
<div class="line"><a id="l02681" name="l02681"></a><span class="lineno"> 2681</span>      <span class="keywordtype">integer</span> iz_u,id,ilu,iurb</div>
<div class="line"><a id="l02682" name="l02682"></a><span class="lineno"> 2682</span> </div>
<div class="line"><a id="l02683" name="l02683"></a><span class="lineno"> 2683</span><span class="keywordtype">      real</span> dtot</div>
<div class="line"><a id="l02684" name="l02684"></a><span class="lineno"> 2684</span><span class="keywordtype">      real</span> hbmax</div>
<div class="line"><a id="l02685" name="l02685"></a><span class="lineno"> 2685</span> </div>
<div class="line"><a id="l02686" name="l02686"></a><span class="lineno"> 2686</span><span class="comment">!------------------------------------------------------------------------</span></div>
<div class="line"><a id="l02687" name="l02687"></a><span class="lineno"> 2687</span>     </div>
<div class="line"><a id="l02688" name="l02688"></a><span class="lineno"> 2688</span> </div>
<div class="line"><a id="l02689" name="l02689"></a><span class="lineno"> 2689</span><span class="comment">! -----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02690" name="l02690"></a><span class="lineno"> 2690</span><span class="comment">!     This routine initialise the urban paramters for the BEP module</span></div>
<div class="line"><a id="l02691" name="l02691"></a><span class="lineno"> 2691</span><span class="comment">!------------------------------------------------------------------------</span></div>
<div class="line"><a id="l02692" name="l02692"></a><span class="lineno"> 2692</span><span class="comment">!</span></div>
<div class="line"><a id="l02693" name="l02693"></a><span class="lineno"> 2693</span><span class="comment">!Initialize variables</span></div>
<div class="line"><a id="l02694" name="l02694"></a><span class="lineno"> 2694</span><span class="comment">!</span></div>
<div class="line"><a id="l02695" name="l02695"></a><span class="lineno"> 2695</span>      z_u=0.</div>
<div class="line"><a id="l02696" name="l02696"></a><span class="lineno"> 2696</span>      nz_u=0</div>
<div class="line"><a id="l02697" name="l02697"></a><span class="lineno"> 2697</span>      ss_u=0.</div>
<div class="line"><a id="l02698" name="l02698"></a><span class="lineno"> 2698</span>      pb_u=0.</div>
<div class="line"><a id="l02699" name="l02699"></a><span class="lineno"> 2699</span> </div>
<div class="line"><a id="l02700" name="l02700"></a><span class="lineno"> 2700</span><span class="comment">! Computation of the urban levels height</span></div>
<div class="line"><a id="l02701" name="l02701"></a><span class="lineno"> 2701</span> </div>
<div class="line"><a id="l02702" name="l02702"></a><span class="lineno"> 2702</span>      z_u(1)=0.</div>
<div class="line"><a id="l02703" name="l02703"></a><span class="lineno"> 2703</span>     </div>
<div class="line"><a id="l02704" name="l02704"></a><span class="lineno"> 2704</span>      <span class="keywordflow">do</span> iz_u=1,nz_um-1</div>
<div class="line"><a id="l02705" name="l02705"></a><span class="lineno"> 2705</span>         z_u(iz_u+1)=z_u(iz_u)+<a class="code hl_variable" href="namespacemodule__sf__bep.html#a0d52a26f82bd0c0cf8a76bea001c9905">dz_u</a></div>
<div class="line"><a id="l02706" name="l02706"></a><span class="lineno"> 2706</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l02707" name="l02707"></a><span class="lineno"> 2707</span>      </div>
<div class="line"><a id="l02708" name="l02708"></a><span class="lineno"> 2708</span><span class="comment">! Normalisation of the building density</span></div>
<div class="line"><a id="l02709" name="l02709"></a><span class="lineno"> 2709</span> </div>
<div class="line"><a id="l02710" name="l02710"></a><span class="lineno"> 2710</span>      <span class="keywordflow">do</span> iurb=1,nurbm</div>
<div class="line"><a id="l02711" name="l02711"></a><span class="lineno"> 2711</span>         dtot=0.</div>
<div class="line"><a id="l02712" name="l02712"></a><span class="lineno"> 2712</span>         <span class="keywordflow">do</span> ilu=1,nz_um</div>
<div class="line"><a id="l02713" name="l02713"></a><span class="lineno"> 2713</span>            dtot=dtot+d_b(ilu,iurb)</div>
<div class="line"><a id="l02714" name="l02714"></a><span class="lineno"> 2714</span><span class="keywordflow">         enddo</span></div>
<div class="line"><a id="l02715" name="l02715"></a><span class="lineno"> 2715</span>         <span class="keywordflow">do</span> ilu=1,nz_um</div>
<div class="line"><a id="l02716" name="l02716"></a><span class="lineno"> 2716</span>            d_b(ilu,iurb)=d_b(ilu,iurb)/dtot</div>
<div class="line"><a id="l02717" name="l02717"></a><span class="lineno"> 2717</span><span class="keywordflow">         enddo</span></div>
<div class="line"><a id="l02718" name="l02718"></a><span class="lineno"> 2718</span><span class="keywordflow">      enddo</span>      </div>
<div class="line"><a id="l02719" name="l02719"></a><span class="lineno"> 2719</span> </div>
<div class="line"><a id="l02720" name="l02720"></a><span class="lineno"> 2720</span><span class="comment">! Compute the view factors, pb and ss </span></div>
<div class="line"><a id="l02721" name="l02721"></a><span class="lineno"> 2721</span>      </div>
<div class="line"><a id="l02722" name="l02722"></a><span class="lineno"> 2722</span>      <span class="keywordflow">do</span> iurb=1,nurbm         </div>
<div class="line"><a id="l02723" name="l02723"></a><span class="lineno"> 2723</span>         hbmax=0.</div>
<div class="line"><a id="l02724" name="l02724"></a><span class="lineno"> 2724</span>         nz_u(iurb)=0</div>
<div class="line"><a id="l02725" name="l02725"></a><span class="lineno"> 2725</span>         <span class="keywordflow">do</span> ilu=1,nz_um</div>
<div class="line"><a id="l02726" name="l02726"></a><span class="lineno"> 2726</span>            <span class="keywordflow">if</span>(h_b(ilu,iurb).gt.hbmax)hbmax=h_b(ilu,iurb)</div>
<div class="line"><a id="l02727" name="l02727"></a><span class="lineno"> 2727</span><span class="keywordflow">         enddo</span></div>
<div class="line"><a id="l02728" name="l02728"></a><span class="lineno"> 2728</span>         </div>
<div class="line"><a id="l02729" name="l02729"></a><span class="lineno"> 2729</span>         <span class="keywordflow">do</span> iz_u=1,nz_um-1</div>
<div class="line"><a id="l02730" name="l02730"></a><span class="lineno"> 2730</span>            <span class="keywordflow">if</span>(z_u(iz_u+1).gt.hbmax)<span class="keywordflow">go to</span> 10</div>
<div class="line"><a id="l02731" name="l02731"></a><span class="lineno"> 2731</span><span class="keywordflow">         enddo</span></div>
<div class="line"><a id="l02732" name="l02732"></a><span class="lineno"> 2732</span>         </div>
<div class="line"><a id="l02733" name="l02733"></a><span class="lineno"> 2733</span> 10      <span class="keywordflow">continue</span></div>
<div class="line"><a id="l02734" name="l02734"></a><span class="lineno"> 2734</span>         nz_u(iurb)=iz_u+1</div>
<div class="line"><a id="l02735" name="l02735"></a><span class="lineno"> 2735</span> </div>
<div class="line"><a id="l02736" name="l02736"></a><span class="lineno"> 2736</span>         <span class="keywordflow">do</span> id=1,nd_u(iurb)</div>
<div class="line"><a id="l02737" name="l02737"></a><span class="lineno"> 2737</span> </div>
<div class="line"><a id="l02738" name="l02738"></a><span class="lineno"> 2738</span>            <span class="keywordflow">do</span> iz_u=1,nz_u(iurb)</div>
<div class="line"><a id="l02739" name="l02739"></a><span class="lineno"> 2739</span>               ss_u(iz_u,iurb)=0.</div>
<div class="line"><a id="l02740" name="l02740"></a><span class="lineno"> 2740</span>               <span class="keywordflow">do</span> ilu=1,nz_um</div>
<div class="line"><a id="l02741" name="l02741"></a><span class="lineno"> 2741</span>                  <span class="keywordflow">if</span>(z_u(iz_u).le.h_b(ilu,iurb)                      &amp;    </div>
<div class="line"><a id="l02742" name="l02742"></a><span class="lineno"> 2742</span>                    .and.z_u(iz_u+1).gt.h_b(ilu,iurb))<span class="keywordflow">then</span>            </div>
<div class="line"><a id="l02743" name="l02743"></a><span class="lineno"> 2743</span>                        ss_u(iz_u,iurb)=ss_u(iz_u,iurb)+d_b(ilu,iurb)</div>
<div class="line"><a id="l02744" name="l02744"></a><span class="lineno"> 2744</span><span class="keywordflow">                  endif</span> </div>
<div class="line"><a id="l02745" name="l02745"></a><span class="lineno"> 2745</span><span class="keywordflow">               enddo</span></div>
<div class="line"><a id="l02746" name="l02746"></a><span class="lineno"> 2746</span><span class="keywordflow">            enddo</span></div>
<div class="line"><a id="l02747" name="l02747"></a><span class="lineno"> 2747</span> </div>
<div class="line"><a id="l02748" name="l02748"></a><span class="lineno"> 2748</span>            pb_u(1,iurb)=1.</div>
<div class="line"><a id="l02749" name="l02749"></a><span class="lineno"> 2749</span>            <span class="keywordflow">do</span> iz_u=1,nz_u(iurb)</div>
<div class="line"><a id="l02750" name="l02750"></a><span class="lineno"> 2750</span>               pb_u(iz_u+1,iurb)=max(0.,pb_u(iz_u,iurb)-ss_u(iz_u,iurb))</div>
<div class="line"><a id="l02751" name="l02751"></a><span class="lineno"> 2751</span><span class="keywordflow">            enddo</span></div>
<div class="line"><a id="l02752" name="l02752"></a><span class="lineno"> 2752</span> </div>
<div class="line"><a id="l02753" name="l02753"></a><span class="lineno"> 2753</span><span class="keywordflow">         enddo</span></div>
<div class="line"><a id="l02754" name="l02754"></a><span class="lineno"> 2754</span><span class="keywordflow">      end do</span></div>
<div class="line"><a id="l02755" name="l02755"></a><span class="lineno"> 2755</span>     </div>
<div class="line"><a id="l02756" name="l02756"></a><span class="lineno"> 2756</span>                  </div>
<div class="line"><a id="l02757" name="l02757"></a><span class="lineno"> 2757</span>      <span class="keywordflow">return</span>       </div>
<div class="line"><a id="l02758" name="l02758"></a><span class="lineno"> 2758</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#ac457b6929ba12db21a3d49ebbacc2508">icbep</a></div>
<div class="line"><a id="l02759" name="l02759"></a><span class="lineno"> 2759</span> </div>
<div class="line"><a id="l02760" name="l02760"></a><span class="lineno"> 2760</span><span class="comment">! ===6=8===============================================================72</span></div>
<div class="line"><a id="l02761" name="l02761"></a><span class="lineno"> 2761</span><span class="comment">! ===6=8===============================================================72</span></div>
<div class="line"><a id="l02762" name="l02762"></a><span class="lineno"> 2762</span> </div>
<div class="line"><a id="l02763" name="l02763"></a><span class="lineno"><a class="line" href="namespacemodule__sf__bep.html#a684f8527484fc85e8f11cc583188d0ab"> 2763</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a684f8527484fc85e8f11cc583188d0ab">view_factors</a>(iurb,nz_u,id,dxy,z,ws,fww,fwg,fgw,fsg,fsw,fws) </div>
<div class="line"><a id="l02764" name="l02764"></a><span class="lineno"> 2764</span>     </div>
<div class="line"><a id="l02765" name="l02765"></a><span class="lineno"> 2765</span>      <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l02766" name="l02766"></a><span class="lineno"> 2766</span> </div>
<div class="line"><a id="l02767" name="l02767"></a><span class="lineno"> 2767</span> </div>
<div class="line"><a id="l02768" name="l02768"></a><span class="lineno"> 2768</span> </div>
<div class="line"><a id="l02769" name="l02769"></a><span class="lineno"> 2769</span><span class="comment">! -----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02770" name="l02770"></a><span class="lineno"> 2770</span><span class="comment">!     Input</span></div>
<div class="line"><a id="l02771" name="l02771"></a><span class="lineno"> 2771</span><span class="comment">!------------------------------------------------------------------------</span></div>
<div class="line"><a id="l02772" name="l02772"></a><span class="lineno"> 2772</span> </div>
<div class="line"><a id="l02773" name="l02773"></a><span class="lineno"> 2773</span>      <span class="keywordtype">integer</span> iurb            <span class="comment">! Number of the urban class</span></div>
<div class="line"><a id="l02774" name="l02774"></a><span class="lineno"> 2774</span>      <span class="keywordtype">integer</span> nz_u            <span class="comment">! Number of levels in the urban grid</span></div>
<div class="line"><a id="l02775" name="l02775"></a><span class="lineno"> 2775</span>      <span class="keywordtype">integer</span> id              <span class="comment">! Street direction number</span></div>
<div class="line"><a id="l02776" name="l02776"></a><span class="lineno"> 2776</span><span class="keywordtype">      real</span> ws                 <span class="comment">! Street width</span></div>
<div class="line"><a id="l02777" name="l02777"></a><span class="lineno"> 2777</span><span class="keywordtype">      real</span> z(nz_um)         <span class="comment">! Height of the urban grid levels</span></div>
<div class="line"><a id="l02778" name="l02778"></a><span class="lineno"> 2778</span><span class="keywordtype">      real</span> dxy                <span class="comment">! Street lenght</span></div>
<div class="line"><a id="l02779" name="l02779"></a><span class="lineno"> 2779</span> </div>
<div class="line"><a id="l02780" name="l02780"></a><span class="lineno"> 2780</span> </div>
<div class="line"><a id="l02781" name="l02781"></a><span class="lineno"> 2781</span><span class="comment">! -----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02782" name="l02782"></a><span class="lineno"> 2782</span><span class="comment">!     Output</span></div>
<div class="line"><a id="l02783" name="l02783"></a><span class="lineno"> 2783</span><span class="comment">!------------------------------------------------------------------------</span></div>
<div class="line"><a id="l02784" name="l02784"></a><span class="lineno"> 2784</span> </div>
<div class="line"><a id="l02785" name="l02785"></a><span class="lineno"> 2785</span><span class="comment">!   fww,fwg,fgw,fsw,fsg are the view factors used to compute the long wave</span></div>
<div class="line"><a id="l02786" name="l02786"></a><span class="lineno"> 2786</span><span class="comment">!   and the short wave radation. They are the part of radiation from a surface</span></div>
<div class="line"><a id="l02787" name="l02787"></a><span class="lineno"> 2787</span><span class="comment">!   or from the sky to another surface.</span></div>
<div class="line"><a id="l02788" name="l02788"></a><span class="lineno"> 2788</span> </div>
<div class="line"><a id="l02789" name="l02789"></a><span class="lineno"> 2789</span><span class="keywordtype">      real</span> fww(nz_um,nz_um,ndm,nurbm)            <span class="comment">!  from wall to wall</span></div>
<div class="line"><a id="l02790" name="l02790"></a><span class="lineno"> 2790</span><span class="keywordtype">      real</span> fwg(nz_um,ndm,nurbm)                  <span class="comment">!  from wall to ground</span></div>
<div class="line"><a id="l02791" name="l02791"></a><span class="lineno"> 2791</span><span class="keywordtype">      real</span> fgw(nz_um,ndm,nurbm)                  <span class="comment">!  from ground to wall</span></div>
<div class="line"><a id="l02792" name="l02792"></a><span class="lineno"> 2792</span><span class="keywordtype">      real</span> fsw(nz_um,ndm,nurbm)                  <span class="comment">!  from sky to wall</span></div>
<div class="line"><a id="l02793" name="l02793"></a><span class="lineno"> 2793</span><span class="keywordtype">      real</span> fws(nz_um,ndm,nurbm)                  <span class="comment">!  from wall to sky</span></div>
<div class="line"><a id="l02794" name="l02794"></a><span class="lineno"> 2794</span><span class="keywordtype">      real</span> fsg(ndm,nurbm)                        <span class="comment">!  from sky to ground</span></div>
<div class="line"><a id="l02795" name="l02795"></a><span class="lineno"> 2795</span> </div>
<div class="line"><a id="l02796" name="l02796"></a><span class="lineno"> 2796</span> </div>
<div class="line"><a id="l02797" name="l02797"></a><span class="lineno"> 2797</span><span class="comment">! -----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02798" name="l02798"></a><span class="lineno"> 2798</span><span class="comment">!     Local</span></div>
<div class="line"><a id="l02799" name="l02799"></a><span class="lineno"> 2799</span><span class="comment">!------------------------------------------------------------------------</span></div>
<div class="line"><a id="l02800" name="l02800"></a><span class="lineno"> 2800</span> </div>
<div class="line"><a id="l02801" name="l02801"></a><span class="lineno"> 2801</span>      <span class="keywordtype">integer</span> jz,iz</div>
<div class="line"><a id="l02802" name="l02802"></a><span class="lineno"> 2802</span> </div>
<div class="line"><a id="l02803" name="l02803"></a><span class="lineno"> 2803</span><span class="keywordtype">      real</span> hut</div>
<div class="line"><a id="l02804" name="l02804"></a><span class="lineno"> 2804</span><span class="keywordtype">      real</span> f1,f2,f12,f23,f123,ftot</div>
<div class="line"><a id="l02805" name="l02805"></a><span class="lineno"> 2805</span><span class="keywordtype">      real</span> fprl,fnrm</div>
<div class="line"><a id="l02806" name="l02806"></a><span class="lineno"> 2806</span><span class="keywordtype">      real</span> a1,a2,a3,a4,a12,a23,a123</div>
<div class="line"><a id="l02807" name="l02807"></a><span class="lineno"> 2807</span> </div>
<div class="line"><a id="l02808" name="l02808"></a><span class="lineno"> 2808</span><span class="comment">! -----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02809" name="l02809"></a><span class="lineno"> 2809</span><span class="comment">!     This routine calculates the view factors</span></div>
<div class="line"><a id="l02810" name="l02810"></a><span class="lineno"> 2810</span><span class="comment">!------------------------------------------------------------------------</span></div>
<div class="line"><a id="l02811" name="l02811"></a><span class="lineno"> 2811</span>        </div>
<div class="line"><a id="l02812" name="l02812"></a><span class="lineno"> 2812</span>      hut=z(nz_u+1)</div>
<div class="line"><a id="l02813" name="l02813"></a><span class="lineno"> 2813</span>        </div>
<div class="line"><a id="l02814" name="l02814"></a><span class="lineno"> 2814</span>      <span class="keywordflow">do</span> jz=1,nz_u      </div>
<div class="line"><a id="l02815" name="l02815"></a><span class="lineno"> 2815</span>      </div>
<div class="line"><a id="l02816" name="l02816"></a><span class="lineno"> 2816</span><span class="comment">! radiation from wall to wall</span></div>
<div class="line"><a id="l02817" name="l02817"></a><span class="lineno"> 2817</span>       </div>
<div class="line"><a id="l02818" name="l02818"></a><span class="lineno"> 2818</span>         <span class="keywordflow">do</span> iz=1,nz_u</div>
<div class="line"><a id="l02819" name="l02819"></a><span class="lineno"> 2819</span>     </div>
<div class="line"><a id="l02820" name="l02820"></a><span class="lineno"> 2820</span>            <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a36cb0fac0e86fb3e61571396455adf45">fprls</a> (fprl,dxy,abs(z(jz+1)-z(iz  )),ws)</div>
<div class="line"><a id="l02821" name="l02821"></a><span class="lineno"> 2821</span>            f123=fprl</div>
<div class="line"><a id="l02822" name="l02822"></a><span class="lineno"> 2822</span>            <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a36cb0fac0e86fb3e61571396455adf45">fprls</a> (fprl,dxy,abs(z(jz+1)-z(iz+1)),ws)</div>
<div class="line"><a id="l02823" name="l02823"></a><span class="lineno"> 2823</span>            f23=fprl</div>
<div class="line"><a id="l02824" name="l02824"></a><span class="lineno"> 2824</span>            <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a36cb0fac0e86fb3e61571396455adf45">fprls</a> (fprl,dxy,abs(z(jz  )-z(iz  )),ws)</div>
<div class="line"><a id="l02825" name="l02825"></a><span class="lineno"> 2825</span>            f12=fprl</div>
<div class="line"><a id="l02826" name="l02826"></a><span class="lineno"> 2826</span>            <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a36cb0fac0e86fb3e61571396455adf45">fprls</a> (fprl,dxy,abs(z(jz  )-z(iz+1)),ws)</div>
<div class="line"><a id="l02827" name="l02827"></a><span class="lineno"> 2827</span>            f2 = fprl</div>
<div class="line"><a id="l02828" name="l02828"></a><span class="lineno"> 2828</span>       </div>
<div class="line"><a id="l02829" name="l02829"></a><span class="lineno"> 2829</span>            a123=dxy*(abs(z(jz+1)-z(iz  )))</div>
<div class="line"><a id="l02830" name="l02830"></a><span class="lineno"> 2830</span>            a12 =dxy*(abs(z(jz  )-z(iz  )))</div>
<div class="line"><a id="l02831" name="l02831"></a><span class="lineno"> 2831</span>            a23 =dxy*(abs(z(jz+1)-z(iz+1)))</div>
<div class="line"><a id="l02832" name="l02832"></a><span class="lineno"> 2832</span>            a1  =dxy*(abs(z(iz+1)-z(iz  )))</div>
<div class="line"><a id="l02833" name="l02833"></a><span class="lineno"> 2833</span>            a2  =dxy*(abs(z(jz  )-z(iz+1)))</div>
<div class="line"><a id="l02834" name="l02834"></a><span class="lineno"> 2834</span>            a3  =dxy*(abs(z(jz+1)-z(jz  )))</div>
<div class="line"><a id="l02835" name="l02835"></a><span class="lineno"> 2835</span>       </div>
<div class="line"><a id="l02836" name="l02836"></a><span class="lineno"> 2836</span>            ftot=0.5*(a123*f123-a23*f23-a12*f12+a2*f2)/a1</div>
<div class="line"><a id="l02837" name="l02837"></a><span class="lineno"> 2837</span>       </div>
<div class="line"><a id="l02838" name="l02838"></a><span class="lineno"> 2838</span>            fww(iz,jz,id,iurb)=ftot*a1/a3</div>
<div class="line"><a id="l02839" name="l02839"></a><span class="lineno"> 2839</span> </div>
<div class="line"><a id="l02840" name="l02840"></a><span class="lineno"> 2840</span><span class="keywordflow">         enddo</span> </div>
<div class="line"><a id="l02841" name="l02841"></a><span class="lineno"> 2841</span> </div>
<div class="line"><a id="l02842" name="l02842"></a><span class="lineno"> 2842</span><span class="comment">! radiation from ground to wall</span></div>
<div class="line"><a id="l02843" name="l02843"></a><span class="lineno"> 2843</span>       </div>
<div class="line"><a id="l02844" name="l02844"></a><span class="lineno"> 2844</span>         <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a4a86b7d5f6e1b383218768f344edc4d3">fnrms</a> (fnrm,z(jz+1),dxy,ws)</div>
<div class="line"><a id="l02845" name="l02845"></a><span class="lineno"> 2845</span>         f12=fnrm</div>
<div class="line"><a id="l02846" name="l02846"></a><span class="lineno"> 2846</span>         <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a4a86b7d5f6e1b383218768f344edc4d3">fnrms</a> (fnrm,z(jz)  ,dxy,ws)</div>
<div class="line"><a id="l02847" name="l02847"></a><span class="lineno"> 2847</span>         f1=fnrm</div>
<div class="line"><a id="l02848" name="l02848"></a><span class="lineno"> 2848</span>       </div>
<div class="line"><a id="l02849" name="l02849"></a><span class="lineno"> 2849</span>         a1 = ws*dxy</div>
<div class="line"><a id="l02850" name="l02850"></a><span class="lineno"> 2850</span>         </div>
<div class="line"><a id="l02851" name="l02851"></a><span class="lineno"> 2851</span>         a12= ws*dxy</div>
<div class="line"><a id="l02852" name="l02852"></a><span class="lineno"> 2852</span>       </div>
<div class="line"><a id="l02853" name="l02853"></a><span class="lineno"> 2853</span>         a4=(z(jz+1)-z(jz))*dxy</div>
<div class="line"><a id="l02854" name="l02854"></a><span class="lineno"> 2854</span>       </div>
<div class="line"><a id="l02855" name="l02855"></a><span class="lineno"> 2855</span>         ftot=(a12*f12-a12*f1)/a1</div>
<div class="line"><a id="l02856" name="l02856"></a><span class="lineno"> 2856</span>                    </div>
<div class="line"><a id="l02857" name="l02857"></a><span class="lineno"> 2857</span>         fgw(jz,id,iurb)=ftot*a1/a4</div>
<div class="line"><a id="l02858" name="l02858"></a><span class="lineno"> 2858</span>     </div>
<div class="line"><a id="l02859" name="l02859"></a><span class="lineno"> 2859</span><span class="comment">!  radiation from sky to wall</span></div>
<div class="line"><a id="l02860" name="l02860"></a><span class="lineno"> 2860</span>     </div>
<div class="line"><a id="l02861" name="l02861"></a><span class="lineno"> 2861</span>         <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a4a86b7d5f6e1b383218768f344edc4d3">fnrms</a>(fnrm,hut-z(jz)  ,dxy,ws)</div>
<div class="line"><a id="l02862" name="l02862"></a><span class="lineno"> 2862</span>         f12 = fnrm</div>
<div class="line"><a id="l02863" name="l02863"></a><span class="lineno"> 2863</span>         <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a4a86b7d5f6e1b383218768f344edc4d3">fnrms</a> (fnrm,hut-z(jz+1),dxy,ws)</div>
<div class="line"><a id="l02864" name="l02864"></a><span class="lineno"> 2864</span>         f1 =fnrm</div>
<div class="line"><a id="l02865" name="l02865"></a><span class="lineno"> 2865</span>       </div>
<div class="line"><a id="l02866" name="l02866"></a><span class="lineno"> 2866</span>         a1 = ws*dxy</div>
<div class="line"><a id="l02867" name="l02867"></a><span class="lineno"> 2867</span>       </div>
<div class="line"><a id="l02868" name="l02868"></a><span class="lineno"> 2868</span>         a12= ws*dxy</div>
<div class="line"><a id="l02869" name="l02869"></a><span class="lineno"> 2869</span>              </div>
<div class="line"><a id="l02870" name="l02870"></a><span class="lineno"> 2870</span>         a4 = (z(jz+1)-z(jz))*dxy</div>
<div class="line"><a id="l02871" name="l02871"></a><span class="lineno"> 2871</span>       </div>
<div class="line"><a id="l02872" name="l02872"></a><span class="lineno"> 2872</span>         ftot=(a12*f12-a12*f1)/a1</div>
<div class="line"><a id="l02873" name="l02873"></a><span class="lineno"> 2873</span>        </div>
<div class="line"><a id="l02874" name="l02874"></a><span class="lineno"> 2874</span>         fsw(jz,id,iurb)=ftot*a1/a4       </div>
<div class="line"><a id="l02875" name="l02875"></a><span class="lineno"> 2875</span>      </div>
<div class="line"><a id="l02876" name="l02876"></a><span class="lineno"> 2876</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l02877" name="l02877"></a><span class="lineno"> 2877</span> </div>
<div class="line"><a id="l02878" name="l02878"></a><span class="lineno"> 2878</span><span class="comment">! radiation from wall to sky      </span></div>
<div class="line"><a id="l02879" name="l02879"></a><span class="lineno"> 2879</span>      <span class="keywordflow">do</span> iz=1,nz_u</div>
<div class="line"><a id="l02880" name="l02880"></a><span class="lineno"> 2880</span>       <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a4a86b7d5f6e1b383218768f344edc4d3">fnrms</a>(fnrm,ws,dxy,hut-z(iz))</div>
<div class="line"><a id="l02881" name="l02881"></a><span class="lineno"> 2881</span>       f12=fnrm</div>
<div class="line"><a id="l02882" name="l02882"></a><span class="lineno"> 2882</span>       <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a4a86b7d5f6e1b383218768f344edc4d3">fnrms</a>(fnrm,ws,dxy,hut-z(iz+1))</div>
<div class="line"><a id="l02883" name="l02883"></a><span class="lineno"> 2883</span>       f1=fnrm</div>
<div class="line"><a id="l02884" name="l02884"></a><span class="lineno"> 2884</span>       a1 = (z(iz+1)-z(iz))*dxy</div>
<div class="line"><a id="l02885" name="l02885"></a><span class="lineno"> 2885</span>       a2 = (hut-z(iz+1))*dxy</div>
<div class="line"><a id="l02886" name="l02886"></a><span class="lineno"> 2886</span>       a12= (hut-z(iz))*dxy</div>
<div class="line"><a id="l02887" name="l02887"></a><span class="lineno"> 2887</span>       a4 = ws*dxy</div>
<div class="line"><a id="l02888" name="l02888"></a><span class="lineno"> 2888</span>       ftot=(a12*f12-a2*f1)/a1</div>
<div class="line"><a id="l02889" name="l02889"></a><span class="lineno"> 2889</span>       fws(iz,id,iurb)=ftot*a1/a4 </div>
<div class="line"><a id="l02890" name="l02890"></a><span class="lineno"> 2890</span> </div>
<div class="line"><a id="l02891" name="l02891"></a><span class="lineno"> 2891</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l02892" name="l02892"></a><span class="lineno"> 2892</span><span class="comment">!!!!!!!!!!!!!</span></div>
<div class="line"><a id="l02893" name="l02893"></a><span class="lineno"> 2893</span> </div>
<div class="line"><a id="l02894" name="l02894"></a><span class="lineno"> 2894</span> </div>
<div class="line"><a id="l02895" name="l02895"></a><span class="lineno"> 2895</span>       <span class="keywordflow">do</span> iz=1,nz_u</div>
<div class="line"><a id="l02896" name="l02896"></a><span class="lineno"> 2896</span> </div>
<div class="line"><a id="l02897" name="l02897"></a><span class="lineno"> 2897</span><span class="comment">! radiation from wall to ground</span></div>
<div class="line"><a id="l02898" name="l02898"></a><span class="lineno"> 2898</span>      </div>
<div class="line"><a id="l02899" name="l02899"></a><span class="lineno"> 2899</span>         <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a4a86b7d5f6e1b383218768f344edc4d3">fnrms</a> (fnrm,ws,dxy,z(iz+1))</div>
<div class="line"><a id="l02900" name="l02900"></a><span class="lineno"> 2900</span>         f12=fnrm</div>
<div class="line"><a id="l02901" name="l02901"></a><span class="lineno"> 2901</span>         <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a4a86b7d5f6e1b383218768f344edc4d3">fnrms</a> (fnrm,ws,dxy,z(iz  ))</div>
<div class="line"><a id="l02902" name="l02902"></a><span class="lineno"> 2902</span>         f1 =fnrm</div>
<div class="line"><a id="l02903" name="l02903"></a><span class="lineno"> 2903</span>         </div>
<div class="line"><a id="l02904" name="l02904"></a><span class="lineno"> 2904</span>         a1= (z(iz+1)-z(iz) )*dxy</div>
<div class="line"><a id="l02905" name="l02905"></a><span class="lineno"> 2905</span>       </div>
<div class="line"><a id="l02906" name="l02906"></a><span class="lineno"> 2906</span>         a2 = z(iz)*dxy</div>
<div class="line"><a id="l02907" name="l02907"></a><span class="lineno"> 2907</span>         a12= z(iz+1)*dxy</div>
<div class="line"><a id="l02908" name="l02908"></a><span class="lineno"> 2908</span>         a4 = ws*dxy</div>
<div class="line"><a id="l02909" name="l02909"></a><span class="lineno"> 2909</span> </div>
<div class="line"><a id="l02910" name="l02910"></a><span class="lineno"> 2910</span>         ftot=(a12*f12-a2*f1)/a1        </div>
<div class="line"><a id="l02911" name="l02911"></a><span class="lineno"> 2911</span>                    </div>
<div class="line"><a id="l02912" name="l02912"></a><span class="lineno"> 2912</span>         fwg(iz,id,iurb)=ftot*a1/a4</div>
<div class="line"><a id="l02913" name="l02913"></a><span class="lineno"> 2913</span>        </div>
<div class="line"><a id="l02914" name="l02914"></a><span class="lineno"> 2914</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l02915" name="l02915"></a><span class="lineno"> 2915</span> </div>
<div class="line"><a id="l02916" name="l02916"></a><span class="lineno"> 2916</span><span class="comment">! radiation from sky to ground</span></div>
<div class="line"><a id="l02917" name="l02917"></a><span class="lineno"> 2917</span>      </div>
<div class="line"><a id="l02918" name="l02918"></a><span class="lineno"> 2918</span>      <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a36cb0fac0e86fb3e61571396455adf45">fprls</a> (fprl,dxy,ws,hut)</div>
<div class="line"><a id="l02919" name="l02919"></a><span class="lineno"> 2919</span>      fsg(id,iurb)=fprl</div>
<div class="line"><a id="l02920" name="l02920"></a><span class="lineno"> 2920</span> </div>
<div class="line"><a id="l02921" name="l02921"></a><span class="lineno"> 2921</span>      <span class="keywordflow">return</span></div>
<div class="line"><a id="l02922" name="l02922"></a><span class="lineno"> 2922</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a684f8527484fc85e8f11cc583188d0ab">view_factors</a></div>
<div class="line"><a id="l02923" name="l02923"></a><span class="lineno"> 2923</span> </div>
<div class="line"><a id="l02924" name="l02924"></a><span class="lineno"> 2924</span><span class="comment">! ===6=8===============================================================72</span></div>
<div class="line"><a id="l02925" name="l02925"></a><span class="lineno"> 2925</span><span class="comment">! ===6=8===============================================================72</span></div>
<div class="line"><a id="l02926" name="l02926"></a><span class="lineno"> 2926</span> </div>
<div class="line"><a id="l02927" name="l02927"></a><span class="lineno"><a class="line" href="namespacemodule__sf__bep.html#a36cb0fac0e86fb3e61571396455adf45"> 2927</a></span>      <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a36cb0fac0e86fb3e61571396455adf45">fprls</a> (fprl,a,b,c)</div>
<div class="line"><a id="l02928" name="l02928"></a><span class="lineno"> 2928</span> </div>
<div class="line"><a id="l02929" name="l02929"></a><span class="lineno"> 2929</span>      <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l02930" name="l02930"></a><span class="lineno"> 2930</span> </div>
<div class="line"><a id="l02931" name="l02931"></a><span class="lineno"> 2931</span>     </div>
<div class="line"><a id="l02932" name="l02932"></a><span class="lineno"> 2932</span>            </div>
<div class="line"><a id="l02933" name="l02933"></a><span class="lineno"> 2933</span><span class="keywordtype">      real</span> a,b,c</div>
<div class="line"><a id="l02934" name="l02934"></a><span class="lineno"> 2934</span><span class="keywordtype">      real</span> x,y</div>
<div class="line"><a id="l02935" name="l02935"></a><span class="lineno"> 2935</span><span class="keywordtype">      real</span> fprl</div>
<div class="line"><a id="l02936" name="l02936"></a><span class="lineno"> 2936</span> </div>
<div class="line"><a id="l02937" name="l02937"></a><span class="lineno"> 2937</span> </div>
<div class="line"><a id="l02938" name="l02938"></a><span class="lineno"> 2938</span>      x=a/c</div>
<div class="line"><a id="l02939" name="l02939"></a><span class="lineno"> 2939</span>      y=b/c</div>
<div class="line"><a id="l02940" name="l02940"></a><span class="lineno"> 2940</span>      </div>
<div class="line"><a id="l02941" name="l02941"></a><span class="lineno"> 2941</span>      <span class="keywordflow">if</span>(a.eq.0.or.b.eq.0.)<span class="keywordflow">then</span></div>
<div class="line"><a id="l02942" name="l02942"></a><span class="lineno"> 2942</span>       fprl=0.</div>
<div class="line"><a id="l02943" name="l02943"></a><span class="lineno"> 2943</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l02944" name="l02944"></a><span class="lineno"> 2944</span>       fprl=log( ( (1.+x**2)*(1.+y**2)/(1.+x**2+y**2) )**.5)+  &amp;</div>
<div class="line"><a id="l02945" name="l02945"></a><span class="lineno"> 2945</span>           y*((1.+x**2)**.5)*atan(y/((1.+x**2)**.5))+          &amp;  </div>
<div class="line"><a id="l02946" name="l02946"></a><span class="lineno"> 2946</span>           x*((1.+y**2)**.5)*atan(x/((1.+y**2)**.5))-          &amp;   </div>
<div class="line"><a id="l02947" name="l02947"></a><span class="lineno"> 2947</span>           y*atan(y)-x*atan(x)</div>
<div class="line"><a id="l02948" name="l02948"></a><span class="lineno"> 2948</span>       fprl=fprl*2./(<a class="code hl_variable" href="namespacemodule__sf__bep.html#a43054ed4c98f3ac9e3a5dc324ec7458f">pi</a>*x*y)</div>
<div class="line"><a id="l02949" name="l02949"></a><span class="lineno"> 2949</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l02950" name="l02950"></a><span class="lineno"> 2950</span>      </div>
<div class="line"><a id="l02951" name="l02951"></a><span class="lineno"> 2951</span>      <span class="keywordflow">return</span></div>
<div class="line"><a id="l02952" name="l02952"></a><span class="lineno"> 2952</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a36cb0fac0e86fb3e61571396455adf45">fprls</a></div>
<div class="line"><a id="l02953" name="l02953"></a><span class="lineno"> 2953</span> </div>
<div class="line"><a id="l02954" name="l02954"></a><span class="lineno"> 2954</span><span class="comment">! ===6=8===============================================================72     </span></div>
<div class="line"><a id="l02955" name="l02955"></a><span class="lineno"> 2955</span><span class="comment">! ===6=8===============================================================72</span></div>
<div class="line"><a id="l02956" name="l02956"></a><span class="lineno"> 2956</span> </div>
<div class="line"><a id="l02957" name="l02957"></a><span class="lineno"><a class="line" href="namespacemodule__sf__bep.html#a4a86b7d5f6e1b383218768f344edc4d3"> 2957</a></span>      <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a4a86b7d5f6e1b383218768f344edc4d3">fnrms</a> (fnrm,a,b,c)</div>
<div class="line"><a id="l02958" name="l02958"></a><span class="lineno"> 2958</span> </div>
<div class="line"><a id="l02959" name="l02959"></a><span class="lineno"> 2959</span>      <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l02960" name="l02960"></a><span class="lineno"> 2960</span> </div>
<div class="line"><a id="l02961" name="l02961"></a><span class="lineno"> 2961</span> </div>
<div class="line"><a id="l02962" name="l02962"></a><span class="lineno"> 2962</span> </div>
<div class="line"><a id="l02963" name="l02963"></a><span class="lineno"> 2963</span><span class="keywordtype">      real</span> a,b,c</div>
<div class="line"><a id="l02964" name="l02964"></a><span class="lineno"> 2964</span><span class="keywordtype">      real</span> x,y,z,a1,a2,a3,a4,a5,a6</div>
<div class="line"><a id="l02965" name="l02965"></a><span class="lineno"> 2965</span><span class="keywordtype">      real</span> fnrm</div>
<div class="line"><a id="l02966" name="l02966"></a><span class="lineno"> 2966</span>      </div>
<div class="line"><a id="l02967" name="l02967"></a><span class="lineno"> 2967</span>      x=a/b</div>
<div class="line"><a id="l02968" name="l02968"></a><span class="lineno"> 2968</span>      y=c/b</div>
<div class="line"><a id="l02969" name="l02969"></a><span class="lineno"> 2969</span>      z=x**2+y**2</div>
<div class="line"><a id="l02970" name="l02970"></a><span class="lineno"> 2970</span>      </div>
<div class="line"><a id="l02971" name="l02971"></a><span class="lineno"> 2971</span>      <span class="keywordflow">if</span>(y.eq.0.or.x.eq.0)<span class="keywordflow">then</span></div>
<div class="line"><a id="l02972" name="l02972"></a><span class="lineno"> 2972</span>       fnrm=0.</div>
<div class="line"><a id="l02973" name="l02973"></a><span class="lineno"> 2973</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l02974" name="l02974"></a><span class="lineno"> 2974</span>       a1=log( (1.+x*x)*(1.+y*y)/(1.+z) )</div>
<div class="line"><a id="l02975" name="l02975"></a><span class="lineno"> 2975</span>       a2=y*y*log(y*y*(1.+z)/z/(1.+y*y) )</div>
<div class="line"><a id="l02976" name="l02976"></a><span class="lineno"> 2976</span>       a3=x*x*log(x*x*(1.+z)/z/(1.+x*x) )</div>
<div class="line"><a id="l02977" name="l02977"></a><span class="lineno"> 2977</span>       a4=y*atan(1./y)</div>
<div class="line"><a id="l02978" name="l02978"></a><span class="lineno"> 2978</span>       a5=x*atan(1./x)</div>
<div class="line"><a id="l02979" name="l02979"></a><span class="lineno"> 2979</span>       a6=sqrt(z)*atan(1./sqrt(z))</div>
<div class="line"><a id="l02980" name="l02980"></a><span class="lineno"> 2980</span>       fnrm=0.25*(a1+a2+a3)+a4+a5-a6</div>
<div class="line"><a id="l02981" name="l02981"></a><span class="lineno"> 2981</span>       fnrm=fnrm/(<a class="code hl_variable" href="namespacemodule__sf__bep.html#a43054ed4c98f3ac9e3a5dc324ec7458f">pi</a>*y)</div>
<div class="line"><a id="l02982" name="l02982"></a><span class="lineno"> 2982</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l02983" name="l02983"></a><span class="lineno"> 2983</span>      </div>
<div class="line"><a id="l02984" name="l02984"></a><span class="lineno"> 2984</span>      <span class="keywordflow">return</span></div>
<div class="line"><a id="l02985" name="l02985"></a><span class="lineno"> 2985</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a4a86b7d5f6e1b383218768f344edc4d3">fnrms</a></div>
<div class="line"><a id="l02986" name="l02986"></a><span class="lineno"> 2986</span>  <span class="comment">! ===6=8===============================================================72  </span></div>
<div class="line"><a id="l02987" name="l02987"></a><span class="lineno"> 2987</span>     </div>
<div class="line"><a id="l02988" name="l02988"></a><span class="lineno"><a class="line" href="namespacemodule__sf__bep.html#a567630d423883a8646b493e79e507f79"> 2988</a></span>      <span class="keyword">SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a567630d423883a8646b493e79e507f79">init_para</a>(alag_u,alaw_u,alar_u,csg_u,csw_u,csr_u,&amp;</div>
<div class="line"><a id="l02989" name="l02989"></a><span class="lineno"> 2989</span>                twini_u,trini_u,tgini_u,albg_u,albw_u,albr_u,emg_u,emw_u,&amp;</div>
<div class="line"><a id="l02990" name="l02990"></a><span class="lineno"> 2990</span>                emr_u,z0g_u,z0r_u,nd_u,strd_u,drst_u,ws_u,bs_u,h_b,d_b)</div>
<div class="line"><a id="l02991" name="l02991"></a><span class="lineno"> 2991</span> </div>
<div class="line"><a id="l02992" name="l02992"></a><span class="lineno"> 2992</span><span class="comment">! initialization routine, where the variables from the table are read</span></div>
<div class="line"><a id="l02993" name="l02993"></a><span class="lineno"> 2993</span> </div>
<div class="line"><a id="l02994" name="l02994"></a><span class="lineno"> 2994</span>      <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l02995" name="l02995"></a><span class="lineno"> 2995</span>      </div>
<div class="line"><a id="l02996" name="l02996"></a><span class="lineno"> 2996</span>      <span class="keywordtype">integer</span> iurb            <span class="comment">! urban class number</span></div>
<div class="line"><a id="l02997" name="l02997"></a><span class="lineno"> 2997</span><span class="comment">!    Building parameters      </span></div>
<div class="line"><a id="l02998" name="l02998"></a><span class="lineno"> 2998</span><span class="keywordtype">      real</span> alag_u(nurbm)      <span class="comment">! Ground thermal diffusivity [m^2 s^-1]</span></div>
<div class="line"><a id="l02999" name="l02999"></a><span class="lineno"> 2999</span><span class="keywordtype">      real</span> alaw_u(nurbm)      <span class="comment">! Wall thermal diffusivity [m^2 s^-1]</span></div>
<div class="line"><a id="l03000" name="l03000"></a><span class="lineno"> 3000</span><span class="keywordtype">      real</span> alar_u(nurbm)      <span class="comment">! Roof thermal diffusivity [m^2 s^-1]</span></div>
<div class="line"><a id="l03001" name="l03001"></a><span class="lineno"> 3001</span><span class="keywordtype">      real</span> csg_u(nurbm)       <span class="comment">! Specific heat of the ground material [J m^3 K^-1]</span></div>
<div class="line"><a id="l03002" name="l03002"></a><span class="lineno"> 3002</span><span class="keywordtype">      real</span> csw_u(nurbm)       <span class="comment">! Specific heat of the wall material [J m^3 K^-1]</span></div>
<div class="line"><a id="l03003" name="l03003"></a><span class="lineno"> 3003</span><span class="keywordtype">      real</span> csr_u(nurbm)       <span class="comment">! Specific heat of the roof material [J m^3 K^-1]</span></div>
<div class="line"><a id="l03004" name="l03004"></a><span class="lineno"> 3004</span><span class="keywordtype">      real</span> twini_u(nurbm)     <span class="comment">! Temperature inside the buildings behind the wall [K]</span></div>
<div class="line"><a id="l03005" name="l03005"></a><span class="lineno"> 3005</span><span class="keywordtype">      real</span> trini_u(nurbm)     <span class="comment">! Temperature inside the buildings behind the roof [K]</span></div>
<div class="line"><a id="l03006" name="l03006"></a><span class="lineno"> 3006</span><span class="keywordtype">      real</span> tgini_u(nurbm)     <span class="comment">! Initial road temperature</span></div>
<div class="line"><a id="l03007" name="l03007"></a><span class="lineno"> 3007</span> </div>
<div class="line"><a id="l03008" name="l03008"></a><span class="lineno"> 3008</span><span class="comment">!    Radiation parameters</span></div>
<div class="line"><a id="l03009" name="l03009"></a><span class="lineno"> 3009</span><span class="keywordtype">      real</span> albg_u(nurbm)      <span class="comment">! Albedo of the ground</span></div>
<div class="line"><a id="l03010" name="l03010"></a><span class="lineno"> 3010</span><span class="keywordtype">      real</span> albw_u(nurbm)      <span class="comment">! Albedo of the wall</span></div>
<div class="line"><a id="l03011" name="l03011"></a><span class="lineno"> 3011</span><span class="keywordtype">      real</span> albr_u(nurbm)      <span class="comment">! Albedo of the roof</span></div>
<div class="line"><a id="l03012" name="l03012"></a><span class="lineno"> 3012</span><span class="keywordtype">      real</span> emg_u(nurbm)       <span class="comment">! Emissivity of ground</span></div>
<div class="line"><a id="l03013" name="l03013"></a><span class="lineno"> 3013</span><span class="keywordtype">      real</span> emw_u(nurbm)       <span class="comment">! Emissivity of wall</span></div>
<div class="line"><a id="l03014" name="l03014"></a><span class="lineno"> 3014</span><span class="keywordtype">      real</span> emr_u(nurbm)       <span class="comment">! Emissivity of roof</span></div>
<div class="line"><a id="l03015" name="l03015"></a><span class="lineno"> 3015</span> </div>
<div class="line"><a id="l03016" name="l03016"></a><span class="lineno"> 3016</span><span class="comment">!    Roughness parameters</span></div>
<div class="line"><a id="l03017" name="l03017"></a><span class="lineno"> 3017</span><span class="keywordtype">      real</span> z0g_u(nurbm)       <span class="comment">! The ground&#39;s roughness length      </span></div>
<div class="line"><a id="l03018" name="l03018"></a><span class="lineno"> 3018</span><span class="keywordtype">      real</span> z0r_u(nurbm)       <span class="comment">! The roof&#39;s roughness length</span></div>
<div class="line"><a id="l03019" name="l03019"></a><span class="lineno"> 3019</span> </div>
<div class="line"><a id="l03020" name="l03020"></a><span class="lineno"> 3020</span><span class="comment">!    Street parameters</span></div>
<div class="line"><a id="l03021" name="l03021"></a><span class="lineno"> 3021</span>      <span class="keywordtype">integer</span> nd_u(nurbm)     <span class="comment">! Number of street direction for each urban class</span></div>
<div class="line"><a id="l03022" name="l03022"></a><span class="lineno"> 3022</span> </div>
<div class="line"><a id="l03023" name="l03023"></a><span class="lineno"> 3023</span><span class="keywordtype">      real</span> strd_u(ndm,nurbm)  <span class="comment">! Street length (fix to greater value to the horizontal length of the cells)</span></div>
<div class="line"><a id="l03024" name="l03024"></a><span class="lineno"> 3024</span><span class="keywordtype">      real</span> drst_u(ndm,nurbm)  <span class="comment">! Street direction [degree]</span></div>
<div class="line"><a id="l03025" name="l03025"></a><span class="lineno"> 3025</span><span class="keywordtype">      real</span> ws_u(ndm,nurbm)    <span class="comment">! Street width [m]</span></div>
<div class="line"><a id="l03026" name="l03026"></a><span class="lineno"> 3026</span><span class="keywordtype">      real</span> bs_u(ndm,nurbm)    <span class="comment">! Building width [m]</span></div>
<div class="line"><a id="l03027" name="l03027"></a><span class="lineno"> 3027</span><span class="keywordtype">      real</span> h_b(nz_um,nurbm)   <span class="comment">! Bulding&#39;s heights [m]</span></div>
<div class="line"><a id="l03028" name="l03028"></a><span class="lineno"> 3028</span><span class="keywordtype">      real</span> d_b(nz_um,nurbm)   <span class="comment">! The probability that a building has an height h_b</span></div>
<div class="line"><a id="l03029" name="l03029"></a><span class="lineno"> 3029</span> </div>
<div class="line"><a id="l03030" name="l03030"></a><span class="lineno"> 3030</span>      <span class="keywordtype">integer</span> i,iu</div>
<div class="line"><a id="l03031" name="l03031"></a><span class="lineno"> 3031</span>      <span class="keywordtype">integer</span> nurb <span class="comment">! number of urban classes used</span></div>
<div class="line"><a id="l03032" name="l03032"></a><span class="lineno"> 3032</span> </div>
<div class="line"><a id="l03033" name="l03033"></a><span class="lineno"> 3033</span><span class="comment">!</span></div>
<div class="line"><a id="l03034" name="l03034"></a><span class="lineno"> 3034</span><span class="comment">!Initialize some variables</span></div>
<div class="line"><a id="l03035" name="l03035"></a><span class="lineno"> 3035</span><span class="comment">!</span></div>
<div class="line"><a id="l03036" name="l03036"></a><span class="lineno"> 3036</span>       </div>
<div class="line"><a id="l03037" name="l03037"></a><span class="lineno"> 3037</span>       h_b=0.</div>
<div class="line"><a id="l03038" name="l03038"></a><span class="lineno"> 3038</span>       d_b=0.</div>
<div class="line"><a id="l03039" name="l03039"></a><span class="lineno"> 3039</span> </div>
<div class="line"><a id="l03040" name="l03040"></a><span class="lineno"> 3040</span>       nurb=<a class="code hl_variable" href="namespacemodule__sf__urban.html#aa330bcb961c1cce0dda88438dd69a66e">icate</a></div>
<div class="line"><a id="l03041" name="l03041"></a><span class="lineno"> 3041</span>       <span class="keywordflow">do</span> iu=1,nurb                         </div>
<div class="line"><a id="l03042" name="l03042"></a><span class="lineno"> 3042</span>          nd_u(iu)=0</div>
<div class="line"><a id="l03043" name="l03043"></a><span class="lineno"> 3043</span><span class="keywordflow">       enddo</span></div>
<div class="line"><a id="l03044" name="l03044"></a><span class="lineno"> 3044</span> </div>
<div class="line"><a id="l03045" name="l03045"></a><span class="lineno"> 3045</span>       csw_u=<a class="code hl_variable" href="namespacemodule__sf__urban.html#ab1f016c942720d416c558e59b8cb12c3">capb_tbl</a> / (( 1.0 / 4.1868 ) * 1.e-6)</div>
<div class="line"><a id="l03046" name="l03046"></a><span class="lineno"> 3046</span>       csr_u=<a class="code hl_variable" href="namespacemodule__sf__urban.html#a55c42da1033c3ee7a17640e20669936f">capr_tbl</a> / (( 1.0 / 4.1868 ) * 1.e-6)</div>
<div class="line"><a id="l03047" name="l03047"></a><span class="lineno"> 3047</span>       csg_u=<a class="code hl_variable" href="namespacemodule__sf__urban.html#a76b0ace2aa89e1d8643ecfc185e36e5f">capg_tbl</a> / (( 1.0 / 4.1868 ) * 1.e-6)</div>
<div class="line"><a id="l03048" name="l03048"></a><span class="lineno"> 3048</span>       <span class="keywordflow">do</span> i=1,<a class="code hl_variable" href="namespacemodule__sf__urban.html#aa330bcb961c1cce0dda88438dd69a66e">icate</a></div>
<div class="line"><a id="l03049" name="l03049"></a><span class="lineno"> 3049</span>         alaw_u(i)=<a class="code hl_variable" href="namespacemodule__sf__urban.html#af1cfe5901e85bc1b1b0e79f49ebc19c4">aksb_tbl</a>(i) / csw_u(i) / (( 1.0 / 4.1868 ) * 1.e-2)</div>
<div class="line"><a id="l03050" name="l03050"></a><span class="lineno"> 3050</span>         alar_u(i)=<a class="code hl_variable" href="namespacemodule__sf__urban.html#a2d07f7dc346267badf036c665b31764b">aksr_tbl</a>(i) / csr_u(i) / (( 1.0 / 4.1868 ) * 1.e-2)</div>
<div class="line"><a id="l03051" name="l03051"></a><span class="lineno"> 3051</span>         alag_u(i)=<a class="code hl_variable" href="namespacemodule__sf__urban.html#acd53e83822af2b680129a7d7c7eb791a">aksg_tbl</a>(i) / csg_u(i) / (( 1.0 / 4.1868 ) * 1.e-2)</div>
<div class="line"><a id="l03052" name="l03052"></a><span class="lineno"> 3052</span><span class="keywordflow">       enddo</span></div>
<div class="line"><a id="l03053" name="l03053"></a><span class="lineno"> 3053</span>       twini_u=<a class="code hl_variable" href="namespacemodule__sf__urban.html#a6311eeae6859b634fd83afa15657ebee">tblend_tbl</a></div>
<div class="line"><a id="l03054" name="l03054"></a><span class="lineno"> 3054</span>       trini_u=<a class="code hl_variable" href="namespacemodule__sf__urban.html#a34bd041e62b44037dadf6259cdd1f1bf">trlend_tbl</a></div>
<div class="line"><a id="l03055" name="l03055"></a><span class="lineno"> 3055</span>       tgini_u=<a class="code hl_variable" href="namespacemodule__sf__urban.html#a319ac4d774951ad1f4e8b95e6a383765">tglend_tbl</a></div>
<div class="line"><a id="l03056" name="l03056"></a><span class="lineno"> 3056</span>       albw_u=<a class="code hl_variable" href="namespacemodule__sf__urban.html#a5ecf10e8e8e5f35bf072c48d39522429">albb_tbl</a></div>
<div class="line"><a id="l03057" name="l03057"></a><span class="lineno"> 3057</span>       albr_u=<a class="code hl_variable" href="namespacemodule__sf__urban.html#abaea368524361341add62f4363eb5a1d">albr_tbl</a></div>
<div class="line"><a id="l03058" name="l03058"></a><span class="lineno"> 3058</span>       albg_u=<a class="code hl_variable" href="namespacemodule__sf__urban.html#a53a7c90caf422a22d67b4d5e2d7bed05">albg_tbl</a></div>
<div class="line"><a id="l03059" name="l03059"></a><span class="lineno"> 3059</span>       emw_u=<a class="code hl_variable" href="namespacemodule__sf__urban.html#a7ad5e495d77c13933a0a0a520fdbd0c5">epsb_tbl</a></div>
<div class="line"><a id="l03060" name="l03060"></a><span class="lineno"> 3060</span>       emr_u=<a class="code hl_variable" href="namespacemodule__sf__urban.html#a756e1da50d2f84e1012c25d28be25ca1">epsr_tbl</a></div>
<div class="line"><a id="l03061" name="l03061"></a><span class="lineno"> 3061</span>       emg_u=<a class="code hl_variable" href="namespacemodule__sf__urban.html#a7bd813149f0db7cf5f651aaac1f61451">epsg_tbl</a></div>
<div class="line"><a id="l03062" name="l03062"></a><span class="lineno"> 3062</span>       z0r_u=<a class="code hl_variable" href="namespacemodule__sf__urban.html#a80861e0dde7b4f614d93906bcb798807">z0r_tbl</a></div>
<div class="line"><a id="l03063" name="l03063"></a><span class="lineno"> 3063</span>       z0g_u=<a class="code hl_variable" href="namespacemodule__sf__urban.html#a8c0b57691d2f95ea83413ad44dbe0911">z0g_tbl</a></div>
<div class="line"><a id="l03064" name="l03064"></a><span class="lineno"> 3064</span>       nd_u=<a class="code hl_variable" href="namespacemodule__sf__urban.html#afdabfc1fc1f3e6af27c4892c580f4f6d">numdir_tbl</a></div>
<div class="line"><a id="l03065" name="l03065"></a><span class="lineno"> 3065</span>       <span class="keywordflow">do</span> iu=1,<a class="code hl_variable" href="namespacemodule__sf__urban.html#aa330bcb961c1cce0dda88438dd69a66e">icate</a></div>
<div class="line"><a id="l03066" name="l03066"></a><span class="lineno"> 3066</span>              <span class="keywordflow">if</span>(ndm.lt.nd_u(iu))<span class="keywordflow">then</span></div>
<div class="line"><a id="l03067" name="l03067"></a><span class="lineno"> 3067</span>                <span class="keyword">write</span>(*,*)<span class="stringliteral">&#39;ndm too small in module_sf_bep, please increase to at least &#39;</span>, nd_u(iu)</div>
<div class="line"><a id="l03068" name="l03068"></a><span class="lineno"> 3068</span>                <span class="keyword">write</span>(*,*)<span class="stringliteral">&#39;remember also that num_urban_layers should be equal or greater than nz_um*ndm*nwr-u!&#39;</span></div>
<div class="line"><a id="l03069" name="l03069"></a><span class="lineno"> 3069</span>                stop</div>
<div class="line"><a id="l03070" name="l03070"></a><span class="lineno"> 3070</span><span class="keywordflow">              endif</span></div>
<div class="line"><a id="l03071" name="l03071"></a><span class="lineno"> 3071</span>         <span class="keywordflow">do</span> i=1,nd_u(iu)</div>
<div class="line"><a id="l03072" name="l03072"></a><span class="lineno"> 3072</span>           drst_u(i,iu)=<a class="code hl_variable" href="namespacemodule__sf__urban.html#af1698485b595e3139fdefa2748180002">street_direction_tbl</a>(i,iu) * <a class="code hl_variable" href="namespacemodule__sf__bep.html#a43054ed4c98f3ac9e3a5dc324ec7458f">pi</a>/180.</div>
<div class="line"><a id="l03073" name="l03073"></a><span class="lineno"> 3073</span>           ws_u(i,iu)=<a class="code hl_variable" href="namespacemodule__sf__urban.html#a7d08a484fba50f61f0fa17627f54152f">street_width_tbl</a>(i,iu)</div>
<div class="line"><a id="l03074" name="l03074"></a><span class="lineno"> 3074</span>           bs_u(i,iu)=<a class="code hl_variable" href="namespacemodule__sf__urban.html#a6712ae7674bdb4edfeab07a0d7952b55">building_width_tbl</a>(i,iu)</div>
<div class="line"><a id="l03075" name="l03075"></a><span class="lineno"> 3075</span><span class="keywordflow">         enddo</span></div>
<div class="line"><a id="l03076" name="l03076"></a><span class="lineno"> 3076</span><span class="keywordflow">       enddo</span></div>
<div class="line"><a id="l03077" name="l03077"></a><span class="lineno"> 3077</span>       <span class="keywordflow">do</span> iu=1,<a class="code hl_variable" href="namespacemodule__sf__urban.html#aa330bcb961c1cce0dda88438dd69a66e">icate</a></div>
<div class="line"><a id="l03078" name="l03078"></a><span class="lineno"> 3078</span>          <span class="keywordflow">if</span>(nz_um.lt.<a class="code hl_variable" href="namespacemodule__sf__urban.html#ad78e2b04cd43b10458d70bdbefabd193">numhgt_tbl</a>(iu)+3)<span class="keywordflow">then</span></div>
<div class="line"><a id="l03079" name="l03079"></a><span class="lineno"> 3079</span>              <span class="keyword">write</span>(*,*)<span class="stringliteral">&#39;nz_um too small in module_sf_bep, please increase to at least &#39;</span>,<a class="code hl_variable" href="namespacemodule__sf__urban.html#ad78e2b04cd43b10458d70bdbefabd193">numhgt_tbl</a>(iu)+3</div>
<div class="line"><a id="l03080" name="l03080"></a><span class="lineno"> 3080</span>              <span class="keyword">write</span>(*,*)<span class="stringliteral">&#39;remember also that num_urban_layers should be equal or greater than nz_um*ndm*nwr-u!&#39;</span></div>
<div class="line"><a id="l03081" name="l03081"></a><span class="lineno"> 3081</span>              stop</div>
<div class="line"><a id="l03082" name="l03082"></a><span class="lineno"> 3082</span><span class="keywordflow">          endif</span></div>
<div class="line"><a id="l03083" name="l03083"></a><span class="lineno"> 3083</span>         <span class="keywordflow">do</span> i=1,<a class="code hl_variable" href="namespacemodule__sf__urban.html#ad78e2b04cd43b10458d70bdbefabd193">numhgt_tbl</a>(iu)</div>
<div class="line"><a id="l03084" name="l03084"></a><span class="lineno"> 3084</span>           h_b(i,iu)=<a class="code hl_variable" href="namespacemodule__sf__urban.html#a2d6d3eaa4751a2ebd7abf1bebd18be55">height_bin_tbl</a>(i,iu)</div>
<div class="line"><a id="l03085" name="l03085"></a><span class="lineno"> 3085</span>           d_b(i,iu)=<a class="code hl_variable" href="namespacemodule__sf__urban.html#aea30c40838b61503f13715dd935df6a8">hpercent_bin_tbl</a>(i,iu)</div>
<div class="line"><a id="l03086" name="l03086"></a><span class="lineno"> 3086</span><span class="keywordflow">         enddo</span></div>
<div class="line"><a id="l03087" name="l03087"></a><span class="lineno"> 3087</span><span class="keywordflow">       enddo</span></div>
<div class="line"><a id="l03088" name="l03088"></a><span class="lineno"> 3088</span> </div>
<div class="line"><a id="l03089" name="l03089"></a><span class="lineno"> 3089</span>       <span class="keywordflow">do</span> i=1,ndm</div>
<div class="line"><a id="l03090" name="l03090"></a><span class="lineno"> 3090</span>        <span class="keywordflow">do</span> iu=1,nurbm</div>
<div class="line"><a id="l03091" name="l03091"></a><span class="lineno"> 3091</span>         strd_u(i,iu)=100000.</div>
<div class="line"><a id="l03092" name="l03092"></a><span class="lineno"> 3092</span><span class="keywordflow">        enddo</span></div>
<div class="line"><a id="l03093" name="l03093"></a><span class="lineno"> 3093</span><span class="keywordflow">       enddo</span></div>
<div class="line"><a id="l03094" name="l03094"></a><span class="lineno"> 3094</span>         </div>
<div class="line"><a id="l03095" name="l03095"></a><span class="lineno"> 3095</span>       <span class="keywordflow">return</span></div>
<div class="line"><a id="l03096" name="l03096"></a><span class="lineno"> 3096</span>      <span class="keyword">END SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a567630d423883a8646b493e79e507f79">init_para</a></div>
<div class="line"><a id="l03097" name="l03097"></a><span class="lineno"> 3097</span><span class="comment">!==============================================================</span></div>
<div class="line"><a id="l03098" name="l03098"></a><span class="lineno"> 3098</span> </div>
<div class="line"><a id="l03099" name="l03099"></a><span class="lineno"> 3099</span><span class="comment">!==============================================================</span></div>
<div class="line"><a id="l03100" name="l03100"></a><span class="lineno"><a class="line" href="namespacemodule__sf__bep.html#a5baa25176991e15fd794190f1c0f5b63"> 3100</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a5baa25176991e15fd794190f1c0f5b63">angle</a>(along,alat,day,realt,zr,deltar,ah)</div>
<div class="line"><a id="l03101" name="l03101"></a><span class="lineno"> 3101</span><span class="comment">!     ----------------     </span></div>
<div class="line"><a id="l03102" name="l03102"></a><span class="lineno"> 3102</span><span class="comment">!      </span></div>
<div class="line"><a id="l03103" name="l03103"></a><span class="lineno"> 3103</span><span class="comment">!         Computation of the solar angles</span></div>
<div class="line"><a id="l03104" name="l03104"></a><span class="lineno"> 3104</span><span class="comment">!         schayes (1982,atm.  env. , p1407)</span></div>
<div class="line"><a id="l03105" name="l03105"></a><span class="lineno"> 3105</span><span class="comment">! Inputs</span></div>
<div class="line"><a id="l03106" name="l03106"></a><span class="lineno"> 3106</span><span class="comment">!========================</span></div>
<div class="line"><a id="l03107" name="l03107"></a><span class="lineno"> 3107</span><span class="comment">! along=longitud</span></div>
<div class="line"><a id="l03108" name="l03108"></a><span class="lineno"> 3108</span><span class="comment">! alat=latitude</span></div>
<div class="line"><a id="l03109" name="l03109"></a><span class="lineno"> 3109</span><span class="comment">! day=julian day (from the beginning of the year)</span></div>
<div class="line"><a id="l03110" name="l03110"></a><span class="lineno"> 3110</span><span class="comment">! realt= time GMT in hours</span></div>
<div class="line"><a id="l03111" name="l03111"></a><span class="lineno"> 3111</span><span class="comment">! Outputs</span></div>
<div class="line"><a id="l03112" name="l03112"></a><span class="lineno"> 3112</span><span class="comment">!============================</span></div>
<div class="line"><a id="l03113" name="l03113"></a><span class="lineno"> 3113</span><span class="comment">! zr=solar zenith angle</span></div>
<div class="line"><a id="l03114" name="l03114"></a><span class="lineno"> 3114</span><span class="comment">! deltar=declination angle</span></div>
<div class="line"><a id="l03115" name="l03115"></a><span class="lineno"> 3115</span><span class="comment">! ah=hour angle</span></div>
<div class="line"><a id="l03116" name="l03116"></a><span class="lineno"> 3116</span><span class="comment">!===============================</span></div>
<div class="line"><a id="l03117" name="l03117"></a><span class="lineno"> 3117</span> </div>
<div class="line"><a id="l03118" name="l03118"></a><span class="lineno"> 3118</span>      <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l03119" name="l03119"></a><span class="lineno"> 3119</span><span class="keywordtype">      real</span> along,alat, realt, zr, deltar, ah, arg</div>
<div class="line"><a id="l03120" name="l03120"></a><span class="lineno"> 3120</span><span class="keywordtype">      real</span> rad,om,radh,initt, pii, drad, alongt, cphi, sphi</div>
<div class="line"><a id="l03121" name="l03121"></a><span class="lineno"> 3121</span><span class="keywordtype">      real</span> c1, c2, c3, s1, s2, s3, delta, rmsr2, cd, sid </div>
<div class="line"><a id="l03122" name="l03122"></a><span class="lineno"> 3122</span><span class="keywordtype">      real</span> et, ahor, chor, coznt </div>
<div class="line"><a id="l03123" name="l03123"></a><span class="lineno"> 3123</span>      <span class="keywordtype">integer</span> day </div>
<div class="line"><a id="l03124" name="l03124"></a><span class="lineno"> 3124</span> </div>
<div class="line"><a id="l03125" name="l03125"></a><span class="lineno"> 3125</span> </div>
<div class="line"><a id="l03126" name="l03126"></a><span class="lineno"> 3126</span>      <span class="keyword">data</span> rad,om,radh,initt/0.0174533,0.0172142,0.26179939,0/</div>
<div class="line"><a id="l03127" name="l03127"></a><span class="lineno"> 3127</span> </div>
<div class="line"><a id="l03128" name="l03128"></a><span class="lineno"> 3128</span>       zr=0.</div>
<div class="line"><a id="l03129" name="l03129"></a><span class="lineno"> 3129</span>       deltar=0.</div>
<div class="line"><a id="l03130" name="l03130"></a><span class="lineno"> 3130</span>       ah=0.</div>
<div class="line"><a id="l03131" name="l03131"></a><span class="lineno"> 3131</span> </div>
<div class="line"><a id="l03132" name="l03132"></a><span class="lineno"> 3132</span>       pii = 3.14159265358979312</div>
<div class="line"><a id="l03133" name="l03133"></a><span class="lineno"> 3133</span>       drad = pii/180.</div>
<div class="line"><a id="l03134" name="l03134"></a><span class="lineno"> 3134</span>      </div>
<div class="line"><a id="l03135" name="l03135"></a><span class="lineno"> 3135</span>       alongt=along/15.</div>
<div class="line"><a id="l03136" name="l03136"></a><span class="lineno"> 3136</span>       cphi=cos(alat*drad)</div>
<div class="line"><a id="l03137" name="l03137"></a><span class="lineno"> 3137</span>       sphi=sin(alat*drad)</div>
<div class="line"><a id="l03138" name="l03138"></a><span class="lineno"> 3138</span><span class="comment">!</span></div>
<div class="line"><a id="l03139" name="l03139"></a><span class="lineno"> 3139</span><span class="comment">!     declination</span></div>
<div class="line"><a id="l03140" name="l03140"></a><span class="lineno"> 3140</span><span class="comment">!</span></div>
<div class="line"><a id="l03141" name="l03141"></a><span class="lineno"> 3141</span>       arg=om*day</div>
<div class="line"><a id="l03142" name="l03142"></a><span class="lineno"> 3142</span>       c1=cos(arg)</div>
<div class="line"><a id="l03143" name="l03143"></a><span class="lineno"> 3143</span>       c2=cos(2.*arg)</div>
<div class="line"><a id="l03144" name="l03144"></a><span class="lineno"> 3144</span>       c3=cos(3.*arg)</div>
<div class="line"><a id="l03145" name="l03145"></a><span class="lineno"> 3145</span>       s1=sin(arg)</div>
<div class="line"><a id="l03146" name="l03146"></a><span class="lineno"> 3146</span>       s2=sin(2.*arg)</div>
<div class="line"><a id="l03147" name="l03147"></a><span class="lineno"> 3147</span>       s3=sin(3.*arg)</div>
<div class="line"><a id="l03148" name="l03148"></a><span class="lineno"> 3148</span>       delta=0.33281-22.984*c1-0.3499*c2-0.1398*c3+3.7872*s1+0.03205*s2+0.07187*s3</div>
<div class="line"><a id="l03149" name="l03149"></a><span class="lineno"> 3149</span>       rmsr2=(1./(1.-0.01673*c1))**2</div>
<div class="line"><a id="l03150" name="l03150"></a><span class="lineno"> 3150</span>       deltar=delta*rad</div>
<div class="line"><a id="l03151" name="l03151"></a><span class="lineno"> 3151</span>       cd=cos(deltar)</div>
<div class="line"><a id="l03152" name="l03152"></a><span class="lineno"> 3152</span>       sid=sin(deltar)</div>
<div class="line"><a id="l03153" name="l03153"></a><span class="lineno"> 3153</span><span class="comment">!</span></div>
<div class="line"><a id="l03154" name="l03154"></a><span class="lineno"> 3154</span><span class="comment">!     time equation in hours</span></div>
<div class="line"><a id="l03155" name="l03155"></a><span class="lineno"> 3155</span><span class="comment">!</span></div>
<div class="line"><a id="l03156" name="l03156"></a><span class="lineno"> 3156</span>       et=0.0072*c1-0.0528*c2-0.0012*c3-0.1229*s1-0.1565*s2-0.0041*s3</div>
<div class="line"><a id="l03157" name="l03157"></a><span class="lineno"> 3157</span><span class="comment">!</span></div>
<div class="line"><a id="l03158" name="l03158"></a><span class="lineno"> 3158</span><span class="comment">!</span></div>
<div class="line"><a id="l03159" name="l03159"></a><span class="lineno"> 3159</span><span class="comment">!   hour angle  </span></div>
<div class="line"><a id="l03160" name="l03160"></a><span class="lineno"> 3160</span><span class="comment">!</span></div>
<div class="line"><a id="l03161" name="l03161"></a><span class="lineno"> 3161</span>      </div>
<div class="line"><a id="l03162" name="l03162"></a><span class="lineno"> 3162</span><span class="comment">!      ifh=0</span></div>
<div class="line"><a id="l03163" name="l03163"></a><span class="lineno"> 3163</span>      </div>
<div class="line"><a id="l03164" name="l03164"></a><span class="lineno"> 3164</span> <span class="comment">!     ahor=realt-12.+ifh+et+alongt</span></div>
<div class="line"><a id="l03165" name="l03165"></a><span class="lineno"> 3165</span>      ahor=realt-12.+et+alongt</div>
<div class="line"><a id="l03166" name="l03166"></a><span class="lineno"> 3166</span>      ah=ahor*radh</div>
<div class="line"><a id="l03167" name="l03167"></a><span class="lineno"> 3167</span>      chor=cos(ah)</div>
<div class="line"><a id="l03168" name="l03168"></a><span class="lineno"> 3168</span><span class="comment">!</span></div>
<div class="line"><a id="l03169" name="l03169"></a><span class="lineno"> 3169</span><span class="comment">!    zenith angle</span></div>
<div class="line"><a id="l03170" name="l03170"></a><span class="lineno"> 3170</span><span class="comment">!</span></div>
<div class="line"><a id="l03171" name="l03171"></a><span class="lineno"> 3171</span>      coznt=sphi*sid+cphi*cd*chor</div>
<div class="line"><a id="l03172" name="l03172"></a><span class="lineno"> 3172</span>      </div>
<div class="line"><a id="l03173" name="l03173"></a><span class="lineno"> 3173</span>       zr=acos(coznt)</div>
<div class="line"><a id="l03174" name="l03174"></a><span class="lineno"> 3174</span> </div>
<div class="line"><a id="l03175" name="l03175"></a><span class="lineno"> 3175</span>      <span class="keywordflow">return</span></div>
<div class="line"><a id="l03176" name="l03176"></a><span class="lineno"> 3176</span> </div>
<div class="line"><a id="l03177" name="l03177"></a><span class="lineno"> 3177</span>      <span class="keyword">END SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a5baa25176991e15fd794190f1c0f5b63">angle</a></div>
<div class="line"><a id="l03178" name="l03178"></a><span class="lineno"> 3178</span><span class="comment">!</span></div>
<div class="line"><a id="l03179" name="l03179"></a><span class="lineno"> 3179</span><span class="comment">!====6=8===============================================================72         </span></div>
<div class="line"><a id="l03180" name="l03180"></a><span class="lineno"> 3180</span><span class="comment">!====6=8===============================================================72 </span></div>
<div class="line"><a id="l03181" name="l03181"></a><span class="lineno"> 3181</span> </div>
<div class="line"><a id="l03182" name="l03182"></a><span class="lineno"><a class="line" href="namespacemodule__sf__bep.html#a996c8ba8d9641d03e68ae303c9470ff8"> 3182</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a996c8ba8d9641d03e68ae303c9470ff8">upward_rad</a>(ndu,nzu,ws,bs,sigma,pb,ss,                     &amp;</div>
<div class="line"><a id="l03183" name="l03183"></a><span class="lineno"> 3183</span>                       tg,emg_u,albg_u,rlg,rsg,sfg,                        &amp; </div>
<div class="line"><a id="l03184" name="l03184"></a><span class="lineno"> 3184</span>                       tw,emw_u,albw_u,rlw,rsw,sfw,                        &amp; </div>
<div class="line"><a id="l03185" name="l03185"></a><span class="lineno"> 3185</span>                       tr,emr_u,albr_u,rld,rs, sfr,                        &amp; </div>
<div class="line"><a id="l03186" name="l03186"></a><span class="lineno"> 3186</span>                       rs_abs,rl_up,emiss,grdflx_urb)</div>
<div class="line"><a id="l03187" name="l03187"></a><span class="lineno"> 3187</span><span class="comment">!</span></div>
<div class="line"><a id="l03188" name="l03188"></a><span class="lineno"> 3188</span><span class="comment">! IN this surboutine we compute the upward longwave flux, and the albedo</span></div>
<div class="line"><a id="l03189" name="l03189"></a><span class="lineno"> 3189</span><span class="comment">! needed for the radiation scheme</span></div>
<div class="line"><a id="l03190" name="l03190"></a><span class="lineno"> 3190</span><span class="comment">!</span></div>
<div class="line"><a id="l03191" name="l03191"></a><span class="lineno"> 3191</span>                       <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l03192" name="l03192"></a><span class="lineno"> 3192</span> </div>
<div class="line"><a id="l03193" name="l03193"></a><span class="lineno"> 3193</span><span class="comment">!</span></div>
<div class="line"><a id="l03194" name="l03194"></a><span class="lineno"> 3194</span><span class="comment">!INPUT VARIABLES</span></div>
<div class="line"><a id="l03195" name="l03195"></a><span class="lineno"> 3195</span><span class="comment">!</span></div>
<div class="line"><a id="l03196" name="l03196"></a><span class="lineno"> 3196</span><span class="keywordtype">      real</span> rsw(2*ndm,nz_um)        <span class="comment">! Short wave radiation at the wall for a given canyon direction [W/m2]</span></div>
<div class="line"><a id="l03197" name="l03197"></a><span class="lineno"> 3197</span><span class="keywordtype">      real</span> rlw(2*ndm,nz_um)         <span class="comment">! Long wave radiation at the walls for a given canyon direction [W/m2]</span></div>
<div class="line"><a id="l03198" name="l03198"></a><span class="lineno"> 3198</span><span class="keywordtype">      real</span> rsg(ndm)                   <span class="comment">! Short wave radiation at the canyon for a given canyon direction [W/m2]</span></div>
<div class="line"><a id="l03199" name="l03199"></a><span class="lineno"> 3199</span><span class="keywordtype">      real</span> rlg(ndm)                   <span class="comment">! Long wave radiation at the ground for a given canyon direction [W/m2]</span></div>
<div class="line"><a id="l03200" name="l03200"></a><span class="lineno"> 3200</span><span class="keywordtype">      real</span> rs                        <span class="comment">! Short wave radiation at the horizontal surface from the sun [W/m2]  </span></div>
<div class="line"><a id="l03201" name="l03201"></a><span class="lineno"> 3201</span><span class="keywordtype">      real</span> sfw(2*ndm,nz_um)      <span class="comment">! Sensible heat flux from walls [W/m2]</span></div>
<div class="line"><a id="l03202" name="l03202"></a><span class="lineno"> 3202</span><span class="keywordtype">      real</span> sfg(ndm)              <span class="comment">! Sensible heat flux from ground (road) [W/m2]</span></div>
<div class="line"><a id="l03203" name="l03203"></a><span class="lineno"> 3203</span><span class="keywordtype">      real</span> sfr(ndm,nz_um)      <span class="comment">! Sensible heat flux from roofs [W/m2]                      </span></div>
<div class="line"><a id="l03204" name="l03204"></a><span class="lineno"> 3204</span><span class="keywordtype">      real</span> rld                        <span class="comment">! Long wave radiation from the sky [W/m2]</span></div>
<div class="line"><a id="l03205" name="l03205"></a><span class="lineno"> 3205</span><span class="keywordtype">      real</span> albg_u                    <span class="comment">! albedo of the ground/street</span></div>
<div class="line"><a id="l03206" name="l03206"></a><span class="lineno"> 3206</span><span class="keywordtype">      real</span> albw_u                    <span class="comment">! albedo of the walls</span></div>
<div class="line"><a id="l03207" name="l03207"></a><span class="lineno"> 3207</span><span class="keywordtype">      real</span> albr_u                    <span class="comment">! albedo of the roof </span></div>
<div class="line"><a id="l03208" name="l03208"></a><span class="lineno"> 3208</span><span class="keywordtype">      real</span> ws(ndm)                        <span class="comment">! width of the street</span></div>
<div class="line"><a id="l03209" name="l03209"></a><span class="lineno"> 3209</span><span class="keywordtype">      real</span> bs(ndm)</div>
<div class="line"><a id="l03210" name="l03210"></a><span class="lineno"> 3210</span>                        <span class="comment">! building size</span></div>
<div class="line"><a id="l03211" name="l03211"></a><span class="lineno"> 3211</span><span class="keywordtype">      real</span> pb(nz_um)                <span class="comment">! Probability to have a building with an height equal or higher   </span></div>
<div class="line"><a id="l03212" name="l03212"></a><span class="lineno"> 3212</span>      <span class="keywordtype">integer</span> nzu</div>
<div class="line"><a id="l03213" name="l03213"></a><span class="lineno"> 3213</span><span class="keywordtype">      real</span> ss(nz_um)                <span class="comment">! Probability to have a building of a given height</span></div>
<div class="line"><a id="l03214" name="l03214"></a><span class="lineno"> 3214</span><span class="keywordtype">      real</span> sigma                       </div>
<div class="line"><a id="l03215" name="l03215"></a><span class="lineno"> 3215</span><span class="keywordtype">      real</span> emg_u                       <span class="comment">! emissivity of the street</span></div>
<div class="line"><a id="l03216" name="l03216"></a><span class="lineno"> 3216</span><span class="keywordtype">      real</span> emw_u                       <span class="comment">! emissivity of the wall</span></div>
<div class="line"><a id="l03217" name="l03217"></a><span class="lineno"> 3217</span><span class="keywordtype">      real</span> emr_u                       <span class="comment">! emissivity of the roof</span></div>
<div class="line"><a id="l03218" name="l03218"></a><span class="lineno"> 3218</span><span class="keywordtype">      real</span> tw(2*ndm,nz_um,nwr_u)  <span class="comment">! Temperature in each layer of the wall [K]</span></div>
<div class="line"><a id="l03219" name="l03219"></a><span class="lineno"> 3219</span><span class="keywordtype">      real</span> tr(ndm,nz_um,nwr_u)  <span class="comment">! Temperature in each layer of the roof [K]</span></div>
<div class="line"><a id="l03220" name="l03220"></a><span class="lineno"> 3220</span><span class="keywordtype">      real</span> tg(ndm,ng_u)          <span class="comment">! Temperature in each layer of the ground [K]</span></div>
<div class="line"><a id="l03221" name="l03221"></a><span class="lineno"> 3221</span>      <span class="keywordtype">integer</span> id <span class="comment">! street direction</span></div>
<div class="line"><a id="l03222" name="l03222"></a><span class="lineno"> 3222</span>      <span class="keywordtype">integer</span> ndu <span class="comment">! number of street directions</span></div>
<div class="line"><a id="l03223" name="l03223"></a><span class="lineno"> 3223</span><span class="comment">!OUTPUT/INPUT</span></div>
<div class="line"><a id="l03224" name="l03224"></a><span class="lineno"> 3224</span><span class="keywordtype">      real</span> rs_abs  <span class="comment">! absrobed solar radiationfor this street direction</span></div>
<div class="line"><a id="l03225" name="l03225"></a><span class="lineno"> 3225</span><span class="keywordtype">      real</span> rl_up   <span class="comment">! upward longwave radiation for this street direction</span></div>
<div class="line"><a id="l03226" name="l03226"></a><span class="lineno"> 3226</span><span class="keywordtype">      real</span> emiss <span class="comment">! mean emissivity</span></div>
<div class="line"><a id="l03227" name="l03227"></a><span class="lineno"> 3227</span><span class="keywordtype">      real</span> grdflx_urb <span class="comment">! ground heat flux </span></div>
<div class="line"><a id="l03228" name="l03228"></a><span class="lineno"> 3228</span><span class="comment">!LOCAL</span></div>
<div class="line"><a id="l03229" name="l03229"></a><span class="lineno"> 3229</span>      <span class="keywordtype">integer</span> iz,iw</div>
<div class="line"><a id="l03230" name="l03230"></a><span class="lineno"> 3230</span><span class="keywordtype">      real</span> rl_inc,rl_emit</div>
<div class="line"><a id="l03231" name="l03231"></a><span class="lineno"> 3231</span><span class="keywordtype">      real</span> gfl</div>
<div class="line"><a id="l03232" name="l03232"></a><span class="lineno"> 3232</span>      <span class="keywordtype">integer</span> ix,iy,iwrong</div>
<div class="line"><a id="l03233" name="l03233"></a><span class="lineno"> 3233</span> </div>
<div class="line"><a id="l03234" name="l03234"></a><span class="lineno"> 3234</span>         iwrong=1</div>
<div class="line"><a id="l03235" name="l03235"></a><span class="lineno"> 3235</span>      <span class="keywordflow">do</span> iz=1,nzu+1</div>
<div class="line"><a id="l03236" name="l03236"></a><span class="lineno"> 3236</span>      <span class="keywordflow">do</span> id=1,ndu</div>
<div class="line"><a id="l03237" name="l03237"></a><span class="lineno"> 3237</span>      <span class="keywordflow">do</span> iw=1,nwr_u</div>
<div class="line"><a id="l03238" name="l03238"></a><span class="lineno"> 3238</span>        <span class="keywordflow">if</span>(tr(id,iz,iw).lt.100.)<span class="keywordflow">then</span></div>
<div class="line"><a id="l03239" name="l03239"></a><span class="lineno"> 3239</span>              <span class="keyword">write</span>(*,*)<span class="stringliteral">&#39;in upward_rad &#39;</span>,iz,id,iw,tr(id,iz,iw) </div>
<div class="line"><a id="l03240" name="l03240"></a><span class="lineno"> 3240</span>              iwrong=0</div>
<div class="line"><a id="l03241" name="l03241"></a><span class="lineno"> 3241</span><span class="keywordflow">        endif</span></div>
<div class="line"><a id="l03242" name="l03242"></a><span class="lineno"> 3242</span>        <span class="keywordflow">if</span>(tw(2*id-1,iz,iw).lt.100.) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03243" name="l03243"></a><span class="lineno"> 3243</span>           <span class="keyword">write</span>(*,*)<span class="stringliteral">&#39;in upward_rad &#39;</span>,iz,id,iw,tw(2*id-1,iz,iw) </div>
<div class="line"><a id="l03244" name="l03244"></a><span class="lineno"> 3244</span>           iwrong=0</div>
<div class="line"><a id="l03245" name="l03245"></a><span class="lineno"> 3245</span><span class="keywordflow">        endif</span></div>
<div class="line"><a id="l03246" name="l03246"></a><span class="lineno"> 3246</span>        <span class="keywordflow">if</span>(tw(2*id,iz,iw).lt.100.) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03247" name="l03247"></a><span class="lineno"> 3247</span>           <span class="keyword">write</span>(*,*)<span class="stringliteral">&#39;in upward_rad &#39;</span>,iz,id,iw,tw(2*id,iz,iw) </div>
<div class="line"><a id="l03248" name="l03248"></a><span class="lineno"> 3248</span>           iwrong=0</div>
<div class="line"><a id="l03249" name="l03249"></a><span class="lineno"> 3249</span><span class="keywordflow">        endif</span></div>
<div class="line"><a id="l03250" name="l03250"></a><span class="lineno"> 3250</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l03251" name="l03251"></a><span class="lineno"> 3251</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l03252" name="l03252"></a><span class="lineno"> 3252</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l03253" name="l03253"></a><span class="lineno"> 3253</span>      <span class="keywordflow">do</span> id=1,ndu</div>
<div class="line"><a id="l03254" name="l03254"></a><span class="lineno"> 3254</span>      <span class="keywordflow">do</span> iw=1,ng_u</div>
<div class="line"><a id="l03255" name="l03255"></a><span class="lineno"> 3255</span>          <span class="keywordflow">if</span>(tg(id,iw).lt.100.) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03256" name="l03256"></a><span class="lineno"> 3256</span>            <span class="keyword">write</span>(*,*)<span class="stringliteral">&#39;in upward_rad &#39;</span>,id,iw,tg(id,iw) </div>
<div class="line"><a id="l03257" name="l03257"></a><span class="lineno"> 3257</span>            iwrong=0</div>
<div class="line"><a id="l03258" name="l03258"></a><span class="lineno"> 3258</span><span class="keywordflow">          endif</span></div>
<div class="line"><a id="l03259" name="l03259"></a><span class="lineno"> 3259</span><span class="keywordflow">      enddo</span>   </div>
<div class="line"><a id="l03260" name="l03260"></a><span class="lineno"> 3260</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l03261" name="l03261"></a><span class="lineno"> 3261</span>           <span class="keywordflow">if</span>(iwrong.eq.0)stop</div>
<div class="line"><a id="l03262" name="l03262"></a><span class="lineno"> 3262</span> </div>
<div class="line"><a id="l03263" name="l03263"></a><span class="lineno"> 3263</span>      rl_up=0.</div>
<div class="line"><a id="l03264" name="l03264"></a><span class="lineno"> 3264</span> </div>
<div class="line"><a id="l03265" name="l03265"></a><span class="lineno"> 3265</span>      rs_abs=0.</div>
<div class="line"><a id="l03266" name="l03266"></a><span class="lineno"> 3266</span>      rl_inc=0.</div>
<div class="line"><a id="l03267" name="l03267"></a><span class="lineno"> 3267</span>      emiss=0.</div>
<div class="line"><a id="l03268" name="l03268"></a><span class="lineno"> 3268</span>      rl_emit=0.</div>
<div class="line"><a id="l03269" name="l03269"></a><span class="lineno"> 3269</span>      grdflx_urb=0.</div>
<div class="line"><a id="l03270" name="l03270"></a><span class="lineno"> 3270</span>      <span class="keywordflow">do</span> id=1,ndu          </div>
<div class="line"><a id="l03271" name="l03271"></a><span class="lineno"> 3271</span>       rl_emit=rl_emit-( emg_u*sigma*(tg(id,ng_u)**4.)+(1-emg_u)*rlg(id))*ws(id)/(ws(id)+bs(id))/ndu</div>
<div class="line"><a id="l03272" name="l03272"></a><span class="lineno"> 3272</span>       rl_inc=rl_inc+rlg(id)*ws(id)/(ws(id)+bs(id))/ndu       </div>
<div class="line"><a id="l03273" name="l03273"></a><span class="lineno"> 3273</span>       rs_abs=rs_abs+(1.-albg_u)*rsg(id)*ws(id)/(ws(id)+bs(id))/ndu</div>
<div class="line"><a id="l03274" name="l03274"></a><span class="lineno"> 3274</span>         gfl=(1.-albg_u)*rsg(id)+emg_u*rlg(id)-emg_u*sigma*(tg(id,ng_u)**4.)+sfg(id)</div>
<div class="line"><a id="l03275" name="l03275"></a><span class="lineno"> 3275</span>         grdflx_urb=grdflx_urb-gfl*ws(id)/(ws(id)+bs(id))/ndu  </div>
<div class="line"><a id="l03276" name="l03276"></a><span class="lineno"> 3276</span> </div>
<div class="line"><a id="l03277" name="l03277"></a><span class="lineno"> 3277</span>          <span class="keywordflow">do</span> iz=2,nzu</div>
<div class="line"><a id="l03278" name="l03278"></a><span class="lineno"> 3278</span>            rl_emit=rl_emit-(emr_u*sigma*(tr(id,iz,nwr_u)**4.)+(1-emr_u)*rld)*ss(iz)*bs(id)/(ws(id)+bs(id))/ndu</div>
<div class="line"><a id="l03279" name="l03279"></a><span class="lineno"> 3279</span>            rl_inc=rl_inc+rld*ss(iz)*bs(id)/(ws(id)+bs(id))/ndu            </div>
<div class="line"><a id="l03280" name="l03280"></a><span class="lineno"> 3280</span>            rs_abs=rs_abs+(1.-albr_u)*rs*ss(iz)*bs(id)/(ws(id)+bs(id))/ndu</div>
<div class="line"><a id="l03281" name="l03281"></a><span class="lineno"> 3281</span>            gfl=(1.-albr_u)*rs+emr_u*rld-emr_u*sigma*(tr(id,iz,nwr_u)**4.)+sfr(id,iz)</div>
<div class="line"><a id="l03282" name="l03282"></a><span class="lineno"> 3282</span>            grdflx_urb=grdflx_urb-gfl*ss(iz)*bs(id)/(ws(id)+bs(id))/ndu</div>
<div class="line"><a id="l03283" name="l03283"></a><span class="lineno"> 3283</span><span class="keywordflow">         enddo</span></div>
<div class="line"><a id="l03284" name="l03284"></a><span class="lineno"> 3284</span>           </div>
<div class="line"><a id="l03285" name="l03285"></a><span class="lineno"> 3285</span>         <span class="keywordflow">do</span> iz=1,nzu            </div>
<div class="line"><a id="l03286" name="l03286"></a><span class="lineno"> 3286</span>            rl_emit=rl_emit-(emw_u*sigma*( tw(2*id-1,iz,nwr_u)**4.+tw(2*id,iz,nwr_u)**4. )+          &amp;</div>
<div class="line"><a id="l03287" name="l03287"></a><span class="lineno"> 3287</span>               (1-emw_u)*( rlw(2*id-1,iz)+rlw(2*id,iz) ) )*<a class="code hl_variable" href="namespacemodule__sf__bep.html#a0d52a26f82bd0c0cf8a76bea001c9905">dz_u</a>*pb(iz+1)/(ws(id)+bs(id))/ndu</div>
<div class="line"><a id="l03288" name="l03288"></a><span class="lineno"> 3288</span>            rl_inc=rl_inc+(( rlw(2*id-1,iz)+rlw(2*id,iz) ) )*<a class="code hl_variable" href="namespacemodule__sf__bep.html#a0d52a26f82bd0c0cf8a76bea001c9905">dz_u</a>*pb(iz+1)/(ws(id)+bs(id))/ndu</div>
<div class="line"><a id="l03289" name="l03289"></a><span class="lineno"> 3289</span>            rs_abs=rs_abs+((1.-albw_u)*( rsw(2*id-1,iz)+rsw(2*id,iz) ) )*<a class="code hl_variable" href="namespacemodule__sf__bep.html#a0d52a26f82bd0c0cf8a76bea001c9905">dz_u</a>*pb(iz+1)/(ws(id)+bs(id))/ndu </div>
<div class="line"><a id="l03290" name="l03290"></a><span class="lineno"> 3290</span>            gfl=(1.-albw_u)*(rsw(2*id-1,iz)+rsw(2*id,iz)) +emw_u*( rlw(2*id-1,iz)+rlw(2*id,iz) )   &amp;</div>
<div class="line"><a id="l03291" name="l03291"></a><span class="lineno"> 3291</span>             -emw_u*sigma*( tw(2*id-1,iz,nwr_u)**4.+tw(2*id,iz,nwr_u)**4. )+(sfw(2*id-1,iz)+sfw(2*id,iz))            </div>
<div class="line"><a id="l03292" name="l03292"></a><span class="lineno"> 3292</span>            grdflx_urb=grdflx_urb-gfl*<a class="code hl_variable" href="namespacemodule__sf__bep.html#a0d52a26f82bd0c0cf8a76bea001c9905">dz_u</a>*pb(iz+1)/(ws(id)+bs(id))/ndu</div>
<div class="line"><a id="l03293" name="l03293"></a><span class="lineno"> 3293</span><span class="keywordflow">         enddo</span></div>
<div class="line"><a id="l03294" name="l03294"></a><span class="lineno"> 3294</span>          </div>
<div class="line"><a id="l03295" name="l03295"></a><span class="lineno"> 3295</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l03296" name="l03296"></a><span class="lineno"> 3296</span>        emiss=(emg_u+emw_u+emr_u)/3.</div>
<div class="line"><a id="l03297" name="l03297"></a><span class="lineno"> 3297</span>        rl_up=(rl_inc+rl_emit)-rld</div>
<div class="line"><a id="l03298" name="l03298"></a><span class="lineno"> 3298</span>       </div>
<div class="line"><a id="l03299" name="l03299"></a><span class="lineno"> 3299</span>         </div>
<div class="line"><a id="l03300" name="l03300"></a><span class="lineno"> 3300</span>      <span class="keywordflow">return</span></div>
<div class="line"><a id="l03301" name="l03301"></a><span class="lineno"> 3301</span> </div>
<div class="line"><a id="l03302" name="l03302"></a><span class="lineno"> 3302</span>      <span class="keyword">END SUBROUTINE </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a996c8ba8d9641d03e68ae303c9470ff8">upward_rad</a></div>
<div class="line"><a id="l03303" name="l03303"></a><span class="lineno"> 3303</span> </div>
<div class="line"><a id="l03304" name="l03304"></a><span class="lineno"> 3304</span><span class="comment">!====6=8===============================================================72         </span></div>
<div class="line"><a id="l03305" name="l03305"></a><span class="lineno"> 3305</span><span class="comment">!====6=8===============================================================72 </span></div>
<div class="line"><a id="l03306" name="l03306"></a><span class="lineno"> 3306</span><span class="comment">! ===6=8===============================================================72</span></div>
<div class="line"><a id="l03307" name="l03307"></a><span class="lineno"> 3307</span><span class="comment">! ===6=8===============================================================72</span></div>
<div class="line"><a id="l03308" name="l03308"></a><span class="lineno"> 3308</span> </div>
<div class="line"><a id="l03309" name="l03309"></a><span class="lineno"><a class="line" href="namespacemodule__sf__bep.html#a16b39e122a77024dc176887d083e8528"> 3309</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a16b39e122a77024dc176887d083e8528">icbep_xy</a>(iurb,fww_u,fwg_u,fgw_u,fsw_u,             &amp;</div>
<div class="line"><a id="l03310" name="l03310"></a><span class="lineno"> 3310</span>                          fws_u,fsg_u,ndu,strd,ws,nzu,z_u)                               </div>
<div class="line"><a id="l03311" name="l03311"></a><span class="lineno"> 3311</span> </div>
<div class="line"><a id="l03312" name="l03312"></a><span class="lineno"> 3312</span>      <span class="keywordtype">implicit none</span>       </div>
<div class="line"><a id="l03313" name="l03313"></a><span class="lineno"> 3313</span>        </div>
<div class="line"><a id="l03314" name="l03314"></a><span class="lineno"> 3314</span><span class="comment">!    Street parameters</span></div>
<div class="line"><a id="l03315" name="l03315"></a><span class="lineno"> 3315</span>      <span class="keywordtype">integer</span> ndu     <span class="comment">! Number of street direction for each urban class</span></div>
<div class="line"><a id="l03316" name="l03316"></a><span class="lineno"> 3316</span>      <span class="keywordtype">integer</span> iurb</div>
<div class="line"><a id="l03317" name="l03317"></a><span class="lineno"> 3317</span> </div>
<div class="line"><a id="l03318" name="l03318"></a><span class="lineno"> 3318</span><span class="keywordtype">      real</span> strd(ndm)        <span class="comment">! Street length (fix to greater value to the horizontal length of the cells)</span></div>
<div class="line"><a id="l03319" name="l03319"></a><span class="lineno"> 3319</span><span class="keywordtype">      real</span> ws(ndm)          <span class="comment">! Street width [m]</span></div>
<div class="line"><a id="l03320" name="l03320"></a><span class="lineno"> 3320</span> </div>
<div class="line"><a id="l03321" name="l03321"></a><span class="lineno"> 3321</span><span class="comment">!    Grid parameters</span></div>
<div class="line"><a id="l03322" name="l03322"></a><span class="lineno"> 3322</span>      <span class="keywordtype">integer</span> nzu          <span class="comment">! Number of layer in the urban grid</span></div>
<div class="line"><a id="l03323" name="l03323"></a><span class="lineno"> 3323</span><span class="keywordtype">      real</span> z_u(nz_um)       <span class="comment">! Height of the urban grid levels</span></div>
<div class="line"><a id="l03324" name="l03324"></a><span class="lineno"> 3324</span><span class="comment">! -----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03325" name="l03325"></a><span class="lineno"> 3325</span><span class="comment">!     Output</span></div>
<div class="line"><a id="l03326" name="l03326"></a><span class="lineno"> 3326</span><span class="comment">!------------------------------------------------------------------------</span></div>
<div class="line"><a id="l03327" name="l03327"></a><span class="lineno"> 3327</span> </div>
<div class="line"><a id="l03328" name="l03328"></a><span class="lineno"> 3328</span><span class="comment">!   fww_u,fwg_u,fgw_u,fsw_u,fsg_u are the view factors used to compute the long wave</span></div>
<div class="line"><a id="l03329" name="l03329"></a><span class="lineno"> 3329</span><span class="comment">!   and the short wave radation. They are the part of radiation from a surface</span></div>
<div class="line"><a id="l03330" name="l03330"></a><span class="lineno"> 3330</span><span class="comment">!   or from the sky to another surface.</span></div>
<div class="line"><a id="l03331" name="l03331"></a><span class="lineno"> 3331</span> </div>
<div class="line"><a id="l03332" name="l03332"></a><span class="lineno"> 3332</span><span class="keywordtype">      real</span> fww_u(nz_um,nz_um,ndm,nurbm)         <span class="comment">!  from wall to wall</span></div>
<div class="line"><a id="l03333" name="l03333"></a><span class="lineno"> 3333</span><span class="keywordtype">      real</span> fwg_u(nz_um,ndm,nurbm)               <span class="comment">!  from wall to ground</span></div>
<div class="line"><a id="l03334" name="l03334"></a><span class="lineno"> 3334</span><span class="keywordtype">      real</span> fgw_u(nz_um,ndm,nurbm)               <span class="comment">!  from ground to wall</span></div>
<div class="line"><a id="l03335" name="l03335"></a><span class="lineno"> 3335</span><span class="keywordtype">      real</span> fsw_u(nz_um,ndm,nurbm)               <span class="comment">!  from sky to wall</span></div>
<div class="line"><a id="l03336" name="l03336"></a><span class="lineno"> 3336</span><span class="keywordtype">      real</span> fws_u(nz_um,ndm,nurbm)               <span class="comment">!  from sky to wall</span></div>
<div class="line"><a id="l03337" name="l03337"></a><span class="lineno"> 3337</span><span class="keywordtype">      real</span> fsg_u(ndm,nurbm)                     <span class="comment">!  from sky to ground</span></div>
<div class="line"><a id="l03338" name="l03338"></a><span class="lineno"> 3338</span> </div>
<div class="line"><a id="l03339" name="l03339"></a><span class="lineno"> 3339</span><span class="comment">! -----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03340" name="l03340"></a><span class="lineno"> 3340</span><span class="comment">!     Local</span></div>
<div class="line"><a id="l03341" name="l03341"></a><span class="lineno"> 3341</span><span class="comment">!------------------------------------------------------------------------</span></div>
<div class="line"><a id="l03342" name="l03342"></a><span class="lineno"> 3342</span> </div>
<div class="line"><a id="l03343" name="l03343"></a><span class="lineno"> 3343</span>      <span class="keywordtype">integer</span> id</div>
<div class="line"><a id="l03344" name="l03344"></a><span class="lineno"> 3344</span> </div>
<div class="line"><a id="l03345" name="l03345"></a><span class="lineno"> 3345</span><span class="comment">! -----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03346" name="l03346"></a><span class="lineno"> 3346</span><span class="comment">!     This routine compute the view factors</span></div>
<div class="line"><a id="l03347" name="l03347"></a><span class="lineno"> 3347</span><span class="comment">!------------------------------------------------------------------------</span></div>
<div class="line"><a id="l03348" name="l03348"></a><span class="lineno"> 3348</span><span class="comment">!</span></div>
<div class="line"><a id="l03349" name="l03349"></a><span class="lineno"> 3349</span><span class="comment">!Initialize</span></div>
<div class="line"><a id="l03350" name="l03350"></a><span class="lineno"> 3350</span><span class="comment">!</span></div>
<div class="line"><a id="l03351" name="l03351"></a><span class="lineno"> 3351</span>      fww_u=0.</div>
<div class="line"><a id="l03352" name="l03352"></a><span class="lineno"> 3352</span>      fwg_u=0.</div>
<div class="line"><a id="l03353" name="l03353"></a><span class="lineno"> 3353</span>      fgw_u=0.</div>
<div class="line"><a id="l03354" name="l03354"></a><span class="lineno"> 3354</span>      fsw_u=0.</div>
<div class="line"><a id="l03355" name="l03355"></a><span class="lineno"> 3355</span>      fws_u=0.</div>
<div class="line"><a id="l03356" name="l03356"></a><span class="lineno"> 3356</span>      fsg_u=0.</div>
<div class="line"><a id="l03357" name="l03357"></a><span class="lineno"> 3357</span>      </div>
<div class="line"><a id="l03358" name="l03358"></a><span class="lineno"> 3358</span>      <span class="keywordflow">do</span> id=1,ndu</div>
<div class="line"><a id="l03359" name="l03359"></a><span class="lineno"> 3359</span> </div>
<div class="line"><a id="l03360" name="l03360"></a><span class="lineno"> 3360</span>            <span class="keyword">call </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a684f8527484fc85e8f11cc583188d0ab">view_factors</a>(iurb,nzu,id,strd(id),z_u,ws(id),  &amp;    </div>
<div class="line"><a id="l03361" name="l03361"></a><span class="lineno"> 3361</span>                              fww_u,fwg_u,fgw_u,fsg_u,fsw_u,fws_u) </div>
<div class="line"><a id="l03362" name="l03362"></a><span class="lineno"> 3362</span>      </div>
<div class="line"><a id="l03363" name="l03363"></a><span class="lineno"> 3363</span><span class="keywordflow">      enddo</span>               </div>
<div class="line"><a id="l03364" name="l03364"></a><span class="lineno"> 3364</span>      <span class="keywordflow">return</span>       </div>
<div class="line"><a id="l03365" name="l03365"></a><span class="lineno"> 3365</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a16b39e122a77024dc176887d083e8528">icbep_xy</a></div>
<div class="line"><a id="l03366" name="l03366"></a><span class="lineno"> 3366</span><span class="comment">! ===6=8===============================================================72</span></div>
<div class="line"><a id="l03367" name="l03367"></a><span class="lineno"> 3367</span><span class="comment">! ===6=8===============================================================72</span></div>
<div class="line"><a id="l03368" name="l03368"></a><span class="lineno"> 3368</span> </div>
<div class="line"><a id="l03369" name="l03369"></a><span class="lineno"><a class="line" href="namespacemodule__sf__bep.html#a63ffc10bf9f3e98abc45ec2cea796270"> 3369</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a63ffc10bf9f3e98abc45ec2cea796270">icbephi_xy</a>(hb_u,hi_urb1D,ss_u,pb_u,nzu,z_u)</div>
<div class="line"><a id="l03370" name="l03370"></a><span class="lineno"> 3370</span> </div>
<div class="line"><a id="l03371" name="l03371"></a><span class="lineno"> 3371</span>      <span class="keywordtype">implicit none</span>   </div>
<div class="line"><a id="l03372" name="l03372"></a><span class="lineno"> 3372</span><span class="comment">!-----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03373" name="l03373"></a><span class="lineno"> 3373</span><span class="comment">!    Inputs</span></div>
<div class="line"><a id="l03374" name="l03374"></a><span class="lineno"> 3374</span><span class="comment">!-----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03375" name="l03375"></a><span class="lineno"> 3375</span><span class="comment">!    Street parameters</span></div>
<div class="line"><a id="l03376" name="l03376"></a><span class="lineno"> 3376</span><span class="comment">!</span></div>
<div class="line"><a id="l03377" name="l03377"></a><span class="lineno"> 3377</span><span class="keywordtype">      real</span> hi_urb1D(nz_um)    <span class="comment">! The probability that a building has an height h_b</span></div>
<div class="line"><a id="l03378" name="l03378"></a><span class="lineno"> 3378</span><span class="comment">!</span></div>
<div class="line"><a id="l03379" name="l03379"></a><span class="lineno"> 3379</span><span class="comment">!     Grid parameters</span></div>
<div class="line"><a id="l03380" name="l03380"></a><span class="lineno"> 3380</span><span class="comment">!</span></div>
<div class="line"><a id="l03381" name="l03381"></a><span class="lineno"> 3381</span><span class="keywordtype">      real</span> z_u(nz_um)         <span class="comment">! Height of the urban grid levels</span></div>
<div class="line"><a id="l03382" name="l03382"></a><span class="lineno"> 3382</span><span class="comment">! -----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03383" name="l03383"></a><span class="lineno"> 3383</span><span class="comment">!     Output</span></div>
<div class="line"><a id="l03384" name="l03384"></a><span class="lineno"> 3384</span><span class="comment">!------------------------------------------------------------------------</span></div>
<div class="line"><a id="l03385" name="l03385"></a><span class="lineno"> 3385</span> </div>
<div class="line"><a id="l03386" name="l03386"></a><span class="lineno"> 3386</span><span class="keywordtype">      real</span> ss_u(nz_um)   <span class="comment">! The probability that a building has an height equal to z</span></div>
<div class="line"><a id="l03387" name="l03387"></a><span class="lineno"> 3387</span><span class="keywordtype">      real</span> pb_u(nz_um)         <span class="comment">! The probability that a building has an height greater or equal to z</span></div>
<div class="line"><a id="l03388" name="l03388"></a><span class="lineno"> 3388</span><span class="comment">!        </span></div>
<div class="line"><a id="l03389" name="l03389"></a><span class="lineno"> 3389</span><span class="comment">!    Grid parameters</span></div>
<div class="line"><a id="l03390" name="l03390"></a><span class="lineno"> 3390</span><span class="comment">!</span></div>
<div class="line"><a id="l03391" name="l03391"></a><span class="lineno"> 3391</span>      <span class="keywordtype">integer</span> nzu                <span class="comment">! Number of layer in the urban grid</span></div>
<div class="line"><a id="l03392" name="l03392"></a><span class="lineno"> 3392</span> </div>
<div class="line"><a id="l03393" name="l03393"></a><span class="lineno"> 3393</span><span class="comment">! -----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03394" name="l03394"></a><span class="lineno"> 3394</span><span class="comment">!     Local</span></div>
<div class="line"><a id="l03395" name="l03395"></a><span class="lineno"> 3395</span><span class="comment">!------------------------------------------------------------------------</span></div>
<div class="line"><a id="l03396" name="l03396"></a><span class="lineno"> 3396</span><span class="keywordtype">      real</span> hb_u(nz_um)        <span class="comment">! Bulding&#39;s heights [m]</span></div>
<div class="line"><a id="l03397" name="l03397"></a><span class="lineno"> 3397</span>      <span class="keywordtype">integer</span> iz_u,id,ilu</div>
<div class="line"><a id="l03398" name="l03398"></a><span class="lineno"> 3398</span> </div>
<div class="line"><a id="l03399" name="l03399"></a><span class="lineno"> 3399</span><span class="keywordtype">      real</span> dtot</div>
<div class="line"><a id="l03400" name="l03400"></a><span class="lineno"> 3400</span><span class="keywordtype">      real</span> hbmax</div>
<div class="line"><a id="l03401" name="l03401"></a><span class="lineno"> 3401</span> </div>
<div class="line"><a id="l03402" name="l03402"></a><span class="lineno"> 3402</span><span class="comment">!------------------------------------------------------------------------</span></div>
<div class="line"><a id="l03403" name="l03403"></a><span class="lineno"> 3403</span> </div>
<div class="line"><a id="l03404" name="l03404"></a><span class="lineno"> 3404</span><span class="comment">!Initialize variables</span></div>
<div class="line"><a id="l03405" name="l03405"></a><span class="lineno"> 3405</span><span class="comment">!</span></div>
<div class="line"><a id="l03406" name="l03406"></a><span class="lineno"> 3406</span>      </div>
<div class="line"><a id="l03407" name="l03407"></a><span class="lineno"> 3407</span>      nzu=0</div>
<div class="line"><a id="l03408" name="l03408"></a><span class="lineno"> 3408</span>      ss_u=0.</div>
<div class="line"><a id="l03409" name="l03409"></a><span class="lineno"> 3409</span>      pb_u=0.</div>
<div class="line"><a id="l03410" name="l03410"></a><span class="lineno"> 3410</span>      </div>
<div class="line"><a id="l03411" name="l03411"></a><span class="lineno"> 3411</span><span class="comment">! Normalisation of the building density</span></div>
<div class="line"><a id="l03412" name="l03412"></a><span class="lineno"> 3412</span> </div>
<div class="line"><a id="l03413" name="l03413"></a><span class="lineno"> 3413</span>         dtot=0.</div>
<div class="line"><a id="l03414" name="l03414"></a><span class="lineno"> 3414</span>         hb_u=0.</div>
<div class="line"><a id="l03415" name="l03415"></a><span class="lineno"> 3415</span> </div>
<div class="line"><a id="l03416" name="l03416"></a><span class="lineno"> 3416</span>         <span class="keywordflow">do</span> ilu=1,nz_um</div>
<div class="line"><a id="l03417" name="l03417"></a><span class="lineno"> 3417</span>            dtot=dtot+hi_urb1d(ilu)</div>
<div class="line"><a id="l03418" name="l03418"></a><span class="lineno"> 3418</span><span class="keywordflow">         enddo</span></div>
<div class="line"><a id="l03419" name="l03419"></a><span class="lineno"> 3419</span>         </div>
<div class="line"><a id="l03420" name="l03420"></a><span class="lineno"> 3420</span>         <span class="keywordflow">do</span> ilu=1,nz_um</div>
<div class="line"><a id="l03421" name="l03421"></a><span class="lineno"> 3421</span>            <span class="keywordflow">if</span> (hi_urb1d(ilu)&lt;0.) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03422" name="l03422"></a><span class="lineno"> 3422</span><span class="comment">!              write(*,*) &#39;WARNING, HI_URB1D(ilu) &lt; 0 IN BEP&#39;</span></div>
<div class="line"><a id="l03423" name="l03423"></a><span class="lineno"> 3423</span>               <span class="keywordflow">go to</span> 20</div>
<div class="line"><a id="l03424" name="l03424"></a><span class="lineno"> 3424</span><span class="keywordflow">            endif</span></div>
<div class="line"><a id="l03425" name="l03425"></a><span class="lineno"> 3425</span><span class="keywordflow">         enddo</span></div>
<div class="line"><a id="l03426" name="l03426"></a><span class="lineno"> 3426</span> </div>
<div class="line"><a id="l03427" name="l03427"></a><span class="lineno"> 3427</span>         <span class="keywordflow">if</span> (dtot.gt.0.) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03428" name="l03428"></a><span class="lineno"> 3428</span>            <span class="keywordflow">continue</span></div>
<div class="line"><a id="l03429" name="l03429"></a><span class="lineno"> 3429</span>         <span class="keywordflow">else</span></div>
<div class="line"><a id="l03430" name="l03430"></a><span class="lineno"> 3430</span><span class="comment">!           write(*,*) &#39;WARNING, HI_URB1D &lt;= 0 IN BEP&#39;</span></div>
<div class="line"><a id="l03431" name="l03431"></a><span class="lineno"> 3431</span>            <span class="keywordflow">go to</span> 20</div>
<div class="line"><a id="l03432" name="l03432"></a><span class="lineno"> 3432</span><span class="keywordflow">         endif</span></div>
<div class="line"><a id="l03433" name="l03433"></a><span class="lineno"> 3433</span> </div>
<div class="line"><a id="l03434" name="l03434"></a><span class="lineno"> 3434</span>         <span class="keywordflow">do</span> ilu=1,nz_um</div>
<div class="line"><a id="l03435" name="l03435"></a><span class="lineno"> 3435</span>            hi_urb1d(ilu)=hi_urb1d(ilu)/dtot</div>
<div class="line"><a id="l03436" name="l03436"></a><span class="lineno"> 3436</span><span class="keywordflow">         enddo</span></div>
<div class="line"><a id="l03437" name="l03437"></a><span class="lineno"> 3437</span>         </div>
<div class="line"><a id="l03438" name="l03438"></a><span class="lineno"> 3438</span>         hb_u(1)=<a class="code hl_variable" href="namespacemodule__sf__bep.html#a0d52a26f82bd0c0cf8a76bea001c9905">dz_u</a>   </div>
<div class="line"><a id="l03439" name="l03439"></a><span class="lineno"> 3439</span>         <span class="keywordflow">do</span> ilu=2,nz_um</div>
<div class="line"><a id="l03440" name="l03440"></a><span class="lineno"> 3440</span>            hb_u(ilu)=<a class="code hl_variable" href="namespacemodule__sf__bep.html#a0d52a26f82bd0c0cf8a76bea001c9905">dz_u</a>+hb_u(ilu-1)</div>
<div class="line"><a id="l03441" name="l03441"></a><span class="lineno"> 3441</span><span class="keywordflow">         enddo</span></div>
<div class="line"><a id="l03442" name="l03442"></a><span class="lineno"> 3442</span>           </div>
<div class="line"><a id="l03443" name="l03443"></a><span class="lineno"> 3443</span> </div>
<div class="line"><a id="l03444" name="l03444"></a><span class="lineno"> 3444</span><span class="comment">! Compute pb and ss </span></div>
<div class="line"><a id="l03445" name="l03445"></a><span class="lineno"> 3445</span>      </div>
<div class="line"><a id="l03446" name="l03446"></a><span class="lineno"> 3446</span>            </div>
<div class="line"><a id="l03447" name="l03447"></a><span class="lineno"> 3447</span>         hbmax=0.</div>
<div class="line"><a id="l03448" name="l03448"></a><span class="lineno"> 3448</span>       </div>
<div class="line"><a id="l03449" name="l03449"></a><span class="lineno"> 3449</span>         <span class="keywordflow">do</span> ilu=1,nz_um</div>
<div class="line"><a id="l03450" name="l03450"></a><span class="lineno"> 3450</span>            <span class="keywordflow">if</span> (hi_urb1d(ilu)&gt;0.and.hi_urb1d(ilu)&lt;=1.) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03451" name="l03451"></a><span class="lineno"> 3451</span>                hbmax=hb_u(ilu)</div>
<div class="line"><a id="l03452" name="l03452"></a><span class="lineno"> 3452</span><span class="keywordflow">            endif</span></div>
<div class="line"><a id="l03453" name="l03453"></a><span class="lineno"> 3453</span><span class="keywordflow">         enddo</span></div>
<div class="line"><a id="l03454" name="l03454"></a><span class="lineno"> 3454</span>         </div>
<div class="line"><a id="l03455" name="l03455"></a><span class="lineno"> 3455</span>         <span class="keywordflow">do</span> iz_u=1,nz_um-1</div>
<div class="line"><a id="l03456" name="l03456"></a><span class="lineno"> 3456</span>            <span class="keywordflow">if</span>(z_u(iz_u+1).gt.hbmax)<span class="keywordflow">go to</span> 10</div>
<div class="line"><a id="l03457" name="l03457"></a><span class="lineno"> 3457</span><span class="keywordflow">         enddo</span></div>
<div class="line"><a id="l03458" name="l03458"></a><span class="lineno"> 3458</span> </div>
<div class="line"><a id="l03459" name="l03459"></a><span class="lineno"> 3459</span>10       <span class="keywordflow">continue</span> </div>
<div class="line"><a id="l03460" name="l03460"></a><span class="lineno"> 3460</span>        </div>
<div class="line"><a id="l03461" name="l03461"></a><span class="lineno"> 3461</span>         nzu=iz_u+1</div>
<div class="line"><a id="l03462" name="l03462"></a><span class="lineno"> 3462</span> </div>
<div class="line"><a id="l03463" name="l03463"></a><span class="lineno"> 3463</span>         <span class="keywordflow">if</span> ((nzu+1).gt.nz_um) <span class="keywordflow">then</span> </div>
<div class="line"><a id="l03464" name="l03464"></a><span class="lineno"> 3464</span>             <span class="keyword">write</span>(*,*) <span class="stringliteral">&#39;error, nz_um has to be increased to at least&#39;</span>,nzu+1</div>
<div class="line"><a id="l03465" name="l03465"></a><span class="lineno"> 3465</span>             stop</div>
<div class="line"><a id="l03466" name="l03466"></a><span class="lineno"> 3466</span><span class="keywordflow">         endif</span></div>
<div class="line"><a id="l03467" name="l03467"></a><span class="lineno"> 3467</span> </div>
<div class="line"><a id="l03468" name="l03468"></a><span class="lineno"> 3468</span>            <span class="keywordflow">do</span> iz_u=1,nzu</div>
<div class="line"><a id="l03469" name="l03469"></a><span class="lineno"> 3469</span>               ss_u(iz_u)=0.</div>
<div class="line"><a id="l03470" name="l03470"></a><span class="lineno"> 3470</span>               <span class="keywordflow">do</span> ilu=1,nz_um</div>
<div class="line"><a id="l03471" name="l03471"></a><span class="lineno"> 3471</span>                  <span class="keywordflow">if</span>(z_u(iz_u).le.hb_u(ilu)                      &amp;    </div>
<div class="line"><a id="l03472" name="l03472"></a><span class="lineno"> 3472</span>                    .and.z_u(iz_u+1).gt.hb_u(ilu))<span class="keywordflow">then</span>            </div>
<div class="line"><a id="l03473" name="l03473"></a><span class="lineno"> 3473</span>                        ss_u(iz_u)=ss_u(iz_u)+hi_urb1d(ilu)</div>
<div class="line"><a id="l03474" name="l03474"></a><span class="lineno"> 3474</span><span class="keywordflow">                  endif</span> </div>
<div class="line"><a id="l03475" name="l03475"></a><span class="lineno"> 3475</span><span class="keywordflow">               enddo</span></div>
<div class="line"><a id="l03476" name="l03476"></a><span class="lineno"> 3476</span><span class="keywordflow">            enddo</span></div>
<div class="line"><a id="l03477" name="l03477"></a><span class="lineno"> 3477</span> </div>
<div class="line"><a id="l03478" name="l03478"></a><span class="lineno"> 3478</span>            pb_u(1)=1.</div>
<div class="line"><a id="l03479" name="l03479"></a><span class="lineno"> 3479</span>            <span class="keywordflow">do</span> iz_u=1,nzu</div>
<div class="line"><a id="l03480" name="l03480"></a><span class="lineno"> 3480</span>               pb_u(iz_u+1)=max(0.,pb_u(iz_u)-ss_u(iz_u))</div>
<div class="line"><a id="l03481" name="l03481"></a><span class="lineno"> 3481</span><span class="keywordflow">            enddo</span></div>
<div class="line"><a id="l03482" name="l03482"></a><span class="lineno"> 3482</span> </div>
<div class="line"><a id="l03483" name="l03483"></a><span class="lineno"> 3483</span>20    <span class="keywordflow">continue</span>    </div>
<div class="line"><a id="l03484" name="l03484"></a><span class="lineno"> 3484</span>      <span class="keywordflow">return</span></div>
<div class="line"><a id="l03485" name="l03485"></a><span class="lineno"> 3485</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="namespacemodule__sf__bep.html#a63ffc10bf9f3e98abc45ec2cea796270">icbephi_xy</a></div>
<div class="line"><a id="l03486" name="l03486"></a><span class="lineno"> 3486</span><span class="comment">! ===6=8===============================================================72</span></div>
<div class="line"><a id="l03487" name="l03487"></a><span class="lineno"> 3487</span><span class="comment">! ===6=8===============================================================72</span></div>
<div class="line"><a id="l03488" name="l03488"></a><span class="lineno"> 3488</span><span class="keyword">END MODULE </span><a class="code hl_namespace" href="namespacemodule__sf__bep.html">module_sf_bep</a></div>
<div class="ttc" id="anamespacemodule__sf__bep_html"><div class="ttname"><a href="namespacemodule__sf__bep.html">module_sf_bep</a></div><div class="ttdef"><b>Definition:</b> <a href="module__sf__bep_8F_source.html#l00001">module_sf_bep.F:1</a></div></div>
<div class="ttc" id="anamespacemodule__sf__bep_html_a05f8a759b52266ba041fde12cecc7962"><div class="ttname"><a href="namespacemodule__sf__bep.html#a05f8a759b52266ba041fde12cecc7962">module_sf_bep::interpol</a></div><div class="ttdeci">subroutine interpol(kms, kme, kts, kte, nz_u, z, z_u, c, c_u)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__bep_8F_source.html#l01068">module_sf_bep.F:1069</a></div></div>
<div class="ttc" id="anamespacemodule__sf__bep_html_a0928487326d9735901c0825abfec3b5e"><div class="ttname"><a href="namespacemodule__sf__bep.html#a0928487326d9735901c0825abfec3b5e">module_sf_bep::soil_temp</a></div><div class="ttdeci">subroutine soil_temp(nz, dz, temp, pt, ala, cs, rs, rl, press, dt, em, alb, rt, sf, gf)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__bep_8F_source.html#l02306">module_sf_bep.F:2308</a></div></div>
<div class="ttc" id="anamespacemodule__sf__bep_html_a0d52a26f82bd0c0cf8a76bea001c9905"><div class="ttname"><a href="namespacemodule__sf__bep.html#a0d52a26f82bd0c0cf8a76bea001c9905">module_sf_bep::dz_u</a></div><div class="ttdeci">real dz_u</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__bep_8F_source.html#l00034">module_sf_bep.F:34</a></div></div>
<div class="ttc" id="anamespacemodule__sf__bep_html_a14b87836842c0cf3cccb0b78fde9b2b0"><div class="ttname"><a href="namespacemodule__sf__bep.html#a14b87836842c0cf3cccb0b78fde9b2b0">module_sf_bep::sigma</a></div><div class="ttdeci">real sigma</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__bep_8F_source.html#l00049">module_sf_bep.F:49</a></div></div>
<div class="ttc" id="anamespacemodule__sf__bep_html_a16b39e122a77024dc176887d083e8528"><div class="ttname"><a href="namespacemodule__sf__bep.html#a16b39e122a77024dc176887d083e8528">module_sf_bep::icbep_xy</a></div><div class="ttdeci">subroutine icbep_xy(iurb, fww_u, fwg_u, fgw_u, fsw_u, fws_u, fsg_u, ndu, strd, ws, nzu, z_u)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__bep_8F_source.html#l03309">module_sf_bep.F:3311</a></div></div>
<div class="ttc" id="anamespacemodule__sf__bep_html_a279edcc0de78c52ec1a201aa9996e23f"><div class="ttname"><a href="namespacemodule__sf__bep.html#a279edcc0de78c52ec1a201aa9996e23f">module_sf_bep::urban_meso</a></div><div class="ttdeci">subroutine urban_meso(nd, kms, kme, kts, kte, nz_u, z, dz, z_u, pb, ss, bs, ws, sf, vl, uva_u, vva_u, uvb_u, vvb_u, tva_u, tvb_u, evb_u, uhb_u, vhb_u, thb_u, ehb_u, a_u, a_v, a_t, a_e, b_u, b_v, b_t, b_e)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__bep_8F_source.html#l01475">module_sf_bep.F:1479</a></div></div>
<div class="ttc" id="anamespacemodule__sf__bep_html_a36c77ea97f8e0c964f324b610af15a08"><div class="ttname"><a href="namespacemodule__sf__bep.html#a36c77ea97f8e0c964f324b610af15a08">module_sf_bep::rcp_u</a></div><div class="ttdeci">real rcp_u</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__bep_8F_source.html#l00048">module_sf_bep.F:48</a></div></div>
<div class="ttc" id="anamespacemodule__sf__bep_html_a36cb0fac0e86fb3e61571396455adf45"><div class="ttname"><a href="namespacemodule__sf__bep.html#a36cb0fac0e86fb3e61571396455adf45">module_sf_bep::fprls</a></div><div class="ttdeci">subroutine fprls(fprl, a, b, c)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__bep_8F_source.html#l02927">module_sf_bep.F:2928</a></div></div>
<div class="ttc" id="anamespacemodule__sf__bep_html_a43054ed4c98f3ac9e3a5dc324ec7458f"><div class="ttname"><a href="namespacemodule__sf__bep.html#a43054ed4c98f3ac9e3a5dc324ec7458f">module_sf_bep::pi</a></div><div class="ttdeci">real pi</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__bep_8F_source.html#l00045">module_sf_bep.F:45</a></div></div>
<div class="ttc" id="anamespacemodule__sf__bep_html_a4a86b7d5f6e1b383218768f344edc4d3"><div class="ttname"><a href="namespacemodule__sf__bep.html#a4a86b7d5f6e1b383218768f344edc4d3">module_sf_bep::fnrms</a></div><div class="ttdeci">subroutine fnrms(fnrm, a, b, c)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__bep_8F_source.html#l02957">module_sf_bep.F:2958</a></div></div>
<div class="ttc" id="anamespacemodule__sf__bep_html_a4e43ca6e75172d2dc55705c6adc6ed0d"><div class="ttname"><a href="namespacemodule__sf__bep.html#a4e43ca6e75172d2dc55705c6adc6ed0d">module_sf_bep::bep</a></div><div class="ttdeci">subroutine bep(FRC_URB2D, UTYPE_URB2D, itimestep, dz8w, dt, u_phy, v_phy, th_phy, rho, p_phy, swdown, glw, gmt, julday, xlong, xlat, declin_urb, cosz_urb2d, omg_urb2d, num_urban_layers, num_urban_hi, trb_urb4d, tw1_urb4d, tw2_urb4d, tgb_urb4d, sfw1_urb3d, sfw2_urb3d, sfr_urb3d, sfg_urb3d, lp_urb2d, hi_urb2d, lb_urb2d, hgt_urb2d, a_u, a_v, a_t, a_e, b_u, b_v, b_t, b_e, b_q, dlg, dl_u, sf, vl, rl_up, rs_abs, emiss, grdflx_urb, ids, ide, jds, jde, kds, kde, ims, ime, jms, jme, kms, kme, its, ite, jts, jte, kts, kte)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__bep_8F_source.html#l00062">module_sf_bep.F:76</a></div></div>
<div class="ttc" id="anamespacemodule__sf__bep_html_a52e6a0727e773b3279ac06328ae60b3b"><div class="ttname"><a href="namespacemodule__sf__bep.html#a52e6a0727e773b3279ac06328ae60b3b">module_sf_bep::p0</a></div><div class="ttdeci">real p0</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__bep_8F_source.html#l00050">module_sf_bep.F:50</a></div></div>
<div class="ttc" id="anamespacemodule__sf__bep_html_a567630d423883a8646b493e79e507f79"><div class="ttname"><a href="namespacemodule__sf__bep.html#a567630d423883a8646b493e79e507f79">module_sf_bep::init_para</a></div><div class="ttdeci">subroutine init_para(alag_u, alaw_u, alar_u, csg_u, csw_u, csr_u, twini_u, trini_u, tgini_u, albg_u, albw_u, albr_u, emg_u, emw_u, emr_u, z0g_u, z0r_u, nd_u, strd_u, drst_u, ws_u, bs_u, h_b, d_b)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__bep_8F_source.html#l02988">module_sf_bep.F:2991</a></div></div>
<div class="ttc" id="anamespacemodule__sf__bep_html_a5baa25176991e15fd794190f1c0f5b63"><div class="ttname"><a href="namespacemodule__sf__bep.html#a5baa25176991e15fd794190f1c0f5b63">module_sf_bep::angle</a></div><div class="ttdeci">subroutine angle(along, alat, day, realt, zr, deltar, ah)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__bep_8F_source.html#l03100">module_sf_bep.F:3101</a></div></div>
<div class="ttc" id="anamespacemodule__sf__bep_html_a5cf51c22bc40ad348fdc4c82f859a375"><div class="ttname"><a href="namespacemodule__sf__bep.html#a5cf51c22bc40ad348fdc4c82f859a375">module_sf_bep::gaussj</a></div><div class="ttdeci">subroutine gaussj(a, n, b, np)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__bep_8F_source.html#l02199">module_sf_bep.F:2200</a></div></div>
<div class="ttc" id="anamespacemodule__sf__bep_html_a63ffc10bf9f3e98abc45ec2cea796270"><div class="ttname"><a href="namespacemodule__sf__bep.html#a63ffc10bf9f3e98abc45ec2cea796270">module_sf_bep::icbephi_xy</a></div><div class="ttdeci">subroutine icbephi_xy(hb_u, hi_urb1D, ss_u, pb_u, nzu, z_u)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__bep_8F_source.html#l03369">module_sf_bep.F:3370</a></div></div>
<div class="ttc" id="anamespacemodule__sf__bep_html_a646e15d96f3e4929948bbb9babe74044"><div class="ttname"><a href="namespacemodule__sf__bep.html#a646e15d96f3e4929948bbb9babe74044">module_sf_bep::modif_rad</a></div><div class="ttdeci">subroutine modif_rad(iurb, nd, nz_u, z, ws, drst, strd, ss, pb, tw, tg, albg, albw, emw, emg, fww, fwg, fgw, fsw, fsg, zr, deltar, ah, rs, rl, rsw, rsg, rlw, rlg)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__bep_8F_source.html#l01121">module_sf_bep.F:1126</a></div></div>
<div class="ttc" id="anamespacemodule__sf__bep_html_a684f8527484fc85e8f11cc583188d0ab"><div class="ttname"><a href="namespacemodule__sf__bep.html#a684f8527484fc85e8f11cc583188d0ab">module_sf_bep::view_factors</a></div><div class="ttdeci">subroutine view_factors(iurb, nz_u, id, dxy, z, ws, fww, fwg, fgw, fsg, fsw, fws)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__bep_8F_source.html#l02763">module_sf_bep.F:2764</a></div></div>
<div class="ttc" id="anamespacemodule__sf__bep_html_a69dc7055b69f77f55dfcb82ac9770c56"><div class="ttname"><a href="namespacemodule__sf__bep.html#a69dc7055b69f77f55dfcb82ac9770c56">module_sf_bep::ng_u</a></div><div class="ttdeci">integer ng_u</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__bep_8F_source.html#l00029">module_sf_bep.F:29</a></div></div>
<div class="ttc" id="anamespacemodule__sf__bep_html_a6a0ea959e93ebb64bda9dfe38ce92994"><div class="ttname"><a href="namespacemodule__sf__bep.html#a6a0ea959e93ebb64bda9dfe38ce92994">module_sf_bep::nwr_u</a></div><div class="ttdeci">integer nwr_u</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__bep_8F_source.html#l00031">module_sf_bep.F:31</a></div></div>
<div class="ttc" id="anamespacemodule__sf__bep_html_a6c06d5d98aed63db0cb89c197392c812"><div class="ttname"><a href="namespacemodule__sf__bep.html#a6c06d5d98aed63db0cb89c197392c812">module_sf_bep::surf_temp</a></div><div class="ttdeci">subroutine surf_temp(nz_u, nd, pr, dt, ss, rs, rl, rsg, rlg, rsw, rlw, tg, alag, csg, emg, albg, ptg, sfg, gfg, tr, alar, csr, emr, albr, ptr, sfr, gfr, tw, alaw, csw, emw, albw, ptw, sfw, gfw)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__bep_8F_source.html#l01199">module_sf_bep.F:1203</a></div></div>
<div class="ttc" id="anamespacemodule__sf__bep_html_a6de67ff4391d9d6c0f924fb424e6b208"><div class="ttname"><a href="namespacemodule__sf__bep.html#a6de67ff4391d9d6c0f924fb424e6b208">module_sf_bep::flux_flat</a></div><div class="ttdeci">subroutine flux_flat(dz, z0, ua, va, pt, pt0, ptg, uhb, vhb, thb, ehb)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__bep_8F_source.html#l02532">module_sf_bep.F:2534</a></div></div>
<div class="ttc" id="anamespacemodule__sf__bep_html_a7ede93d00f17bd1c407a69e2f1f566cc"><div class="ttname"><a href="namespacemodule__sf__bep.html#a7ede93d00f17bd1c407a69e2f1f566cc">module_sf_bep::invert</a></div><div class="ttdeci">subroutine invert(n, a, c, x)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__bep_8F_source.html#l02402">module_sf_bep.F:2403</a></div></div>
<div class="ttc" id="anamespacemodule__sf__bep_html_a82297fd79f7a6627963d8b172f2a9c56"><div class="ttname"><a href="namespacemodule__sf__bep.html#a82297fd79f7a6627963d8b172f2a9c56">module_sf_bep::bep1d</a></div><div class="ttdeci">subroutine bep1d(iurb, kms, kme, kts, kte, z, dt, ua, va, pt, da, pr, pt0, zr, deltar, ah, rs, rld, alag, alaw, alar, csg, csw, csr, albg, albw, albr, emg, emw, emr, fww, fwg, fgw, fsw, fws, fsg, z0, ndu, strd, drst, ws, bs, ss, pb, nzu, z_u, tw, tg, tr, sfw, sfg, sfr, a_u, a_v, a_t, a_e, b_u, b_v, b_t, b_e, dlg, dl_u, sf, vl, rl_up, rs_abs, emiss, grdflx_urb)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__bep_8F_source.html#l00577">module_sf_bep.F:588</a></div></div>
<div class="ttc" id="anamespacemodule__sf__bep_html_a851f0f918177ac23c73ff631fd96683a"><div class="ttname"><a href="namespacemodule__sf__bep.html#a851f0f918177ac23c73ff631fd96683a">module_sf_bep::param</a></div><div class="ttdeci">subroutine param(iurb, nzu, nzurb, nzurban, ndu, csg_u, csg, alag_u, alag, csr_u, csr, alar_u, alar, csw_u, csw, alaw_u, alaw, ws_u, ws, bs_u, bs, z0g_u, z0r_u, z0, strd_u, strd, drst_u, drst, ss_u, ss_urb, ss, pb_u, pb_urb, pb, lp_urb, lb_urb, hgt_urb, frc_urb)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__bep_8F_source.html#l00898">module_sf_bep.F:904</a></div></div>
<div class="ttc" id="anamespacemodule__sf__bep_html_a873560a1932723dc6c6a6e31bebd91af"><div class="ttname"><a href="namespacemodule__sf__bep.html#a873560a1932723dc6c6a6e31bebd91af">module_sf_bep::buildings</a></div><div class="ttdeci">subroutine buildings(nd, nz, z0, ua_u, va_u, pt_u, pt0_u, ptg, ptr, da_u, ptw, drst, uva_u, vva_u, uvb_u, vvb_u, tva_u, tvb_u, evb_u, uhb_u, vhb_u, thb_u, ehb_u, ss, dt)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__bep_8F_source.html#l01360">module_sf_bep.F:1365</a></div></div>
<div class="ttc" id="anamespacemodule__sf__bep_html_a996c8ba8d9641d03e68ae303c9470ff8"><div class="ttname"><a href="namespacemodule__sf__bep.html#a996c8ba8d9641d03e68ae303c9470ff8">module_sf_bep::upward_rad</a></div><div class="ttdeci">subroutine upward_rad(ndu, nzu, ws, bs, sigma, pb, ss, tg, emg_u, albg_u, rlg, rsg, sfg, tw, emw_u, albw_u, rlw, rsw, sfw, tr, emr_u, albr_u, rld, rs, sfr, rs_abs, rl_up, emiss, grdflx_urb)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__bep_8F_source.html#l03182">module_sf_bep.F:3187</a></div></div>
<div class="ttc" id="anamespacemodule__sf__bep_html_aad179c533a1745a0d54a5dac9fe675a8"><div class="ttname"><a href="namespacemodule__sf__bep.html#aad179c533a1745a0d54a5dac9fe675a8">module_sf_bep::shade_wall</a></div><div class="ttdeci">subroutine shade_wall(z1, z2, hu, phix, aa, ws, rd)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__bep_8F_source.html#l01884">module_sf_bep.F:1885</a></div></div>
<div class="ttc" id="anamespacemodule__sf__bep_html_ab1764f8546c93ef96e065809e96f5999"><div class="ttname"><a href="namespacemodule__sf__bep.html#ab1764f8546c93ef96e065809e96f5999">module_sf_bep::cdrag</a></div><div class="ttdeci">real cdrag</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__bep_8F_source.html#l00051">module_sf_bep.F:51</a></div></div>
<div class="ttc" id="anamespacemodule__sf__bep_html_ab4c5155d2e31a1453a93508d2b63de18"><div class="ttname"><a href="namespacemodule__sf__bep.html#ab4c5155d2e31a1453a93508d2b63de18">module_sf_bep::interp_length</a></div><div class="ttdeci">subroutine interp_length(nd, kms, kme, kts, kte, nz_u, z_u, z, ss, ws, bs, dlg, dl_u)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__bep_8F_source.html#l01677">module_sf_bep.F:1679</a></div></div>
<div class="ttc" id="anamespacemodule__sf__bep_html_ab6b1a75584ebf7aec548086a00f5a3a2"><div class="ttname"><a href="namespacemodule__sf__bep.html#ab6b1a75584ebf7aec548086a00f5a3a2">module_sf_bep::nz_um</a></div><div class="ttdeci">integer nz_um</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__bep_8F_source.html#l00026">module_sf_bep.F:26</a></div></div>
<div class="ttc" id="anamespacemodule__sf__bep_html_abd3776b0304ce044cb0513a63aa99b07"><div class="ttname"><a href="namespacemodule__sf__bep.html#abd3776b0304ce044cb0513a63aa99b07">module_sf_bep::short_rad</a></div><div class="ttdeci">subroutine short_rad(iurb, nz_u, id, albw, albg, fwg, fww, fgw, rsg, rsw, pb)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__bep_8F_source.html#l02085">module_sf_bep.F:2087</a></div></div>
<div class="ttc" id="anamespacemodule__sf__bep_html_abfc00f67431c88cb28d213407cda5fca"><div class="ttname"><a href="namespacemodule__sf__bep.html#abfc00f67431c88cb28d213407cda5fca">module_sf_bep::ndm</a></div><div class="ttdeci">integer ndm</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__bep_8F_source.html#l00023">module_sf_bep.F:23</a></div></div>
<div class="ttc" id="anamespacemodule__sf__bep_html_ac457b6929ba12db21a3d49ebbacc2508"><div class="ttname"><a href="namespacemodule__sf__bep.html#ac457b6929ba12db21a3d49ebbacc2508">module_sf_bep::icbep</a></div><div class="ttdeci">subroutine icbep(nd_u, h_b, d_b, ss_u, pb_u, nz_u, z_u)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__bep_8F_source.html#l02656">module_sf_bep.F:2657</a></div></div>
<div class="ttc" id="anamespacemodule__sf__bep_html_ac956b0ccc4743b9847b8f9e2c5e5ad63"><div class="ttname"><a href="namespacemodule__sf__bep.html#ac956b0ccc4743b9847b8f9e2c5e5ad63">module_sf_bep::vk</a></div><div class="ttdeci">real vk</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__bep_8F_source.html#l00043">module_sf_bep.F:43</a></div></div>
<div class="ttc" id="anamespacemodule__sf__bep_html_acaecbbdf8792abde301dc5b78589ba9f"><div class="ttname"><a href="namespacemodule__sf__bep.html#acaecbbdf8792abde301dc5b78589ba9f">module_sf_bep::long_rad</a></div><div class="ttdeci">subroutine long_rad(iurb, nz_u, id, emw, emg, fwg, fww, fgw, fsw, fsg, tg, tw, rlg, rlw, rl, pb)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__bep_8F_source.html#l01939">module_sf_bep.F:1941</a></div></div>
<div class="ttc" id="anamespacemodule__sf__bep_html_accfe04a9ac7c32180691c196e2e00d4a"><div class="ttname"><a href="namespacemodule__sf__bep.html#accfe04a9ac7c32180691c196e2e00d4a">module_sf_bep::g_u</a></div><div class="ttdeci">real g_u</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__bep_8F_source.html#l00044">module_sf_bep.F:44</a></div></div>
<div class="ttc" id="anamespacemodule__sf__bep_html_adc1740fecdbbc88a536fda2c456b1e2d"><div class="ttname"><a href="namespacemodule__sf__bep.html#adc1740fecdbbc88a536fda2c456b1e2d">module_sf_bep::shadow_mas</a></div><div class="ttdeci">subroutine shadow_mas(nd, nz_u, zr, deltar, ah, drst, ws, ss, pb, z, rs, rsw, rsg)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__bep_8F_source.html#l01762">module_sf_bep.F:1764</a></div></div>
<div class="ttc" id="anamespacemodule__sf__bep_html_addfda01e830adb3a757aaecb94b26f64"><div class="ttname"><a href="namespacemodule__sf__bep.html#addfda01e830adb3a757aaecb94b26f64">module_sf_bep::r</a></div><div class="ttdeci">real r</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__bep_8F_source.html#l00046">module_sf_bep.F:46</a></div></div>
<div class="ttc" id="anamespacemodule__sf__bep_html_ae322728a3b7be919f956d83fcfbcc60a"><div class="ttname"><a href="namespacemodule__sf__bep.html#ae322728a3b7be919f956d83fcfbcc60a">module_sf_bep::cp_u</a></div><div class="ttdeci">real cp_u</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__bep_8F_source.html#l00047">module_sf_bep.F:47</a></div></div>
<div class="ttc" id="anamespacemodule__sf__bep_html_aed1522acfe1cfcab63a7734d8ebb32ae"><div class="ttname"><a href="namespacemodule__sf__bep.html#aed1522acfe1cfcab63a7734d8ebb32ae">module_sf_bep::nurbm</a></div><div class="ttdeci">integer nurbm</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__bep_8F_source.html#l00020">module_sf_bep.F:20</a></div></div>
<div class="ttc" id="anamespacemodule__sf__bep_html_afad1f5b9f81d43acb300a4ff02b17d33"><div class="ttname"><a href="namespacemodule__sf__bep.html#afad1f5b9f81d43acb300a4ff02b17d33">module_sf_bep::flux_wall</a></div><div class="ttdeci">subroutine flux_wall(ua, va, pt, da, ptw, uva, vva, uvb, vvb, tva, tvb, evb, drst, dt)</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__bep_8F_source.html#l02454">module_sf_bep.F:2456</a></div></div>
<div class="ttc" id="anamespacemodule__sf__urban_html"><div class="ttname"><a href="namespacemodule__sf__urban.html">module_sf_urban</a></div><div class="ttdef"><b>Definition:</b> <a href="module__sf__urban_8F_source.html#l00001">module_sf_urban.F:1</a></div></div>
<div class="ttc" id="anamespacemodule__sf__urban_html_a2d07f7dc346267badf036c665b31764b"><div class="ttname"><a href="namespacemodule__sf__urban.html#a2d07f7dc346267badf036c665b31764b">module_sf_urban::aksr_tbl</a></div><div class="ttdeci">real, dimension(:), allocatable aksr_tbl</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__urban_8F_source.html#l00051">module_sf_urban.F:51</a></div></div>
<div class="ttc" id="anamespacemodule__sf__urban_html_a2d6d3eaa4751a2ebd7abf1bebd18be55"><div class="ttname"><a href="namespacemodule__sf__urban.html#a2d6d3eaa4751a2ebd7abf1bebd18be55">module_sf_urban::height_bin_tbl</a></div><div class="ttdeci">real, dimension(:,:), allocatable height_bin_tbl</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__urban_8F_source.html#l00071">module_sf_urban.F:71</a></div></div>
<div class="ttc" id="anamespacemodule__sf__urban_html_a319ac4d774951ad1f4e8b95e6a383765"><div class="ttname"><a href="namespacemodule__sf__urban.html#a319ac4d774951ad1f4e8b95e6a383765">module_sf_urban::tglend_tbl</a></div><div class="ttdeci">real, dimension(:), allocatable tglend_tbl</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__urban_8F_source.html#l00057">module_sf_urban.F:57</a></div></div>
<div class="ttc" id="anamespacemodule__sf__urban_html_a34bd041e62b44037dadf6259cdd1f1bf"><div class="ttname"><a href="namespacemodule__sf__urban.html#a34bd041e62b44037dadf6259cdd1f1bf">module_sf_urban::trlend_tbl</a></div><div class="ttdeci">real, dimension(:), allocatable trlend_tbl</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__urban_8F_source.html#l00057">module_sf_urban.F:57</a></div></div>
<div class="ttc" id="anamespacemodule__sf__urban_html_a53a7c90caf422a22d67b4d5e2d7bed05"><div class="ttname"><a href="namespacemodule__sf__urban.html#a53a7c90caf422a22d67b4d5e2d7bed05">module_sf_urban::albg_tbl</a></div><div class="ttdeci">real, dimension(:), allocatable albg_tbl</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__urban_8F_source.html#l00052">module_sf_urban.F:52</a></div></div>
<div class="ttc" id="anamespacemodule__sf__urban_html_a55c42da1033c3ee7a17640e20669936f"><div class="ttname"><a href="namespacemodule__sf__urban.html#a55c42da1033c3ee7a17640e20669936f">module_sf_urban::capr_tbl</a></div><div class="ttdeci">real, dimension(:), allocatable capr_tbl</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__urban_8F_source.html#l00050">module_sf_urban.F:50</a></div></div>
<div class="ttc" id="anamespacemodule__sf__urban_html_a5ecf10e8e8e5f35bf072c48d39522429"><div class="ttname"><a href="namespacemodule__sf__urban.html#a5ecf10e8e8e5f35bf072c48d39522429">module_sf_urban::albb_tbl</a></div><div class="ttdeci">real, dimension(:), allocatable albb_tbl</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__urban_8F_source.html#l00052">module_sf_urban.F:52</a></div></div>
<div class="ttc" id="anamespacemodule__sf__urban_html_a6311eeae6859b634fd83afa15657ebee"><div class="ttname"><a href="namespacemodule__sf__urban.html#a6311eeae6859b634fd83afa15657ebee">module_sf_urban::tblend_tbl</a></div><div class="ttdeci">real, dimension(:), allocatable tblend_tbl</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__urban_8F_source.html#l00057">module_sf_urban.F:57</a></div></div>
<div class="ttc" id="anamespacemodule__sf__urban_html_a6712ae7674bdb4edfeab07a0d7952b55"><div class="ttname"><a href="namespacemodule__sf__urban.html#a6712ae7674bdb4edfeab07a0d7952b55">module_sf_urban::building_width_tbl</a></div><div class="ttdeci">real, dimension(:,:), allocatable building_width_tbl</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__urban_8F_source.html#l00069">module_sf_urban.F:69</a></div></div>
<div class="ttc" id="anamespacemodule__sf__urban_html_a756e1da50d2f84e1012c25d28be25ca1"><div class="ttname"><a href="namespacemodule__sf__urban.html#a756e1da50d2f84e1012c25d28be25ca1">module_sf_urban::epsr_tbl</a></div><div class="ttdeci">real, dimension(:), allocatable epsr_tbl</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__urban_8F_source.html#l00053">module_sf_urban.F:53</a></div></div>
<div class="ttc" id="anamespacemodule__sf__urban_html_a76b0ace2aa89e1d8643ecfc185e36e5f"><div class="ttname"><a href="namespacemodule__sf__urban.html#a76b0ace2aa89e1d8643ecfc185e36e5f">module_sf_urban::capg_tbl</a></div><div class="ttdeci">real, dimension(:), allocatable capg_tbl</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__urban_8F_source.html#l00050">module_sf_urban.F:50</a></div></div>
<div class="ttc" id="anamespacemodule__sf__urban_html_a7ad5e495d77c13933a0a0a520fdbd0c5"><div class="ttname"><a href="namespacemodule__sf__urban.html#a7ad5e495d77c13933a0a0a520fdbd0c5">module_sf_urban::epsb_tbl</a></div><div class="ttdeci">real, dimension(:), allocatable epsb_tbl</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__urban_8F_source.html#l00053">module_sf_urban.F:53</a></div></div>
<div class="ttc" id="anamespacemodule__sf__urban_html_a7bd813149f0db7cf5f651aaac1f61451"><div class="ttname"><a href="namespacemodule__sf__urban.html#a7bd813149f0db7cf5f651aaac1f61451">module_sf_urban::epsg_tbl</a></div><div class="ttdeci">real, dimension(:), allocatable epsg_tbl</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__urban_8F_source.html#l00053">module_sf_urban.F:53</a></div></div>
<div class="ttc" id="anamespacemodule__sf__urban_html_a7d08a484fba50f61f0fa17627f54152f"><div class="ttname"><a href="namespacemodule__sf__urban.html#a7d08a484fba50f61f0fa17627f54152f">module_sf_urban::street_width_tbl</a></div><div class="ttdeci">real, dimension(:,:), allocatable street_width_tbl</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__urban_8F_source.html#l00068">module_sf_urban.F:68</a></div></div>
<div class="ttc" id="anamespacemodule__sf__urban_html_a80861e0dde7b4f614d93906bcb798807"><div class="ttname"><a href="namespacemodule__sf__urban.html#a80861e0dde7b4f614d93906bcb798807">module_sf_urban::z0r_tbl</a></div><div class="ttdeci">real, dimension(:), allocatable z0r_tbl</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__urban_8F_source.html#l00054">module_sf_urban.F:54</a></div></div>
<div class="ttc" id="anamespacemodule__sf__urban_html_a8c0b57691d2f95ea83413ad44dbe0911"><div class="ttname"><a href="namespacemodule__sf__urban.html#a8c0b57691d2f95ea83413ad44dbe0911">module_sf_urban::z0g_tbl</a></div><div class="ttdeci">real, dimension(:), allocatable z0g_tbl</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__urban_8F_source.html#l00054">module_sf_urban.F:54</a></div></div>
<div class="ttc" id="anamespacemodule__sf__urban_html_aa330bcb961c1cce0dda88438dd69a66e"><div class="ttname"><a href="namespacemodule__sf__urban.html#aa330bcb961c1cce0dda88438dd69a66e">module_sf_urban::icate</a></div><div class="ttdeci">integer icate</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__urban_8F_source.html#l00020">module_sf_urban.F:20</a></div></div>
<div class="ttc" id="anamespacemodule__sf__urban_html_ab1f016c942720d416c558e59b8cb12c3"><div class="ttname"><a href="namespacemodule__sf__urban.html#ab1f016c942720d416c558e59b8cb12c3">module_sf_urban::capb_tbl</a></div><div class="ttdeci">real, dimension(:), allocatable capb_tbl</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__urban_8F_source.html#l00050">module_sf_urban.F:50</a></div></div>
<div class="ttc" id="anamespacemodule__sf__urban_html_abaea368524361341add62f4363eb5a1d"><div class="ttname"><a href="namespacemodule__sf__urban.html#abaea368524361341add62f4363eb5a1d">module_sf_urban::albr_tbl</a></div><div class="ttdeci">real, dimension(:), allocatable albr_tbl</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__urban_8F_source.html#l00052">module_sf_urban.F:52</a></div></div>
<div class="ttc" id="anamespacemodule__sf__urban_html_acd53e83822af2b680129a7d7c7eb791a"><div class="ttname"><a href="namespacemodule__sf__urban.html#acd53e83822af2b680129a7d7c7eb791a">module_sf_urban::aksg_tbl</a></div><div class="ttdeci">real, dimension(:), allocatable aksg_tbl</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__urban_8F_source.html#l00051">module_sf_urban.F:51</a></div></div>
<div class="ttc" id="anamespacemodule__sf__urban_html_ad78e2b04cd43b10458d70bdbefabd193"><div class="ttname"><a href="namespacemodule__sf__urban.html#ad78e2b04cd43b10458d70bdbefabd193">module_sf_urban::numhgt_tbl</a></div><div class="ttdeci">integer, dimension(:), allocatable numhgt_tbl</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__urban_8F_source.html#l00070">module_sf_urban.F:70</a></div></div>
<div class="ttc" id="anamespacemodule__sf__urban_html_aea30c40838b61503f13715dd935df6a8"><div class="ttname"><a href="namespacemodule__sf__urban.html#aea30c40838b61503f13715dd935df6a8">module_sf_urban::hpercent_bin_tbl</a></div><div class="ttdeci">real, dimension(:,:), allocatable hpercent_bin_tbl</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__urban_8F_source.html#l00072">module_sf_urban.F:72</a></div></div>
<div class="ttc" id="anamespacemodule__sf__urban_html_af1698485b595e3139fdefa2748180002"><div class="ttname"><a href="namespacemodule__sf__urban.html#af1698485b595e3139fdefa2748180002">module_sf_urban::street_direction_tbl</a></div><div class="ttdeci">real, dimension(:,:), allocatable street_direction_tbl</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__urban_8F_source.html#l00067">module_sf_urban.F:67</a></div></div>
<div class="ttc" id="anamespacemodule__sf__urban_html_af1cfe5901e85bc1b1b0e79f49ebc19c4"><div class="ttname"><a href="namespacemodule__sf__urban.html#af1cfe5901e85bc1b1b0e79f49ebc19c4">module_sf_urban::aksb_tbl</a></div><div class="ttdeci">real, dimension(:), allocatable aksb_tbl</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__urban_8F_source.html#l00051">module_sf_urban.F:51</a></div></div>
<div class="ttc" id="anamespacemodule__sf__urban_html_afdabfc1fc1f3e6af27c4892c580f4f6d"><div class="ttname"><a href="namespacemodule__sf__urban.html#afdabfc1fc1f3e6af27c4892c580f4f6d">module_sf_urban::numdir_tbl</a></div><div class="ttdeci">integer, dimension(:), allocatable numdir_tbl</div><div class="ttdef"><b>Definition:</b> <a href="module__sf__urban_8F_source.html#l00066">module_sf_urban.F:66</a></div></div>
<div class="ttc" id="anamespacempas__atmphys__utilities_html"><div class="ttname"><a href="namespacempas__atmphys__utilities.html">mpas_atmphys_utilities</a></div><div class="ttdef"><b>Definition:</b> <a href="core__atmosphere_2physics_2mpas__atmphys__utilities_8F_source.html#l00009">mpas_atmphys_utilities.F:9</a></div></div>
<div class="ttc" id="anamespacempas__atmphys__utilities_html_aa49abb89b6ebc760010e08cbdade2706"><div class="ttname"><a href="namespacempas__atmphys__utilities.html#aa49abb89b6ebc760010e08cbdade2706">mpas_atmphys_utilities::physics_error_fatal</a></div><div class="ttdeci">subroutine, public physics_error_fatal(str)</div><div class="ttdef"><b>Definition:</b> <a href="core__atmosphere_2physics_2mpas__atmphys__utilities_8F_source.html#l00044">mpas_atmphys_utilities.F:45</a></div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5
</small></address>
</body>
</html>
